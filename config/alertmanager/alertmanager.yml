global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@zero-carbon-system.com'
  smtp_auth_username: 'alerts@zero-carbon-system.com'
  smtp_auth_password: 'your-email-password'
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 30m
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 2h
    - match:
        alertname: 'ServiceDown'
      receiver: 'service-down-alerts'
      group_wait: 5s
      repeat_interval: 15m
    - match:
        alertname: 'HighErrorRate'
      receiver: 'error-rate-alerts'
      repeat_interval: 30m
    - match:
        alertname: 'DataQualityLow'
      receiver: 'data-quality-alerts'
      repeat_interval: 1h

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://energy-system:3001/api/alerts/webhook'
        send_resolved: true
        http_config:
          basic_auth:
            username: 'alertmanager'
            password: 'webhook-secret'

  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@zero-carbon-system.com'
        subject: '🚨 [CRITICAL] {{ .GroupLabels.alertname }} - 零碳园区系统'
        body: |
          告警详情:
          {{ range .Alerts }}
          - 告警名称: {{ .Annotations.summary }}
          - 描述: {{ .Annotations.description }}
          - 实例: {{ .Labels.instance }}
          - 服务: {{ .Labels.job }}
          - 严重程度: {{ .Labels.severity }}
          - 开始时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .EndsAt }}- 结束时间: {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
          
          {{ end }}
          
          请立即处理此告警！
          
          监控面板: http://localhost:3000
          Prometheus: http://localhost:9090
    webhook_configs:
      - url: 'http://energy-system:3001/api/alerts/critical'
        send_resolved: true
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#critical-alerts'
        title: '🚨 Critical Alert - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          *Severity:* {{ .Labels.severity }}
          {{ end }}

  - name: 'warning-alerts'
    email_configs:
      - to: 'ops@zero-carbon-system.com'
        subject: '⚠️ [WARNING] {{ .GroupLabels.alertname }} - 零碳园区系统'
        body: |
          告警详情:
          {{ range .Alerts }}
          - 告警名称: {{ .Annotations.summary }}
          - 描述: {{ .Annotations.description }}
          - 实例: {{ .Labels.instance }}
          - 服务: {{ .Labels.job }}
          - 严重程度: {{ .Labels.severity }}
          - 开始时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
          
          请关注此告警状态。
    webhook_configs:
      - url: 'http://energy-system:3001/api/alerts/warning'
        send_resolved: true

  - name: 'service-down-alerts'
    email_configs:
      - to: 'admin@zero-carbon-system.com,ops@zero-carbon-system.com'
        subject: '🔴 [SERVICE DOWN] {{ .GroupLabels.alertname }} - 零碳园区系统'
        body: |
          服务下线告警:
          {{ range .Alerts }}
          - 服务名称: {{ .Labels.job }}
          - 实例: {{ .Labels.instance }}
          - 下线时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          - 描述: {{ .Annotations.description }}
          {{ end }}
          
          请立即检查服务状态！
    webhook_configs:
      - url: 'http://energy-system:3001/api/alerts/service-down'
        send_resolved: true
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#service-alerts'
        title: '🔴 Service Down - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Service:* {{ .Labels.job }}
          *Instance:* {{ .Labels.instance }}
          *Down Since:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  - name: 'error-rate-alerts'
    email_configs:
      - to: 'dev@zero-carbon-system.com'
        subject: '📈 [HIGH ERROR RATE] {{ .GroupLabels.alertname }} - 零碳园区系统'
        body: |
          高错误率告警:
          {{ range .Alerts }}
          - 服务: {{ .Labels.job }}
          - 实例: {{ .Labels.instance }}
          - 错误率: {{ .Annotations.value }}
          - 阈值: {{ .Annotations.threshold }}
          - 开始时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
          
          请检查应用日志和性能指标。
    webhook_configs:
      - url: 'http://energy-system:3001/api/alerts/error-rate'
        send_resolved: true

  - name: 'data-quality-alerts'
    email_configs:
      - to: 'data@zero-carbon-system.com'
        subject: '📊 [DATA QUALITY] {{ .GroupLabels.alertname }} - 零碳园区系统'
        body: |
          数据质量告警:
          {{ range .Alerts }}
          - 数据源: {{ .Labels.datasource }}
          - 质量评分: {{ .Annotations.score }}
          - 阈值: {{ .Annotations.threshold }}
          - 影响范围: {{ .Annotations.impact }}
          - 开始时间: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
          
          请检查数据管道和数据源。
    webhook_configs:
      - url: 'http://energy-system:3001/api/alerts/data-quality'
        send_resolved: true

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '(HighLatency|HighErrorRate)'
    equal: ['instance']

templates:
  - '/etc/alertmanager/templates/*.tmpl'

# 告警抑制配置
# 当同一实例的critical告警触发时，抑制warning告警
# 当服务下线时，抑制该服务的其他性能告警