# 零碳园区数字孪生系统部署运维指南

版本：V2.0  
编制日期：2025年6月10日  
状态：✅ 生产就绪

## 📋 指南概述

本指南详细说明零碳园区数字孪生系统V2.0的生产环境部署、配置、监控和运维流程，确保系统稳定、安全、高效运行。

## 🎯 部署架构概览

### 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                   生产环境架构                           │
├─────────────────────────────────────────────────────────┤
│ 负载均衡层 │        Nginx + HAProxy                    │
├─────────────────────────────────────────────────────────┤
│ 网关层    │        Spring Cloud Gateway              │
├─────────────────────────────────────────────────────────┤
│ 应用层    │ 能碳核算 │ 优化调度 │ 企业诊断 │ 资源循环 │
│          │  服务   │   服务   │   服务   │   服务   │
│          │ 虚拟电厂 │ 数据资产 │ 申报验收 │ 基础设施 │
│          │  服务   │   服务   │   服务   │   服务   │
├─────────────────────────────────────────────────────────┤
│ 数据层    │ PostgreSQL │ InfluxDB │ MongoDB │ Redis  │
├─────────────────────────────────────────────────────────┤
│ 基础设施  │        Kubernetes + Docker               │
└─────────────────────────────────────────────────────────┘
```

### 环境要求

| 组件类型 | 最低配置 | 推荐配置 | 生产配置 |
|---------|---------|---------|----------|
| **应用服务器** | 4C8G | 8C16G | 16C32G |
| **数据库服务器** | 8C16G | 16C32G | 32C64G |
| **缓存服务器** | 4C8G | 8C16G | 16C32G |
| **存储空间** | 500GB | 2TB | 10TB |
| **网络带宽** | 100Mbps | 1Gbps | 10Gbps |

## 🚀 部署准备

### 1. 环境检查清单

#### 1.1 操作系统要求
```bash
# 支持的操作系统
- Ubuntu 20.04 LTS / 22.04 LTS
- CentOS 8 / Rocky Linux 8
- Red Hat Enterprise Linux 8

# 系统检查脚本
#!/bin/bash
echo "=== 系统环境检查 ==="
echo "操作系统: $(lsb_release -d | cut -f2)"
echo "内核版本: $(uname -r)"
echo "CPU核数: $(nproc)"
echo "内存大小: $(free -h | grep Mem | awk '{print $2}')"
echo "磁盘空间: $(df -h / | tail -1 | awk '{print $4}')"
echo "网络连接: $(ping -c 1 8.8.8.8 > /dev/null && echo '正常' || echo '异常')"
```

#### 1.2 依赖软件安装
```bash
# Docker安装
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Docker Compose安装
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Kubernetes安装 (使用kubeadm)
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
```

### 2. 网络配置

#### 2.1 防火墙配置
```bash
# UFW防火墙配置
sudo ufw enable
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 6443/tcp  # Kubernetes API
sudo ufw allow 8080:8090/tcp  # 应用服务端口范围

# 查看防火墙状态
sudo ufw status verbose
```

#### 2.2 域名和SSL证书
```bash
# 使用Let's Encrypt获取SSL证书
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d api.your-domain.com

# 证书自动续期
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

## 🐳 Docker部署方案

### 1. Docker Compose配置

#### 1.1 主配置文件 (docker-compose.yml)
```yaml
version: '3.8'

services:
  # API网关
  gateway:
    image: zero-carbon/gateway:v2.0
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka
    depends_on:
      - eureka
      - redis
    networks:
      - zero-carbon-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 服务注册中心
  eureka:
    image: zero-carbon/eureka:v2.0
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=production
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # 碳排放核算服务
  carbon-accounting:
    image: zero-carbon/carbon-accounting:v2.0
    ports:
      - "8081:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - DATABASE_URL=jdbc:postgresql://postgres:5432/carbon_accounting
      - DATABASE_USERNAME=carbon_user
      - DATABASE_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka
    depends_on:
      - postgres
      - redis
      - eureka
    networks:
      - zero-carbon-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  # 能源优化调度服务
  energy-optimization:
    image: zero-carbon/energy-optimization:v2.0
    ports:
      - "8082:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - DATABASE_URL=jdbc:postgresql://postgres:5432/energy_optimization
      - DATABASE_USERNAME=energy_user
      - DATABASE_PASSWORD=${DB_PASSWORD}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka
    depends_on:
      - postgres
      - influxdb
      - eureka
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # PostgreSQL数据库
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=zero_carbon
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - zero-carbon-network
    restart: unless-stopped
    command: [
      "postgres",
      "-c", "max_connections=200",
      "-c", "shared_buffers=256MB",
      "-c", "effective_cache_size=1GB",
      "-c", "work_mem=4MB",
      "-c", "maintenance_work_mem=64MB"
    ]

  # InfluxDB时序数据库
  influxdb:
    image: influxdb:2.7
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=zero-carbon
      - DOCKER_INFLUXDB_INIT_BUCKET=energy-data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # Redis缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # MongoDB文档数据库
  mongodb:
    image: mongo:6
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
    volumes:
      - mongodb_data:/data/db
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - gateway
    networks:
      - zero-carbon-network
    restart: unless-stopped

volumes:
  postgres_data:
  influxdb_data:
  redis_data:
  mongodb_data:

networks:
  zero-carbon-network:
    driver: bridge
```

#### 1.2 环境变量配置 (.env)
```bash
# 数据库密码
POSTGRES_PASSWORD=your_secure_postgres_password
DB_PASSWORD=your_secure_db_password
INFLUXDB_PASSWORD=your_secure_influxdb_password
INFLUXDB_TOKEN=your_secure_influxdb_token
REDIS_PASSWORD=your_secure_redis_password
MONGO_PASSWORD=your_secure_mongo_password

# JWT密钥
JWT_SECRET=your_jwt_secret_key_at_least_256_bits

# 外部API密钥
WEATHER_API_KEY=your_weather_api_key
GRID_API_KEY=your_grid_api_key

# 监控配置
PROMETHEUS_RETENTION=30d
GRAFANA_ADMIN_PASSWORD=your_grafana_password
```

#### 1.3 Nginx配置
```nginx
# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream gateway {
        server gateway:8080;
    }
    
    # HTTP重定向到HTTPS
    server {
        listen 80;
        server_name your-domain.com;
        return 301 https://$server_name$request_uri;
    }
    
    # HTTPS配置
    server {
        listen 443 ssl http2;
        server_name your-domain.com;
        
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        
        # 安全头
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
        
        # API代理
        location /api/ {
            proxy_pass http://gateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 超时设置
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # 静态文件
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

### 2. 部署脚本

#### 2.1 一键部署脚本 (deploy.sh)
```bash
#!/bin/bash

set -e

echo "=== 零碳园区数字孪生系统部署脚本 ==="

# 检查Docker和Docker Compose
if ! command -v docker &> /dev/null; then
    echo "错误: Docker未安装"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "错误: Docker Compose未安装"
    exit 1
fi

# 创建必要目录
mkdir -p nginx/ssl nginx/logs
mkdir -p init-scripts
mkdir -p data/postgres data/influxdb data/redis data/mongodb

# 设置权限
sudo chown -R 999:999 data/postgres
sudo chown -R 1000:1000 data/influxdb

# 检查环境变量文件
if [ ! -f .env ]; then
    echo "错误: .env文件不存在，请先配置环境变量"
    exit 1
fi

# 拉取最新镜像
echo "拉取Docker镜像..."
docker-compose pull

# 启动服务
echo "启动服务..."
docker-compose up -d

# 等待服务启动
echo "等待服务启动..."
sleep 30

# 健康检查
echo "执行健康检查..."
for service in gateway carbon-accounting energy-optimization; do
    if docker-compose ps $service | grep -q "Up"; then
        echo "✅ $service 服务正常"
    else
        echo "❌ $service 服务异常"
        docker-compose logs $service
    fi
done

# 显示访问信息
echo ""
echo "=== 部署完成 ==="
echo "系统访问地址: https://your-domain.com"
echo "API文档地址: https://your-domain.com/api/swagger-ui.html"
echo "监控面板地址: https://your-domain.com/grafana"
echo ""
echo "查看服务状态: docker-compose ps"
echo "查看服务日志: docker-compose logs [service-name]"
echo "停止所有服务: docker-compose down"
```

#### 2.2 数据库初始化脚本
```sql
-- init-scripts/01-create-databases.sql
CREATE DATABASE carbon_accounting;
CREATE DATABASE energy_optimization;
CREATE DATABASE enterprise_diagnosis;
CREATE DATABASE resource_circulation;
CREATE DATABASE virtual_power_plant;
CREATE DATABASE data_assets;

-- 创建用户
CREATE USER carbon_user WITH PASSWORD 'your_password';
CREATE USER energy_user WITH PASSWORD 'your_password';
CREATE USER enterprise_user WITH PASSWORD 'your_password';
CREATE USER resource_user WITH PASSWORD 'your_password';
CREATE USER vpp_user WITH PASSWORD 'your_password';
CREATE USER data_user WITH PASSWORD 'your_password';

-- 授权
GRANT ALL PRIVILEGES ON DATABASE carbon_accounting TO carbon_user;
GRANT ALL PRIVILEGES ON DATABASE energy_optimization TO energy_user;
GRANT ALL PRIVILEGES ON DATABASE enterprise_diagnosis TO enterprise_user;
GRANT ALL PRIVILEGES ON DATABASE resource_circulation TO resource_user;
GRANT ALL PRIVILEGES ON DATABASE virtual_power_plant TO vpp_user;
GRANT ALL PRIVILEGES ON DATABASE data_assets TO data_user;
```

## ☸️ Kubernetes部署方案

### 1. 快速部署指南

#### 1.1 部署步骤

```bash
# 1. 创建命名空间和基础资源
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/storage.yaml

# 2. 创建配置和密钥
kubectl apply -f k8s/configmaps.yaml
kubectl apply -f k8s/secrets.yaml

# 3. 部署数据库服务
kubectl apply -f k8s/database-deployment.yaml

# 4. 部署应用服务
kubectl apply -f k8s/app-deployments.yaml

# 5. 配置Ingress
kubectl apply -f k8s/ingress.yaml

# 6. 验证部署
kubectl get pods -n zero-carbon
kubectl get services -n zero-carbon
kubectl get ingress -n zero-carbon
```

#### 1.2 部署验证

```bash
# 检查Pod状态
kubectl get pods -n zero-carbon -o wide

# 检查服务状态
kubectl get svc -n zero-carbon

# 检查HPA状态
kubectl get hpa -n zero-carbon

# 查看日志
kubectl logs -f deployment/carbon-accounting -n zero-carbon

# 端口转发测试
kubectl port-forward svc/gateway-service 8080:80 -n zero-carbon
```

### 2. 命名空间配置
```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: zero-carbon
  labels:
    name: zero-carbon
    environment: production
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: zero-carbon-quota
  namespace: zero-carbon
spec:
  hard:
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    persistentvolumeclaims: "10"
```

### 2. 配置管理
```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: zero-carbon
data:
  application.yml: |
    spring:
      profiles:
        active: production
      datasource:
        url: jdbc:postgresql://postgres-service:5432/zero_carbon
        username: ${DATABASE_USERNAME}
        password: ${DATABASE_PASSWORD}
      redis:
        host: redis-service
        port: 6379
        password: ${REDIS_PASSWORD}
    eureka:
      client:
        service-url:
          defaultZone: http://eureka-service:8761/eureka
    management:
      endpoints:
        web:
          exposure:
            include: health,info,metrics,prometheus
      endpoint:
        health:
          show-details: always
```

### 3. 密钥管理
```yaml
# k8s/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: zero-carbon
type: Opaque
data:
  database-username: Y2FyYm9uX3VzZXI=  # base64编码
  database-password: eW91cl9zZWN1cmVfcGFzc3dvcmQ=
  redis-password: eW91cl9yZWRpc19wYXNzd29yZA==
  jwt-secret: eW91cl9qd3Rfc2VjcmV0X2tleQ==
```

### 4. 应用部署
```yaml
# k8s/carbon-accounting-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: carbon-accounting
  namespace: zero-carbon
  labels:
    app: carbon-accounting
spec:
  replicas: 3
  selector:
    matchLabels:
      app: carbon-accounting
  template:
    metadata:
      labels:
        app: carbon-accounting
    spec:
      containers:
      - name: carbon-accounting
        image: zero-carbon/carbon-accounting:v2.0
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: DATABASE_USERNAME
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: database-username
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: database-password
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: redis-password
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      volumes:
      - name: config-volume
        configMap:
          name: app-config
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: carbon-accounting-service
  namespace: zero-carbon
spec:
  selector:
    app: carbon-accounting
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP
```

### 5. Ingress配置
```yaml
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: zero-carbon-ingress
  namespace: zero-carbon
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
  - hosts:
    - your-domain.com
    - api.your-domain.com
    secretName: zero-carbon-tls
  rules:
  - host: your-domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
  - host: api.your-domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gateway-service
            port:
              number: 80
```

## 📊 监控与日志

### 1. 监控系统部署

#### 1.1 快速部署监控系统

```bash
# 使用自动化部署脚本
chmod +x scripts/monitoring/setup-monitoring.sh
./scripts/monitoring/setup-monitoring.sh

# 检查监控服务状态
./scripts/monitoring/health-check.sh

# 启动持续健康检查
./scripts/monitoring/health-check.sh --continuous --interval 60
```

#### 1.2 监控组件访问

- **Grafana仪表板**: http://localhost:3000 (admin/admin123)
- **Prometheus**: http://localhost:9090
- **AlertManager**: http://localhost:9093
- **Node Exporter**: http://localhost:9100
- **Redis监控**: http://localhost:9121

### 2. Prometheus监控配置

监控配置文件位于 `config/prometheus/prometheus.yml`，包含以下监控目标：

- 零碳园区主应用 (端口: 3001)
- Node Exporter系统指标 (端口: 9100)
- Redis缓存服务 (端口: 6379)
- MQTT消息代理 (端口: 1883)
- 各业务模块自定义指标

```yaml
# monitoring/prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    rule_files:
      - "alert_rules.yml"
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    scrape_configs:
      - job_name: 'zero-carbon-system'
        static_configs:
          - targets: ['energy-system:3001']
        metrics_path: '/api/metrics'
        scrape_interval: 30s
      
      - job_name: 'node-exporter'
        static_configs:
          - targets: ['node-exporter:9100']
        scrape_interval: 15s
      
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: default;kubernetes;https
      
      - job_name: 'zero-carbon-apps'
        kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
            - zero-carbon
        relabel_configs:
        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
```

### 2. 告警规则配置
```yaml
# monitoring/alert-rules.yaml
groups:
- name: zero-carbon-alerts
  rules:
  - alert: ServiceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service {{ $labels.instance }} is down"
      description: "{{ $labels.instance }} has been down for more than 1 minute."
  
  - alert: HighMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage on {{ $labels.instance }}"
      description: "Memory usage is above 90% for more than 5 minutes."
  
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage on {{ $labels.instance }}"
      description: "CPU usage is above 80% for more than 5 minutes."
  
  - alert: DatabaseConnectionFailure
    expr: increase(database_connection_errors_total[5m]) > 5
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Database connection failures detected"
      description: "More than 5 database connection failures in the last 5 minutes."
```

### 3. Grafana仪表板
```json
{
  "dashboard": {
    "title": "零碳园区系统监控",
    "panels": [
      {
        "title": "系统概览",
        "type": "stat",
        "targets": [
          {
            "expr": "up",
            "legendFormat": "服务状态"
          }
        ]
      },
      {
        "title": "API请求量",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{uri}}"
          }
        ]
      },
      {
        "title": "响应时间",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          }
        ]
      }
    ]
  }
}
```

## 🔧 运维操作

### 1. 日常维护脚本

#### 1.1 健康检查脚本
```bash
#!/bin/bash
# health-check.sh

echo "=== 零碳园区系统健康检查 ==="
echo "检查时间: $(date)"
echo ""

# 检查服务状态
echo "=== 服务状态检查 ==="
services=("gateway" "carbon-accounting" "energy-optimization" "enterprise-diagnosis")
for service in "${services[@]}"; do
    if docker-compose ps $service | grep -q "Up"; then
        echo "✅ $service: 正常运行"
    else
        echo "❌ $service: 服务异常"
        docker-compose logs --tail=10 $service
    fi
done

# 检查数据库连接
echo ""
echo "=== 数据库连接检查 ==="
if docker-compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then
    echo "✅ PostgreSQL: 连接正常"
else
    echo "❌ PostgreSQL: 连接异常"
fi

if docker-compose exec -T redis redis-cli ping | grep -q "PONG"; then
    echo "✅ Redis: 连接正常"
else
    echo "❌ Redis: 连接异常"
fi

# 检查磁盘空间
echo ""
echo "=== 磁盘空间检查 ==="
disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $disk_usage -gt 80 ]; then
    echo "⚠️  磁盘使用率: ${disk_usage}% (警告: 超过80%)" 
else
    echo "✅ 磁盘使用率: ${disk_usage}%"
fi

# 检查内存使用
echo ""
echo "=== 内存使用检查 ==="
mem_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
echo "内存使用率: ${mem_usage}%"

echo ""
echo "=== 检查完成 ==="
```

#### 1.2 备份脚本
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/zero-carbon"
DATE=$(date +%Y%m%d_%H%M%S)

echo "=== 开始备份 ==="
echo "备份时间: $(date)"
echo "备份目录: $BACKUP_DIR"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份PostgreSQL数据库
echo "备份PostgreSQL数据库..."
docker-compose exec -T postgres pg_dumpall -U postgres | gzip > $BACKUP_DIR/postgres_$DATE.sql.gz

# 备份InfluxDB数据
echo "备份InfluxDB数据..."
docker-compose exec -T influxdb influx backup /tmp/backup
docker cp $(docker-compose ps -q influxdb):/tmp/backup $BACKUP_DIR/influxdb_$DATE

# 备份Redis数据
echo "备份Redis数据..."
docker-compose exec -T redis redis-cli BGSAVE
sleep 5
docker cp $(docker-compose ps -q redis):/data/dump.rdb $BACKUP_DIR/redis_$DATE.rdb

# 备份配置文件
echo "备份配置文件..."
tar -czf $BACKUP_DIR/config_$DATE.tar.gz docker-compose.yml .env nginx/

# 清理旧备份 (保留7天)
find $BACKUP_DIR -name "*" -mtime +7 -delete

echo "备份完成: $BACKUP_DIR"
echo "备份文件列表:"
ls -lh $BACKUP_DIR/*$DATE*
```

#### 1.3 日志轮转配置
```bash
# /etc/logrotate.d/zero-carbon
/var/log/zero-carbon/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        docker-compose restart nginx
    endscript
}
```

### 2. 故障排查指南

#### 2.1 常见问题诊断

**问题1: 服务启动失败**
```bash
# 查看服务日志
docker-compose logs [service-name]

# 检查配置文件
docker-compose config

# 检查端口占用
netstat -tulpn | grep [port]

# 重启服务
docker-compose restart [service-name]
```

**问题2: 数据库连接失败**
```bash
# 检查数据库状态
docker-compose exec postgres pg_isready -U postgres

# 查看数据库日志
docker-compose logs postgres

# 检查网络连接
docker-compose exec [service] ping postgres

# 重置数据库连接池
docker-compose restart [service-name]
```

**问题3: 内存不足**
```bash
# 查看内存使用
docker stats

# 清理Docker缓存
docker system prune -f

# 调整JVM内存参数
# 在docker-compose.yml中添加:
# environment:
#   - JAVA_OPTS=-Xmx1g -Xms512m
```

#### 2.2 性能调优

**数据库优化**
```sql
-- PostgreSQL性能调优
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET work_mem = '4MB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
SELECT pg_reload_conf();
```

**应用优化**
```yaml
# 增加JVM参数优化
environment:
  - JAVA_OPTS=-Xmx2g -Xms1g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
  - SPRING_PROFILES_ACTIVE=production
```

### 3. 安全维护

#### 3.1 安全检查清单
```bash
#!/bin/bash
# security-check.sh

echo "=== 安全检查 ==="

# 检查SSL证书有效期
echo "检查SSL证书..."
ssl_expiry=$(openssl x509 -in /etc/nginx/ssl/cert.pem -noout -enddate | cut -d= -f2)
echo "SSL证书到期时间: $ssl_expiry"

# 检查开放端口
echo "检查开放端口..."
nmap -sT localhost

# 检查Docker镜像漏洞
echo "检查Docker镜像安全..."
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image zero-carbon/gateway:v2.0

# 检查系统更新
echo "检查系统更新..."
apt list --upgradable

echo "安全检查完成"
```

#### 3.2 密码轮换脚本
```bash
#!/bin/bash
# rotate-passwords.sh

echo "=== 密码轮换 ==="

# 生成新密码
new_db_password=$(openssl rand -base64 32)
new_redis_password=$(openssl rand -base64 32)

# 更新.env文件
sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=$new_db_password/" .env
sed -i "s/REDIS_PASSWORD=.*/REDIS_PASSWORD=$new_redis_password/" .env

# 重启服务
docker-compose down
docker-compose up -d

echo "密码轮换完成"
```

## 📞 技术支持

### 联系方式
- **技术支持邮箱**: kmxunan@gmail.com
- **紧急联系电话**: +86-138-8892-0284
- **在线文档**: https://docs.zero-carbon-park.com
- **GitHub仓库**: https://github.com/zero-carbon/digital-twin

### 支持时间
- **工作日**: 9:00-18:00 (标准支持)
- **7x24小时**: 紧急故障支持
- **响应时间**: 4小时内响应，24小时内解决

---

**文档版本**: V2.0  
**最后更新**: 2025年6月10日  
**维护团队**: 零碳园区数字孪生系统运维团队