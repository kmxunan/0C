# é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿç³»ç»Ÿéƒ¨ç½²è¿ç»´æŒ‡å—

ç‰ˆæœ¬ï¼šV2.0  
ç¼–åˆ¶æ—¥æœŸï¼š2025å¹´6æœˆ10æ—¥  
çŠ¶æ€ï¼šâœ… ç”Ÿäº§å°±ç»ª

## ğŸ“‹ æŒ‡å—æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿç³»ç»ŸV2.0çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€é…ç½®ã€ç›‘æ§å’Œè¿ç»´æµç¨‹ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆè¿è¡Œã€‚

## ğŸ¯ éƒ¨ç½²æ¶æ„æ¦‚è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”Ÿäº§ç¯å¢ƒæ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è´Ÿè½½å‡è¡¡å±‚ â”‚        Nginx + HAProxy                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç½‘å…³å±‚    â”‚        Spring Cloud Gateway              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åº”ç”¨å±‚    â”‚ èƒ½ç¢³æ ¸ç®— â”‚ ä¼˜åŒ–è°ƒåº¦ â”‚ ä¼ä¸šè¯Šæ–­ â”‚ èµ„æºå¾ªç¯ â”‚
â”‚          â”‚  æœåŠ¡   â”‚   æœåŠ¡   â”‚   æœåŠ¡   â”‚   æœåŠ¡   â”‚
â”‚          â”‚ è™šæ‹Ÿç”µå‚ â”‚ æ•°æ®èµ„äº§ â”‚ ç”³æŠ¥éªŒæ”¶ â”‚ åŸºç¡€è®¾æ–½ â”‚
â”‚          â”‚  æœåŠ¡   â”‚   æœåŠ¡   â”‚   æœåŠ¡   â”‚   æœåŠ¡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•°æ®å±‚    â”‚ PostgreSQL â”‚ InfluxDB â”‚ MongoDB â”‚ Redis  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸºç¡€è®¾æ–½  â”‚        Kubernetes + Docker               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¯å¢ƒè¦æ±‚

| ç»„ä»¶ç±»å‹ | æœ€ä½é…ç½® | æ¨èé…ç½® | ç”Ÿäº§é…ç½® |
|---------|---------|---------|----------|
| **åº”ç”¨æœåŠ¡å™¨** | 4C8G | 8C16G | 16C32G |
| **æ•°æ®åº“æœåŠ¡å™¨** | 8C16G | 16C32G | 32C64G |
| **ç¼“å­˜æœåŠ¡å™¨** | 4C8G | 8C16G | 16C32G |
| **å­˜å‚¨ç©ºé—´** | 500GB | 2TB | 10TB |
| **ç½‘ç»œå¸¦å®½** | 100Mbps | 1Gbps | 10Gbps |

## ğŸš€ éƒ¨ç½²å‡†å¤‡

### 1. ç¯å¢ƒæ£€æŸ¥æ¸…å•

#### 1.1 æ“ä½œç³»ç»Ÿè¦æ±‚
```bash
# æ”¯æŒçš„æ“ä½œç³»ç»Ÿ
- Ubuntu 20.04 LTS / 22.04 LTS
- CentOS 8 / Rocky Linux 8
- Red Hat Enterprise Linux 8

# ç³»ç»Ÿæ£€æŸ¥è„šæœ¬
#!/bin/bash
echo "=== ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥ ==="
echo "æ“ä½œç³»ç»Ÿ: $(lsb_release -d | cut -f2)"
echo "å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
echo "CPUæ ¸æ•°: $(nproc)"
echo "å†…å­˜å¤§å°: $(free -h | grep Mem | awk '{print $2}')"
echo "ç£ç›˜ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
echo "ç½‘ç»œè¿æ¥: $(ping -c 1 8.8.8.8 > /dev/null && echo 'æ­£å¸¸' || echo 'å¼‚å¸¸')"
```

#### 1.2 ä¾èµ–è½¯ä»¶å®‰è£…
```bash
# Dockerå®‰è£…
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Docker Composeå®‰è£…
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Kuberneteså®‰è£… (ä½¿ç”¨kubeadm)
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
```

### 2. ç½‘ç»œé…ç½®

#### 2.1 é˜²ç«å¢™é…ç½®
```bash
# UFWé˜²ç«å¢™é…ç½®
sudo ufw enable
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 6443/tcp  # Kubernetes API
sudo ufw allow 8080:8090/tcp  # åº”ç”¨æœåŠ¡ç«¯å£èŒƒå›´

# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
sudo ufw status verbose
```

#### 2.2 åŸŸåå’ŒSSLè¯ä¹¦
```bash
# ä½¿ç”¨Let's Encryptè·å–SSLè¯ä¹¦
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d api.your-domain.com

# è¯ä¹¦è‡ªåŠ¨ç»­æœŸ
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

## ğŸ³ Dockeréƒ¨ç½²æ–¹æ¡ˆ

### 1. Docker Composeé…ç½®

#### 1.1 ä¸»é…ç½®æ–‡ä»¶ (docker-compose.yml)
```yaml
version: '3.8'

services:
  # APIç½‘å…³
  gateway:
    image: zero-carbon/gateway:v2.0
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka
    depends_on:
      - eureka
      - redis
    networks:
      - zero-carbon-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # æœåŠ¡æ³¨å†Œä¸­å¿ƒ
  eureka:
    image: zero-carbon/eureka:v2.0
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=production
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # ç¢³æ’æ”¾æ ¸ç®—æœåŠ¡
  carbon-accounting:
    image: zero-carbon/carbon-accounting:v2.0
    ports:
      - "8081:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - DATABASE_URL=jdbc:postgresql://postgres:5432/carbon_accounting
      - DATABASE_USERNAME=carbon_user
      - DATABASE_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka
    depends_on:
      - postgres
      - redis
      - eureka
    networks:
      - zero-carbon-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  # èƒ½æºä¼˜åŒ–è°ƒåº¦æœåŠ¡
  energy-optimization:
    image: zero-carbon/energy-optimization:v2.0
    ports:
      - "8082:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - DATABASE_URL=jdbc:postgresql://postgres:5432/energy_optimization
      - DATABASE_USERNAME=energy_user
      - DATABASE_PASSWORD=${DB_PASSWORD}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka
    depends_on:
      - postgres
      - influxdb
      - eureka
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=zero_carbon
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - zero-carbon-network
    restart: unless-stopped
    command: [
      "postgres",
      "-c", "max_connections=200",
      "-c", "shared_buffers=256MB",
      "-c", "effective_cache_size=1GB",
      "-c", "work_mem=4MB",
      "-c", "maintenance_work_mem=64MB"
    ]

  # InfluxDBæ—¶åºæ•°æ®åº“
  influxdb:
    image: influxdb:2.7
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=zero-carbon
      - DOCKER_INFLUXDB_INIT_BUCKET=energy-data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # MongoDBæ–‡æ¡£æ•°æ®åº“
  mongodb:
    image: mongo:6
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
    volumes:
      - mongodb_data:/data/db
    networks:
      - zero-carbon-network
    restart: unless-stopped

  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - gateway
    networks:
      - zero-carbon-network
    restart: unless-stopped

volumes:
  postgres_data:
  influxdb_data:
  redis_data:
  mongodb_data:

networks:
  zero-carbon-network:
    driver: bridge
```

#### 1.2 ç¯å¢ƒå˜é‡é…ç½® (.env)
```bash
# æ•°æ®åº“å¯†ç 
POSTGRES_PASSWORD=your_secure_postgres_password
DB_PASSWORD=your_secure_db_password
INFLUXDB_PASSWORD=your_secure_influxdb_password
INFLUXDB_TOKEN=your_secure_influxdb_token
REDIS_PASSWORD=your_secure_redis_password
MONGO_PASSWORD=your_secure_mongo_password

# JWTå¯†é’¥
JWT_SECRET=your_jwt_secret_key_at_least_256_bits

# å¤–éƒ¨APIå¯†é’¥
WEATHER_API_KEY=your_weather_api_key
GRID_API_KEY=your_grid_api_key

# ç›‘æ§é…ç½®
PROMETHEUS_RETENTION=30d
GRAFANA_ADMIN_PASSWORD=your_grafana_password
```

#### 1.3 Nginxé…ç½®
```nginx
# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream gateway {
        server gateway:8080;
    }
    
    # HTTPé‡å®šå‘åˆ°HTTPS
    server {
        listen 80;
        server_name your-domain.com;
        return 301 https://$server_name$request_uri;
    }
    
    # HTTPSé…ç½®
    server {
        listen 443 ssl http2;
        server_name your-domain.com;
        
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        
        # å®‰å…¨å¤´
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
        
        # APIä»£ç†
        location /api/ {
            proxy_pass http://gateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # é™æ€æ–‡ä»¶
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        # å¥åº·æ£€æŸ¥
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

### 2. éƒ¨ç½²è„šæœ¬

#### 2.1 ä¸€é”®éƒ¨ç½²è„šæœ¬ (deploy.sh)
```bash
#!/bin/bash

set -e

echo "=== é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿç³»ç»Ÿéƒ¨ç½²è„šæœ¬ ==="

# æ£€æŸ¥Dockerå’ŒDocker Compose
if ! command -v docker &> /dev/null; then
    echo "é”™è¯¯: Dockeræœªå®‰è£…"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "é”™è¯¯: Docker Composeæœªå®‰è£…"
    exit 1
fi

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p nginx/ssl nginx/logs
mkdir -p init-scripts
mkdir -p data/postgres data/influxdb data/redis data/mongodb

# è®¾ç½®æƒé™
sudo chown -R 999:999 data/postgres
sudo chown -R 1000:1000 data/influxdb

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
if [ ! -f .env ]; then
    echo "é”™è¯¯: .envæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆé…ç½®ç¯å¢ƒå˜é‡"
    exit 1
fi

# æ‹‰å–æœ€æ–°é•œåƒ
echo "æ‹‰å–Dockeré•œåƒ..."
docker-compose pull

# å¯åŠ¨æœåŠ¡
echo "å¯åŠ¨æœåŠ¡..."
docker-compose up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# å¥åº·æ£€æŸ¥
echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
for service in gateway carbon-accounting energy-optimization; do
    if docker-compose ps $service | grep -q "Up"; then
        echo "âœ… $service æœåŠ¡æ­£å¸¸"
    else
        echo "âŒ $service æœåŠ¡å¼‚å¸¸"
        docker-compose logs $service
    fi
done

# æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
echo ""
echo "=== éƒ¨ç½²å®Œæˆ ==="
echo "ç³»ç»Ÿè®¿é—®åœ°å€: https://your-domain.com"
echo "APIæ–‡æ¡£åœ°å€: https://your-domain.com/api/swagger-ui.html"
echo "ç›‘æ§é¢æ¿åœ°å€: https://your-domain.com/grafana"
echo ""
echo "æŸ¥çœ‹æœåŠ¡çŠ¶æ€: docker-compose ps"
echo "æŸ¥çœ‹æœåŠ¡æ—¥å¿—: docker-compose logs [service-name]"
echo "åœæ­¢æ‰€æœ‰æœåŠ¡: docker-compose down"
```

#### 2.2 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
```sql
-- init-scripts/01-create-databases.sql
CREATE DATABASE carbon_accounting;
CREATE DATABASE energy_optimization;
CREATE DATABASE enterprise_diagnosis;
CREATE DATABASE resource_circulation;
CREATE DATABASE virtual_power_plant;
CREATE DATABASE data_assets;

-- åˆ›å»ºç”¨æˆ·
CREATE USER carbon_user WITH PASSWORD 'your_password';
CREATE USER energy_user WITH PASSWORD 'your_password';
CREATE USER enterprise_user WITH PASSWORD 'your_password';
CREATE USER resource_user WITH PASSWORD 'your_password';
CREATE USER vpp_user WITH PASSWORD 'your_password';
CREATE USER data_user WITH PASSWORD 'your_password';

-- æˆæƒ
GRANT ALL PRIVILEGES ON DATABASE carbon_accounting TO carbon_user;
GRANT ALL PRIVILEGES ON DATABASE energy_optimization TO energy_user;
GRANT ALL PRIVILEGES ON DATABASE enterprise_diagnosis TO enterprise_user;
GRANT ALL PRIVILEGES ON DATABASE resource_circulation TO resource_user;
GRANT ALL PRIVILEGES ON DATABASE virtual_power_plant TO vpp_user;
GRANT ALL PRIVILEGES ON DATABASE data_assets TO data_user;
```

## â˜¸ï¸ Kuberneteséƒ¨ç½²æ–¹æ¡ˆ

### 1. å¿«é€Ÿéƒ¨ç½²æŒ‡å—

#### 1.1 éƒ¨ç½²æ­¥éª¤

```bash
# 1. åˆ›å»ºå‘½åç©ºé—´å’ŒåŸºç¡€èµ„æº
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/storage.yaml

# 2. åˆ›å»ºé…ç½®å’Œå¯†é’¥
kubectl apply -f k8s/configmaps.yaml
kubectl apply -f k8s/secrets.yaml

# 3. éƒ¨ç½²æ•°æ®åº“æœåŠ¡
kubectl apply -f k8s/database-deployment.yaml

# 4. éƒ¨ç½²åº”ç”¨æœåŠ¡
kubectl apply -f k8s/app-deployments.yaml

# 5. é…ç½®Ingress
kubectl apply -f k8s/ingress.yaml

# 6. éªŒè¯éƒ¨ç½²
kubectl get pods -n zero-carbon
kubectl get services -n zero-carbon
kubectl get ingress -n zero-carbon
```

#### 1.2 éƒ¨ç½²éªŒè¯

```bash
# æ£€æŸ¥PodçŠ¶æ€
kubectl get pods -n zero-carbon -o wide

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get svc -n zero-carbon

# æ£€æŸ¥HPAçŠ¶æ€
kubectl get hpa -n zero-carbon

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/carbon-accounting -n zero-carbon

# ç«¯å£è½¬å‘æµ‹è¯•
kubectl port-forward svc/gateway-service 8080:80 -n zero-carbon
```

### 2. å‘½åç©ºé—´é…ç½®
```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: zero-carbon
  labels:
    name: zero-carbon
    environment: production
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: zero-carbon-quota
  namespace: zero-carbon
spec:
  hard:
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    persistentvolumeclaims: "10"
```

### 2. é…ç½®ç®¡ç†
```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: zero-carbon
data:
  application.yml: |
    spring:
      profiles:
        active: production
      datasource:
        url: jdbc:postgresql://postgres-service:5432/zero_carbon
        username: ${DATABASE_USERNAME}
        password: ${DATABASE_PASSWORD}
      redis:
        host: redis-service
        port: 6379
        password: ${REDIS_PASSWORD}
    eureka:
      client:
        service-url:
          defaultZone: http://eureka-service:8761/eureka
    management:
      endpoints:
        web:
          exposure:
            include: health,info,metrics,prometheus
      endpoint:
        health:
          show-details: always
```

### 3. å¯†é’¥ç®¡ç†
```yaml
# k8s/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: zero-carbon
type: Opaque
data:
  database-username: Y2FyYm9uX3VzZXI=  # base64ç¼–ç 
  database-password: eW91cl9zZWN1cmVfcGFzc3dvcmQ=
  redis-password: eW91cl9yZWRpc19wYXNzd29yZA==
  jwt-secret: eW91cl9qd3Rfc2VjcmV0X2tleQ==
```

### 4. åº”ç”¨éƒ¨ç½²
```yaml
# k8s/carbon-accounting-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: carbon-accounting
  namespace: zero-carbon
  labels:
    app: carbon-accounting
spec:
  replicas: 3
  selector:
    matchLabels:
      app: carbon-accounting
  template:
    metadata:
      labels:
        app: carbon-accounting
    spec:
      containers:
      - name: carbon-accounting
        image: zero-carbon/carbon-accounting:v2.0
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: DATABASE_USERNAME
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: database-username
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: database-password
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: redis-password
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      volumes:
      - name: config-volume
        configMap:
          name: app-config
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: carbon-accounting-service
  namespace: zero-carbon
spec:
  selector:
    app: carbon-accounting
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP
```

### 5. Ingressé…ç½®
```yaml
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: zero-carbon-ingress
  namespace: zero-carbon
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
  - hosts:
    - your-domain.com
    - api.your-domain.com
    secretName: zero-carbon-tls
  rules:
  - host: your-domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
  - host: api.your-domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gateway-service
            port:
              number: 80
```

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### 1. ç›‘æ§ç³»ç»Ÿéƒ¨ç½²

#### 1.1 å¿«é€Ÿéƒ¨ç½²ç›‘æ§ç³»ç»Ÿ

```bash
# ä½¿ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
chmod +x scripts/monitoring/setup-monitoring.sh
./scripts/monitoring/setup-monitoring.sh

# æ£€æŸ¥ç›‘æ§æœåŠ¡çŠ¶æ€
./scripts/monitoring/health-check.sh

# å¯åŠ¨æŒç»­å¥åº·æ£€æŸ¥
./scripts/monitoring/health-check.sh --continuous --interval 60
```

#### 1.2 ç›‘æ§ç»„ä»¶è®¿é—®

- **Grafanaä»ªè¡¨æ¿**: http://localhost:3000 (admin/admin123)
- **Prometheus**: http://localhost:9090
- **AlertManager**: http://localhost:9093
- **Node Exporter**: http://localhost:9100
- **Redisç›‘æ§**: http://localhost:9121

### 2. Prometheusç›‘æ§é…ç½®

ç›‘æ§é…ç½®æ–‡ä»¶ä½äº `config/prometheus/prometheus.yml`ï¼ŒåŒ…å«ä»¥ä¸‹ç›‘æ§ç›®æ ‡ï¼š

- é›¶ç¢³å›­åŒºä¸»åº”ç”¨ (ç«¯å£: 3001)
- Node Exporterç³»ç»ŸæŒ‡æ ‡ (ç«¯å£: 9100)
- Redisç¼“å­˜æœåŠ¡ (ç«¯å£: 6379)
- MQTTæ¶ˆæ¯ä»£ç† (ç«¯å£: 1883)
- å„ä¸šåŠ¡æ¨¡å—è‡ªå®šä¹‰æŒ‡æ ‡

```yaml
# monitoring/prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    rule_files:
      - "alert_rules.yml"
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    scrape_configs:
      - job_name: 'zero-carbon-system'
        static_configs:
          - targets: ['energy-system:3001']
        metrics_path: '/api/metrics'
        scrape_interval: 30s
      
      - job_name: 'node-exporter'
        static_configs:
          - targets: ['node-exporter:9100']
        scrape_interval: 15s
      
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: default;kubernetes;https
      
      - job_name: 'zero-carbon-apps'
        kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
            - zero-carbon
        relabel_configs:
        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
```

### 2. å‘Šè­¦è§„åˆ™é…ç½®
```yaml
# monitoring/alert-rules.yaml
groups:
- name: zero-carbon-alerts
  rules:
  - alert: ServiceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service {{ $labels.instance }} is down"
      description: "{{ $labels.instance }} has been down for more than 1 minute."
  
  - alert: HighMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage on {{ $labels.instance }}"
      description: "Memory usage is above 90% for more than 5 minutes."
  
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage on {{ $labels.instance }}"
      description: "CPU usage is above 80% for more than 5 minutes."
  
  - alert: DatabaseConnectionFailure
    expr: increase(database_connection_errors_total[5m]) > 5
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Database connection failures detected"
      description: "More than 5 database connection failures in the last 5 minutes."
```

### 3. Grafanaä»ªè¡¨æ¿
```json
{
  "dashboard": {
    "title": "é›¶ç¢³å›­åŒºç³»ç»Ÿç›‘æ§",
    "panels": [
      {
        "title": "ç³»ç»Ÿæ¦‚è§ˆ",
        "type": "stat",
        "targets": [
          {
            "expr": "up",
            "legendFormat": "æœåŠ¡çŠ¶æ€"
          }
        ]
      },
      {
        "title": "APIè¯·æ±‚é‡",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{uri}}"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          }
        ]
      }
    ]
  }
}
```

## ğŸ”§ è¿ç»´æ“ä½œ

### 1. æ—¥å¸¸ç»´æŠ¤è„šæœ¬

#### 1.1 å¥åº·æ£€æŸ¥è„šæœ¬
```bash
#!/bin/bash
# health-check.sh

echo "=== é›¶ç¢³å›­åŒºç³»ç»Ÿå¥åº·æ£€æŸ¥ ==="
echo "æ£€æŸ¥æ—¶é—´: $(date)"
echo ""

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "=== æœåŠ¡çŠ¶æ€æ£€æŸ¥ ==="
services=("gateway" "carbon-accounting" "energy-optimization" "enterprise-diagnosis")
for service in "${services[@]}"; do
    if docker-compose ps $service | grep -q "Up"; then
        echo "âœ… $service: æ­£å¸¸è¿è¡Œ"
    else
        echo "âŒ $service: æœåŠ¡å¼‚å¸¸"
        docker-compose logs --tail=10 $service
    fi
done

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo ""
echo "=== æ•°æ®åº“è¿æ¥æ£€æŸ¥ ==="
if docker-compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then
    echo "âœ… PostgreSQL: è¿æ¥æ­£å¸¸"
else
    echo "âŒ PostgreSQL: è¿æ¥å¼‚å¸¸"
fi

if docker-compose exec -T redis redis-cli ping | grep -q "PONG"; then
    echo "âœ… Redis: è¿æ¥æ­£å¸¸"
else
    echo "âŒ Redis: è¿æ¥å¼‚å¸¸"
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
echo ""
echo "=== ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $disk_usage -gt 80 ]; then
    echo "âš ï¸  ç£ç›˜ä½¿ç”¨ç‡: ${disk_usage}% (è­¦å‘Š: è¶…è¿‡80%)" 
else
    echo "âœ… ç£ç›˜ä½¿ç”¨ç‡: ${disk_usage}%"
fi

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
echo ""
echo "=== å†…å­˜ä½¿ç”¨æ£€æŸ¥ ==="
mem_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
echo "å†…å­˜ä½¿ç”¨ç‡: ${mem_usage}%"

echo ""
echo "=== æ£€æŸ¥å®Œæˆ ==="
```

#### 1.2 å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/zero-carbon"
DATE=$(date +%Y%m%d_%H%M%S)

echo "=== å¼€å§‹å¤‡ä»½ ==="
echo "å¤‡ä»½æ—¶é—´: $(date)"
echo "å¤‡ä»½ç›®å½•: $BACKUP_DIR"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½PostgreSQLæ•°æ®åº“
echo "å¤‡ä»½PostgreSQLæ•°æ®åº“..."
docker-compose exec -T postgres pg_dumpall -U postgres | gzip > $BACKUP_DIR/postgres_$DATE.sql.gz

# å¤‡ä»½InfluxDBæ•°æ®
echo "å¤‡ä»½InfluxDBæ•°æ®..."
docker-compose exec -T influxdb influx backup /tmp/backup
docker cp $(docker-compose ps -q influxdb):/tmp/backup $BACKUP_DIR/influxdb_$DATE

# å¤‡ä»½Redisæ•°æ®
echo "å¤‡ä»½Redisæ•°æ®..."
docker-compose exec -T redis redis-cli BGSAVE
sleep 5
docker cp $(docker-compose ps -q redis):/data/dump.rdb $BACKUP_DIR/redis_$DATE.rdb

# å¤‡ä»½é…ç½®æ–‡ä»¶
echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
tar -czf $BACKUP_DIR/config_$DATE.tar.gz docker-compose.yml .env nginx/

# æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™7å¤©)
find $BACKUP_DIR -name "*" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
echo "å¤‡ä»½æ–‡ä»¶åˆ—è¡¨:"
ls -lh $BACKUP_DIR/*$DATE*
```

#### 1.3 æ—¥å¿—è½®è½¬é…ç½®
```bash
# /etc/logrotate.d/zero-carbon
/var/log/zero-carbon/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        docker-compose restart nginx
    endscript
}
```

### 2. æ•…éšœæ’æŸ¥æŒ‡å—

#### 2.1 å¸¸è§é—®é¢˜è¯Šæ–­

**é—®é¢˜1: æœåŠ¡å¯åŠ¨å¤±è´¥**
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs [service-name]

# æ£€æŸ¥é…ç½®æ–‡ä»¶
docker-compose config

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep [port]

# é‡å¯æœåŠ¡
docker-compose restart [service-name]
```

**é—®é¢˜2: æ•°æ®åº“è¿æ¥å¤±è´¥**
```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
docker-compose exec postgres pg_isready -U postgres

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker-compose logs postgres

# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker-compose exec [service] ping postgres

# é‡ç½®æ•°æ®åº“è¿æ¥æ± 
docker-compose restart [service-name]
```

**é—®é¢˜3: å†…å­˜ä¸è¶³**
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
docker stats

# æ¸…ç†Dockerç¼“å­˜
docker system prune -f

# è°ƒæ•´JVMå†…å­˜å‚æ•°
# åœ¨docker-compose.ymlä¸­æ·»åŠ :
# environment:
#   - JAVA_OPTS=-Xmx1g -Xms512m
```

#### 2.2 æ€§èƒ½è°ƒä¼˜

**æ•°æ®åº“ä¼˜åŒ–**
```sql
-- PostgreSQLæ€§èƒ½è°ƒä¼˜
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET work_mem = '4MB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
SELECT pg_reload_conf();
```

**åº”ç”¨ä¼˜åŒ–**
```yaml
# å¢åŠ JVMå‚æ•°ä¼˜åŒ–
environment:
  - JAVA_OPTS=-Xmx2g -Xms1g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
  - SPRING_PROFILES_ACTIVE=production
```

### 3. å®‰å…¨ç»´æŠ¤

#### 3.1 å®‰å…¨æ£€æŸ¥æ¸…å•
```bash
#!/bin/bash
# security-check.sh

echo "=== å®‰å…¨æ£€æŸ¥ ==="

# æ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæœŸ
echo "æ£€æŸ¥SSLè¯ä¹¦..."
ssl_expiry=$(openssl x509 -in /etc/nginx/ssl/cert.pem -noout -enddate | cut -d= -f2)
echo "SSLè¯ä¹¦åˆ°æœŸæ—¶é—´: $ssl_expiry"

# æ£€æŸ¥å¼€æ”¾ç«¯å£
echo "æ£€æŸ¥å¼€æ”¾ç«¯å£..."
nmap -sT localhost

# æ£€æŸ¥Dockeré•œåƒæ¼æ´
echo "æ£€æŸ¥Dockeré•œåƒå®‰å…¨..."
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image zero-carbon/gateway:v2.0

# æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
echo "æ£€æŸ¥ç³»ç»Ÿæ›´æ–°..."
apt list --upgradable

echo "å®‰å…¨æ£€æŸ¥å®Œæˆ"
```

#### 3.2 å¯†ç è½®æ¢è„šæœ¬
```bash
#!/bin/bash
# rotate-passwords.sh

echo "=== å¯†ç è½®æ¢ ==="

# ç”Ÿæˆæ–°å¯†ç 
new_db_password=$(openssl rand -base64 32)
new_redis_password=$(openssl rand -base64 32)

# æ›´æ–°.envæ–‡ä»¶
sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=$new_db_password/" .env
sed -i "s/REDIS_PASSWORD=.*/REDIS_PASSWORD=$new_redis_password/" .env

# é‡å¯æœåŠ¡
docker-compose down
docker-compose up -d

echo "å¯†ç è½®æ¢å®Œæˆ"
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è”ç³»æ–¹å¼
- **æŠ€æœ¯æ”¯æŒé‚®ç®±**: kmxunan@gmail.com
- **ç´§æ€¥è”ç³»ç”µè¯**: +86-138-8892-0284
- **åœ¨çº¿æ–‡æ¡£**: https://docs.zero-carbon-park.com
- **GitHubä»“åº“**: https://github.com/zero-carbon/digital-twin

### æ”¯æŒæ—¶é—´
- **å·¥ä½œæ—¥**: 9:00-18:00 (æ ‡å‡†æ”¯æŒ)
- **7x24å°æ—¶**: ç´§æ€¥æ•…éšœæ”¯æŒ
- **å“åº”æ—¶é—´**: 4å°æ—¶å†…å“åº”ï¼Œ24å°æ—¶å†…è§£å†³

---

**æ–‡æ¡£ç‰ˆæœ¬**: V2.0  
**æœ€åæ›´æ–°**: 2025å¹´6æœˆ10æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿç³»ç»Ÿè¿ç»´å›¢é˜Ÿ