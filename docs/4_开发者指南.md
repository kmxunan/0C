# 零碳园区数字孪生系统 - 开发者指南

## 概述

本指南为零碳园区数字孪生系统的开发者提供详细的开发环境搭建、代码规范、构建部署等指导信息。系统采用现代化的技术栈和开发工具链，确保代码质量和开发效率。

## 详细环境搭建

### 1. 系统要求

#### 操作系统
- **推荐**: macOS 12+ / Ubuntu 20.04+ / Windows 10+
- **内存**: 最低8GB，推荐16GB+
- **存储**: 最低20GB可用空间
- **网络**: 稳定的互联网连接

#### 必需软件版本

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Node.js | 18.0+ | JavaScript运行时 |
| npm | 9.0+ | 包管理器 |
| Java | 11+ | 后端运行环境 |
| Maven | 3.8+ | Java构建工具 |
| MySQL | 8.0+ | 主数据库 |
| Redis | 6.0+ | 缓存数据库 |
| Docker | 20.0+ | 容器化平台 |
| Git | 2.30+ | 版本控制 |

### 2. 开发工具推荐

#### IDE选择

**前端开发**:
- **主推**: Visual Studio Code
- **备选**: WebStorm, Sublime Text

**后端开发**:
- **主推**: IntelliJ IDEA
- **备选**: Eclipse, Visual Studio Code

#### VS Code必装插件

```json
{
  "recommendations": [
    "ms-vscode.vscode-eslint",
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "ms-vscode.vscode-typescript-next",
    "formulahendry.auto-rename-tag",
    "christian-kohler.path-intellisense",
    "ms-vscode.vscode-json",
    "redhat.vscode-yaml",
    "ms-python.python",
    "ms-vscode.vscode-docker"
  ]
}
```

#### IntelliJ IDEA必装插件

- **Lombok**: 简化Java代码
- **Spring Boot Helper**: Spring Boot开发助手
- **MyBatis Log Plugin**: MyBatis日志插件
- **Rainbow Brackets**: 彩虹括号
- **SonarLint**: 代码质量检查
- **Docker**: Docker集成

### 3. 环境安装步骤

#### 3.1 Node.js环境

```bash
# 使用nvm安装Node.js（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# 安装Node.js 18
nvm install 18
nvm use 18
nvm alias default 18

# 验证安装
node --version  # 应显示 v18.x.x
npm --version   # 应显示 9.x.x

# 配置npm镜像（可选，提升下载速度）
npm config set registry https://registry.npmmirror.com
```

#### 3.2 Java环境

```bash
# macOS使用Homebrew
brew install openjdk@11
echo 'export PATH="/opt/homebrew/opt/openjdk@11/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# Ubuntu
sudo apt update
sudo apt install openjdk-11-jdk

# 验证安装
java -version
javac -version

# 安装Maven
brew install maven  # macOS
sudo apt install maven  # Ubuntu

# 验证Maven
mvn -version
```

#### 3.3 数据库环境

**MySQL安装**:
```bash
# macOS
brew install mysql
brew services start mysql

# Ubuntu
sudo apt update
sudo apt install mysql-server
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation

# 创建开发数据库
mysql -u root -p
CREATE DATABASE zero_carbon_dev CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'dev_user'@'localhost' IDENTIFIED BY 'dev_password';
GRANT ALL PRIVILEGES ON zero_carbon_dev.* TO 'dev_user'@'localhost';
FLUSH PRIVILEGES;
```

**Redis安装**:
```bash
# macOS
brew install redis
brew services start redis

# Ubuntu
sudo apt install redis-server
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 验证Redis
redis-cli ping  # 应返回 PONG
```

#### 3.4 Docker环境

```bash
# macOS - 下载Docker Desktop
# https://www.docker.com/products/docker-desktop

# Ubuntu
sudo apt update
sudo apt install apt-transport-https ca-certificates curl gnupg lsb-release
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install docker-ce docker-ce-cli containerd.io

# 启动Docker
sudo systemctl start docker
sudo systemctl enable docker

# 添加用户到docker组
sudo usermod -aG docker $USER

# 验证安装
docker --version
docker-compose --version
```

### 4. 项目克隆与配置

#### 4.1 克隆项目

```bash
# 克隆项目
git clone https://github.com/kmxunan/0C.git
cd 0C

# 查看项目结构
tree -L 2
```

#### 4.2 环境变量配置

**创建环境配置文件**:
```bash
# 复制环境变量模板
cp .env.example .env
cp frontend/.env.example frontend/.env
cp backend/.env.example backend/.env
```

**根目录 .env 配置**:
```bash
# 应用环境
NODE_ENV=development
PORT=1125

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=zero_carbon_dev
DB_USER=dev_user
DB_PASSWORD=dev_password

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# JWT配置
JWT_SECRET=your_super_secret_jwt_key_here
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# MQTT配置
MQTT_BROKER_URL=mqtt://localhost:1883
MQTT_USERNAME=
MQTT_PASSWORD=

# 区块链配置
BLOCKCHAIN_NETWORK=polygon_mumbai
BLOCKCHAIN_RPC_URL=https://rpc-mumbai.maticvigil.com
PRIVATE_KEY=your_private_key_here
CONTRACT_ADDRESS=0x...

# API配置
API_RATE_LIMIT=100
API_RATE_WINDOW=15
API_TIMEOUT=30000

# 文件存储
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760

# 日志配置
LOG_LEVEL=debug
LOG_FILE=./logs/app.log

# 监控配置
PROMETHEUS_PORT=9090
GRAFANA_PORT=3000
```

**前端 frontend/.env 配置**:
```bash
# API配置
REACT_APP_API_BASE_URL=http://localhost:1125/api/v1
REACT_APP_WS_URL=ws://localhost:1125/ws

# 应用配置
REACT_APP_NAME=零碳园区数字孪生系统
REACT_APP_VERSION=2.0.0

# 地图配置
REACT_APP_MAP_API_KEY=your_map_api_key

# 第三方服务
REACT_APP_ANALYTICS_ID=your_analytics_id

# 开发配置
REACT_APP_DEBUG=true
REACT_APP_MOCK_DATA=false

# 构建配置
GENERATE_SOURCEMAP=true
REACT_APP_BUILD_PATH=./build
```

#### 4.3 依赖安装

**安装根目录依赖**:
```bash
npm install
```

**安装前端依赖**:
```bash
cd frontend
npm install
cd ..
```

**安装后端依赖**:
```bash
cd backend
mvn clean install
cd ..
```

#### 4.4 数据库初始化

```bash
# 运行数据库迁移
npm run db:migrate

# 导入初始数据
npm run db:seed

# 创建VPP相关表
npm run db:create-vpp-tables
```

### 5. 开发服务启动

#### 5.1 启动后端服务

```bash
# 方式1: 使用npm脚本
npm run dev:backend

# 方式2: 直接启动
cd backend
mvn spring-boot:run

# 方式3: 使用IDE
# 在IntelliJ IDEA中运行Application.java
```

#### 5.2 启动前端服务

```bash
# 方式1: 使用npm脚本
npm run dev:frontend

# 方式2: 直接启动
cd frontend
npm start

# 前端将在 http://localhost:7240 启动
```

#### 5.3 启动Node.js服务

```bash
# 开发模式启动
npm run dev

# 或者使用nodemon
npm run dev:watch

# 服务将在 http://localhost:1125 启动
```

#### 5.4 启动所有服务

```bash
# 使用Docker Compose启动所有服务
docker-compose up -d

# 或使用npm脚本
npm run dev:all
```

## 代码风格与规范

### 1. JavaScript/TypeScript规范

#### 1.1 ESLint配置

**根目录 .eslintrc.js**:
```javascript
module.exports = {
  env: {
    browser: true,
    es2021: true,
    node: true,
  },
  extends: [
    'eslint:recommended',
    '@typescript-eslint/recommended',
    'plugin:react/recommended',
    'plugin:react-hooks/recommended',
    'prettier',
  ],
  parser: '@typescript-eslint/parser',
  parserOptions: {
    ecmaFeatures: {
      jsx: true,
    },
    ecmaVersion: 12,
    sourceType: 'module',
  },
  plugins: [
    'react',
    '@typescript-eslint',
    'react-hooks',
  ],
  rules: {
    // 基础规则
    'no-console': 'warn',
    'no-debugger': 'error',
    'no-unused-vars': 'off',
    '@typescript-eslint/no-unused-vars': 'error',
    
    // React规则
    'react/prop-types': 'off',
    'react/react-in-jsx-scope': 'off',
    'react-hooks/rules-of-hooks': 'error',
    'react-hooks/exhaustive-deps': 'warn',
    
    // TypeScript规则
    '@typescript-eslint/explicit-function-return-type': 'off',
    '@typescript-eslint/explicit-module-boundary-types': 'off',
    '@typescript-eslint/no-explicit-any': 'warn',
    
    // 代码风格
    'prefer-const': 'error',
    'no-var': 'error',
    'object-shorthand': 'error',
    'prefer-template': 'error',
  },
  settings: {
    react: {
      version: 'detect',
    },
  },
};
```

#### 1.2 Prettier配置

**.prettierrc**:
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false,
  "bracketSpacing": true,
  "bracketSameLine": false,
  "arrowParens": "avoid",
  "endOfLine": "lf"
}
```

#### 1.3 命名约定

**文件命名**:
- **组件文件**: PascalCase (e.g., `DeviceManagement.tsx`)
- **工具文件**: camelCase (e.g., `apiUtils.ts`)
- **常量文件**: UPPER_SNAKE_CASE (e.g., `API_CONSTANTS.ts`)
- **样式文件**: kebab-case (e.g., `device-management.css`)

**变量命名**:
```typescript
// 常量 - UPPER_SNAKE_CASE
const API_BASE_URL = 'http://localhost:1125/api/v1';
const MAX_RETRY_ATTEMPTS = 3;

// 变量和函数 - camelCase
const deviceList = [];
const isLoading = false;
const fetchDeviceData = async () => {};

// 类和组件 - PascalCase
class DeviceManager {}
const DeviceCard = () => {};

// 接口和类型 - PascalCase
interface DeviceData {
  id: number;
  name: string;
}

type ApiResponse<T> = {
  success: boolean;
  data: T;
};
```

#### 1.4 代码组织

**组件结构**:
```typescript
// DeviceManagement.tsx
import React, { useState, useEffect } from 'react';
import { Button, Table, Modal } from 'antd';
import { useDeviceStore } from '../stores/deviceStore';
import { DeviceService } from '../services/deviceService';
import type { Device } from '../types/device';

// 接口定义
interface DeviceManagementProps {
  onDeviceSelect?: (device: Device) => void;
}

// 组件实现
const DeviceManagement: React.FC<DeviceManagementProps> = ({
  onDeviceSelect,
}) => {
  // State定义
  const [devices, setDevices] = useState<Device[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedDevice, setSelectedDevice] = useState<Device | null>(null);
  
  // Store hooks
  const { addDevice, updateDevice, deleteDevice } = useDeviceStore();
  
  // Effects
  useEffect(() => {
    fetchDevices();
  }, []);
  
  // 事件处理函数
  const handleDeviceSelect = (device: Device) => {
    setSelectedDevice(device);
    onDeviceSelect?.(device);
  };
  
  const fetchDevices = async () => {
    setLoading(true);
    try {
      const response = await DeviceService.getDevices();
      setDevices(response.data);
    } catch (error) {
      console.error('Failed to fetch devices:', error);
    } finally {
      setLoading(false);
    }
  };
  
  // 渲染
  return (
    <div className="device-management">
      {/* 组件内容 */}
    </div>
  );
};

export default DeviceManagement;
```

### 2. Java代码规范

#### 2.1 包结构

```
com.xunan.zerocarbon
├── config/          # 配置类
├── controller/      # 控制器
├── service/         # 服务层
│   ├── impl/        # 服务实现
├── repository/      # 数据访问层
├── entity/          # 实体类
├── dto/             # 数据传输对象
├── vo/              # 视图对象
├── util/            # 工具类
├── exception/       # 异常类
├── constant/        # 常量类
└── Application.java # 启动类
```

#### 2.2 命名约定

```java
// 类名 - PascalCase
public class DeviceManagementService {}
public class VPPTradingController {}

// 方法名 - camelCase
public List<Device> getDeviceList() {}
public void updateDeviceStatus() {}

// 变量名 - camelCase
private String deviceName;
private boolean isActive;

// 常量 - UPPER_SNAKE_CASE
public static final String API_VERSION = "v1";
public static final int MAX_RETRY_COUNT = 3;

// 包名 - 小写，用点分隔
com.xunan.zerocarbon.service.impl
```

#### 2.3 注解使用

```java
// Controller示例
@RestController
@RequestMapping("/api/v1/devices")
@Validated
@Slf4j
public class DeviceController {
    
    @Autowired
    private DeviceService deviceService;
    
    @GetMapping
    @ApiOperation("获取设备列表")
    public ResponseEntity<ApiResponse<PageResult<Device>>> getDevices(
            @RequestParam(defaultValue = "1") @Min(1) Integer page,
            @RequestParam(defaultValue = "20") @Range(min = 1, max = 100) Integer limit,
            @RequestParam(required = false) String type) {
        
        PageResult<Device> result = deviceService.getDevices(page, limit, type);
        return ResponseEntity.ok(ApiResponse.success(result));
    }
}

// Service示例
@Service
@Transactional
@Slf4j
public class DeviceServiceImpl implements DeviceService {
    
    @Autowired
    private DeviceRepository deviceRepository;
    
    @Override
    @Cacheable(value = "devices", key = "#page + '_' + #limit + '_' + #type")
    public PageResult<Device> getDevices(Integer page, Integer limit, String type) {
        log.info("Fetching devices: page={}, limit={}, type={}", page, limit, type);
        
        Pageable pageable = PageRequest.of(page - 1, limit);
        Page<Device> devicePage;
        
        if (StringUtils.hasText(type)) {
            devicePage = deviceRepository.findByType(type, pageable);
        } else {
            devicePage = deviceRepository.findAll(pageable);
        }
        
        return PageResult.of(devicePage);
    }
}
```

#### 2.4 异常处理

```java
// 自定义异常
@Getter
public class BusinessException extends RuntimeException {
    private final String errorCode;
    private final String errorMessage;
    
    public BusinessException(String errorCode, String errorMessage) {
        super(errorMessage);
        this.errorCode = errorCode;
        this.errorMessage = errorMessage;
    }
}

// 全局异常处理
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(BusinessException e) {
        log.warn("Business exception: {}", e.getMessage());
        return ResponseEntity.badRequest()
                .body(ApiResponse.error(e.getErrorCode(), e.getErrorMessage()));
    }
    
    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ApiResponse<Void>> handleValidationException(ValidationException e) {
        log.warn("Validation exception: {}", e.getMessage());
        return ResponseEntity.badRequest()
                .body(ApiResponse.error("VALIDATION_ERROR", e.getMessage()));
    }
}
```

### 3. 数据库规范

#### 3.1 表命名

```sql
-- 表名：小写，下划线分隔
CREATE TABLE device_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id INT NOT NULL,
    metric_name VARCHAR(100) NOT NULL,
    value DECIMAL(15,6) NOT NULL,
    recorded_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引命名：idx_表名_字段名
CREATE INDEX idx_device_data_device_id ON device_data(device_id);
CREATE INDEX idx_device_data_recorded_at ON device_data(recorded_at);

-- 外键命名：fk_表名_字段名
ALTER TABLE device_data 
ADD CONSTRAINT fk_device_data_device_id 
FOREIGN KEY (device_id) REFERENCES devices(id);
```

#### 3.2 字段规范

```sql
-- 主键：统一使用id，BIGINT类型，自增
id BIGINT PRIMARY KEY AUTO_INCREMENT

-- 时间字段：统一使用TIMESTAMP类型
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

-- 状态字段：使用ENUM类型
status ENUM('active', 'inactive', 'maintenance') NOT NULL DEFAULT 'active'

-- 金额字段：使用DECIMAL类型
price DECIMAL(10,4) NOT NULL COMMENT '价格，单位：元'

-- JSON字段：使用JSON类型（MySQL 5.7+）
metadata JSON COMMENT '元数据信息'
```

### 4. Git工作流规范

#### 4.1 分支命名

```bash
# 主分支
main/master     # 生产环境分支
develop         # 开发环境分支

# 功能分支
feature/vpp-trading-system      # 新功能开发
feature/device-management-ui    # UI功能开发

# 修复分支
hotfix/critical-security-fix    # 紧急修复
bugfix/device-data-sync-issue   # 问题修复

# 发布分支
release/v2.1.0                  # 版本发布
```

#### 4.2 提交信息规范

```bash
# 提交信息格式
<type>(<scope>): <subject>

<body>

<footer>

# 类型说明
feat:     新功能
fix:      修复问题
docs:     文档更新
style:    代码格式调整
refactor: 代码重构
test:     测试相关
chore:    构建工具、依赖更新

# 示例
feat(vpp): add trading strategy management

- Add CRUD operations for trading strategies
- Implement strategy validation logic
- Add unit tests for strategy service

Closes #123

fix(device): resolve data synchronization issue

- Fix race condition in device data sync
- Add retry mechanism for failed sync operations
- Update error handling for network timeouts

Fixes #456
```

## 构建与部署流程

### 1. 本地构建

#### 1.1 前端构建

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 代码检查
npm run lint
npm run lint:fix

# 类型检查
npm run type-check

# 运行测试
npm run test
npm run test:coverage

# 构建生产版本
npm run build

# 预览构建结果
npm run preview
```

#### 1.2 后端构建

```bash
# 进入后端目录
cd backend

# 编译项目
mvn clean compile

# 运行测试
mvn test

# 代码质量检查
mvn sonar:sonar

# 打包应用
mvn clean package

# 跳过测试打包（仅开发环境）
mvn clean package -DskipTests

# 构建Docker镜像
mvn spring-boot:build-image
```

#### 1.3 Node.js服务构建

```bash
# 根目录构建
npm run build

# 运行测试
npm run test
npm run test:integration

# 代码覆盖率
npm run test:coverage

# 安全检查
npm audit
npm audit fix

# 性能分析
npm run analyze
```

### 2. Docker构建

#### 2.1 Dockerfile配置

**前端Dockerfile**:
```dockerfile
# frontend/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**后端Dockerfile**:
```dockerfile
# backend/Dockerfile
FROM openjdk:11-jre-slim

WORKDIR /app
COPY target/*.jar app.jar

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**Node.js Dockerfile**:
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 1125
CMD ["npm", "start"]
```

#### 2.2 Docker Compose配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "7240:80"
    depends_on:
      - backend
      - nodejs-api
    networks:
      - app-network

  # Node.js API服务
  nodejs-api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "1125:1125"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    networks:
      - app-network
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads

  # Java后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/zero_carbon
      - SPRING_REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    networks:
      - app-network

  # MySQL数据库
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=zero_carbon
      - MYSQL_USER=app_user
      - MYSQL_PASSWORD=app_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - app-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network

  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto_data:/mosquitto/data
    networks:
      - app-network

  # Prometheus监控
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - app-network

  # Grafana可视化
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - app-network

volumes:
  mysql_data:
  redis_data:
  mosquitto_data:
  prometheus_data:
  grafana_data:

networks:
  app-network:
    driver: bridge
```

### 3. CI/CD流程

#### 3.1 GitHub Actions配置

```yaml
# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # 代码质量检查
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Install dependencies
      run: |
        npm install
        cd frontend && npm install
        cd ../backend && mvn dependency:resolve
    
    - name: Run linting
      run: |
        npm run lint
        cd frontend && npm run lint
    
    - name: Run tests
      run: |
        npm run test:coverage
        cd frontend && npm run test:coverage
        cd ../backend && mvn test
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info,./frontend/coverage/lcov.info

  # 构建和部署
  build-and-deploy:
    needs: lint-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push images
      run: |
        docker build -t zerocarbon/frontend:latest ./frontend
        docker build -t zerocarbon/backend:latest ./backend
        docker build -t zerocarbon/nodejs-api:latest .
        
        docker push zerocarbon/frontend:latest
        docker push zerocarbon/backend:latest
        docker push zerocarbon/nodejs-api:latest
    
    - name: Deploy to staging
      run: |
        # 部署到测试环境的脚本
        echo "Deploying to staging environment"
```

#### 3.2 部署脚本

**部署脚本 scripts/deploy.sh**:
```bash
#!/bin/bash

set -e

# 配置变量
ENVIRONMENT=${1:-staging}
VERSION=${2:-latest}

echo "Deploying to $ENVIRONMENT environment with version $VERSION"

# 停止现有服务
docker-compose down

# 拉取最新镜像
docker-compose pull

# 备份数据库
echo "Creating database backup..."
docker exec mysql mysqldump -u root -p$MYSQL_ROOT_PASSWORD zero_carbon > backup_$(date +%Y%m%d_%H%M%S).sql

# 启动服务
docker-compose up -d

# 等待服务启动
echo "Waiting for services to start..."
sleep 30

# 健康检查
echo "Performing health checks..."
curl -f http://localhost:1125/health || exit 1
curl -f http://localhost:8080/actuator/health || exit 1
curl -f http://localhost:7240 || exit 1

echo "Deployment completed successfully!"
```

### 4. Kubernetes部署

#### 4.1 Kubernetes配置

```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: zero-carbon

---
# k8s/frontend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: zero-carbon
spec:
  replicas: 3
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: zerocarbon/frontend:latest
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"

---
# k8s/frontend-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: zero-carbon
spec:
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
```

#### 4.2 Helm Chart

```yaml
# helm/zero-carbon/Chart.yaml
apiVersion: v2
name: zero-carbon
description: Zero Carbon Digital Twin System
type: application
version: 2.0.0
appVersion: "2.0.0"

# helm/zero-carbon/values.yaml
replicaCount: 3

image:
  repository: zerocarbon
  pullPolicy: IfNotPresent
  tag: "latest"

service:
  type: ClusterIP
  port: 80

ingress:
  enabled: true
  className: "nginx"
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: zero-carbon.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: zero-carbon-tls
      hosts:
        - zero-carbon.example.com

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
```

## 外部依赖

### 1. 前端依赖分析

#### 1.1 核心框架依赖

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| react | 19.1.0 | 前端框架 | MIT |
| react-dom | 19.1.0 | DOM渲染 | MIT |
| typescript | 5.7.3 | 类型系统 | Apache-2.0 |
| @types/react | 19.0.2 | React类型定义 | MIT |

#### 1.2 UI组件库

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| @mui/material | 5.14.20 | Material-UI组件 | MIT |
| @mui/icons-material | 5.14.19 | Material图标 | MIT |
| antd | 5.26.3 | Ant Design组件 | MIT |
| @ant-design/icons | 5.5.2 | Ant Design图标 | MIT |

#### 1.3 3D渲染依赖

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| three | 0.168.0 | 3D图形库 | MIT |
| @react-three/fiber | 8.17.10 | React Three.js集成 | MIT |
| @react-three/drei | 9.117.3 | Three.js工具集 | MIT |
| @react-three/postprocessing | 2.16.4 | 后处理效果 | MIT |

#### 1.4 状态管理与路由

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| zustand | 5.0.6 | 状态管理 | MIT |
| react-router-dom | 6.28.1 | 路由管理 | MIT |
| react-query | 3.39.3 | 数据获取 | MIT |

#### 1.5 图表与可视化

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| recharts | 2.8.0 | React图表库 | MIT |
| chart.js | 4.5.0 | 图表库 | MIT |
| react-chartjs-2 | 5.2.0 | Chart.js React封装 | MIT |
| d3 | 7.8.5 | 数据可视化 | BSD-3-Clause |

### 2. 后端依赖分析

#### 2.1 Spring Boot核心

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| spring-boot-starter-web | 2.7.0 | Web框架 | Apache-2.0 |
| spring-boot-starter-data-jpa | 2.7.0 | JPA数据访问 | Apache-2.0 |
| spring-boot-starter-security | 2.7.0 | 安全框架 | Apache-2.0 |
| spring-boot-starter-validation | 2.7.0 | 数据验证 | Apache-2.0 |

#### 2.2 数据库驱动

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| mysql-connector-java | 8.0.33 | MySQL驱动 | GPL-2.0 |
| druid-spring-boot-starter | 1.2.16 | 数据库连接池 | Apache-2.0 |
| redisson-spring-boot-starter | 3.20.1 | Redis客户端 | Apache-2.0 |

#### 2.3 工具库

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| hutool-all | 5.8.18 | Java工具库 | Mulan PSL v2 |
| fastjson2 | 2.0.32 | JSON处理 | Apache-2.0 |
| jjwt | 0.11.5 | JWT处理 | Apache-2.0 |
| minio | 8.5.2 | 对象存储客户端 | Apache-2.0 |

### 3. Node.js依赖分析

#### 3.1 核心框架

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| express | 4.18.2 | Web框架 | MIT |
| mongoose | 8.9.3 | MongoDB ODM | MIT |
| mysql2 | 3.14.1 | MySQL客户端 | MIT |
| redis | 5.5.6 | Redis客户端 | MIT |

#### 3.2 区块链集成

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| ethers | 5.7.2 | 以太坊库 | MIT |
| web3 | 4.0.3 | Web3库 | LGPL-3.0 |
| hardhat | 2.17.0 | 开发框架 | MIT |
| @openzeppelin/contracts | 4.9.2 | 智能合约库 | MIT |

#### 3.3 AI/ML库

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| @tensorflow/tfjs | 4.22.0 | TensorFlow.js | Apache-2.0 |
| @tensorflow/tfjs-node | 4.22.0 | Node.js后端 | Apache-2.0 |
| ml-matrix | 6.10.4 | 矩阵运算 | MIT |

#### 3.4 通信与消息

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| mqtt | 5.13.1 | MQTT客户端 | MIT |
| ws | 8.18.0 | WebSocket | MIT |
| socket.io | 4.7.2 | 实时通信 | MIT |

#### 3.5 安全与工具

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| bcrypt | 5.1.1 | 密码加密 | MIT |
| helmet | 8.1.0 | 安全中间件 | MIT |
| joi | 17.13.3 | 数据验证 | BSD-3-Clause |
| winston | 3.17.0 | 日志记录 | MIT |

### 4. 开发工具依赖

#### 4.1 测试框架

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| jest | 29.7.0 | 测试框架 | MIT |
| @testing-library/react | 14.0.0 | React测试 | MIT |
| @testing-library/jest-dom | 6.1.4 | DOM测试 | MIT |
| supertest | 6.3.3 | API测试 | MIT |

#### 4.2 代码质量

| 依赖包 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| eslint | 8.57.0 | 代码检查 | MIT |
| prettier | 3.0.3 | 代码格式化 | MIT |
| husky | 8.0.3 | Git钩子 | MIT |
| lint-staged | 13.2.3 | 暂存区检查 | MIT |

### 5. 依赖管理策略

#### 5.1 版本锁定

```json
// package-lock.json 确保版本一致性
// 使用 npm ci 而不是 npm install 在生产环境

// 定期更新策略
{
  "scripts": {
    "deps:check": "npm outdated",
    "deps:update": "npm update",
    "deps:audit": "npm audit",
    "deps:fix": "npm audit fix"
  }
}
```

#### 5.2 安全扫描

```bash
# 定期安全扫描
npm audit
npm audit fix

# 使用Snyk进行深度安全扫描
npx snyk test
npx snyk monitor

# Maven安全扫描
mvn org.owasp:dependency-check-maven:check
```

#### 5.3 许可证合规

```bash
# 检查许可证兼容性
npx license-checker --summary
npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-3-Clause'

# 生成许可证报告
npx license-checker --csv > licenses.csv
```

## 开发最佳实践

### 1. 性能优化

#### 1.1 前端性能

```typescript
// 代码分割
const DeviceManagement = lazy(() => import('./components/DeviceManagement'));
const VPPDashboard = lazy(() => import('./components/VPPDashboard'));

// 组件优化
const DeviceCard = memo(({ device }: { device: Device }) => {
  return (
    <Card>
      <h3>{device.name}</h3>
      <p>{device.status}</p>
    </Card>
  );
});

// 状态优化
const useDeviceData = (deviceId: number) => {
  return useQuery(
    ['device', deviceId],
    () => fetchDevice(deviceId),
    {
      staleTime: 5 * 60 * 1000, // 5分钟
      cacheTime: 10 * 60 * 1000, // 10分钟
    }
  );
};
```

#### 1.2 后端性能

```java
// 数据库查询优化
@Query("SELECT d FROM Device d WHERE d.type = :type AND d.status = 'ACTIVE'")
List<Device> findActiveDevicesByType(@Param("type") String type);

// 缓存策略
@Cacheable(value = "devices", key = "#type")
public List<Device> getDevicesByType(String type) {
    return deviceRepository.findActiveDevicesByType(type);
}

// 异步处理
@Async
public CompletableFuture<Void> processDeviceData(DeviceData data) {
    // 异步处理设备数据
    return CompletableFuture.completedFuture(null);
}
```

### 2. 错误处理

```typescript
// 前端错误边界
class ErrorBoundary extends Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    console.error('Error caught by boundary:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback />;
    }
    return this.props.children;
  }
}
```

### 3. 监控与日志

```javascript
// 前端监控
const trackEvent = (eventName, properties) => {
  if (process.env.NODE_ENV === 'production') {
    analytics.track(eventName, properties);
  }
};

// 性能监控
const observer = new PerformanceObserver((list) => {
  for (const entry of list.getEntries()) {
    if (entry.entryType === 'navigation') {
      console.log('Page load time:', entry.loadEventEnd - entry.fetchStart);
    }
  }
});
observer.observe({ entryTypes: ['navigation'] });
```

## 故障排除

### 1. 常见问题

#### 1.1 环境问题

**Node.js版本不兼容**:
```bash
# 检查Node.js版本
node --version

# 使用nvm切换版本
nvm use 18

# 清除npm缓存
npm cache clean --force
```

**端口冲突**:
```bash
# 查看端口占用
lsof -i :1125
netstat -tulpn | grep :1125

# 杀死进程
kill -9 <PID>
```

#### 1.2 数据库问题

**连接失败**:
```bash
# 检查MySQL服务
sudo systemctl status mysql

# 重启MySQL
sudo systemctl restart mysql

# 检查连接
mysql -u root -p -h localhost
```

**权限问题**:
```sql
-- 检查用户权限
SHOW GRANTS FOR 'dev_user'@'localhost';

-- 重新授权
GRANT ALL PRIVILEGES ON zero_carbon_dev.* TO 'dev_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. 调试技巧

#### 2.1 前端调试

```typescript
// React DevTools
// 安装浏览器扩展：React Developer Tools

// 调试状态
const DeviceManagement = () => {
  const [devices, setDevices] = useState([]);
  
  // 开发环境调试
  useEffect(() => {
    if (process.env.NODE_ENV === 'development') {
      console.log('Devices updated:', devices);
    }
  }, [devices]);
};

// 网络请求调试
const api = axios.create({
  baseURL: process.env.REACT_APP_API_BASE_URL,
});

api.interceptors.request.use((config) => {
  console.log('Request:', config);
  return config;
});

api.interceptors.response.use(
  (response) => {
    console.log('Response:', response);
    return response;
  },
  (error) => {
    console.error('Request failed:', error);
    return Promise.reject(error);
  }
);
```

#### 2.2 后端调试

```java
// 日志配置
@Slf4j
@RestController
public class DeviceController {
    
    @GetMapping("/devices")
    public ResponseEntity<List<Device>> getDevices() {
        log.debug("Fetching all devices");
        
        try {
            List<Device> devices = deviceService.getAllDevices();
            log.info("Found {} devices", devices.size());
            return ResponseEntity.ok(devices);
        } catch (Exception e) {
            log.error("Error fetching devices", e);
            throw new ServiceException("Failed to fetch devices", e);
        }
    }
}

// 数据库查询调试
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

## 总结

本开发者指南提供了零碳园区数字孪生系统的完整开发环境搭建、代码规范、构建部署等详细信息。通过遵循这些规范和最佳实践，开发团队可以高效地进行协作开发，确保代码质量和系统稳定性。

建议开发者：
1. 严格按照环境要求搭建开发环境
2. 遵循代码规范和命名约定
3. 使用推荐的开发工具和插件
4. 定期更新依赖包并进行安全扫描
5. 重视测试覆盖率和代码质量
6. 关注性能优化和监控

如有问题，请参考故障排除章节或联系技术团队。