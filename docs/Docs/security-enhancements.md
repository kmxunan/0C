# 安全增强指南

## 1. 安全架构设计

### 1.1 安全分层
```
+-----------------------------+
|        应用层安全           |
|  - 前端安全验证             |
|  - 用户权限控制             |
+-----------------------------+
|        服务层安全           |
|  - API认证与授权            |
|  - 请求速率限制             |
|  - 输入验证                 |
+-----------------------------+
|        数据层安全           |
|  - 数据加密存储             |
|  - 访问控制                 |
+-----------------------------+
|        网络层安全           |
|  - HTTPS加密传输            |
|  - 防火墙配置               |
+-----------------------------+
```

## 2. 身份认证

### 2.1 JWT认证流程
```
+--------+     +------------------+     +-------------------+
| 用户   |---->|  登录认证服务    |---->|  生成JWT令牌      |
+--------+     +------------------+     +-------------------+
                                         |
                    +---------------------v---------------------+
                    |         存储令牌到浏览器Cookie          |
                    +----------------------+------------------+
                                           |
                    +----------------------v-----------------------+
                    |       后续请求携带令牌进行API认证        |
                    +-----------------------------------------------+
```

## 3. 权限管理

### 3.1 RBAC权限模型
- 角色定义：
  - 管理员：拥有全部权限
  - 能源管理员：可管理能源数据和设备
  - 查看者：仅可查看数据

### 3.2 权限验证流程
```
+---------------------+     +------------------+     +-------------------+
|   接收到API请求     |---->|  解析JWT令牌     |---->| 获取用户角色信息   |
+---------------------+     +------------------+     +-------------------+
                                                       |
                    +----------------------------------v--------------------------+
                    |         根据角色和权限规则验证访问权限                |
                    +----------------------+-------------------------------+
                                           |
                    +----------------------v-----------------------+
                    |              返回响应或拒绝访问                     |
                    +-----------------------------------------------+
```

## 4. API安全

### 4.1 安全中间件
- CORS策略：`origin: process.env.FRONTEND_URL || 'https://zerocarbonpark.com'`
- 请求速率限制：默认15分钟100次请求
- 输入验证：使用express-validator进行参数校验
- 错误处理：统一的错误响应格式，避免暴露敏感信息

## 5. 数据安全

### 5.1 数据加密
- 传输加密：强制HTTPS协议
- 存储加密：敏感字段使用AES-256加密

### 5.2 日志安全
- 敏感信息脱敏处理
- 日志文件权限控制
- 定期日志轮转

## 6. 安全加固措施

### 6.1 安全头部设置
```http
Content-Security-Policy: default-src 'self'
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=63072000
```

### 6.2 漏洞修复
- 使用`npm audit fix --force`命令强制修复高危漏洞
- 定期更新依赖库版本
- 关注安全公告，及时应用补丁