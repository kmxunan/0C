name: ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œè´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'

jobs:
  code-quality:
    name: ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äº SonarCloud åˆ†æ

      - name: è®¾ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm install -g typescript

      - name: ç¼“å­˜è´¨é‡æ£€æŸ¥ç»“æœ
        uses: actions/cache@v3
        with:
          path: |
            reports
            coverage
            .eslintcache
          key: quality-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            quality-${{ runner.os }}-${{ matrix.node-version }}-
            quality-${{ runner.os }}-

      - name: ESLint æ£€æŸ¥
        run: |
          npm run lint:enhanced
          npm run lint:enhanced -- --format json --output-file reports/eslint-report.json || true
        continue-on-error: true

      - name: Prettier æ ¼å¼æ£€æŸ¥
        run: npm run format:check
        continue-on-error: true

      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: npm run type:check
        continue-on-error: true

      - name: è¿è¡Œæµ‹è¯•å’Œè¦†ç›–ç‡
        run: |
          npm run test:ci
          npm run test:coverage
        env:
          NODE_ENV: test
          CI: true

      - name: å®‰å…¨æ¼æ´æ£€æŸ¥
        run: |
          npm audit --audit-level=moderate --json > reports/security-audit.json || true
          npm run security:audit
        continue-on-error: true

      - name: ä¾èµ–é¡¹æ£€æŸ¥
        run: |
          npm outdated --json > reports/outdated-dependencies.json || true
        continue-on-error: true

      - name: è¿è¡Œå¢å¼ºè´¨é‡æ£€æŸ¥
        run: |
          mkdir -p reports
          npm run quality:monitor
        continue-on-error: true

      - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡åˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: SonarCloud æ‰«æ
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=zero-carbon-park
            -Dsonar.organization=your-org
            -Dsonar.sources=src
            -Dsonar.tests=tests
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.eslint.reportPaths=reports/eslint-report.json
            -Dsonar.coverage.exclusions=**/*.test.js,**/*.spec.js,**/node_modules/**
        continue-on-error: true

      - name: è´¨é‡é—¨æ£€æŸ¥
        run: |
          node -e "
            const fs = require('fs');
            const reportPath = 'reports/quality-report.json';
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              console.log('è´¨é‡åˆ†æ•°:', report.overall.score);
              console.log('è´¨é‡ç­‰çº§:', report.overall.grade);
              console.log('çŠ¶æ€:', report.overall.status);
              
              if (report.overall.score < 80) {
                console.error('âŒ è´¨é‡é—¨æ£€æŸ¥å¤±è´¥: åˆ†æ•°ä½äº 80');
                process.exit(1);
              }
              
              // æ£€æŸ¥å…³é”®æŒ‡æ ‡
              const criticalIssues = [];
              if (report.checks.eslint.errors > 0) {
                criticalIssues.push('ESLint é”™è¯¯');
              }
              if (report.checks.typescript.status === 'FAIL') {
                criticalIssues.push('TypeScript ç±»å‹é”™è¯¯');
              }
              if (report.checks.security.vulnerabilities?.high > 0) {
                criticalIssues.push('é«˜å±å®‰å…¨æ¼æ´');
              }
              if (report.metrics.testCoverage < 70) {
                criticalIssues.push('æµ‹è¯•è¦†ç›–ç‡è¿‡ä½');
              }
              
              if (criticalIssues.length > 0) {
                console.error('âŒ å‘ç°å…³é”®é—®é¢˜:', criticalIssues.join(', '));
                process.exit(1);
              }
              
              console.log('âœ… è´¨é‡é—¨æ£€æŸ¥é€šè¿‡');
            } else {
              console.warn('âš ï¸  è´¨é‡æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨');
            }
          "

      - name: ç”Ÿæˆè´¨é‡å¾½ç« 
        run: |
          node -e "
            const fs = require('fs');
            const reportPath = 'reports/quality-report.json';
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const score = report.overall.score;
              const grade = report.overall.grade;
              const color = score >= 90 ? 'brightgreen' : score >= 80 ? 'green' : score >= 70 ? 'yellow' : score >= 60 ? 'orange' : 'red';
              
              const badge = {
                schemaVersion: 1,
                label: 'code quality',
                message: \`\${score}/100 (\${grade})\`,
                color: color
              };
              
              fs.writeFileSync('reports/quality-badge.json', JSON.stringify(badge, null, 2));
              console.log('è´¨é‡å¾½ç« å·²ç”Ÿæˆ');
            }
          "

      - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-reports-${{ matrix.node-version }}
          path: |
            reports/
            coverage/
          retention-days: 30

      - name: è¯„è®º PRï¼ˆå¦‚æœæ˜¯ PRï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/quality-report.json';

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const comment = `
            ## ğŸ” ä»£ç è´¨é‡æŠ¥å‘Š

            **æ€»ä½“è¯„åˆ†**: ${report.overall.score}/100 (${report.overall.grade})
            **çŠ¶æ€**: ${report.overall.status === 'PASS' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}

            ### è¯¦ç»†æ£€æŸ¥ç»“æœ

            | æ£€æŸ¥é¡¹ | çŠ¶æ€ | åˆ†æ•° | è¯¦æƒ… |
            |--------|------|------|------|
            | ESLint | ${report.checks.eslint.status === 'PASS' ? 'âœ…' : 'âŒ'} | ${report.checks.eslint.score}/100 | ${report.checks.eslint.errors || 0} é”™è¯¯, ${report.checks.eslint.warnings || 0} è­¦å‘Š |
            | Prettier | ${report.checks.prettier.status === 'PASS' ? 'âœ…' : 'âŒ'} | ${report.checks.prettier.score}/100 | æ ¼å¼æ£€æŸ¥ |
            | TypeScript | ${report.checks.typescript.status === 'PASS' ? 'âœ…' : 'âŒ'} | ${report.checks.typescript.score}/100 | ç±»å‹æ£€æŸ¥ |
            | æµ‹è¯•è¦†ç›–ç‡ | ${report.checks.tests.status === 'PASS' ? 'âœ…' : 'âŒ'} | ${report.checks.tests.score}/100 | ${report.metrics.testCoverage.toFixed(1)}% |
            | å®‰å…¨æ£€æŸ¥ | ${report.checks.security.status === 'PASS' ? 'âœ…' : 'âŒ'} | ${report.checks.security.score}/100 | ${report.checks.security.vulnerabilities?.total || 0} ä¸ªæ¼æ´ |

            ### å…³é”®æŒ‡æ ‡

            - ğŸ“Š **æµ‹è¯•è¦†ç›–ç‡**: ${report.metrics.testCoverage.toFixed(1)}%
            - ğŸ“ **ä»£ç è¡Œæ•°**: ${report.metrics.linesOfCode.toLocaleString()}
            - ğŸ”’ **å®‰å…¨æ¼æ´**: ${report.checks.security.vulnerabilities?.total || 0}
            - âš ï¸ **ESLint é—®é¢˜**: ${(report.checks.eslint.errors || 0) + (report.checks.eslint.warnings || 0)}

            ${report.recommendations.length > 0 ? `
            ### ğŸ”§ æ”¹è¿›å»ºè®®

            ${report.recommendations.slice(0, 5).map((rec, i) => 
              `${i + 1}. **[${rec.priority}]** ${rec.message}\n   \`${rec.action}\``
            ).join('\n\n')}
            ` : ''}

            ---
            *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date(report.timestamp).toLocaleString('zh-CN')}*
            `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          npm run test:load
          npm run test:system
        continue-on-error: true

      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-reports
          path: |
            reports/performance/
            logs/
          retention-days: 7

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ä¸Šä¼  Trivy æ‰«æç»“æœåˆ° GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: è¿è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript
          queries: security-and-quality

  dependency-review:
    name: ä¾èµ–é¡¹å®¡æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¾èµ–é¡¹å®¡æŸ¥
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  quality-gate:
    name: è´¨é‡é—¨
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    if: always()

    steps:
      - name: æ£€æŸ¥è´¨é‡é—¨çŠ¶æ€
        run: |
          echo "ä»£ç è´¨é‡æ£€æŸ¥çŠ¶æ€: ${{ needs.code-quality.result }}"
          echo "å®‰å…¨æ‰«æçŠ¶æ€: ${{ needs.security-scan.result }}"

          if [[ "${{ needs.code-quality.result }}" != "success" ]]; then
            echo "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "âŒ å®‰å…¨æ‰«æå¤±è´¥"
            exit 1
          fi

          echo "âœ… æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡"

      - name: æ›´æ–°çŠ¶æ€æ£€æŸ¥
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const status = '${{ needs.code-quality.result }}' === 'success' && '${{ needs.security-scan.result }}' === 'success' ? 'success' : 'failure';
            const description = status === 'success' ? 'æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡' : 'è´¨é‡æ£€æŸ¥å¤±è´¥';

            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'quality-gate'
            });
