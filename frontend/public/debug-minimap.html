<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小地图功能调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }
        .error-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }
        .warning-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ff9800;
        }
        .btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn-warning {
            background: #ff9800;
        }
        .btn-warning:hover {
            background: #e68900;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn-danger:hover {
            background: #da190b;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }
        .checklist li:before {
            content: "✓";
            color: #4caf50;
            font-weight: bold;
            margin-right: 10px;
        }
        .checklist li.error:before {
            content: "✗";
            color: #f44336;
        }
        .checklist li.warning:before {
            content: "⚠";
            color: #ff9800;
        }
        #webgl-info {
            font-family: monospace;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗺️ 小地图功能调试页面</h1>
        
        <div class="status-card">
            <h2>功能检查清单</h2>
            <ul class="checklist" id="checklist">
                <li id="check-webgl">WebGL 支持检查</li>
                <li id="check-frontend">前端服务器运行状态</li>
                <li id="check-components">组件加载状态</li>
                <li id="check-minimap">小地图显示状态</li>
                <li id="check-viewport">视角管理器状态</li>
            </ul>
        </div>

        <div class="warning-card">
            <h2>⚠️ 已知问题</h2>
            <p><strong>WebGL 上下文丢失错误:</strong></p>
            <ul>
                <li>THREE.WebGLRenderer: Context Lost</li>
                <li>GL_INVALID_OPERATION 错误</li>
            </ul>
            <p><strong>可能的解决方案:</strong></p>
            <ul>
                <li>刷新页面重新初始化 WebGL 上下文</li>
                <li>使用 2D 小地图作为备用方案</li>
                <li>检查浏览器的硬件加速设置</li>
                <li>更新显卡驱动程序</li>
            </ul>
        </div>

        <div class="status-card">
            <h2>🚀 快速操作</h2>
            <a href="http://localhost:7240" class="btn" target="_blank">打开数字孪生页面</a>
            <button class="btn btn-warning" onclick="clearCache()">清除缓存</button>
            <button class="btn" onclick="checkWebGL()">检查 WebGL 支持</button>
            <button class="btn btn-danger" onclick="location.reload()">刷新页面</button>
        </div>

        <div class="status-card">
            <h2>🔍 WebGL 状态检查</h2>
            <div id="webgl-info">正在检查 WebGL 状态...</div>
        </div>

        <div class="status-card">
            <h2>📋 使用说明</h2>
            <ol>
                <li><strong>小地图切换:</strong> 点击地图图标按钮切换小地图显示/隐藏</li>
                <li><strong>2D/3D 切换:</strong> 双击地图图标按钮强制切换到 2D 小地图</li>
                <li><strong>视角管理:</strong> 点击视角图标按钮打开视角管理器</li>
                <li><strong>调试信息:</strong> 在数字孪生页面左上角查看实时状态信息</li>
                <li><strong>WebGL 错误:</strong> 如果遇到 WebGL 错误，系统会自动切换到 2D 小地图</li>
            </ol>
        </div>
    </div>

    <script>
        function checkWebGL() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            const info = document.getElementById('webgl-info');
            
            if (gl) {
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                const vendor = gl.getParameter(gl.VENDOR);
                const renderer = gl.getParameter(gl.RENDERER);
                const version = gl.getParameter(gl.VERSION);
                const shadingLanguageVersion = gl.getParameter(gl.SHADING_LANGUAGE_VERSION);
                
                let result = `WebGL 支持: ✅ 是\n`;
                result += `供应商: ${vendor}\n`;
                result += `渲染器: ${renderer}\n`;
                result += `版本: ${version}\n`;
                result += `着色器语言版本: ${shadingLanguageVersion}\n`;
                
                if (debugInfo) {
                    const unmaskedVendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                    const unmaskedRenderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                    result += `真实供应商: ${unmaskedVendor}\n`;
                    result += `真实渲染器: ${unmaskedRenderer}\n`;
                }
                
                // 检查扩展
                const extensions = gl.getSupportedExtensions();
                result += `\n支持的扩展 (${extensions.length}个):\n`;
                extensions.slice(0, 10).forEach(ext => {
                    result += `- ${ext}\n`;
                });
                if (extensions.length > 10) {
                    result += `... 还有 ${extensions.length - 10} 个扩展\n`;
                }
                
                info.textContent = result;
                document.getElementById('check-webgl').className = '';
            } else {
                info.textContent = 'WebGL 支持: ❌ 否\n\n您的浏览器不支持 WebGL，这可能是小地图无法显示的原因。';
                document.getElementById('check-webgl').className = 'error';
            }
        }
        
        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            localStorage.clear();
            sessionStorage.clear();
            alert('缓存已清除，建议刷新页面。');
        }
        
        function checkFrontendStatus() {
            fetch('http://localhost:7240')
                .then(response => {
                    if (response.ok) {
                        document.getElementById('check-frontend').className = '';
                    } else {
                        document.getElementById('check-frontend').className = 'error';
                    }
                })
                .catch(() => {
                    document.getElementById('check-frontend').className = 'error';
                });
        }
        
        // 页面加载时自动检查
        window.onload = function() {
            checkWebGL();
            checkFrontendStatus();
        };
    </script>
</body>
</html>