{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "零碳园区数字孪生系统代码质量配置",
  "description": "定义代码质量标准、阈值和规则",
  "version": "1.0.0",
  "lastUpdated": "2024-01-20",

  "quality": {
    "thresholds": {
      "overall": {
        "minimum": 80,
        "target": 90,
        "excellent": 95
      },
      "eslint": {
        "maxErrors": 0,
        "maxWarnings": 10,
        "maxWarningsPerFile": 3,
        "allowedRules": {
          "console.log": "warn",
          "debugger": "error",
          "no-unused-vars": "error",
          "no-undef": "error"
        }
      },
      "prettier": {
        "enforceFormatting": true,
        "maxUnformattedFiles": 0
      },
      "typescript": {
        "maxTypeErrors": 0,
        "strictMode": true,
        "noImplicitAny": true,
        "strictNullChecks": true
      },
      "testing": {
        "coverage": {
          "statements": 80,
          "branches": 75,
          "functions": 80,
          "lines": 80,
          "minimum": 70,
          "target": 85,
          "excellent": 95
        },
        "testFiles": {
          "minTestsPerModule": 1,
          "testNamingPattern": "*.test.js|*.spec.js",
          "requiredTestTypes": ["unit", "integration"]
        }
      },
      "security": {
        "vulnerabilities": {
          "critical": 0,
          "high": 0,
          "medium": 2,
          "low": 10
        },
        "auditLevel": "moderate",
        "allowedLicenses": [
          "MIT",
          "Apache-2.0",
          "BSD-2-Clause",
          "BSD-3-Clause",
          "ISC",
          "CC0-1.0",
          "Unlicense"
        ]
      },
      "dependencies": {
        "maxOutdated": 5,
        "maxMajorVersionsBehind": 2,
        "allowedDevDependencies": true,
        "bannedPackages": [],
        "preferredAlternatives": {
          "lodash": "ramda",
          "moment": "dayjs"
        }
      },
      "complexity": {
        "cyclomaticComplexity": {
          "max": 10,
          "warn": 7
        },
        "cognitiveComplexity": {
          "max": 15,
          "warn": 10
        },
        "maxLinesPerFunction": 50,
        "maxLinesPerFile": 500,
        "maxParametersPerFunction": 5,
        "maxNestedCallbacks": 3
      },
      "duplication": {
        "maxDuplicationPercentage": 5,
        "minTokens": 50,
        "maxDuplicateBlocks": 3,
        "ignoredPatterns": ["test/**", "*.config.js", "migrations/**"]
      },
      "performance": {
        "bundleSize": {
          "maxSizeKB": 500,
          "warnSizeKB": 300
        },
        "buildTime": {
          "maxSeconds": 120,
          "warnSeconds": 60
        }
      }
    },

    "weights": {
      "eslint": 0.2,
      "prettier": 0.05,
      "typescript": 0.15,
      "testing": 0.3,
      "security": 0.15,
      "dependencies": 0.05,
      "complexity": 0.05,
      "duplication": 0.05
    },

    "scoring": {
      "grades": {
        "A+": { "min": 95, "color": "#28a745" },
        "A": { "min": 90, "color": "#28a745" },
        "B+": { "min": 85, "color": "#6f42c1" },
        "B": { "min": 80, "color": "#007bff" },
        "C+": { "min": 75, "color": "#fd7e14" },
        "C": { "min": 70, "color": "#ffc107" },
        "D": { "min": 60, "color": "#dc3545" },
        "F": { "min": 0, "color": "#6c757d" }
      },
      "penalties": {
        "eslintError": 10,
        "eslintWarning": 2,
        "typeError": 5,
        "securityVulnHigh": 30,
        "securityVulnMedium": 10,
        "securityVulnLow": 2,
        "unformattedFile": 5,
        "outdatedDependency": 1,
        "complexFunction": 3,
        "duplicateCode": 5
      }
    }
  },

  "rules": {
    "filePatterns": {
      "source": ["src/**/*.js", "src/**/*.jsx", "src/**/*.ts", "src/**/*.tsx"],
      "tests": ["tests/**/*.js", "tests/**/*.test.js", "tests/**/*.spec.js", "__tests__/**/*.js"],
      "config": ["*.config.js", ".*rc.js", "webpack.*.js", "rollup.*.js"],
      "documentation": ["*.md", "docs/**/*.md", "README*"]
    },

    "exclusions": {
      "directories": [
        "node_modules",
        ".git",
        "dist",
        "build",
        "coverage",
        "reports",
        "logs",
        "tmp",
        ".cache"
      ],
      "files": ["*.min.js", "*.bundle.js", "package-lock.json", "yarn.lock"],
      "patterns": ["**/*.generated.*", "**/*.auto.*", "**/vendor/**", "**/third-party/**"]
    },

    "requirements": {
      "mandatoryFiles": [
        "package.json",
        "README.md",
        ".gitignore",
        ".eslintrc.js",
        ".prettierrc.js",
        "jest.config.js"
      ],
      "recommendedFiles": [
        "tsconfig.json",
        ".editorconfig",
        "CHANGELOG.md",
        "LICENSE",
        ".nvmrc",
        "docker-compose.yml"
      ],
      "codeStructure": {
        "maxDirectoryDepth": 6,
        "requiredDirectories": ["src", "tests"],
        "recommendedDirectories": ["docs", "scripts", "config"]
      }
    }
  },

  "reporting": {
    "formats": ["json", "html", "console"],
    "outputDirectory": "reports",
    "includeDetails": true,
    "includeRecommendations": true,
    "includeMetrics": true,
    "includeTrends": true,
    "retention": {
      "keepReports": 30,
      "archiveAfterDays": 90
    }
  },

  "automation": {
    "preCommitHooks": {
      "enabled": true,
      "checks": ["lint", "format", "type-check", "test-changed"]
    },
    "cicd": {
      "failOnQualityGate": true,
      "minimumScore": 80,
      "requiredChecks": ["eslint", "typescript", "security", "tests"]
    },
    "notifications": {
      "enabled": false,
      "channels": ["slack", "email"],
      "triggers": ["quality-degradation", "security-vulnerability", "build-failure"]
    }
  },

  "metrics": {
    "tracking": {
      "codeQualityTrend": true,
      "testCoverageTrend": true,
      "securityTrend": true,
      "performanceTrend": true,
      "technicalDebtTrend": true
    },
    "kpis": {
      "defectDensity": {
        "target": "< 0.1 defects per KLOC",
        "measurement": "defects / (lines of code / 1000)"
      },
      "codeChurn": {
        "target": "< 20% per sprint",
        "measurement": "changed lines / total lines"
      },
      "testAutomation": {
        "target": "> 90%",
        "measurement": "automated tests / total tests"
      },
      "buildSuccess": {
        "target": "> 95%",
        "measurement": "successful builds / total builds"
      }
    }
  },

  "tools": {
    "eslint": {
      "version": "^8.0.0",
      "config": ".eslintrc.enhanced.cjs",
      "plugins": ["@typescript-eslint", "security", "import", "promise", "node"]
    },
    "prettier": {
      "version": "^3.0.0",
      "config": ".prettierrc.js"
    },
    "typescript": {
      "version": "^5.0.0",
      "config": "tsconfig.json",
      "strict": true
    },
    "jest": {
      "version": "^29.0.0",
      "config": "jest.enhanced.config.js",
      "coverage": true
    },
    "husky": {
      "version": "^8.0.0",
      "hooks": {
        "pre-commit": "npm run precommit",
        "pre-push": "npm run test:ci"
      }
    }
  },

  "environments": {
    "development": {
      "strictMode": false,
      "allowConsoleLog": true,
      "skipSlowTests": true
    },
    "staging": {
      "strictMode": true,
      "allowConsoleLog": false,
      "skipSlowTests": false
    },
    "production": {
      "strictMode": true,
      "allowConsoleLog": false,
      "skipSlowTests": false,
      "requireSecurityScan": true
    }
  },

  "customRules": {
    "businessLogic": {
      "energyDataValidation": {
        "description": "能耗数据必须包含必要字段",
        "pattern": "src/services/energy/**/*.js",
        "rules": [
          "必须验证 power, energy, voltage, current 字段",
          "必须检查数据范围的合理性",
          "必须记录数据来源和时间戳"
        ]
      },
      "carbonEmissionCalculation": {
        "description": "碳排放计算必须遵循标准",
        "pattern": "src/services/carbon/**/*.js",
        "rules": [
          "必须使用标准排放因子",
          "必须记录计算方法和参数",
          "必须提供计算结果的不确定性评估"
        ]
      },
      "alertProcessing": {
        "description": "告警处理必须及时和准确",
        "pattern": "src/services/alert/**/*.js",
        "rules": ["必须在 5 秒内处理告警", "必须记录告警处理历史", "必须支持告警升级机制"]
      }
    },
    "security": {
      "dataProtection": {
        "description": "数据保护和隐私规则",
        "rules": [
          "禁止在日志中记录敏感信息",
          "必须对用户密码进行哈希处理",
          "必须验证所有用户输入",
          "必须使用 HTTPS 传输敏感数据"
        ]
      },
      "accessControl": {
        "description": "访问控制规则",
        "rules": ["必须验证用户权限", "必须记录访问日志", "必须实现会话超时", "必须支持多因素认证"]
      }
    },
    "performance": {
      "databaseQueries": {
        "description": "数据库查询性能规则",
        "rules": [
          "避免 N+1 查询问题",
          "必须使用索引优化查询",
          "必须限制查询结果数量",
          "必须监控慢查询"
        ]
      },
      "apiResponse": {
        "description": "API 响应性能规则",
        "rules": [
          "API 响应时间必须 < 2 秒",
          "必须实现响应缓存",
          "必须支持分页查询",
          "必须压缩响应数据"
        ]
      }
    }
  }
}
