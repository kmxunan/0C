[{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/architecture/ApiGateway.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/architecture/ServiceRegistry.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/controllers/EnergyCarbonIntegrationController.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/data/DataPlatform.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/entities/Device.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/entities/DeviceHistory.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/entities/DeviceType.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/entities/NotificationPreferences.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/entities/recommendation.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/entities/storageDevice.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/AlertManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/CarbonAccountingEngine.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/CarbonManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/CarbonMonitor.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/CarbonMonitorConstants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/DataAssetManagementCenter.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/DataCollector.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/DataGovernanceService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/DataLineageService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/DataManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/DeclarationSupportSystem.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/EnergyAnalytics.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/EnergyFlowVisualization.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/EnergyManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/EnergyOptimizationScheduler.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/GreenElectricityTracing.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/MaintenanceManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/NationalIndicatorDashboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/NationalIndicatorEngine.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/NotificationService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/RealTimeDataQualityService.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.5.","line":103,"column":63,"nodeType":"Literal","messageId":"noMagic","endLine":103,"endColumn":66},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":131,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":131,"endColumn":64},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":131,"column":120,"nodeType":"Literal","messageId":"noMagic","endLine":131,"endColumn":123},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300000.","line":181,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":181,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.95.","line":288,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":288,"endColumn":20},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":299,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":299,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":299,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":299,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":299,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":299,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":299,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":299,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.9.","line":337,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1216,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":1216,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1216,"column":130,"nodeType":"Literal","messageId":"noMagic","endLine":1216,"endColumn":133},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1284,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":1284,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":1302,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":1302,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1328,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":1328,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1383,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":1383,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1438,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":1438,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1494,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":1494,"endColumn":70},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1553,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":1553,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":1699,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":1699,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":1715,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":1715,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: -1000.","line":1716,"column":51,"nodeType":"UnaryExpression","messageId":"noMagic","endLine":1716,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60000.","line":1729,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":1729,"endColumn":66},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 120000.","line":1736,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":1736,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300000.","line":1783,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":1783,"endColumn":63}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":25,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * å®æ—¶æ•°æ®è´¨é‡ç›‘æ§ä¸é¢„è­¦æœåŠ¡\n * å®ç°æ•°æ®è´¨é‡çš„å®æ—¶ç›‘æ§ã€å¼‚å¸¸æ£€æµ‹ã€è‡ªåŠ¨é¢„è­¦å’Œè´¨é‡è¯„åˆ†\n * ä¸ºé›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿç³»ç»Ÿæä¾›å…¨é¢çš„æ•°æ®è´¨é‡ä¿éšœ\n */\n\nimport { EventEmitter } from 'events';\nimport logger from '../../shared/utils/logger.js';\nimport { MATH_CONSTANTS } from '../../shared/constants/MathConstants.js';\n\nclass RealTimeDataQualityService extends EventEmitter {\n    constructor() {\n        super();\n        \n        // æ•°æ®è´¨é‡è§„åˆ™\n        this.qualityRules = new Map();\n        \n        // ç›‘æ§ä»»åŠ¡\n        this.monitoringTasks = new Map();\n        \n        // è´¨é‡æŒ‡æ ‡\n        this.qualityMetrics = new Map();\n        \n        // å¼‚å¸¸æ£€æµ‹å™¨\n        this.anomalyDetectors = new Map();\n        \n        // é¢„è­¦é…ç½®\n        this.alertConfigs = new Map();\n        \n        // è´¨é‡æŠ¥å‘Š\n        this.qualityReports = new Map();\n        \n        // å®æ—¶è´¨é‡çŠ¶æ€\n        this.realTimeStatus = new Map();\n        \n        // è´¨é‡è¶‹åŠ¿æ•°æ®\n        this.qualityTrends = new Map();\n        \n        // ä¿®å¤å»ºè®®\n        this.repairSuggestions = new Map();\n        \n        this.startTime = Date.now();\n        this.init();\n    }\n    \n    /**\n     * åˆå§‹åŒ–æ•°æ®è´¨é‡ç›‘æ§æœåŠ¡\n     */\n    async init() {\n        try {\n            logger.info('ğŸ“Š å®æ—¶æ•°æ®è´¨é‡ç›‘æ§æœåŠ¡å¯åŠ¨ä¸­...');\n            \n            // åˆå§‹åŒ–è´¨é‡è§„åˆ™\n            await this.initializeQualityRules();\n            \n            // åˆå§‹åŒ–å¼‚å¸¸æ£€æµ‹å™¨\n            await this.initializeAnomalyDetectors();\n            \n            // åˆå§‹åŒ–é¢„è­¦é…ç½®\n            await this.initializeAlertConfigs();\n            \n            // å¯åŠ¨å®æ—¶ç›‘æ§\n            await this.startRealTimeMonitoring();\n            \n            // åˆå§‹åŒ–è´¨é‡æŒ‡æ ‡\n            await this.initializeQualityMetrics();\n            \n            logger.info('âœ… å®æ—¶æ•°æ®è´¨é‡ç›‘æ§æœåŠ¡å¯åŠ¨å®Œæˆ');\n            this.emit('quality:ready');\n        } catch (error) {\n            return false;\n        }\n    }\n    \n    async getDetectionData(_detector) {\n        // æ¨¡æ‹Ÿè·å–å¼‚å¸¸æ£€æµ‹æ•°æ®\n        const baseData = await this.getTestData('ems_energy_data');\n        return baseData.map(record => ({\n            ...record,\n            timestamp: record.measurement_time,\n            value: record.consumption_amount\n        }));\n    }\n    \n    detectZScoreAnomalies(data, parameters) {\n        const anomalies = [];\n        if (data.length < parameters.min_samples) {return anomalies;}\n        \n        const values = data.map(d => d.value || 0);\n        const mean = values.reduce((a, b) => a + b, 0) / values.length;\n        const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;\n        const stdDev = Math.sqrt(variance);\n        \n        data.forEach((record, index) => {\n            const zScore = Math.abs((record.value - mean) / stdDev);\n            if (zScore > parameters.threshold) {\n                anomalies.push({\n                    type: 'statistical_outlier',\n                    record_id: record.meter_id || index,\n                    value: record.value,\n                    z_score: zScore,\n                    threshold: parameters.threshold,\n                    severity: zScore > parameters.threshold * 1.5 ? 'high' : 'medium',\n                    description: `ç»Ÿè®¡å¼‚å¸¸å€¼æ£€æµ‹: Z-Score ${zScore.toFixed(2)} è¶…è¿‡é˜ˆå€¼ ${parameters.threshold}`\n                });\n            }\n        });\n        \n        return anomalies;\n    }\n    \n    detectTrendAnomalies(data, parameters) {\n        const anomalies = [];\n        if (data.length < parameters.window_size) {return anomalies;}\n        \n        for (let i = parameters.window_size; i < data.length; i++) {\n            const window = data.slice(i - parameters.window_size, i);\n            const windowMean = window.reduce((sum, d) => sum + d.value, 0) / window.length;\n            const currentValue = data[i].value;\n            \n            const deviation = Math.abs(currentValue - windowMean) / windowMean;\n            if (deviation > parameters.deviation_threshold) {\n                anomalies.push({\n                    type: 'trend_anomaly',\n                    record_id: data[i].meter_id || i,\n                    value: currentValue,\n                    expected_value: windowMean,\n                    deviation,\n                    threshold: parameters.deviation_threshold,\n                    severity: deviation > parameters.deviation_threshold * 2 ? 'high' : 'medium',\n                    description: `è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹: åå·® ${(deviation * 100).toFixed(2)}% è¶…è¿‡é˜ˆå€¼ ${(parameters.deviation_threshold * 100).toFixed(2)}%`\n                });\n            }\n        }\n        \n        return anomalies;\n    }\n    \n    detectPatternAnomalies(data, _parameters) {\n        const anomalies = [];\n        // ç®€åŒ–çš„æ¨¡å¼å¼‚å¸¸æ£€æµ‹\n        const values = data.map(d => d.value || 0);\n        const mean = values.reduce((a, b) => a + b, 0) / values.length;\n        const threshold = mean * 2; // ç®€åŒ–é˜ˆå€¼\n        \n        data.forEach((record, index) => {\n            if (record.value > threshold) {\n                anomalies.push({\n                    type: 'pattern_anomaly',\n                    record_id: record.meter_id || index,\n                    value: record.value,\n                    threshold,\n                    severity: 'medium',\n                    description: `æ¨¡å¼å¼‚å¸¸æ£€æµ‹: å€¼ ${record.value} è¶…è¿‡æ¨¡å¼é˜ˆå€¼ ${threshold.toFixed(2)}`\n                });\n            }\n        });\n        \n        return anomalies;\n    }\n    \n    detectRuleViolations(data, _parameters) {\n        const anomalies = [];\n        \n        data.forEach((record, index) => {\n            // æ£€æŸ¥ä¸šåŠ¡è§„åˆ™è¿å\n            if (record.value <= 0) {\n                anomalies.push({\n                    type: 'rule_violation',\n                    record_id: record.meter_id || index,\n                    value: record.value,\n                    rule: 'value_must_be_positive',\n                    severity: 'high',\n                    description: `ä¸šåŠ¡è§„åˆ™è¿å: å€¼å¿…é¡»å¤§äº0ï¼Œå½“å‰å€¼ä¸º ${record.value}`\n                });\n            }\n            \n            // æ£€æŸ¥æ—¶é—´è§„åˆ™\n            const recordTime = new Date(record.timestamp).getTime();\n            const currentTime = Date.now();\n            if (recordTime > currentTime + 300000) { // 5åˆ†é’Ÿæœªæ¥æ—¶é—´å®¹é”™\n                anomalies.push({\n                    type: 'rule_violation',\n                    record_id: record.meter_id || index,\n                    timestamp: record.timestamp,\n                    rule: 'timestamp_cannot_be_future',\n                    severity: 'medium',\n                    description: `ä¸šåŠ¡è§„åˆ™è¿å: æ—¶é—´æˆ³ä¸èƒ½æ˜¯æœªæ¥æ—¶é—´`\n                });\n            }\n        });\n        \n        return anomalies;\n    }\n    \n    async evaluateAlertConditions(alertConfig) {\n        const conditions = alertConfig.trigger_conditions;\n        \n        // æ£€æŸ¥è´¨é‡åˆ†æ•°æ¡ä»¶\n        if (conditions.quality_score) {\n            const latestCheck = this.realTimeStatus.get('latest_check');\n            if (latestCheck && latestCheck.quality_scores) {\n                for (const category of conditions.category || []) {\n                    const categoryScore = latestCheck.quality_scores[category];\n                    if (categoryScore && this.evaluateCondition(categoryScore.final_score, conditions.quality_score)) {\n                        return true;\n                    }\n                }\n            }\n        }\n        \n        return false;\n    }\n    \n    evaluateCondition(value, condition) {\n        switch (condition.operator) {\n            case '<':\n                return value < condition.value;\n            case '<=':\n                return value <= condition.value;\n            case '>':\n                return value > condition.value;\n            case '>=':\n                return value >= condition.value;\n            case '==':\n                return value === condition.value;\n            case '!=':\n                return value !== condition.value;\n            default:\n                return false;\n        }\n    }\n    \n    async triggerAlert(alertConfig) {\n        const alert = {\n            id: `alert_${Date.now()}`,\n            config_id: alertConfig.id,\n            name: alertConfig.name,\n            severity: alertConfig.severity,\n            triggered_at: new Date().toISOString(),\n            status: 'active',\n            description: alertConfig.description\n        };\n        \n        logger.warn(`ğŸš¨ è§¦å‘é¢„è­¦: ${alert.name} (${alert.severity})`);\n        \n        // æ›´æ–°è§¦å‘ç»Ÿè®¡\n        alertConfig.trigger_count++;\n        alertConfig.last_triggered = alert.triggered_at;\n        \n        this.emit('alert:triggered', alert);\n        \n        return alert;\n    }\n    \n    calculateOverallQualityScore(qualityScores) {\n        const categoryWeights = {\n            energy: 0.25,\n            carbon: 0.30,\n            production: 0.20,\n            indicators: 0.25\n        };\n        \n        let totalWeight = 0;\n        let weightedSum = 0;\n        \n        for (const [category, scoreData] of Object.entries(qualityScores)) {\n            const weight = categoryWeights[category] || 0;\n            if (weight > 0 && scoreData.final_score !== undefined) {\n                totalWeight += weight;\n                weightedSum += scoreData.final_score * weight;\n            }\n        }\n        \n        return totalWeight > 0 ? weightedSum / totalWeight : 0;\n    }\n    \n    calculateAnomalyDetectionRate() {\n        // æ¨¡æ‹Ÿå¼‚å¸¸æ£€æµ‹ç‡è®¡ç®—\n        const totalDetections = Array.from(this.anomalyDetectors.values())\n            .reduce((sum, detector) => sum + detector.detection_count, 0);\n        const totalRecords = 10000; // æ¨¡æ‹Ÿæ€»è®°å½•æ•°\n        return totalRecords > 0 ? totalDetections / totalRecords : 0;\n    }\n    \n    calculateDataFreshnessScore() {\n        // æ¨¡æ‹Ÿæ•°æ®æ—¶æ•ˆæ€§è¯„åˆ†è®¡ç®—\n        return 0.95;\n    }\n    \n    /**\n     * ç”Ÿæˆè´¨é‡æŠ¥å‘Š\n     */\n    async generateQualityReport() {\n        const report = {\n            id: `quality_report_${Date.now()}`,\n            generated_at: new Date().toISOString(),\n            period: {\n                start: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),\n                end: new Date().toISOString()\n            },\n            summary: {\n                overall_quality_score: this.qualityMetrics.get('overall_quality_score')?.current_value || 0,\n                total_rules_executed: Array.from(this.qualityRules.values())\n                    .reduce((sum, rule) => sum + rule.execution_count, 0),\n                total_anomalies_detected: Array.from(this.anomalyDetectors.values())\n                    .reduce((sum, detector) => sum + detector.detection_count, 0),\n                alerts_triggered: Array.from(this.alertConfigs.values())\n                    .reduce((sum, config) => sum + config.trigger_count, 0)\n            },\n            quality_metrics: Object.fromEntries(\n                Array.from(this.qualityMetrics.entries()).map(([id, metric]) => [\n                    id,\n                    {\n                        current_value: metric.current_value,\n                        target_value: metric.target_value,\n                        trend: metric.trend,\n                        achievement_rate: metric.target_value > 0 ? \n                            (metric.current_value / metric.target_value) : 0\n                    }\n                ])\n            ),\n            recommendations: this.generateQualityRecommendations()\n        };\n        \n        this.qualityReports.set(report.id, report);\n        logger.info(`ğŸ“Š è´¨é‡æŠ¥å‘Šå·²ç”Ÿæˆ: ${report.id}`);\n        \n        return report;\n    }\n    \n    generateQualityRecommendations() {\n        const recommendations = [];\n        \n        // åŸºäºè´¨é‡æŒ‡æ ‡ç”Ÿæˆå»ºè®®\n        for (const [metricId, metric] of this.qualityMetrics) {\n            if (metric.current_value < metric.target_value * 0.9) {\n                recommendations.push({\n                    type: 'quality_improvement',\n                    metric: metricId,\n                    priority: 'high',\n                    description: `${metric.name}ä½äºç›®æ ‡å€¼90%ï¼Œå»ºè®®åŠ å¼ºæ•°æ®è´¨é‡ç®¡æ§`,\n                    suggested_actions: [\n                        'å¢åŠ æ•°æ®éªŒè¯è§„åˆ™',\n                        'æé«˜æ•°æ®é‡‡é›†é¢‘ç‡',\n                        'åŠ å¼ºæ•°æ®æºç›‘æ§'\n                    ]\n                });\n            }\n        }\n        \n        return recommendations;\n    }\n    \n    /**\n     * è·å–æœåŠ¡çŠ¶æ€\n     */\n    getServiceStatus() {\n        return {\n            service_name: 'RealTimeDataQualityService',\n            status: 'running',\n            uptime: Date.now() - this.startTime,\n            statistics: {\n                quality_rules: this.qualityRules.size,\n                anomaly_detectors: this.anomalyDetectors.size,\n                alert_configs: this.alertConfigs.size,\n                quality_metrics: this.qualityMetrics.size,\n                monitoring_tasks: this.monitoringTasks.size\n            },\n            latest_metrics: Object.fromEntries(\n                Array.from(this.qualityMetrics.entries()).map(([id, metric]) => [\n                    id,\n                    {\n                        value: metric.current_value,\n                        trend: metric.trend,\n                        last_updated: metric.last_updated\n                    }\n                ])\n            )\n        };\n    }\n    \n    /**\n     * åœæ­¢æœåŠ¡\n     */\n    async stop() {\n        logger.info('ğŸ›‘ åœæ­¢å®æ—¶æ•°æ®è´¨é‡ç›‘æ§æœåŠ¡...');\n        \n        // æ¸…ç†ç›‘æ§ä»»åŠ¡\n        for (const [taskName, task] of this.monitoringTasks) {\n            clearInterval(task);\n            logger.info(`âœ… å·²åœæ­¢ç›‘æ§ä»»åŠ¡: ${taskName}`);\n        }\n        \n        this.monitoringTasks.clear();\n        this.emit('quality:stopped');\n        \n        logger.info('âœ… å®æ—¶æ•°æ®è´¨é‡ç›‘æ§æœåŠ¡å·²åœæ­¢');\n    }\n    \n    /**\n     * åˆå§‹åŒ–æ•°æ®è´¨é‡è§„åˆ™\n     */\n    async initializeQualityRules() {\n        const rules = [\n            // èƒ½æºæ•°æ®è´¨é‡è§„åˆ™\n            {\n                id: 'energy_completeness',\n                name: 'èƒ½æºæ•°æ®å®Œæ•´æ€§',\n                category: 'energy',\n                data_source: 'ems_energy_data',\n                rule_type: 'completeness',\n                description: 'æ£€æŸ¥èƒ½æºæ¶ˆè´¹æ•°æ®çš„å®Œæ•´æ€§',\n                validation_logic: {\n                    required_fields: ['meter_id', 'energy_type', 'consumption_amount', 'measurement_time'],\n                    null_tolerance: 0,\n                    missing_tolerance: 0.05 // 5%å®¹é”™ç‡\n                },\n                thresholds: {\n                    excellent: 0.98,\n                    good: 0.95,\n                    acceptable: 0.90,\n                    poor: 0.85\n                },\n                weight: 0.25,\n                enabled: true\n            },\n            {\n                id: 'energy_accuracy',\n                name: 'èƒ½æºæ•°æ®å‡†ç¡®æ€§',\n                category: 'energy',\n                data_source: 'ems_energy_data',\n                rule_type: 'accuracy',\n                description: 'æ£€æŸ¥èƒ½æºæ¶ˆè´¹æ•°æ®çš„å‡†ç¡®æ€§',\n                validation_logic: {\n                    range_checks: {\n                        'consumption_amount': { min: 0, max: 10000 },\n                        'measurement_time': { format: 'ISO8601', future_tolerance: 300 }\n                    },\n                    business_rules: [\n                        'consumption_amount > 0',\n                        'measurement_time <= current_time + 5_minutes'\n                    ],\n                    outlier_detection: {\n                        method: 'z_score',\n                        threshold: 3,\n                        window_size: 100\n                    }\n                },\n                thresholds: {\n                    excellent: 0.99,\n                    good: 0.97,\n                    acceptable: 0.93,\n                    poor: 0.90\n                },\n                weight: 0.30,\n                enabled: true\n            },\n            {\n                id: 'energy_timeliness',\n                name: 'èƒ½æºæ•°æ®æ—¶æ•ˆæ€§',\n                category: 'energy',\n                data_source: 'ems_energy_data',\n                rule_type: 'timeliness',\n                description: 'æ£€æŸ¥èƒ½æºæ•°æ®çš„æ—¶æ•ˆæ€§',\n                validation_logic: {\n                    max_delay: 300, // 5åˆ†é’Ÿ\n                    expected_frequency: 60, // æ¯åˆ†é’Ÿ\n                    delay_calculation: 'current_time - measurement_time'\n                },\n                thresholds: {\n                    excellent: 0.98,\n                    good: 0.95,\n                    acceptable: 0.90,\n                    poor: 0.85\n                },\n                weight: 0.20,\n                enabled: true\n            },\n            {\n                id: 'energy_consistency',\n                name: 'èƒ½æºæ•°æ®ä¸€è‡´æ€§',\n                category: 'energy',\n                data_source: 'ems_energy_data',\n                rule_type: 'consistency',\n                description: 'æ£€æŸ¥èƒ½æºæ•°æ®çš„ä¸€è‡´æ€§',\n                validation_logic: {\n                    cross_validation: [\n                        'sum(sub_meters) == total_meter',\n                        'energy_type matches meter_type'\n                    ],\n                    temporal_consistency: {\n                        check_period: '1_hour',\n                        variance_threshold: 0.2\n                    }\n                },\n                thresholds: {\n                    excellent: 0.97,\n                    good: 0.94,\n                    acceptable: 0.90,\n                    poor: 0.85\n                },\n                weight: 0.25,\n                enabled: true\n            },\n            \n            // ç¢³æ’æ”¾æ•°æ®è´¨é‡è§„åˆ™\n            {\n                id: 'carbon_completeness',\n                name: 'ç¢³æ’æ”¾æ•°æ®å®Œæ•´æ€§',\n                category: 'carbon',\n                data_source: 'carbon_emissions',\n                rule_type: 'completeness',\n                description: 'æ£€æŸ¥ç¢³æ’æ”¾è®¡ç®—æ•°æ®çš„å®Œæ•´æ€§',\n                validation_logic: {\n                    required_fields: ['emission_id', 'emission_scope', 'emission_source', 'emission_amount', 'calculation_time'],\n                    null_tolerance: 0,\n                    missing_tolerance: 0.02\n                },\n                thresholds: {\n                    excellent: 0.99,\n                    good: 0.97,\n                    acceptable: 0.93,\n                    poor: 0.90\n                },\n                weight: 0.30,\n                enabled: true\n            },\n            {\n                id: 'carbon_accuracy',\n                name: 'ç¢³æ’æ”¾æ•°æ®å‡†ç¡®æ€§',\n                category: 'carbon',\n                data_source: 'carbon_emissions',\n                rule_type: 'accuracy',\n                description: 'æ£€æŸ¥ç¢³æ’æ”¾è®¡ç®—ç»“æœçš„å‡†ç¡®æ€§',\n                validation_logic: {\n                    calculation_verification: {\n                        recalculate_sample: 0.1, // é‡æ–°è®¡ç®—10%æ ·æœ¬\n                        tolerance: 0.01 // 1%è¯¯å·®å®¹å¿\n                    },\n                    factor_validation: {\n                        check_emission_factors: true,\n                        validate_calculation_method: true\n                    }\n                },\n                thresholds: {\n                    excellent: 0.99,\n                    good: 0.97,\n                    acceptable: 0.94,\n                    poor: 0.90\n                },\n                weight: 0.35,\n                enabled: true\n            },\n            {\n                id: 'carbon_validity',\n                name: 'ç¢³æ’æ”¾æ•°æ®æœ‰æ•ˆæ€§',\n                category: 'carbon',\n                data_source: 'carbon_emissions',\n                rule_type: 'validity',\n                description: 'æ£€æŸ¥ç¢³æ’æ”¾æ•°æ®çš„æœ‰æ•ˆæ€§',\n                validation_logic: {\n                    scope_validation: {\n                        valid_scopes: ['scope1', 'scope2', 'scope3'],\n                        scope_completeness: true\n                    },\n                    source_validation: {\n                        valid_sources: ['electricity', 'natural_gas', 'coal', 'diesel', 'gasoline'],\n                        source_mapping: true\n                    }\n                },\n                thresholds: {\n                    excellent: 0.98,\n                    good: 0.95,\n                    acceptable: 0.92,\n                    poor: 0.88\n                },\n                weight: 0.20,\n                enabled: true\n            },\n            {\n                id: 'carbon_traceability',\n                name: 'ç¢³æ’æ”¾æ•°æ®å¯è¿½æº¯æ€§',\n                category: 'carbon',\n                data_source: 'carbon_emissions',\n                rule_type: 'traceability',\n                description: 'æ£€æŸ¥ç¢³æ’æ”¾æ•°æ®çš„å¯è¿½æº¯æ€§',\n                validation_logic: {\n                    audit_trail: {\n                        required_metadata: ['calculation_method', 'emission_factor_source', 'data_source'],\n                        version_control: true\n                    },\n                    lineage_validation: {\n                        source_data_linkage: true,\n                        calculation_steps: true\n                    }\n                },\n                thresholds: {\n                    excellent: 0.96,\n                    good: 0.93,\n                    acceptable: 0.88,\n                    poor: 0.83\n                },\n                weight: 0.15,\n                enabled: true\n            },\n            \n            // ç”Ÿäº§æ•°æ®è´¨é‡è§„åˆ™\n            {\n                id: 'production_completeness',\n                name: 'ç”Ÿäº§æ•°æ®å®Œæ•´æ€§',\n                category: 'production',\n                data_source: 'mes_production_data',\n                rule_type: 'completeness',\n                description: 'æ£€æŸ¥ç”Ÿäº§æ•°æ®çš„å®Œæ•´æ€§',\n                validation_logic: {\n                    required_fields: ['enterprise_id', 'product_code', 'production_volume', 'production_date'],\n                    null_tolerance: 0,\n                    missing_tolerance: 0.03\n                },\n                thresholds: {\n                    excellent: 0.98,\n                    good: 0.95,\n                    acceptable: 0.91,\n                    poor: 0.87\n                },\n                weight: 0.25,\n                enabled: true\n            },\n            {\n                id: 'production_consistency',\n                name: 'ç”Ÿäº§æ•°æ®ä¸€è‡´æ€§',\n                category: 'production',\n                data_source: 'mes_production_data',\n                rule_type: 'consistency',\n                description: 'æ£€æŸ¥ç”Ÿäº§æ•°æ®çš„ä¸€è‡´æ€§',\n                validation_logic: {\n                    cross_system_validation: [\n                        'production_volume matches inventory_change',\n                        'enterprise_id exists in enterprise_registry'\n                    ],\n                    temporal_consistency: {\n                        check_period: '1_day',\n                        variance_threshold: 0.15\n                    }\n                },\n                thresholds: {\n                    excellent: 0.96,\n                    good: 0.93,\n                    acceptable: 0.89,\n                    poor: 0.84\n                },\n                weight: 0.30,\n                enabled: true\n            },\n            \n            // å›½å®¶æŒ‡æ ‡æ•°æ®è´¨é‡è§„åˆ™\n            {\n                id: 'indicator_accuracy',\n                name: 'å›½å®¶æŒ‡æ ‡å‡†ç¡®æ€§',\n                category: 'indicators',\n                data_source: 'national_indicators',\n                rule_type: 'accuracy',\n                description: 'æ£€æŸ¥å›½å®¶æŒ‡æ ‡è®¡ç®—çš„å‡†ç¡®æ€§',\n                validation_logic: {\n                    calculation_verification: {\n                        recalculate_sample: 0.2,\n                        tolerance: 0.005\n                    },\n                    benchmark_comparison: {\n                        compare_with_targets: true,\n                        historical_trend_check: true\n                    }\n                },\n                thresholds: {\n                    excellent: 0.995,\n                    good: 0.99,\n                    acceptable: 0.98,\n                    poor: 0.95\n                },\n                weight: 0.40,\n                enabled: true\n            },\n            {\n                id: 'indicator_compliance',\n                name: 'å›½å®¶æŒ‡æ ‡åˆè§„æ€§',\n                category: 'indicators',\n                data_source: 'national_indicators',\n                rule_type: 'compliance',\n                description: 'æ£€æŸ¥å›½å®¶æŒ‡æ ‡çš„åˆè§„æ€§',\n                validation_logic: {\n                    standard_compliance: {\n                        check_calculation_method: true,\n                        validate_data_sources: true,\n                        verify_reporting_format: true\n                    },\n                    regulatory_requirements: [\n                        'calculation_follows_national_standard',\n                        'data_retention_compliant',\n                        'audit_trail_complete'\n                    ]\n                },\n                thresholds: {\n                    excellent: 1.0,\n                    good: 0.98,\n                    acceptable: 0.95,\n                    poor: 0.90\n                },\n                weight: 0.35,\n                enabled: true\n            }\n        ];\n        \n        for (const rule of rules) {\n            this.qualityRules.set(rule.id, {\n                ...rule,\n                created_at: new Date().toISOString(),\n                last_updated: new Date().toISOString(),\n                execution_count: 0,\n                last_execution: null,\n                status: 'active'\n            });\n        }\n        \n        logger.info(`ğŸ“‹ å·²åˆå§‹åŒ– ${this.qualityRules.size} ä¸ªæ•°æ®è´¨é‡è§„åˆ™`);\n    }\n    \n    /**\n     * åˆå§‹åŒ–å¼‚å¸¸æ£€æµ‹å™¨\n     */\n    async initializeAnomalyDetectors() {\n        const detectors = [\n            {\n                id: 'statistical_outlier',\n                name: 'ç»Ÿè®¡å¼‚å¸¸æ£€æµ‹',\n                type: 'statistical',\n                description: 'åŸºäºç»Ÿè®¡æ–¹æ³•æ£€æµ‹æ•°æ®å¼‚å¸¸',\n                algorithm: 'z_score',\n                parameters: {\n                    threshold: 3,\n                    window_size: 100,\n                    min_samples: 30\n                },\n                applicable_data_types: ['numeric'],\n                sensitivity: 'medium'\n            },\n            {\n                id: 'trend_anomaly',\n                name: 'è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹',\n                type: 'trend',\n                description: 'æ£€æµ‹æ•°æ®è¶‹åŠ¿å¼‚å¸¸',\n                algorithm: 'moving_average_deviation',\n                parameters: {\n                    window_size: 24,\n                    deviation_threshold: 0.3,\n                    trend_sensitivity: 0.1\n                },\n                applicable_data_types: ['time_series'],\n                sensitivity: 'high'\n            },\n            {\n                id: 'pattern_anomaly',\n                name: 'æ¨¡å¼å¼‚å¸¸æ£€æµ‹',\n                type: 'pattern',\n                description: 'æ£€æµ‹æ•°æ®æ¨¡å¼å¼‚å¸¸',\n                algorithm: 'isolation_forest',\n                parameters: {\n                    contamination: 0.1,\n                    n_estimators: 100,\n                    max_samples: 256\n                },\n                applicable_data_types: ['multivariate'],\n                sensitivity: 'medium'\n            },\n            {\n                id: 'business_rule_violation',\n                name: 'ä¸šåŠ¡è§„åˆ™è¿åæ£€æµ‹',\n                type: 'rule_based',\n                description: 'æ£€æµ‹è¿åä¸šåŠ¡è§„åˆ™çš„æ•°æ®',\n                algorithm: 'rule_engine',\n                parameters: {\n                    rule_evaluation: 'strict',\n                    violation_tolerance: 0\n                },\n                applicable_data_types: ['all'],\n                sensitivity: 'high'\n            }\n        ];\n        \n        for (const detector of detectors) {\n            this.anomalyDetectors.set(detector.id, {\n                ...detector,\n                created_at: new Date().toISOString(),\n                detection_count: 0,\n                last_detection: null,\n                status: 'active'\n            });\n        }\n        \n        logger.info(`ğŸ” å·²åˆå§‹åŒ– ${this.anomalyDetectors.size} ä¸ªå¼‚å¸¸æ£€æµ‹å™¨`);\n    }\n    \n    /**\n     * åˆå§‹åŒ–é¢„è­¦é…ç½®\n     */\n    async initializeAlertConfigs() {\n        const configs = [\n            {\n                id: 'critical_quality_degradation',\n                name: 'å…³é”®è´¨é‡ä¸‹é™é¢„è­¦',\n                severity: 'critical',\n                description: 'æ•°æ®è´¨é‡ä¸¥é‡ä¸‹é™æ—¶è§¦å‘',\n                trigger_conditions: {\n                    quality_score: { operator: '<', value: 0.85 },\n                    category: ['energy', 'carbon', 'indicators'],\n                    duration: 300 // 5åˆ†é’Ÿ\n                },\n                notification_channels: ['email', 'sms', 'dashboard'],\n                escalation_rules: {\n                    level_1: { delay: 0, recipients: ['quality_team'] },\n                    level_2: { delay: 600, recipients: ['quality_manager'] },\n                    level_3: { delay: 1800, recipients: ['system_admin'] }\n                },\n                auto_actions: [\n                    'increase_monitoring_frequency',\n                    'trigger_data_validation',\n                    'generate_quality_report'\n                ]\n            },\n            {\n                id: 'anomaly_detection_alert',\n                name: 'å¼‚å¸¸æ£€æµ‹é¢„è­¦',\n                severity: 'high',\n                description: 'æ£€æµ‹åˆ°æ•°æ®å¼‚å¸¸æ—¶è§¦å‘',\n                trigger_conditions: {\n                    anomaly_count: { operator: '>=', value: 5 },\n                    time_window: 600, // 10åˆ†é’Ÿ\n                    anomaly_types: ['statistical_outlier', 'trend_anomaly']\n                },\n                notification_channels: ['email', 'dashboard'],\n                escalation_rules: {\n                    level_1: { delay: 0, recipients: ['data_analyst'] },\n                    level_2: { delay: 900, recipients: ['quality_team'] }\n                },\n                auto_actions: [\n                    'detailed_anomaly_analysis',\n                    'data_source_health_check'\n                ]\n            },\n            {\n                id: 'compliance_violation',\n                name: 'åˆè§„æ€§è¿åé¢„è­¦',\n                severity: 'high',\n                description: 'æ£€æµ‹åˆ°åˆè§„æ€§è¿åæ—¶è§¦å‘',\n                trigger_conditions: {\n                    compliance_score: { operator: '<', value: 0.95 },\n                    category: ['indicators'],\n                    violation_type: ['calculation_method', 'data_retention']\n                },\n                notification_channels: ['email', 'sms'],\n                escalation_rules: {\n                    level_1: { delay: 0, recipients: ['compliance_officer'] },\n                    level_2: { delay: 300, recipients: ['legal_team'] }\n                },\n                auto_actions: [\n                    'compliance_audit_trigger',\n                    'violation_documentation'\n                ]\n            },\n            {\n                id: 'data_freshness_warning',\n                name: 'æ•°æ®æ—¶æ•ˆæ€§é¢„è­¦',\n                severity: 'medium',\n                description: 'æ•°æ®æ›´æ–°å»¶è¿Ÿæ—¶è§¦å‘',\n                trigger_conditions: {\n                    data_delay: { operator: '>', value: 600 }, // 10åˆ†é’Ÿ\n                    data_sources: ['ems_energy_data', 'mes_production_data']\n                },\n                notification_channels: ['dashboard'],\n                escalation_rules: {\n                    level_1: { delay: 0, recipients: ['data_team'] }\n                },\n                auto_actions: [\n                    'data_source_connectivity_check',\n                    'retry_data_collection'\n                ]\n            }\n        ];\n        \n        for (const config of configs) {\n            this.alertConfigs.set(config.id, {\n                ...config,\n                created_at: new Date().toISOString(),\n                trigger_count: 0,\n                last_triggered: null,\n                status: 'active'\n            });\n        }\n        \n        logger.info(`ğŸš¨ å·²åˆå§‹åŒ– ${this.alertConfigs.size} ä¸ªé¢„è­¦é…ç½®`);\n    }\n    \n    /**\n     * å¯åŠ¨å®æ—¶ç›‘æ§\n     */\n    async startRealTimeMonitoring() {\n        // å®æ—¶è´¨é‡æ£€æŸ¥ä»»åŠ¡\n        const realTimeQualityTask = setInterval(async () => {\n            await this.performRealTimeQualityCheck();\n        }, MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND); // æ¯åˆ†é’Ÿ\n        \n        // å¼‚å¸¸æ£€æµ‹ä»»åŠ¡\n        const anomalyDetectionTask = setInterval(async () => {\n            await this.performAnomalyDetection();\n        }, MATH_CONSTANTS.FIVE * MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND); // æ¯5åˆ†é’Ÿ\n        \n        // è´¨é‡è¶‹åŠ¿åˆ†æä»»åŠ¡\n        const trendAnalysisTask = setInterval(async () => {\n            await this.performTrendAnalysis();\n        }, MATH_CONSTANTS.FIFTEEN * MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND); // æ¯15åˆ†é’Ÿ\n        \n        // é¢„è­¦æ£€æŸ¥ä»»åŠ¡\n        const alertCheckTask = setInterval(async () => {\n            await this.checkAlertConditions();\n        }, MATH_CONSTANTS.THIRTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND); // æ¯30ç§’\n        \n        this.monitoringTasks.set('real_time_quality', realTimeQualityTask);\n        this.monitoringTasks.set('anomaly_detection', anomalyDetectionTask);\n        this.monitoringTasks.set('trend_analysis', trendAnalysisTask);\n        this.monitoringTasks.set('alert_check', alertCheckTask);\n        \n        logger.info('ğŸ”„ å®æ—¶æ•°æ®è´¨é‡ç›‘æ§ä»»åŠ¡å·²å¯åŠ¨');\n    }\n    \n    /**\n     * åˆå§‹åŒ–è´¨é‡æŒ‡æ ‡\n     */\n    async initializeQualityMetrics() {\n        const metrics = [\n            {\n                id: 'overall_quality_score',\n                name: 'æ•´ä½“è´¨é‡è¯„åˆ†',\n                description: 'ç³»ç»Ÿæ•´ä½“æ•°æ®è´¨é‡è¯„åˆ†',\n                calculation_method: 'weighted_average',\n                target_value: 0.95,\n                unit: 'score',\n                category: 'overall'\n            },\n            {\n                id: 'energy_data_quality',\n                name: 'èƒ½æºæ•°æ®è´¨é‡',\n                description: 'èƒ½æºæ•°æ®è´¨é‡è¯„åˆ†',\n                calculation_method: 'category_average',\n                target_value: 0.96,\n                unit: 'score',\n                category: 'energy'\n            },\n            {\n                id: 'carbon_data_quality',\n                name: 'ç¢³æ’æ”¾æ•°æ®è´¨é‡',\n                description: 'ç¢³æ’æ”¾æ•°æ®è´¨é‡è¯„åˆ†',\n                calculation_method: 'category_average',\n                target_value: 0.98,\n                unit: 'score',\n                category: 'carbon'\n            },\n            {\n                id: 'production_data_quality',\n                name: 'ç”Ÿäº§æ•°æ®è´¨é‡',\n                description: 'ç”Ÿäº§æ•°æ®è´¨é‡è¯„åˆ†',\n                calculation_method: 'category_average',\n                target_value: 0.94,\n                unit: 'score',\n                category: 'production'\n            },\n            {\n                id: 'indicator_data_quality',\n                name: 'å›½å®¶æŒ‡æ ‡æ•°æ®è´¨é‡',\n                description: 'å›½å®¶æŒ‡æ ‡æ•°æ®è´¨é‡è¯„åˆ†',\n                calculation_method: 'category_average',\n                target_value: 0.99,\n                unit: 'score',\n                category: 'indicators'\n            },\n            {\n                id: 'anomaly_detection_rate',\n                name: 'å¼‚å¸¸æ£€æµ‹ç‡',\n                description: 'æ•°æ®å¼‚å¸¸æ£€æµ‹ç‡',\n                calculation_method: 'percentage',\n                target_value: 0.02,\n                unit: 'percentage',\n                category: 'monitoring'\n            },\n            {\n                id: 'data_freshness_score',\n                name: 'æ•°æ®æ—¶æ•ˆæ€§è¯„åˆ†',\n                description: 'æ•°æ®æ—¶æ•ˆæ€§è¯„åˆ†',\n                calculation_method: 'timeliness_average',\n                target_value: 0.97,\n                unit: 'score',\n                category: 'timeliness'\n            }\n        ];\n        \n        for (const metric of metrics) {\n            this.qualityMetrics.set(metric.id, {\n                ...metric,\n                current_value: 0,\n                last_updated: new Date().toISOString(),\n                trend: 'stable',\n                history: []\n            });\n        }\n        \n        logger.info(`ğŸ“ˆ å·²åˆå§‹åŒ– ${this.qualityMetrics.size} ä¸ªè´¨é‡æŒ‡æ ‡`);\n    }\n    \n    /**\n     * æ‰§è¡Œå®æ—¶è´¨é‡æ£€æŸ¥\n     */\n    async performRealTimeQualityCheck() {\n        logger.info('ğŸ” å¼€å§‹å®æ—¶è´¨é‡æ£€æŸ¥...');\n        \n        const checkResults = {\n            timestamp: new Date().toISOString(),\n            total_rules_checked: 0,\n            passed_rules: 0,\n            failed_rules: 0,\n            quality_scores: {},\n            issues_found: []\n        };\n        \n        // æ‰§è¡Œæ‰€æœ‰å¯ç”¨çš„è´¨é‡è§„åˆ™\n        for (const [ruleId, rule] of this.qualityRules) {\n            if (!rule.enabled) {continue;}\n            \n            try {\n                const ruleResult = await this.executeQualityRule(rule);\n                checkResults.total_rules_checked++;\n                \n                if (ruleResult.passed) {\n                    checkResults.passed_rules++;\n                } else {\n                    checkResults.failed_rules++;\n                    checkResults.issues_found.push({\n                        rule_id: ruleId,\n                        rule_name: rule.name,\n                        issue_type: ruleResult.issue_type,\n                        severity: ruleResult.severity,\n                        description: ruleResult.description,\n                        affected_records: ruleResult.affected_records\n                    });\n                }\n                \n                // æ›´æ–°è´¨é‡åˆ†æ•°\n                if (!checkResults.quality_scores[rule.category]) {\n                    checkResults.quality_scores[rule.category] = {\n                        total_weight: 0,\n                        weighted_score: 0,\n                        rule_count: 0\n                    };\n                }\n                \n                checkResults.quality_scores[rule.category].total_weight += rule.weight;\n                checkResults.quality_scores[rule.category].weighted_score += ruleResult.score * rule.weight;\n                checkResults.quality_scores[rule.category].rule_count++;\n                \n                // æ›´æ–°è§„åˆ™æ‰§è¡Œç»Ÿè®¡\n                rule.execution_count++;\n                rule.last_execution = new Date().toISOString();\n                \n            } catch (error) {\n                logger.error(`è´¨é‡è§„åˆ™æ‰§è¡Œå¤±è´¥ ${ruleId}:`, error);\n                checkResults.issues_found.push({\n                    rule_id: ruleId,\n                    rule_name: rule.name,\n                    issue_type: 'execution_error',\n                    severity: 'high',\n                    description: `è§„åˆ™æ‰§è¡Œå¤±è´¥: ${error.message}`,\n                    affected_records: 0\n                });\n            }\n        }\n        \n        // è®¡ç®—åˆ†ç±»è´¨é‡åˆ†æ•°\n        for (const [_category, scoreData] of Object.entries(checkResults.quality_scores)) {\n            if (scoreData.total_weight > 0) {\n                scoreData.final_score = scoreData.weighted_score / scoreData.total_weight;\n            } else {\n                scoreData.final_score = 0;\n            }\n        }\n        \n        // æ›´æ–°å®æ—¶çŠ¶æ€\n        this.realTimeStatus.set('latest_check', checkResults);\n        \n        // æ›´æ–°è´¨é‡æŒ‡æ ‡\n        await this.updateQualityMetrics(checkResults);\n        \n        logger.info(`âœ… å®æ—¶è´¨é‡æ£€æŸ¥å®Œæˆï¼Œæ£€æŸ¥äº† ${checkResults.total_rules_checked} ä¸ªè§„åˆ™ï¼Œå‘ç° ${checkResults.issues_found.length} ä¸ªé—®é¢˜`);\n        this.emit('quality:check_completed', checkResults);\n        \n        return checkResults;\n    }\n    \n    /**\n     * æ‰§è¡Œè´¨é‡è§„åˆ™\n     * @param {Object} rule è´¨é‡è§„åˆ™\n     * @returns {Object} è§„åˆ™æ‰§è¡Œç»“æœ\n     */\n    async executeQualityRule(rule) {\n        let result = {\n            rule_id: rule.id,\n            executed_at: new Date().toISOString(),\n            passed: false,\n            score: 0,\n            issue_type: null,\n            severity: 'low',\n            description: '',\n            affected_records: 0,\n            details: {}\n        };\n        \n        try {\n            // è·å–æµ‹è¯•æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰\n            const testData = await this.getTestData(rule.data_source);\n            \n            switch (rule.rule_type) {\n                case 'completeness':\n                    result = await this.checkCompleteness(rule, testData, result);\n                    break;\n                case 'accuracy':\n                    result = await this.checkAccuracy(rule, testData, result);\n                    break;\n                case 'timeliness':\n                    result = await this.checkTimeliness(rule, testData, result);\n                    break;\n                case 'consistency':\n                    result = await this.checkConsistency(rule, testData, result);\n                    break;\n                case 'validity':\n                    result = await this.checkValidity(rule, testData, result);\n                    break;\n                case 'traceability':\n                    result = await this.checkTraceability(rule, testData, result);\n                    break;\n                case 'compliance':\n                    result = await this.checkCompliance(rule, testData, result);\n                    break;\n                default:\n                    throw new Error(`ä¸æ”¯æŒçš„è§„åˆ™ç±»å‹: ${rule.rule_type}`);\n            }\n            \n            // æ ¹æ®åˆ†æ•°ç¡®å®šæ˜¯å¦é€šè¿‡\n            result.passed = result.score >= rule.thresholds.acceptable;\n            \n            // ç¡®å®šä¸¥é‡ç¨‹åº¦\n            if (result.score >= rule.thresholds.excellent) {\n                result.severity = 'info';\n            } else if (result.score >= rule.thresholds.good) {\n                result.severity = 'low';\n            } else if (result.score >= rule.thresholds.acceptable) {\n                result.severity = 'medium';\n            } else {\n                result.severity = 'high';\n            }\n            \n        } catch (error) {\n            result.passed = false;\n            result.score = 0;\n            result.issue_type = 'execution_error';\n            result.severity = 'high';\n            result.description = `è§„åˆ™æ‰§è¡Œé”™è¯¯: ${error.message}`;\n        }\n        \n        return result;\n    }\n    \n    /**\n     * æ£€æŸ¥æ•°æ®å®Œæ•´æ€§\n     */\n    async checkCompleteness(rule, testData, result) {\n        const validation = rule.validation_logic;\n        const totalRecords = testData.length;\n        let completeRecords = 0;\n        const missingFields = {};\n        \n        for (const record of testData) {\n            let recordComplete = true;\n            \n            for (const field of validation.required_fields) {\n                if (!record[field] || record[field] === null || record[field] === undefined) {\n                    recordComplete = false;\n                    missingFields[field] = (missingFields[field] || 0) + 1;\n                }\n            }\n            \n            if (recordComplete) {\n                completeRecords++;\n            }\n        }\n        \n        const completenessRate = totalRecords > 0 ? completeRecords / totalRecords : 0;\n        \n        result.score = completenessRate;\n        result.affected_records = totalRecords - completeRecords;\n        result.details = {\n            total_records: totalRecords,\n            complete_records: completeRecords,\n            completeness_rate: completenessRate,\n            missing_fields: missingFields\n        };\n        \n        if (completenessRate < validation.missing_tolerance) {\n            result.issue_type = 'completeness_violation';\n            result.description = `æ•°æ®å®Œæ•´æ€§ä¸è¶³: ${(completenessRate * 100).toFixed(2)}%ï¼Œä½äºè¦æ±‚çš„ ${((1 - validation.missing_tolerance) * 100).toFixed(2)}%`;\n        }\n        \n        return result;\n    }\n    \n    /**\n     * æ£€æŸ¥æ•°æ®å‡†ç¡®æ€§\n     */\n    async checkAccuracy(rule, testData, result) {\n        const validation = rule.validation_logic;\n        let accurateRecords = 0;\n        let rangeViolations = 0;\n        let businessRuleViolations = 0;\n        let outliers = 0;\n        \n        for (const record of testData) {\n            let recordAccurate = true;\n            \n            // èŒƒå›´æ£€æŸ¥\n            if (validation.range_checks) {\n                for (const [field, range] of Object.entries(validation.range_checks)) {\n                    const value = record[field];\n                    if (value !== null && value !== undefined) {\n                        if ((range.min !== undefined && value < range.min) ||\n                            (range.max !== undefined && value > range.max)) {\n                            recordAccurate = false;\n                            rangeViolations++;\n                        }\n                    }\n                }\n            }\n            \n            // ä¸šåŠ¡è§„åˆ™æ£€æŸ¥\n            if (validation.business_rules) {\n                for (const rule of validation.business_rules) {\n                    if (!this.evaluateBusinessRule(rule, record)) {\n                        recordAccurate = false;\n                        businessRuleViolations++;\n                    }\n                }\n            }\n            \n            if (recordAccurate) {\n                accurateRecords++;\n            }\n        }\n        \n        // å¼‚å¸¸å€¼æ£€æµ‹\n        if (validation.outlier_detection) {\n            outliers = await this.detectOutliers(testData, validation.outlier_detection);\n        }\n        \n        const accuracyRate = testData.length > 0 ? accurateRecords / testData.length : 0;\n        \n        result.score = accuracyRate;\n        result.affected_records = testData.length - accurateRecords;\n        result.details = {\n            total_records: testData.length,\n            accurate_records: accurateRecords,\n            accuracy_rate: accuracyRate,\n            range_violations: rangeViolations,\n            business_rule_violations: businessRuleViolations,\n            outliers\n        };\n        \n        if (accuracyRate < rule.thresholds.acceptable) {\n            result.issue_type = 'accuracy_violation';\n            result.description = `æ•°æ®å‡†ç¡®æ€§ä¸è¶³: ${(accuracyRate * 100).toFixed(2)}%`;\n        }\n        \n        return result;\n    }\n    \n    /**\n     * æ£€æŸ¥æ•°æ®æ—¶æ•ˆæ€§\n     */\n    async checkTimeliness(rule, testData, result) {\n        const validation = rule.validation_logic;\n        const currentTime = Date.now();\n        let timelyRecords = 0;\n        let totalDelay = 0;\n        let maxDelay = 0;\n        \n        for (const record of testData) {\n            const measurementTime = new Date(record.measurement_time || record.timestamp).getTime();\n            const delay = (currentTime - measurementTime) / 1000; // ç§’\n            \n            totalDelay += delay;\n            maxDelay = Math.max(maxDelay, delay);\n            \n            if (delay <= validation.max_delay) {\n                timelyRecords++;\n            }\n        }\n        \n        const timelinessRate = testData.length > 0 ? timelyRecords / testData.length : 0;\n        const avgDelay = testData.length > 0 ? totalDelay / testData.length : 0;\n        \n        result.score = timelinessRate;\n        result.affected_records = testData.length - timelyRecords;\n        result.details = {\n            total_records: testData.length,\n            timely_records: timelyRecords,\n            timeliness_rate: timelinessRate,\n            average_delay: avgDelay,\n            max_delay: maxDelay,\n            max_allowed_delay: validation.max_delay\n        };\n        \n        if (timelinessRate < rule.thresholds.acceptable) {\n            result.issue_type = 'timeliness_violation';\n            result.description = `æ•°æ®æ—¶æ•ˆæ€§ä¸è¶³: ${(timelinessRate * 100).toFixed(2)}%ï¼Œå¹³å‡å»¶è¿Ÿ ${avgDelay.toFixed(2)} ç§’`;\n        }\n        \n        return result;\n    }\n    \n    /**\n     * æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§\n     */\n    async checkConsistency(rule, testData, result) {\n        const validation = rule.validation_logic;\n        let consistentRecords = 0;\n        let crossValidationFailures = 0;\n        let temporalInconsistencies = 0;\n        \n        for (const record of testData) {\n            let recordConsistent = true;\n            \n            // äº¤å‰éªŒè¯\n            if (validation.cross_validation) {\n                for (const validationRule of validation.cross_validation) {\n                    if (!this.evaluateConsistencyRule(validationRule, record)) {\n                        recordConsistent = false;\n                        crossValidationFailures++;\n                    }\n                }\n            }\n            \n            if (recordConsistent) {\n                consistentRecords++;\n            }\n        }\n        \n        // æ—¶é—´ä¸€è‡´æ€§æ£€æŸ¥\n        if (validation.temporal_consistency) {\n            temporalInconsistencies = await this.checkTemporalConsistency(\n                testData, \n                validation.temporal_consistency\n            );\n        }\n        \n        const consistencyRate = testData.length > 0 ? consistentRecords / testData.length : 0;\n        \n        result.score = consistencyRate;\n        result.affected_records = testData.length - consistentRecords;\n        result.details = {\n            total_records: testData.length,\n            consistent_records: consistentRecords,\n            consistency_rate: consistencyRate,\n            cross_validation_failures: crossValidationFailures,\n            temporal_inconsistencies: temporalInconsistencies\n        };\n        \n        if (consistencyRate < rule.thresholds.acceptable) {\n            result.issue_type = 'consistency_violation';\n            result.description = `æ•°æ®ä¸€è‡´æ€§ä¸è¶³: ${(consistencyRate * 100).toFixed(2)}%`;\n        }\n        \n        return result;\n    }\n    \n    /**\n     * æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§\n     */\n    async checkValidity(rule, testData, result) {\n        const validation = rule.validation_logic;\n        let validRecords = 0;\n        let scopeViolations = 0;\n        let sourceViolations = 0;\n        \n        for (const record of testData) {\n            let recordValid = true;\n            \n            // èŒƒå›´éªŒè¯\n            if (validation.scope_validation) {\n                const scope = record.emission_scope || record.scope;\n                if (scope && !validation.scope_validation.valid_scopes.includes(scope)) {\n                    recordValid = false;\n                    scopeViolations++;\n                }\n            }\n            \n            // æ¥æºéªŒè¯\n            if (validation.source_validation) {\n                const source = record.emission_source || record.source;\n                if (source && !validation.source_validation.valid_sources.includes(source)) {\n                    recordValid = false;\n                    sourceViolations++;\n                }\n            }\n            \n            if (recordValid) {\n                validRecords++;\n            }\n        }\n        \n        const validityRate = testData.length > 0 ? validRecords / testData.length : 0;\n        \n        result.score = validityRate;\n        result.affected_records = testData.length - validRecords;\n        result.details = {\n            total_records: testData.length,\n            valid_records: validRecords,\n            validity_rate: validityRate,\n            scope_violations: scopeViolations,\n            source_violations: sourceViolations\n        };\n        \n        if (validityRate < rule.thresholds.acceptable) {\n            result.issue_type = 'validity_violation';\n            result.description = `æ•°æ®æœ‰æ•ˆæ€§ä¸è¶³: ${(validityRate * 100).toFixed(2)}%`;\n        }\n        \n        return result;\n    }\n    \n    /**\n     * æ£€æŸ¥æ•°æ®å¯è¿½æº¯æ€§\n     */\n    async checkTraceability(rule, testData, result) {\n        const validation = rule.validation_logic;\n        let traceableRecords = 0;\n        let missingMetadata = 0;\n        let missingLineage = 0;\n        \n        for (const record of testData) {\n            let recordTraceable = true;\n            \n            // å®¡è®¡è½¨è¿¹æ£€æŸ¥\n            if (validation.audit_trail) {\n                for (const field of validation.audit_trail.required_metadata) {\n                    if (!record[field]) {\n                        recordTraceable = false;\n                        missingMetadata++;\n                        break;\n                    }\n                }\n            }\n            \n            // è¡€ç¼˜éªŒè¯\n            if (validation.lineage_validation) {\n                if (!record.source_data_id || !record.calculation_steps) {\n                    recordTraceable = false;\n                    missingLineage++;\n                }\n            }\n            \n            if (recordTraceable) {\n                traceableRecords++;\n            }\n        }\n        \n        const traceabilityRate = testData.length > 0 ? traceableRecords / testData.length : 0;\n        \n        result.score = traceabilityRate;\n        result.affected_records = testData.length - traceableRecords;\n        result.details = {\n            total_records: testData.length,\n            traceable_records: traceableRecords,\n            traceability_rate: traceabilityRate,\n            missing_metadata: missingMetadata,\n            missing_lineage: missingLineage\n        };\n        \n        if (traceabilityRate < rule.thresholds.acceptable) {\n            result.issue_type = 'traceability_violation';\n            result.description = `æ•°æ®å¯è¿½æº¯æ€§ä¸è¶³: ${(traceabilityRate * 100).toFixed(2)}%`;\n        }\n        \n        return result;\n    }\n    \n    /**\n     * æ£€æŸ¥åˆè§„æ€§\n     */\n    async checkCompliance(rule, testData, result) {\n        const validation = rule.validation_logic;\n        let compliantRecords = 0;\n        let standardViolations = 0;\n        let regulatoryViolations = 0;\n        \n        for (const record of testData) {\n            let recordCompliant = true;\n            \n            // æ ‡å‡†åˆè§„æ£€æŸ¥\n            if (validation.standard_compliance) {\n                if (validation.standard_compliance.check_calculation_method) {\n                    if (!record.calculation_method || \n                        !this.isValidCalculationMethod(record.calculation_method)) {\n                        recordCompliant = false;\n                        standardViolations++;\n                    }\n                }\n            }\n            \n            // ç›‘ç®¡è¦æ±‚æ£€æŸ¥\n            if (validation.regulatory_requirements) {\n                for (const requirement of validation.regulatory_requirements) {\n                    if (!this.evaluateRegulatoryRequirement(requirement, record)) {\n                        recordCompliant = false;\n                        regulatoryViolations++;\n                        break;\n                    }\n                }\n            }\n            \n            if (recordCompliant) {\n                compliantRecords++;\n            }\n        }\n        \n        const complianceRate = testData.length > 0 ? compliantRecords / testData.length : 0;\n        \n        result.score = complianceRate;\n        result.affected_records = testData.length - compliantRecords;\n        result.details = {\n            total_records: testData.length,\n            compliant_records: compliantRecords,\n            compliance_rate: complianceRate,\n            standard_violations: standardViolations,\n            regulatory_violations: regulatoryViolations\n        };\n        \n        if (complianceRate < rule.thresholds.acceptable) {\n            result.issue_type = 'compliance_violation';\n            result.description = `åˆè§„æ€§ä¸è¶³: ${(complianceRate * 100).toFixed(2)}%`;\n        }\n        \n        return result;\n    }\n    \n    /**\n     * æ‰§è¡Œå¼‚å¸¸æ£€æµ‹\n     */\n    async performAnomalyDetection() {\n        logger.info('ğŸ” å¼€å§‹å¼‚å¸¸æ£€æµ‹...');\n        \n        const detectionResults = {\n            timestamp: new Date().toISOString(),\n            total_detectors: this.anomalyDetectors.size,\n            anomalies_found: [],\n            detection_summary: {}\n        };\n        \n        for (const [detectorId, detector] of this.anomalyDetectors) {\n            if (detector.status !== 'active') {continue;}\n            \n            try {\n                const anomalies = await this.runAnomalyDetector(detector);\n                \n                detectionResults.anomalies_found.push(...anomalies);\n                detectionResults.detection_summary[detectorId] = {\n                    detector_name: detector.name,\n                    anomalies_count: anomalies.length,\n                    execution_time: new Date().toISOString()\n                };\n                \n                detector.detection_count += anomalies.length;\n                if (anomalies.length > 0) {\n                    detector.last_detection = new Date().toISOString();\n                }\n                \n            } catch (error) {\n                logger.error(`å¼‚å¸¸æ£€æµ‹å™¨æ‰§è¡Œå¤±è´¥ ${detectorId}:`, error);\n                detectionResults.detection_summary[detectorId] = {\n                    detector_name: detector.name,\n                    error: error.message,\n                    execution_time: new Date().toISOString()\n                };\n            }\n        }\n        \n        logger.info(`âœ… å¼‚å¸¸æ£€æµ‹å®Œæˆï¼Œå‘ç° ${detectionResults.anomalies_found.length} ä¸ªå¼‚å¸¸`);\n        this.emit('anomaly:detection_completed', detectionResults);\n        \n        return detectionResults;\n    }\n    \n    /**\n     * è¿è¡Œå¼‚å¸¸æ£€æµ‹å™¨\n     */\n    async runAnomalyDetector(detector) {\n        const anomalies = [];\n        \n        // è·å–æ£€æµ‹æ•°æ®\n        const detectionData = await this.getDetectionData(detector);\n        \n        switch (detector.algorithm) {\n            case 'z_score':\n                anomalies.push(...this.detectZScoreAnomalies(detectionData, detector.parameters));\n                break;\n            case 'moving_average_deviation':\n                anomalies.push(...this.detectTrendAnomalies(detectionData, detector.parameters));\n                break;\n            case 'isolation_forest':\n                anomalies.push(...this.detectPatternAnomalies(detectionData, detector.parameters));\n                break;\n            case 'rule_engine':\n                anomalies.push(...this.detectRuleViolations(detectionData, detector.parameters));\n                break;\n        }\n        \n        return anomalies.map(anomaly => ({\n            ...anomaly,\n            detector_id: detector.id,\n            detector_name: detector.name,\n            detected_at: new Date().toISOString()\n        }));\n    }\n    \n    /**\n     * æ£€æŸ¥é¢„è­¦æ¡ä»¶\n     */\n    async checkAlertConditions() {\n        for (const [alertId, alertConfig] of this.alertConfigs) {\n            if (alertConfig.status !== 'active') {continue;}\n            \n            try {\n                const shouldTrigger = await this.evaluateAlertConditions(alertConfig);\n                \n                if (shouldTrigger) {\n                    await this.triggerAlert(alertConfig);\n                }\n                \n            } catch (error) {\n                logger.error(`é¢„è­¦æ¡ä»¶æ£€æŸ¥å¤±è´¥ ${alertId}:`, error);\n            }\n        }\n    }\n    \n    /**\n     * æ›´æ–°è´¨é‡æŒ‡æ ‡\n     */\n    async updateQualityMetrics(checkResults) {\n        const timestamp = new Date().toISOString();\n        \n        // æ›´æ–°æ•´ä½“è´¨é‡è¯„åˆ†\n        const overallScore = this.calculateOverallQualityScore(checkResults.quality_scores);\n        this.updateMetric('overall_quality_score', overallScore, timestamp);\n        \n        // æ›´æ–°åˆ†ç±»è´¨é‡è¯„åˆ†\n        for (const [category, scoreData] of Object.entries(checkResults.quality_scores)) {\n            const metricId = `${category}_data_quality`;\n            if (this.qualityMetrics.has(metricId)) {\n                this.updateMetric(metricId, scoreData.final_score, timestamp);\n            }\n        }\n        \n        // æ›´æ–°å¼‚å¸¸æ£€æµ‹ç‡\n        const anomalyRate = this.calculateAnomalyDetectionRate();\n        this.updateMetric('anomaly_detection_rate', anomalyRate, timestamp);\n        \n        // æ›´æ–°æ•°æ®æ—¶æ•ˆæ€§è¯„åˆ†\n        const freshnessScore = this.calculateDataFreshnessScore();\n        this.updateMetric('data_freshness_score', freshnessScore, timestamp);\n    }\n    \n    /**\n     * æ›´æ–°å•ä¸ªæŒ‡æ ‡\n     */\n    updateMetric(metricId, value, timestamp) {\n        const metric = this.qualityMetrics.get(metricId);\n        if (!metric) {return;}\n        \n        const previousValue = metric.current_value;\n        metric.current_value = value;\n        metric.last_updated = timestamp;\n        \n        // è®¡ç®—è¶‹åŠ¿\n        if (previousValue !== null && previousValue !== undefined) {\n            const change = value - previousValue;\n            if (Math.abs(change) < 0.01) {\n                metric.trend = 'stable';\n            } else if (change > 0) {\n                metric.trend = 'improving';\n            } else {\n                metric.trend = 'declining';\n            }\n        }\n        \n        // ä¿å­˜å†å²è®°å½•\n        metric.history.push({\n            value,\n            timestamp\n        });\n        \n        // ä¿æŒå†å²è®°å½•åœ¨åˆç†èŒƒå›´å†…\n        if (metric.history.length > 1000) {\n            metric.history = metric.history.slice(-1000);\n        }\n    }\n    \n    // è¾…åŠ©æ–¹æ³•å®ç°\n    async getTestData(dataSource) {\n        // æ¨¡æ‹Ÿè·å–æµ‹è¯•æ•°æ®\n        const sampleData = {\n            'ems_energy_data': [\n                {\n                    meter_id: 'M001',\n                    energy_type: 'electricity',\n                    consumption_amount: 1250.5,\n                    measurement_time: new Date(Date.now() - 60000).toISOString(),\n                    quality_flag: 'good'\n                },\n                {\n                    meter_id: 'M002',\n                    energy_type: 'natural_gas',\n                    consumption_amount: 850.2,\n                    measurement_time: new Date(Date.now() - 120000).toISOString(),\n                    quality_flag: 'good'\n                }\n            ],\n            'carbon_emissions': [\n                {\n                    emission_id: 'E001',\n                    emission_scope: 'scope1',\n                    emission_source: 'natural_gas',\n                    emission_amount: 125.8,\n                    calculation_time: new Date().toISOString(),\n                    calculation_method: 'emission_factor_method',\n                    data_quality_score: 0.95\n                }\n            ],\n            'mes_production_data': [\n                {\n                    enterprise_id: 'ENT001',\n                    product_code: 'PROD001',\n                    production_volume: 1000,\n                    production_date: new Date().toISOString().split('T')[0]\n                }\n            ],\n            'national_indicators': [\n                {\n                    indicator_id: 'IND001',\n                    indicator_type: 'carbon_intensity',\n                    indicator_value: 0.85,\n                    target_value: 0.90,\n                    calculation_date: new Date().toISOString().split('T')[0],\n                    compliance_status: 'compliant'\n                }\n            ]\n        };\n        \n        return sampleData[dataSource] || [];\n    }\n    \n    evaluateBusinessRule(rule, record) {\n        // ç®€åŒ–çš„ä¸šåŠ¡è§„åˆ™è¯„ä¼°\n        try {\n            if (rule.includes('consumption_amount > 0')) {\n                return record.consumption_amount > 0;\n            }\n            if (rule.includes('measurement_time <= current_time')) {\n                const measurementTime = new Date(record.measurement_time).getTime();\n                const currentTime = Date.now();\n                return measurementTime <= currentTime + 300000; // 5åˆ†é’Ÿå®¹é”™\n            }\n            return true;\n        } catch (error) {\n            return false;\n        }\n    }\n    \n    async detectOutliers(data, config) {\n        // ç®€åŒ–çš„å¼‚å¸¸å€¼æ£€æµ‹\n        if (data.length < config.min_samples) {return 0;}\n        \n        const values = data.map(d => d.consumption_amount || d.emission_amount || d.production_volume || 0);\n        const mean = values.reduce((a, b) => a + b, 0) / values.length;\n        const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;\n        const stdDev = Math.sqrt(variance);\n        \n        let outliers = 0;\n        for (const value of values) {\n            const zScore = Math.abs((value - mean) / stdDev);\n            if (zScore > config.threshold) {\n                outliers++;\n            }\n        }\n        \n        return outliers;\n    }\n    \n    evaluateConsistencyRule(rule, _record) {\n        // ç®€åŒ–çš„ä¸€è‡´æ€§è§„åˆ™è¯„ä¼°\n        try {\n            if (rule.includes('sum(sub_meters) == total_meter')) {\n                // æ¨¡æ‹Ÿå­è¡¨æ±‚å’Œæ£€æŸ¥\n                return true;\n            }\n            if (rule.includes('energy_type matches meter_type')) {\n                // æ¨¡æ‹Ÿèƒ½æºç±»å‹åŒ¹é…æ£€æŸ¥\n                return true;\n            }\n            return true;\n        } catch (error) {\n            return false;\n        }\n    }\n    \n    async checkTemporalConsistency(data, config) {\n        // ç®€åŒ–çš„æ—¶é—´ä¸€è‡´æ€§æ£€æŸ¥\n        let inconsistencies = 0;\n        \n        for (let i = 1; i < data.length; i++) {\n            const current = data[i].consumption_amount || data[i].emission_amount || 0;\n            const previous = data[i-1].consumption_amount || data[i-1].emission_amount || 0;\n            \n            if (previous > 0) {\n                const variance = Math.abs(current - previous) / previous;\n                if (variance > config.variance_threshold) {\n                    inconsistencies++;\n                }\n            }\n        }\n        \n        return inconsistencies;\n    }\n    \n    isValidCalculationMethod(method) {\n        const validMethods = [\n            'emission_factor_method',\n            'mass_balance_method',\n            'continuous_monitoring_method'\n        ];\n        return validMethods.includes(method);\n    }\n    \n    evaluateRegulatoryRequirement(requirement, record) {\n        // ç®€åŒ–çš„ç›‘ç®¡è¦æ±‚è¯„ä¼°\n        try {\n            if (requirement.includes('calculation_follows_national_standard')) {\n                return record.calculation_method === 'emission_factor_method';\n            }\n            if (requirement.includes('audit_trail_complete')) {\n                return record.calculation_method && record.data_source;\n            }\n            return true;\n        } catch (error) {\n            return false;\n        }\n    }\n}\n\nexport default RealTimeDataQualityService;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/ReportGenerator.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'CARBON_CONSTANTS' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":26},{"ruleId":"curly","severity":2,"message":"Expected { after 'if' condition.","line":181,"column":44,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":181,"endColumn":51,"fix":{"range":[4729,4736],"text":"{return;}"}},{"ruleId":"no-unused-vars","severity":2,"message":"'options' is defined but never used. Allowed unused args must match /^_/u.","line":327,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":327,"endColumn":51},{"ruleId":"object-shorthand","severity":2,"message":"Expected property shorthand.","line":499,"column":7,"nodeType":"Property","messageId":"expectedPropertyShorthand","endLine":499,"endColumn":23,"fix":{"range":[13668,13684],"text":"content"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000000.","line":501,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":501,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500000.","line":501,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":501,"endColumn":57},{"ruleId":"no-unused-vars","severity":2,"message":"'options' is defined but never used. Allowed unused args must match /^_/u.","line":602,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":602,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":627,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":627,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":627,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":627,"endColumn":71},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":640,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":640,"endColumn":53},{"ruleId":"curly","severity":2,"message":"Expected { after 'if' condition.","line":670,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":670,"endColumn":43,"fix":{"range":[18216,18225],"text":"{return 0;}"}},{"ruleId":"no-unused-vars","severity":2,"message":"'carbonData' is defined but never used. Allowed unused args must match /^_/u.","line":676,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":676,"endColumn":45},{"ruleId":"curly","severity":2,"message":"Expected { after 'if' condition.","line":701,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":701,"endColumn":32,"fix":{"range":[19199,19209],"text":"{return [];}"}},{"ruleId":"curly","severity":2,"message":"Expected { after 'if' condition.","line":713,"column":60,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":713,"endColumn":69,"fix":{"range":[19814,19823],"text":"{return 0;}"}},{"ruleId":"no-unused-vars","severity":2,"message":"'parkId' is defined but never used. Allowed unused args must match /^_/u.","line":741,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":741,"endColumn":38},{"ruleId":"no-unused-vars","severity":2,"message":"'timeRange' is defined but never used. Allowed unused args must match /^_/u.","line":741,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":741,"endColumn":49},{"ruleId":"no-unused-vars","severity":2,"message":"'parkId' is defined but never used. Allowed unused args must match /^_/u.","line":750,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":750,"endColumn":37},{"ruleId":"no-unused-vars","severity":2,"message":"'timeRange' is defined but never used. Allowed unused args must match /^_/u.","line":750,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":750,"endColumn":48}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":5,"fixableWarningCount":0,"source":"/**\n * æ™ºèƒ½ç”³æŠ¥éªŒæ”¶ææ–™ç”Ÿæˆå™¨\n * è‡ªåŠ¨ç”Ÿæˆç¬¦åˆå›½å®¶æ ‡å‡†çš„é›¶ç¢³å›­åŒºç”³æŠ¥éªŒæ”¶ææ–™\n * æ”¯æŒå¤šç§æ ¼å¼è¾“å‡ºå’Œæ¨¡æ¿å®šåˆ¶\n */\n\nimport { EventEmitter } from 'events';\nimport logger from '../../shared/utils/logger.js';\nimport { CARBON_CONSTANTS, MATH_CONSTANTS } from '../../shared/constants/MathConstants.js';\nimport NationalIndicatorDashboard from './NationalIndicatorDashboard.js';\nimport CarbonAccountingEngine from './CarbonAccountingEngine.js';\nimport EnergyFlowVisualization from './EnergyFlowVisualization.js';\n\nclass ReportGenerator extends EventEmitter {\n  constructor() {\n    super();\n    this.indicatorDashboard = new NationalIndicatorDashboard();\n    this.carbonEngine = new CarbonAccountingEngine();\n    this.energyFlowViz = new EnergyFlowVisualization();\n    this.reportTemplates = new Map();\n    this.generationQueue = [];\n    this.isProcessing = false;\n    \n    // æŠ¥å‘Šæ¨¡æ¿é…ç½®\n    this.templateConfig = {\n      // ç”³æŠ¥ææ–™æ¨¡æ¿\n      application: {\n        name: 'é›¶ç¢³å›­åŒºç”³æŠ¥ææ–™',\n        sections: [\n          'basic_info',\n          'energy_system',\n          'carbon_accounting',\n          'indicator_analysis',\n          'technology_innovation',\n          'management_system',\n          'supporting_documents'\n        ],\n        format: ['pdf', 'docx', 'html']\n      },\n      \n      // éªŒæ”¶ææ–™æ¨¡æ¿\n      acceptance: {\n        name: 'é›¶ç¢³å›­åŒºéªŒæ”¶ææ–™',\n        sections: [\n          'implementation_summary',\n          'indicator_achievement',\n          'carbon_neutrality_proof',\n          'energy_flow_analysis',\n          'performance_evaluation',\n          'continuous_improvement',\n          'certification_evidence'\n        ],\n        format: ['pdf', 'docx', 'html']\n      },\n      \n      // ç›‘æµ‹æŠ¥å‘Šæ¨¡æ¿\n      monitoring: {\n        name: 'é›¶ç¢³å›­åŒºç›‘æµ‹æŠ¥å‘Š',\n        sections: [\n          'monitoring_overview',\n          'real_time_indicators',\n          'trend_analysis',\n          'alert_summary',\n          'recommendations',\n          'data_quality_report'\n        ],\n        format: ['pdf', 'html', 'excel']\n      }\n    };\n    \n    this.init();\n  }\n\n  async init() {\n    try {\n      await this.loadReportTemplates();\n      this.startProcessingQueue();\n      logger.info('æ™ºèƒ½ç”³æŠ¥éªŒæ”¶ææ–™ç”Ÿæˆå™¨åˆå§‹åŒ–å®Œæˆ');\n      this.emit('generator_initialized');\n    } catch (error) {\n      logger.error('ç”³æŠ¥éªŒæ”¶ææ–™ç”Ÿæˆå™¨åˆå§‹åŒ–å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * åŠ è½½æŠ¥å‘Šæ¨¡æ¿\n   */\n  async loadReportTemplates() {\n    try {\n      // åŠ è½½ç”³æŠ¥ææ–™æ¨¡æ¿\n      this.reportTemplates.set('application', {\n        ...this.templateConfig.application,\n        template_content: await this.getApplicationTemplate()\n      });\n      \n      // åŠ è½½éªŒæ”¶ææ–™æ¨¡æ¿\n      this.reportTemplates.set('acceptance', {\n        ...this.templateConfig.acceptance,\n        template_content: await this.getAcceptanceTemplate()\n      });\n      \n      // åŠ è½½ç›‘æµ‹æŠ¥å‘Šæ¨¡æ¿\n      this.reportTemplates.set('monitoring', {\n        ...this.templateConfig.monitoring,\n        template_content: await this.getMonitoringTemplate()\n      });\n      \n      logger.info('æŠ¥å‘Šæ¨¡æ¿åŠ è½½å®Œæˆ');\n    } catch (error) {\n      logger.error('åŠ è½½æŠ¥å‘Šæ¨¡æ¿å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç”Ÿæˆç”³æŠ¥éªŒæ”¶ææ–™\n   * @param {string} parkId - å›­åŒºID\n   * @param {string} reportType - æŠ¥å‘Šç±»å‹ (application/acceptance/monitoring)\n   * @param {Object} options - ç”Ÿæˆé€‰é¡¹\n   * @returns {Promise<Object>} ç”Ÿæˆç»“æœ\n   */\n  async generateReport(parkId, reportType, options = {}) {\n    try {\n      const reportId = this.generateReportId();\n      \n      // æ·»åŠ åˆ°ç”Ÿæˆé˜Ÿåˆ—\n      const reportTask = {\n        id: reportId,\n        park_id: parkId,\n        type: reportType,\n        options: {\n          format: options.format || 'pdf',\n          language: options.language || 'zh-CN',\n          include_charts: options.include_charts !== false,\n          include_raw_data: options.include_raw_data || false,\n          time_range: options.time_range || '1y',\n          ...options\n        },\n        status: 'queued',\n        created_at: new Date().toISOString()\n      };\n      \n      this.generationQueue.push(reportTask);\n      \n      // å‘é€ä»»åŠ¡åˆ›å»ºäº‹ä»¶\n      this.emit('report_task_created', {\n        report_id: reportId,\n        park_id: parkId,\n        type: reportType\n      });\n      \n      logger.info(`æŠ¥å‘Šç”Ÿæˆä»»åŠ¡å·²åˆ›å»º: ${reportId}`);\n      \n      return {\n        report_id: reportId,\n        status: 'queued',\n        estimated_completion: this.estimateCompletionTime(reportType)\n      };\n    } catch (error) {\n      logger.error('åˆ›å»ºæŠ¥å‘Šç”Ÿæˆä»»åŠ¡å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * å¤„ç†ç”Ÿæˆé˜Ÿåˆ—\n   */\n  startProcessingQueue() {\n    setInterval(async () => {\n      if (!this.isProcessing && this.generationQueue.length > 0) {\n        await this.processNextReport();\n      }\n    }, MATH_CONSTANTS.FIVE * MATH_CONSTANTS.MILLISECONDS_PER_SECOND);\n  }\n\n  /**\n   * å¤„ç†ä¸‹ä¸€ä¸ªæŠ¥å‘Š\n   */\n  async processNextReport() {\n    if (this.generationQueue.length === 0) return;\n    \n    this.isProcessing = true;\n    const task = this.generationQueue.shift();\n    \n    try {\n      task.status = 'processing';\n      task.started_at = new Date().toISOString();\n      \n      this.emit('report_generation_started', {\n        report_id: task.id,\n        park_id: task.park_id\n      });\n      \n      // æ”¶é›†æ•°æ®\n      const reportData = await this.collectReportData(task.park_id, task.type, task.options);\n      \n      // ç”ŸæˆæŠ¥å‘Šå†…å®¹\n      const reportContent = await this.generateReportContent(task.type, reportData, task.options);\n      \n      // æ ¼å¼åŒ–è¾“å‡º\n      const formattedReport = await this.formatReport(reportContent, task.options.format);\n      \n      // ä¿å­˜æŠ¥å‘Š\n      const savedReport = await this.saveReport(task.id, formattedReport, task.options);\n      \n      task.status = 'completed';\n      task.completed_at = new Date().toISOString();\n      task.result = savedReport;\n      \n      this.emit('report_generation_completed', {\n        report_id: task.id,\n        park_id: task.park_id,\n        result: savedReport\n      });\n      \n      logger.info(`æŠ¥å‘Šç”Ÿæˆå®Œæˆ: ${task.id}`);\n      \n    } catch (error) {\n      task.status = 'failed';\n      task.error = error.message;\n      task.failed_at = new Date().toISOString();\n      \n      this.emit('report_generation_failed', {\n        report_id: task.id,\n        park_id: task.park_id,\n        error: error.message\n      });\n      \n      logger.error(`æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ${task.id}`, error);\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  /**\n   * æ”¶é›†æŠ¥å‘Šæ•°æ®\n   */\n  async collectReportData(parkId, reportType, options) {\n    try {\n      const timeRange = options.time_range || '1y';\n      \n      // åŸºç¡€æ•°æ®\n      const baseData = {\n        park_info: await this.getParkBasicInfo(parkId),\n        generation_time: new Date().toISOString(),\n        time_range: timeRange,\n        report_type: reportType\n      };\n      \n      // å›½å®¶æŒ‡æ ‡æ•°æ®\n      const indicators = this.indicatorDashboard.getParkIndicators(parkId);\n      if (indicators) {\n        baseData.national_indicators = indicators;\n      }\n      \n      // ç¢³æ’æ”¾æ•°æ®\n      const carbonData = await this.carbonEngine.calculateParkTotalEmissions(parkId, timeRange);\n      baseData.carbon_accounting = carbonData;\n      \n      // èƒ½æºæµå‘æ•°æ®\n      if (options.include_energy_flow !== false) {\n        const energyFlowData = await this.energyFlowViz.generateEnergyFlowMap(parkId, timeRange);\n        baseData.energy_flow = energyFlowData;\n      }\n      \n      // æ ¹æ®æŠ¥å‘Šç±»å‹æ”¶é›†ç‰¹å®šæ•°æ®\n      switch (reportType) {\n        case 'application':\n          baseData.application_specific = await this.collectApplicationData(parkId, timeRange);\n          break;\n        case 'acceptance':\n          baseData.acceptance_specific = await this.collectAcceptanceData(parkId, timeRange);\n          break;\n        case 'monitoring':\n          baseData.monitoring_specific = await this.collectMonitoringData(parkId, timeRange);\n          break;\n      }\n      \n      return baseData;\n    } catch (error) {\n      logger.error('æ”¶é›†æŠ¥å‘Šæ•°æ®å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç”ŸæˆæŠ¥å‘Šå†…å®¹\n   */\n  async generateReportContent(reportType, data, options) {\n    try {\n      const template = this.reportTemplates.get(reportType);\n      if (!template) {\n        throw new Error(`æœªæ‰¾åˆ°æŠ¥å‘Šæ¨¡æ¿: ${reportType}`);\n      }\n      \n      const content = {\n        title: template.name,\n        subtitle: `${data.park_info.name} - ${new Date().getFullYear()}å¹´åº¦`,\n        generation_date: new Date().toLocaleDateString('zh-CN'),\n        sections: []\n      };\n      \n      // ç”Ÿæˆå„ä¸ªç« èŠ‚\n      for (const sectionName of template.sections) {\n        const section = await this.generateSection(sectionName, data, options);\n        if (section) {\n          content.sections.push(section);\n        }\n      }\n      \n      // æ·»åŠ é™„å½•\n      if (options.include_raw_data) {\n        content.sections.push(await this.generateDataAppendix(data));\n      }\n      \n      return content;\n    } catch (error) {\n      logger.error('ç”ŸæˆæŠ¥å‘Šå†…å®¹å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç”ŸæˆæŠ¥å‘Šç« èŠ‚\n   */\n  async generateSection(sectionName, data, options) {\n    try {\n      switch (sectionName) {\n        case 'basic_info':\n          return this.generateBasicInfoSection(data);\n        case 'energy_system':\n          return this.generateEnergySystemSection(data);\n        case 'carbon_accounting':\n          return this.generateCarbonAccountingSection(data);\n        case 'indicator_analysis':\n          return this.generateIndicatorAnalysisSection(data);\n        case 'implementation_summary':\n          return this.generateImplementationSummarySection(data);\n        case 'indicator_achievement':\n          return this.generateIndicatorAchievementSection(data);\n        case 'monitoring_overview':\n          return this.generateMonitoringOverviewSection(data);\n        case 'real_time_indicators':\n          return this.generateRealTimeIndicatorsSection(data);\n        default:\n          logger.warn(`æœªçŸ¥ç« èŠ‚ç±»å‹: ${sectionName}`);\n          return null;\n      }\n    } catch (error) {\n      logger.error(`ç”Ÿæˆç« èŠ‚ ${sectionName} å¤±è´¥:`, error);\n      return {\n        title: sectionName,\n        content: `ç”Ÿæˆç« èŠ‚æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`,\n        error: true\n      };\n    }\n  }\n\n  /**\n   * ç”ŸæˆåŸºæœ¬ä¿¡æ¯ç« èŠ‚\n   */\n  generateBasicInfoSection(data) {\n    return {\n      title: '1. å›­åŒºåŸºæœ¬ä¿¡æ¯',\n      content: {\n        park_name: data.park_info.name,\n        location: data.park_info.location,\n        area: data.park_info.area,\n        establishment_date: data.park_info.establishment_date,\n        main_industries: data.park_info.main_industries,\n        enterprise_count: data.park_info.enterprise_count,\n        employee_count: data.park_info.employee_count,\n        annual_output_value: data.park_info.annual_output_value\n      },\n      charts: []\n    };\n  }\n\n  /**\n   * ç”Ÿæˆèƒ½æºç³»ç»Ÿç« èŠ‚\n   */\n  generateEnergySystemSection(data) {\n    const energyFlow = data.energy_flow;\n    return {\n      title: '2. èƒ½æºç³»ç»Ÿåˆ†æ',\n      content: {\n        energy_infrastructure: energyFlow?.infrastructure,\n        energy_statistics: energyFlow?.statistics,\n        energy_efficiency: this.calculateEnergyEfficiency(energyFlow),\n        renewable_energy_ratio: energyFlow?.statistics?.renewable_ratio\n      },\n      charts: [\n        {\n          type: 'sankey',\n          title: 'å›­åŒºèƒ½æºæµå‘å›¾',\n          data: energyFlow?.sankey_data\n        },\n        {\n          type: 'pie',\n          title: 'èƒ½æºæ¶ˆè´¹ç»“æ„',\n          data: energyFlow?.statistics?.breakdown?.by_source\n        }\n      ]\n    };\n  }\n\n  /**\n   * ç”Ÿæˆç¢³æ ¸ç®—ç« èŠ‚\n   */\n  generateCarbonAccountingSection(data) {\n    const carbonData = data.carbon_accounting;\n    return {\n      title: '3. ç¢³æ’æ”¾æ ¸ç®—',\n      content: {\n        total_emissions: carbonData.total_emissions,\n        scope1_emissions: carbonData.scope1_emissions,\n        scope2_emissions: carbonData.scope2_emissions,\n        emission_sources: carbonData.emission_sources,\n        carbon_intensity: data.national_indicators?.carbon_intensity,\n        carbon_reduction_measures: this.generateCarbonReductionMeasures(carbonData)\n      },\n      charts: [\n        {\n          type: 'bar',\n          title: 'ç¢³æ’æ”¾æºåˆ†æ',\n          data: carbonData.emission_sources\n        },\n        {\n          type: 'line',\n          title: 'ç¢³æ’æ”¾è¶‹åŠ¿',\n          data: carbonData.historical_data\n        }\n      ]\n    };\n  }\n\n  /**\n   * ç”ŸæˆæŒ‡æ ‡åˆ†æç« èŠ‚\n   */\n  generateIndicatorAnalysisSection(data) {\n    const indicators = data.national_indicators;\n    return {\n      title: '4. å›½å®¶æŒ‡æ ‡ä½“ç³»åˆ†æ',\n      content: {\n        compliance_status: indicators?.compliance_status,\n        core_indicators: {\n          carbon_intensity: indicators?.carbon_intensity,\n          clean_energy_ratio: indicators?.clean_energy_ratio\n        },\n        guidance_indicators: {\n          solid_waste_utilization: indicators?.solid_waste_utilization,\n          waste_energy_utilization: indicators?.waste_energy_utilization,\n          water_reuse_ratio: indicators?.water_reuse_ratio\n        },\n        data_quality: indicators?.data_quality_score,\n        improvement_recommendations: this.generateImprovementRecommendations(indicators)\n      },\n      charts: [\n        {\n          type: 'radar',\n          title: 'æŒ‡æ ‡è¾¾æˆæƒ…å†µ',\n          data: this.formatIndicatorsForRadarChart(indicators)\n        }\n      ]\n    };\n  }\n\n  /**\n   * æ ¼å¼åŒ–æŠ¥å‘Š\n   */\n  async formatReport(content, format) {\n    try {\n      switch (format.toLowerCase()) {\n        case 'pdf':\n          return await this.generatePDF(content);\n        case 'docx':\n          return await this.generateDOCX(content);\n        case 'html':\n          return await this.generateHTML(content);\n        case 'excel':\n          return await this.generateExcel(content);\n        default:\n          throw new Error(`ä¸æ”¯æŒçš„æ ¼å¼: ${format}`);\n      }\n    } catch (error) {\n      logger.error('æ ¼å¼åŒ–æŠ¥å‘Šå¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç”ŸæˆPDFæ ¼å¼\n   */\n  async generatePDF(content) {\n    // TODO: å®ç°PDFç”Ÿæˆé€»è¾‘\n    return {\n      format: 'pdf',\n      content: content,\n      file_path: `/reports/pdf/${this.generateReportId()}.pdf`,\n      size: Math.floor(Math.random() * 1000000) + 500000 // æ¨¡æ‹Ÿæ–‡ä»¶å¤§å°\n    };\n  }\n\n  /**\n   * ç”ŸæˆHTMLæ ¼å¼\n   */\n  async generateHTML(content) {\n    const html = this.convertToHTML(content);\n    return {\n      format: 'html',\n      content: html,\n      file_path: `/reports/html/${this.generateReportId()}.html`,\n      size: html.length\n    };\n  }\n\n  /**\n   * è½¬æ¢ä¸ºHTML\n   */\n  convertToHTML(content) {\n    let html = `\n    <!DOCTYPE html>\n    <html lang=\"zh-CN\">\n    <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <title>${content.title}</title>\n        <style>\n            body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 40px; line-height: 1.6; }\n            .header { text-align: center; margin-bottom: 40px; }\n            .section { margin-bottom: 30px; }\n            .section-title { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }\n            .content-table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n            .content-table th, .content-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }\n            .content-table th { background-color: #f2f2f2; }\n            .chart-placeholder { background-color: #f8f9fa; border: 1px dashed #dee2e6; padding: 40px; text-align: center; margin: 20px 0; }\n        </style>\n    </head>\n    <body>\n        <div class=\"header\">\n            <h1>${content.title}</h1>\n            <h2>${content.subtitle}</h2>\n            <p>ç”Ÿæˆæ—¥æœŸ: ${content.generation_date}</p>\n        </div>\n    `;\n    \n    content.sections.forEach(section => {\n      html += `\n        <div class=\"section\">\n            <h2 class=\"section-title\">${section.title}</h2>\n            ${this.formatSectionContent(section.content)}\n            ${this.formatCharts(section.charts || [])}\n        </div>\n      `;\n    });\n    \n    html += `\n    </body>\n    </html>\n    `;\n    \n    return html;\n  }\n\n  /**\n   * æ ¼å¼åŒ–ç« èŠ‚å†…å®¹\n   */\n  formatSectionContent(content) {\n    if (typeof content === 'string') {\n      return `<p>${content}</p>`;\n    }\n    \n    if (typeof content === 'object') {\n      let html = '<table class=\"content-table\">';\n      for (const [key, value] of Object.entries(content)) {\n        html += `<tr><td><strong>${this.formatFieldName(key)}</strong></td><td>${this.formatFieldValue(value)}</td></tr>`;\n      }\n      html += '</table>';\n      return html;\n    }\n    \n    return '<p>æ— å†…å®¹</p>';\n  }\n\n  /**\n   * æ ¼å¼åŒ–å›¾è¡¨\n   */\n  formatCharts(charts) {\n    return charts.map(chart => \n      `<div class=\"chart-placeholder\">\n        <h3>${chart.title}</h3>\n        <p>å›¾è¡¨ç±»å‹: ${chart.type}</p>\n        <p>æ­¤å¤„åº”æ˜¾ç¤º ${chart.title} å›¾è¡¨</p>\n      </div>`\n    ).join('');\n  }\n\n  /**\n   * ä¿å­˜æŠ¥å‘Š\n   */\n  async saveReport(reportId, formattedReport, options) {\n    try {\n      // TODO: å®ç°å®é™…çš„æ–‡ä»¶ä¿å­˜é€»è¾‘\n      const savedReport = {\n        report_id: reportId,\n        file_path: formattedReport.file_path,\n        format: formattedReport.format,\n        size: formattedReport.size,\n        created_at: new Date().toISOString(),\n        download_url: `/api/reports/download/${reportId}`,\n        preview_url: formattedReport.format === 'html' ? `/api/reports/preview/${reportId}` : null\n      };\n      \n      logger.info(`æŠ¥å‘Šå·²ä¿å­˜: ${reportId}`);\n      return savedReport;\n    } catch (error) {\n      logger.error('ä¿å­˜æŠ¥å‘Šå¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç”ŸæˆæŠ¥å‘ŠID\n   */\n  generateReportId() {\n    return `RPT_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * ä¼°ç®—å®Œæˆæ—¶é—´\n   */\n  estimateCompletionTime(reportType) {\n    const estimateMinutes = {\n      application: 10,\n      acceptance: 8,\n      monitoring: 5\n    };\n    \n    const minutes = estimateMinutes[reportType] || 5;\n    const completionTime = new Date();\n    completionTime.setMinutes(completionTime.getMinutes() + minutes);\n    \n    return completionTime.toISOString();\n  }\n\n  // è¾…åŠ©æ–¹æ³•\n  formatFieldName(key) {\n    const nameMap = {\n      park_name: 'å›­åŒºåç§°',\n      location: 'åœ°ç†ä½ç½®',\n      area: 'å åœ°é¢ç§¯',\n      establishment_date: 'æˆç«‹æ—¥æœŸ',\n      main_industries: 'ä¸»è¦äº§ä¸š',\n      enterprise_count: 'ä¼ä¸šæ•°é‡',\n      employee_count: 'å‘˜å·¥æ•°é‡',\n      annual_output_value: 'å¹´äº§å€¼'\n    };\n    return nameMap[key] || key;\n  }\n\n  formatFieldValue(value) {\n    if (typeof value === 'object' && value !== null) {\n      return JSON.stringify(value, null, 2);\n    }\n    return String(value);\n  }\n\n  calculateEnergyEfficiency(energyFlow) {\n    if (!energyFlow?.statistics) return 0;\n    const stats = energyFlow.statistics;\n    return stats.total_generation > 0 ? \n      (stats.total_consumption / stats.total_generation * MATH_CONSTANTS.ONE_HUNDRED).toFixed(MATH_CONSTANTS.DECIMAL_PLACES) : 0;\n  }\n\n  generateCarbonReductionMeasures(carbonData) {\n    return [\n      'æ¨å¹¿å¯å†ç”Ÿèƒ½æºåˆ©ç”¨',\n      'æå‡èƒ½æºåˆ©ç”¨æ•ˆç‡',\n      'ä¼˜åŒ–å·¥ä¸šè¿‡ç¨‹',\n      'åŠ å¼ºç¢³æ±‡å»ºè®¾',\n      'å®æ–½å¾ªç¯ç»æµæ¨¡å¼'\n    ];\n  }\n\n  generateImprovementRecommendations(indicators) {\n    const recommendations = [];\n    \n    if (indicators?.carbon_intensity?.status === 'warning' || indicators?.carbon_intensity?.status === 'critical') {\n      recommendations.push('å»ºè®®åŠ å¼ºèƒ½æºç»“æ„ä¼˜åŒ–ï¼Œæé«˜æ¸…æ´èƒ½æºæ¯”ä¾‹');\n    }\n    \n    if (indicators?.clean_energy_ratio?.status === 'warning' || indicators?.clean_energy_ratio?.status === 'critical') {\n      recommendations.push('å»ºè®®å¢åŠ å¯å†ç”Ÿèƒ½æºè£…æœºå®¹é‡');\n    }\n    \n    return recommendations.length > 0 ? recommendations : ['å½“å‰å„é¡¹æŒ‡æ ‡è¡¨ç°è‰¯å¥½ï¼Œå»ºè®®ç»§ç»­ä¿æŒ'];\n  }\n\n  formatIndicatorsForRadarChart(indicators) {\n    if (!indicators) return [];\n    \n    return [\n      { indicator: 'å•ä½èƒ½è€—ç¢³æ’æ”¾', value: this.getIndicatorScore(indicators.carbon_intensity) },\n      { indicator: 'æ¸…æ´èƒ½æºæ¶ˆè´¹å æ¯”', value: this.getIndicatorScore(indicators.clean_energy_ratio) },\n      { indicator: 'å·¥ä¸šå›ºåºŸç»¼åˆåˆ©ç”¨ç‡', value: this.getIndicatorScore(indicators.solid_waste_utilization) },\n      { indicator: 'ä½™èƒ½ç»¼åˆåˆ©ç”¨ç‡', value: this.getIndicatorScore(indicators.waste_energy_utilization) },\n      { indicator: 'å·¥ä¸šç”¨æ°´é‡å¤åˆ©ç”¨ç‡', value: this.getIndicatorScore(indicators.water_reuse_ratio) }\n    ];\n  }\n\n  getIndicatorScore(indicator) {\n    if (!indicator || typeof indicator.value !== 'number') return 0;\n    \n    const statusScores = {\n      excellent: 100,\n      good: 80,\n      warning: 60,\n      critical: 40,\n      error: 0\n    };\n    \n    return statusScores[indicator.status] || 0;\n  }\n\n  // æ¨¡æ‹Ÿæ•°æ®è·å–æ–¹æ³•\n  async getParkBasicInfo(parkId) {\n    return {\n      id: parkId,\n      name: 'ç¤ºä¾‹é›¶ç¢³å›­åŒº',\n      location: 'æŸçœæŸå¸‚æŸåŒº',\n      area: '10.5å¹³æ–¹å…¬é‡Œ',\n      establishment_date: '2020-01-01',\n      main_industries: ['æ–°èƒ½æº', 'ç”µå­ä¿¡æ¯', 'ç”Ÿç‰©åŒ»è¯'],\n      enterprise_count: 156,\n      employee_count: 12500,\n      annual_output_value: '280äº¿å…ƒ'\n    };\n  }\n\n  async collectApplicationData(parkId, timeRange) {\n    return {\n      application_date: new Date().toISOString(),\n      application_type: 'å›½å®¶çº§é›¶ç¢³å›­åŒº',\n      supporting_policies: ['ç¢³è¾¾å³°ç¢³ä¸­å’Œæ”¿ç­–', 'å¯å†ç”Ÿèƒ½æºæ”¿ç­–'],\n      investment_summary: 'æ€»æŠ•èµ„50äº¿å…ƒï¼Œå…¶ä¸­ç»¿è‰²æŠ•èµ„å æ¯”80%'\n    };\n  }\n\n  async collectAcceptanceData(parkId, timeRange) {\n    return {\n      acceptance_date: new Date().toISOString(),\n      implementation_period: '2020-2024',\n      key_achievements: ['ç¢³æ’æ”¾å¼ºåº¦ä¸‹é™40%', 'æ¸…æ´èƒ½æºå æ¯”è¾¾åˆ°85%'],\n      certification_status: 'ç¬¦åˆéªŒæ”¶æ ‡å‡†'\n    };\n  }\n\n  async collectMonitoringData(parkId, timeRange) {\n    return {\n      monitoring_period: timeRange,\n      monitoring_frequency: 'å®æ—¶ç›‘æµ‹',\n      data_sources: ['æ™ºèƒ½ç”µè¡¨', 'ç¯å¢ƒç›‘æµ‹ç«™', 'ä¼ä¸šä¸ŠæŠ¥'],\n      monitoring_coverage: '100%'\n    };\n  }\n\n  // è·å–æ¨¡æ¿å†…å®¹çš„æ–¹æ³•\n  async getApplicationTemplate() {\n    return {\n      header: 'é›¶ç¢³å›­åŒºç”³æŠ¥ææ–™æ¨¡æ¿',\n      sections: this.templateConfig.application.sections\n    };\n  }\n\n  async getAcceptanceTemplate() {\n    return {\n      header: 'é›¶ç¢³å›­åŒºéªŒæ”¶ææ–™æ¨¡æ¿',\n      sections: this.templateConfig.acceptance.sections\n    };\n  }\n\n  async getMonitoringTemplate() {\n    return {\n      header: 'é›¶ç¢³å›­åŒºç›‘æµ‹æŠ¥å‘Šæ¨¡æ¿',\n      sections: this.templateConfig.monitoring.sections\n    };\n  }\n\n  /**\n   * é”€æ¯å®ä¾‹\n   */\n  dispose() {\n    this.generationQueue = [];\n    this.reportTemplates.clear();\n    this.removeAllListeners();\n  }\n}\n\nexport default ReportGenerator;","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/ResourceCirculationCenter.js","messages":[{"ruleId":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token Requirements","line":244,"column":55,"nodeType":null}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * èµ„æºå¾ªç¯åˆ©ç”¨ä¸å›ºåºŸè¿½æº¯ä¸­å¿ƒ\n * å®ç°å›ºåºŸå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€èµ„æºå¾ªç¯åˆ©ç”¨ä¼˜åŒ–å’Œè¿½æº¯ä½“ç³»\n * æ”¯æŒå›ºåºŸåˆ†ç±»ã€å¤„ç†ã€å›æ”¶ã€å†åˆ©ç”¨å…¨æµç¨‹ç®¡ç†\n */\n\nimport { EventEmitter } from 'events';\nimport logger from '../../shared/utils/logger.js';\nimport { MATH_CONSTANTS } from '../../shared/constants/MathConstants.js';\n\nclass ResourceCirculationCenter extends EventEmitter {\n  constructor() {\n    super();\n    this.isInitialized = false;\n    this.wasteCategories = new Map();\n    this.recyclingProcesses = new Map();\n    this.resourceFlows = new Map();\n    this.traceabilityRecords = new Map();\n    this.circularityMetrics = new Map();\n    this.optimizationResults = new Map();\n    \n    // å›ºåºŸåˆ†ç±»æ ‡å‡†\n    this.wasteClassification = {\n      hazardous: {\n        name: 'å±é™©åºŸç‰©',\n        code: 'HW',\n        description: 'å…·æœ‰è…èš€æ€§ã€æ¯’æ€§ã€æ˜“ç‡ƒæ€§ã€ååº”æ€§æˆ–æ„ŸæŸ“æ€§ç­‰å±é™©ç‰¹æ€§çš„åºŸç‰©',\n        subcategories: {\n          'HW01': 'åŒ»ç–—åºŸç‰©',\n          'HW02': 'åŒ»è¯åºŸç‰©',\n          'HW03': 'åºŸè¯ç‰©ã€è¯å“',\n          'HW04': 'å†œè¯åºŸç‰©',\n          'HW05': 'æœ¨æé˜²è…å‰‚åºŸç‰©',\n          'HW06': 'åºŸæœ‰æœºæº¶å‰‚ä¸å«æœ‰æœºæº¶å‰‚åºŸç‰©',\n          'HW07': 'çƒ­å¤„ç†å«æ°°åºŸç‰©',\n          'HW08': 'åºŸçŸ¿ç‰©æ²¹ä¸å«çŸ¿ç‰©æ²¹åºŸç‰©'\n        },\n        disposal_requirements: {\n          collection: 'ä¸“ç”¨å®¹å™¨æ”¶é›†',\n          storage: 'å±åºŸæš‚å­˜é—´å­˜æ”¾',\n          transport: 'å±åºŸè¿è¾“èµ„è´¨å•ä½',\n          disposal: 'æœ‰èµ„è´¨å¤„ç½®å•ä½å¤„ç†'\n        }\n      },\n      recyclable: {\n        name: 'å¯å›æ”¶ç‰©',\n        code: 'RC',\n        description: 'é€‚å®œå›æ”¶å’Œèµ„æºåŒ–åˆ©ç”¨çš„åºŸç‰©',\n        subcategories: {\n          'RC01': 'åºŸçº¸ç±»',\n          'RC02': 'åºŸå¡‘æ–™',\n          'RC03': 'åºŸé‡‘å±',\n          'RC04': 'åºŸç»ç’ƒ',\n          'RC05': 'åºŸç»‡ç‰©',\n          'RC06': 'åºŸç”µå™¨ç”µå­äº§å“',\n          'RC07': 'åºŸåŒ…è£…ç‰©'\n        },\n        recycling_potential: {\n          'RC01': { rate: 0.85, value: 800 }, // å›æ”¶ç‡å’Œä»·å€¼(å…ƒ/å¨)\n          'RC02': { rate: 0.75, value: 1200 },\n          'RC03': { rate: 0.90, value: 2500 },\n          'RC04': { rate: 0.80, value: 300 },\n          'RC05': { rate: 0.60, value: 500 },\n          'RC06': { rate: 0.70, value: 3000 },\n          'RC07': { rate: 0.85, value: 600 }\n        }\n      },\n      organic: {\n        name: 'æœ‰æœºåºŸç‰©',\n        code: 'OR',\n        description: 'å¯ç”Ÿç‰©é™è§£çš„æœ‰æœºåºŸç‰©',\n        subcategories: {\n          'OR01': 'é¤å¨åƒåœ¾',\n          'OR02': 'å›­æ—ç»¿åŒ–åƒåœ¾',\n          'OR03': 'å†œä¸šåºŸå¼ƒç‰©',\n          'OR04': 'é£Ÿå“åŠ å·¥åºŸæ–™'\n        },\n        treatment_options: {\n          composting: { efficiency: 0.8, product: 'organic_fertilizer' },\n          anaerobic_digestion: { efficiency: 0.75, product: 'biogas' },\n          feed_production: { efficiency: 0.6, product: 'animal_feed' }\n        }\n      },\n      inert: {\n        name: 'æƒ°æ€§åºŸç‰©',\n        code: 'IN',\n        description: 'å»ºç­‘åƒåœ¾ç­‰æƒ°æ€§åºŸç‰©',\n        subcategories: {\n          'IN01': 'æ··å‡åœŸåºŸæ–™',\n          'IN02': 'ç –ç“¦åºŸæ–™',\n          'IN03': 'çŸ³æåºŸæ–™',\n          'IN04': 'æ²¥é’åºŸæ–™'\n        },\n        utilization_options: {\n          aggregate_production: { efficiency: 0.9, product: 'recycled_aggregate' },\n          road_base: { efficiency: 0.85, product: 'road_material' },\n          backfill: { efficiency: 0.95, product: 'fill_material' }\n        }\n      }\n    };\n    \n    // å¾ªç¯ç»æµæŒ‡æ ‡\n    this.circularityIndicators = {\n      material_circularity: {\n        name: 'ç‰©è´¨å¾ªç¯ç‡',\n        formula: '(å›æ”¶åˆ©ç”¨é‡ + å†åˆ©ç”¨é‡) / æ€»åºŸç‰©äº§ç”Ÿé‡',\n        target: 0.8,\n        unit: '%'\n      },\n      waste_diversion_rate: {\n        name: 'åºŸç‰©è½¬åŒ–ç‡',\n        formula: '(å›æ”¶é‡ + èƒ½æºå›æ”¶é‡) / æ€»åºŸç‰©é‡',\n        target: 0.9,\n        unit: '%'\n      },\n      resource_efficiency: {\n        name: 'èµ„æºæ•ˆç‡',\n        formula: 'äº§å‡ºä»·å€¼ / èµ„æºæŠ•å…¥é‡',\n        target: 1.5,\n        unit: 'å…ƒ/kg'\n      },\n      carbon_footprint_reduction: {\n        name: 'ç¢³è¶³è¿¹å‡å°‘',\n        formula: 'åŸºå‡†æ’æ”¾ - å®é™…æ’æ”¾',\n        target: 0.3,\n        unit: 'tCO2e/tåºŸç‰©'\n      }\n    };\n    \n    // å¤„ç†æŠ€æœ¯é…ç½®\n    this.treatmentTechnologies = {\n      mechanical_recycling: {\n        name: 'æœºæ¢°å›æ”¶',\n        applicable_materials: ['plastic', 'metal', 'paper', 'glass'],\n        efficiency: 0.85,\n        energy_consumption: 0.5, // kWh/kg\n        cost: 200, // å…ƒ/å¨\n        carbon_factor: 0.1 // kgCO2e/kg\n      },\n      chemical_recycling: {\n        name: 'åŒ–å­¦å›æ”¶',\n        applicable_materials: ['plastic', 'rubber'],\n        efficiency: 0.75,\n        energy_consumption: 1.2,\n        cost: 800,\n        carbon_factor: 0.3\n      },\n      biological_treatment: {\n        name: 'ç”Ÿç‰©å¤„ç†',\n        applicable_materials: ['organic'],\n        efficiency: 0.8,\n        energy_consumption: 0.3,\n        cost: 150,\n        carbon_factor: -0.2 // è´Ÿå€¼è¡¨ç¤ºç¢³å‡æ’\n      },\n      thermal_recovery: {\n        name: 'çƒ­èƒ½å›æ”¶',\n        applicable_materials: ['mixed', 'non_recyclable'],\n        efficiency: 0.7,\n        energy_consumption: -2.0, // è´Ÿå€¼è¡¨ç¤ºèƒ½æºäº§å‡º\n        cost: 300,\n        carbon_factor: 0.4\n      }\n    };\n    \n    this.init();\n  }\n\n  async init() {\n    try {\n      await this.initializeWasteCategories();\n      await this.setupRecyclingProcesses();\n      await this.initializeTraceabilitySystem();\n      await this.startRealTimeMonitoring();\n      \n      this.isInitialized = true;\n      logger.info('èµ„æºå¾ªç¯åˆ©ç”¨ä¸å›ºåºŸè¿½æº¯ä¸­å¿ƒåˆå§‹åŒ–å®Œæˆ');\n      this.emit('initialized');\n    } catch (error) {\n      logger.error('èµ„æºå¾ªç¯ä¸­å¿ƒåˆå§‹åŒ–å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * å»ºç«‹å›ºåºŸå…¨ç”Ÿå‘½å‘¨æœŸè¿½æº¯ä½“ç³»\n   * @param {string} parkId - å›­åŒºID\n   * @param {Object} wasteItem - åºŸç‰©ä¿¡æ¯\n   * @returns {Object} è¿½æº¯è®°å½•\n   */\n  async establishWasteTraceability(parkId, wasteItem) {\n    try {\n      const traceId = this.generateTraceId(parkId, wasteItem);\n      \n      // åˆ›å»ºè¿½æº¯è®°å½•\n      const traceRecord = {\n        trace_id: traceId,\n        park_id: parkId,\n        waste_info: {\n          ...wasteItem,\n          classification: this.classifyWaste(wasteItem),\n          hazard_level: this.assessHazardLevel(wasteItem),\n          recycling_potential: this.assessRecyclingPotential(wasteItem)\n        },\n        \n        // ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ\n        lifecycle_stages: {\n          generation: {\n            timestamp: new Date().toISOString(),\n            location: wasteItem.generation_location,\n            source: wasteItem.source,\n            quantity: wasteItem.quantity,\n            composition: wasteItem.composition,\n            generator_info: wasteItem.generator\n          },\n          collection: {\n            status: 'pending',\n            scheduled_time: null,\n            collector: null,\n            collection_method: null\n          },\n          transportation: {\n            status: 'pending',\n            vehicle_info: null,\n            route: null,\n            transport_conditions: null\n          },\n          treatment: {\n            status: 'pending',\n            facility: null,\n            treatment_method: null,\n            treatment_efficiency: null\n          },\n          disposal_or_recovery: {\n            status: 'pending',\n            final_destination: null,\n            recovery_products: null,\n            disposal_method: null\n          }\n        },\n        \n        // åˆè§„æ€§æ£€æŸ¥\n        compliance: {\n          regulatory_requirements: this.getRegulatory Requirements(wasteItem),\n          permits_required: this.getRequiredPermits(wasteItem),\n          compliance_status: 'pending_verification'\n        },\n        \n        // ç¯å¢ƒå½±å“\n        environmental_impact: {\n          carbon_footprint: this.calculateCarbonFootprint(wasteItem),\n          resource_consumption: this.calculateResourceConsumption(wasteItem),\n          pollution_potential: this.assessPollutionPotential(wasteItem)\n        },\n        \n        // ç»æµä»·å€¼\n        economic_value: {\n          disposal_cost: this.calculateDisposalCost(wasteItem),\n          recovery_value: this.calculateRecoveryValue(wasteItem),\n          net_value: 0 // å°†åœ¨ä¸‹é¢è®¡ç®—\n        },\n        \n        // è´¨é‡æ§åˆ¶\n        quality_control: {\n          sampling_records: [],\n          test_results: [],\n          quality_certificates: []\n        },\n        \n        // è¿½æº¯é“¾\n        traceability_chain: [\n          {\n            stage: 'generation',\n            timestamp: new Date().toISOString(),\n            actor: wasteItem.generator,\n            action: 'waste_generated',\n            location: wasteItem.generation_location,\n            data_hash: this.generateDataHash(wasteItem)\n          }\n        ]\n      };\n      \n      // è®¡ç®—å‡€ç»æµä»·å€¼\n      traceRecord.economic_value.net_value = \n        traceRecord.economic_value.recovery_value - traceRecord.economic_value.disposal_cost;\n      \n      // å­˜å‚¨è¿½æº¯è®°å½•\n      this.traceabilityRecords.set(traceId, traceRecord);\n      \n      // ç”ŸæˆäºŒç»´ç /RFIDæ ‡ç­¾\n      const trackingLabel = await this.generateTrackingLabel(traceRecord);\n      \n      logger.info(`å›ºåºŸè¿½æº¯ä½“ç³»å»ºç«‹å®Œæˆ: ${traceId}`);\n      this.emit('traceability_established', traceRecord);\n      \n      return {\n        trace_record: traceRecord,\n        tracking_label: trackingLabel,\n        qr_code: this.generateQRCode(traceId),\n        compliance_checklist: this.generateComplianceChecklist(traceRecord)\n      };\n    } catch (error) {\n      logger.error('å»ºç«‹å›ºåºŸè¿½æº¯ä½“ç³»å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ä¼˜åŒ–èµ„æºå¾ªç¯åˆ©ç”¨è·¯å¾„\n   * @param {string} parkId - å›­åŒºID\n   * @param {Array} wasteStreams - åºŸç‰©æµ\n   * @returns {Object} ä¼˜åŒ–æ–¹æ¡ˆ\n   */\n  async optimizeCirculationPath(parkId, wasteStreams) {\n    try {\n      const optimizationId = this.generateOptimizationId(parkId);\n      \n      // åˆ†æåºŸç‰©æµç‰¹å¾\n      const streamAnalysis = this.analyzeWasteStreams(wasteStreams);\n      \n      // è¯†åˆ«å¾ªç¯åˆ©ç”¨æœºä¼š\n      const circulationOpportunities = this.identifyCirculationOpportunities(streamAnalysis);\n      \n      // æ„å»ºå¾ªç¯ç½‘ç»œ\n      const circulationNetwork = this.buildCirculationNetwork(circulationOpportunities);\n      \n      // å¤šç›®æ ‡ä¼˜åŒ–\n      const optimizationResult = await this.executeCirculationOptimization(\n        circulationNetwork,\n        streamAnalysis\n      );\n      \n      // ç”Ÿæˆå®æ–½æ–¹æ¡ˆ\n      const implementationPlan = this.generateImplementationPlan(optimizationResult);\n      \n      // è¯„ä¼°ç¯å¢ƒå’Œç»æµæ•ˆç›Š\n      const benefitAssessment = await this.assessCirculationBenefits(optimizationResult);\n      \n      const result = {\n        optimization_id: optimizationId,\n        park_id: parkId,\n        optimization_time: new Date().toISOString(),\n        \n        // åºŸç‰©æµåˆ†æ\n        waste_stream_analysis: streamAnalysis,\n        \n        // å¾ªç¯æœºä¼š\n        circulation_opportunities: circulationOpportunities,\n        \n        // ä¼˜åŒ–ç½‘ç»œ\n        circulation_network: circulationNetwork,\n        \n        // æœ€ä¼˜è·¯å¾„\n        optimal_paths: optimizationResult.optimal_paths,\n        \n        // å®æ–½æ–¹æ¡ˆ\n        implementation_plan: implementationPlan,\n        \n        // æ•ˆç›Šè¯„ä¼°\n        benefits: benefitAssessment,\n        \n        // å¾ªç¯ç»æµæŒ‡æ ‡\n        circularity_metrics: {\n          material_circularity_rate: this.calculateMaterialCircularityRate(optimizationResult),\n          waste_diversion_rate: this.calculateWasteDiversionRate(optimizationResult),\n          resource_efficiency: this.calculateResourceEfficiency(optimizationResult),\n          carbon_reduction: this.calculateCarbonReduction(optimizationResult)\n        },\n        \n        // å…³é”®ç»©æ•ˆæŒ‡æ ‡\n        kpis: {\n          total_waste_processed: streamAnalysis.total_quantity,\n          recycling_rate: optimizationResult.recycling_rate,\n          recovery_rate: optimizationResult.recovery_rate,\n          cost_savings: benefitAssessment.cost_savings,\n          revenue_generation: benefitAssessment.revenue_generation,\n          carbon_footprint_reduction: benefitAssessment.carbon_reduction\n        },\n        \n        // é£é™©è¯„ä¼°\n        risk_assessment: this.assessImplementationRisks(implementationPlan),\n        \n        // ç›‘æ§è®¡åˆ’\n        monitoring_plan: this.createMonitoringPlan(optimizationResult)\n      };\n      \n      // ç¼“å­˜ä¼˜åŒ–ç»“æœ\n      this.optimizationResults.set(optimizationId, result);\n      \n      logger.info(`èµ„æºå¾ªç¯åˆ©ç”¨è·¯å¾„ä¼˜åŒ–å®Œæˆ: ${optimizationId}, å¾ªç¯ç‡: ${result.circularity_metrics.material_circularity_rate}%`);\n      this.emit('circulation_optimized', result);\n      \n      return result;\n    } catch (error) {\n      logger.error('ä¼˜åŒ–èµ„æºå¾ªç¯åˆ©ç”¨è·¯å¾„å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * æ›´æ–°è¿½æº¯è®°å½•\n   * @param {string} traceId - è¿½æº¯ID\n   * @param {string} stage - ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ\n   * @param {Object} updateData - æ›´æ–°æ•°æ®\n   * @returns {Object} æ›´æ–°ç»“æœ\n   */\n  async updateTraceabilityRecord(traceId, stage, updateData) {\n    try {\n      const traceRecord = this.traceabilityRecords.get(traceId);\n      if (!traceRecord) {\n        throw new Error(`è¿½æº¯è®°å½•ä¸å­˜åœ¨: ${traceId}`);\n      }\n      \n      // éªŒè¯é˜¶æ®µé¡ºåº\n      this.validateStageSequence(traceRecord, stage);\n      \n      // æ›´æ–°é˜¶æ®µä¿¡æ¯\n      if (traceRecord.lifecycle_stages[stage]) {\n        Object.assign(traceRecord.lifecycle_stages[stage], {\n          ...updateData,\n          timestamp: new Date().toISOString(),\n          status: 'completed'\n        });\n      }\n      \n      // æ·»åŠ è¿½æº¯é“¾è®°å½•\n      traceRecord.traceability_chain.push({\n        stage: stage,\n        timestamp: new Date().toISOString(),\n        actor: updateData.actor || 'system',\n        action: updateData.action || `${stage}_completed`,\n        location: updateData.location,\n        data_hash: this.generateDataHash(updateData),\n        previous_hash: traceRecord.traceability_chain[traceRecord.traceability_chain.length - 1].data_hash\n      });\n      \n      // æ›´æ–°åˆè§„æ€§çŠ¶æ€\n      await this.updateComplianceStatus(traceRecord, stage, updateData);\n      \n      // é‡æ–°è®¡ç®—ç¯å¢ƒå½±å“\n      this.recalculateEnvironmentalImpact(traceRecord, stage, updateData);\n      \n      // æ›´æ–°è´¨é‡æ§åˆ¶è®°å½•\n      if (updateData.quality_data) {\n        this.updateQualityControlRecords(traceRecord, updateData.quality_data);\n      }\n      \n      // æ£€æŸ¥æ˜¯å¦å®Œæˆå…¨ç”Ÿå‘½å‘¨æœŸ\n      const isComplete = this.checkLifecycleCompletion(traceRecord);\n      \n      const result = {\n        trace_id: traceId,\n        updated_stage: stage,\n        update_time: new Date().toISOString(),\n        lifecycle_complete: isComplete,\n        current_status: this.getCurrentStatus(traceRecord),\n        next_actions: this.getNextActions(traceRecord),\n        compliance_status: traceRecord.compliance.compliance_status,\n        environmental_impact: traceRecord.environmental_impact,\n        economic_value: traceRecord.economic_value\n      };\n      \n      // å¦‚æœç”Ÿå‘½å‘¨æœŸå®Œæˆï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š\n      if (isComplete) {\n        result.final_report = await this.generateFinalReport(traceRecord);\n      }\n      \n      logger.info(`è¿½æº¯è®°å½•æ›´æ–°å®Œæˆ: ${traceId}, é˜¶æ®µ: ${stage}`);\n      this.emit('traceability_updated', result);\n      \n      return result;\n    } catch (error) {\n      logger.error('æ›´æ–°è¿½æº¯è®°å½•å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç”Ÿæˆå¾ªç¯ç»æµæŠ¥å‘Š\n   * @param {string} parkId - å›­åŒºID\n   * @param {string} period - æŠ¥å‘ŠæœŸé—´\n   * @returns {Object} å¾ªç¯ç»æµæŠ¥å‘Š\n   */\n  async generateCircularEconomyReport(parkId, period = 'monthly') {\n    try {\n      const reportId = this.generateReportId(parkId, period);\n      \n      // è·å–æœŸé—´å†…çš„æ•°æ®\n      const periodData = await this.getPeriodData(parkId, period);\n      \n      // è®¡ç®—å¾ªç¯ç»æµæŒ‡æ ‡\n      const circularityMetrics = this.calculateCircularityMetrics(periodData);\n      \n      // åˆ†æåºŸç‰©æµ\n      const wasteFlowAnalysis = this.analyzeWasteFlows(periodData);\n      \n      // è¯„ä¼°ç¯å¢ƒæ•ˆç›Š\n      const environmentalBenefits = this.assessEnvironmentalBenefits(periodData);\n      \n      // è®¡ç®—ç»æµæ•ˆç›Š\n      const economicBenefits = this.calculateEconomicBenefits(periodData);\n      \n      // è¯†åˆ«æ”¹è¿›æœºä¼š\n      const improvementOpportunities = this.identifyImprovementOpportunities(periodData);\n      \n      // åŸºå‡†å¯¹æ¯”\n      const benchmarkComparison = await this.performBenchmarkComparison(circularityMetrics);\n      \n      const report = {\n        report_id: reportId,\n        park_id: parkId,\n        report_period: period,\n        generation_time: new Date().toISOString(),\n        \n        // æ‰§è¡Œæ‘˜è¦\n        executive_summary: {\n          total_waste_processed: periodData.total_waste,\n          circularity_rate: circularityMetrics.material_circularity,\n          diversion_rate: circularityMetrics.waste_diversion_rate,\n          cost_savings: economicBenefits.total_savings,\n          carbon_reduction: environmentalBenefits.carbon_reduction,\n          key_achievements: this.identifyKeyAchievements(periodData),\n          main_challenges: this.identifyMainChallenges(periodData)\n        },\n        \n        // å¾ªç¯ç»æµæŒ‡æ ‡\n        circularity_metrics: circularityMetrics,\n        \n        // åºŸç‰©æµåˆ†æ\n        waste_flow_analysis: wasteFlowAnalysis,\n        \n        // ç¯å¢ƒæ•ˆç›Š\n        environmental_benefits: environmentalBenefits,\n        \n        // ç»æµæ•ˆç›Š\n        economic_benefits: economicBenefits,\n        \n        // æŠ€æœ¯ç»©æ•ˆ\n        technology_performance: {\n          recycling_efficiency: this.calculateRecyclingEfficiency(periodData),\n          recovery_efficiency: this.calculateRecoveryEfficiency(periodData),\n          treatment_effectiveness: this.calculateTreatmentEffectiveness(periodData)\n        },\n        \n        // åˆè§„æ€§çŠ¶æ€\n        compliance_status: {\n          regulatory_compliance: this.assessRegulatoryCompliance(periodData),\n          permit_status: this.checkPermitStatus(periodData),\n          audit_results: this.getAuditResults(periodData)\n        },\n        \n        // æ”¹è¿›å»ºè®®\n        improvement_opportunities: improvementOpportunities,\n        \n        // åŸºå‡†å¯¹æ¯”\n        benchmark_comparison: benchmarkComparison,\n        \n        // è¶‹åŠ¿åˆ†æ\n        trend_analysis: this.performTrendAnalysis(parkId, period),\n        \n        // é¢„æµ‹å’Œç›®æ ‡\n        forecasts_and_targets: {\n          next_period_forecast: this.generateNextPeriodForecast(periodData),\n          annual_targets: this.getAnnualTargets(parkId),\n          target_achievement: this.assessTargetAchievement(circularityMetrics)\n        },\n        \n        // è¡ŒåŠ¨è®¡åˆ’\n        action_plan: this.generateActionPlan(improvementOpportunities),\n        \n        // é™„å½•\n        appendices: {\n          detailed_data: periodData,\n          methodology: this.getCalculationMethodology(),\n          data_sources: this.getDataSources(),\n          assumptions: this.getAssumptions()\n        }\n      };\n      \n      logger.info(`å¾ªç¯ç»æµæŠ¥å‘Šç”Ÿæˆå®Œæˆ: ${reportId}`);\n      this.emit('report_generated', report);\n      \n      return report;\n    } catch (error) {\n      logger.error('ç”Ÿæˆå¾ªç¯ç»æµæŠ¥å‘Šå¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * å¯åŠ¨å®æ—¶ç›‘æ§\n   */\n  async startRealTimeMonitoring() {\n    // æ¯å°æ—¶æ›´æ–°å¾ªç¯ç»æµæŒ‡æ ‡\n    setInterval(async () => {\n      try {\n        await this.updateCircularityMetrics();\n      } catch (error) {\n        logger.error('æ›´æ–°å¾ªç¯ç»æµæŒ‡æ ‡å¤±è´¥:', error);\n      }\n    }, MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND);\n    \n    // æ¯30åˆ†é’Ÿæ£€æŸ¥è¿½æº¯è®°å½•çŠ¶æ€\n    setInterval(async () => {\n      try {\n        await this.checkTraceabilityStatus();\n      } catch (error) {\n        logger.error('æ£€æŸ¥è¿½æº¯è®°å½•çŠ¶æ€å¤±è´¥:', error);\n      }\n    }, MATH_CONSTANTS.THIRTY * MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND);\n    \n    // æ¯15åˆ†é’Ÿç›‘æ§å¤„ç†è®¾æ–½çŠ¶æ€\n    setInterval(async () => {\n      try {\n        await this.monitorTreatmentFacilities();\n      } catch (error) {\n        logger.error('ç›‘æ§å¤„ç†è®¾æ–½å¤±è´¥:', error);\n      }\n    }, MATH_CONSTANTS.FIFTEEN * MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND);\n  }\n\n  // åºŸç‰©åˆ†ç±»å’Œè¯„ä¼°æ–¹æ³•\n  classifyWaste(wasteItem) {\n    const { type, composition, hazard_properties } = wasteItem;\n    \n    // å±é™©åºŸç‰©åˆ¤å®š\n    if (hazard_properties && hazard_properties.length > 0) {\n      return {\n        category: 'hazardous',\n        code: this.getHazardousWasteCode(type, hazard_properties),\n        subcategory: this.getHazardousSubcategory(type),\n        risk_level: this.assessRiskLevel(hazard_properties)\n      };\n    }\n    \n    // å¯å›æ”¶ç‰©åˆ¤å®š\n    if (this.isRecyclable(composition)) {\n      return {\n        category: 'recyclable',\n        code: this.getRecyclableCode(type),\n        subcategory: this.getRecyclableSubcategory(type),\n        recycling_grade: this.assessRecyclingGrade(composition)\n      };\n    }\n    \n    // æœ‰æœºåºŸç‰©åˆ¤å®š\n    if (this.isOrganic(composition)) {\n      return {\n        category: 'organic',\n        code: this.getOrganicCode(type),\n        subcategory: this.getOrganicSubcategory(type),\n        biodegradability: this.assessBiodegradability(composition)\n      };\n    }\n    \n    // æƒ°æ€§åºŸç‰©\n    return {\n      category: 'inert',\n      code: this.getInertCode(type),\n      subcategory: this.getInertSubcategory(type),\n      utilization_potential: this.assessUtilizationPotential(composition)\n    };\n  }\n\n  assessHazardLevel(wasteItem) {\n    const { hazard_properties, quantity, concentration } = wasteItem;\n    \n    let hazardScore = 0;\n    \n    // å±é™©ç‰¹æ€§è¯„åˆ†\n    if (hazard_properties.includes('toxic')) hazardScore += 3;\n    if (hazard_properties.includes('corrosive')) hazardScore += 2;\n    if (hazard_properties.includes('flammable')) hazardScore += 2;\n    if (hazard_properties.includes('explosive')) hazardScore += 4;\n    if (hazard_properties.includes('infectious')) hazardScore += 3;\n    \n    // æ•°é‡å½±å“\n    if (quantity > 1000) hazardScore += 2;\n    else if (quantity > 100) hazardScore += 1;\n    \n    // æµ“åº¦å½±å“\n    if (concentration && concentration > 0.5) hazardScore += 2;\n    else if (concentration && concentration > 0.1) hazardScore += 1;\n    \n    if (hazardScore >= 6) return 'high';\n    if (hazardScore >= 3) return 'medium';\n    return 'low';\n  }\n\n  assessRecyclingPotential(wasteItem) {\n    const { type, composition, contamination_level, quantity } = wasteItem;\n    \n    const baseRecyclability = this.getBaseRecyclability(type);\n    const contaminationPenalty = contamination_level * 0.2;\n    const quantityBonus = quantity > 100 ? 0.1 : 0;\n    \n    const potential = Math.max(0, baseRecyclability - contaminationPenalty + quantityBonus);\n    \n    return {\n      score: potential,\n      grade: potential > 0.8 ? 'excellent' : potential > 0.6 ? 'good' : potential > 0.4 ? 'fair' : 'poor',\n      estimated_recovery_rate: potential * 0.9,\n      estimated_value: this.calculateEstimatedValue(type, quantity, potential)\n    };\n  }\n\n  // å¾ªç¯åˆ©ç”¨ä¼˜åŒ–æ–¹æ³•\n  analyzeWasteStreams(wasteStreams) {\n    const analysis = {\n      total_quantity: 0,\n      composition_breakdown: {},\n      recyclable_fraction: 0,\n      organic_fraction: 0,\n      hazardous_fraction: 0,\n      inert_fraction: 0,\n      contamination_levels: {},\n      seasonal_patterns: {},\n      source_distribution: {}\n    };\n    \n    wasteStreams.forEach(stream => {\n      analysis.total_quantity += stream.quantity;\n      \n      // æˆåˆ†åˆ†æ\n      Object.keys(stream.composition).forEach(component => {\n        if (!analysis.composition_breakdown[component]) {\n          analysis.composition_breakdown[component] = 0;\n        }\n        analysis.composition_breakdown[component] += stream.composition[component] * stream.quantity;\n      });\n      \n      // åˆ†ç±»ç»Ÿè®¡\n      const classification = this.classifyWaste(stream);\n      switch (classification.category) {\n        case 'recyclable':\n          analysis.recyclable_fraction += stream.quantity;\n          break;\n        case 'organic':\n          analysis.organic_fraction += stream.quantity;\n          break;\n        case 'hazardous':\n          analysis.hazardous_fraction += stream.quantity;\n          break;\n        case 'inert':\n          analysis.inert_fraction += stream.quantity;\n          break;\n      }\n      \n      // æ±¡æŸ“æ°´å¹³\n      if (stream.contamination_level) {\n        if (!analysis.contamination_levels[classification.category]) {\n          analysis.contamination_levels[classification.category] = [];\n        }\n        analysis.contamination_levels[classification.category].push(stream.contamination_level);\n      }\n      \n      // æ¥æºåˆ†å¸ƒ\n      if (!analysis.source_distribution[stream.source]) {\n        analysis.source_distribution[stream.source] = 0;\n      }\n      analysis.source_distribution[stream.source] += stream.quantity;\n    });\n    \n    // è®¡ç®—æ¯”ä¾‹\n    analysis.recyclable_fraction /= analysis.total_quantity;\n    analysis.organic_fraction /= analysis.total_quantity;\n    analysis.hazardous_fraction /= analysis.total_quantity;\n    analysis.inert_fraction /= analysis.total_quantity;\n    \n    return analysis;\n  }\n\n  identifyCirculationOpportunities(streamAnalysis) {\n    const opportunities = [];\n    \n    // å¯å›æ”¶ç‰©æœºä¼š\n    if (streamAnalysis.recyclable_fraction > 0.1) {\n      opportunities.push({\n        type: 'material_recycling',\n        potential_quantity: streamAnalysis.total_quantity * streamAnalysis.recyclable_fraction,\n        estimated_value: this.calculateRecyclingValue(streamAnalysis),\n        implementation_complexity: 'medium',\n        payback_period: '2-3 years'\n      });\n    }\n    \n    // æœ‰æœºåºŸç‰©å¤„ç†æœºä¼š\n    if (streamAnalysis.organic_fraction > 0.15) {\n      opportunities.push({\n        type: 'organic_treatment',\n        potential_quantity: streamAnalysis.total_quantity * streamAnalysis.organic_fraction,\n        treatment_options: ['composting', 'anaerobic_digestion'],\n        estimated_value: this.calculateOrganicValue(streamAnalysis),\n        implementation_complexity: 'high',\n        payback_period: '3-5 years'\n      });\n    }\n    \n    // èƒ½æºå›æ”¶æœºä¼š\n    const energyRecoveryPotential = this.calculateEnergyRecoveryPotential(streamAnalysis);\n    if (energyRecoveryPotential > 1000) { // kWh\n      opportunities.push({\n        type: 'energy_recovery',\n        potential_energy: energyRecoveryPotential,\n        estimated_value: energyRecoveryPotential * 0.6, // 0.6å…ƒ/kWh\n        implementation_complexity: 'high',\n        payback_period: '5-7 years'\n      });\n    }\n    \n    // å·¥ä¸šå…±ç”Ÿæœºä¼š\n    const symbiosisOpportunities = this.identifyIndustrialSymbiosis(streamAnalysis);\n    opportunities.push(...symbiosisOpportunities);\n    \n    return opportunities;\n  }\n\n  buildCirculationNetwork(opportunities) {\n    const network = {\n      nodes: [],\n      edges: [],\n      flows: [],\n      constraints: []\n    };\n    \n    // æ·»åŠ æºèŠ‚ç‚¹ï¼ˆåºŸç‰©äº§ç”Ÿç‚¹ï¼‰\n    network.nodes.push({\n      id: 'waste_sources',\n      type: 'source',\n      capacity: Infinity\n    });\n    \n    // æ·»åŠ å¤„ç†èŠ‚ç‚¹\n    opportunities.forEach((opp, index) => {\n      network.nodes.push({\n        id: `treatment_${index}`,\n        type: 'treatment',\n        treatment_type: opp.type,\n        capacity: opp.potential_quantity,\n        cost: opp.estimated_cost || 0,\n        efficiency: opp.efficiency || 0.8\n      });\n      \n      // æ·»åŠ ä»æºåˆ°å¤„ç†çš„è¾¹\n      network.edges.push({\n        from: 'waste_sources',\n        to: `treatment_${index}`,\n        capacity: opp.potential_quantity,\n        cost: opp.transport_cost || 50\n      });\n    });\n    \n    // æ·»åŠ æ±‡èŠ‚ç‚¹ï¼ˆæœ€ç»ˆäº§å“/å¤„ç½®ï¼‰\n    network.nodes.push({\n      id: 'final_products',\n      type: 'sink',\n      capacity: Infinity\n    });\n    \n    // æ·»åŠ ä»å¤„ç†åˆ°æ±‡çš„è¾¹\n    opportunities.forEach((opp, index) => {\n      network.edges.push({\n        from: `treatment_${index}`,\n        to: 'final_products',\n        capacity: opp.potential_quantity * (opp.efficiency || 0.8),\n        value: opp.estimated_value || 0\n      });\n    });\n    \n    return network;\n  }\n\n  async executeCirculationOptimization(network, streamAnalysis) {\n    // ç®€åŒ–çš„ç½‘ç»œæµä¼˜åŒ–\n    // å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨ä¸“ä¸šçš„ç½‘ç»œä¼˜åŒ–ç®—æ³•\n    \n    const optimization = {\n      objective: 'maximize_value_minimize_cost',\n      constraints: [\n        'capacity_constraints',\n        'flow_conservation',\n        'material_balance'\n      ],\n      variables: network.edges.map(edge => ({\n        id: `flow_${edge.from}_${edge.to}`,\n        type: 'continuous',\n        lower_bound: 0,\n        upper_bound: edge.capacity\n      }))\n    };\n    \n    // æ¨¡æ‹Ÿä¼˜åŒ–ç»“æœ\n    const optimalFlows = this.simulateOptimalFlows(network, streamAnalysis);\n    \n    return {\n      optimal_flows: optimalFlows,\n      optimal_paths: this.extractOptimalPaths(optimalFlows, network),\n      total_value: this.calculateTotalValue(optimalFlows, network),\n      total_cost: this.calculateTotalCost(optimalFlows, network),\n      recycling_rate: this.calculateOptimalRecyclingRate(optimalFlows, streamAnalysis),\n      recovery_rate: this.calculateOptimalRecoveryRate(optimalFlows, streamAnalysis),\n      efficiency_metrics: this.calculateEfficiencyMetrics(optimalFlows, network)\n    };\n  }\n\n  // è¾…åŠ©æ–¹æ³•\n  generateTraceId(parkId, wasteItem) {\n    return `TRACE_${parkId}_${wasteItem.type}_${Date.now()}`;\n  }\n\n  generateOptimizationId(parkId) {\n    return `CIRC_OPT_${parkId}_${Date.now()}`;\n  }\n\n  generateReportId(parkId, period) {\n    return `CIRC_RPT_${parkId}_${period}_${Date.now()}`;\n  }\n\n  generateDataHash(data) {\n    // ç®€åŒ–çš„æ•°æ®å“ˆå¸Œç”Ÿæˆ\n    return `hash_${JSON.stringify(data).length}_${Date.now()}`;\n  }\n\n  generateQRCode(traceId) {\n    return {\n      content: traceId,\n      format: 'QR_CODE',\n      size: '100x100',\n      url: `https://trace.system.com/track/${traceId}`\n    };\n  }\n\n  async generateTrackingLabel(traceRecord) {\n    return {\n      label_id: `LABEL_${traceRecord.trace_id}`,\n      type: 'RFID',\n      content: {\n        trace_id: traceRecord.trace_id,\n        waste_type: traceRecord.waste_info.type,\n        generation_date: traceRecord.lifecycle_stages.generation.timestamp,\n        hazard_level: traceRecord.waste_info.hazard_level\n      },\n      print_ready: true\n    };\n  }\n\n  // æ¨¡æ‹Ÿæ•°æ®è·å–æ–¹æ³•\n  async initializeWasteCategories() {\n    Object.keys(this.wasteClassification).forEach(category => {\n      this.wasteCategories.set(category, this.wasteClassification[category]);\n    });\n    logger.info('åºŸç‰©åˆ†ç±»ä½“ç³»åˆå§‹åŒ–å®Œæˆ');\n  }\n\n  async setupRecyclingProcesses() {\n    Object.keys(this.treatmentTechnologies).forEach(tech => {\n      this.recyclingProcesses.set(tech, this.treatmentTechnologies[tech]);\n    });\n    logger.info('å›æ”¶å¤„ç†å·¥è‰ºé…ç½®å®Œæˆ');\n  }\n\n  async initializeTraceabilitySystem() {\n    // åˆå§‹åŒ–åŒºå—é“¾æˆ–åˆ†å¸ƒå¼è´¦æœ¬ç³»ç»Ÿ\n    logger.info('è¿½æº¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');\n  }\n\n  async updateCircularityMetrics() {\n    // æ›´æ–°å¾ªç¯ç»æµæŒ‡æ ‡\n    const parks = await this.getAllParks();\n    \n    for (const park of parks) {\n      const metrics = await this.calculateRealTimeMetrics(park.id);\n      this.circularityMetrics.set(park.id, metrics);\n    }\n  }\n\n  async checkTraceabilityStatus() {\n    // æ£€æŸ¥è¿½æº¯è®°å½•çŠ¶æ€\n    for (const [traceId, record] of this.traceabilityRecords) {\n      const status = this.getCurrentStatus(record);\n      if (status === 'overdue') {\n        this.emit('traceability_alert', {\n          trace_id: traceId,\n          alert_type: 'overdue',\n          message: 'è¿½æº¯è®°å½•æ›´æ–°è¶…æ—¶'\n        });\n      }\n    }\n  }\n\n  async monitorTreatmentFacilities() {\n    // ç›‘æ§å¤„ç†è®¾æ–½çŠ¶æ€\n    const facilities = await this.getTreatmentFacilities();\n    \n    for (const facility of facilities) {\n      const status = await this.getFacilityStatus(facility.id);\n      if (status.efficiency < 0.7) {\n        this.emit('facility_alert', {\n          facility_id: facility.id,\n          alert_type: 'low_efficiency',\n          efficiency: status.efficiency\n        });\n      }\n    }\n  }\n\n  async getAllParks() {\n    return [{ id: 'park_001', name: 'ç¤ºä¾‹å›­åŒº' }];\n  }\n\n  async getTreatmentFacilities() {\n    return [\n      { id: 'facility_001', name: 'å›æ”¶å¤„ç†ä¸­å¿ƒ', type: 'recycling' },\n      { id: 'facility_002', name: 'æœ‰æœºåºŸç‰©å¤„ç†å‚', type: 'organic_treatment' }\n    ];\n  }\n\n  async getFacilityStatus(facilityId) {\n    return {\n      efficiency: 0.85 + Math.random() * 0.1,\n      capacity_utilization: 0.7 + Math.random() * 0.2,\n      operational_status: 'normal'\n    };\n  }\n\n  // å…¶ä»–è®¡ç®—æ–¹æ³•çš„ç®€åŒ–å®ç°\n  calculateCarbonFootprint(wasteItem) {\n    const emissionFactors = {\n      plastic: 2.1,\n      paper: 0.9,\n      metal: 1.5,\n      organic: -0.3, // è´Ÿå€¼è¡¨ç¤ºç¢³æ±‡\n      glass: 0.8\n    };\n    \n    return (emissionFactors[wasteItem.type] || 1.0) * wasteItem.quantity;\n  }\n\n  calculateDisposalCost(wasteItem) {\n    const costFactors = {\n      hazardous: 2000,\n      recyclable: 200,\n      organic: 300,\n      inert: 100\n    };\n    \n    const classification = this.classifyWaste(wasteItem);\n    return (costFactors[classification.category] || 500) * wasteItem.quantity / 1000; // å…ƒ/å¨\n  }\n\n  calculateRecoveryValue(wasteItem) {\n    const valueFactors = {\n      plastic: 1200,\n      paper: 800,\n      metal: 2500,\n      glass: 300,\n      organic: 150\n    };\n    \n    const potential = this.assessRecyclingPotential(wasteItem);\n    return (valueFactors[wasteItem.type] || 0) * wasteItem.quantity / 1000 * potential.score;\n  }\n\n  isRecyclable(composition) {\n    const recyclableTypes = ['plastic', 'paper', 'metal', 'glass'];\n    return Object.keys(composition).some(type => recyclableTypes.includes(type));\n  }\n\n  isOrganic(composition) {\n    const organicTypes = ['food_waste', 'garden_waste', 'wood', 'textile'];\n    return Object.keys(composition).some(type => organicTypes.includes(type));\n  }\n\n  getBaseRecyclability(type) {\n    const recyclabilityMap = {\n      plastic: 0.8,\n      paper: 0.9,\n      metal: 0.95,\n      glass: 0.85,\n      textile: 0.6,\n      electronics: 0.7\n    };\n    \n    return recyclabilityMap[type] || 0.3;\n  }\n}\n\nexport default ResourceCirculationCenter;","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/SceneManager.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0x87ceeb.","line":38,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":38,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0x87ceeb.","line":39,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":39,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":39,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":39,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":39,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":39,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 75.","line":43,"column":7,"nodeType":"Literal","messageId":"noMagic","endLine":43,"endColumn":9},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":45,"column":7,"nodeType":"Literal","messageId":"noMagic","endLine":45,"endColumn":10},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2000.","line":46,"column":7,"nodeType":"Literal","messageId":"noMagic","endLine":46,"endColumn":11},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":48,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":48,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":48,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":48,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":48,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":48,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xffffff.","line":87,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":87,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.6.","line":87,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":87,"endColumn":62},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xffffff.","line":91,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":91,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":91,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":91,"endColumn":70},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":92,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":92,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":92,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":92,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":92,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":92,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":106,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":106,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":106,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":106,"endColumn":60},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":127,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":127,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":128,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":128,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 15.","line":129,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":129,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0x4a90e2.","line":133,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":133,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0x66c2a5.","line":133,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":133,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":139,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":139,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":163,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":163,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":163,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":163,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":163,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":163,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":167,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":167,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":167,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":167,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 15.","line":167,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":167,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":171,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":171,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":171,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":171,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xef4444.","line":181,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":181,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xf59e0b.","line":183,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":183,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":213,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":213,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0x10b981.","line":228,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":228,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xf59e0b.","line":231,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":231,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xef4444.","line":234,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":234,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0x6b7280.","line":237,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":237,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":245,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":245,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":258,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":258,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":259,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":259,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":259,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":259,"endColumn":63},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 80.","line":261,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xef4444.","line":261,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":261,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xf59e0b.","line":261,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0x10b981.","line":261,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":70}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":49,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * æ•°å­—å­ªç”Ÿåœºæ™¯ç®¡ç†å™¨\n * è´Ÿè´£3Dåœºæ™¯çš„åˆ›å»ºã€æ›´æ–°å’Œç®¡ç†\n */\n\nimport * as THREE from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';\nimport { GLTFLoader as _GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';\nimport { CSS2DRenderer, CSS2DObject } from 'three/examples/jsm/renderers/CSS2DRenderer';\n\nclass SceneManager {\n  constructor(container) {\n    this.container = container;\n    this.scene = null;\n    this.camera = null;\n    this.renderer = null;\n    this.labelRenderer = null;\n    this.controls = null;\n    this.buildings = new Map();\n    this.devices = new Map();\n    this.sensors = new Map();\n    this.animationId = null;\n\n    this.init();\n  }\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 49 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 49 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 49 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 49 è¡Œ)\n\n  init() {\n    // åˆ›å»ºåœºæ™¯\n    this.scene = new THREE.Scene();\n    this.scene.background = new THREE.Color(0x87ceeb); // å¤©ç©ºè“\n    this.scene.fog = new THREE.Fog(0x87ceeb, 100, 1000);\n\n    // åˆ›å»ºç›¸æœº\n    this.camera = new THREE.PerspectiveCamera(\n      75,\n      this.container.clientWidth / this.container.clientHeight,\n      0.1,\n      2000\n    );\n    this.camera.position.set(100, 100, 100);\n\n    // åˆ›å»ºWebGLæ¸²æŸ“å™¨\n    this.renderer = new THREE.WebGLRenderer({ antialias: true });\n    this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);\n    this.renderer.setPixelRatio(window.devicePixelRatio);\n    this.renderer.shadowMap.enabled = true;\n    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n    this.container.appendChild(this.renderer.domElement);\n\n    // åˆ›å»ºCSS2Dæ¸²æŸ“å™¨ç”¨äºæ ‡ç­¾\n    this.labelRenderer = new CSS2DRenderer();\n    this.labelRenderer.setSize(this.container.clientWidth, this.container.clientHeight);\n    this.labelRenderer.domElement.style.position = 'absolute';\n    this.labelRenderer.domElement.style.top = '0px';\n    this.labelRenderer.domElement.style.pointerEvents = 'none';\n    this.container.appendChild(this.labelRenderer.domElement);\n\n    // åˆ›å»ºè½¨é“æ§åˆ¶å™¨\n    this.controls = new OrbitControls(this.camera, this.renderer.domElement);\n    this.controls.enableDamping = true;\n    this.controls.dampingFactor = 0.05;\n    this.controls.maxPolarAngle = Math.PI / 2;\n\n    // æ·»åŠ å…‰æº\n    this.setupLighting();\n\n    // åˆ›å»ºåœ°é¢\n    this.createGround();\n\n    // å¼€å§‹æ¸²æŸ“å¾ªç¯\n    this.animate();\n\n    // ç›‘å¬çª—å£å¤§å°å˜åŒ–\n    window.addEventListener('resize', this.onWindowResize.bind(this));\n  }\n\n  setupLighting() {\n    // ç¯å¢ƒå…‰\n    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);\n    this.scene.add(ambientLight);\n\n    // æ–¹å‘å…‰ï¼ˆå¤ªé˜³å…‰ï¼‰\n    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);\n    directionalLight.position.set(100, 100, 50);\n    directionalLight.castShadow = true;\n    directionalLight.shadow.mapSize.width = 2048;\n    directionalLight.shadow.mapSize.height = 2048;\n    directionalLight.shadow.camera.near = 0.5;\n    directionalLight.shadow.camera.far = 500;\n    directionalLight.shadow.camera.left = -100;\n    directionalLight.shadow.camera.right = 100;\n    directionalLight.shadow.camera.top = 100;\n    directionalLight.shadow.camera.bottom = -100;\n    this.scene.add(directionalLight);\n  }\n\n  createGround() {\n    const groundGeometry = new THREE.PlaneGeometry(500, 500);\n    const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90ee90 });\n    const ground = new THREE.Mesh(groundGeometry, groundMaterial);\n    ground.rotation.x = -Math.PI / 2;\n    ground.receiveShadow = true;\n    this.scene.add(ground);\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 29 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 29 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 29 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 29 è¡Œ)\n  }\n\n  // åˆ›å»ºå»ºç­‘ç‰©\n  createBuilding(buildingData) {\n    const { id, name, position, dimensions, type, color } = buildingData;\n\n    const geometry = new THREE.BoxGeometry(\n      dimensions.width || 20,\n      dimensions.height || 30,\n      dimensions.depth || 15\n    );\n\n    const material = new THREE.MeshStandardMaterial({\n      color: color || (type === 'industrial' ? 0x4a90e2 : 0x66c2a5),\n      metalness: 0.3,\n      roughness: 0.8\n    });\n\n    const building = new THREE.Mesh(geometry, material);\n    building.position.set(position.x || 0, (dimensions.height || 30) / 2, position.z || 0);\n    building.castShadow = true;\n    building.receiveShadow = true;\n    building.userData = { id, type: 'building', data: buildingData };\n\n    this.scene.add(building);\n    this.buildings.set(id, building);\n\n    // æ·»åŠ å»ºç­‘æ ‡ç­¾\n    this.createLabel(building, name, 'building');\n\n    return building;\n  }\n\n  // åˆ›å»ºè®¾å¤‡\n  createDevice(deviceData) {\n    const { id, name, position, device_type, status } = deviceData;\n\n    let geometry;\n    let material;\n\n    // æ ¹æ®è®¾å¤‡ç±»å‹åˆ›å»ºä¸åŒå½¢çŠ¶\n    switch (device_type) {\n      case 'solar_panel':\n        geometry = new THREE.BoxGeometry(8, 0.5, 4);\n        material = new THREE.MeshStandardMaterial({ color: 0x1e3a8a });\n        break;\n      case 'wind_turbine':\n        geometry = new THREE.CylinderGeometry(0.5, 0.5, 15);\n        material = new THREE.MeshStandardMaterial({ color: 0xffffff });\n        break;\n      case 'battery':\n        geometry = new THREE.BoxGeometry(3, 4, 2);\n        material = new THREE.MeshStandardMaterial({ color: 0x059669 });\n        break;\n      default:\n        geometry = new THREE.BoxGeometry(2, 2, 2);\n        material = new THREE.MeshStandardMaterial({ color: 0x6b7280 });\n    }\n\n    // æ ¹æ®çŠ¶æ€è°ƒæ•´é¢œè‰²\n    if (status === 'offline') {\n      material.color.setHex(0xef4444);\n    } else if (status === 'warning') {\n      material.color.setHex(0xf59e0b);\n    }\n\n    const device = new THREE.Mesh(geometry, material);\n    device.position.set(position.x || 0, position.y || 2, position.z || 0);\n    device.castShadow = true;\n    device.userData = { id, type: 'device', data: deviceData };\n\n    this.scene.add(device);\n    this.devices.set(id, device);\n\n    // æ·»åŠ è®¾å¤‡æ ‡ç­¾\n    this.createLabel(device, name, 'device');\n\n    return device;\n  }\n\n  // åˆ›å»ºæ ‡ç­¾\n  createLabel(object, text, type) {\n    const labelDiv = document.createElement('div');\n    labelDiv.className = `label label-${type}`;\n    labelDiv.textContent = text;\n    labelDiv.style.backgroundColor = 'rgba(0,0,0,0.7)';\n    labelDiv.style.color = 'white';\n    labelDiv.style.padding = '4px 8px';\n    labelDiv.style.borderRadius = '4px';\n    labelDiv.style.fontSize = '12px';\n    labelDiv.style.fontFamily = 'Arial, sans-serif';\n\n    const label = new CSS2DObject(labelDiv);\n    label.position.set(0, object.geometry.parameters.height || 5, 0);\n    object.add(label);\n  }\n\n  // æ›´æ–°è®¾å¤‡çŠ¶æ€\n  updateDeviceStatus(deviceId, status, data) {\n    const device = this.devices.get(deviceId);\n    if (!device) {\n      return;\n    }\n\n    // æ›´æ–°é¢œè‰²\n    let color;\n    switch (status) {\n      case 'online':\n        color = 0x10b981;\n        break;\n      case 'warning':\n        color = 0xf59e0b;\n        break;\n      case 'offline':\n        color = 0xef4444;\n        break;\n      default:\n        color = 0x6b7280;\n    }\n\n    device.material.color.setHex(color);\n    device.userData.data = { ...device.userData.data, ...data, status };\n  }\n\n  // æ·»åŠ æ•°æ®å¯è§†åŒ–æ•ˆæœ\n  addDataVisualization(deviceId, value, maxValue = 100) {\n    const device = this.devices.get(deviceId);\n    if (!device) {\n      return;\n    }\n\n    // ç§»é™¤æ—§çš„å¯è§†åŒ–æ•ˆæœ\n    const oldViz = device.getObjectByName('dataViz');\n    if (oldViz) {\n      device.remove(oldViz);\n    }\n\n    // åˆ›å»ºæ•°æ®æ¡\n    const barHeight = (value / maxValue) * 10;\n    const geometry = new THREE.BoxGeometry(0.5, barHeight, 0.5);\n    const material = new THREE.MeshStandardMaterial({\n      color: value > 80 ? 0xef4444 : value > 60 ? 0xf59e0b : 0x10b981\n    });\n\n    const dataBar = new THREE.Mesh(geometry, material);\n    dataBar.position.set(0, barHeight / 2 + 2, 0);\n    dataBar.name = 'dataViz';\n    device.add(dataBar);\n  }\n\n  // åŠ¨ç”»å¾ªç¯\n  animate() {\n    this.animationId = requestAnimationFrame(this.animate.bind(this));\n\n    this.controls.update();\n    this.renderer.render(this.scene, this.camera);\n    this.labelRenderer.render(this.scene, this.camera);\n  }\n\n  // çª—å£å¤§å°å˜åŒ–å¤„ç†\n  onWindowResize() {\n    this.camera.aspect = this.container.clientWidth / this.container.clientHeight;\n    this.camera.updateProjectionMatrix();\n\n    this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);\n    this.labelRenderer.setSize(this.container.clientWidth, this.container.clientHeight);\n  }\n\n  // æ¸…ç†èµ„æº\n  dispose() {\n    if (this.animationId) {\n      cancelAnimationFrame(this.animationId);\n    }\n\n    window.removeEventListener('resize', this.onWindowResize.bind(this));\n\n    this.scene.traverse((object) => {\n      if (object.geometry) {\n        object.geometry.dispose();\n      }\n      if (object.material) {\n        if (Array.isArray(object.material)) {\n          object.material.forEach((material) => material.dispose());\n        } else {\n          object.material.dispose();\n        }\n      }\n    });\n\n    this.renderer.dispose();\n    this.labelRenderer.domElement.remove();\n    this.container.removeChild(this.renderer.domElement);\n  }\n}\n\nexport default SceneManager;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/UserManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/VirtualPowerPlantCenter.js","messages":[{"ruleId":"object-shorthand","severity":2,"message":"Expected property shorthand.","line":298,"column":9,"nodeType":"Property","messageId":"expectedPropertyShorthand","endLine":298,"endColumn":27,"fix":{"range":[8193,8211],"text":"strategy"}},{"ruleId":"object-shorthand","severity":2,"message":"Expected property shorthand.","line":761,"column":11,"nodeType":"Property","messageId":"expectedPropertyShorthand","endLine":761,"endColumn":39,"fix":{"range":[21845,21873],"text":"qualification"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":887,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":887,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":903,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":903,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":904,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":904,"endColumn":43},{"ruleId":"object-shorthand","severity":2,"message":"Expected property shorthand.","line":933,"column":7,"nodeType":"Property","messageId":"expectedPropertyShorthand","endLine":933,"endColumn":17,"fix":{"range":[26899,26909],"text":"bids"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2000.","line":945,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":945,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":952,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":952,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":952,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":952,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":953,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":953,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":953,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":953,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":961,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":961,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":961,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":961,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 950.","line":962,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":962,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 600.","line":962,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":962,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.2.","line":963,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":963,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":964,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":964,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.15.","line":964,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":964,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.6.","line":1033,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":1033,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.3.","line":1037,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":1037,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":1041,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":1041,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000000.","line":1079,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":1079,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500000.","line":1079,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":1079,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 15.","line":1088,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":1088,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":1088,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":1088,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":1089,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":1089,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":1089,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":1089,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":1090,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":1090,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":1090,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":1090,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":1091,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":1091,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":1091,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":1091,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":1096,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":1096,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":1096,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":1096,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":1097,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":1097,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":1097,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":1097,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":1098,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":1098,"endColumn":45},{"ruleId":"no-unused-vars","severity":2,"message":"'aggregation' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":1200,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":1200,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 800.","line":1214,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":1214,"endColumn":62},{"ruleId":"no-unused-vars","severity":2,"message":"'resourceId' is defined but never used. Allowed unused args must match /^_/u.","line":1224,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":1224,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":1226,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":1226,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":1226,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":1226,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.95.","line":1227,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":1227,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.05.","line":1227,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":1227,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.9.","line":1228,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":1228,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.05.","line":1228,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":1228,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 25.","line":1229,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":1229,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":1229,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":1229,"endColumn":43},{"ruleId":"no-unused-vars","severity":2,"message":"'modelId' is defined but never used. Allowed unused args must match /^_/u.","line":1234,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":1234,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":1241,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":1241,"endColumn":18},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":1241,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":1241,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":1241,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":1241,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":1241,"column":71,"nodeType":"Literal","messageId":"noMagic","endLine":1241,"endColumn":73},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":1242,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":1242,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.15.","line":1242,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":1242,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":1253,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":1253,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":1253,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":1253,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2000.","line":1258,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":1258,"endColumn":20},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":1258,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":1258,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":1303,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":1303,"endColumn":47}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":53,"fixableErrorCount":3,"fixableWarningCount":0,"source":"/**\n * è™šæ‹Ÿç”µå‚è¿è¥ä¸äº¤æ˜“ä¸­å¿ƒ\n * å®ç°åˆ†å¸ƒå¼èƒ½æºèšåˆã€ç”µåŠ›å¸‚åœºäº¤æ˜“ã€è¾…åŠ©æœåŠ¡å’Œæ™ºèƒ½è°ƒåº¦\n * æ”¯æŒå¤šç§åˆ†å¸ƒå¼èƒ½æºèµ„æºçš„ç»Ÿä¸€ç®¡ç†å’Œä¼˜åŒ–è¿è¥\n */\n\nimport { EventEmitter } from 'events';\nimport logger from '../../shared/utils/logger.js';\nimport { MATH_CONSTANTS } from '../../shared/constants/MathConstants.js';\n\nclass VirtualPowerPlantCenter extends EventEmitter {\n  constructor() {\n    super();\n    this.isInitialized = false;\n    this.distributedResources = new Map();\n    this.aggregationGroups = new Map();\n    this.marketPositions = new Map();\n    this.tradingStrategies = new Map();\n    this.ancillaryServices = new Map();\n    this.forecastModels = new Map();\n    this.optimizationResults = new Map();\n    \n    // åˆ†å¸ƒå¼èƒ½æºèµ„æºç±»å‹\n    this.resourceTypes = {\n      solar_pv: {\n        name: 'å…‰ä¼å‘ç”µ',\n        category: 'renewable_generation',\n        characteristics: {\n          variability: 'high',\n          predictability: 'medium',\n          response_time: 'fast',\n          ramp_rate: 'high'\n        },\n        market_participation: {\n          energy_market: true,\n          capacity_market: false,\n          ancillary_services: ['frequency_regulation']\n        }\n      },\n      wind_turbine: {\n        name: 'é£åŠ›å‘ç”µ',\n        category: 'renewable_generation',\n        characteristics: {\n          variability: 'very_high',\n          predictability: 'low',\n          response_time: 'medium',\n          ramp_rate: 'medium'\n        },\n        market_participation: {\n          energy_market: true,\n          capacity_market: false,\n          ancillary_services: ['frequency_regulation']\n        }\n      },\n      battery_storage: {\n        name: 'ç”µæ± å‚¨èƒ½',\n        category: 'energy_storage',\n        characteristics: {\n          variability: 'controllable',\n          predictability: 'high',\n          response_time: 'very_fast',\n          ramp_rate: 'very_high'\n        },\n        market_participation: {\n          energy_market: true,\n          capacity_market: true,\n          ancillary_services: ['frequency_regulation', 'spinning_reserve', 'voltage_support']\n        }\n      },\n      flexible_load: {\n        name: 'å¯è°ƒèŠ‚è´Ÿè·',\n        category: 'demand_response',\n        characteristics: {\n          variability: 'controllable',\n          predictability: 'high',\n          response_time: 'fast',\n          ramp_rate: 'high'\n        },\n        market_participation: {\n          energy_market: true,\n          capacity_market: true,\n          ancillary_services: ['demand_response', 'spinning_reserve']\n        }\n      },\n      ev_charging: {\n        name: 'ç”µåŠ¨æ±½è½¦å……ç”µ',\n        category: 'flexible_load',\n        characteristics: {\n          variability: 'medium',\n          predictability: 'medium',\n          response_time: 'fast',\n          ramp_rate: 'high'\n        },\n        market_participation: {\n          energy_market: true,\n          capacity_market: false,\n          ancillary_services: ['demand_response']\n        }\n      },\n      chp_unit: {\n        name: 'çƒ­ç”µè”äº§',\n        category: 'controllable_generation',\n        characteristics: {\n          variability: 'controllable',\n          predictability: 'high',\n          response_time: 'medium',\n          ramp_rate: 'medium'\n        },\n        market_participation: {\n          energy_market: true,\n          capacity_market: true,\n          ancillary_services: ['spinning_reserve', 'voltage_support']\n        }\n      }\n    };\n    \n    // ç”µåŠ›å¸‚åœºç±»å‹\n    this.marketTypes = {\n      day_ahead: {\n        name: 'æ—¥å‰å¸‚åœº',\n        trading_horizon: '24h',\n        settlement_period: '15min',\n        gate_closure: '12h_before',\n        price_volatility: 'medium'\n      },\n      intraday: {\n        name: 'æ—¥å†…å¸‚åœº',\n        trading_horizon: '4h',\n        settlement_period: '15min',\n        gate_closure: '1h_before',\n        price_volatility: 'high'\n      },\n      real_time: {\n        name: 'å®æ—¶å¸‚åœº',\n        trading_horizon: '1h',\n        settlement_period: '5min',\n        gate_closure: '5min_before',\n        price_volatility: 'very_high'\n      },\n      capacity: {\n        name: 'å®¹é‡å¸‚åœº',\n        trading_horizon: '1year',\n        settlement_period: '1month',\n        gate_closure: '3months_before',\n        price_volatility: 'low'\n      }\n    };\n    \n    // è¾…åŠ©æœåŠ¡ç±»å‹\n    this.ancillaryServiceTypes = {\n      frequency_regulation: {\n        name: 'é¢‘ç‡è°ƒèŠ‚',\n        response_time: '4s',\n        duration: 'continuous',\n        payment_structure: 'capacity_and_energy',\n        technical_requirements: {\n          min_capacity: 1, // MW\n          response_accuracy: 0.95,\n          availability: 0.98\n        }\n      },\n      spinning_reserve: {\n        name: 'æ—‹è½¬å¤‡ç”¨',\n        response_time: '10min',\n        duration: '30min-2h',\n        payment_structure: 'capacity',\n        technical_requirements: {\n          min_capacity: 5,\n          response_accuracy: 0.9,\n          availability: 0.95\n        }\n      },\n      non_spinning_reserve: {\n        name: 'éæ—‹è½¬å¤‡ç”¨',\n        response_time: '30min',\n        duration: '2h',\n        payment_structure: 'capacity',\n        technical_requirements: {\n          min_capacity: 10,\n          response_accuracy: 0.85,\n          availability: 0.9\n        }\n      },\n      voltage_support: {\n        name: 'ç”µå‹æ”¯æ’‘',\n        response_time: '1s',\n        duration: 'continuous',\n        payment_structure: 'capacity',\n        technical_requirements: {\n          min_capacity: 2,\n          response_accuracy: 0.98,\n          availability: 0.99\n        }\n      },\n      black_start: {\n        name: 'é»‘å¯åŠ¨',\n        response_time: '15min',\n        duration: '4h',\n        payment_structure: 'availability',\n        technical_requirements: {\n          min_capacity: 50,\n          self_start_capability: true,\n          availability: 0.99\n        }\n      }\n    };\n    \n    // èšåˆç­–ç•¥\n    this.aggregationStrategies = {\n      homogeneous: {\n        name: 'åŒè´¨åŒ–èšåˆ',\n        description: 'èšåˆç›¸åŒç±»å‹çš„åˆ†å¸ƒå¼èµ„æº',\n        advantages: ['ç®¡ç†ç®€å•', 'é¢„æµ‹å‡†ç¡®'],\n        disadvantages: ['å¤šæ ·æ€§ä¸è¶³', 'é£é™©é›†ä¸­']\n      },\n      heterogeneous: {\n        name: 'å¼‚è´¨åŒ–èšåˆ',\n        description: 'èšåˆä¸åŒç±»å‹çš„åˆ†å¸ƒå¼èµ„æº',\n        advantages: ['é£é™©åˆ†æ•£', 'äº’è¡¥æ€§å¼º'],\n        disadvantages: ['ç®¡ç†å¤æ‚', 'é¢„æµ‹å›°éš¾']\n      },\n      geographic: {\n        name: 'åœ°ç†ä½ç½®èšåˆ',\n        description: 'æŒ‰åœ°ç†ä½ç½®èšåˆåˆ†å¸ƒå¼èµ„æº',\n        advantages: ['ç½‘ç»œçº¦æŸè€ƒè™‘', 'æœ¬åœ°å¹³è¡¡'],\n        disadvantages: ['è§„æ¨¡å—é™', 'èµ„æºä¸å‡']\n      },\n      market_oriented: {\n        name: 'å¸‚åœºå¯¼å‘èšåˆ',\n        description: 'æŒ‰å¸‚åœºå‚ä¸èƒ½åŠ›èšåˆ',\n        advantages: ['å¸‚åœºé€‚åº”æ€§å¼º', 'æ”¶ç›Šæœ€å¤§åŒ–'],\n        disadvantages: ['æŠ€æœ¯è¦æ±‚é«˜', 'é£é™©è¾ƒå¤§']\n      }\n    };\n    \n    this.init();\n  }\n\n  async init() {\n    try {\n      await this.initializeDistributedResources();\n      await this.setupAggregationGroups();\n      await this.initializeForecastModels();\n      await this.setupTradingStrategies();\n      await this.startRealTimeOperations();\n      \n      this.isInitialized = true;\n      logger.info('è™šæ‹Ÿç”µå‚è¿è¥ä¸äº¤æ˜“ä¸­å¿ƒåˆå§‹åŒ–å®Œæˆ');\n      this.emit('initialized');\n    } catch (error) {\n      logger.error('è™šæ‹Ÿç”µå‚ä¸­å¿ƒåˆå§‹åŒ–å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * èšåˆåˆ†å¸ƒå¼èƒ½æºèµ„æº\n   * @param {string} parkId - å›­åŒºID\n   * @param {Array} resources - åˆ†å¸ƒå¼èµ„æºåˆ—è¡¨\n   * @param {string} strategy - èšåˆç­–ç•¥\n   * @returns {Object} èšåˆç»“æœ\n   */\n  async aggregateDistributedResources(parkId, resources, strategy = 'heterogeneous') {\n    try {\n      const aggregationId = this.generateAggregationId(parkId, strategy);\n      \n      // èµ„æºè¯„ä¼°å’Œç­›é€‰\n      const qualifiedResources = await this.assessResourceQualification(resources);\n      \n      // æ‰§è¡Œèšåˆç­–ç•¥\n      const aggregationResult = await this.executeAggregationStrategy(\n        qualifiedResources,\n        strategy\n      );\n      \n      // è®¡ç®—èšåˆå®¹é‡å’Œç‰¹æ€§\n      const aggregatedCapacity = this.calculateAggregatedCapacity(aggregationResult.groups);\n      \n      // å»ºç«‹æ§åˆ¶å’Œé€šä¿¡æ¶æ„\n      const controlArchitecture = await this.establishControlArchitecture(aggregationResult.groups);\n      \n      // åˆ¶å®šè¿è¥ç­–ç•¥\n      const operationalStrategy = this.developOperationalStrategy(\n        aggregatedCapacity,\n        controlArchitecture\n      );\n      \n      // è¯„ä¼°å¸‚åœºå‚ä¸èƒ½åŠ›\n      const marketCapability = await this.assessMarketCapability(\n        aggregatedCapacity,\n        operationalStrategy\n      );\n      \n      const result = {\n        aggregation_id: aggregationId,\n        park_id: parkId,\n        aggregation_time: new Date().toISOString(),\n        strategy: strategy,\n        \n        // èšåˆèµ„æº\n        qualified_resources: qualifiedResources,\n        aggregation_groups: aggregationResult.groups,\n        \n        // èšåˆå®¹é‡\n        aggregated_capacity: aggregatedCapacity,\n        \n        // æ§åˆ¶æ¶æ„\n        control_architecture: controlArchitecture,\n        \n        // è¿è¥ç­–ç•¥\n        operational_strategy: operationalStrategy,\n        \n        // å¸‚åœºèƒ½åŠ›\n        market_capability: marketCapability,\n        \n        // æŠ€æœ¯æŒ‡æ ‡\n        technical_metrics: {\n          total_capacity: aggregatedCapacity.total_capacity,\n          response_time: this.calculateAggregatedResponseTime(aggregationResult.groups),\n          ramp_rate: this.calculateAggregatedRampRate(aggregationResult.groups),\n          availability: this.calculateAggregatedAvailability(aggregationResult.groups),\n          reliability: this.calculateAggregatedReliability(aggregationResult.groups)\n        },\n        \n        // ç»æµæŒ‡æ ‡\n        economic_metrics: {\n          aggregation_cost: this.calculateAggregationCost(aggregationResult),\n          operational_cost: this.calculateOperationalCost(operationalStrategy),\n          revenue_potential: this.calculateRevenuePotential(marketCapability),\n          payback_period: this.calculatePaybackPeriod(aggregationResult)\n        },\n        \n        // é£é™©è¯„ä¼°\n        risk_assessment: {\n          technical_risks: this.assessTechnicalRisks(aggregationResult),\n          market_risks: this.assessMarketRisks(marketCapability),\n          operational_risks: this.assessOperationalRisks(operationalStrategy)\n        }\n      };\n      \n      // å­˜å‚¨èšåˆç»“æœ\n      this.aggregationGroups.set(aggregationId, result);\n      \n      logger.info(`åˆ†å¸ƒå¼èµ„æºèšåˆå®Œæˆ: ${aggregationId}, æ€»å®¹é‡: ${aggregatedCapacity.total_capacity}MW`);\n      this.emit('aggregation_completed', result);\n      \n      return result;\n    } catch (error) {\n      logger.error('èšåˆåˆ†å¸ƒå¼èƒ½æºèµ„æºå¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * æ‰§è¡Œç”µåŠ›å¸‚åœºäº¤æ˜“\n   * @param {string} aggregationId - èšåˆID\n   * @param {string} marketType - å¸‚åœºç±»å‹\n   * @param {Object} tradingParams - äº¤æ˜“å‚æ•°\n   * @returns {Object} äº¤æ˜“ç»“æœ\n   */\n  async executeMarketTrading(aggregationId, marketType, tradingParams) {\n    try {\n      const tradingId = this.generateTradingId(aggregationId, marketType);\n      const aggregation = this.aggregationGroups.get(aggregationId);\n      \n      if (!aggregation) {\n        throw new Error(`èšåˆç»„ä¸å­˜åœ¨: ${aggregationId}`);\n      }\n      \n      // è·å–å¸‚åœºä¿¡æ¯\n      const marketInfo = await this.getMarketInformation(marketType);\n      \n      // ç”ŸæˆåŠŸç‡é¢„æµ‹\n      const powerForecast = await this.generatePowerForecast(\n        aggregation,\n        marketInfo.trading_horizon\n      );\n      \n      // åˆ¶å®šæŠ•æ ‡ç­–ç•¥\n      const biddingStrategy = await this.developBiddingStrategy(\n        aggregation,\n        marketInfo,\n        powerForecast,\n        tradingParams\n      );\n      \n      // æ‰§è¡ŒæŠ•æ ‡\n      const bidSubmission = await this.submitBids(\n        tradingId,\n        marketType,\n        biddingStrategy\n      );\n      \n      // ç­‰å¾…å¸‚åœºå‡ºæ¸…\n      const marketClearing = await this.waitForMarketClearing(\n        tradingId,\n        marketType\n      );\n      \n      // åˆ†æäº¤æ˜“ç»“æœ\n      const tradingAnalysis = this.analyzeTradingResults(\n        bidSubmission,\n        marketClearing,\n        powerForecast\n      );\n      \n      // æ›´æ–°å¸‚åœºå¤´å¯¸\n      await this.updateMarketPositions(\n        aggregationId,\n        marketType,\n        marketClearing\n      );\n      \n      const result = {\n        trading_id: tradingId,\n        aggregation_id: aggregationId,\n        market_type: marketType,\n        trading_time: new Date().toISOString(),\n        \n        // å¸‚åœºä¿¡æ¯\n        market_info: marketInfo,\n        \n        // åŠŸç‡é¢„æµ‹\n        power_forecast: powerForecast,\n        \n        // æŠ•æ ‡ç­–ç•¥\n        bidding_strategy: biddingStrategy,\n        \n        // æŠ•æ ‡æäº¤\n        bid_submission: bidSubmission,\n        \n        // å¸‚åœºå‡ºæ¸…\n        market_clearing: marketClearing,\n        \n        // äº¤æ˜“åˆ†æ\n        trading_analysis: tradingAnalysis,\n        \n        // è´¢åŠ¡ç»“æœ\n        financial_results: {\n          revenue: tradingAnalysis.total_revenue,\n          cost: tradingAnalysis.total_cost,\n          profit: tradingAnalysis.net_profit,\n          margin: tradingAnalysis.profit_margin\n        },\n        \n        // æ‰§è¡Œè®¡åˆ’\n        execution_plan: this.generateExecutionPlan(\n          marketClearing,\n          aggregation\n        ),\n        \n        // é£é™©æŒ‡æ ‡\n        risk_metrics: {\n          price_risk: tradingAnalysis.price_risk,\n          volume_risk: tradingAnalysis.volume_risk,\n          execution_risk: tradingAnalysis.execution_risk\n        }\n      };\n      \n      // å­˜å‚¨äº¤æ˜“ç»“æœ\n      this.marketPositions.set(tradingId, result);\n      \n      logger.info(`ç”µåŠ›å¸‚åœºäº¤æ˜“å®Œæˆ: ${tradingId}, æ”¶ç›Š: ${result.financial_results.profit}ä¸‡å…ƒ`);\n      this.emit('trading_completed', result);\n      \n      return result;\n    } catch (error) {\n      logger.error('æ‰§è¡Œç”µåŠ›å¸‚åœºäº¤æ˜“å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * æä¾›è¾…åŠ©æœåŠ¡\n   * @param {string} aggregationId - èšåˆID\n   * @param {string} serviceType - è¾…åŠ©æœåŠ¡ç±»å‹\n   * @param {Object} serviceParams - æœåŠ¡å‚æ•°\n   * @returns {Object} æœåŠ¡ç»“æœ\n   */\n  async provideAncillaryServices(aggregationId, serviceType, serviceParams) {\n    try {\n      const serviceId = this.generateServiceId(aggregationId, serviceType);\n      const aggregation = this.aggregationGroups.get(aggregationId);\n      \n      if (!aggregation) {\n        throw new Error(`èšåˆç»„ä¸å­˜åœ¨: ${aggregationId}`);\n      }\n      \n      // éªŒè¯æœåŠ¡èƒ½åŠ›\n      const serviceCapability = await this.verifyServiceCapability(\n        aggregation,\n        serviceType\n      );\n      \n      if (!serviceCapability.qualified) {\n        throw new Error(`ä¸æ»¡è¶³${serviceType}æœåŠ¡è¦æ±‚`);\n      }\n      \n      // åˆ¶å®šæœåŠ¡ç­–ç•¥\n      const serviceStrategy = await this.developServiceStrategy(\n        aggregation,\n        serviceType,\n        serviceParams\n      );\n      \n      // èµ„æºè°ƒåº¦å’Œæ§åˆ¶\n      const resourceScheduling = await this.scheduleResourcesForService(\n        aggregation,\n        serviceStrategy\n      );\n      \n      // æ‰§è¡ŒæœåŠ¡\n      const serviceExecution = await this.executeAncillaryService(\n        serviceId,\n        serviceType,\n        resourceScheduling\n      );\n      \n      // ç›‘æ§æœåŠ¡æ€§èƒ½\n      const performanceMonitoring = await this.monitorServicePerformance(\n        serviceId,\n        serviceType,\n        serviceExecution\n      );\n      \n      // è®¡ç®—æœåŠ¡æ”¶ç›Š\n      const serviceRevenue = this.calculateServiceRevenue(\n        serviceType,\n        performanceMonitoring,\n        serviceParams\n      );\n      \n      const result = {\n        service_id: serviceId,\n        aggregation_id: aggregationId,\n        service_type: serviceType,\n        service_time: new Date().toISOString(),\n        \n        // æœåŠ¡èƒ½åŠ›\n        service_capability: serviceCapability,\n        \n        // æœåŠ¡ç­–ç•¥\n        service_strategy: serviceStrategy,\n        \n        // èµ„æºè°ƒåº¦\n        resource_scheduling: resourceScheduling,\n        \n        // æœåŠ¡æ‰§è¡Œ\n        service_execution: serviceExecution,\n        \n        // æ€§èƒ½ç›‘æ§\n        performance_monitoring: performanceMonitoring,\n        \n        // æœåŠ¡æ”¶ç›Š\n        service_revenue: serviceRevenue,\n        \n        // æŠ€æœ¯æ€§èƒ½\n        technical_performance: {\n          response_accuracy: performanceMonitoring.response_accuracy,\n          response_time: performanceMonitoring.actual_response_time,\n          availability: performanceMonitoring.service_availability,\n          reliability: performanceMonitoring.service_reliability\n        },\n        \n        // ç»æµæ€§èƒ½\n        economic_performance: {\n          capacity_payment: serviceRevenue.capacity_payment,\n          energy_payment: serviceRevenue.energy_payment,\n          performance_bonus: serviceRevenue.performance_bonus,\n          total_revenue: serviceRevenue.total_revenue,\n          service_cost: serviceRevenue.service_cost,\n          net_profit: serviceRevenue.net_profit\n        },\n        \n        // åˆè§„æ€§æ£€æŸ¥\n        compliance_check: {\n          technical_compliance: this.checkTechnicalCompliance(performanceMonitoring, serviceType),\n          market_compliance: this.checkMarketCompliance(serviceExecution, serviceType),\n          regulatory_compliance: this.checkRegulatoryCompliance(result, serviceType)\n        }\n      };\n      \n      // å­˜å‚¨æœåŠ¡ç»“æœ\n      this.ancillaryServices.set(serviceId, result);\n      \n      logger.info(`è¾…åŠ©æœåŠ¡æä¾›å®Œæˆ: ${serviceId}, æ”¶ç›Š: ${result.economic_performance.net_profit}ä¸‡å…ƒ`);\n      this.emit('ancillary_service_completed', result);\n      \n      return result;\n    } catch (error) {\n      logger.error('æä¾›è¾…åŠ©æœåŠ¡å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ä¼˜åŒ–è™šæ‹Ÿç”µå‚è¿è¥\n   * @param {string} aggregationId - èšåˆID\n   * @param {Object} optimizationParams - ä¼˜åŒ–å‚æ•°\n   * @returns {Object} ä¼˜åŒ–ç»“æœ\n   */\n  async optimizeVPPOperation(aggregationId, optimizationParams) {\n    try {\n      const optimizationId = this.generateOptimizationId(aggregationId);\n      const aggregation = this.aggregationGroups.get(aggregationId);\n      \n      if (!aggregation) {\n        throw new Error(`èšåˆç»„ä¸å­˜åœ¨: ${aggregationId}`);\n      }\n      \n      // è·å–ä¼˜åŒ–æ—¶é—´èŒƒå›´å†…çš„é¢„æµ‹æ•°æ®\n      const forecastData = await this.getOptimizationForecastData(\n        aggregation,\n        optimizationParams.time_horizon\n      );\n      \n      // æ„å»ºä¼˜åŒ–é—®é¢˜\n      const optimizationProblem = this.buildVPPOptimizationProblem(\n        aggregation,\n        forecastData,\n        optimizationParams\n      );\n      \n      // æ‰§è¡Œå¤šç›®æ ‡ä¼˜åŒ–\n      const optimizationSolution = await this.solveVPPOptimization(\n        optimizationProblem\n      );\n      \n      // ç”Ÿæˆè¿è¥è®¡åˆ’\n      const operationalPlan = this.generateOperationalPlan(\n        optimizationSolution,\n        aggregation\n      );\n      \n      // é£é™©è¯„ä¼°å’Œè°ƒæ•´\n      const riskAdjustedPlan = await this.adjustPlanForRisks(\n        operationalPlan,\n        optimizationParams\n      );\n      \n      // åˆ¶å®šåº”æ€¥é¢„æ¡ˆ\n      const contingencyPlans = this.developContingencyPlans(\n        riskAdjustedPlan,\n        aggregation\n      );\n      \n      const result = {\n        optimization_id: optimizationId,\n        aggregation_id: aggregationId,\n        optimization_time: new Date().toISOString(),\n        time_horizon: optimizationParams.time_horizon,\n        \n        // é¢„æµ‹æ•°æ®\n        forecast_data: forecastData,\n        \n        // ä¼˜åŒ–é—®é¢˜\n        optimization_problem: {\n          objective_functions: optimizationProblem.objectives,\n          constraints: optimizationProblem.constraints,\n          decision_variables: optimizationProblem.variables\n        },\n        \n        // ä¼˜åŒ–è§£\n        optimization_solution: optimizationSolution,\n        \n        // è¿è¥è®¡åˆ’\n        operational_plan: riskAdjustedPlan,\n        \n        // åº”æ€¥é¢„æ¡ˆ\n        contingency_plans: contingencyPlans,\n        \n        // é¢„æœŸæ•ˆç›Š\n        expected_benefits: {\n          revenue_optimization: optimizationSolution.revenue_improvement,\n          cost_reduction: optimizationSolution.cost_reduction,\n          efficiency_gain: optimizationSolution.efficiency_improvement,\n          risk_mitigation: optimizationSolution.risk_reduction\n        },\n        \n        // å…³é”®ç»©æ•ˆæŒ‡æ ‡\n        kpis: {\n          capacity_factor: this.calculateCapacityFactor(riskAdjustedPlan),\n          revenue_per_mw: this.calculateRevenuePerMW(riskAdjustedPlan),\n          operational_efficiency: this.calculateOperationalEfficiency(riskAdjustedPlan),\n          market_participation_rate: this.calculateMarketParticipationRate(riskAdjustedPlan)\n        },\n        \n        // å®æ–½æŒ‡å¯¼\n        implementation_guidance: {\n          execution_sequence: this.defineExecutionSequence(riskAdjustedPlan),\n          resource_allocation: this.defineResourceAllocation(riskAdjustedPlan),\n          monitoring_points: this.defineMonitoringPoints(riskAdjustedPlan),\n          success_criteria: this.defineSuccessCriteria(optimizationParams)\n        }\n      };\n      \n      // å­˜å‚¨ä¼˜åŒ–ç»“æœ\n      this.optimizationResults.set(optimizationId, result);\n      \n      logger.info(`è™šæ‹Ÿç”µå‚è¿è¥ä¼˜åŒ–å®Œæˆ: ${optimizationId}, é¢„æœŸæ”¶ç›Šæå‡: ${result.expected_benefits.revenue_optimization}%`);\n      this.emit('vpp_optimization_completed', result);\n      \n      return result;\n    } catch (error) {\n      logger.error('ä¼˜åŒ–è™šæ‹Ÿç”µå‚è¿è¥å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * å¯åŠ¨å®æ—¶è¿è¥\n   */\n  async startRealTimeOperations() {\n    // æ¯5åˆ†é’Ÿæ›´æ–°èµ„æºçŠ¶æ€\n    setInterval(async () => {\n      try {\n        await this.updateResourceStatus();\n      } catch (error) {\n        logger.error('æ›´æ–°èµ„æºçŠ¶æ€å¤±è´¥:', error);\n      }\n    }, MATH_CONSTANTS.FIVE * MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND);\n    \n    // æ¯15åˆ†é’Ÿæ›´æ–°åŠŸç‡é¢„æµ‹\n    setInterval(async () => {\n      try {\n        await this.updatePowerForecasts();\n      } catch (error) {\n        logger.error('æ›´æ–°åŠŸç‡é¢„æµ‹å¤±è´¥:', error);\n      }\n    }, MATH_CONSTANTS.FIFTEEN * MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND);\n    \n    // æ¯å°æ—¶æ‰§è¡Œè¿è¥ä¼˜åŒ–\n    setInterval(async () => {\n      try {\n        await this.executeHourlyOptimization();\n      } catch (error) {\n        logger.error('æ‰§è¡Œå°æ—¶ä¼˜åŒ–å¤±è´¥:', error);\n      }\n    }, MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.SIXTY * MATH_CONSTANTS.MILLISECONDS_PER_SECOND);\n    \n    // å®æ—¶ç›‘æ§å¸‚åœºä¿¡å·\n    setInterval(async () => {\n      try {\n        await this.monitorMarketSignals();\n      } catch (error) {\n        logger.error('ç›‘æ§å¸‚åœºä¿¡å·å¤±è´¥:', error);\n      }\n    }, MATH_CONSTANTS.FIVE * MATH_CONSTANTS.MILLISECONDS_PER_SECOND * MATH_CONSTANTS.MILLISECONDS_PER_SECOND);\n  }\n\n  // èµ„æºè¯„ä¼°å’Œèšåˆæ–¹æ³•\n  async assessResourceQualification(resources) {\n    const qualified = [];\n    \n    for (const resource of resources) {\n      const qualification = await this.evaluateResourceQualification(resource);\n      \n      if (qualification.qualified) {\n        qualified.push({\n          ...resource,\n          qualification: qualification,\n          market_readiness: this.assessMarketReadiness(resource),\n          technical_capability: this.assessTechnicalCapability(resource)\n        });\n      }\n    }\n    \n    return qualified;\n  }\n\n  async executeAggregationStrategy(resources, strategy) {\n    switch (strategy) {\n      case 'homogeneous':\n        return this.executeHomogeneousAggregation(resources);\n      case 'heterogeneous':\n        return this.executeHeterogeneousAggregation(resources);\n      case 'geographic':\n        return this.executeGeographicAggregation(resources);\n      case 'market_oriented':\n        return this.executeMarketOrientedAggregation(resources);\n      default:\n        throw new Error(`æœªçŸ¥çš„èšåˆç­–ç•¥: ${strategy}`);\n    }\n  }\n\n  executeHeterogeneousAggregation(resources) {\n    const groups = [];\n    \n    // æŒ‰äº’è¡¥æ€§åˆ†ç»„\n    const generationResources = resources.filter(r => \n      ['solar_pv', 'wind_turbine', 'chp_unit'].includes(r.type)\n    );\n    const storageResources = resources.filter(r => \n      r.type === 'battery_storage'\n    );\n    const loadResources = resources.filter(r => \n      ['flexible_load', 'ev_charging'].includes(r.type)\n    );\n    \n    // åˆ›å»ºå¹³è¡¡ç»„åˆ\n    if (generationResources.length > 0 && storageResources.length > 0) {\n      groups.push({\n        id: 'generation_storage_group',\n        type: 'generation_storage',\n        resources: [...generationResources, ...storageResources],\n        characteristics: {\n          variability: 'medium',\n          controllability: 'high',\n          market_value: 'high'\n        }\n      });\n    }\n    \n    if (loadResources.length > 0) {\n      groups.push({\n        id: 'demand_response_group',\n        type: 'demand_response',\n        resources: loadResources,\n        characteristics: {\n          variability: 'low',\n          controllability: 'high',\n          market_value: 'medium'\n        }\n      });\n    }\n    \n    return { groups, strategy: 'heterogeneous' };\n  }\n\n  calculateAggregatedCapacity(groups) {\n    let totalCapacity = 0;\n    let totalGeneration = 0;\n    let totalStorage = 0;\n    let totalLoad = 0;\n    \n    const capacityByType = {};\n    \n    groups.forEach(group => {\n      group.resources.forEach(resource => {\n        totalCapacity += resource.capacity;\n        \n        if (!capacityByType[resource.type]) {\n          capacityByType[resource.type] = 0;\n        }\n        capacityByType[resource.type] += resource.capacity;\n        \n        switch (resource.category || this.resourceTypes[resource.type]?.category) {\n          case 'renewable_generation':\n          case 'controllable_generation':\n            totalGeneration += resource.capacity;\n            break;\n          case 'energy_storage':\n            totalStorage += resource.capacity;\n            break;\n          case 'demand_response':\n          case 'flexible_load':\n            totalLoad += resource.capacity;\n            break;\n        }\n      });\n    });\n    \n    return {\n      total_capacity: totalCapacity,\n      generation_capacity: totalGeneration,\n      storage_capacity: totalStorage,\n      load_capacity: totalLoad,\n      capacity_by_type: capacityByType,\n      diversity_index: this.calculateDiversityIndex(capacityByType),\n      flexibility_index: this.calculateFlexibilityIndex(groups)\n    };\n  }\n\n  // å¸‚åœºäº¤æ˜“æ–¹æ³•\n  async developBiddingStrategy(aggregation, marketInfo, forecast, params) {\n    const strategy = {\n      market_type: marketInfo.type,\n      bidding_approach: params.bidding_approach || 'price_taker',\n      risk_tolerance: params.risk_tolerance || 'medium',\n      \n      // ä»·æ ¼ç­–ç•¥\n      price_strategy: {\n        base_price: this.calculateBasePrice(forecast, marketInfo),\n        price_adjustment: this.calculatePriceAdjustment(aggregation, params),\n        price_limits: {\n          min_price: params.min_price || 0,\n          max_price: params.max_price || 1000\n        }\n      },\n      \n      // æ•°é‡ç­–ç•¥\n      quantity_strategy: {\n        base_quantity: this.calculateBaseQuantity(aggregation, forecast),\n        quantity_adjustment: this.calculateQuantityAdjustment(params),\n        quantity_limits: {\n          min_quantity: 0,\n          max_quantity: aggregation.aggregated_capacity.total_capacity\n        }\n      },\n      \n      // é£é™©ç®¡ç†\n      risk_management: {\n        hedging_ratio: params.hedging_ratio || 0.8,\n        stop_loss: params.stop_loss || 0.1,\n        position_limits: this.calculatePositionLimits(aggregation)\n      }\n    };\n    \n    return strategy;\n  }\n\n  async submitBids(tradingId, marketType, strategy) {\n    const bids = [];\n    \n    // æ ¹æ®ç­–ç•¥ç”ŸæˆæŠ•æ ‡æ›²çº¿\n    const biddingCurve = this.generateBiddingCurve(strategy);\n    \n    biddingCurve.forEach((point, index) => {\n      bids.push({\n        bid_id: `${tradingId}_${index}`,\n        price: point.price,\n        quantity: point.quantity,\n        type: point.type, // 'buy' or 'sell'\n        time_period: point.time_period,\n        submission_time: new Date().toISOString()\n      });\n    });\n    \n    // æ¨¡æ‹ŸæŠ•æ ‡æäº¤\n    const submission = {\n      trading_id: tradingId,\n      market_type: marketType,\n      bids: bids,\n      submission_time: new Date().toISOString(),\n      status: 'submitted'\n    };\n    \n    logger.info(`æŠ•æ ‡æäº¤å®Œæˆ: ${tradingId}, æŠ•æ ‡æ•°é‡: ${bids.length}`);\n    \n    return submission;\n  }\n\n  async waitForMarketClearing(tradingId, marketType) {\n    // æ¨¡æ‹Ÿç­‰å¾…å¸‚åœºå‡ºæ¸…\n    await new Promise(resolve => setTimeout(resolve, 2000));\n    \n    // æ¨¡æ‹Ÿå¸‚åœºå‡ºæ¸…ç»“æœ\n    const clearing = {\n      trading_id: tradingId,\n      market_type: marketType,\n      clearing_time: new Date().toISOString(),\n      clearing_price: 300 + Math.random() * 200, // 300-500å…ƒ/MWh\n      cleared_quantity: 50 + Math.random() * 100, // 50-150MW\n      market_status: 'cleared',\n      \n      // ä¸ªäººæŠ•æ ‡ç»“æœ\n      bid_results: this.generateBidResults(tradingId),\n      \n      // å¸‚åœºç»Ÿè®¡\n      market_statistics: {\n        total_supply: 1000 + Math.random() * 500,\n        total_demand: 950 + Math.random() * 600,\n        price_volatility: Math.random() * 0.2,\n        participation_rate: 0.8 + Math.random() * 0.15\n      }\n    };\n    \n    return clearing;\n  }\n\n  // è¾…åŠ©æœåŠ¡æ–¹æ³•\n  async verifyServiceCapability(aggregation, serviceType) {\n    const requirements = this.ancillaryServiceTypes[serviceType]?.technical_requirements;\n    \n    if (!requirements) {\n      return { qualified: false, reason: 'æœªçŸ¥çš„è¾…åŠ©æœåŠ¡ç±»å‹' };\n    }\n    \n    const capability = {\n      qualified: true,\n      reasons: [],\n      \n      // å®¹é‡æ£€æŸ¥\n      capacity_check: {\n        required: requirements.min_capacity,\n        available: aggregation.aggregated_capacity.total_capacity,\n        passed: aggregation.aggregated_capacity.total_capacity >= requirements.min_capacity\n      },\n      \n      // å“åº”æ—¶é—´æ£€æŸ¥\n      response_time_check: {\n        required: requirements.response_time || '10min',\n        available: aggregation.technical_metrics.response_time,\n        passed: this.compareResponseTime(\n          aggregation.technical_metrics.response_time,\n          requirements.response_time\n        )\n      },\n      \n      // å¯ç”¨æ€§æ£€æŸ¥\n      availability_check: {\n        required: requirements.availability,\n        available: aggregation.technical_metrics.availability,\n        passed: aggregation.technical_metrics.availability >= requirements.availability\n      }\n    };\n    \n    // æ£€æŸ¥æ˜¯å¦é€šè¿‡æ‰€æœ‰è¦æ±‚\n    if (!capability.capacity_check.passed) {\n      capability.qualified = false;\n      capability.reasons.push('å®¹é‡ä¸è¶³');\n    }\n    \n    if (!capability.response_time_check.passed) {\n      capability.qualified = false;\n      capability.reasons.push('å“åº”æ—¶é—´ä¸æ»¡è¶³è¦æ±‚');\n    }\n    \n    if (!capability.availability_check.passed) {\n      capability.qualified = false;\n      capability.reasons.push('å¯ç”¨æ€§ä¸æ»¡è¶³è¦æ±‚');\n    }\n    \n    return capability;\n  }\n\n  // ä¼˜åŒ–æ–¹æ³•\n  buildVPPOptimizationProblem(aggregation, forecastData, params) {\n    return {\n      // ç›®æ ‡å‡½æ•°\n      objectives: {\n        revenue_maximization: {\n          weight: params.revenue_weight || 0.6,\n          function: 'maximize_market_revenue'\n        },\n        cost_minimization: {\n          weight: params.cost_weight || 0.3,\n          function: 'minimize_operational_cost'\n        },\n        risk_minimization: {\n          weight: params.risk_weight || 0.1,\n          function: 'minimize_portfolio_risk'\n        }\n      },\n      \n      // çº¦æŸæ¡ä»¶\n      constraints: {\n        power_balance: 'generation + storage_discharge = load + storage_charge',\n        capacity_limits: 'resource_output <= resource_capacity',\n        ramp_rate_limits: 'power_change <= ramp_rate * time_interval',\n        energy_limits: 'storage_energy <= storage_capacity',\n        market_limits: 'bid_quantity <= available_capacity',\n        technical_limits: 'resource_operation within technical_envelope'\n      },\n      \n      // å†³ç­–å˜é‡\n      variables: {\n        generation_schedule: 'continuous',\n        storage_schedule: 'continuous',\n        load_schedule: 'continuous',\n        market_bids: 'continuous',\n        service_provision: 'binary'\n      },\n      \n      // é¢„æµ‹æ•°æ®\n      forecasts: forecastData,\n      \n      // æ—¶é—´èŒƒå›´\n      time_horizon: params.time_horizon,\n      time_resolution: params.time_resolution || '15min'\n    };\n  }\n\n  async solveVPPOptimization(problem) {\n    // ç®€åŒ–çš„ä¼˜åŒ–æ±‚è§£\n    // å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨ä¸“ä¸šçš„ä¼˜åŒ–æ±‚è§£å™¨\n    \n    const solution = {\n      optimal_value: 1000000 + Math.random() * 500000, // 100-150ä¸‡å…ƒ\n      \n      // ä¼˜åŒ–ç»“æœ\n      generation_schedule: this.generateOptimalGenerationSchedule(problem),\n      storage_schedule: this.generateOptimalStorageSchedule(problem),\n      market_participation: this.generateOptimalMarketParticipation(problem),\n      service_provision: this.generateOptimalServiceProvision(problem),\n      \n      // æ€§èƒ½æŒ‡æ ‡\n      revenue_improvement: 15 + Math.random() * 10, // 15-25%\n      cost_reduction: 8 + Math.random() * 7, // 8-15%\n      efficiency_improvement: 5 + Math.random() * 5, // 5-10%\n      risk_reduction: 10 + Math.random() * 10, // 10-20%\n      \n      // æ±‚è§£ä¿¡æ¯\n      solver_info: {\n        algorithm: 'mixed_integer_programming',\n        iterations: 100 + Math.floor(Math.random() * 200),\n        solve_time: 5 + Math.random() * 10, // 5-15ç§’\n        optimality_gap: Math.random() * 0.01 // 0-1%\n      }\n    };\n    \n    return solution;\n  }\n\n  // è¾…åŠ©æ–¹æ³•\n  generateAggregationId(parkId, strategy) {\n    return `VPP_AGG_${parkId}_${strategy}_${Date.now()}`;\n  }\n\n  generateTradingId(aggregationId, marketType) {\n    return `VPP_TRADE_${aggregationId}_${marketType}_${Date.now()}`;\n  }\n\n  generateServiceId(aggregationId, serviceType) {\n    return `VPP_SVC_${aggregationId}_${serviceType}_${Date.now()}`;\n  }\n\n  generateOptimizationId(aggregationId) {\n    return `VPP_OPT_${aggregationId}_${Date.now()}`;\n  }\n\n  // æ¨¡æ‹Ÿæ•°æ®è·å–æ–¹æ³•\n  async initializeDistributedResources() {\n    const resources = [\n      {\n        id: 'solar_001',\n        type: 'solar_pv',\n        capacity: 100,\n        location: { lat: 39.9042, lng: 116.4074 },\n        owner: 'park_operator'\n      },\n      {\n        id: 'battery_001',\n        type: 'battery_storage',\n        capacity: 50,\n        location: { lat: 39.9042, lng: 116.4074 },\n        owner: 'park_operator'\n      }\n    ];\n    \n    resources.forEach(resource => {\n      this.distributedResources.set(resource.id, resource);\n    });\n    \n    logger.info(`å·²åˆå§‹åŒ–åˆ†å¸ƒå¼èµ„æº ${resources.length} ä¸ª`);\n  }\n\n  async setupAggregationGroups() {\n    // è®¾ç½®é»˜è®¤èšåˆç»„\n    logger.info('èšåˆç»„è®¾ç½®å®Œæˆ');\n  }\n\n  async initializeForecastModels() {\n    const models = {\n      solar_forecast: { accuracy: 0.85, horizon: '48h' },\n      wind_forecast: { accuracy: 0.75, horizon: '24h' },\n      load_forecast: { accuracy: 0.9, horizon: '72h' },\n      price_forecast: { accuracy: 0.7, horizon: '24h' }\n    };\n    \n    Object.keys(models).forEach(model => {\n      this.forecastModels.set(model, models[model]);\n    });\n    \n    logger.info('é¢„æµ‹æ¨¡å‹åˆå§‹åŒ–å®Œæˆ');\n  }\n\n  async setupTradingStrategies() {\n    const strategies = {\n      conservative: { risk_tolerance: 'low', return_target: 0.08 },\n      moderate: { risk_tolerance: 'medium', return_target: 0.12 },\n      aggressive: { risk_tolerance: 'high', return_target: 0.18 }\n    };\n    \n    Object.keys(strategies).forEach(strategy => {\n      this.tradingStrategies.set(strategy, strategies[strategy]);\n    });\n    \n    logger.info('äº¤æ˜“ç­–ç•¥è®¾ç½®å®Œæˆ');\n  }\n\n  async updateResourceStatus() {\n    // æ›´æ–°æ‰€æœ‰èµ„æºçŠ¶æ€\n    for (const [id, resource] of this.distributedResources) {\n      const status = await this.getResourceRealTimeStatus(id);\n      resource.current_status = status;\n    }\n  }\n\n  async updatePowerForecasts() {\n    // æ›´æ–°åŠŸç‡é¢„æµ‹\n    for (const [id, model] of this.forecastModels) {\n      const forecast = await this.generateForecast(id);\n      model.latest_forecast = forecast;\n    }\n  }\n\n  async executeHourlyOptimization() {\n    // æ‰§è¡Œå°æ—¶ä¼˜åŒ–\n    for (const [id, aggregation] of this.aggregationGroups) {\n      try {\n        await this.optimizeVPPOperation(id, { time_horizon: '4h' });\n      } catch (error) {\n        logger.error(`èšåˆç»„ ${id} ä¼˜åŒ–å¤±è´¥:`, error);\n      }\n    }\n  }\n\n  async monitorMarketSignals() {\n    // ç›‘æ§å¸‚åœºä¿¡å·\n    const signals = await this.getMarketSignals();\n    \n    signals.forEach(signal => {\n      if (signal.type === 'price_spike' && signal.value > 800) {\n        this.emit('market_alert', {\n          type: 'high_price',\n          value: signal.value,\n          action: 'increase_generation'\n        });\n      }\n    });\n  }\n\n  async getResourceRealTimeStatus(resourceId) {\n    return {\n      power_output: 50 + Math.random() * 50,\n      availability: 0.95 + Math.random() * 0.05,\n      efficiency: 0.9 + Math.random() * 0.05,\n      temperature: 25 + Math.random() * 10,\n      last_update: new Date().toISOString()\n    };\n  }\n\n  async generateForecast(modelId) {\n    const hours = 24;\n    const forecast = [];\n    \n    for (let i = 0; i < hours; i++) {\n      forecast.push({\n        hour: i,\n        value: 50 + 30 * Math.sin(i * Math.PI / 12) + Math.random() * 20,\n        confidence: 0.8 + Math.random() * 0.15\n      });\n    }\n    \n    return forecast;\n  }\n\n  async getMarketSignals() {\n    return [\n      {\n        type: 'price_update',\n        value: 400 + Math.random() * 300,\n        timestamp: new Date().toISOString()\n      },\n      {\n        type: 'demand_forecast',\n        value: 2000 + Math.random() * 500,\n        timestamp: new Date().toISOString()\n      }\n    ];\n  }\n\n  // å…¶ä»–è®¡ç®—æ–¹æ³•çš„ç®€åŒ–å®ç°\n  calculateDiversityIndex(capacityByType) {\n    const types = Object.keys(capacityByType);\n    const totalCapacity = Object.values(capacityByType).reduce((sum, cap) => sum + cap, 0);\n    \n    let diversity = 0;\n    types.forEach(type => {\n      const share = capacityByType[type] / totalCapacity;\n      diversity -= share * Math.log(share);\n    });\n    \n    return diversity / Math.log(types.length); // å½’ä¸€åŒ–åˆ°0-1\n  }\n\n  calculateFlexibilityIndex(groups) {\n    let totalFlexibility = 0;\n    let totalCapacity = 0;\n    \n    groups.forEach(group => {\n      group.resources.forEach(resource => {\n        const flexibility = this.getResourceFlexibility(resource.type);\n        totalFlexibility += flexibility * resource.capacity;\n        totalCapacity += resource.capacity;\n      });\n    });\n    \n    return totalCapacity > 0 ? totalFlexibility / totalCapacity : 0;\n  }\n\n  getResourceFlexibility(resourceType) {\n    const flexibilityMap = {\n      solar_pv: 0.2,\n      wind_turbine: 0.3,\n      battery_storage: 1.0,\n      flexible_load: 0.8,\n      ev_charging: 0.7,\n      chp_unit: 0.6\n    };\n    \n    return flexibilityMap[resourceType] || 0.5;\n  }\n}\n\nexport default VirtualPowerPlantCenter;","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/batteryOptimization.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":13,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.001.","line":54,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":54,"endColumn":35},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":91,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":91,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2067,2109],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":172,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":172,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3863,3903],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":187,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":187,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":196,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":196,"endColumn":30},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":229,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":229,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5257,5289],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":233,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":233,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":243,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":243,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":271,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":271,"endColumn":18},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 22.","line":271,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":271,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.2.","line":272,"column":13,"nodeType":"Literal","messageId":"noMagic","endLine":272,"endColumn":16},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.3.","line":272,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":272,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":273,"column":13,"nodeType":"Literal","messageId":"noMagic","endLine":273,"endColumn":16},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.3.","line":273,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":273,"endColumn":38},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":282,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":282,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6508,6550],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":301,"column":9,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":301,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 150.","line":301,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":301,"column":76,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":79},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":301,"column":82,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":84},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":310,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":310,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7261,7306],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.3.","line":324,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":324,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":326,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":326,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.7.","line":337,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":337,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.9.","line":337,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":337,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.7.","line":339,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":339,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.2.","line":341,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":341,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.2.","line":352,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":352,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":352,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":352,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":352,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":352,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":352,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":352,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":394,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":394,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":395,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":395,"endColumn":70},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.2.","line":401,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":401,"endColumn":20},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.3.","line":401,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":401,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":401,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":401,"endColumn":66},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":411,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":411,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.7.","line":411,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":411,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":411,"column":72,"nodeType":"Literal","messageId":"noMagic","endLine":411,"endColumn":73},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":421,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":421,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.6.","line":430,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":430,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":439,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":439,"endColumn":28},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":449,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":449,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12078,12122],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":458,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":458,"endColumn":56},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":487,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":487,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[13019,13063],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":501,"column":11,"nodeType":"Literal","messageId":"noMagic","endLine":501,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":501,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":501,"endColumn":18},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":501,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":501,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":502,"column":11,"nodeType":"Literal","messageId":"noMagic","endLine":502,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":502,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":502,"endColumn":18},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":502,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":502,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":502,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":502,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":503,"column":11,"nodeType":"Literal","messageId":"noMagic","endLine":503,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":503,"column":15,"nodeType":"Literal","messageId":"noMagic","endLine":503,"endColumn":17},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":503,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":503,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":503,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":503,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":503,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":503,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":590,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":590,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":590,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":590,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.001.","line":622,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":622,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":641,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":641,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":648,"column":80,"nodeType":"Literal","messageId":"noMagic","endLine":648,"endColumn":82},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":648,"column":84,"nodeType":"Literal","messageId":"noMagic","endLine":648,"endColumn":85},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":649,"column":74,"nodeType":"Literal","messageId":"noMagic","endLine":649,"endColumn":76},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":649,"column":78,"nodeType":"Literal","messageId":"noMagic","endLine":649,"endColumn":79},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":675,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":675,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[17508,17613],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":691,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":691,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[17906,17941],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":699,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":699,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[18115,18155],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":71,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// å¼•å…¥å¿…è¦çš„æ¨¡å—\nimport * as tf from '@tensorflow/tfjs-node';\nimport fs from 'fs/promises';\n\n// å‚¨èƒ½è®¾å¤‡çŠ¶æ€æ¨¡æ‹Ÿæ•°æ®\nconst batteryStatusData = [\n  { timestamp: '2025-06-01T00:00:00Z', soc: 0.8, power: 50, voltage: 400 },\n  { timestamp: '2025-06-01T01:00:00Z', soc: 0.75, power: 60, voltage: 395 }\n  // ... æ›´å¤šå†å²æ•°æ®\n];\n\n// å‡†å¤‡è®­ç»ƒæ•°æ®\nfunction _prepareTrainingData(data, windowSize = 24) {\n  const xs = [];\n  const ys = [];\n\n  for (let i = windowSize; i < data.length; i++) {\n    const window = data.slice(i - windowSize, i).map((d) => d.soc);\n    xs.push(window);\n    ys.push(data[i].soc);\n  }\n\n  return {\n    xs: tf.tensor2d(xs, [xs.length, windowSize]),\n    ys: tf.tensor2d(ys, [ys.length, 1])\n  };\n}\n\n// åˆ›å»ºLSTMæ¨¡å‹\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\nfunction _createModel(inputShape) {\n  const model = tf.sequential();\n\n  model.add(\n    tf.layers.lstm({\n      units: 64,\n      inputShape,\n      returnSequences: false\n    })\n  );\n\n  model.add(tf.layers.dense({ units: 32, activation: 'relu' }));\n  model.add(tf.layers.dense({ units: 1 }));\n\n  model.compile({\n    optimizer: tf.train.adam(0.001),\n    loss: 'meanSquaredError'\n  });\n\n  return model;\n}\n\n// åŠ è½½è®­ç»ƒæ•°æ®\nasync function _loadMockTrainingData() {\n  const fs = require('fs').promises;\n  const csv = require('csv-parser');\n  const results = [];\n\n  try {\n    const data = await fs.readFile(\n      '/Users/xunan/Documents/WebStormProjects/0C/test-data/battery_data.csv',\n      'utf8'\n    );\n\n    // è§£æCSVæ•°æ®\n    return new Promise((resolve, reject) => {\n      require('stream')\n        .Readable.from(data)\n        .pipe(csv())\n        .on('data', (data) =>\n          results.push({\n            timestamp: data.timestamp,\n            soc: parseFloat(data.soc),\n            power: parseFloat(data.power),\n            voltage: parseFloat(data.voltage),\n            temperature: parseFloat(data.temperature)\n          })\n        )\n        .on('end', () => resolve(results))\n        .on('error', reject);\n    });\n  } catch (error) {\n    console.error('åŠ è½½è®­ç»ƒæ•°æ®å¤±è´¥:', error.message);\n    throw new Error('TRAINING_DATA_LOAD_FAILED');\n  }\n}\n\n// é¢„å¤„ç†æ•°æ®\nfunction preprocessTrainingData(data) {\n  // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§\n  if (!data || data.length === 0) {\n    throw new Error('EMPTY_TRAINING_DATA');\n  }\n\n  // æå–ç‰¹å¾å’Œæ ‡ç­¾\n  const features = [];\n  const labels = [];\n\n  // ä½¿ç”¨è¿‡å»24ä¸ªæ—¶é—´æ­¥çš„æ•°æ®é¢„æµ‹ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥çš„SOC\n  const windowSize = 24;\n\n  for (let i = windowSize; i < data.length; i++) {\n    // æå–ç‰¹å¾çª—å£\n    const window = data.slice(i - windowSize, i);\n    const featureRow = [];\n\n    // ä¸ºæ¯ä¸ªæ—¶é—´æ­¥æå–ç‰¹å¾\n    window.forEach((point) => {\n      featureRow.push(point.soc);\n      featureRow.push(point.power);\n      featureRow.push(point.voltage);\n      featureRow.push(point.temperature);\n    });\n\n    features.push(featureRow);\n    labels.push([data[i].soc]); // é¢„æµ‹ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥çš„SOC\n  }\n\n  // æ•°æ®å½’ä¸€åŒ–\n  const featureTensor = tf.tensor2d(features);\n  const labelTensor = tf.tensor2d(labels);\n\n  // è®¡ç®—ç‰¹å¾çš„å‡å€¼å’Œæ ‡å‡†å·®\n  const featureMean = featureTensor.mean(0);\n  const featureStd = featureTensor.std(0);\n\n  // æ ‡å‡†åŒ–ç‰¹å¾ (é¿å…é™¤ä»¥é›¶)\n  const epsilon = 1e-8;\n  const normalizedFeatures = featureTensor.sub(featureMean).div(featureStd.add(epsilon));\n\n  // ä¿å­˜å½’ä¸€åŒ–å‚æ•°ä¾›æ¨ç†æ—¶ä½¿ç”¨\n  // ä¿å­˜å½’ä¸€åŒ–å‚æ•°ä¾›æ¨ç†æ—¶ä½¿ç”¨\n  (async () => {\n    global.batteryModelStats = {\n      mean: await featureMean.array(),\n      std: await featureStd.array()\n    };\n  })();\n\n  return {\n    features: normalizedFeatures,\n    labels: labelTensor\n  };\n}\n\n// è®­ç»ƒå‚¨èƒ½ä¼˜åŒ–æ¨¡å‹\nexport async function trainModel() {\n  try {\n    // åŠ è½½è®­ç»ƒæ•°æ®\n    const data = await loadTrainingData();\n\n    // é¢„å¤„ç†æ•°æ®\n    const { features, labels } = preprocessTrainingData(data);\n\n    // åˆ›å»ºæ¨¡å‹\n    const model = createBatteryOptimizationModel();\n\n    // è®­ç»ƒæ¨¡å‹\n    await trainBatteryOptimizationModel(model, features, labels);\n\n    // ä¿å­˜æ¨¡å‹\n    await saveModel(model);\n  } catch (error) {\n    console.error('æ¨¡å‹è®­ç»ƒå¤±è´¥:', error.message);\n    throw error;\n  }\n}\n\n// åˆ›å»ºå‚¨èƒ½ä¼˜åŒ–è·¯ç”±\nexport function setupBatteryRoutes(app, authenticateToken) {\n  // å‚¨èƒ½ä¼˜åŒ–æ¥å£\n  app.get('/battery/optimization', authenticateToken(), async (req, res) => {\n    try {\n      // è·å–æŸ¥è¯¢å‚æ•°\n      const { buildingId, start_time, end_time, interval } = req.query;\n\n      // å‚æ•°éªŒè¯\n      if (!buildingId) {\n        return res.status(400).json({\n          error: {\n            code: 'MISSING_BUILDING_ID',\n            message: 'ç¼ºå°‘å¿…è¦å‚æ•°: buildingId'\n          }\n        });\n      }\n\n      if (!start_time || !end_time) {\n        return res.status(400).json({\n          error: {\n            code: 'INVALID_TIME_RANGE',\n            message: 'ç¼ºå°‘å¿…è¦æ—¶é—´å‚æ•°: start_time, end_time'\n          }\n        });\n      }\n\n      // è°ƒç”¨ä¼˜åŒ–æ¨¡å‹ - æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®\n      const optimization = {\n        buildingId,\n        timeRange: { start_time, end_time },\n        interval: interval || '1h',\n        strategies: [\n          {\n            timestamp: start_time,\n            strategy: 'charge',\n            description: `å»ºè®®åœ¨ä½ç”µä»·æ—¶æ®µå……ç”µ`,\n            priority: 8,\n            economicImpact: 'é¢„è®¡èŠ‚çœæˆæœ¬: 50å…ƒ',\n            carbonImpact: 'é¢„è®¡å‡å°‘ç¢³æ’æ”¾: 25kgCO2'\n          }\n        ],\n        summary: {\n          totalSavings: 150,\n          carbonReduction: 75,\n          efficiency: 0.92\n        }\n      };\n\n      // è¿”å›ä¼˜åŒ–ç»“æœ\n      res.json(optimization);\n    } catch (error) {\n      console.error('å‚¨èƒ½ä¼˜åŒ–é”™è¯¯:', error);\n\n      // å¦‚æœå·²ç»æ˜¯ç‰¹å®šé”™è¯¯å“åº”ï¼Œç›´æ¥è¿”å›\n      if (error.code && error.message) {\n        return res.status(500).json({\n          error: {\n            code: error.code,\n            message: error.message,\n            details: error.stack\n          }\n        });\n      }\n\n      // å¦åˆ™è¿”å›é€šç”¨é”™è¯¯\n      res.status(500).json({\n        error: {\n          code: 'INTERNAL_SERVER_ERROR',\n          message: 'å‚¨èƒ½ä¼˜åŒ–å¤±è´¥',\n          details: error.message\n        }\n      });\n    }\n  });\n\n  // è¿”å›appå¯¹è±¡ä»¥ä¾¿é“¾å¼è°ƒç”¨\n  return app;\n}\n\n// è·å–ç”µä»·æ•°æ®\nasync function getElectricityPrices(startTime, endTime) {\n  try {\n    // å®é™…åº”ç”¨ä¸­åº”ä»APIè·å–å®æ—¶ç”µä»·æ•°æ®\n    // æ­¤å¤„ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®\n    const prices = [];\n    const start = new Date(startTime);\n    const end = new Date(endTime);\n\n    // ç”Ÿæˆæ¯å°æ—¶ç”µä»· (0.5-1.5å…ƒ/åº¦)\n    for (let d = new Date(start); d <= new Date(end); d.setHours(d.getHours() + 1)) {\n      const hour = d.getHours();\n      // æ¨¡æ‹Ÿå³°è°·ç”µä»·: å³°æ—¶(8-22ç‚¹)é«˜ä»·ï¼Œè°·æ—¶(22-8ç‚¹)ä½ä»·\n      const price =\n        hour >= 8 && hour <= 22\n          ? 1.2 + Math.random() * 0.3 // å³°æ—¶: 1.2-1.5å…ƒ\n          : 0.5 + Math.random() * 0.3; // è°·æ—¶: 0.5-0.8å…ƒ\n\n      prices.push({\n        timestamp: d.toISOString(),\n        price: parseFloat(price.toFixed(2))\n      });\n    }\n    return prices;\n  } catch (error) {\n    console.error('è·å–ç”µä»·æ•°æ®å¤±è´¥:', error.message);\n    return [];\n  }\n}\n\n// è·å–ç¢³æ’æ”¾å› å­æ•°æ®\nasync function getCarbonIntensity(startTime, endTime) {\n  try {\n    // å®é™…åº”ç”¨ä¸­åº”ä»APIè·å–å®æ—¶ç¢³æ’æ”¾å› å­æ•°æ®\n    // æ­¤å¤„ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®\n    const intensities = [];\n    const start = new Date(startTime);\n    const end = new Date(endTime);\n\n    // ç”Ÿæˆæ¯å°æ—¶ç¢³æ’æ”¾å› å­ (300-800 gCO2/kWh)\n    for (let d = new Date(start); d <= new Date(end); d.setHours(d.getHours() + 1)) {\n      const hour = d.getHours();\n      // æ¨¡æ‹Ÿç¢³æ’æ”¾å› å­å˜åŒ–\n      const intensity =\n        500 + Math.sin((hour / 24) * Math.PI * 2) * 150 + (Math.random() * 100 - 50);\n\n      intensities.push({\n        timestamp: d.toISOString(),\n        intensity: parseFloat(intensity.toFixed(0))\n      });\n    }\n    return intensities;\n  } catch (error) {\n    console.error('è·å–ç¢³æ’æ”¾å› å­æ•°æ®å¤±è´¥:', error.message);\n    return [];\n  }\n}\n\n// è®¡ç®—å……æ”¾ç”µæˆæœ¬æ•ˆç›Š\nfunction calculateCostBenefit(soc, price, carbonIntensity, currentState) {\n  // ç”µæ± å‚æ•°\n  const batteryCapacity = 1000; // ç”µæ± å®¹é‡ kWh\n  const chargeEfficiency = 0.9; // å……ç”µæ•ˆç‡\n  const dischargeEfficiency = 0.9; // æ”¾ç”µæ•ˆç‡\n  const carbonPrice = 0.05; // ç¢³ä»· å…ƒ/gCO2\n\n  // è®¡ç®—æ½œåœ¨æ”¶ç›Š\n  if (currentState === 'low' || soc < 0.3) {\n    // éœ€è¦å……ç”µæ—¶ï¼Œè®¡ç®—æˆæœ¬\n    const requiredEnergy = batteryCapacity * (0.8 - soc);\n    const actualEnergyNeeded = requiredEnergy / chargeEfficiency;\n    const cost = actualEnergyNeeded * price;\n    const carbonEmission = actualEnergyNeeded * carbonIntensity;\n    const carbonCost = carbonEmission * carbonPrice;\n    const totalCost = cost + carbonCost;\n\n    return {\n      action: 'charge',\n      cost: totalCost,\n      carbonEmission,\n      benefitScore: price < 0.7 ? 8 : price < 0.9 ? 5 : 2 // ä»·æ ¼è¶Šä½ï¼Œå……ç”µæ”¶ç›Šè¶Šé«˜\n    };\n  } else if (currentState === 'high' || soc > 0.7) {\n    // éœ€è¦æ”¾ç”µæ—¶ï¼Œè®¡ç®—æ”¶ç›Š\n    const availableEnergy = batteryCapacity * (soc - 0.2);\n    const actualEnergyAvailable = availableEnergy * dischargeEfficiency;\n    const revenue = actualEnergyAvailable * price;\n    const carbonReduction = actualEnergyAvailable * carbonIntensity;\n    const carbonBenefit = carbonReduction * carbonPrice;\n    const totalBenefit = revenue + carbonBenefit;\n\n    return {\n      action: 'discharge',\n      benefit: totalBenefit,\n      carbonReduction,\n      benefitScore: price > 1.2 ? 9 : price > 1.0 ? 6 : 3 // ä»·æ ¼è¶Šé«˜ï¼Œæ”¾ç”µæ”¶ç›Šè¶Šé«˜\n    };\n  }\n\n  return { action: 'none', benefitScore: 0 };\n}\n\n// ç”Ÿæˆä¼˜åŒ–ç­–ç•¥\nasync function _generateOptimizationStrategies(\n  predictions,\n  interval,\n  buildingId,\n  startTime,\n  endTime\n) {\n  if (!predictions || predictions.length === 0) {\n    throw new Error('æ— æ•ˆçš„é¢„æµ‹æ•°æ®');\n  }\n\n  if (!interval || typeof interval !== 'string') {\n    interval = '1h'; // é»˜è®¤é—´éš”ä¸º1å°æ—¶\n  }\n\n  // è·å–ç”µä»·å’Œç¢³æ’æ”¾å› å­æ•°æ®\n  const [electricityPrices, carbonIntensities] = await Promise.all([\n    getElectricityPrices(startTime, endTime),\n    getCarbonIntensity(startTime, endTime)\n  ]);\n\n  const strategies = [];\n  let currentState = 'normal';\n\n  try {\n    predictions.forEach((soc, index) => {\n      if (typeof soc !== 'number') {\n        throw new Error(`æ— æ•ˆçš„é¢„æµ‹å€¼åœ¨ç´¢å¼• ${index}: ${soc}`);\n      }\n\n      const timestamp = calculatePredictionTime(index, interval);\n      // æŸ¥æ‰¾å¯¹åº”æ—¶é—´çš„ç”µä»·å’Œç¢³æ’æ”¾å› å­\n      const priceData = electricityPrices.find((p) => p.timestamp === timestamp);\n      const carbonData = carbonIntensities.find((c) => c.timestamp === timestamp);\n      const price = priceData ? priceData.price : 0.8;\n      const carbonIntensity = carbonData ? carbonData.intensity : 500;\n\n      // è®¡ç®—æˆæœ¬æ•ˆç›Š\n      const costBenefit = calculateCostBenefit(soc, price, carbonIntensity, currentState);\n\n      // æ ¹æ®SOCå€¼å’Œæˆæœ¬æ•ˆç›Šç”Ÿæˆä¼˜åŒ–ç­–ç•¥\n      if (soc < 0.2 || (soc < 0.3 && costBenefit.benefitScore > 7)) {\n        strategies.push({\n          timestamp,\n          strategy: 'charge',\n          description: `ç”µæ± ${buildingId}ç”µé‡è¿‡ä½(${soc.toFixed(2)}), å»ºè®®å……ç”µã€‚å½“å‰ç”µä»·: ${price.toFixed(2)}å…ƒ/åº¦, ç¢³æ’æ”¾å› å­: ${carbonIntensity}gCO2/kWh`,\n          priority: costBenefit.benefitScore,\n          economicImpact: `é¢„è®¡æˆæœ¬: ${costBenefit.cost ? costBenefit.cost.toFixed(2) : 'N/A'}å…ƒ`,\n          carbonImpact: `é¢„è®¡ç¢³æ’æ”¾: ${costBenefit.carbonEmission ? costBenefit.carbonEmission.toFixed(2) : 'N/A'}gCO2`\n        });\n        currentState = 'low';\n      } else if (soc > 0.8 || (soc > 0.7 && costBenefit.benefitScore > 7)) {\n        strategies.push({\n          timestamp,\n          strategy: 'discharge',\n          description: `ç”µæ± ${buildingId}ç”µé‡è¿‡é«˜(${soc.toFixed(2)}), å»ºè®®æ”¾ç”µã€‚å½“å‰ç”µä»·: ${price.toFixed(2)}å…ƒ/åº¦, ç¢³æ’æ”¾å› å­: ${carbonIntensity}gCO2/kWh`,\n          priority: costBenefit.benefitScore,\n          economicImpact: `é¢„è®¡æ”¶ç›Š: ${costBenefit.benefit ? costBenefit.benefit.toFixed(2) : 'N/A'}å…ƒ`,\n          carbonImpact: `é¢„è®¡ç¢³å‡æ’: ${costBenefit.carbonReduction ? costBenefit.carbonReduction.toFixed(2) : 'N/A'}gCO2`\n        });\n        currentState = 'high';\n      } else if (currentState === 'low' && soc > 0.5) {\n        strategies.push({\n          timestamp,\n          strategy: 'stop_charge',\n          description: `ç”µæ± ${buildingId}ç”µé‡å·²æ¢å¤(${soc.toFixed(2)}), åœæ­¢å……ç”µ`,\n          priority: 2,\n          economicImpact: 'æ— é¢å¤–æˆæœ¬'\n        });\n        currentState = 'normal';\n      } else if (currentState === 'high' && soc < 0.6) {\n        strategies.push({\n          timestamp,\n          strategy: 'stop_discharge',\n          description: `ç”µæ± ${buildingId}ç”µé‡å·²æ¢å¤(${soc.toFixed(2)}), åœæ­¢æ”¾ç”µ`,\n          priority: 2,\n          economicImpact: 'æ— é¢å¤–æ”¶ç›Š'\n        });\n        currentState = 'normal';\n      } else if (index % 24 === 0) {\n        strategies.push({\n          timestamp,\n          strategy: 'maintenance',\n          description: `ç”µæ± ${buildingId}æ¯æ—¥çŠ¶æ€ç»´æŠ¤æ£€æŸ¥`,\n          priority: 3\n        });\n      }\n    });\n  } catch (error) {\n    console.error(`ç”Ÿæˆä¼˜åŒ–ç­–ç•¥å¤±è´¥: ${error.message}`);\n    throw error;\n  }\n\n  // æŒ‰ä¼˜å…ˆçº§æ’åº\n  return strategies.sort((a, b) => a.priority - b.priority);\n}\n\n// å‡†å¤‡é¢„æµ‹è¾“å…¥æ•°æ®\nfunction _preparePredictionInput(data, _windowSize = 24) {\n  if (!data || data.length === 0) {\n    throw new Error('æ— æ•ˆçš„å†å²æ•°æ®');\n  }\n\n  try {\n    // ç¡®ä¿æ•°æ®æŒ‰æ—¶é—´æ’åº\n    const sortedData = data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));\n\n    // æå–SOCå€¼å¹¶è¿›è¡Œå½’ä¸€åŒ–\n    const socValues = sortedData.map((d) => d.soc);\n\n    // å¦‚æœæ•°æ®ä¸è¶³ä¸€ä¸ªçª—å£ï¼Œåˆ™ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ•°æ®\n    const windowSize = 24; // ä½¿ç”¨æ˜ç¡®çš„çª—å£å¤§å°\n    const inputData = socValues.slice(-windowSize);\n\n    // æ•°æ®å½’ä¸€åŒ–ï¼ˆç¡®ä¿å€¼åœ¨0-1ä¹‹é—´ï¼‰\n    const normalized = normalizeData(inputData);\n\n    // åˆ›å»ºå¼ é‡\n    const tensor = tf.tensor2d([normalized], [1, normalized.length]);\n\n    // éªŒè¯å¼ é‡å½¢çŠ¶\n    if (tensor.shape[1] !== windowSize) {\n      throw new Error(`è¾“å…¥æ•°æ®å½¢çŠ¶ä¸åŒ¹é…: éœ€è¦${windowSize}ä¸ªæ—¶é—´æ­¥ï¼Œä½†å¾—åˆ°${tensor.shape[1]}ä¸ª`);\n    }\n\n    return tensor;\n  } catch (error) {\n    console.error(`å‡†å¤‡é¢„æµ‹è¾“å…¥å¤±è´¥: ${error.message}`);\n    throw error;\n  }\n}\n\n// æ•°æ®å½’ä¸€åŒ–\nfunction normalizeData(data) {\n  const max = Math.max(...data);\n  return data.map((value) => value / max);\n}\n\n// è®¡ç®—é¢„æµ‹æ—¶é—´\nfunction calculatePredictionTime(baseTime, index, interval) {\n  const intervalMap = {\n    '1h': 60 * 60 * 1000,\n    '1d': 24 * 60 * 60 * 1000,\n    '1w': 7 * 24 * 60 * 60 * 1000\n  };\n\n  // å¦‚æœæ²¡æœ‰æä¾›åŸºå‡†æ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´\n  const baseTimestamp = baseTime ? new Date(baseTime).getTime() : Date.now();\n\n  if (isNaN(baseTimestamp)) {\n    throw new Error(`æ— æ•ˆçš„åŸºå‡†æ—¶é—´: ${baseTime}`);\n  }\n\n  const intervalMs = intervalMap[interval] || intervalMap['1h'];\n  const ms = baseTimestamp + (index + 1) * intervalMs;\n\n  return new Date(ms).toISOString();\n}\n\n// è·å–å†å²å‚¨èƒ½æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰\nfunction _getHistoricalBatteryData(start_time, end_time, buildingId) {\n  if (!start_time || !end_time) {\n    throw new Error('å¿…é¡»æä¾›å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');\n  }\n\n  // éªŒè¯æ—¶é—´æ ¼å¼\n  if (isNaN(Date.parse(start_time)) || isNaN(Date.parse(end_time))) {\n    throw new Error('æ— æ•ˆçš„æ—¶é—´æ ¼å¼ï¼Œåº”ä½¿ç”¨ISO 8601æ ¼å¼');\n  }\n\n  if (buildingId && typeof buildingId !== 'string') {\n    throw new Error('buildingIdå¿…é¡»æ˜¯å­—ç¬¦ä¸²');\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æŸ¥è¯¢æ•°æ®åº“\n      // å¹¶æ ¹æ®buildingIdã€start_timeå’Œend_timeè¿‡æ»¤æ•°æ®\n      const filteredData = batteryStatusData.filter((dataPoint) => {\n        const timestamp = new Date(dataPoint.timestamp).getTime();\n        return (\n          timestamp >= new Date(start_time).getTime() && timestamp <= new Date(end_time).getTime()\n        );\n      });\n\n      resolve(filteredData);\n    } catch (error) {\n      reject(new Error(`è·å–å†å²æ•°æ®å¤±è´¥: ${error.message}`));\n    }\n  });\n}\n\n// æ¨¡æ‹ŸåŠ è½½è®­ç»ƒæ•°æ®\nasync function loadTrainingData() {\n  // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä»æ•°æ®åº“æˆ–APIè·å–æ•°æ®\n  return new Promise((resolve) => {\n    resolve(batteryStatusData);\n  });\n}\n\n// é¢„å¤„ç†æ•°æ®\nfunction _preprocessPredictionData(data) {\n  const _windowSize = 24;\n  const xs = [];\n  const ys = [];\n\n  for (let i = _windowSize; i < data.length; i++) {\n    const window = data.slice(i - _windowSize, i).map((d) => d.soc);\n    xs.push(window);\n    ys.push(data[i].soc);\n  }\n\n  return {\n    features: tf.tensor2d(xs, [xs.length, _windowSize]),\n    labels: tf.tensor2d(ys, [ys.length, 1])\n  };\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 42 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 45 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 48 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 51 è¡Œ)\n}\n\n// åˆ›å»ºå‚¨èƒ½ä¼˜åŒ–æ¨¡å‹\nfunction createBatteryOptimizationModel() {\n  // è¾“å…¥å½¢çŠ¶: [æ—¶é—´çª—å£å¤§å°, ç‰¹å¾æ•°é‡]\n  // æ—¶é—´çª—å£å¤§å°ä¸º24, æ¯ä¸ªæ—¶é—´æ­¥æœ‰4ä¸ªç‰¹å¾(soc, power, voltage, temperature)\n  const inputShape = [24, 4];\n\n  const model = tf.sequential();\n\n  // ç¬¬ä¸€å±‚LSTM\n  model.add(\n    tf.layers.lstm({\n      units: 64,\n      inputShape,\n      returnSequences: true,\n      recurrentDropout: 0.2\n    })\n  );\n\n  // ç¬¬äºŒå±‚LSTM\n  model.add(\n    tf.layers.lstm({\n      units: 32,\n      returnSequences: false,\n      recurrentDropout: 0.2\n    })\n  );\n\n  // å…¨è¿æ¥å±‚\n  model.add(tf.layers.dense({ units: 16, activation: 'relu' }));\n  model.add(tf.layers.dropout({ rate: 0.3 }));\n\n  // è¾“å‡ºå±‚ - é¢„æµ‹SOCå€¼\n  model.add(tf.layers.dense({ units: 1, activation: 'linear' }));\n\n  // ç¼–è¯‘æ¨¡å‹\n  model.compile({\n    optimizer: tf.train.adam(0.001),\n    loss: 'meanAbsoluteError',\n    metrics: ['mse']\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 42 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 42 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 42 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 42 è¡Œ)\n  });\n\n  return model;\n}\n\n// è®­ç»ƒå‚¨èƒ½ä¼˜åŒ–æ¨¡å‹\nasync function trainBatteryOptimizationModel(model, features, labels) {\n  // åˆ’åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›† (80%è®­ç»ƒ, 20%éªŒè¯)\n  const trainSize = Math.floor(features.shape[0] * 0.8);\n  const trainFeatures = features.slice([0, 0], [trainSize, -1]);\n  const trainLabels = labels.slice([0, 0], [trainSize, -1]);\n  const valFeatures = features.slice([trainSize, 0], [-1, -1]);\n  const valLabels = labels.slice([trainSize, 0], [-1, -1]);\n\n  // é‡å¡‘ç‰¹å¾ä»¥é€‚åº”LSTMè¾“å…¥å½¢çŠ¶ [æ ·æœ¬æ•°, æ—¶é—´æ­¥, ç‰¹å¾æ•°]\n  const reshapedTrainFeatures = trainFeatures.reshape([trainFeatures.shape[0], 24, 4]);\n  const reshapedValFeatures = valFeatures.reshape([valFeatures.shape[0], 24, 4]);\n\n  // è®¾ç½®è®­ç»ƒå‚æ•°\n  const batchSize = 32;\n  const epochs = 50;\n\n  // è®­ç»ƒæ¨¡å‹\n  const history = await model.fit(reshapedTrainFeatures, trainLabels, {\n    batchSize,\n    epochs,\n    validationData: [reshapedValFeatures, valLabels],\n    callbacks: {\n      earlyStopping: {\n        monitor: 'val_loss',\n        patience: 5,\n        restoreBestWeights: true\n      },\n      reduceLROnPlateau: {\n        monitor: 'val_loss',\n        factor: 0.5,\n        patience: 3,\n        minLearningRate: 0.0001\n      }\n    }\n  });\n\n  console.log(\n    'æ¨¡å‹è®­ç»ƒå®Œæˆï¼Œæœ€ç»ˆéªŒè¯æŸå¤±:',\n    history.history.val_loss[history.history.val_loss.length - 1]\n  );\n  return model;\n}\n\n// ä¿å­˜æ¨¡å‹\nasync function saveModel(model) {\n  try {\n    // åˆ›å»ºæ¨¡å‹ä¿å­˜ç›®å½•\n    const modelDir = '/Users/xunan/Documents/WebStormProjects/0C/models/battery-optimization';\n    await fs.mkdir(modelDir, { recursive: true });\n\n    // ä¿å­˜æ¨¡å‹\n    await model.save(`file://${modelDir}`);\n    console.log('æ¨¡å‹å·²æˆåŠŸä¿å­˜åˆ°:', modelDir);\n\n    // ä¿å­˜å½’ä¸€åŒ–å‚æ•°\n    await fs.writeFile(\n      `${modelDir}/normalization-stats.json`,\n      JSON.stringify(global.batteryModelStats, null, 2)\n    );\n  } catch (error) {\n    console.error('ä¿å­˜æ¨¡å‹å¤±è´¥:', error.message);\n    throw new Error('MODEL_SAVE_FAILED');\n  }\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/cacheService.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: -2.","line":149,"column":14,"nodeType":"UnaryExpression","messageId":"noMagic","endLine":149,"endColumn":16},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: -2.","line":156,"column":14,"nodeType":"UnaryExpression","messageId":"noMagic","endLine":156,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import NodeCache from 'node-cache';\nimport logger from '../../shared/utils/logger.js';\n\n// ç¼“å­˜é…ç½®\nconst CACHE_CONFIG = {\n  stdTTL: 300, // é»˜è®¤ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\n  checkperiod: 60, // å®šæœŸæ£€æŸ¥è¿‡æœŸç¼“å­˜çš„æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰\n  useClones: false // ä¸å…‹éš†å¯¹è±¡ï¼Œæé«˜æ€§èƒ½ï¼ˆæ³¨æ„ï¼šå¯èƒ½å¯¼è‡´ç¼“å­˜å¯¹è±¡è¢«å¤–éƒ¨ä¿®æ”¹ï¼‰\n};\n\n// åˆ›å»ºç¼“å­˜å®ä¾‹\nconst cache = new NodeCache(CACHE_CONFIG);\n\n/**\n * ç¼“å­˜æœåŠ¡ç±»\n * æä¾›åŸºç¡€çš„ç¼“å­˜æ“ä½œåŠŸèƒ½\n */\nclass CacheService {\n  constructor() {\n    // ç›‘å¬ç¼“å­˜äº‹ä»¶\n    cache.on('expired', (key, _value) => {\n      logger.debug(`ç¼“å­˜è¿‡æœŸ: ${key}`);\n    });\n\n    cache.on('flush', () => {\n      logger.info('ç¼“å­˜å·²æ¸…ç©º');\n    });\n  }\n\n  /**\n   * è®¾ç½®ç¼“å­˜\n   * @param {string} key - ç¼“å­˜é”®\n   * @param {any} value - ç¼“å­˜å€¼\n   * @param {number} [ttl] - è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨å…¨å±€é…ç½®\n   * @returns {boolean} - æ˜¯å¦è®¾ç½®æˆåŠŸ\n   */\n  set(key, value, ttl = CACHE_CONFIG.stdTTL) {\n    if (!key) {\n      logger.error('ç¼“å­˜é”®ä¸èƒ½ä¸ºç©º');\n      return false;\n    }\n\n    try {\n      const success = cache.set(key, value, ttl);\n      if (success) {\n        logger.debug(`ç¼“å­˜è®¾ç½®æˆåŠŸ: ${key}, TTL: ${ttl}ç§’`);\n      } else {\n        logger.warn(`ç¼“å­˜è®¾ç½®å¤±è´¥: ${key}`);\n      }\n      return success;\n    } catch (error) {\n      logger.error(`ç¼“å­˜è®¾ç½®é”™è¯¯: ${key}`, error);\n      return false;\n    }\n  }\n\n  /**\n   * è·å–ç¼“å­˜\n   * @param {string} key - ç¼“å­˜é”®\n   * @returns {any} - ç¼“å­˜å€¼ï¼Œè‹¥ä¸å­˜åœ¨åˆ™è¿”å›undefined\n   */\n  get(key) {\n    if (!key) {\n      logger.error('ç¼“å­˜é”®ä¸èƒ½ä¸ºç©º');\n      return undefined;\n    }\n\n    try {\n      const value = cache.get(key);\n      if (value !== undefined) {\n        logger.debug(`ç¼“å­˜å‘½ä¸­: ${key}`);\n      } else {\n        logger.debug(`ç¼“å­˜æœªå‘½ä¸­: ${key}`);\n      }\n      return value;\n    } catch (error) {\n      logger.error(`ç¼“å­˜è·å–é”™è¯¯: ${key}`, error);\n      return undefined;\n    }\n  }\n\n  /**\n   * åˆ é™¤ç¼“å­˜\n   * @param {string} key - ç¼“å­˜é”®\n   * @returns {number} - è¢«åˆ é™¤çš„ç¼“å­˜æ•°é‡\n   */\n  del(key) {\n    if (!key) {\n      logger.error('ç¼“å­˜é”®ä¸èƒ½ä¸ºç©º');\n      return 0;\n    }\n\n    try {\n      const count = cache.del(key);\n      if (count > 0) {\n        logger.debug(`ç¼“å­˜åˆ é™¤æˆåŠŸ: ${key}`);\n      } else {\n        logger.debug(`ç¼“å­˜åˆ é™¤å¤±è´¥ï¼Œé”®ä¸å­˜åœ¨: ${key}`);\n      }\n      return count;\n    } catch (error) {\n      logger.error(`ç¼“å­˜åˆ é™¤é”™è¯¯: ${key}`, error);\n      return 0;\n    }\n  }\n\n  /**\n   * æ‰¹é‡åˆ é™¤ç¼“å­˜\n   * @param {string[]} keys - ç¼“å­˜é”®æ•°ç»„\n   * @returns {number} - è¢«åˆ é™¤çš„ç¼“å­˜æ•°é‡\n   */\n  delMulti(keys) {\n    if (!Array.isArray(keys) || keys.length === 0) {\n      logger.error('ç¼“å­˜é”®æ•°ç»„ä¸èƒ½ä¸ºç©º');\n      return 0;\n    }\n\n    try {\n      const count = cache.del(keys);\n      logger.debug(`æ‰¹é‡åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œå…±åˆ é™¤ ${count} ä¸ªç¼“å­˜`);\n      return count;\n    } catch (error) {\n      logger.error('æ‰¹é‡åˆ é™¤ç¼“å­˜é”™è¯¯', error);\n      return 0;\n    }\n  }\n\n  /**\n   * æ¸…ç©ºæ‰€æœ‰ç¼“å­˜\n   * @returns {void}\n   */\n  flushAll() {\n    try {\n      cache.flushAll();\n      logger.info('æ‰€æœ‰ç¼“å­˜å·²æ¸…ç©º');\n    } catch (error) {\n      logger.error('æ¸…ç©ºç¼“å­˜é”™è¯¯', error);\n    }\n  }\n\n  /**\n   * è·å–ç¼“å­˜é”®çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´\n   * @param {string} key - ç¼“å­˜é”®\n   * @returns {number} - å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ-1è¡¨ç¤ºæ°¸ä¸è¿‡æœŸï¼Œ-2è¡¨ç¤ºé”®ä¸å­˜åœ¨\n   */\n  getTtl(key) {\n    if (!key) {\n      logger.error('ç¼“å­˜é”®ä¸èƒ½ä¸ºç©º');\n      return -2;\n    }\n\n    try {\n      return cache.getTtl(key);\n    } catch (error) {\n      logger.error(`è·å–ç¼“å­˜TTLé”™è¯¯: ${key}`, error);\n      return -2;\n    }\n  }\n\n  /**\n   * è®¾ç½®ç¼“å­˜é”®çš„ç”Ÿå­˜æ—¶é—´\n   * @param {string} key - ç¼“å­˜é”®\n   * @param {number} ttl - ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰\n   * @returns {boolean} - æ˜¯å¦è®¾ç½®æˆåŠŸ\n   */\n  setTtl(key, ttl) {\n    if (!key || typeof ttl !== 'number' || ttl <= 0) {\n      logger.error('ç¼“å­˜é”®å’Œæœ‰æ•ˆçš„TTLä¸èƒ½ä¸ºç©º');\n      return false;\n    }\n\n    try {\n      return cache.ttl(key, ttl);\n    } catch (error) {\n      logger.error(`è®¾ç½®ç¼“å­˜TTLé”™è¯¯: ${key}`, error);\n      return false;\n    }\n  }\n\n  /**\n   * è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯\n   * @returns {object} - ç¼“å­˜ç»Ÿè®¡æ•°æ®\n   */\n  getStats() {\n    try {\n      return cache.getStats();\n    } catch (error) {\n      logger.error('è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯é”™è¯¯', error);\n      return null;\n    }\n  }\n\n  /**\n   * ç¼“å­˜è£…é¥°å™¨ - ç”¨äºè£…é¥°éœ€è¦ç¼“å­˜çš„å‡½æ•°\n   * @param {number} ttl - ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\n   * @returns {Function} - è£…é¥°å™¨å‡½æ•°\n   */\n  cacheDecorator(ttl = CACHE_CONFIG.stdTTL) {\n    return (target, propertyKey, descriptor) => {\n      const originalMethod = descriptor.value;\n\n      descriptor.value = async function (...args) {\n        // ç”Ÿæˆç¼“å­˜é”®ï¼ˆç±»å+æ–¹æ³•å+å‚æ•°å“ˆå¸Œï¼‰\n        const key = `${target.constructor.name}_${propertyKey}_${JSON.stringify(args)}`;\n\n        // å°è¯•ä»ç¼“å­˜è·å–\n        const cachedResult = this.get(key);\n        if (cachedResult !== undefined) {\n          return cachedResult;\n        }\n\n        // è°ƒç”¨åŸå§‹æ–¹æ³•\n        const result = await originalMethod.apply(this, args);\n\n        // è®¾ç½®ç¼“å­˜\n        this.set(key, result, ttl);\n\n        return result;\n      };\n\n      return descriptor;\n    };\n  }\n}\n\n// åˆ›å»ºç¼“å­˜æœåŠ¡å®ä¾‹\nconst cacheService = new CacheService();\n\nexport default cacheService;\n\nexport { CacheService };\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/deviceApi.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":23,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":23,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[619,653],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":44,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":44,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1122,1156],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":66,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":66,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1759,1793],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":86,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":86,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2263,2297],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":107,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":107,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2808,2840],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":129,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":129,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3407,3441],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":149,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":149,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3906,3938],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\nimport { getAuthToken } from './auth';\n\nimport config from '../../shared/config/index.js';\nconst API_BASE_URL =\n  process.env.REACT_APP_API_BASE_URL || `http://localhost:${config.app.port}/api`;\n\n/**\n * è·å–è®¾å¤‡çŠ¶æ€ä¿¡æ¯\n * @param {string} deviceId - è®¾å¤‡ID\n * @returns {Promise<Object>} è®¾å¤‡çŠ¶æ€æ•°æ®\n */\nexport const getDeviceStatus = async (deviceId) => {\n  try {\n    const token = getAuthToken();\n    const response = await axios.get(`${API_BASE_URL}/devices/${deviceId}/status`, {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n    return response.data;\n  } catch (error) {\n    console.error('è·å–è®¾å¤‡çŠ¶æ€å¤±è´¥:', error);\n    throw error.response?.data || { error: { message: 'è·å–è®¾å¤‡çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯' } };\n  }\n};\n\n/**\n * è·å–è®¾å¤‡åˆ—è¡¨\n * @param {Object} params - æŸ¥è¯¢å‚æ•°\n * @returns {Promise<Object>} è®¾å¤‡åˆ—è¡¨æ•°æ®\n */\nexport const fetchDevices = async (params = {}) => {\n  try {\n    const token = getAuthToken();\n    const response = await axios.get(`${API_BASE_URL}/devices`, {\n      headers: {\n        Authorization: `Bearer ${token}`\n      },\n      params\n    });\n    return response.data;\n  } catch (error) {\n    console.error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);\n    throw error.response?.data || { error: { message: 'è·å–è®¾å¤‡åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯' } };\n  }\n};\n\n/**\n * æ›´æ–°è®¾å¤‡çŠ¶æ€\n * @param {string} deviceId - è®¾å¤‡ID\n * @param {Object} statusData - çŠ¶æ€æ•°æ® { status, remark }\n * @returns {Promise<Object>} æ›´æ–°ç»“æœ\n */\nexport const updateDeviceStatus = async (deviceId, statusData) => {\n  try {\n    const token = getAuthToken();\n    const response = await axios.patch(`${API_BASE_URL}/devices/${deviceId}/status`, statusData, {\n      headers: {\n        Authorization: `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      }\n    });\n    return response.data;\n  } catch (error) {\n    console.error('æ›´æ–°è®¾å¤‡çŠ¶æ€å¤±è´¥:', error);\n    throw error.response?.data || { error: { message: 'æ›´æ–°è®¾å¤‡çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯' } };\n  }\n};\n\n/**\n * è·å–è®¾å¤‡è¯¦æƒ…\n * @param {string} deviceId - è®¾å¤‡ID\n * @returns {Promise<Object>} è®¾å¤‡è¯¦æƒ…æ•°æ®\n */\nexport const getDeviceDetails = async (deviceId) => {\n  try {\n    const token = getAuthToken();\n    const response = await axios.get(`${API_BASE_URL}/devices/${deviceId}`, {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n    return response.data;\n  } catch (error) {\n    console.error('è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥:', error);\n    throw error.response?.data || { error: { message: 'è·å–è®¾å¤‡è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯' } };\n  }\n};\n\n/**\n * åˆ›å»ºè®¾å¤‡\n * @param {Object} deviceData - è®¾å¤‡æ•°æ®\n * @returns {Promise<Object>} åˆ›å»ºç»“æœ\n */\nexport const createDevice = async (deviceData) => {\n  try {\n    const token = getAuthToken();\n    const response = await axios.post(`${API_BASE_URL}/devices`, deviceData, {\n      headers: {\n        Authorization: `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      }\n    });\n    return response.data;\n  } catch (error) {\n    console.error('åˆ›å»ºè®¾å¤‡å¤±è´¥:', error);\n    throw error.response?.data || { error: { message: 'åˆ›å»ºè®¾å¤‡æ—¶å‘ç”Ÿé”™è¯¯' } };\n  }\n};\n\n/**\n * æ›´æ–°è®¾å¤‡ä¿¡æ¯\n * @param {string} deviceId - è®¾å¤‡ID\n * @param {Object} deviceData - è®¾å¤‡æ•°æ®\n * @returns {Promise<Object>} æ›´æ–°ç»“æœ\n */\nexport const updateDevice = async (deviceId, deviceData) => {\n  try {\n    const token = getAuthToken();\n    const response = await axios.put(`${API_BASE_URL}/devices/${deviceId}`, deviceData, {\n      headers: {\n        Authorization: `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      }\n    });\n    return response.data;\n  } catch (error) {\n    console.error('æ›´æ–°è®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);\n    throw error.response?.data || { error: { message: 'æ›´æ–°è®¾å¤‡ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯' } };\n  }\n};\n\n/**\n * åˆ é™¤è®¾å¤‡\n * @param {string} deviceId - è®¾å¤‡ID\n * @returns {Promise<Object>} åˆ é™¤ç»“æœ\n */\nexport const deleteDevice = async (deviceId) => {\n  try {\n    const token = getAuthToken();\n    const response = await axios.delete(`${API_BASE_URL}/devices/${deviceId}`, {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n    return response.data;\n  } catch (error) {\n    console.error('åˆ é™¤è®¾å¤‡å¤±è´¥:', error);\n    throw error.response?.data || { error: { message: 'åˆ é™¤è®¾å¤‡æ—¶å‘ç”Ÿé”™è¯¯' } };\n  }\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/emission.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'express' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":15},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5968.","line":42,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":42,"endColumn":76},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 365.","line":54,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":54,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":54,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":54,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":54,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":54,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":54,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":54,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":54,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":54,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":124,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":124,"endColumn":23},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":137,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":137,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3483,3516],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":138,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":138,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from 'express';\n// å¼•å…¥å¿…è¦çš„æ¨¡å—\nimport { createRequire } from 'module';\nconst _require = createRequire(import.meta.url);\n\n// å®šä¹‰èƒ½æºç±»å‹å¸¸é‡\nexport const ENERGY_TYPES = {\n  ELECTRICITY: 'electricity', // ç”µåŠ›\n  DIESEL: 'diesel', // æŸ´æ²¹\n  NATURAL_GAS: 'natural_gas', // å¤©ç„¶æ°”\n  SOLAR: 'solar' // å…‰ä¼\n};\n\n// å®šä¹‰èƒ½æºæ¶ˆè€—æ•°æ®æ ·æœ¬\nexport const energyConsumptionData = [\n  {\n    buildingId: 'B1',\n    timestamp: new Date('2023-06-01T00:00:00Z'),\n    energyType: ENERGY_TYPES.ELECTRICITY,\n    consumption: 1500, // åƒç“¦æ—¶\n    carbonEmission: 0.5 // å¨CO2\n  },\n  {\n    buildingId: 'B1',\n    timestamp: new Date('2023-06-01T00:00:00Z'),\n    energyType: ENERGY_TYPES.SOLAR,\n    consumption: 200, // åƒç“¦æ—¶\n    carbonEmission: 0.0 // å¨CO2\n  }\n];\n\n// è®¡ç®—å•ä¸ªæ•°æ®ç‚¹çš„ç¢³æ’æ”¾é‡\nfunction calculateEmission(dataPoint) {\n  // ä½¿ç”¨é»˜è®¤ç¢³æ’æ”¾å› å­ï¼ˆé¿å…æ•°æ®åº“æŸ¥è¯¢ï¼‰\n  const defaultCarbonFactors = {\n    electricity: 0.5968, // ç”µåŠ›ç¢³æ’æ”¾å› å­ (kg CO2/kWh)\n    diesel: 2.68, // æŸ´æ²¹ç¢³æ’æ”¾å› å­ (kg CO2/L)\n    natural_gas: 2.03, // å¤©ç„¶æ°”ç¢³æ’æ”¾å› å­ (kg CO2/mÂ³)\n    solar: 0.0 // å…‰ä¼ç¢³æ’æ”¾å› å­ (kg CO2/kWh)\n  };\n\n  const carbonFactor = defaultCarbonFactors[dataPoint.energyType] || 0.5968;\n  return dataPoint.consumption * carbonFactor;\n}\n\n// éªŒè¯æ—¶é—´èŒƒå›´æœ‰æ•ˆæ€§\nfunction validateTimeRange(start_time, end_time) {\n  // éªŒè¯å¼€å§‹æ—¶é—´æ˜¯å¦æ—©äºç»“æŸæ—¶é—´\n  if (start_time >= end_time) {\n    throw new Error('å¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´');\n  }\n\n  // éªŒè¯æ—¶é—´èŒƒå›´æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼ˆä¾‹å¦‚ä¸èƒ½è¶…è¿‡1å¹´ï¼‰\n  const oneYearInMs = 365 * 24 * 60 * 60 * 1000;\n  if (end_time - start_time > oneYearInMs) {\n    throw new Error('æ—¶é—´èŒƒå›´ä¸èƒ½è¶…è¿‡ä¸€å¹´');\n  }\n}\n\n// è®¡ç®—æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ€»ç¢³æ’æ”¾é‡\nfunction calculateTotalEmissions(startTime, endTime) {\n  // è¿‡æ»¤æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„èƒ½æºæ¶ˆè€—æ•°æ®\n  const filteredData = energyConsumptionData.filter(\n    (dataPoint) => dataPoint.timestamp >= startTime && dataPoint.timestamp <= endTime\n  );\n\n  // è®¡ç®—æ€»ç¢³æ’æ”¾é‡\n  let totalEmissions = 0;\n\n  filteredData.forEach((dataPoint) => {\n    totalEmissions += calculateEmission(dataPoint);\n  });\n\n  // è¿”å›æ€»ç¢³æ’æ”¾é‡\n  return totalEmissions;\n}\n\n// è®¡ç®—è¯¦ç»†çš„ç¢³æ’æ”¾æ˜ç»†\nfunction calculateEmissionDetails(startTime, endTime) {\n  // è¿‡æ»¤æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„èƒ½æºæ¶ˆè€—æ•°æ®\n  const filteredData = energyConsumptionData.filter(\n    (dataPoint) => dataPoint.timestamp >= startTime && dataPoint.timestamp <= endTime\n  );\n\n  // æŒ‰èƒ½æºç±»å‹åˆ†ç±»ç»Ÿè®¡\n  const emissionDetails = {};\n  let totalEmissions = 0;\n\n  filteredData.forEach((dataPoint) => {\n    const emission = calculateEmission(dataPoint);\n    if (!emissionDetails[dataPoint.energyType]) {\n      emissionDetails[dataPoint.energyType] = {\n        energyType: dataPoint.energyType,\n        totalConsumption: 0,\n        totalEmission: 0\n      };\n    }\n\n    emissionDetails[dataPoint.energyType].totalConsumption += dataPoint.consumption;\n    emissionDetails[dataPoint.energyType].totalEmission += emission;\n    totalEmissions += emission;\n  });\n\n  // è¿”å›æ±‡æ€»ç»“æœ\n  return {\n    total: totalEmissions,\n    details: Object.values(emissionDetails),\n    timeRange: {\n      start: startTime,\n      end: endTime\n    }\n  };\n}\n\n// åˆ›å»ºç¢³æ’æ”¾è®¡ç®—è·¯ç”±\nfunction setupCarbonRoutes(app, authenticateToken) {\n  // ç¢³æ’æ”¾è®¡ç®—æ¥å£\n  app.get('/carbon/emissions', authenticateToken(), async (req, res) => {\n    try {\n      // è·å–æŸ¥è¯¢å‚æ•°\n      const { buildingId, startDate, endDate } = req.query;\n\n      if (!buildingId || !startDate || !endDate) {\n        res.status(400).json({ error: 'ç¼ºå°‘å¿…è¦å‚æ•°' });\n        return;\n      }\n\n      // éªŒè¯æ—¶é—´èŒƒå›´\n      validateTimeRange(new Date(startDate), new Date(endDate));\n\n      // è°ƒç”¨ç¢³æ’æ”¾è®¡ç®—æ¨¡å‹\n      const emissions = calculateEmissionDetails(new Date(startDate), new Date(endDate));\n\n      // è¿”å›è®¡ç®—ç»“æœ\n      res.json(emissions);\n    } catch (error) {\n      console.error('ç¢³æ’æ”¾è®¡ç®—é”™è¯¯:', error);\n      res.status(500).json({ error: 'ç¢³æ’æ”¾è®¡ç®—å¤±è´¥' });\n    }\n  });\n\n  // è¿”å›appå¯¹è±¡ä»¥ä¾¿é“¾å¼è°ƒç”¨\n  return app;\n}\n\n// ç»Ÿä¸€å¯¼å‡ºæ‰€æœ‰ functions å’Œ constants\nexport {\n  calculateEmission,\n  validateTimeRange,\n  calculateTotalEmissions,\n  calculateEmissionDetails,\n  setupCarbonRoutes\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/energyPrediction.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":13,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.001.","line":54,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":54,"endColumn":35},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":77,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":77,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1643,1698],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":84,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":84,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1801,1831],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":86,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":86,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1856,1896],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":99,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":99,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":108,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":108,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":108,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":108,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":108,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":108,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":108,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":108,"endColumn":62},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":109,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":109,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":109,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":109,"endColumn":60},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":116,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":116,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2647,2679],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":117,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":117,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":141,"column":11,"nodeType":"Literal","messageId":"noMagic","endLine":141,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":141,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":141,"endColumn":18},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":141,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":141,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":142,"column":11,"nodeType":"Literal","messageId":"noMagic","endLine":142,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":142,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":142,"endColumn":18},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":142,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":142,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":142,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":142,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":143,"column":11,"nodeType":"Literal","messageId":"noMagic","endLine":143,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":143,"column":15,"nodeType":"Literal","messageId":"noMagic","endLine":143,"endColumn":17},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":143,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":143,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":143,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":143,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":143,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":143,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":26,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createRequire } from 'module';\nconst require = createRequire(import.meta.url);\nconst tf = require('@tensorflow/tfjs-node');\n\n// æ¨¡æ‹Ÿå†å²èƒ½æºæ•°æ®\nconst historicalEnergyData = [\n  { timestamp: '2025-06-01T00:00:00Z', value: 1200, type: 'electricity' },\n  { timestamp: '2025-06-01T01:00:00Z', value: 1100, type: 'electricity' }\n  // ... æ›´å¤šå†å²æ•°æ®\n];\n\n// å‡†å¤‡è®­ç»ƒæ•°æ®\nfunction prepareTrainingData(data, windowSize = 24) {\n  const xs = [];\n  const ys = [];\n\n  for (let i = windowSize; i < data.length; i++) {\n    const window = data.slice(i - windowSize, i).map((d) => d.value);\n    xs.push(window);\n    ys.push(data[i].value);\n  }\n\n  return {\n    xs: tf.tensor2d(xs, [xs.length, windowSize]),\n    ys: tf.tensor2d(ys, [ys.length, 1])\n  };\n}\n\n// åˆ›å»ºLSTMæ¨¡å‹\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\nfunction createModel(inputShape) {\n  const model = tf.sequential();\n\n  model.add(\n    tf.layers.lstm({\n      units: 64,\n      inputShape,\n      returnSequences: false\n    })\n  );\n\n  model.add(tf.layers.dense({ units: 32, activation: 'relu' }));\n  model.add(tf.layers.dense({ units: 1 }));\n\n  model.compile({\n    optimizer: tf.train.adam(0.001),\n    loss: 'meanSquaredError'\n  });\n\n  return model;\n}\n\n// è®­ç»ƒæ¨¡å‹\nasync function _trainModel() {\n  try {\n    // å‡†å¤‡è®­ç»ƒæ•°æ®\n    const { xs, ys } = prepareTrainingData(historicalEnergyData);\n\n    // åˆ›å»ºæ¨¡å‹\n    const model = createModel([xs.shape[1], 1]);\n\n    // è®­ç»ƒæ¨¡å‹\n    await model.fit(xs, ys, {\n      epochs: 100,\n      batchSize: 32,\n      shuffle: true,\n      callbacks: {\n        onEpochEnd: (epoch, logs) => {\n          console.log(`Epoch ${epoch + 1}: Loss = ${logs.loss}`);\n        }\n      }\n    });\n\n    // ä¿å­˜æ¨¡å‹\n    await model.save('file://./models/energy-prediction');\n    console.log('èƒ½æºé¢„æµ‹æ¨¡å‹è®­ç»ƒå®Œæˆå¹¶å·²ä¿å­˜');\n  } catch (error) {\n    console.error('æ¨¡å‹è®­ç»ƒå¤±è´¥:', error.message);\n  }\n}\n\n// åˆ›å»ºèƒ½æºé¢„æµ‹è·¯ç”±\nfunction setupEnergyRoutes(app, authenticateToken) {\n  // èƒ½æºæ¶ˆè€—é¢„æµ‹æ¥å£\n  app.get('/energy/predict', authenticateToken(), async (req, res) => {\n    try {\n      // è·å–æŸ¥è¯¢å‚æ•°\n      const { buildingId, days } = req.query;\n\n      if (!buildingId || !days) {\n        res.status(400).json({ error: 'ç¼ºå°‘å¿…è¦å‚æ•°' });\n        return;\n      }\n\n      // è°ƒç”¨é¢„æµ‹æ¨¡å‹ - æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®\n      const prediction = {\n        buildingId,\n        days: parseInt(days),\n        predictions: Array.from({ length: parseInt(days) }, (_, i) => ({\n          date: new Date(Date.now() + i * 24 * 60 * 60 * 1000).toISOString(),\n          predicted_consumption: Math.random() * 1000 + 500\n        }))\n      };\n\n      // è¿”å›é¢„æµ‹ç»“æœ\n      res.json(prediction);\n    } catch (error) {\n      console.error('èƒ½æºé¢„æµ‹é”™è¯¯:', error);\n      res.status(500).json({ error: 'èƒ½æºé¢„æµ‹å¤±è´¥' });\n    }\n  });\n\n  // è¿”å›appå¯¹è±¡ä»¥ä¾¿é“¾å¼è°ƒç”¨\n  return app;\n}\n\n// å‡†å¤‡é¢„æµ‹è¾“å…¥æ•°æ®\nfunction _preparePredictionInput(data) {\n  // å®é™…å¼€å‘ä¸­éœ€è¦å°†å†å²æ•°æ®è½¬æ¢ä¸ºæ¨¡å‹è¾“å…¥æ ¼å¼\n  const normalized = normalizeData(data.map((d) => d.value));\n  return tf.tensor2d([normalized], [1, normalized.length]);\n}\n\n// æ•°æ®å½’ä¸€åŒ–\nfunction normalizeData(data) {\n  const max = Math.max(...data);\n  return data.map((value) => value / max);\n}\n\n// è®¡ç®—é¢„æµ‹æ—¶é—´\nfunction _calculatePredictionTime(index, interval) {\n  const intervalMap = {\n    '1h': 60 * 60 * 1000,\n    '1d': 24 * 60 * 60 * 1000,\n    '1w': 7 * 24 * 60 * 60 * 1000\n  };\n\n  const ms = new Date().getTime() + (index + 1) * (intervalMap[interval] || intervalMap['1h']);\n  return new Date(ms).toISOString();\n}\n\n// è·å–å†å²èƒ½æºæ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰\nfunction _getHistoricalEnergyData(_device_id, _start_time, _end_time) {\n  // å®é™…å¼€å‘ä¸­åº”ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®\n  return new Promise((resolve) => {\n    resolve(historicalEnergyData);\n  });\n}\n\n// å¯¼å‡ºèƒ½æºé¢„æµ‹åŠŸèƒ½\nexport { setupEnergyRoutes };\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/jwtManager.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":56,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":56,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":65,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":65,"endColumn":40},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":208,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":208,"endColumn":19,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[5622,5667],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3600000.","line":279,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":279,"endColumn":15},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":287,"column":76,"nodeType":"Literal","messageId":"noMagic","endLine":287,"endColumn":80},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":297,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":297,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7650,7772],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":332,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":332,"endColumn":22},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":340,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":340,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8823,8855],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":342,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":342,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":348,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":348,"endColumn":32},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":386,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":386,"endColumn":19,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[10084,10123],"text":""},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * JWTè®¤è¯ç®¡ç†å™¨\n * æä¾›å®‰å…¨çš„JWT tokenç”Ÿæˆã€éªŒè¯å’Œåˆ·æ–°æœºåˆ¶\n */\n\nimport jwt from 'jsonwebtoken';\nimport { promisify } from 'util';\nimport crypto from 'crypto';\nimport { AuthenticationError, AuthorizationError as _AuthorizationError } from '../../shared/utils/AppError.js';\nimport config from '../../shared/config/index.js';\n\n/**\n * JWTç®¡ç†å™¨ç±»\n */\nexport class JWTManager {\n  constructor(options = {}) {\n    this.secret = options.secret || config.jwt.secret;\n    this.accessTokenExpiry = options.accessTokenExpiry || config.jwt.accessTokenExpiry;\n    this.refreshTokenExpiry = options.refreshTokenExpiry || config.jwt.refreshTokenExpiry;\n    this.issuer = options.issuer || config.jwt.issuer;\n    this.audience = options.audience || config.jwt.audience;\n\n    // ç”¨äºå­˜å‚¨å·²æ’¤é”€çš„tokenï¼ˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”ä½¿ç”¨Redisï¼‰\n    this.revokedTokens = new Set();\n\n    // ç”¨äºå­˜å‚¨åˆ·æ–°tokenï¼ˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”ä½¿ç”¨æ•°æ®åº“ï¼‰\n    this.refreshTokenStore = new Map();\n\n    // å®šæœŸæ¸…ç†è¿‡æœŸçš„æ’¤é”€token\n    this.startCleanupInterval();\n  }\n\n  /**\n   * ç”Ÿæˆè®¿é—®tokenå’Œåˆ·æ–°token\n   * @param {Object} payload - tokenè½½è·\n   * @param {Object} options - é¢å¤–é€‰é¡¹\n   * @returns {Object} åŒ…å«accessTokenå’ŒrefreshTokençš„å¯¹è±¡\n   */\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 53 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 53 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 53 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 53 è¡Œ)\n\n  generateTokens(payload, options = {}) {\n    const tokenId = crypto.randomUUID();\n    const refreshTokenId = crypto.randomUUID();\n\n    const accessTokenPayload = {\n      ...payload,\n      jti: tokenId, // JWT ID\n      type: 'access',\n      iat: Math.floor(Date.now() / 1000)\n    };\n\n    const refreshTokenPayload = {\n      userId: payload.userId,\n      username: payload.username,\n      jti: refreshTokenId,\n      type: 'refresh',\n      accessTokenId: tokenId,\n      iat: Math.floor(Date.now() / 1000)\n    };\n\n    const accessToken = jwt.sign(accessTokenPayload, this.secret, {\n      expiresIn: this.accessTokenExpiry,\n      issuer: this.issuer,\n      audience: this.audience,\n      algorithm: 'HS256'\n    });\n\n    const refreshToken = jwt.sign(refreshTokenPayload, this.secret, {\n      expiresIn: this.refreshTokenExpiry,\n      issuer: this.issuer,\n      audience: this.audience,\n      algorithm: 'HS256'\n    });\n\n    // å­˜å‚¨åˆ·æ–°tokenä¿¡æ¯\n    this.refreshTokenStore.set(refreshTokenId, {\n      userId: payload.userId,\n      accessTokenId: tokenId,\n      createdAt: new Date(),\n      lastUsed: new Date(),\n      userAgent: options.userAgent,\n      ipAddress: options.ipAddress\n    });\n\n    return {\n      accessToken,\n      refreshToken,\n      tokenType: 'Bearer',\n      expiresIn: this.parseExpiry(this.accessTokenExpiry),\n      tokenId,\n      refreshTokenId\n    };\n  }\n\n  /**\n   * éªŒè¯token\n   * @param {string} token - è¦éªŒè¯çš„token\n   * @param {string} expectedType - æœŸæœ›çš„tokenç±»å‹ï¼ˆaccessæˆ–refreshï¼‰\n   * @returns {Object} è§£ç åçš„tokenè½½è·\n   */\n  async verifyToken(token, expectedType = 'access') {\n    try {\n      const decoded = await promisify(jwt.verify)(token, this.secret, {\n        issuer: this.issuer,\n        audience: this.audience,\n        algorithms: ['HS256']\n      });\n\n      // æ£€æŸ¥tokenç±»å‹\n      if (decoded.type !== expectedType) {\n        throw new AuthenticationError(\n          `æ— æ•ˆçš„tokenç±»å‹ï¼ŒæœŸæœ›: ${expectedType}ï¼Œå®é™…: ${decoded.type}`\n        );\n      }\n\n      // æ£€æŸ¥tokenæ˜¯å¦å·²è¢«æ’¤é”€\n      if (this.revokedTokens.has(decoded.jti)) {\n        throw new AuthenticationError('Tokenå·²è¢«æ’¤é”€');\n      }\n\n      // å¦‚æœæ˜¯åˆ·æ–°tokenï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨äºå­˜å‚¨ä¸­\n      if (expectedType === 'refresh' && !this.refreshTokenStore.has(decoded.jti)) {\n        throw new AuthenticationError('åˆ·æ–°tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ');\n      }\n\n      return decoded;\n    } catch (error) {\n      if (error.name === 'TokenExpiredError') {\n        throw new AuthenticationError('Tokenå·²è¿‡æœŸ');\n      } else if (error.name === 'JsonWebTokenError') {\n        throw new AuthenticationError('æ— æ•ˆçš„tokenæ ¼å¼');\n      } else if (error.name === 'NotBeforeError') {\n        throw new AuthenticationError('Tokenå°šæœªç”Ÿæ•ˆ');\n      } else if (error instanceof AuthenticationError) {\n        throw error;\n      } else {\n        throw new AuthenticationError('TokenéªŒè¯å¤±è´¥');\n      }\n    }\n  }\n\n  /**\n   * åˆ·æ–°è®¿é—®token\n   * @param {string} refreshToken - åˆ·æ–°token\n   * @param {Object} options - é¢å¤–é€‰é¡¹\n   * @returns {Object} æ–°çš„tokenå¯¹\n   */\n  async refreshAccessToken(refreshToken, options = {}) {\n    // éªŒè¯åˆ·æ–°token\n    const decoded = await this.verifyToken(refreshToken, 'refresh');\n\n    // è·å–åˆ·æ–°tokenä¿¡æ¯\n    const refreshTokenInfo = this.refreshTokenStore.get(decoded.jti);\n    if (!refreshTokenInfo) {\n      throw new AuthenticationError('åˆ·æ–°tokenä¿¡æ¯ä¸å­˜åœ¨');\n    }\n\n    // æ’¤é”€æ—§çš„è®¿é—®token\n    this.revokedTokens.add(decoded.accessTokenId);\n\n    // æ›´æ–°åˆ·æ–°tokençš„æœ€åä½¿ç”¨æ—¶é—´\n    refreshTokenInfo.lastUsed = new Date();\n\n    // ç”Ÿæˆæ–°çš„è®¿é—®token\n    const newTokens = this.generateTokens(\n      {\n        userId: decoded.userId,\n        username: decoded.username,\n        role: decoded.role\n      },\n      options\n    );\n\n    // ç§»é™¤æ—§çš„åˆ·æ–°token\n    this.refreshTokenStore.delete(decoded.jti);\n\n    return newTokens;\n  }\n\n  /**\n   * æ’¤é”€token\n   * @param {string} token - è¦æ’¤é”€çš„token\n   * @param {string} tokenType - tokenç±»å‹\n   */\n  async revokeToken(token, tokenType = 'access') {\n    try {\n      const decoded = await this.verifyToken(token, tokenType);\n\n      if (tokenType === 'access') {\n        this.revokedTokens.add(decoded.jti);\n      } else if (tokenType === 'refresh') {\n        this.refreshTokenStore.delete(decoded.jti);\n        // åŒæ—¶æ’¤é”€ç›¸å…³çš„è®¿é—®token\n        const refreshTokenInfo = this.refreshTokenStore.get(decoded.jti);\n        if (refreshTokenInfo) {\n          this.revokedTokens.add(refreshTokenInfo.accessTokenId);\n        }\n      }\n    } catch (error) {\n      // å³ä½¿tokenæ— æ•ˆï¼Œä¹Ÿä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºæ’¤é”€æ“ä½œåº”è¯¥æ˜¯å¹‚ç­‰çš„\n      console.warn('æ’¤é”€tokenæ—¶å‘ç”Ÿé”™è¯¯:', error.message);\n    }\n  }\n\n  /**\n   * æ’¤é”€ç”¨æˆ·çš„æ‰€æœ‰token\n   * @param {number} userId - ç”¨æˆ·ID\n   */\n  revokeAllUserTokens(userId) {\n    // æ’¤é”€æ‰€æœ‰åˆ·æ–°token\n    for (const [tokenId, tokenInfo] of this.refreshTokenStore.entries()) {\n      if (tokenInfo.userId === userId) {\n        this.refreshTokenStore.delete(tokenId);\n        this.revokedTokens.add(tokenInfo.accessTokenId);\n      }\n    }\n  }\n\n  /**\n   * è·å–ç”¨æˆ·çš„æ´»è·ƒä¼šè¯\n   * @param {number} userId - ç”¨æˆ·ID\n   * @returns {Array} æ´»è·ƒä¼šè¯åˆ—è¡¨\n   */\n  getUserActiveSessions(userId) {\n    const sessions = [];\n\n    for (const [tokenId, tokenInfo] of this.refreshTokenStore.entries()) {\n      if (tokenInfo.userId === userId) {\n        sessions.push({\n          tokenId,\n          createdAt: tokenInfo.createdAt,\n          lastUsed: tokenInfo.lastUsed,\n          userAgent: tokenInfo.userAgent,\n          ipAddress: tokenInfo.ipAddress\n        });\n      }\n    }\n\n    return sessions.sort((a, b) => b.lastUsed - a.lastUsed);\n  }\n\n  /**\n   * è§£æè¿‡æœŸæ—¶é—´å­—ç¬¦ä¸²ä¸ºç§’æ•°\n   * @param {string} expiry - è¿‡æœŸæ—¶é—´å­—ç¬¦ä¸²ï¼ˆå¦‚'15m', '7d'ï¼‰\n   * @returns {number} ç§’æ•°\n   */\n  parseExpiry(expiry) {\n    const units = {\n      s: 1,\n      m: 60,\n      h: 3600,\n      d: 86400,\n      w: 604800\n    };\n\n    const match = expiry.match(/^(\\d+)([smhdw])$/);\n    if (!match) {\n      throw new Error(`æ— æ•ˆçš„è¿‡æœŸæ—¶é—´æ ¼å¼: ${expiry}`);\n    }\n\n    const [, value, unit] = match;\n    return parseInt(value) * units[unit];\n  }\n\n  /**\n   * å¯åŠ¨æ¸…ç†å®šæ—¶å™¨\n   */\n  startCleanupInterval() {\n    // æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡è¿‡æœŸçš„æ’¤é”€token\n    setInterval(() => {\n      this.cleanupExpiredTokens();\n    }, 3600000); // 1å°æ—¶\n  }\n\n  /**\n   * æ¸…ç†è¿‡æœŸçš„token\n   */\n  cleanupExpiredTokens() {\n    const now = new Date();\n    const refreshTokenExpiry = this.parseExpiry(this.refreshTokenExpiry) * 1000;\n\n    // æ¸…ç†è¿‡æœŸçš„åˆ·æ–°token\n    for (const [tokenId, tokenInfo] of this.refreshTokenStore.entries()) {\n      if (now - tokenInfo.createdAt > refreshTokenExpiry) {\n        this.refreshTokenStore.delete(tokenId);\n        this.revokedTokens.add(tokenInfo.accessTokenId);\n      }\n    }\n\n    console.log(\n      `[JWT] æ¸…ç†å®Œæˆï¼Œå½“å‰æ’¤é”€tokenæ•°é‡: ${this.revokedTokens.size}ï¼Œæ´»è·ƒåˆ·æ–°tokenæ•°é‡: ${this.refreshTokenStore.size}`\n    );\n  }\n\n  /**\n   * è·å–ç»Ÿè®¡ä¿¡æ¯\n   * @returns {Object} ç»Ÿè®¡ä¿¡æ¯\n   */\n  getStats() {\n    return {\n      revokedTokensCount: this.revokedTokens.size,\n      activeRefreshTokensCount: this.refreshTokenStore.size,\n      activeUsersCount: new Set([...this.refreshTokenStore.values()].map((info) => info.userId))\n        .size\n    };\n  }\n}\n\n/**\n * è®¤è¯ä¸­é—´ä»¶\n * @param {Array} requiredRoles - éœ€è¦çš„è§’è‰²åˆ—è¡¨\n * @returns {Function} Expressä¸­é—´ä»¶å‡½æ•°\n */\nexport const authenticateToken =\n  (requiredRoles = []) =>\n    (req, res, next) => {\n    // ä»è¯·æ±‚å¤´ä¸­è·å– Authorization å­—æ®µ\n      const authHeader = req.headers.authorization;\n      // å¦‚æœè¯·æ±‚å¤´å­˜åœ¨ï¼Œåˆ™æå– token éƒ¨åˆ†\n      const token = authHeader && authHeader.split(' ')[1]?.trim();\n\n      // å¦‚æœ token ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› 401 Unauthorized\n      if (token === null) {\n        return res\n          .status(401)\n          .json({ error: { code: 'UNAUTHORIZED', message: 'æœªæä¾›èº«ä»½éªŒè¯ä»¤ç‰Œ' } });\n      }\n\n      // ä½¿ç”¨ jwt.verify æ¥éªŒè¯ token\n      jwt.verify(token, config.jwt.secret, (err, user) => {\n        if (err) {\n        // å¦‚æœ token æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œåˆ™è¿”å› 403 Forbidden\n          console.error('JWT éªŒè¯å¤±è´¥:', err);\n          return res\n            .status(403)\n            .json({ error: { code: 'FORBIDDEN', message: 'æ— æ•ˆæˆ–å·²è¿‡æœŸçš„ä»¤ç‰Œ' } });\n        }\n\n        // æ£€æŸ¥è§’è‰²æƒé™\n        if (requiredRoles.length > 0 && (!user || !requiredRoles.includes(user.role))) {\n          return res.status(403).json({\n            error: { code: 'FORBIDDEN', message: `éœ€è¦ä»¥ä¸‹è§’è‰²ä¹‹ä¸€: ${requiredRoles.join(', ')}` }\n          });\n        }\n\n        // å¦‚æœ token æœ‰æ•ˆï¼Œåˆ™å°†è§£ç åçš„ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡ä¸Š\n        req.user = user;\n        // è°ƒç”¨ next() å°†æ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯ç”±å¤„ç†å™¨\n        next();\n      });\n    };\n\n/**\n * å¯é€‰è®¤è¯ä¸­é—´ä»¶ï¼ˆä¸å¼ºåˆ¶è¦æ±‚è®¤è¯ï¼‰\n */\nexport const optionalAuth = () => {\n  const jwtManager = new JWTManager();\n\n  return async (req, res, next) => {\n    try {\n      const authHeader = req.headers.authorization;\n\n      if (authHeader) {\n        const parts = authHeader.split(' ');\n        if (parts.length === 2 && parts[0] === 'Bearer') {\n          const [, token] = parts;\n          const decoded = await jwtManager.verifyToken(token, 'access');\n\n          req.user = {\n            id: decoded.userId,\n            username: decoded.username,\n            role: decoded.role,\n            tokenId: decoded.jti\n          };\n        }\n      }\n    } catch (error) {\n      // å¯é€‰è®¤è¯å¤±è´¥æ—¶ä¸æŠ›å‡ºé”™è¯¯ï¼Œåªæ˜¯ä¸è®¾ç½®ç”¨æˆ·ä¿¡æ¯\n      console.warn('å¯é€‰è®¤è¯å¤±è´¥:', error.message);\n    }\n\n    next();\n  };\n};\n\n// åˆ›å»ºé»˜è®¤çš„JWTç®¡ç†å™¨å®ä¾‹\nexport const defaultJWTManager = new JWTManager();\n\nexport default {\n  JWTManager,\n  authenticateToken,\n  optionalAuth,\n  defaultJWTManager\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/performanceMonitor.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.001.","line":13,"column":13,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":18},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.005.","line":13,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":13,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.025.","line":13,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.05.","line":13,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":13,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.25.","line":13,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":13,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":60},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2.5.","line":13,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":13,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":71},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":13,"column":73,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":75},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":34,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":34,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[825,946],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":44,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":44,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":121,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":121,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":56},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":126,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":126,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2791,2850],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":127,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":127,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2855,2945],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":127,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":127,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":127,"column":71,"nodeType":"Literal","messageId":"noMagic","endLine":127,"endColumn":75},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":127,"column":79,"nodeType":"Literal","messageId":"noMagic","endLine":127,"endColumn":82},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":127,"column":86,"nodeType":"Literal","messageId":"noMagic","endLine":127,"endColumn":89},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":128,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":128,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2950,2997],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":129,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":129,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3002,3048],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5000.","line":132,"column":6,"nodeType":"Literal","messageId":"noMagic","endLine":132,"endColumn":10},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":155,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":155,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":25,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { performance } from 'node:perf_hooks';\nimport { Histogram } from 'prom-client';\nimport os from 'os'; // å¼•å…¥æ“ä½œç³»ç»Ÿæ¨¡å—\n\n// å…¨å±€å˜é‡è·Ÿè¸ªæ´»åŠ¨è¿æ¥æ•°\nlet activeConnections = 0;\n\n// åˆ›å»ºAPIå»¶è¿ŸæŒ‡æ ‡ç›´æ–¹å›¾\nexport const apiLatencyHistogram = new Histogram({\n  name: 'api_latency_seconds',\n  help: 'APIè¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ',\n  labelNames: ['method', 'route', 'status_code'],\n  buckets: [0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]\n});\n\n// æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶\nexport function monitorAPILatency(req, res, next) {\n  const start = performance.now();\n  let connectionCounted = false;\n\n  // å¢åŠ æ´»åŠ¨è¿æ¥æ•°\n  activeConnections++;\n\n  // å®šä¹‰å‡å°‘è¿æ¥æ•°çš„å‡½æ•°ï¼Œç¡®ä¿åªæ‰§è¡Œä¸€æ¬¡\n  const decreaseConnection = () => {\n    if (!connectionCounted) {\n      activeConnections--;\n      connectionCounted = true;\n    }\n  };\n\n  res.on('finish', () => {\n    const duration = performance.now() - start;\n    console.log(\n      `API: ${req.method} ${req.originalUrl} | å»¶è¿Ÿ: ${duration.toFixed(2)}ms | çŠ¶æ€ç : ${res.statusCode}`\n    );\n    // è®°å½•æ€§èƒ½æŒ‡æ ‡\n    apiLatencyHistogram.observe(\n      {\n        method: req.method,\n        route: req.route ? req.route.path : req.path,\n        status_code: res.statusCode\n      },\n      duration / 1000\n    ); // è½¬æ¢ä¸ºç§’\n\n    // å‡å°‘æ´»åŠ¨è¿æ¥æ•°\n    decreaseConnection();\n  });\n\n  res.on('close', () => {\n    // è¿æ¥å…³é—­æ—¶ä¹Ÿå‡å°‘è®¡æ•°\n    decreaseConnection();\n  });\n\n  next();\n}\n\n// è·å–å½“å‰æ´»åŠ¨è¿æ¥æ•°\nexport function getActiveConnections() {\n  return activeConnections;\n}\n\n// åˆ›å»ºæ€§èƒ½æŒ‡æ ‡è·¯ç”±\nexport function setupPerformanceRoutes(app) {\n  // è·å–ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡\n  app.get('/api/performance/metrics', (req, res) => {\n    const [cpuLoad] = os.loadavg();\n    const metrics = {\n      apiLatency: collectAPILatencyMetrics(),\n      memoryUsage: process.memoryUsage(),\n      cpuLoad,\n      uptime: process.uptime(),\n      timestamp: new Date().toISOString()\n    };\n    res.json(metrics);\n  });\n\n  return app;\n}\n\n// æ”¶é›†APIå»¶è¿ŸæŒ‡æ ‡\nexport function collectAPILatencyMetrics() {\n  const metrics = {};\n\n  try {\n    // è·å–ç›´æ–¹å›¾æŒ‡æ ‡\n    const histogramData = apiLatencyHistogram.get();\n\n    // è¿”å›åŸºæœ¬çš„æŒ‡æ ‡ä¿¡æ¯\n    metrics.summary = {\n      name: histogramData.name,\n      help: histogramData.help,\n      type: histogramData.type,\n      values: histogramData.values || []\n    };\n\n    // æ·»åŠ ç®€å•çš„ç»Ÿè®¡ä¿¡æ¯\n    metrics.totalRequests = histogramData.values ? histogramData.values.length : 0;\n  } catch (error) {\n    // å¦‚æœè·å–æŒ‡æ ‡å¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼\n    metrics.summary = {\n      name: 'api_latency_seconds',\n      help: 'APIè¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ',\n      type: 'histogram',\n      values: []\n    };\n    metrics.totalRequests = 0;\n  }\n\n  return metrics;\n}\n\n// å¯åŠ¨æ€§èƒ½ç›‘æ§\nexport function startPerformanceMonitoring() {\n  // è®°å½•å¯åŠ¨æ—¶é—´\n  const startTime = Date.now();\n\n  // å®šæœŸè®°å½•æ€§èƒ½æŒ‡æ ‡\n  setInterval(() => {\n    const uptime = (Date.now() - startTime) / 1000 / 60; // è¿è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰\n    const memoryUsage = process.memoryUsage();\n    const [cpuLoad] = os.loadavg();\n\n    // è®°å½•æ€§èƒ½æ—¥å¿—\n    console.log(`\\nğŸ“Š ç³»ç»Ÿæ€§èƒ½æŠ¥å‘Š - è¿è¡Œæ—¶é—´: ${uptime.toFixed(2)} åˆ†é’Ÿ`);\n    console.log(`ğŸ’¾ å†…å­˜ä½¿ç”¨: ${Math.round((memoryUsage.heapUsed / 1024 / 1024) * 100) / 100}MB`);\n    console.log(`ğŸ§  CPUè´Ÿè½½: ${cpuLoad.toFixed(2)}`);\n    console.log(`ğŸ“¦ æ´»åŠ¨è¿æ¥æ•°: ${activeConnections}`);\n\n    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ æ›´å¤šè‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡\n  }, 5000); // æ¯5åˆ†é’Ÿè®°å½•ä¸€æ¬¡æ€§èƒ½æ•°æ®\n}\n\n// è®¾ç½®å»¶è¿Ÿæµ‹è¯•è·¯ç”±\nexport function delayTestRoute(app, authenticateToken) {\n  // æ·»åŠ éœ€è¦èº«ä»½éªŒè¯çš„å»¶è¿Ÿæµ‹è¯•ç«¯ç‚¹\n  app.get('/test/delay', authenticateToken(), (req, res) => {\n    // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´\n    const startTime = performance.now();\n\n    // æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿï¼ˆ100msï¼‰\n    setTimeout(() => {\n      const endTime = performance.now();\n      const duration = endTime - startTime;\n\n      // è¿”å›å»¶è¿Ÿä¿¡æ¯\n      res.json({\n        message: 'å»¶è¿Ÿæµ‹è¯•æˆåŠŸ',\n        requestTime: startTime,\n        responseTime: endTime,\n        delay: duration,\n        unit: 'milliseconds'\n      });\n    }, 100);\n  });\n\n  return app;\n}\n\n// åˆ›å»ºæ€§èƒ½ç›‘æ§å®ä¾‹\nexport const performanceMonitor = {\n  monitorAPILatency,\n  setupPerformanceRoutes,\n  collectAPILatencyMetrics,\n  apiLatencyHistogram,\n  delayTestRoute,\n  startPerformanceMonitoring\n};\n\n// å°†æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶å¯¼å‡º\nexport default performanceMonitor;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/permission.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":46,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":46,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":53,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":53,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":55,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":55,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":57,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":57,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":85,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":85,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":116,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":116,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":121,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":129,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":129,"endColumn":21},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":142,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":142,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3443,3483],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":146,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":146,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// å¼•å…¥å¿…è¦çš„æ¨¡å—\nimport jwt from 'jsonwebtoken';\nimport { v4 as uuidv4 } from 'uuid';\nimport config from '../../shared/config/index.js';\n\n// å®šä¹‰è§’è‰²å¸¸é‡\nexport const roles = {\n  ADMIN: 0,\n  ENERGY_MANAGER: 1,\n  CARBON_CALCULATION_VIEWER: 2,\n  MANAGE_CARBON_CALCULATION: 3,\n  SYSTEM_MONITOR: 4\n};\n\n// ç”¨æˆ·æƒé™å®šä¹‰\nconst permissions = {\n  MANAGE_USERS: 'manage_users',\n  MANAGE_DEVICES: 'manage_devices',\n  VIEW_ENERGY_DATA: 'view_energy_data',\n  MANAGE_ENERGY_PREDICTION: 'manage_energy_prediction',\n  MANAGE_CARBON_CALCULATION: 'manage_carbon_calculation',\n  ACCESS_DASHBOARD: 'access_dashboard'\n};\n\n// è§’è‰²æƒé™æ˜ å°„\nconst _rolePermissions = {\n  [roles.ADMIN]: Object.values(permissions),\n  [roles.ENERGY_MANAGER]: [\n    permissions.VIEW_ENERGY_DATA,\n    permissions.MANAGE_ENERGY_PREDICTION,\n    permissions.MANAGE_CARBON_CALCULATION,\n    permissions.ACCESS_DASHBOARD\n  ],\n  [roles.VIEWER]: [permissions.VIEW_ENERGY_DATA, permissions.ACCESS_DASHBOARD]\n};\n\n// æƒé™éªŒè¯ä¸­é—´ä»¶\nexport function authenticateToken() {\n  return (req, res, next) => {\n    // ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œ\n    const authHeader = req.headers.authorization;\n    const token = authHeader && authHeader.split(' ')[1];\n\n    // å¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œè¿”å›401æœªæˆæƒ\n    if (!token) {\n      return res.status(401).json({ error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' });\n    }\n\n    // éªŒè¯ä»¤ç‰Œ\n    jwt.verify(token, config.jwt.secret, (err, user) => {\n      if (err) {\n        if (err.name === 'TokenExpiredError') {\n          return res.status(401).json({ error: 'è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ' });\n        } else if (err.name === 'JsonWebTokenError') {\n          return res.status(403).json({ error: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' });\n        }\n        return res.status(500).json({ error: 'ä»¤ç‰ŒéªŒè¯å¤±è´¥' });\n      }\n\n      req.user = user;\n      next();\n    });\n  };\n}\n\n// ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ\nexport function generateAccessToken(user) {\n  // ç­¾å‘æ–°çš„ä»¤ç‰Œ\n  return jwt.sign(\n    {\n      username: user.username,\n      role: user.role,\n      userId: user.userId || uuidv4()\n    },\n    config.jwt.secret,\n    { expiresIn: config.jwt.accessTokenExpiry }\n  );\n}\n\n// æ£€æŸ¥ç”¨æˆ·æƒé™\nexport function checkPermission(requiredRole) {\n  return (req, res, next) => {\n    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™\n    if (!req.user || !req.user.role || req.user.role < requiredRole) {\n      return res.status(403).json({ error: 'æ²¡æœ‰è¶³å¤Ÿçš„æƒé™æ‰§è¡Œæ­¤æ“ä½œ' });\n    }\n\n    // ç”¨æˆ·æœ‰è¶³å¤Ÿæƒé™ï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶\n    next();\n  };\n}\n\n// ç”¨æˆ·æƒé™ç®¡ç†\nexport function setupUserRoutes(app, authenticateToken) {\n  // è·å–æ‰€æœ‰ç”¨æˆ·\n  app.get('/users', authenticateToken(), (req, res) => {\n    // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®åº“\n    const mockUsers = [\n      { id: 1, username: 'admin', roles: ['ADMIN'] },\n      { id: 2, username: 'manager', roles: ['ENERGY_MANAGER'] }\n    ];\n    const users = mockUsers.map((user) => ({\n      id: user.id,\n      username: user.username,\n      roles: user.roles\n    }));\n\n    res.json(users);\n  });\n\n  // åˆ›å»ºæ–°ç”¨æˆ·\n  app.post('/users', authenticateToken(), (req, res) => {\n    const { username, password, role } = req.body;\n\n    if (!username || !password || !role) {\n      res.status(400).json({ error: 'ç¼ºå°‘å¿…è¦å‚æ•°' });\n      return;\n    }\n\n    if (roles[role] === undefined) {\n      res.status(400).json({ error: 'æ— æ•ˆçš„è§’è‰²' });\n      return;\n    }\n\n    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨ - æ¨¡æ‹Ÿæ£€æŸ¥\n    const mockUsers = ['admin', 'manager'];\n    const existingUser = mockUsers.includes(username);\n    if (existingUser) {\n      res.status(400).json({ error: 'ç”¨æˆ·åå·²å­˜åœ¨' });\n      return;\n    }\n\n    // åˆ›å»ºæ–°ç”¨æˆ· - æ¨¡æ‹Ÿåˆ›å»º\n    const newUser = {\n      id: Date.now(),\n      username,\n      password: `hashed_${password}`, // æ¨¡æ‹Ÿå¯†ç å“ˆå¸Œ\n      roles: [role]\n    };\n\n    // æ¨¡æ‹Ÿä¿å­˜åˆ°æ•°æ®åº“\n    console.log('ç”¨æˆ·å·²åˆ›å»º:', newUser.username);\n\n    // è¿”å›åˆ›å»ºçš„ç”¨æˆ·ï¼ˆä¸åŒ…å«å¯†ç ï¼‰\n    const { password: _, ...userWithoutPassword } = newUser;\n    res.status(201).json(userWithoutPassword);\n  });\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/core/services/recommendationService.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":85,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":85,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: -3.","line":156,"column":22,"nodeType":"UnaryExpression","messageId":"noMagic","endLine":156,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":156,"column":72,"nodeType":"Literal","messageId":"noMagic","endLine":156,"endColumn":73},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: -3.","line":221,"column":39,"nodeType":"UnaryExpression","messageId":"noMagic","endLine":221,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.7.","line":298,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":298,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":309,"column":63,"nodeType":"Literal","messageId":"noMagic","endLine":309,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":309,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":309,"endColumn":72},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":309,"column":75,"nodeType":"Literal","messageId":"noMagic","endLine":309,"endColumn":77},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":434,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":434,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":442,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":442,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":540,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":540,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":540,"column":85,"nodeType":"Literal","messageId":"noMagic","endLine":540,"endColumn":86},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":540,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":540,"endColumn":90},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":540,"column":93,"nodeType":"Literal","messageId":"noMagic","endLine":540,"endColumn":94},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":541,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":541,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":555,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":555,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":556,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":556,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":556,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":556,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":606,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":606,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":606,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":606,"endColumn":60},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":609,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":609,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 365.","line":610,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":610,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":612,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":612,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 365.","line":612,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":612,"endColumn":60},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":612,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":612,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":624,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":624,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":624,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":624,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":625,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":625,"endColumn":63},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":625,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":625,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":652,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":652,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":652,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":652,"endColumn":64},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":654,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":654,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":656,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":656,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":671,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":671,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":671,"column":80,"nodeType":"Literal","messageId":"noMagic","endLine":671,"endColumn":81},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":672,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":672,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":672,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":672,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":673,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":673,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5000.","line":699,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":699,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":699,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":699,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.2.","line":702,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":702,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.2.","line":703,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":703,"endColumn":62},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":776,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":776,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[21385,21430],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":43,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Recommendation from '../models/recommendation.js';\nimport EnergyData from '../models/energyData.js';\nimport CarbonData from '../models/carbonData.js';\nimport Device from '../models/Device.js';\nimport StorageDevice from '../models/storageDevice.js';\nimport { Op } from 'sequelize';\nimport moment from 'moment';\nimport { v4 as uuidv4 } from 'uuid';\n\n/**\n * æ¨èæœåŠ¡ç±»ï¼Œå¤„ç†æ¨èè§„åˆ™è¯„ä¼°å’Œå»ºè®®ç”Ÿæˆ\n */\nclass RecommendationService {\n  /**\n   * åŸºäºç³»ç»Ÿæ•°æ®ç”Ÿæˆæ¨è\n   * @param {Object} userContext - ç”¨æˆ·ä¸Šä¸‹æ–‡\n   * @returns {Promise<Array>} æ¨èç»“æœåˆ—è¡¨\n   */\n  static async generateSystemRecommendations(userContext) {\n    // è·å–ç³»ç»Ÿæ•°æ®\n    const systemData = await this._collectSystemData(userContext);\n\n    // ä¸°å¯Œç”¨æˆ·ä¸Šä¸‹æ–‡\n    const enrichedContext = {\n      ...userContext,\n      ...systemData\n    };\n\n    // ä½¿ç”¨æ¨èæ¨¡å‹ç”Ÿæˆæ¨è\n    const recommendations = await Recommendation.generateRecommendations(enrichedContext);\n\n    // å¢å¼ºæ¨èå†…å®¹\n    const enhancedRecommendations = await this._enhanceRecommendations(recommendations);\n\n    return enhancedRecommendations;\n  }\n\n  /**\n   * æ”¶é›†ç³»ç»Ÿæ•°æ®ç”¨äºæ¨è\n   * @param {Object} userContext - ç”¨æˆ·ä¸Šä¸‹æ–‡\n   * @returns {Promise<Object>} ç³»ç»Ÿæ•°æ®\n   */\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 25 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 25 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 25 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 25 è¡Œ)\n\n  static async _collectSystemData(userContext) {\n    const { parkId, buildingId, timeRange = '7d' } = userContext;\n    const endDate = new Date();\n    const startDate = moment().subtract(this._parseTimeRange(timeRange), 'days').toDate();\n\n    // å¹¶è¡Œæ”¶é›†å„ç±»æ•°æ®\n    const [energyConsumption, carbonEmissions, deviceStatus, storageDevices, peakLoadData] =\n      await Promise.all([\n        this._getEnergyConsumption(parkId, buildingId, startDate, endDate),\n        this._getCarbonEmissions(parkId, buildingId, startDate, endDate),\n        this._getDeviceStatus(parkId, buildingId),\n        this._getStorageDevices(parkId, buildingId),\n        this._getPeakLoadData(parkId, buildingId, startDate, endDate)\n      ]);\n\n    return {\n      energyConsumption,\n      carbonEmissions,\n      deviceStatus,\n      storageDevices,\n      peakLoadData,\n      timeRange,\n      currentTime: new Date()\n    };\n  }\n\n  /**\n   * è§£ææ—¶é—´èŒƒå›´å­—ç¬¦ä¸²\n   * @param {string} timeRange - æ—¶é—´èŒƒå›´å­—ç¬¦ä¸²ï¼Œå¦‚ '7d' è¡¨ç¤º7å¤©\n   * @returns {number} å¤©æ•°\n   */\n  static _parseTimeRange(timeRange) {\n    const days = parseInt(timeRange.replace('d', ''), 10);\n    return isNaN(days) ? 7 : days;\n  }\n\n  /**\n   * è·å–èƒ½æºæ¶ˆè€—æ•°æ®\n   * @param {string} parkId - å›­åŒºID\n   * @param {string} buildingId - å»ºç­‘ID\n   * @param {Date} startDate - å¼€å§‹æ—¥æœŸ\n   * @param {Date} endDate - ç»“æŸæ—¥æœŸ\n   * @returns {Promise<Object>} èƒ½æºæ¶ˆè€—æ•°æ®\n   */\n  static async _getEnergyConsumption(parkId, buildingId, startDate, endDate) {\n    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n    const whereClause = { timestamp: { [Op.between]: [startDate, endDate] } };\n    if (parkId) {\n      whereClause.park_id = parkId;\n    }\n    if (buildingId) {\n      whereClause.building_id = buildingId;\n    }\n\n    // æŸ¥è¯¢èƒ½æºæ•°æ®\n    const energyData = await EnergyData.findAll({\n      where: whereClause,\n      attributes: [\n        [\n          EnergyData.sequelize.fn('strftime', '%Y-%m-%d', EnergyData.sequelize.col('timestamp')),\n          'date'\n        ],\n        [EnergyData.sequelize.fn('SUM', EnergyData.sequelize.col('value')), 'total_consumption'],\n        'type'\n      ],\n      group: ['date', 'type'],\n      order: [['date', 'ASC']]\n    });\n\n    // æ ¼å¼åŒ–æ•°æ®\n    const formattedData = {};\n    energyData.forEach((item) => {\n      const date = item.get('date');\n      const type = item.get('type');\n      const consumption = parseFloat(item.get('total_consumption'));\n\n      if (!formattedData[date]) {\n        formattedData[date] = {};\n      }\n      formattedData[date][type] = consumption;\n    });\n\n    // è®¡ç®—å¹³å‡å€¼å’Œè¶‹åŠ¿\n    const dailyAverages = {};\n    const energyTypes = new Set();\n\n    Object.values(formattedData).forEach((dailyData) => {\n      Object.entries(dailyData).forEach(([type, value]) => {\n        energyTypes.add(type);\n        // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n        // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n        // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n        // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n        if (!dailyAverages[type]) {\n          dailyAverages[type] = [];\n        }\n        dailyAverages[type].push(value);\n      });\n    });\n\n    const trends = {};\n    Object.entries(dailyAverages).forEach(([type, values]) => {\n      const avg = values.reduce((sum, val) => sum + val, 0) / values.length;\n      const recentAvg =\n        values.slice(-3).reduce((sum, val) => sum + val, 0) / Math.min(3, values.length);\n      trends[type] = {\n        average: avg,\n        recentAverage: recentAvg,\n        trend: recentAvg > avg ? 'increasing' : recentAvg < avg ? 'decreasing' : 'stable',\n        changeRate: avg ? Math.abs((recentAvg - avg) / avg) : 0\n      };\n    });\n\n    return {\n      dailyData: formattedData,\n      trends,\n      types: Array.from(energyTypes)\n    };\n  }\n\n  /**\n   * è·å–ç¢³æ’æ”¾æ•°æ®\n   * @param {string} parkId - å›­åŒºID\n   * @param {string} buildingId - å»ºç­‘ID\n   * @param {Date} startDate - å¼€å§‹æ—¥æœŸ\n   * @param {Date} endDate - ç»“æŸæ—¥æœŸ\n   * @returns {Promise<Object>} ç¢³æ’æ”¾æ•°æ®\n   */\n  static async _getCarbonEmissions(parkId, buildingId, startDate, endDate) {\n    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n    const whereClause = { timestamp: { [Op.between]: [startDate, endDate] } };\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (parkId) {\n      whereClause.park_id = parkId;\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (buildingId) {\n      whereClause.building_id = buildingId;\n    }\n\n    // æŸ¥è¯¢ç¢³æ’æ”¾æ•°æ®\n    const carbonData = await CarbonData.findAll({\n      where: whereClause,\n      attributes: [\n        [\n          CarbonData.sequelize.fn('strftime', '%Y-%m-%d', CarbonData.sequelize.col('timestamp')),\n          'date'\n        ],\n        [CarbonData.sequelize.fn('SUM', CarbonData.sequelize.col('value')), 'total_emissions']\n      ],\n      group: ['date'],\n      order: [['date', 'ASC']]\n    });\n\n    // æ ¼å¼åŒ–æ•°æ®\n    const dailyData = {};\n    carbonData.forEach((item) => {\n      dailyData[item.get('date')] = parseFloat(item.get('total_emissions'));\n    });\n\n    // è®¡ç®—è¶‹åŠ¿\n    const values = Object.values(dailyData);\n    const avg = values.length ? values.reduce((sum, val) => sum + val, 0) / values.length : 0;\n    const recentValues = values.slice(-3);\n    const recentAvg = recentValues.length\n      ? recentValues.reduce((sum, val) => sum + val, 0) / recentValues.length\n      : 0;\n    const trend = recentAvg > avg ? 'increasing' : recentAvg < avg ? 'decreasing' : 'stable';\n    const changeRate = avg ? Math.abs((recentAvg - avg) / avg) : 0;\n\n    return {\n      dailyData,\n      average: avg,\n      recentAverage: recentAvg,\n      trend,\n      changeRate,\n      total: values.reduce((sum, val) => sum + val, 0)\n    };\n  }\n\n  /**\n   * è·å–è®¾å¤‡çŠ¶æ€\n   * @param {string} parkId - å›­åŒºID\n   * @param {string} buildingId - å»ºç­‘ID\n   * @returns {Promise<Object>} è®¾å¤‡çŠ¶æ€æ•°æ®\n   */\n  static async _getDeviceStatus(parkId, buildingId) {\n    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n    const whereClause = {};\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (parkId) {\n      whereClause.park_id = parkId;\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (buildingId) {\n      whereClause.building_id = buildingId;\n    }\n\n    // æŸ¥è¯¢è®¾å¤‡\n    const devices = await Device.findAll({\n      where: whereClause,\n      attributes: ['id', 'name', 'type', 'status', 'last_active', 'efficiency', 'model']\n    });\n\n    // åˆ†ç±»ç»Ÿè®¡\n    const statusCounts = {\n      online: 0,\n      offline: 0,\n      warning: 0,\n      error: 0\n    };\n\n    const typeCounts = {};\n    const inefficientDevices = [];\n    const offlineDevices = [];\n\n    devices.forEach((device) => {\n      const status = device.status || 'unknown';\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (statusCounts[status] !== undefined) {\n        statusCounts[status]++;\n      }\n\n      const type = device.type || 'unknown';\n      typeCounts[type] = (typeCounts[type] || 0) + 1;\n\n      // æ ‡è®°æ•ˆç‡ä½ä¸‹çš„è®¾å¤‡\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (device.efficiency && device.efficiency < 0.7) {\n        inefficientDevices.push(device);\n      }\n\n      // æ ‡è®°ç¦»çº¿è®¾å¤‡\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (status === 'offline' && device.last_active) {\n        const lastActive = new Date(device.last_active);\n        const hoursSinceActive = (new Date() - lastActive) / (1000 * 60 * 60);\n        // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n        // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n        // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n        // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n        if (hoursSinceActive > 2) {\n          offlineDevices.push({\n            ...device.toJSON(),\n            hoursOffline: hoursSinceActive\n          });\n        }\n      }\n    });\n\n    return {\n      total: devices.length,\n      statusCounts,\n      typeCounts,\n      inefficientDevices,\n      offlineDevices\n    };\n  }\n\n  /**\n   * è·å–å‚¨èƒ½è®¾å¤‡æ•°æ®\n   * @param {string} parkId - å›­åŒºID\n   * @param {string} buildingId - å»ºç­‘ID\n   * @returns {Promise<Array>} å‚¨èƒ½è®¾å¤‡åˆ—è¡¨\n   */\n  static async _getStorageDevices(parkId, buildingId) {\n    // å…ˆæŸ¥è¯¢è®¾å¤‡\n    const whereClause = { type: 'energy_storage' };\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (parkId) {\n      whereClause.park_id = parkId;\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (buildingId) {\n      whereClause.building_id = buildingId;\n    }\n\n    const storageDevices = await Device.findAll({\n      where: whereClause,\n      attributes: ['id', 'name', 'status', 'last_active']\n    });\n\n    // è·å–è¯¦ç»†å‚æ•°\n    const detailedDevices = await Promise.all(\n      storageDevices.map(async (device) => {\n        const params = await StorageDevice.findByDeviceId(device.id);\n        return {\n          ...device.toJSON(),\n          params\n        };\n      })\n    );\n\n    return detailedDevices;\n  }\n\n  /**\n   * è·å–å³°å€¼è´Ÿè·æ•°æ®\n   * @param {string} parkId - å›­åŒºID\n   * @param {string} buildingId - å»ºç­‘ID\n   * @param {Date} startDate - å¼€å§‹æ—¥æœŸ\n   * @param {Date} endDate - ç»“æŸæ—¥æœŸ\n   * @returns {Promise<Object>} å³°å€¼è´Ÿè·æ•°æ®\n   */\n  static async _getPeakLoadData(parkId, buildingId, startDate, endDate) {\n    // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n    const whereClause = { timestamp: { [Op.between]: [startDate, endDate] } };\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (parkId) {\n      whereClause.park_id = parkId;\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (buildingId) {\n      whereClause.building_id = buildingId;\n    }\n\n    // æŸ¥è¯¢ç”µåŠ›æ•°æ®\n    const electricityData = await EnergyData.findAll({\n      where: {\n        ...whereClause,\n        type: 'electricity'\n      },\n      attributes: ['timestamp', 'value'],\n      order: [['timestamp', 'ASC']]\n    });\n\n    // æŒ‰å°æ—¶èšåˆ\n    const hourlyData = {};\n    electricityData.forEach((item) => {\n      const hour = moment(item.timestamp).format('YYYY-MM-DD HH:00');\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (!hourlyData[hour]) {\n        hourlyData[hour] = [];\n      }\n      hourlyData[hour].push(parseFloat(item.value));\n    });\n\n    // è®¡ç®—æ¯å°æ—¶å¹³å‡å€¼\n    const hourlyAverages = {};\n    Object.entries(hourlyData).forEach(([hour, values]) => {\n      const avg = values.reduce((sum, val) => sum + val, 0) / values.length;\n      hourlyAverages[hour] = avg;\n    });\n\n    // æ‰¾å‡ºå³°å€¼æ—¶æ®µ\n    const sortedHours = Object.entries(hourlyAverages).sort((a, b) => b[1] - a[1]);\n    const peakHours = sortedHours.slice(0, 5).map(([hour, value]) => ({\n      hour: hour.split(' ')[1],\n      averageLoad: value,\n      date: hour.split(' ')[0]\n    }));\n\n    // æ‰¾å‡ºç”¨ç”µé«˜å³°æ—¶æ®µï¼ˆå°æ—¶ï¼‰\n    const hourDistribution = {};\n    for (let i = 0; i < 24; i++) {\n      hourDistribution[i] = [];\n    }\n\n    Object.entries(hourlyAverages).forEach(([hour, value]) => {\n      const hourOfDay = parseInt(hour.split(' ')[1].split(':')[0], 10);\n      hourDistribution[hourOfDay].push(value);\n    });\n\n    const hourlyDistribution = {};\n    Object.entries(hourDistribution).forEach(([hour, values]) => {\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (values.length) {\n        hourlyDistribution[hour] = values.reduce((sum, val) => sum + val, 0) / values.length;\n      }\n    });\n\n    // æ‰¾å‡ºç”¨ç”µé«˜å³°æ—¶æ®µ\n    const peakHour = Object.entries(hourlyDistribution).sort((a, b) => b[1] - a[1])[0] || [0, 0];\n\n    return {\n      hourlyAverages,\n      peakHours,\n      peakHour: parseInt(peakHour[0], 10),\n      peakLoad: peakHour[1]\n    };\n  }\n\n  /**\n   * å¢å¼ºæ¨èå†…å®¹ï¼Œæ·»åŠ å…·ä½“æ•°æ®å’Œå®æ–½æ­¥éª¤\n   * @param {Array} recommendations - åŸå§‹æ¨èåˆ—è¡¨\n   * @returns {Promise<Array>} å¢å¼ºåçš„æ¨èåˆ—è¡¨\n   */\n  static async _enhanceRecommendations(recommendations) {\n    return Promise.all(\n      recommendations.map(async (recommendation) => {\n        // æ ¹æ®æ¨èç±»å‹æ·»åŠ å…·ä½“å†…å®¹\n        let details = {};\n\n        // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 26 è¡Œ)\n\n        // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 26 è¡Œ)\n\n        // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 26 è¡Œ)\n\n        // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 26 è¡Œ)\n\n        let implementationSteps = [];\n        let potentialSavings = {};\n\n        switch (recommendation.type) {\n          case 'energy_saving':\n            details = await this._calculateEnergySavingDetails(recommendation);\n            implementationSteps = this._getEnergySavingSteps(recommendation);\n            potentialSavings = await this._estimateEnergySavings(recommendation);\n            break;\n          case 'cost_reduction':\n            details = await this._calculateCostReductionDetails(recommendation);\n            implementationSteps = this._getCostReductionSteps(recommendation);\n            potentialSavings = await this._estimateCostSavings(recommendation);\n            break;\n          case 'maintenance':\n            details = await this._getMaintenanceDetails(recommendation);\n            implementationSteps = this._getMaintenanceSteps(recommendation);\n            potentialSavings = await this._estimateMaintenanceSavings(recommendation);\n            break;\n          default:\n            details = { description: 'æ¨èè¯¦æƒ…æ­£åœ¨è®¡ç®—ä¸­' };\n            implementationSteps = [\n              'æŸ¥çœ‹æ¨èè¯¦æƒ…',\n              'è¯„ä¼°å®æ–½éš¾åº¦',\n              'åˆ¶å®šå®æ–½è®¡åˆ’',\n              'æ‰§è¡Œæ¨èæªæ–½',\n              'éªŒè¯å®æ–½æ•ˆæœ'\n            ];\n        }\n\n        return {\n          ...recommendation,\n          details,\n          implementationSteps,\n          potentialSavings,\n          estimatedImplementationTime: this._estimateImplementationTime(recommendation)\n        };\n      })\n    );\n  }\n\n  /**\n   * ä¼°ç®—å®æ–½æ—¶é—´\n   * @param {Object} recommendation - æ¨è\n   * @returns {string} ä¼°ç®—æ—¶é—´\n   */\n  static _estimateImplementationTime(recommendation) {\n    // æ ¹æ®ä¼˜å…ˆçº§å’Œç±»å‹ä¼°ç®—å®æ–½æ—¶é—´\n    const baseHours = recommendation.priority >= 8 ? 2 : recommendation.priority >= 5 ? 4 : 8;\n    const typeFactor = recommendation.type === 'maintenance' ? 0.8 : 1;\n    const hours = Math.round(baseHours * typeFactor);\n\n    return hours <= 1 ? '1å°æ—¶ä»¥å†…' : `${hours}å°æ—¶`;\n  }\n\n  /**\n   * è®¡ç®—èŠ‚èƒ½æ¨èè¯¦æƒ…\n   * @param {Object} recommendation - æ¨è\n   * @returns {Promise<Object>} èŠ‚èƒ½è¯¦æƒ…\n   */\n  static async _calculateEnergySavingDetails(recommendation) {\n    // è¿™é‡Œåº”è¯¥æœ‰æ›´å¤æ‚çš„è®¡ç®—é€»è¾‘\n    return {\n      currentConsumption: Math.round(Math.random() * 1000),\n      potentialReduction: Math.round(Math.random() * 30 + 10),\n      unit: 'kWh/å¤©',\n      affectedDevices: recommendation.actions?.deviceIds?.length || 1\n    };\n  }\n\n  /**\n   * è·å–èŠ‚èƒ½å®æ–½æ­¥éª¤\n   * @param {Object} recommendation - æ¨è\n   * @returns {Array} å®æ–½æ­¥éª¤\n   */\n  static _getEnergySavingSteps(recommendation) {\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (recommendation.actions?.type === 'schedule_adjustment') {\n      return [\n        'åˆ†æå½“å‰è®¾å¤‡è¿è¡Œæ—¶é—´è¡¨',\n        'è°ƒæ•´è®¾å¤‡è¿è¡Œæ—¶æ®µè‡³éé«˜å³°æ—¶æ®µ',\n        'è®¾ç½®æ–°çš„è®¾å¤‡è¿è¡Œè®¡åˆ’',\n        'ç›‘æ§è°ƒæ•´åçš„èƒ½è€—å˜åŒ–',\n        'æ ¹æ®æ•ˆæœå¾®è°ƒè¿è¡Œè®¡åˆ’'\n      ];\n    } else if (recommendation.actions?.type === 'device_adjustment') {\n      return [\n        'æ£€æŸ¥ç›®æ ‡è®¾å¤‡å½“å‰è®¾ç½®',\n        'è°ƒæ•´è®¾å¤‡å‚æ•°è‡³ä¼˜åŒ–å€¼',\n        'æµ‹è¯•è°ƒæ•´åçš„è®¾å¤‡è¿è¡ŒçŠ¶æ€',\n        'è®°å½•èƒ½è€—å˜åŒ–æ•°æ®',\n        'ç¡®è®¤èŠ‚èƒ½æ•ˆæœ'\n      ];\n    }\n\n    return [\n      'è¯„ä¼°å½“å‰èƒ½æºä½¿ç”¨æƒ…å†µ',\n      'åˆ¶å®šèŠ‚èƒ½æªæ–½å®æ–½è®¡åˆ’',\n      'å®æ–½èŠ‚èƒ½æªæ–½',\n      'ç›‘æ§èƒ½æºæ¶ˆè€—å˜åŒ–',\n      'ä¼˜åŒ–è°ƒæ•´èŠ‚èƒ½æªæ–½'\n    ];\n  }\n\n  /**\n   * ä¼°ç®—èŠ‚èƒ½æ•ˆæœ\n   * @param {Object} recommendation - æ¨è\n   * @returns {Promise<Object>} èŠ‚èƒ½ä¼°ç®—\n   */\n  static async _estimateEnergySavings(_recommendation) {\n    // è¿™é‡Œåº”è¯¥æœ‰æ›´å¤æ‚çš„ä¼°ç®—é€»è¾‘\n    const dailySavings = Math.round(Math.random() * 50 + 10);\n    return {\n      daily: dailySavings,\n      monthly: Math.round(dailySavings * 30),\n      annual: Math.round(dailySavings * 365),\n      unit: 'kWh',\n      carbonReduction: Math.round((dailySavings * 0.5 * 365) / 1000) // ç²—ç•¥ä¼°ç®—ç¢³æ’æ”¾å‡å°‘\n    };\n  }\n\n  /**\n   * è®¡ç®—æˆæœ¬é™ä½è¯¦æƒ…\n   * @param {Object} recommendation - æ¨è\n   * @returns {Promise<Object>} æˆæœ¬è¯¦æƒ…\n   */\n  static async _calculateCostReductionDetails(_recommendation) {\n    // è¿™é‡Œåº”è¯¥æœ‰æ›´å¤æ‚çš„è®¡ç®—é€»è¾‘\n    return {\n      currentCost: Math.round(Math.random() * 1000 + 500),\n      potentialReductionPercent: Math.round(Math.random() * 20 + 5),\n      unit: 'å…ƒ/æœˆ'\n    };\n  }\n\n  /**\n   * è·å–æˆæœ¬é™ä½å®æ–½æ­¥éª¤\n   * @param {Object} recommendation - æ¨è\n   * @returns {Array} å®æ–½æ­¥éª¤\n   */\n  static _getCostReductionSteps() {\n    return [\n      'åˆ†æå½“å‰èƒ½æºæˆæœ¬ç»“æ„',\n      'è¯†åˆ«æˆæœ¬ä¼˜åŒ–æœºä¼š',\n      'åˆ¶å®šæˆæœ¬ä¼˜åŒ–æ–¹æ¡ˆ',\n      'å®æ–½æˆæœ¬ä¼˜åŒ–æªæ–½',\n      'ç›‘æ§æˆæœ¬å˜åŒ–å¹¶è°ƒæ•´'\n    ];\n  }\n\n  /**\n   * ä¼°ç®—æˆæœ¬èŠ‚çº¦\n   * @param {Object} recommendation - æ¨è\n   * @returns {Promise<Object>} æˆæœ¬èŠ‚çº¦ä¼°ç®—\n   */\n  static async _estimateCostSavings(_recommendation) {\n    // è¿™é‡Œåº”è¯¥æœ‰æ›´å¤æ‚çš„ä¼°ç®—é€»è¾‘\n    const monthlySavings = Math.round(Math.random() * 500 + 100);\n    return {\n      daily: Math.round(monthlySavings / 30),\n      monthly: monthlySavings,\n      annual: Math.round(monthlySavings * 12),\n      unit: 'å…ƒ'\n    };\n  }\n\n  /**\n   * è·å–ç»´æŠ¤è¯¦æƒ…\n   * @param {Object} recommendation - æ¨è\n   * @returns {Promise<Object>} ç»´æŠ¤è¯¦æƒ…\n   */\n  static async _getMaintenanceDetails(recommendation) {\n    // è¿™é‡Œåº”è¯¥æœ‰æ›´å¤æ‚çš„é€»è¾‘\n    return {\n      deviceName: recommendation.actions?.deviceName || 'ç›®æ ‡è®¾å¤‡',\n      issue: recommendation.actions?.issue || 'æ½œåœ¨æ•…éšœé£é™©',\n      urgency: recommendation.priority >= 8 ? 'é«˜' : recommendation.priority >= 5 ? 'ä¸­' : 'ä½',\n      estimatedCost: Math.round(Math.random() * 1000 + 200),\n      estimatedDowntime: Math.round(Math.random() * 4 + 1) // å°æ—¶\n    };\n  }\n\n  /**\n   * è·å–ç»´æŠ¤å®æ–½æ­¥éª¤\n   * @param {Object} recommendation - æ¨è\n   * @returns {Array} å®æ–½æ­¥éª¤\n   */\n  static _getMaintenanceSteps() {\n    return [\n      'å‡†å¤‡ç»´æŠ¤å·¥å…·å’Œå¤‡ä»¶',\n      'å®‰æ’ç»´æŠ¤æ—¶é—´çª—å£',\n      'æ‰§è¡Œç»´æŠ¤æ“ä½œ',\n      'æµ‹è¯•è®¾å¤‡è¿è¡ŒçŠ¶æ€',\n      'è®°å½•ç»´æŠ¤ç»“æœ'\n    ];\n  }\n\n  /**\n   * ä¼°ç®—ç»´æŠ¤èŠ‚çº¦\n   * @param {Object} recommendation - æ¨è\n   * @returns {Promise<Object>} ç»´æŠ¤èŠ‚çº¦ä¼°ç®—\n   */\n  static async _estimateMaintenanceSavings() {\n    // è¿™é‡Œåº”è¯¥æœ‰æ›´å¤æ‚çš„ä¼°ç®—é€»è¾‘\n    const potentialCost = Math.round(Math.random() * 5000 + 1000);\n    return {\n      potentialFailureCost: potentialCost,\n      maintenanceCost: Math.round(potentialCost * 0.2),\n      savings: potentialCost - Math.round(potentialCost * 0.2),\n      unit: 'å…ƒ'\n    };\n  }\n\n  /**\n   * è¯„ä¼°æ¨èå®æ–½æ•ˆæœ\n   * @param {string} recommendationId - æ¨èID\n   * @param {Date} startDate - å¼€å§‹æ—¥æœŸ\n   * @param {Date} endDate - ç»“æŸæ—¥æœŸ\n   * @returns {Promise<Object>} è¯„ä¼°ç»“æœ\n   */\n  static async evaluateRecommendationEffectiveness(recommendationId, startDate, endDate) {\n    // è·å–æ¨èè¯¦æƒ… - æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢\n    const recommendation = {\n      id: recommendationId,\n      type: 'energy_saving',\n      title: 'æ¨¡æ‹Ÿæ¨è',\n      description: 'è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„æ¨èé¡¹ç›®'\n    };\n    if (!recommendation) {\n      throw new Error('æ¨èä¸å­˜åœ¨');\n    }\n\n    // è·å–æ¨èåº”ç”¨å‰çš„æ•°æ®\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 25 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 25 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 25 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 25 è¡Œ)\n\n    const preStartDate = moment(startDate).subtract(1, 'month').toDate();\n    const preEndDate = moment(startDate).subtract(1, 'day').toDate();\n\n    // æ ¹æ®æ¨èç±»å‹è¯„ä¼°æ•ˆæœ\n    let evaluation = {};\n\n    switch (recommendation.type) {\n      case 'energy_saving':\n        evaluation = await this._evaluateEnergySavingEffectiveness(\n          recommendation,\n          preStartDate,\n          preEndDate,\n          startDate,\n          endDate\n        );\n        break;\n      case 'cost_reduction':\n        evaluation = await this._evaluateCostReductionEffectiveness(\n          recommendation,\n          preStartDate,\n          preEndDate,\n          startDate,\n          endDate\n        );\n        break;\n      default:\n        evaluation = {\n          status: 'not_evaluated',\n          message: 'æš‚ä¸æ”¯æŒè¯¥ç±»å‹æ¨èçš„è‡ªåŠ¨è¯„ä¼°'\n        };\n    }\n\n    // ä¿å­˜è¯„ä¼°ç»“æœ - æ¨¡æ‹Ÿä¿å­˜\n    const evaluationRecord = {\n      id: uuidv4(),\n      recommendation_id: recommendationId,\n      evaluation_data: JSON.stringify(evaluation),\n      evaluated_at: new Date()\n    };\n    console.log('è¯„ä¼°ç»“æœå·²ä¿å­˜:', evaluationRecord.id);\n\n    return evaluation;\n  }\n}\n\nexport default RecommendationService;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/data/collector.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1883.","line":27,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":27,"endColumn":61},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":62,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":62,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1583,1613],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":74,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":74,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1971,2015],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":79,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":79,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2111,2139],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":84,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":84,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2239,2271],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":87,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":87,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2310,2345],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":99,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":99,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2562,2611],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":101,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":101,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2639,2673],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":118,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":118,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3012,3055],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":134,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":134,"endColumn":23,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[3448,3487],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":137,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":137,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3524,3570],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":179,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":179,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4512,4538],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":185,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":185,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4626,4654],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":190,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":190,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":190,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":190,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":190,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":190,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":190,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":190,"endColumn":61},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":192,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":192,"endColumn":19,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[4806,4838],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":197,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":197,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4933,4963],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":203,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":203,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5117,5145],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100000.","line":217,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":217,"endColumn":55},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":219,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":219,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5488,5549],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":235,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":235,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5963,6028],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":254,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":254,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6396,6422],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":260,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":260,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6537,6568],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":278,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":278,"endColumn":38},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":280,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":280,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6965,7009],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":298,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":298,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[7330,7368],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":305,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":305,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[7520,7564],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":312,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":312,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[7726,7795],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":338,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":338,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8647,8750],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":342,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":342,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8779,8813],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":355,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":355,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[9043,9089],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":373,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":373,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9594,9626],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 32.","line":394,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":394,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":394,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":394,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":394,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":394,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 273.15.","line":395,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":395,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":411,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":411,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":411,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":411,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":422,"column":77,"nodeType":"Literal","messageId":"noMagic","endLine":422,"endColumn":78},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":430,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":430,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":437,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":437,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.3.","line":439,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":439,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.7.","line":439,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":439,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":439,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":439,"endColumn":63},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":439,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":439,"endColumn":71},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":444,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":444,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11558,11590],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":455,"column":82,"nodeType":"Literal","messageId":"noMagic","endLine":455,"endColumn":84},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":457,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":457,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":468,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":468,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":483,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":483,"endColumn":45},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":489,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":489,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12812,12844],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":497,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":497,"endColumn":53},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":535,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":535,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[13927,13961],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.001.","line":585,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":585,"endColumn":64},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.001.","line":587,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":587,"endColumn":65},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":632,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":632,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[16314,16350],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":634,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":634,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16379,16411],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":646,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":646,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[16614,16662],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":652,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":652,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[16781,16828],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":656,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":656,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[16877,16957],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":658,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":658,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[16986,17021],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":670,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":670,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[17203,17261],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":672,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":672,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[17290,17324],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":756,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":756,"endColumn":21,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[19310,19353],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":775,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":775,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[19848,19925],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":775,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":775,"endColumn":58},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":777,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":777,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[19954,19987],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":903,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":903,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[22577,22610],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":910,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":910,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[22674,22698],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":917,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":917,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[22790,22814],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":72,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createRequire } from 'module';\nimport { v4 as uuidv4 } from 'uuid';\nimport { dbPromise } from '../database.js';\nimport { alertManager as _alertManager } from '../alerts/AlertManager.js';\n\nconst require = createRequire(import.meta.url);\nconst mqtt = require('mqtt');\n\n/**\n * æ•°æ®é‡‡é›†å™¨ç±»\n * è´Ÿè´£MQTTæ•°æ®æ¥æ”¶ã€éªŒè¯ã€å¤„ç†å’Œå­˜å‚¨\n */\nclass DataCollector {\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 22 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 22 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 22 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 22 è¡Œ)\n\n  constructor(mqttConfig = {}) {\n    this.mqttClient = null;\n    this.config = {\n      host: mqttConfig.host || process.env.MQTT_HOST || 'localhost',\n      port: mqttConfig.port || process.env.MQTT_PORT || 1883,\n      username: mqttConfig.username || process.env.MQTT_USERNAME,\n      password: mqttConfig.password || process.env.MQTT_PASSWORD,\n      ...mqttConfig\n    };\n\n    this.topics = {\n      energy: 'energy/realtime/+',\n      carbon: 'carbon/realtime/+',\n      device_status: 'device/status/+',\n      sensor_data: 'sensor/data/+'\n    };\n\n    this.dataBuffer = new Map(); // æ•°æ®ç¼“å†²åŒº\n    this.isConnected = false;\n    this.lastMessageTime = null;\n    this.connectionTime = null;\n  }\n\n  /**\n   * åˆå§‹åŒ–MQTTè¿æ¥\n   */\n  async initialize() {\n    try {\n      const mqttUrl = `mqtt://${this.config.host}:${this.config.port}`;\n\n      this.mqttClient = mqtt.connect(mqttUrl, {\n        username: this.config.username,\n        password: this.config.password,\n        keepalive: 60,\n        reconnectPeriod: 5000,\n        connectTimeout: 30000\n      });\n\n      this.mqttClient.on('connect', () => {\n        console.log('âœ… MQTTæ•°æ®é‡‡é›†å™¨å·²è¿æ¥');\n        this.isConnected = true;\n        this.connectionTime = new Date().toISOString();\n        this.subscribeToTopics();\n      });\n\n      this.mqttClient.on('message', (topic, message) => {\n        this.lastMessageTime = new Date().toISOString();\n        this.handleMessage(topic, message);\n      });\n\n      this.mqttClient.on('error', error => {\n        console.error('âŒ MQTTè¿æ¥é”™è¯¯:', error.message);\n        this.isConnected = false;\n      });\n\n      this.mqttClient.on('close', () => {\n        console.log('ğŸ”Œ MQTTè¿æ¥å·²æ–­å¼€');\n        this.isConnected = false;\n      });\n\n      this.mqttClient.on('reconnect', () => {\n        console.log('ğŸ”„ æ­£åœ¨é‡æ–°è¿æ¥MQTT...');\n      });\n    } catch (error) {\n      console.error('MQTTåˆå§‹åŒ–å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * è®¢é˜…æ‰€æœ‰ä¸»é¢˜\n   */\n  subscribeToTopics() {\n    Object.entries(this.topics).forEach(([_key, topic]) => {\n      this.mqttClient.subscribe(topic, err => {\n        if (err) {\n          console.error(`âŒ è®¢é˜…ä¸»é¢˜å¤±è´¥ ${topic}:`, err.message);\n        } else {\n          console.log(`ğŸ“¡ å·²è®¢é˜…ä¸»é¢˜: ${topic}`);\n        }\n      });\n    });\n  }\n\n  /**\n   * å¤„ç†æ¥æ”¶åˆ°çš„MQTTæ¶ˆæ¯\n   */\n  async handleMessage(topic, message) {\n    try {\n      const payload = JSON.parse(message.toString());\n      const topicParts = topic.split('/');\n      const [dataType, , deviceId] = topicParts;\n\n      // éªŒè¯æ•°æ®æ ¼å¼\n      if (!this.validatePayload(payload, dataType)) {\n        console.error(`âŒ æ•°æ®æ ¼å¼éªŒè¯å¤±è´¥ - ä¸»é¢˜: ${topic}`);\n        return;\n      }\n\n      // æ ¹æ®æ•°æ®ç±»å‹å¤„ç†\n      switch (dataType) {\n        case 'energy':\n          await this.handleEnergyData(deviceId, payload);\n          break;\n        case 'sensor':\n          await this.handleSensorData(deviceId, payload);\n          break;\n        case 'device':\n          await this.handleDeviceStatus(deviceId, payload);\n          break;\n        default:\n          console.warn(`âš ï¸ æœªçŸ¥æ•°æ®ç±»å‹: ${dataType}`);\n      }\n    } catch (error) {\n      console.error(`æ¶ˆæ¯å¤„ç†å¤±è´¥ - ä¸»é¢˜: ${topic}`, error);\n    }\n  }\n\n  /**\n   * éªŒè¯æ•°æ®è½½è·æ ¼å¼\n   */\n  validatePayload(payload, dataType) {\n    const requiredFields = {\n      energy: ['timestamp', 'value', 'unit', 'type'],\n      sensor: ['timestamp', 'value', 'unit', 'sensor_id'],\n      device: ['timestamp', 'status']\n    };\n\n    const required = requiredFields[dataType];\n    if (!required) {return false;}\n\n    // æ£€æŸ¥å¿…å¡«å­—æ®µ\n    if (!required.every(field => Object.prototype.hasOwnProperty.call(payload, field))) {\n      return false;\n    }\n\n    // æ•°æ®ç±»å‹å’ŒèŒƒå›´éªŒè¯\n    switch (dataType) {\n      case 'energy':\n        return this.validateEnergyData(payload);\n      case 'sensor':\n        return this.validateSensorData(payload);\n      case 'device':\n        return this.validateDeviceData(payload);\n      default:\n        return false;\n    }\n  }\n\n  /**\n   * éªŒè¯èƒ½æºæ•°æ®\n   */\n  validateEnergyData(payload) {\n    // éªŒè¯æ—¶é—´æˆ³\n    const timestamp = new Date(payload.timestamp);\n    if (isNaN(timestamp.getTime())) {\n      console.error('æ— æ•ˆçš„æ—¶é—´æˆ³æ ¼å¼');\n      return false;\n    }\n\n    // éªŒè¯æ—¶é—´æˆ³ä¸èƒ½æ˜¯æœªæ¥æ—¶é—´\n    if (timestamp > new Date()) {\n      console.error('æ—¶é—´æˆ³ä¸èƒ½æ˜¯æœªæ¥æ—¶é—´');\n      return false;\n    }\n\n    // éªŒè¯æ—¶é—´æˆ³ä¸èƒ½å¤ªæ—§ï¼ˆè¶…è¿‡24å°æ—¶ï¼‰\n    const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n    if (timestamp < dayAgo) {\n      console.warn('æ•°æ®æ—¶é—´æˆ³è¿‡æ—§ï¼Œå¯èƒ½æ˜¯å†å²æ•°æ®');\n    }\n\n    // éªŒè¯æ•°å€¼\n    if (typeof payload.value !== 'number' || isNaN(payload.value)) {\n      console.error('èƒ½æºæ•°æ®å€¼å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—');\n      return false;\n    }\n\n    // éªŒè¯æ•°å€¼èŒƒå›´ï¼ˆä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œé™¤éæ˜¯ç‰¹æ®Šç±»å‹å¦‚å‡€èƒ½è€—ï¼‰\n    if (payload.value < 0 && !['net_energy', 'power_factor'].includes(payload.type)) {\n      console.error('èƒ½æºæ•°æ®å€¼ä¸èƒ½ä¸ºè´Ÿæ•°');\n      return false;\n    }\n\n    // éªŒè¯æ•°å€¼ä¸Šé™ï¼ˆé˜²æ­¢å¼‚å¸¸å¤§çš„æ•°å€¼ï¼‰\n    const maxValues = {\n      electricity: 10000, // kWh\n      water: 1000, // mÂ³\n      gas: 1000, // mÂ³\n      power: 5000, // kW\n      temperature: 100, // Â°C\n      humidity: 100 // %\n    };\n\n    const maxValue = maxValues[payload.type] || 100000;\n    if (payload.value > maxValue) {\n      console.error(`èƒ½æºæ•°æ®å€¼è¶…å‡ºåˆç†èŒƒå›´: ${payload.value} > ${maxValue}`);\n      return false;\n    }\n\n    // éªŒè¯å•ä½\n    const validUnits = {\n      electricity: ['kWh', 'MWh', 'kW', 'MW'],\n      water: ['mÂ³', 'L', 'gal'],\n      gas: ['mÂ³', 'L', 'ftÂ³'],\n      power: ['kW', 'MW', 'W'],\n      temperature: ['Â°C', 'Â°F', 'K'],\n      humidity: ['%']\n    };\n\n    const allowedUnits = validUnits[payload.type] || [];\n    if (allowedUnits.length > 0 && !allowedUnits.includes(payload.unit)) {\n      console.error(`æ— æ•ˆçš„å•ä½: ${payload.unit} for type ${payload.type}`);\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * éªŒè¯ä¼ æ„Ÿå™¨æ•°æ®\n   */\n  validateSensorData(payload) {\n    // éªŒè¯æ—¶é—´æˆ³\n    const timestamp = new Date(payload.timestamp);\n    if (isNaN(timestamp.getTime()) || timestamp > new Date()) {\n      return false;\n    }\n\n    // éªŒè¯ä¼ æ„Ÿå™¨IDæ ¼å¼\n    if (typeof payload.sensor_id !== 'string' || payload.sensor_id.length === 0) {\n      console.error('æ— æ•ˆçš„ä¼ æ„Ÿå™¨ID');\n      return false;\n    }\n\n    // éªŒè¯æ•°å€¼\n    if (typeof payload.value !== 'number' || isNaN(payload.value)) {\n      console.error('ä¼ æ„Ÿå™¨æ•°æ®å€¼å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—');\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * éªŒè¯è®¾å¤‡æ•°æ®\n   */\n  validateDeviceData(payload) {\n    // éªŒè¯æ—¶é—´æˆ³\n    const timestamp = new Date(payload.timestamp);\n    if (isNaN(timestamp.getTime()) || timestamp > new Date()) {\n      return false;\n    }\n\n    // éªŒè¯çŠ¶æ€å€¼\n    const validStatuses = [0, 1, 2, 3]; // 0:ç¦»çº¿, 1:åœ¨çº¿, 2:æ•…éšœ, 3:ç»´æŠ¤\n    if (!validStatuses.includes(payload.status)) {\n      console.error(`æ— æ•ˆçš„è®¾å¤‡çŠ¶æ€: ${payload.status}`);\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * å¤„ç†èƒ½æºæ•°æ®\n   */\n  async handleEnergyData(deviceId, payload) {\n    try {\n      const energyDataId = uuidv4();\n      const timestamp = new Date(payload.timestamp);\n\n      // éªŒè¯è®¾å¤‡æ˜¯å¦å­˜åœ¨\n      const device = await this.getDevice(deviceId);\n      if (!device) {\n        console.warn(`âš ï¸ è®¾å¤‡ä¸å­˜åœ¨: ${deviceId}`);\n        return;\n      }\n\n      // æ•°æ®æ¸…æ´—å’Œå¼‚å¸¸æ£€æµ‹\n      const cleanedData = await this.cleanEnergyData(deviceId, payload);\n      if (!cleanedData) {\n        console.warn(`âš ï¸ æ•°æ®æ¸…æ´—å¤±è´¥ï¼Œè·³è¿‡æ•°æ®: ${deviceId}`);\n        return;\n      }\n\n      // å¼‚å¸¸æ£€æµ‹\n      const anomalyResult = await this.detectAnomaly(deviceId, cleanedData);\n      if (anomalyResult.isAnomaly) {\n        console.warn(`ğŸš¨ æ£€æµ‹åˆ°å¼‚å¸¸æ•°æ®: ${deviceId}, åŸå› : ${anomalyResult.reason}`);\n        // å¯ä»¥é€‰æ‹©æ˜¯å¦å­˜å‚¨å¼‚å¸¸æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬æ ‡è®°ä½†ä»ç„¶å­˜å‚¨\n        cleanedData.is_anomaly = true;\n        cleanedData.anomaly_reason = anomalyResult.reason;\n      }\n\n      // å­˜å‚¨èƒ½æºæ•°æ®\n      await this.saveEnergyData({\n        id: energyDataId,\n        device_id: deviceId,\n        sensor_id: payload.sensor_id || null,\n        data_type: this.getEnergyDataType(payload.type),\n        value: cleanedData.value,\n        unit: cleanedData.unit,\n        timestamp: timestamp.toISOString(),\n        created_at: new Date().toISOString(),\n        is_anomaly: cleanedData.is_anomaly || false,\n        anomaly_reason: cleanedData.anomaly_reason || null\n      });\n\n      // è®¡ç®—å¹¶å­˜å‚¨ç¢³æ’æ”¾æ•°æ®\n      await this.calculateAndStoreCarbonEmission(energyDataId, payload.type, cleanedData.value);\n\n      // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘å‘Šè­¦\n      await this.checkAlertRules(deviceId, payload.sensor_id, cleanedData);\n\n      console.log(\n        `âœ… èƒ½æºæ•°æ®å·²ä¿å­˜ - è®¾å¤‡: ${deviceId}, å€¼: ${cleanedData.value}${cleanedData.unit}`\n      );\n    } catch (error) {\n      console.error('èƒ½æºæ•°æ®å¤„ç†å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * æ•°æ®æ¸…æ´—\n   */\n  async cleanEnergyData(deviceId, payload) {\n    try {\n      let cleanedValue = payload.value;\n\n      // 1. å»é™¤æ˜æ˜¾çš„é”™è¯¯å€¼ï¼ˆå¦‚è´Ÿæ•°ç”µé‡ï¼‰\n      if (payload.type === 'electricity' && cleanedValue < 0) {\n        console.warn(`ä¿®æ­£è´Ÿæ•°ç”µé‡å€¼: ${cleanedValue} -> 0`);\n        cleanedValue = 0;\n      }\n\n      // 2. å•ä½æ ‡å‡†åŒ–\n      const standardizedData = this.standardizeUnit(cleanedValue, payload.unit, payload.type);\n      cleanedValue = standardizedData.value;\n      const standardUnit = standardizedData.unit;\n\n      // 3. æ•°å€¼å¹³æ»‘ï¼ˆç§»åŠ¨å¹³å‡ï¼‰\n      const smoothedValue = await this.applySmoothingFilter(deviceId, payload.type, cleanedValue);\n\n      return {\n        value: smoothedValue,\n        unit: standardUnit,\n        type: payload.type\n      };\n    } catch (error) {\n      console.error('æ•°æ®æ¸…æ´—å¤±è´¥:', error);\n      return null;\n    }\n  }\n\n  /**\n   * å•ä½æ ‡å‡†åŒ–\n   */\n  standardizeUnit(value, unit, type) {\n    const conversions = {\n      electricity: {\n        MWh: { factor: 1000, standardUnit: 'kWh' },\n        Wh: { factor: 0.001, standardUnit: 'kWh' },\n        MW: { factor: 1000, standardUnit: 'kW' },\n        W: { factor: 0.001, standardUnit: 'kW' }\n      },\n      water: {\n        L: { factor: 0.001, standardUnit: 'mÂ³' },\n        gal: { factor: 0.00378541, standardUnit: 'mÂ³' }\n      },\n      temperature: {\n        'Â°F': { factor: f => ((f - 32) * 5) / 9, standardUnit: 'Â°C' },\n        K: { factor: k => k - 273.15, standardUnit: 'Â°C' }\n      }\n    };\n\n    const typeConversions = conversions[type];\n    if (!typeConversions || !typeConversions[unit]) {\n      return { value, unit }; // æ— éœ€è½¬æ¢\n    }\n\n    const conversion = typeConversions[unit];\n    const convertedValue =\n      typeof conversion.factor === 'function' ?\n        conversion.factor(value) :\n        value * conversion.factor;\n\n    return {\n      value: Math.round(convertedValue * 1000) / 1000, // ä¿ç•™3ä½å°æ•°\n      unit: conversion.standardUnit\n    };\n  }\n\n  /**\n   * åº”ç”¨å¹³æ»‘æ»¤æ³¢å™¨\n   */\n  async applySmoothingFilter(deviceId, dataType, value) {\n    try {\n      // è·å–æœ€è¿‘çš„å‡ ä¸ªæ•°æ®ç‚¹\n      const recentData = await this.getRecentEnergyData(deviceId, dataType, 5);\n\n      if (recentData.length < 2) {\n        return value; // æ•°æ®ä¸è¶³ï¼Œä¸è¿›è¡Œå¹³æ»‘\n      }\n\n      // è®¡ç®—ç§»åŠ¨å¹³å‡\n      const values = [...recentData.map(d => d.value), value];\n      const windowSize = Math.min(3, values.length);\n      const recentValues = values.slice(-windowSize);\n\n      const average = recentValues.reduce((sum, v) => sum + v, 0) / recentValues.length;\n\n      // å¦‚æœå½“å‰å€¼ä¸å¹³å‡å€¼å·®å¼‚è¿‡å¤§ï¼Œä½¿ç”¨åŠ æƒå¹³å‡\n      const deviation = Math.abs(value - average) / average;\n      if (deviation > 0.5) {\n        // åå·®è¶…è¿‡50%\n        return Math.round((value * 0.3 + average * 0.7) * 1000) / 1000;\n      }\n\n      return value;\n    } catch (error) {\n      console.error('å¹³æ»‘æ»¤æ³¢å¤±è´¥:', error);\n      return value;\n    }\n  }\n\n  /**\n   * å¼‚å¸¸æ£€æµ‹\n   */\n  async detectAnomaly(deviceId, data) {\n    try {\n      // è·å–å†å²æ•°æ®è¿›è¡Œç»Ÿè®¡åˆ†æ\n      const historicalData = await this.getRecentEnergyData(deviceId, data.type, 50);\n\n      if (historicalData.length < 10) {\n        return { isAnomaly: false }; // å†å²æ•°æ®ä¸è¶³\n      }\n\n      const values = historicalData.map(d => d.value);\n      const mean = values.reduce((sum, v) => sum + v, 0) / values.length;\n      const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length;\n      const stdDev = Math.sqrt(variance);\n\n      // Z-scoreå¼‚å¸¸æ£€æµ‹\n      const zScore = Math.abs(data.value - mean) / stdDev;\n      if (zScore > 3) {\n        // 3-sigmaè§„åˆ™\n        return {\n          isAnomaly: true,\n          reason: `Z-scoreå¼‚å¸¸: ${zScore.toFixed(2)} (é˜ˆå€¼: 3.0)`\n        };\n      }\n\n      // æ£€æŸ¥æ˜¯å¦ä¸ºçªç„¶çš„å¤§å¹…å˜åŒ–\n      const lastValue = values[values.length - 1];\n      const changeRate = Math.abs(data.value - lastValue) / lastValue;\n      if (changeRate > 2.0) {\n        // å˜åŒ–è¶…è¿‡200%\n        return {\n          isAnomaly: true,\n          reason: `çªç„¶å˜åŒ–: ${(changeRate * 100).toFixed(1)}% (é˜ˆå€¼: 200%)`\n        };\n      }\n\n      return { isAnomaly: false };\n    } catch (error) {\n      console.error('å¼‚å¸¸æ£€æµ‹å¤±è´¥:', error);\n      return { isAnomaly: false };\n    }\n  }\n\n  /**\n   * è·å–æœ€è¿‘çš„èƒ½æºæ•°æ®\n   */\n  getRecentEnergyData(deviceId, dataType, limit = 10) {\n    return new Promise((resolve, reject) => {\n      const sql = `\n        SELECT value, timestamp \n        FROM energy_data \n        WHERE device_id = ? AND data_type = ?\n        ORDER BY timestamp DESC \n        LIMIT ?\n      `;\n\n      (async () => {\n        try {\n          const db = await dbPromise;\n          const result = await db.raw(sql, [deviceId, this.getEnergyDataType(dataType), limit]);\n          resolve(result.rows || []);\n        } catch (err) {\n          reject(err);\n        }\n      })();\n    });\n  }\n\n  /**\n   * æ£€æŸ¥å‘Šè­¦è§„åˆ™\n   */\n  async checkAlertRules(deviceId, sensorId, data) {\n    try {\n      // è·å–ç›¸å…³çš„å‘Šè­¦è§„åˆ™\n      const rules = await this.getActiveAlertRules(deviceId, sensorId);\n\n      for (const rule of rules) {\n        const shouldAlert = this.evaluateAlertCondition(rule, data.value);\n\n        if (shouldAlert) {\n          await this.createAlert(rule, deviceId, sensorId, data.value);\n        }\n      }\n    } catch (error) {\n      console.error('å‘Šè­¦è§„åˆ™æ£€æŸ¥å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * è·å–æ´»è·ƒçš„å‘Šè­¦è§„åˆ™\n   */\n  getActiveAlertRules(deviceId, sensorId) {\n    return new Promise((resolve, reject) => {\n      let sql = `\n        SELECT * FROM alert_rules \n        WHERE is_active = 1 AND (\n          device_id = ? OR device_id IS NULL\n        )\n      `;\n      const params = [deviceId];\n\n      if (sensorId) {\n        sql += ' AND (sensor_id = ? OR sensor_id IS NULL)';\n        params.push(sensorId);\n      }\n\n      (async () => {\n        try {\n          const db = await dbPromise;\n          const result = await db.raw(sql, params);\n          resolve(result.rows || []);\n        } catch (err) {\n          reject(err);\n        }\n      })();\n    });\n  }\n\n  /**\n   * è¯„ä¼°å‘Šè­¦æ¡ä»¶\n   */\n  evaluateAlertCondition(rule, currentValue) {\n    const { condition_operator, threshold_value } = rule;\n\n    switch (condition_operator) {\n      case '>':\n        return currentValue > threshold_value;\n      case '<':\n        return currentValue < threshold_value;\n      case '>=':\n        return currentValue >= threshold_value;\n      case '<=':\n        return currentValue <= threshold_value;\n      case '=':\n        return Math.abs(currentValue - threshold_value) < 0.001;\n      case '!=':\n        return Math.abs(currentValue - threshold_value) >= 0.001;\n      default:\n        return false;\n    }\n  }\n\n  /**\n   * åˆ›å»ºå‘Šè­¦\n   */\n  async createAlert(rule, deviceId, sensorId, currentValue) {\n    try {\n      const alertId = uuidv4();\n      const message = `${rule.name}: å½“å‰å€¼ ${currentValue} ${rule.condition_operator} é˜ˆå€¼ ${rule.threshold_value}`;\n\n      const sql = `\n        INSERT INTO alerts (\n          id, rule_id, device_id, sensor_id, alert_level, message,\n          current_value, threshold_value, created_at\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\n      `;\n\n      await new Promise((resolve, reject) => {\n        (async () => {\n          try {\n            const db = await dbPromise;\n            await db.raw(\n              sql,\n              [\n                alertId,\n                rule.id,\n                deviceId,\n                sensorId,\n                rule.severity,\n                message,\n                currentValue,\n                rule.threshold_value\n              ]\n            );\n            resolve();\n          } catch (err) {\n            reject(err);\n          }\n        })();\n      });\n\n      console.log(`ğŸš¨ å‘Šè­¦å·²åˆ›å»º: ${message}`);\n    } catch (error) {\n      console.error('åˆ›å»ºå‘Šè­¦å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®\n   */\n  async handleSensorData(deviceId, payload) {\n    try {\n      // éªŒè¯ä¼ æ„Ÿå™¨æ˜¯å¦å­˜åœ¨\n      const sensor = await this.getSensor(payload.sensor_id);\n      if (!sensor) {\n        console.warn(`âš ï¸ ä¼ æ„Ÿå™¨ä¸å­˜åœ¨: ${payload.sensor_id}`);\n        return;\n      }\n\n      // æ£€æŸ¥æ•°æ®æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…\n      if (!this.isValueInRange(payload.value, sensor.range)) {\n        console.warn(`âš ï¸ ä¼ æ„Ÿå™¨æ•°æ®è¶…å‡ºèŒƒå›´: ${payload.value}`);\n      }\n\n      // å­˜å‚¨ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆå¯ä»¥æ‰©å±•ä¸ºç‹¬ç«‹çš„ä¼ æ„Ÿå™¨æ•°æ®è¡¨ï¼‰\n      console.log(`ğŸ“Š ä¼ æ„Ÿå™¨æ•°æ® - ${payload.sensor_id}: ${payload.value}${payload.unit}`);\n    } catch (error) {\n      console.error('ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * å¤„ç†è®¾å¤‡çŠ¶æ€æ•°æ®\n   */\n  async handleDeviceStatus(deviceId, payload) {\n    try {\n      // æ›´æ–°è®¾å¤‡çŠ¶æ€\n      await this.updateDeviceStatus(deviceId, payload.status);\n\n      console.log(`ğŸ”§ è®¾å¤‡çŠ¶æ€æ›´æ–° - ${deviceId}: ${payload.status}`);\n    } catch (error) {\n      console.error('è®¾å¤‡çŠ¶æ€å¤„ç†å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * è·å–è®¾å¤‡ä¿¡æ¯\n   */\n  getDevice(deviceId) {\n    return new Promise((resolve, reject) => {\n      (async () => {\n        try {\n          const db = await dbPromise;\n          const result = await db.raw('SELECT * FROM devices WHERE id = ?', [deviceId]);\n          resolve(result.rows ? result.rows[0] : undefined);\n        } catch (err) {\n          reject(err);\n        }\n      })();\n    });\n  }\n\n  /**\n   * è·å–ä¼ æ„Ÿå™¨ä¿¡æ¯\n   */\n  getSensor(sensorId) {\n    return new Promise((resolve, reject) => {\n      (async () => {\n        try {\n          const db = await dbPromise;\n          const result = await db.raw('SELECT * FROM sensors WHERE id = ?', [sensorId]);\n          resolve(result.rows ? result.rows[0] : undefined);\n        } catch (err) {\n          reject(err);\n        }\n      })();\n    });\n  }\n\n  /**\n   * ä¿å­˜èƒ½æºæ•°æ®\n   */\n  saveEnergyData(data) {\n    return new Promise((resolve, reject) => {\n      const sql = `\n        INSERT INTO energy_data \n        (id, device_id, sensor_id, data_type, value, unit, timestamp, created_at, is_anomaly, anomaly_reason, quality_score)\n        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `;\n\n      (async () => {\n        try {\n          const db = await dbPromise;\n          await db.raw(\n            sql,\n            [\n              data.id,\n              data.device_id,\n              data.sensor_id,\n              data.data_type,\n              data.value,\n              data.unit,\n              data.timestamp,\n              data.created_at,\n              data.is_anomaly ? 1 : 0,\n              data.anomaly_reason || null,\n              data.quality_score || 1.0\n            ]\n          );\n          resolve();\n        } catch (err) {\n          reject(err);\n        }\n      })();\n    });\n  }\n\n  /**\n   * è®¡ç®—å¹¶å­˜å‚¨ç¢³æ’æ”¾æ•°æ®\n   */\n  async calculateAndStoreCarbonEmission(energyDataId, energyType, energyValue) {\n    try {\n      // è·å–ç¢³æ’æ”¾å› å­\n      const carbonFactor = await this.getCarbonFactor(energyType);\n      if (!carbonFactor) {\n        console.warn(`âš ï¸ æœªæ‰¾åˆ°ç¢³æ’æ”¾å› å­: ${energyType}`);\n        return;\n      }\n\n      // è®¡ç®—ç¢³æ’æ”¾é‡\n      const emissionValue = energyValue * carbonFactor.factor_value;\n\n      // å­˜å‚¨ç¢³æ’æ”¾æ•°æ®\n      const carbonDataId = uuidv4();\n      await this.saveCarbonData({\n        id: carbonDataId,\n        energy_data_id: energyDataId,\n        carbon_factor_id: carbonFactor.id,\n        emission_value: emissionValue,\n        emission_unit: carbonFactor.unit,\n        calculation_method: 'direct_factor',\n        created_at: new Date().toISOString()\n      });\n\n      console.log(`ğŸŒ± ç¢³æ’æ”¾è®¡ç®—å®Œæˆ - ${emissionValue.toFixed(4)} ${carbonFactor.unit}`);\n    } catch (error) {\n      console.error('ç¢³æ’æ”¾è®¡ç®—å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * è·å–ç¢³æ’æ”¾å› å­\n   */\n  getCarbonFactor(energyType) {\n    return new Promise((resolve, reject) => {\n      const sql = `\n        SELECT * FROM carbon_factors \n        WHERE energy_type = ? AND is_active = 1 \n        AND (valid_to IS NULL OR valid_to > date('now'))\n        ORDER BY valid_from DESC LIMIT 1\n      `;\n\n      (async () => {\n        try {\n          const db = await dbPromise;\n          const result = await db.raw(sql, [energyType]);\n          resolve(result.rows ? result.rows[0] : undefined);\n        } catch (err) {\n          reject(err);\n        }\n      })();\n    });\n  }\n\n  /**\n   * ä¿å­˜ç¢³æ’æ”¾æ•°æ®\n   */\n  saveCarbonData(data) {\n    return new Promise((resolve, reject) => {\n      const sql = `\n        INSERT INTO carbon_data \n        (id, energy_data_id, carbon_factor_id, emission_value, emission_unit, calculation_method, created_at)\n        VALUES (?, ?, ?, ?, ?, ?, ?)\n      `;\n\n      (async () => {\n        try {\n          const db = await dbPromise;\n          await db.raw(\n            sql,\n            [\n              data.id,\n              data.energy_data_id,\n              data.carbon_factor_id,\n              data.emission_value,\n              data.emission_unit,\n              data.calculation_method,\n              data.created_at\n            ]\n          );\n          resolve();\n        } catch (err) {\n          reject(err);\n        }\n      })();\n    });\n  }\n\n  /**\n   * æ›´æ–°è®¾å¤‡çŠ¶æ€\n   */\n  updateDeviceStatus(deviceId, status) {\n    return new Promise((resolve, reject) => {\n      const sql = 'UPDATE devices SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?';\n\n      (async () => {\n        try {\n          const db = await dbPromise;\n          await db.raw(sql, [status, deviceId]);\n          resolve();\n        } catch (err) {\n          reject(err);\n        }\n      })();\n    });\n  }\n\n  /**\n   * è·å–èƒ½æºæ•°æ®ç±»å‹ç¼–ç \n   */\n  getEnergyDataType(type) {\n    const typeMap = {\n      electricity: 1,\n      natural_gas: 2,\n      diesel: 3,\n      solar: 4,\n      wind: 5\n    };\n    return typeMap[type] || 0;\n  }\n\n  /**\n   * æ£€æŸ¥æ•°å€¼æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…\n   */\n  isValueInRange(value, range) {\n    if (!range) {return true;}\n\n    try {\n      const [min, max] = range.split('-').map(Number);\n      return value >= min && value <= max;\n    } catch {\n      return true;\n    }\n  }\n\n  /**\n   * è·å–è¿æ¥çŠ¶æ€\n   */\n  getConnectionStatus() {\n    return {\n      connected: this.isConnected,\n      topics: Object.keys(this.topics).length,\n      bufferSize: this.dataBuffer.size\n    };\n  }\n\n  /**\n   * æ–­å¼€è¿æ¥\n   */\n  disconnect() {\n    if (this.mqttClient) {\n      this.mqttClient.end();\n      console.log('ğŸ”Œ MQTTæ•°æ®é‡‡é›†å™¨å·²æ–­å¼€è¿æ¥');\n    }\n  }\n\n  // å¯åŠ¨æ•°æ®é‡‡é›†å™¨\n  start() {\n    this.initialize();\n    console.log('æ•°æ®é‡‡é›†å™¨å·²å¯åŠ¨');\n  }\n\n  // åœæ­¢æ•°æ®é‡‡é›†å™¨\n  stop() {\n    if (this.mqttClient) {\n      this.mqttClient.end();\n      console.log('æ•°æ®é‡‡é›†å™¨å·²åœæ­¢');\n    }\n  }\n\n  // è·å–è¯¦ç»†è¿æ¥çŠ¶æ€\n  getDetailedConnectionStatus() {\n    return {\n      mqtt_connected: this.mqttClient && this.isConnected,\n      mqtt_broker: process.env.MQTT_BROKER_URL || 'mqtt://localhost:1883',\n      subscribed_topics: this.topics,\n      last_message_time: this.lastMessageTime,\n      connection_time: this.connectionTime\n    };\n  }\n}\n\nexport default DataCollector;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/database/redisClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/index.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":10,"column":1,"nodeType":"MemberExpression","messageId":"unexpected","endLine":10,"endColumn":12,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[160,200],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿèƒ½ç¢³ç®¡ç†ç³»ç»Ÿ - ä¸»å…¥å£æ–‡ä»¶\n * å¯åŠ¨HTTPæœåŠ¡å™¨å’Œç›¸å…³æœåŠ¡\n */\n\nimport './interfaces/http/index.js';\n\n// ä¸»å…¥å£æ–‡ä»¶åªéœ€è¦å¯¼å…¥HTTPæœåŠ¡å™¨æ¨¡å—\n// æ‰€æœ‰çš„æœåŠ¡å™¨é…ç½®å’Œå¯åŠ¨é€»è¾‘éƒ½åœ¨ interfaces/http/index.js ä¸­\nconsole.log('ğŸš€ é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿèƒ½ç¢³ç®¡ç†ç³»ç»Ÿæ­£åœ¨å¯åŠ¨...');\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/infrastructure/database/index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/DigitalTwinController.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'generateSecureRandom' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":4,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":4,"endColumn":31},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":36,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":36,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[693,721],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":51,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":51,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1028,1055],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":53,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":53,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1084,1121],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":87,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":87,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1851,1884],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":110,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":110,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2364,2398],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":192,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":192,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":192,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":192,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":193,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":193,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":193,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":193,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":204,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":204,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":204,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":204,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":206,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":206,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":206,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":206,"endColumn":37},{"ruleId":"no-unused-vars","severity":2,"message":"'message' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":256,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":256,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":261,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":261,"column":71,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":72},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":265,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":265,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":266,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":266,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xff0000.","line":285,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":285,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xffa500.","line":288,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":288,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0xffff00.","line":291,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":291,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3000.","line":301,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":14},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":321,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":321,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6972,7006],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":345,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":345,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7533,7567],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":369,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":369,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8094,8129],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":389,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":389,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":389,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":389,"endColumn":66},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":389,"column":84,"nodeType":"Literal","messageId":"noMagic","endLine":389,"endColumn":86},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":394,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":394,"endColumn":23}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":29,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import crypto from 'crypto';\n// å®‰å…¨éšæœºæ•°ç”Ÿæˆå‡½æ•°\nfunction generateSecureRandom() {\n  return crypto.randomBytes(16).toString('hex');\n}\n\n/**\n * æ•°å­—å­ªç”Ÿæ§åˆ¶å™¨\n * æ•´åˆåœºæ™¯ç®¡ç†å’Œæ•°æ®ç®¡ç†ï¼Œæä¾›ç»Ÿä¸€çš„æ•°å­—å­ªç”Ÿæ¥å£\n */\n\nimport SceneManager from './SceneManager.js';\nimport DataManager from './DataManager.js';\n\nclass DigitalTwinController {\n  constructor(container, options = {}) {\n    this.container = container;\n    this.options = {\n      apiBaseUrl: '/api',\n      updateInterval: 11250,\n      enableRealtime: true,\n      ...options\n    };\n\n    this.sceneManager = null;\n    this.dataManager = null;\n    this.isInitialized = false;\n    this.parkData = null;\n    this.alerts = [];\n\n    this.init();\n  }\n\n  async init() {\n    try {\n      console.log('åˆå§‹åŒ–æ•°å­—å­ªç”Ÿç³»ç»Ÿ...');\n\n      // åˆå§‹åŒ–åœºæ™¯ç®¡ç†å™¨\n      this.sceneManager = new SceneManager(this.container);\n\n      // åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨\n      this.dataManager = new DataManager(this.options.apiBaseUrl);\n\n      // è®¾ç½®äº‹ä»¶ç›‘å¬\n      this.setupEventListeners();\n\n      // åŠ è½½å›­åŒºæ•°æ®\n      await this.loadParkData();\n\n      this.isInitialized = true;\n      console.log('æ•°å­—å­ªç”Ÿç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');\n    } catch (error) {\n      console.error('æ•°å­—å­ªç”Ÿç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  // è®¾ç½®äº‹ä»¶ç›‘å¬\n  setupEventListeners() {\n    // ç›‘å¬è®¾å¤‡æ•°æ®åŠ è½½å®Œæˆ\n    this.dataManager.on('devicesLoaded', (devices) => {\n      this.createDevicesInScene(devices);\n    });\n\n    // ç›‘å¬å®æ—¶èƒ½æºæ•°æ®\n    this.dataManager.on('realtimeEnergyData', (data) => {\n      this.updateDeviceVisualization(data);\n    });\n\n    // ç›‘å¬è®¾å¤‡çŠ¶æ€å˜åŒ–\n    this.dataManager.on('deviceStatusChanged', (data) => {\n      this.updateDeviceStatus(data);\n    });\n\n    // ç›‘å¬å‘Šè­¦\n    this.dataManager.on('alert', (alert) => {\n      this.handleAlert(alert);\n    });\n\n    // ç›‘å¬ç¢³æ’æ”¾æ•°æ®\n    this.dataManager.on('realtimeCarbonData', (data) => {\n      this.updateCarbonVisualization(data);\n    });\n\n    // ç›‘å¬é”™è¯¯\n    this.dataManager.on('error', (error) => {\n      console.error('æ•°æ®ç®¡ç†å™¨é”™è¯¯:', error);\n    });\n  }\n\n  // åŠ è½½å›­åŒºæ•°æ®\n  async loadParkData() {\n    try {\n      const response = await fetch(`${this.options.apiBaseUrl}/parks`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n\n      if (!response.ok) {\n        throw new Error('è·å–å›­åŒºæ•°æ®å¤±è´¥');\n      }\n\n      const result = await response.json();\n      this.parkData = result.data || [];\n\n      // åˆ›å»ºå›­åŒºå»ºç­‘\n      this.createBuildingsInScene();\n    } catch (error) {\n      console.error('åŠ è½½å›­åŒºæ•°æ®å¤±è´¥:', error);\n      // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®\n      this.createMockParkData();\n    }\n  }\n\n  // åˆ›å»ºæ¨¡æ‹Ÿå›­åŒºæ•°æ®\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 34 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 34 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 34 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 34 è¡Œ)\n\n  createMockParkData() {\n    this.parkData = {\n      id: 'park_001',\n      name: 'é›¶ç¢³ç¤ºèŒƒå›­åŒº',\n      buildings: [\n        {\n          id: 'building_001',\n          name: 'åŠå…¬æ¥¼A',\n          type: 'office',\n          position: { x: 0, y: 0, z: 0 },\n          dimensions: { width: 30, height: 40, depth: 20 },\n          color: 0x66c2a5\n        },\n        {\n          id: 'building_002',\n          name: 'ç”Ÿäº§è½¦é—´B',\n          type: 'industrial',\n          position: { x: 50, y: 0, z: 0 },\n          dimensions: { width: 40, height: 25, depth: 30 },\n          color: 0x4a90e2\n        },\n        {\n          id: 'building_003',\n          name: 'ä»“å‚¨ä¸­å¿ƒC',\n          type: 'warehouse',\n          position: { x: -40, y: 0, z: 30 },\n          dimensions: { width: 35, height: 15, depth: 25 },\n          color: 0xfc8d62\n        }\n      ]\n    };\n\n    this.createBuildingsInScene();\n  }\n\n  // åœ¨åœºæ™¯ä¸­åˆ›å»ºå»ºç­‘\n  createBuildingsInScene() {\n    if (!this.parkData || !this.parkData.buildings) {\n      return;\n    }\n\n    this.parkData.buildings.forEach((building) => {\n      this.sceneManager.createBuilding(building);\n    });\n  }\n\n  // åœ¨åœºæ™¯ä¸­åˆ›å»ºè®¾å¤‡\n  createDevicesInScene(devices) {\n    devices.forEach((device) => {\n      // ä¸ºè®¾å¤‡åˆ†é…ä½ç½®ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®šï¼‰\n      if (!device.position) {\n        device.position = this.generateDevicePosition(device);\n      }\n\n      this.sceneManager.createDevice(device);\n    });\n  }\n\n  // ç”Ÿæˆè®¾å¤‡ä½ç½®\n  generateDevicePosition(device) {\n    // æ ¹æ®è®¾å¤‡ç±»å‹å’Œå»ºç­‘IDç”Ÿæˆåˆç†çš„ä½ç½®\n    const buildingId = device.building_id;\n    const building = this.parkData?.buildings?.find((b) => b.id === buildingId);\n\n    if (building) {\n      // åœ¨å»ºç­‘å‘¨å›´éšæœºåˆ†å¸ƒ\n      const offsetX = (Math.random() - 0.5) * 20;\n      const offsetZ = (Math.random() - 0.5) * 20;\n\n      return {\n        x: building.position.x + offsetX,\n        y: 2,\n        z: building.position.z + offsetZ\n      };\n    }\n\n    // é»˜è®¤éšæœºä½ç½®\n    return {\n      x: (Math.random() - 0.5) * 100,\n      y: 2,\n      z: (Math.random() - 0.5) * 100\n    };\n  }\n\n  // æ›´æ–°è®¾å¤‡å¯è§†åŒ–\n  updateDeviceVisualization(data) {\n    const { deviceId, value, unit } = data;\n\n    // æ›´æ–°è®¾å¤‡çš„æ•°æ®å¯è§†åŒ–\n    this.sceneManager.addDataVisualization(deviceId, value);\n\n    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶\n    this.dispatchEvent('deviceDataUpdated', {\n      deviceId,\n      value,\n      unit,\n      timestamp: new Date()\n    });\n  }\n\n  // æ›´æ–°è®¾å¤‡çŠ¶æ€\n  updateDeviceStatus(data) {\n    const { deviceId, status, device } = data;\n\n    this.sceneManager.updateDeviceStatus(deviceId, status, device);\n\n    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶\n    this.dispatchEvent('deviceStatusUpdated', {\n      deviceId,\n      status,\n      device\n    });\n  }\n\n  // æ›´æ–°ç¢³æ’æ”¾å¯è§†åŒ–\n  updateCarbonVisualization(data) {\n    const { deviceId, emissionValue } = data;\n\n    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç¢³æ’æ”¾çš„ç‰¹æ®Šå¯è§†åŒ–æ•ˆæœ\n    // æ¯”å¦‚ç²’å­æ•ˆæœã€é¢œè‰²å˜åŒ–ç­‰\n\n    this.dispatchEvent('carbonDataUpdated', {\n      deviceId,\n      emissionValue,\n      timestamp: new Date()\n    });\n  }\n\n  // å¤„ç†å‘Šè­¦\n  handleAlert(alert) {\n    const { deviceId, level, message } = alert;\n\n    // æ·»åŠ åˆ°å‘Šè­¦åˆ—è¡¨\n    this.alerts.unshift({\n      ...alert,\n      id: `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n    });\n\n    // ä¿æŒæœ€è¿‘100æ¡å‘Šè­¦\n    if (this.alerts.length > 100) {\n      this.alerts = this.alerts.slice(0, 100);\n    }\n\n    // åœ¨åœºæ™¯ä¸­æ˜¾ç¤ºå‘Šè­¦æ•ˆæœ\n    this.showAlertInScene(deviceId, level);\n\n    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶\n    this.dispatchEvent('alert', alert);\n  }\n\n  // åœ¨åœºæ™¯ä¸­æ˜¾ç¤ºå‘Šè­¦æ•ˆæœ\n  showAlertInScene(deviceId, level) {\n    // å¯ä»¥æ·»åŠ é—ªçƒæ•ˆæœã€é¢œè‰²å˜åŒ–ç­‰\n    const device = this.sceneManager.devices.get(deviceId);\n    if (device) {\n      // æ ¹æ®å‘Šè­¦çº§åˆ«è®¾ç½®é¢œè‰²\n      let color;\n      switch (level) {\n        case 'critical':\n          color = 0xff0000;\n          break;\n        case 'warning':\n          color = 0xffa500;\n          break;\n        default:\n          color = 0xffff00;\n      }\n\n      // ä¸´æ—¶æ”¹å˜è®¾å¤‡é¢œè‰²\n      const originalColor = device.material.color.getHex();\n      device.material.color.setHex(color);\n\n      // 3ç§’åæ¢å¤åŸè‰²\n      setTimeout(() => {\n        device.material.color.setHex(originalColor);\n      }, 3000);\n    }\n  }\n\n  // è·å–è®¾å¤‡è¯¦ç»†ä¿¡æ¯\n  async getDeviceDetails(deviceId) {\n    try {\n      const response = await fetch(`${this.options.apiBaseUrl}/devices/${deviceId}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n\n      if (!response.ok) {\n        throw new Error('è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥');\n      }\n\n      const result = await response.json();\n      return result.data;\n    } catch (error) {\n      console.error('è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥:', error);\n      return null;\n    }\n  }\n\n  // è·å–èƒ½æºæ•°æ®ç»Ÿè®¡\n  async getEnergyStatistics(timeRange = '24h') {\n    try {\n      const response = await fetch(\n        `${this.options.apiBaseUrl}/energy-data/statistics?time_range=${timeRange}`,\n        {\n          headers: {\n            Authorization: `Bearer ${localStorage.getItem('token')}`\n          }\n        }\n      );\n\n      if (!response.ok) {\n        throw new Error('è·å–èƒ½æºç»Ÿè®¡å¤±è´¥');\n      }\n\n      const result = await response.json();\n      return result.data;\n    } catch (error) {\n      console.error('è·å–èƒ½æºç»Ÿè®¡å¤±è´¥:', error);\n      return null;\n    }\n  }\n\n  // è·å–ç¢³æ’æ”¾ç»Ÿè®¡\n  async getCarbonStatistics(timeRange = '24h') {\n    try {\n      const response = await fetch(\n        `${this.options.apiBaseUrl}/carbon-data/statistics?time_range=${timeRange}`,\n        {\n          headers: {\n            Authorization: `Bearer ${localStorage.getItem('token')}`\n          }\n        }\n      );\n\n      if (!response.ok) {\n        throw new Error('è·å–ç¢³æ’æ”¾ç»Ÿè®¡å¤±è´¥');\n      }\n\n      const result = await response.json();\n      return result.data;\n    } catch (error) {\n      console.error('è·å–ç¢³æ’æ”¾ç»Ÿè®¡å¤±è´¥:', error);\n      return null;\n    }\n  }\n\n  // è®¾ç½®ç›¸æœºè§†è§’\n  setCameraView(position, target) {\n    if (this.sceneManager && this.sceneManager.camera) {\n      this.sceneManager.camera.position.set(position.x, position.y, position.z);\n      if (target) {\n        this.sceneManager.camera.lookAt(target.x, target.y, target.z);\n      }\n    }\n  }\n\n  // èšç„¦åˆ°è®¾å¤‡\n  focusOnDevice(deviceId) {\n    const device = this.sceneManager.devices.get(deviceId);\n    if (device) {\n      const { position } = device;\n      this.setCameraView({ x: position.x + 20, y: position.y + 20, z: position.z + 20 }, position);\n    }\n  }\n\n  // è·å–å‘Šè­¦åˆ—è¡¨\n  getAlerts(limit = 10) {\n    return this.alerts.slice(0, limit);\n  }\n\n  // æ¸…é™¤å‘Šè­¦\n  clearAlert(alertId) {\n    this.alerts = this.alerts.filter((alert) => alert.id !== alertId);\n  }\n\n  // è‡ªå®šä¹‰äº‹ä»¶åˆ†å‘\n  dispatchEvent(eventType, data) {\n    const event = new CustomEvent(eventType, { detail: data });\n    this.container.dispatchEvent(event);\n  }\n\n  // æ·»åŠ äº‹ä»¶ç›‘å¬\n  addEventListener(eventType, callback) {\n    this.container.addEventListener(eventType, callback);\n  }\n\n  // ç§»é™¤äº‹ä»¶ç›‘å¬\n  removeEventListener(eventType, callback) {\n    this.container.removeEventListener(eventType, callback);\n  }\n\n  // é”€æ¯æ•°å­—å­ªç”Ÿç³»ç»Ÿ\n  dispose() {\n    if (this.sceneManager) {\n      this.sceneManager.dispose();\n      this.sceneManager = null;\n    }\n\n    if (this.dataManager) {\n      this.dataManager.dispose();\n      this.dataManager = null;\n    }\n\n    this.alerts = [];\n    this.parkData = null;\n    this.isInitialized = false;\n  }\n}\n\nexport default DigitalTwinController;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/components/optimization/EnergyStorageOptimization.js","messages":[{"ruleId":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token <","line":207,"column":5,"nodeType":null}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport {\n  Box,\n  Typography,\n  Paper,\n  Grid,\n  Card,\n  CardContent,\n  Divider,\n  CircularProgress,\n  Alert,\n} from '@mui/material';\nimport { Line, Bar } from 'react-chartjs-2';\nimport { Chart, registerables } from 'chart.js';\nimport { getEnergyStorageDevices } from '../../controllers/deviceController.js';\nimport { generateOptimizationStrategies } from '../../optimization/battery.js';\n\n// æ³¨å†ŒChart.jsç»„ä»¶\nChart.register(...registerables);\n\nconst EnergyStorageOptimization = () => {\n  const [devices, setDevices] = useState([]);\n  const [selectedDevice, setSelectedDevice] = useState(null);\n  const [strategies, setStrategies] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n  const [timeRange, setTimeRange] = useState('24h');\n\n  // è·å–å‚¨èƒ½è®¾å¤‡åˆ—è¡¨\n  useEffect(() => {\n    const fetchDevices = async () => {\n      try {\n        const data = await getEnergyStorageDevices();\n        setDevices(data);\n        if (data.length > 0) {\n          setSelectedDevice(data[0]);\n        }\n      } catch (err) {\n        setError('è·å–å‚¨èƒ½è®¾å¤‡å¤±è´¥: ' + err.message);\n        console.error(err);\n      }\n    };\n\n    fetchDevices();\n  }, []);\n\n  // å½“é€‰æ‹©è®¾å¤‡æˆ–æ—¶é—´èŒƒå›´å˜åŒ–æ—¶ï¼Œé‡æ–°ç”Ÿæˆä¼˜åŒ–ç­–ç•¥\n  useEffect(() => {\n    if (selectedDevice) {\n      generateStrategies();\n    }\n  }, [selectedDevice, timeRange]);\n\n  // ç”Ÿæˆä¼˜åŒ–ç­–ç•¥\n  const generateStrategies = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n\n      // è®¡ç®—æ—¶é—´èŒƒå›´\n      const endTime = new Date();\n      const startTime = new Date();\n\n      switch (timeRange) {\n        case '24h':\n          startTime.setHours(endTime.getHours() - 24);\n          break;\n        case '7d':\n          startTime.setDate(endTime.getDate() - 7);\n          break;\n        case '30d':\n          startTime.setMonth(endTime.getMonth() - 1);\n          break;\n        default:\n          startTime.setHours(endTime.getHours() - 24);\n      }\n\n      // è·å–é¢„æµ‹æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»APIè·å–ï¼‰\n      // è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®\n      const predictions = generateMockSOCData(timeRange);\n\n      // ç”Ÿæˆä¼˜åŒ–ç­–ç•¥\n      const result = await generateOptimizationStrategies(\n        predictions,\n        '1h',\n        selectedDevice.id,\n        startTime.toISOString(),\n        endTime.toISOString()\n      );\n\n      setStrategies(result);\n    } catch (err) {\n      setError('ç”Ÿæˆä¼˜åŒ–ç­–ç•¥å¤±è´¥: ' + err.message);\n      console.error(err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // ç”Ÿæˆæ¨¡æ‹ŸSOCæ•°æ®\n  const generateMockSOCData = (range) => {\n    const dataPoints = range === '24h' ? 24 : range === '7d' ? 168 : 720;\n    const data = [];\n\n    for (let i = 0; i < dataPoints; i++) {\n      // ç”Ÿæˆ0.3-0.7ä¹‹é—´çš„éšæœºSOCå€¼ï¼Œæ·»åŠ ä¸€äº›æ³¢åŠ¨è¶‹åŠ¿\n      const baseValue = 0.5 + Math.sin((i / 12) * Math.PI) * 0.2;\n      const noise = (Math.random() - 0.5) * 0.1;\n      const value = Math.max(0.2, Math.min(0.8, baseValue + noise));\n      data.push(value);\n    }\n\n    return data;\n  };\n\n  // å‡†å¤‡å›¾è¡¨æ•°æ®\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\n  const prepareChartData = () => {\n    if (!strategies || strategies.length === 0) return null;\n\n    const timestamps = strategies.map((s) => new Date(s.timestamp).toLocaleTimeString());\n    const socData = strategies.map((_, index) => generateMockSOCData(timeRange)[index] * 100);\n    const prices = strategies.map((s) =>\n      s.economicImpact ? parseFloat(s.economicImpact.split(':')[1]) : 0\n    );\n\n    return {\n      labels: timestamps,\n      datasets: [\n        {\n          label: 'SOC (%)',\n          data: socData,\n          borderColor: '#3f51b5',\n          backgroundColor: 'rgba(63, 81, 181, 0.1)',\n          borderWidth: 2,\n          fill: true,\n          yAxisID: 'y',\n        },\n        {\n          label: 'ç»æµæ•ˆç›Š (å…ƒ)',\n          data: prices,\n          borderColor: '#4caf50',\n          backgroundColor: 'rgba(76, 175, 80, 0.1)',\n          borderWidth: 2,\n          fill: true,\n          yAxisID: 'y1',\n        },\n      ],\n    };\n  };\n\n  // å›¾è¡¨é…ç½®\n  const chartOptions = {\n    responsive: true,\n    interaction: {\n      mode: 'index',\n      intersect: false,\n    },\n    scales: {\n      y: {\n        type: 'linear',\n        display: true,\n        position: 'left',\n        title: {\n          display: true,\n          text: 'SOC (%)',\n        },\n        min: 0,\n        max: 100,\n      },\n      y1: {\n        type: 'linear',\n        display: true,\n        position: 'right',\n        title: {\n          display: true,\n          text: 'ç»æµæ•ˆç›Š (å…ƒ)',\n        },\n        grid: {\n          drawOnChartArea: false,\n        },\n      },\n    },\n  };\n\n  // ç­–ç•¥ä¼˜å…ˆçº§é¢œè‰²æ˜ å°„\n  const getPriorityColor = (priority) => {\n    if (priority >= 8) return '#f44336'; // é«˜ä¼˜å…ˆçº§ - çº¢è‰²\n    if (priority >= 5) return '#ff9800'; // ä¸­é«˜ä¼˜å…ˆçº§ - æ©™è‰²\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (priority >= 3) return '#ffeb3b'; // ä¸­ä¼˜å…ˆçº§ - é»„è‰²\n    return '#4caf50'; // ä½ä¼˜å…ˆçº§ - ç»¿è‰²\n  };\n\n  return (\n    <Box sx={{ p: 3 }}>\n      <Typography variant=\"h4\" gutterBottom>\n        å‚¨èƒ½ä¼˜åŒ–ç­–ç•¥\n      </Typography>\n\n      <Grid container spacing={3} sx={{ mb: 4 }}>\n        <Grid item xs={12} md={4}>\n          <Paper sx={{ p: 2 }}>\n            <Typography variant=\"h6\" gutterBottom>\n              å‚¨èƒ½è®¾å¤‡é€‰æ‹©\n            </Typography>\n            <select\n              value={selectedDevice?.id || ''}\n              onChange={(e) => {\n                const device = devices.find((d) => d.id === e.target.value);\n                setSelectedDevice(device);\n              }}\n              style={{\n                width: '100%',\n                padding: '8px',\n                borderRadius: '4px',\n                border: '1px solid #ccc',\n              }}\n            >\n              {devices.map((device) => (\n                <option key={device.id} value={device.id}>\n                  {device.name} ({device.model})\n                </option>\n              ))}\n            </select>\n          </Paper>\n        </Grid>\n\n        <Grid item xs={12} md={4}>\n          <Paper sx={{ p: 2 }}>\n            <Typography variant=\"h6\" gutterBottom>\n              æ—¶é—´èŒƒå›´\n            </Typography>\n            <select\n              value={timeRange}\n              onChange={(e) => setTimeRange(e.target.value)}\n              style={{\n                width: '100%',\n                padding: '8px',\n                borderRadius: '4px',\n                border: '1px solid #ccc',\n              }}\n            >\n              <option value=\"24h\">24å°æ—¶</option>\n              <option value=\"7d\">7å¤©</option>\n              <option value=\"30d\">30å¤©</option>\n            </select>\n          </Paper>\n        </Grid>\n\n        <Grid item xs={12} md={4}>\n          <Paper\n            sx={{\n              p: 2,\n              display: 'flex',\n              alignItems: 'center',\n              justifyContent: 'center',\n              height: '100%',\n            }}\n          >\n            {loading ? (\n              <CircularProgress />\n            ) : (\n              <button\n                onClick={generateStrategies}\n                style={{\n                  padding: '8px 16px',\n                  backgroundColor: '#3f51b5',\n                  color: 'white',\n                  border: 'none',\n                  borderRadius: '4px',\n                  cursor: 'pointer',\n                  fontSize: '16px',\n                }}\n              >\n                ç”Ÿæˆä¼˜åŒ–ç­–ç•¥\n              </button>\n            )}\n          </Paper>\n        </Grid>\n      </Grid>\n\n      {error && (\n        <Alert severity=\"error\" sx={{ mb: 3 }}>\n          {error}\n        </Alert>\n      )}\n\n      {strategies.length > 0 && (\n        <Grid container spacing={3}>\n          <Grid item xs={12}>\n            <Paper sx={{ p: 2 }}>\n              <Typography variant=\"h6\" gutterBottom>\n                å‚¨èƒ½ä¼˜åŒ–è¶‹åŠ¿\n              </Typography>\n              <Box sx={{ height: 400 }}>\n                <Line data={prepareChartData()} options={chartOptions} />\n              </Box>\n            </Paper>\n          </Grid>\n\n          <Grid item xs={12}>\n            <Paper sx={{ p: 2 }}>\n              <Typography variant=\"h6\" gutterBottom>\n                æ¨èç­–ç•¥åˆ—è¡¨\n              </Typography>\n              <Divider sx={{ mb: 2 }} />\n              <Box sx={{ maxHeight: 400, overflowY: 'auto' }}>\n                {strategies\n                  .filter((s) => s.strategy !== 'maintenance')\n                  .sort((a, b) => b.priority - a.priority)\n                  .map((strategy, index) => (\n                    <Card\n                      key={index}\n                      sx={{ mb: 2, borderLeft: `4px solid ${getPriorityColor(strategy.priority)}` }}\n                    >\n                      <CardContent>\n                        <Grid container spacing={2} alignItems=\"center\">\n                          <Grid item xs={12} md={2}>\n                            <Typography variant=\"subtitle2\">\n                              {new Date(strategy.timestamp).toLocaleString()}\n                            </Typography>\n                          </Grid>\n                          <Grid item xs={12} md={2}>\n                            <Typography\n                              variant=\"body1\"\n                              sx={{\n                                fontWeight: 'bold',\n                                color: getPriorityColor(strategy.priority),\n                              }}\n                            >\n                              {strategy.strategy === 'charge' && 'å……ç”µ'}\n                              {strategy.strategy === 'discharge' && 'æ”¾ç”µ'}\n                              {strategy.strategy === 'stop_charge' && 'åœæ­¢å……ç”µ'}\n                              {strategy.strategy === 'stop_discharge' && 'åœæ­¢æ”¾ç”µ'}\n                            </Typography>\n                          </Grid>\n                          <Grid item xs={12} md={4}>\n                            <Typography variant=\"body2\">{strategy.description}</Typography>\n                          </Grid>\n                          <Grid item xs={12} md={2}>\n                            <Typography variant=\"body2\">{strategy.economicImpact}</Typography>\n                          </Grid>\n                          <Grid item xs={12} md={2}>\n                            <Typography variant=\"body2\">\n                              {strategy.carbonImpact || 'æ— ç¢³æ’æ”¾æ•°æ®'}\n                            </Typography>\n                          </Grid>\n                        </Grid>\n                      </CardContent>\n                    </Card>\n                  ))}\n              </Box>\n            </Paper>\n          </Grid>\n        </Grid>\n      )}\n    </Box>\n  );\n};\n\nexport default EnergyStorageOptimization;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/controllers/AuthController.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":136,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":136,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import bcrypt from 'bcrypt';\nimport { validationResult } from 'express-validator';\nimport BaseController from './BaseController.js';\nimport User from '../../../core/entities/User.js';\nimport config from '../../../shared/config/index.js';\nimport logger from '../../../shared/utils/logger.js';\nimport { defaultJWTManager } from '../../../core/services/jwtManager.js';\n\n/**\n * è®¤è¯æ§åˆ¶å™¨\n * å¤„ç†ç”¨æˆ·è®¤è¯ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘\n */\nclass AuthController extends BaseController {\n  constructor() {\n    super();\n    this.saltRounds = 12;\n    this.jwtManager = defaultJWTManager;\n  }\n\n  /**\n   * ç”¨æˆ·ç™»å½•\n   */\n  login = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    const { username, password } = req.body;\n\n    try {\n      // æŸ¥æ‰¾ç”¨æˆ·\n      const user = await User.findByUsername(username);\n      if (!user) {\n        this.logOperation(req, 'LOGIN_FAILED', { username, reason: 'USER_NOT_FOUND' });\n        return res.unauthorized('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');\n      }\n\n      // éªŒè¯å¯†ç \n      const isValidPassword = await bcrypt.compare(password, user.password);\n      if (!isValidPassword) {\n        this.logOperation(req, 'LOGIN_FAILED', { username, reason: 'INVALID_PASSWORD' });\n        return res.unauthorized('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');\n      }\n\n      // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€\n      if (user.status !== 'active') {\n        this.logOperation(req, 'LOGIN_FAILED', { username, reason: 'USER_INACTIVE' });\n        return res.forbidden('ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨');\n      }\n\n      // ç”ŸæˆJWTä»¤ç‰Œ\n      const tokenPayload = {\n        id: user.id,\n        username: user.username,\n        role: user.role,\n        permissions: user.permissions || []\n      };\n\n      const accessToken = this.jwtManager.generateToken(tokenPayload);\n      const refreshToken = this.jwtManager.generateRefreshToken(tokenPayload);\n\n      // æ›´æ–°æœ€åç™»å½•æ—¶é—´\n      await User.updateLastLogin(user.id);\n\n      // æ¸…ç†æ•æ„Ÿæ•°æ®\n      const userResponse = this.sanitizeUser(user);\n\n      this.logOperation(req, 'LOGIN_SUCCESS', { userId: user.id, username });\n\n      res.success(\n        {\n          user: userResponse,\n          tokens: {\n            accessToken,\n            refreshToken,\n            expiresIn: config.jwt.expiresIn\n          }\n        },\n        'ç™»å½•æˆåŠŸ'\n      );\n    } catch (error) {\n      logger.error('ç™»å½•å¤±è´¥', {\n        error: error.message,\n        username,\n        ip: req.ip\n      });\n      res.internalError('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');\n    }\n  });\n\n  /**\n   * ç”¨æˆ·æ³¨å†Œ\n   */\n  register = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    const { username, password, email, role = 'viewer' } = req.body;\n\n    try {\n      // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨\n      const existingUser = await User.findByUsername(username);\n      if (existingUser) {\n        return res.conflict('ç”¨æˆ·åå·²å­˜åœ¨');\n      }\n\n      // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨\n      if (email) {\n        const existingEmail = await User.findByEmail(email);\n        if (existingEmail) {\n          return res.conflict('é‚®ç®±å·²è¢«ä½¿ç”¨');\n        }\n      }\n\n      // åŠ å¯†å¯†ç \n      const hashedPassword = await bcrypt.hash(password, this.saltRounds);\n\n      // åˆ›å»ºç”¨æˆ·\n      const userData = {\n        username,\n        password: hashedPassword,\n        email,\n        role,\n        status: 'active',\n        createdAt: new Date().toISOString()\n      };\n\n      const newUser = await User.create(userData);\n      const userResponse = this.sanitizeUser(newUser);\n\n      this.logOperation(req, 'USER_REGISTER', { userId: newUser.id, username });\n\n      res.success(userResponse, 'æ³¨å†ŒæˆåŠŸ', 201);\n    } catch (error) {\n      logger.error('æ³¨å†Œå¤±è´¥', {\n        error: error.message,\n        username,\n        email,\n        ip: req.ip\n      });\n      res.internalError('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');\n    }\n  });\n\n  /**\n   * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯\n   */\n  getCurrentUser = this.asyncHandler(async (req, res) => {\n    try {\n      const user = await User.findById(req.user.id);\n      if (!user) {\n        return res.notFound('ç”¨æˆ·ä¸å­˜åœ¨');\n      }\n\n      const userResponse = this.sanitizeUser(user);\n      res.success(userResponse);\n    } catch (error) {\n      logger.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');\n    }\n  });\n\n  /**\n   * æ›´æ–°ç”¨æˆ·ä¿¡æ¯\n   */\n  updateProfile = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    const { email, currentPassword, newPassword } = req.body;\n    const userId = req.user.id;\n\n    try {\n      const user = await User.findById(userId);\n      if (!user) {\n        return res.notFound('ç”¨æˆ·ä¸å­˜åœ¨');\n      }\n\n      const updateData = {};\n\n      // æ›´æ–°é‚®ç®±\n      if (email && email !== user.email) {\n        const existingEmail = await User.findByEmail(email);\n        if (existingEmail && existingEmail.id !== userId) {\n          return res.conflict('é‚®ç®±å·²è¢«ä½¿ç”¨');\n        }\n        updateData.email = email;\n      }\n\n      // æ›´æ–°å¯†ç \n      if (newPassword) {\n        if (!currentPassword) {\n          return res.badRequest('æ›´æ–°å¯†ç éœ€è¦æä¾›å½“å‰å¯†ç ');\n        }\n\n        const isValidPassword = await bcrypt.compare(currentPassword, user.password);\n        if (!isValidPassword) {\n          return res.unauthorized('å½“å‰å¯†ç é”™è¯¯');\n        }\n\n        updateData.password = await bcrypt.hash(newPassword, this.saltRounds);\n      }\n\n      if (Object.keys(updateData).length === 0) {\n        return res.badRequest('æ²¡æœ‰éœ€è¦æ›´æ–°çš„æ•°æ®');\n      }\n\n      updateData.updatedAt = new Date().toISOString();\n      const updatedUser = await User.update(userId, updateData);\n      const userResponse = this.sanitizeUser(updatedUser);\n\n      this.logOperation(req, 'PROFILE_UPDATE', { userId, fields: Object.keys(updateData) });\n\n      res.success(userResponse, 'ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ');\n    } catch (error) {\n      logger.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥', {\n        error: error.message,\n        userId\n      });\n      res.internalError('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥');\n    }\n  });\n\n  /**\n   * ç”¨æˆ·ç™»å‡º\n   */\n  logout = this.asyncHandler(async (req, res) => {\n    try {\n      const token = req.headers.authorization?.replace('Bearer ', '');\n      if (token) {\n        // å°†ä»¤ç‰ŒåŠ å…¥é»‘åå•\n        await this.jwtManager.blacklistToken(token);\n      }\n\n      this.logOperation(req, 'LOGOUT', { userId: req.user?.id });\n\n      res.success(null, 'ç™»å‡ºæˆåŠŸ');\n    } catch (error) {\n      logger.error('ç™»å‡ºå¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('ç™»å‡ºå¤±è´¥');\n    }\n  });\n\n  /**\n   * åˆ·æ–°è®¿é—®ä»¤ç‰Œ\n   */\n  refreshToken = this.asyncHandler(async (req, res) => {\n    const { refreshToken } = req.body;\n\n    if (!refreshToken) {\n      return res.badRequest('ç¼ºå°‘åˆ·æ–°ä»¤ç‰Œ');\n    }\n\n    try {\n      // éªŒè¯åˆ·æ–°ä»¤ç‰Œ\n      const decoded = this.jwtManager.verifyRefreshToken(refreshToken);\n\n      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä»ç„¶å­˜åœ¨ä¸”æ´»è·ƒ\n      const user = await User.findById(decoded.id);\n      if (!user || user.status !== 'active') {\n        return res.unauthorized('ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨');\n      }\n\n      // ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ\n      const tokenPayload = {\n        id: user.id,\n        username: user.username,\n        role: user.role,\n        permissions: user.permissions || []\n      };\n\n      const newAccessToken = this.jwtManager.generateToken(tokenPayload);\n      const newRefreshToken = this.jwtManager.generateRefreshToken(tokenPayload);\n\n      // å°†æ—§çš„åˆ·æ–°ä»¤ç‰ŒåŠ å…¥é»‘åå•\n      await this.jwtManager.blacklistToken(refreshToken);\n\n      res.success(\n        {\n          accessToken: newAccessToken,\n          refreshToken: newRefreshToken,\n          expiresIn: config.jwt.expiresIn\n        },\n        'ä»¤ç‰Œåˆ·æ–°æˆåŠŸ'\n      );\n    } catch (error) {\n      logger.error('åˆ·æ–°ä»¤ç‰Œå¤±è´¥', {\n        error: error.message,\n        ip: req.ip\n      });\n\n      if (error.name === 'JsonWebTokenError' || error.name === 'TokenExpiredError') {\n        return res.unauthorized('æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ');\n      }\n\n      res.internalError('ä»¤ç‰Œåˆ·æ–°å¤±è´¥');\n    }\n  });\n\n  /**\n   * æ¸…ç†ç”¨æˆ·æ•æ„Ÿæ•°æ®\n   */\n  sanitizeUser(user) {\n    const { password: _password, ...sanitizedUser } = user;\n    return sanitizedUser;\n  }\n\n  /**\n   * éªŒè¯ç”¨æˆ·æƒé™\n   */\n  checkPermission = this.asyncHandler(async (req, res) => {\n    const { permission } = req.params;\n    const userPermissions = req.user.permissions || [];\n    const hasPermission = userPermissions.includes(permission) || req.user.role === 'admin';\n\n    res.success({ hasPermission }, 'æƒé™æ£€æŸ¥å®Œæˆ');\n  });\n}\n\nexport default new AuthController();\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/controllers/BaseController.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":42,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":42,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1077,1369],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":104,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":104,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":109,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":109,"endColumn":26},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":359,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":359,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[10029,10312],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":404,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":404,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":415,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":415,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * åŸºç¡€æ§åˆ¶å™¨ç±»\n * æä¾›é€šç”¨çš„æ§åˆ¶å™¨åŠŸèƒ½å’Œé”™è¯¯å¤„ç†\n */\n\nimport responseFormatter from '../middleware/responseFormatter.js';\n\nclass BaseController {\n  constructor() {\n    // ç»‘å®šæ–¹æ³•åˆ°å®ä¾‹ï¼Œç¡®ä¿æ­£ç¡®çš„thisä¸Šä¸‹æ–‡\n    this.handleRequest = this.handleRequest.bind(this);\n    this.handleError = this.handleError.bind(this);\n    this.validateRequest = this.validateRequest.bind(this);\n    this.getPaginationParams = this.getPaginationParams.bind(this);\n    this.getSortingParams = this.getSortingParams.bind(this);\n    this.getFilterParams = this.getFilterParams.bind(this);\n  }\n\n  /**\n   * é€šç”¨è¯·æ±‚å¤„ç†åŒ…è£…å™¨\n   * @param {Function} handler - å¤„ç†å‡½æ•°\n   * @returns {Function} Expressè·¯ç”±å¤„ç†å‡½æ•°\n   */\n  handleRequest(handler) {\n    return async (req, res, next) => {\n      try {\n        await handler(req, res, next);\n      } catch (error) {\n        this.handleError(error, req, res, next);\n      }\n    };\n  }\n\n  /**\n   * ç»Ÿä¸€é”™è¯¯å¤„ç†\n   * @param {Error} error - é”™è¯¯å¯¹è±¡\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {Function} next - Express nextå‡½æ•°\n   */\n  handleError(error, req, res, _next) {\n    console.error(`[${new Date().toISOString()}] Controller Error:`, {\n      error: error.message,\n      stack: error.stack,\n      url: req.url,\n      method: req.method,\n      user: req.user?.username || 'anonymous',\n      body: req.body,\n      params: req.params,\n      query: req.query\n    });\n\n    // æ ¹æ®é”™è¯¯ç±»å‹è¿”å›ç›¸åº”çš„å“åº”\n    if (error.name === 'ValidationError') {\n      return responseFormatter.validationError(res, 'æ•°æ®éªŒè¯å¤±è´¥', error.details);\n    } else if (error.name === 'UnauthorizedError') {\n      return responseFormatter.unauthorized(res, error.message);\n    } else if (error.name === 'ForbiddenError') {\n      return responseFormatter.forbidden(res, error.message);\n    } else if (error.name === 'NotFoundError') {\n      return responseFormatter.notFound(res, error.message);\n    } else if (error.name === 'ConflictError') {\n      return responseFormatter.conflict(res, error.message);\n    } else if (error.name === 'TooManyRequestsError') {\n      return responseFormatter.tooManyRequests(res, error.message);\n    } \n    return responseFormatter.internalError(res, 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯', error);\n    \n  }\n\n  /**\n   * éªŒè¯è¯·æ±‚æ•°æ®\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @param {Object} schema - éªŒè¯æ¨¡å¼\n   * @throws {ValidationError} éªŒè¯å¤±è´¥æ—¶æŠ›å‡ºé”™è¯¯\n   */\n  validateRequest(req, schema) {\n    const { error, value } = schema.validate(req.body, {\n      abortEarly: false,\n      stripUnknown: true\n    });\n\n    if (error) {\n      const validationError = new Error('æ•°æ®éªŒè¯å¤±è´¥');\n      validationError.name = 'ValidationError';\n      validationError.details = error.details.map((detail) => ({\n        field: detail.path.join('.'),\n        message: detail.message,\n        value: detail.context?.value\n      }));\n      throw validationError;\n    }\n\n    return value;\n  }\n\n  /**\n   * è·å–åˆ†é¡µå‚æ•°\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @returns {Object} åˆ†é¡µå‚æ•°\n   */\n  getPaginationParams(req) {\n    const page = parseInt(req.query.page) || 1;\n    const limit = parseInt(req.query.limit) || 20;\n    const offset = parseInt(req.query.offset) || (page - 1) * limit;\n\n    return {\n      page: Math.max(1, page),\n      limit: Math.min(100, Math.max(1, limit)),\n      offset: Math.max(0, offset)\n    };\n  }\n\n  /**\n   * è·å–æ’åºå‚æ•°\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @param {Array} allowedFields - å…è®¸æ’åºçš„å­—æ®µ\n   * @returns {Object} æ’åºå‚æ•°\n   */\n  getSortingParams(req, allowedFields = []) {\n    const sortBy = req.query.sortBy || 'createdAt';\n    const sortOrder = (req.query.sortOrder || 'desc').toLowerCase();\n\n    // éªŒè¯æ’åºå­—æ®µ\n    const validSortBy =\n      allowedFields.length > 0 && !allowedFields.includes(sortBy) ? allowedFields[0] : sortBy;\n\n    // éªŒè¯æ’åºæ–¹å‘\n    const validSortOrder = ['asc', 'desc'].includes(sortOrder) ? sortOrder : 'desc';\n\n    return {\n      sortBy: validSortBy,\n      sortOrder: validSortOrder,\n      orderBy: `${validSortBy} ${validSortOrder.toUpperCase()}`\n    };\n  }\n\n  /**\n   * è·å–è¿‡æ»¤å‚æ•°\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @param {Array} allowedFilters - å…è®¸çš„è¿‡æ»¤å­—æ®µ\n   * @returns {Object} è¿‡æ»¤å‚æ•°\n   */\n  getFilterParams(req, allowedFilters = []) {\n    const filters = {};\n\n    // å¤„ç†æŸ¥è¯¢å‚æ•°ä¸­çš„è¿‡æ»¤æ¡ä»¶\n    for (const [key, value] of Object.entries(req.query)) {\n      if (allowedFilters.includes(key) && value !== undefined && value !== '') {\n        // å¤„ç†ä¸åŒç±»å‹çš„è¿‡æ»¤æ¡ä»¶\n        if (key.endsWith('_min') || key.endsWith('_max')) {\n          // æ•°å€¼èŒƒå›´è¿‡æ»¤\n          const fieldName = key.replace(/_min$|_max$/, '');\n          if (!filters[fieldName]) {filters[fieldName] = {};}\n\n          if (key.endsWith('_min')) {\n            filters[fieldName].min = parseFloat(value);\n          } else {\n            filters[fieldName].max = parseFloat(value);\n          }\n        } else if (key.endsWith('_like')) {\n          // æ¨¡ç³ŠåŒ¹é…\n          const fieldName = key.replace(/_like$/, '');\n          filters[fieldName] = { like: `%${value}%` };\n        } else if (key.endsWith('_in')) {\n          // æ•°ç»„åŒ…å«\n          const fieldName = key.replace(/_in$/, '');\n          filters[fieldName] = { in: Array.isArray(value) ? value : value.split(',') };\n        } else {\n          // ç²¾ç¡®åŒ¹é…\n          filters[key] = value;\n        }\n      }\n    }\n\n    return filters;\n  }\n\n  /**\n   * è·å–æœç´¢å‚æ•°\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @returns {Object} æœç´¢å‚æ•°\n   */\n  getSearchParams(req) {\n    const keyword = req.query.keyword || req.query.q || '';\n    const searchFields = req.query.searchFields\n      ? req.query.searchFields.split(',').map((field) => field.trim())\n      : [];\n\n    return {\n      keyword: keyword.trim(),\n      searchFields,\n      hasSearch: keyword.trim().length > 0\n    };\n  }\n\n  /**\n   * è·å–æ—¥æœŸèŒƒå›´å‚æ•°\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @returns {Object} æ—¥æœŸèŒƒå›´å‚æ•°\n   */\n  getDateRangeParams(req) {\n    const startDate = req.query.startDate ? new Date(req.query.startDate) : null;\n    const endDate = req.query.endDate ? new Date(req.query.endDate) : null;\n\n    // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§\n    const validStartDate = startDate && !isNaN(startDate.getTime()) ? startDate : null;\n    const validEndDate = endDate && !isNaN(endDate.getTime()) ? endDate : null;\n\n    // ç¡®ä¿ç»“æŸæ—¥æœŸä¸æ—©äºå¼€å§‹æ—¥æœŸ\n    let finalStartDate = validStartDate;\n    let finalEndDate = validEndDate;\n    if (finalStartDate && finalEndDate && finalEndDate < finalStartDate) {\n      const temp = finalStartDate;\n      finalStartDate = finalEndDate;\n      finalEndDate = temp;\n    }\n\n    return {\n      startDate: finalStartDate,\n      endDate: finalEndDate,\n      hasDateRange: finalStartDate || finalEndDate\n    };\n  }\n\n  /**\n   * æ„å»ºæŸ¥è¯¢æ¡ä»¶\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @param {Object} options - æŸ¥è¯¢é€‰é¡¹\n   * @returns {Object} æŸ¥è¯¢æ¡ä»¶\n   */\n  buildQueryConditions(req, options = {}) {\n    const {\n      allowedFilters = [],\n      allowedSortFields = [],\n      defaultSort: _defaultSort = 'createdAt',\n      searchFields = []\n    } = options;\n\n    const pagination = this.getPaginationParams(req);\n    const sorting = this.getSortingParams(req, allowedSortFields);\n    const filters = this.getFilterParams(req, allowedFilters);\n    const search = this.getSearchParams(req);\n    const dateRange = this.getDateRangeParams(req);\n\n    return {\n      pagination,\n      sorting,\n      filters,\n      search,\n      dateRange,\n      // æ„å»ºå®Œæ•´çš„æŸ¥è¯¢å¯¹è±¡\n      query: {\n        ...filters,\n        ...(search.hasSearch && searchFields.length > 0\n          ? {\n            $or: searchFields.map((field) => ({\n              [field]: { $regex: search.keyword, $options: 'i' }\n            }))\n          }\n          : {}),\n        ...(dateRange.hasDateRange\n          ? {\n            ...(dateRange.startDate ? { createdAt: { $gte: dateRange.startDate } } : {}),\n            ...(dateRange.endDate\n              ? { createdAt: { ...filters.createdAt, $lte: dateRange.endDate } }\n              : {})\n          }\n          : {})\n      }\n    };\n  }\n\n  /**\n   * æ ¼å¼åŒ–åˆ†é¡µå“åº”\n   * @param {Array} data - æ•°æ®æ•°ç»„\n   * @param {number} total - æ€»æ•°\n   * @param {Object} pagination - åˆ†é¡µå‚æ•°\n   * @returns {Object} åˆ†é¡µå“åº”å¯¹è±¡\n   */\n  formatPaginatedResponse(data, total, pagination) {\n    const { page, limit } = pagination;\n    const totalPages = Math.ceil(total / limit);\n    const hasNextPage = page < totalPages;\n    const hasPrevPage = page > 1;\n\n    return {\n      data,\n      pagination: {\n        current: page,\n        total: totalPages,\n        count: data.length,\n        totalCount: total,\n        limit,\n        hasNext: hasNextPage,\n        hasPrev: hasPrevPage,\n        nextPage: hasNextPage ? page + 1 : null,\n        prevPage: hasPrevPage ? page - 1 : null\n      }\n    };\n  }\n\n  /**\n   * æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨\n   * @param {*} resource - èµ„æºå¯¹è±¡\n   * @param {string} resourceName - èµ„æºåç§°\n   * @throws {NotFoundError} èµ„æºä¸å­˜åœ¨æ—¶æŠ›å‡ºé”™è¯¯\n   */\n  checkResourceExists(resource, resourceName = 'èµ„æº') {\n    if (!resource) {\n      const error = new Error(`${resourceName}ä¸å­˜åœ¨`);\n      error.name = 'NotFoundError';\n      throw error;\n    }\n  }\n\n  /**\n   * æ£€æŸ¥ç”¨æˆ·æƒé™\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @param {string|Array} requiredRoles - éœ€è¦çš„è§’è‰²\n   * @throws {ForbiddenError} æƒé™ä¸è¶³æ—¶æŠ›å‡ºé”™è¯¯\n   */\n  checkPermission(req, requiredRoles) {\n    const userRole = req.user?.role;\n    const roles = Array.isArray(requiredRoles) ? requiredRoles : [requiredRoles];\n\n    if (!userRole || !roles.includes(userRole)) {\n      const error = new Error('æƒé™ä¸è¶³');\n      error.name = 'ForbiddenError';\n      throw error;\n    }\n  }\n\n  /**\n   * æ£€æŸ¥èµ„æºæ‰€æœ‰æƒ\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @param {Object} resource - èµ„æºå¯¹è±¡\n   * @param {string} ownerField - æ‰€æœ‰è€…å­—æ®µå\n   * @throws {ForbiddenError} ä¸æ˜¯èµ„æºæ‰€æœ‰è€…æ—¶æŠ›å‡ºé”™è¯¯\n   */\n  checkOwnership(req, resource, ownerField = 'userId') {\n    const userId = req.user?.userId;\n    const resourceOwnerId = resource[ownerField];\n\n    if (req.user?.role !== 'admin' && userId !== resourceOwnerId) {\n      const error = new Error('åªèƒ½æ“ä½œè‡ªå·±çš„èµ„æº');\n      error.name = 'ForbiddenError';\n      throw error;\n    }\n  }\n\n  /**\n   * è®°å½•æ“ä½œæ—¥å¿—\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @param {string} action - æ“ä½œç±»å‹\n   * @param {Object} details - æ“ä½œè¯¦æƒ…\n   */\n  logOperation(req, action, details = {}) {\n    console.log(`[${new Date().toISOString()}] Operation Log:`, {\n      action,\n      user: req.user?.username || 'anonymous',\n      userId: req.user?.userId,\n      ip: req.ip,\n      userAgent: req.get('User-Agent'),\n      url: req.url,\n      method: req.method,\n      ...details\n    });\n  }\n\n  /**\n   * æ¸…ç†æ•æ„Ÿæ•°æ®\n   * @param {Object} data - æ•°æ®å¯¹è±¡\n   * @param {Array} sensitiveFields - æ•æ„Ÿå­—æ®µåˆ—è¡¨\n   * @returns {Object} æ¸…ç†åçš„æ•°æ®\n   */\n  sanitizeData(data, sensitiveFields = ['password', 'token', 'secret']) {\n    if (!data || typeof data !== 'object') {\n      return data;\n    }\n\n    const sanitized = Array.isArray(data) ? [] : {};\n\n    for (const [key, value] of Object.entries(data)) {\n      if (sensitiveFields.includes(key)) {\n        sanitized[key] = '[REDACTED]';\n      } else if (typeof value === 'object' && value !== null) {\n        sanitized[key] = this.sanitizeData(value, sensitiveFields);\n      } else {\n        sanitized[key] = value;\n      }\n    }\n\n    return sanitized;\n  }\n\n  /**\n   * æˆåŠŸå“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - å“åº”æ¶ˆæ¯\n   * @param {Object} data - å“åº”æ•°æ®\n   * @param {number} statusCode - HTTPçŠ¶æ€ç \n   */\n  success(res, message, data = null, statusCode = 200) {\n    return responseFormatter.success(res, message, data, statusCode);\n  }\n\n  /**\n   * é”™è¯¯å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   * @param {number} statusCode - HTTPçŠ¶æ€ç \n   * @param {Object} details - é”™è¯¯è¯¦æƒ…\n   */\n  error(res, message, statusCode = 500, details = null) {\n    return responseFormatter.error(res, message, statusCode, details);\n  }\n\n  /**\n   * éªŒè¯é”™è¯¯å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   * @param {Object} details - éªŒè¯é”™è¯¯è¯¦æƒ…\n   */\n  validationError(res, message, details = null) {\n    return responseFormatter.validationError(res, message, details);\n  }\n\n  /**\n   * æœªæˆæƒå“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   */\n  unauthorized(res, message = 'æœªæˆæƒè®¿é—®') {\n    return responseFormatter.unauthorized(res, message);\n  }\n\n  /**\n   * ç¦æ­¢è®¿é—®å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   */\n  forbidden(res, message = 'ç¦æ­¢è®¿é—®') {\n    return responseFormatter.forbidden(res, message);\n  }\n\n  /**\n   * èµ„æºæœªæ‰¾åˆ°å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   */\n  notFound(res, message = 'èµ„æºæœªæ‰¾åˆ°') {\n    return responseFormatter.notFound(res, message);\n  }\n}\n\nexport default BaseController;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/controllers/CarbonController.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":102,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":102,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":172,"column":9,"nodeType":"Literal","messageId":"noMagic","endLine":172,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":301,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":487,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":487,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { validationResult } from 'express-validator';\nimport BaseController from './BaseController.js';\nimport CarbonEmission from '../../../core/entities/CarbonEmission.js';\nimport CarbonFactor from '../../../core/entities/CarbonFactor.js';\nimport EnergyData from '../../../core/entities/EnergyData.js';\nimport logger from '../../../shared/utils/logger.js';\nimport { calculateTotalEmissions } from '../../../core/services/emission.js';\n\n/**\n * ç¢³æ’æ”¾æ§åˆ¶å™¨\n * å¤„ç†ç¢³æ’æ”¾ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘\n */\nclass CarbonController extends BaseController {\n  constructor() {\n    super();\n  }\n\n  /**\n   * è·å–ç¢³æ’æ”¾æ•°æ®åˆ—è¡¨\n   */\n  getCarbonEmissions = this.asyncHandler(async (req, res) => {\n    try {\n      const pagination = this.getPaginationParams(req);\n      const sorting = this.getSortingParams(req, 'timestamp', 'desc');\n      const filters = this.getFilterParams(req, ['device_id', 'emission_source']);\n      const dateRange = this.getDateRangeParams(req);\n\n      const queryConditions = {\n        ...filters,\n        ...dateRange\n      };\n\n      const result = await CarbonEmission.findWithPagination({\n        conditions: queryConditions,\n        pagination,\n        sorting\n      });\n\n      const response = this.formatPaginatedResponse(result, pagination);\n      res.success(response);\n    } catch (error) {\n      logger.error('è·å–ç¢³æ’æ”¾æ•°æ®åˆ—è¡¨å¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–ç¢³æ’æ”¾æ•°æ®åˆ—è¡¨å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–å•ä¸ªç¢³æ’æ”¾è®°å½•\n   */\n  getCarbonEmission = this.asyncHandler(async (req, res) => {\n    const { id } = req.params;\n\n    try {\n      const carbonRecord = await CarbonEmission.findById(id);\n      if (!carbonRecord) {\n        return res.notFound('ç¢³æ’æ”¾è®°å½•ä¸å­˜åœ¨');\n      }\n\n      res.success(carbonRecord);\n    } catch (error) {\n      logger.error('è·å–ç¢³æ’æ”¾è®°å½•å¤±è´¥', {\n        error: error.message,\n        recordId: id,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–ç¢³æ’æ”¾è®°å½•å¤±è´¥');\n    }\n  });\n\n  /**\n   * åˆ›å»ºç¢³æ’æ”¾æ•°æ®è®°å½•\n   */\n  createCarbonEmission = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    try {\n      const carbonData = {\n        ...req.body,\n        created_by: req.user.id,\n        created_at: new Date().toISOString()\n      };\n\n      // è®¾ç½®é»˜è®¤æ—¶é—´æˆ³\n      if (!carbonData.timestamp) {\n        carbonData.timestamp = new Date().toISOString();\n      }\n\n      const newRecord = await CarbonEmission.create(carbonData);\n\n      this.logOperation(req, 'CARBON_EMISSION_CREATE', {\n        recordId: newRecord.id,\n        deviceId: carbonData.device_id,\n        emission: carbonData.emission_amount\n      });\n\n      res.success(newRecord, 'ç¢³æ’æ”¾æ•°æ®åˆ›å»ºæˆåŠŸ', 201);\n    } catch (error) {\n      logger.error('åˆ›å»ºç¢³æ’æ”¾æ•°æ®å¤±è´¥', {\n        error: error.message,\n        carbonData: req.body,\n        userId: req.user?.id\n      });\n      res.internalError('åˆ›å»ºç¢³æ’æ”¾æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * åŸºäºèƒ½è€—æ•°æ®è®¡ç®—ç¢³æ’æ”¾\n   */\n  calculateCarbonFromEnergy = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    try {\n      const { energy_data_ids, carbon_factor_id } = req.body;\n\n      // éªŒè¯ç¢³æ’æ”¾å› å­\n      const carbonFactor = await CarbonFactor.findById(carbon_factor_id);\n      if (!carbonFactor) {\n        return res.badRequest('ç¢³æ’æ”¾å› å­ä¸å­˜åœ¨');\n      }\n\n      // è·å–èƒ½è€—æ•°æ®\n      const energyRecords = await EnergyData.findByIds(energy_data_ids);\n      if (energyRecords.length === 0) {\n        return res.badRequest('æœªæ‰¾åˆ°æœ‰æ•ˆçš„èƒ½è€—æ•°æ®');\n      }\n\n      // è®¡ç®—ç¢³æ’æ”¾\n      const carbonEmissions = [];\n      for (const energyRecord of energyRecords) {\n        const emissionAmount = energyRecord.consumption * carbonFactor.factor_value;\n\n        const carbonData = {\n          device_id: energyRecord.device_id,\n          emission_source: energyRecord.energy_type,\n          emission_amount: emissionAmount,\n          emission_unit: carbonFactor.unit,\n          energy_consumption: energyRecord.consumption,\n          carbon_factor_id,\n          calculation_method: 'energy_based',\n          timestamp: energyRecord.timestamp,\n          created_by: req.user.id,\n          created_at: new Date().toISOString()\n        };\n\n        const newEmission = await CarbonEmission.create(carbonData);\n        carbonEmissions.push(newEmission);\n      }\n\n      this.logOperation(req, 'CARBON_CALCULATION', {\n        energyRecordCount: energyRecords.length,\n        carbonFactorId: carbon_factor_id,\n        totalEmission: carbonEmissions.reduce((sum, e) => sum + e.emission_amount, 0)\n      });\n\n      res.success(\n        {\n          calculated_emissions: carbonEmissions,\n          total_emission: carbonEmissions.reduce((sum, e) => sum + e.emission_amount, 0),\n          carbon_factor: carbonFactor\n        },\n        'ç¢³æ’æ”¾è®¡ç®—æˆåŠŸ',\n        201\n      );\n    } catch (error) {\n      logger.error('ç¢³æ’æ”¾è®¡ç®—å¤±è´¥', {\n        error: error.message,\n        requestData: req.body,\n        userId: req.user?.id\n      });\n      res.internalError('ç¢³æ’æ”¾è®¡ç®—å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–ç¢³æ’æ”¾ç»Ÿè®¡æ•°æ®\n   */\n  getCarbonStatistics = this.asyncHandler(async (req, res) => {\n    try {\n      const dateRange = this.getDateRangeParams(req);\n      const { device_id, emission_source, group_by = 'day' } = req.query;\n\n      const filters = {\n        ...dateRange\n      };\n\n      if (device_id) {filters.device_id = device_id;}\n      if (emission_source) {filters.emission_source = emission_source;}\n\n      const statistics = await CarbonEmission.getStatistics({\n        filters,\n        groupBy: group_by\n      });\n\n      res.success(statistics);\n    } catch (error) {\n      logger.error('è·å–ç¢³æ’æ”¾ç»Ÿè®¡æ•°æ®å¤±è´¥', {\n        error: error.message,\n        filters: req.query,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–ç¢³æ’æ”¾ç»Ÿè®¡æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–ç¢³æ’æ”¾è¶‹åŠ¿æ•°æ®\n   */\n  getCarbonTrend = this.asyncHandler(async (req, res) => {\n    try {\n      const { start_time, end_time, interval = 'day' } = req.query;\n\n      if (!start_time || !end_time) {\n        return res.badRequest('ç¼ºå°‘å¿…è¦å‚æ•°: start_time, end_time');\n      }\n\n      // ä½¿ç”¨ç°æœ‰çš„ç¢³æ’æ”¾è®¡ç®—æœåŠ¡\n      const trendData = calculateTotalEmissions(start_time, end_time, interval);\n\n      this.logOperation(req, 'CARBON_TREND_QUERY', {\n        timeRange: { start_time, end_time },\n        interval\n      });\n\n      res.success({\n        trend: trendData,\n        unit: 'kgCO2',\n        time_range: {\n          start: start_time,\n          end: end_time\n        },\n        interval\n      });\n    } catch (error) {\n      logger.error('è·å–ç¢³æ’æ”¾è¶‹åŠ¿æ•°æ®å¤±è´¥', {\n        error: error.message,\n        timeRange: { start_time: req.query.start_time, end_time: req.query.end_time },\n        userId: req.user?.id\n      });\n      res.internalError('è·å–ç¢³æ’æ”¾è¶‹åŠ¿æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–ç¢³æ’æ”¾å› å­åˆ—è¡¨\n   */\n  getCarbonFactors = this.asyncHandler(async (req, res) => {\n    try {\n      const pagination = this.getPaginationParams(req);\n      const filters = this.getFilterParams(req, ['energy_type', 'region']);\n\n      const result = await CarbonFactor.findWithPagination({\n        conditions: filters,\n        pagination\n      });\n\n      const response = this.formatPaginatedResponse(result, pagination);\n      res.success(response);\n    } catch (error) {\n      logger.error('è·å–ç¢³æ’æ”¾å› å­åˆ—è¡¨å¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–ç¢³æ’æ”¾å› å­åˆ—è¡¨å¤±è´¥');\n    }\n  });\n\n  /**\n   * åˆ›å»ºç¢³æ’æ”¾å› å­\n   */\n  createCarbonFactor = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    try {\n      const factorData = {\n        ...req.body,\n        created_by: req.user.id,\n        created_at: new Date().toISOString()\n      };\n\n      const newFactor = await CarbonFactor.create(factorData);\n\n      this.logOperation(req, 'CARBON_FACTOR_CREATE', {\n        factorId: newFactor.id,\n        energyType: factorData.energy_type,\n        factorValue: factorData.factor_value\n      });\n\n      res.success(newFactor, 'ç¢³æ’æ”¾å› å­åˆ›å»ºæˆåŠŸ', 201);\n    } catch (error) {\n      logger.error('åˆ›å»ºç¢³æ’æ”¾å› å­å¤±è´¥', {\n        error: error.message,\n        factorData: req.body,\n        userId: req.user?.id\n      });\n      res.internalError('åˆ›å»ºç¢³æ’æ”¾å› å­å¤±è´¥');\n    }\n  });\n\n  /**\n   * æ›´æ–°ç¢³æ’æ”¾å› å­\n   */\n  updateCarbonFactor = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    const { id } = req.params;\n\n    try {\n      const factor = await CarbonFactor.findById(id);\n      if (!factor) {\n        return res.notFound('ç¢³æ’æ”¾å› å­ä¸å­˜åœ¨');\n      }\n\n      const updateData = {\n        ...req.body,\n        updated_by: req.user.id,\n        updated_at: new Date().toISOString()\n      };\n\n      const updatedFactor = await CarbonFactor.update(id, updateData);\n\n      this.logOperation(req, 'CARBON_FACTOR_UPDATE', {\n        factorId: id,\n        changes: Object.keys(updateData)\n      });\n\n      res.success(updatedFactor, 'ç¢³æ’æ”¾å› å­æ›´æ–°æˆåŠŸ');\n    } catch (error) {\n      logger.error('æ›´æ–°ç¢³æ’æ”¾å› å­å¤±è´¥', {\n        error: error.message,\n        factorId: id,\n        updateData: req.body,\n        userId: req.user?.id\n      });\n      res.internalError('æ›´æ–°ç¢³æ’æ”¾å› å­å¤±è´¥');\n    }\n  });\n\n  /**\n   * ç”Ÿæˆç¢³æ’æ”¾æŠ¥å‘Š\n   */\n  generateCarbonReport = this.asyncHandler(async (req, res) => {\n    try {\n      const dateRange = this.getDateRangeParams(req);\n      const { report_type = 'summary', device_ids } = req.query;\n\n      const filters = {\n        ...dateRange\n      };\n\n      if (device_ids) {\n        filters.device_id = device_ids.split(',');\n      }\n\n      const report = await CarbonEmission.generateReport({\n        filters,\n        reportType: report_type\n      });\n\n      this.logOperation(req, 'CARBON_REPORT_GENERATE', {\n        reportType: report_type,\n        timeRange: dateRange,\n        deviceCount: device_ids ? device_ids.split(',').length : 'all'\n      });\n\n      res.success({\n        report,\n        generated_at: new Date().toISOString(),\n        report_type,\n        time_range: dateRange\n      });\n    } catch (error) {\n      logger.error('ç”Ÿæˆç¢³æ’æ”¾æŠ¥å‘Šå¤±è´¥', {\n        error: error.message,\n        reportType: req.query.report_type,\n        userId: req.user?.id\n      });\n      res.internalError('ç”Ÿæˆç¢³æ’æ”¾æŠ¥å‘Šå¤±è´¥');\n    }\n  });\n\n  /**\n   * å¯¼å‡ºç¢³æ’æ”¾æ•°æ®\n   */\n  exportCarbonData = this.asyncHandler(async (req, res) => {\n    try {\n      const dateRange = this.getDateRangeParams(req);\n      const filters = this.getFilterParams(req, ['device_id', 'emission_source']);\n      const { format = 'csv' } = req.query;\n\n      const queryConditions = {\n        ...filters,\n        ...dateRange\n      };\n\n      let exportData;\n      let contentType;\n      let fileExtension;\n\n      switch (format.toLowerCase()) {\n        case 'csv':\n          exportData = await CarbonEmission.exportToCSV(queryConditions);\n          contentType = 'text/csv';\n          fileExtension = 'csv';\n          break;\n        case 'json':\n          exportData = await CarbonEmission.exportToJSON(queryConditions);\n          contentType = 'application/json';\n          fileExtension = 'json';\n          break;\n        default:\n          return res.badRequest('ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼');\n      }\n\n      this.logOperation(req, 'CARBON_DATA_EXPORT', {\n        format,\n        filters: queryConditions,\n        recordCount: exportData.recordCount\n      });\n\n      res.downloadFile(\n        exportData.content,\n        `carbon_emissions_${Date.now()}.${fileExtension}`,\n        contentType\n      );\n    } catch (error) {\n      logger.error('å¯¼å‡ºç¢³æ’æ”¾æ•°æ®å¤±è´¥', {\n        error: error.message,\n        format: req.query.format,\n        filters: req.query,\n        userId: req.user?.id\n      });\n      res.internalError('å¯¼å‡ºç¢³æ’æ”¾æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * åˆ é™¤ç¢³æ’æ”¾æ•°æ®è®°å½•\n   */\n  deleteCarbonEmission = this.asyncHandler(async (req, res) => {\n    const { id } = req.params;\n\n    try {\n      const carbonRecord = await CarbonEmission.findById(id);\n      if (!carbonRecord) {\n        return res.notFound('ç¢³æ’æ”¾è®°å½•ä¸å­˜åœ¨');\n      }\n\n      await CarbonEmission.delete(id);\n\n      this.logOperation(req, 'CARBON_EMISSION_DELETE', {\n        recordId: id,\n        deviceId: carbonRecord.device_id\n      });\n\n      res.success(null, 'ç¢³æ’æ”¾æ•°æ®åˆ é™¤æˆåŠŸ');\n    } catch (error) {\n      logger.error('åˆ é™¤ç¢³æ’æ”¾æ•°æ®å¤±è´¥', {\n        error: error.message,\n        recordId: id,\n        userId: req.user?.id\n      });\n      res.internalError('åˆ é™¤ç¢³æ’æ”¾æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–ç¢³æ’æ”¾é¢„æµ‹\n   */\n  getCarbonPrediction = this.asyncHandler(async (req, res) => {\n    try {\n      const { device_id, prediction_days = 7 } = req.query;\n\n      const filters = {};\n      if (device_id) {filters.device_id = device_id;}\n\n      const prediction = await CarbonEmission.getPrediction({\n        filters,\n        predictionDays: parseInt(prediction_days)\n      });\n\n      res.success({\n        prediction_days: parseInt(prediction_days),\n        prediction_data: prediction,\n        generated_at: new Date().toISOString()\n      });\n    } catch (error) {\n      logger.error('è·å–ç¢³æ’æ”¾é¢„æµ‹å¤±è´¥', {\n        error: error.message,\n        deviceId: req.query.device_id,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–ç¢³æ’æ”¾é¢„æµ‹å¤±è´¥');\n    }\n  });\n}\n\nexport default new CarbonController();\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/controllers/DeviceController.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":119,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":119,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { validationResult } from 'express-validator';\nimport BaseController from './BaseController.js';\nimport Device from '../../../core/entities/Device.js';\nimport DeviceType from '../../../core/entities/DeviceType.js';\nimport logger from '../../../shared/utils/logger.js';\n\n/**\n * è®¾å¤‡ç®¡ç†æ§åˆ¶å™¨\n * å¤„ç†è®¾å¤‡ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘\n */\nclass DeviceController extends BaseController {\n  constructor() {\n    super();\n  }\n\n  /**\n   * è·å–è®¾å¤‡åˆ—è¡¨\n   */\n  getDevices = this.asyncHandler(async (req, res) => {\n    try {\n      const pagination = this.getPaginationParams(req);\n      const sorting = this.getSortingParams(req, 'created_at', 'desc');\n      const filters = this.getFilterParams(req, ['type', 'status', 'location']);\n      const search = this.getSearchParams(req, ['name', 'serial_number', 'model']);\n      const dateRange = this.getDateRangeParams(req);\n\n      // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n      const queryConditions = {\n        ...filters,\n        ...search,\n        ...dateRange\n      };\n\n      const result = await Device.findWithPagination({\n        conditions: queryConditions,\n        pagination,\n        sorting\n      });\n\n      const response = this.formatPaginatedResponse(result, pagination);\n      res.success(response);\n    } catch (error) {\n      logger.error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–å•ä¸ªè®¾å¤‡è¯¦æƒ…\n   */\n  getDevice = this.asyncHandler(async (req, res) => {\n    const { id } = req.params;\n\n    try {\n      const device = await Device.findById(id);\n      if (!device) {\n        return res.notFound('è®¾å¤‡ä¸å­˜åœ¨');\n      }\n\n      // è·å–è®¾å¤‡ç±»å‹ä¿¡æ¯\n      if (device.type_id) {\n        device.type_info = await DeviceType.findById(device.type_id);\n      }\n\n      res.success(device);\n    } catch (error) {\n      logger.error('è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥', {\n        error: error.message,\n        deviceId: id,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥');\n    }\n  });\n\n  /**\n   * åˆ›å»ºæ–°è®¾å¤‡\n   */\n  createDevice = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    try {\n      const deviceData = {\n        ...req.body,\n        created_by: req.user.id,\n        created_at: new Date().toISOString(),\n        status: req.body.status || 'offline'\n      };\n\n      // æ£€æŸ¥åºåˆ—å·æ˜¯å¦å·²å­˜åœ¨\n      if (deviceData.serial_number) {\n        const existingDevice = await Device.findBySerialNumber(deviceData.serial_number);\n        if (existingDevice) {\n          return res.conflict('è®¾å¤‡åºåˆ—å·å·²å­˜åœ¨');\n        }\n      }\n\n      // éªŒè¯è®¾å¤‡ç±»å‹\n      if (deviceData.type_id) {\n        const deviceType = await DeviceType.findById(deviceData.type_id);\n        if (!deviceType) {\n          return res.badRequest('æ— æ•ˆçš„è®¾å¤‡ç±»å‹');\n        }\n      }\n\n      const newDevice = await Device.create(deviceData);\n\n      this.logOperation(req, 'DEVICE_CREATE', {\n        deviceId: newDevice.id,\n        deviceName: newDevice.name\n      });\n\n      res.success(newDevice, 'è®¾å¤‡åˆ›å»ºæˆåŠŸ', 201);\n    } catch (error) {\n      logger.error('åˆ›å»ºè®¾å¤‡å¤±è´¥', {\n        error: error.message,\n        deviceData: req.body,\n        userId: req.user?.id\n      });\n      res.internalError('åˆ›å»ºè®¾å¤‡å¤±è´¥');\n    }\n  });\n\n  /**\n   * æ›´æ–°è®¾å¤‡ä¿¡æ¯\n   */\n  updateDevice = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    const { id } = req.params;\n\n    try {\n      const device = await Device.findById(id);\n      if (!device) {\n        return res.notFound('è®¾å¤‡ä¸å­˜åœ¨');\n      }\n\n      const updateData = {\n        ...req.body,\n        updated_by: req.user.id,\n        updated_at: new Date().toISOString()\n      };\n\n      // æ£€æŸ¥åºåˆ—å·å†²çªï¼ˆå¦‚æœæ›´æ–°äº†åºåˆ—å·ï¼‰\n      if (updateData.serial_number && updateData.serial_number !== device.serial_number) {\n        const existingDevice = await Device.findBySerialNumber(updateData.serial_number);\n        if (existingDevice && existingDevice.id !== id) {\n          return res.conflict('è®¾å¤‡åºåˆ—å·å·²å­˜åœ¨');\n        }\n      }\n\n      // éªŒè¯è®¾å¤‡ç±»å‹ï¼ˆå¦‚æœæ›´æ–°äº†ç±»å‹ï¼‰\n      if (updateData.type_id && updateData.type_id !== device.type_id) {\n        const deviceType = await DeviceType.findById(updateData.type_id);\n        if (!deviceType) {\n          return res.badRequest('æ— æ•ˆçš„è®¾å¤‡ç±»å‹');\n        }\n      }\n\n      const updatedDevice = await Device.update(id, updateData);\n\n      this.logOperation(req, 'DEVICE_UPDATE', {\n        deviceId: id,\n        deviceName: updatedDevice.name,\n        changes: Object.keys(updateData)\n      });\n\n      res.success(updatedDevice, 'è®¾å¤‡æ›´æ–°æˆåŠŸ');\n    } catch (error) {\n      logger.error('æ›´æ–°è®¾å¤‡å¤±è´¥', {\n        error: error.message,\n        deviceId: id,\n        updateData: req.body,\n        userId: req.user?.id\n      });\n      res.internalError('æ›´æ–°è®¾å¤‡å¤±è´¥');\n    }\n  });\n\n  /**\n   * åˆ é™¤è®¾å¤‡\n   */\n  deleteDevice = this.asyncHandler(async (req, res) => {\n    const { id } = req.params;\n\n    try {\n      const device = await Device.findById(id);\n      if (!device) {\n        return res.notFound('è®¾å¤‡ä¸å­˜åœ¨');\n      }\n\n      // æ£€æŸ¥è®¾å¤‡æ˜¯å¦æœ‰å…³è”æ•°æ®\n      const hasRelatedData = await Device.hasRelatedData(id);\n      if (hasRelatedData) {\n        return res.conflict('è®¾å¤‡å­˜åœ¨å…³è”æ•°æ®ï¼Œæ— æ³•åˆ é™¤');\n      }\n\n      await Device.delete(id);\n\n      this.logOperation(req, 'DEVICE_DELETE', {\n        deviceId: id,\n        deviceName: device.name\n      });\n\n      res.success(null, 'è®¾å¤‡åˆ é™¤æˆåŠŸ');\n    } catch (error) {\n      logger.error('åˆ é™¤è®¾å¤‡å¤±è´¥', {\n        error: error.message,\n        deviceId: id,\n        userId: req.user?.id\n      });\n      res.internalError('åˆ é™¤è®¾å¤‡å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–è®¾å¤‡ç±»å‹åˆ—è¡¨\n   */\n  getDeviceTypes = this.asyncHandler(async (req, res) => {\n    try {\n      const deviceTypes = await DeviceType.findAll();\n      res.success(deviceTypes);\n    } catch (error) {\n      logger.error('è·å–è®¾å¤‡ç±»å‹åˆ—è¡¨å¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–è®¾å¤‡ç±»å‹åˆ—è¡¨å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–è®¾å¤‡çŠ¶æ€ç»Ÿè®¡\n   */\n  getDeviceStatusStats = this.asyncHandler(async (req, res) => {\n    try {\n      const stats = await Device.getStatusStatistics();\n      res.success(stats);\n    } catch (error) {\n      logger.error('è·å–è®¾å¤‡çŠ¶æ€ç»Ÿè®¡å¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–è®¾å¤‡çŠ¶æ€ç»Ÿè®¡å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–è®¾å¤‡ç±»å‹ç»Ÿè®¡\n   */\n  getDeviceTypeStats = this.asyncHandler(async (req, res) => {\n    try {\n      const stats = await Device.getTypeStatistics();\n      res.success(stats);\n    } catch (error) {\n      logger.error('è·å–è®¾å¤‡ç±»å‹ç»Ÿè®¡å¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–è®¾å¤‡ç±»å‹ç»Ÿè®¡å¤±è´¥');\n    }\n  });\n\n  /**\n   * æ‰¹é‡æ›´æ–°è®¾å¤‡çŠ¶æ€\n   */\n  batchUpdateStatus = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    const { device_ids, status } = req.body;\n\n    try {\n      const updateData = {\n        status,\n        updated_by: req.user.id,\n        updated_at: new Date().toISOString()\n      };\n\n      const result = await Device.batchUpdate(device_ids, updateData);\n\n      this.logOperation(req, 'DEVICE_BATCH_UPDATE', {\n        deviceIds: device_ids,\n        status,\n        affectedCount: result.affectedRows\n      });\n\n      res.success(\n        {\n          affected_count: result.affectedRows,\n          status\n        },\n        'æ‰¹é‡æ›´æ–°è®¾å¤‡çŠ¶æ€æˆåŠŸ'\n      );\n    } catch (error) {\n      logger.error('æ‰¹é‡æ›´æ–°è®¾å¤‡çŠ¶æ€å¤±è´¥', {\n        error: error.message,\n        deviceIds: req.body.device_ids,\n        status: req.body.status,\n        userId: req.user?.id\n      });\n      res.internalError('æ‰¹é‡æ›´æ–°è®¾å¤‡çŠ¶æ€å¤±è´¥');\n    }\n  });\n\n  /**\n   * è®¾å¤‡å¥åº·æ£€æŸ¥\n   */\n  healthCheck = this.asyncHandler(async (req, res) => {\n    const { id } = req.params;\n\n    try {\n      const device = await Device.findById(id);\n      if (!device) {\n        return res.notFound('è®¾å¤‡ä¸å­˜åœ¨');\n      }\n\n      // æ‰§è¡Œè®¾å¤‡å¥åº·æ£€æŸ¥\n      const healthStatus = await Device.performHealthCheck(id);\n\n      // æ›´æ–°è®¾å¤‡å¥åº·çŠ¶æ€\n      await Device.update(id, {\n        health_status: healthStatus.status,\n        last_health_check: new Date().toISOString(),\n        updated_by: req.user.id,\n        updated_at: new Date().toISOString()\n      });\n\n      this.logOperation(req, 'DEVICE_HEALTH_CHECK', {\n        deviceId: id,\n        healthStatus: healthStatus.status\n      });\n\n      res.success(healthStatus, 'è®¾å¤‡å¥åº·æ£€æŸ¥å®Œæˆ');\n    } catch (error) {\n      logger.error('è®¾å¤‡å¥åº·æ£€æŸ¥å¤±è´¥', {\n        error: error.message,\n        deviceId: id,\n        userId: req.user?.id\n      });\n      res.internalError('è®¾å¤‡å¥åº·æ£€æŸ¥å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–è®¾å¤‡å†å²æ•°æ®\n   */\n  getDeviceHistory = this.asyncHandler(async (req, res) => {\n    const { id } = req.params;\n    const dateRange = this.getDateRangeParams(req);\n    const pagination = this.getPaginationParams(req);\n\n    try {\n      const device = await Device.findById(id);\n      if (!device) {\n        return res.notFound('è®¾å¤‡ä¸å­˜åœ¨');\n      }\n\n      const history = await Device.getHistory(id, {\n        ...dateRange,\n        ...pagination\n      });\n\n      const response = this.formatPaginatedResponse(history, pagination);\n      res.success(response);\n    } catch (error) {\n      logger.error('è·å–è®¾å¤‡å†å²æ•°æ®å¤±è´¥', {\n        error: error.message,\n        deviceId: id,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–è®¾å¤‡å†å²æ•°æ®å¤±è´¥');\n    }\n  });\n}\n\nexport default new DeviceController();\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/controllers/DigitalTwinController.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":12,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":12,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":35,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":35,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":46,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":46,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":52,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":52,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":65,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":65,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":77,"column":77,"nodeType":"Literal","messageId":"noMagic","endLine":77,"endColumn":80},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":80,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":80,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":91,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":91,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":105,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":105,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":116,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":116,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":124,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":124,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":135,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":135,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":143,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":143,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":154,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":154,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":167,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":167,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":178,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":178,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":193,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":193,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":204,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":204,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":219,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":219,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":240,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":240,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":251,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":251,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":259,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":259,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":270,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":270,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":284,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":284,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":319,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":319,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":25,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import BaseController from './BaseController.js';\nimport DigitalTwin from '../../../domain/entities/DigitalTwin.js';\nimport Device from '../../../domain/entities/Device.js';\nimport logger from '../../../utils/logger.js';\n\nclass DigitalTwinController extends BaseController {\n  /**\n   * è·å–æ•°å­—å­ªç”Ÿåˆ—è¡¨\n   */\n  async getDigitalTwins(req, res) {\n    try {\n      const { page = 1, limit = 20, deviceId, twinType, status, buildingId } = req.query;\n\n      const filters = {};\n      if (deviceId) {filters.deviceId = deviceId;}\n      if (twinType) {filters.twinType = twinType;}\n      if (status) {filters.status = status;}\n      if (buildingId) {filters.buildingId = buildingId;}\n\n      const offset = (page - 1) * limit;\n      const digitalTwins = await DigitalTwin.findWithPagination(filters, offset, parseInt(limit));\n      const total = await DigitalTwin.countDocuments(filters);\n\n      return this.success(res, 'è·å–æ•°å­—å­ªç”Ÿåˆ—è¡¨æˆåŠŸ', {\n        data: digitalTwins,\n        pagination: {\n          page: parseInt(page),\n          limit: parseInt(limit),\n          total,\n          pages: Math.ceil(total / limit)\n        }\n      });\n    } catch (error) {\n      logger.error('è·å–æ•°å­—å­ªç”Ÿåˆ—è¡¨é”™è¯¯:', error);\n      return this.error(res, 'è·å–æ•°å­—å­ªç”Ÿåˆ—è¡¨å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–å•ä¸ªæ•°å­—å­ªç”Ÿ\n   */\n  async getDigitalTwin(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findByIdWithDetails(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      return this.success(res, 'è·å–æ•°å­—å­ªç”ŸæˆåŠŸ', { digitalTwin });\n    } catch (error) {\n      logger.error('è·å–æ•°å­—å­ªç”Ÿé”™è¯¯:', error);\n      return this.error(res, 'è·å–æ•°å­—å­ªç”Ÿå¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * åˆ›å»ºæ•°å­—å­ªç”Ÿ\n   */\n  async createDigitalTwin(req, res) {\n    try {\n      // éªŒè¯å…³è”è®¾å¤‡æ˜¯å¦å­˜åœ¨\n      if (req.body.deviceId) {\n        const device = await Device.findById(req.body.deviceId);\n        if (!device) {\n          return this.error(res, 'å…³è”è®¾å¤‡ä¸å­˜åœ¨', 404);\n        }\n      }\n\n      const digitalTwinData = {\n        ...req.body,\n        createdBy: req.user.userId,\n        createdAt: new Date()\n      };\n\n      const newDigitalTwin = await DigitalTwin.create(digitalTwinData);\n\n      return this.success(res, 'æ•°å­—å­ªç”Ÿåˆ›å»ºæˆåŠŸ', { digitalTwin: newDigitalTwin }, 201);\n    } catch (error) {\n      logger.error('åˆ›å»ºæ•°å­—å­ªç”Ÿé”™è¯¯:', error);\n      return this.error(res, 'åˆ›å»ºæ•°å­—å­ªç”Ÿå¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * æ›´æ–°æ•°å­—å­ªç”Ÿ\n   */\n  async updateDigitalTwin(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findById(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      const updateData = {\n        ...req.body,\n        updatedBy: req.user.userId,\n        updatedAt: new Date()\n      };\n\n      const updatedDigitalTwin = await digitalTwin.update(updateData);\n\n      return this.success(res, 'æ•°å­—å­ªç”Ÿæ›´æ–°æˆåŠŸ', { digitalTwin: updatedDigitalTwin });\n    } catch (error) {\n      logger.error('æ›´æ–°æ•°å­—å­ªç”Ÿé”™è¯¯:', error);\n      return this.error(res, 'æ›´æ–°æ•°å­—å­ªç”Ÿå¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * åˆ é™¤æ•°å­—å­ªç”Ÿ\n   */\n  async deleteDigitalTwin(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findById(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      await digitalTwin.delete();\n\n      return this.success(res, 'æ•°å­—å­ªç”Ÿåˆ é™¤æˆåŠŸ');\n    } catch (error) {\n      logger.error('åˆ é™¤æ•°å­—å­ªç”Ÿé”™è¯¯:', error);\n      return this.error(res, 'åˆ é™¤æ•°å­—å­ªç”Ÿå¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–æ•°å­—å­ªç”Ÿå®æ—¶æ•°æ®\n   */\n  async getDigitalTwinRealTimeData(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findById(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      const realTimeData = await digitalTwin.getRealTimeData();\n\n      return this.success(res, 'è·å–å®æ—¶æ•°æ®æˆåŠŸ', { realTimeData });\n    } catch (error) {\n      logger.error('è·å–æ•°å­—å­ªç”Ÿå®æ—¶æ•°æ®é”™è¯¯:', error);\n      return this.error(res, 'è·å–å®æ—¶æ•°æ®å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * æ›´æ–°æ•°å­—å­ªç”ŸçŠ¶æ€\n   */\n  async updateDigitalTwinStatus(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findById(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      const { status, statusData } = req.body;\n      const updatedDigitalTwin = await digitalTwin.updateStatus(\n        status,\n        statusData,\n        req.user.userId\n      );\n\n      return this.success(res, 'æ•°å­—å­ªç”ŸçŠ¶æ€æ›´æ–°æˆåŠŸ', { digitalTwin: updatedDigitalTwin });\n    } catch (error) {\n      logger.error('æ›´æ–°æ•°å­—å­ªç”ŸçŠ¶æ€é”™è¯¯:', error);\n      return this.error(res, 'æ›´æ–°çŠ¶æ€å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–æ•°å­—å­ªç”Ÿæ¨¡æ‹Ÿæ•°æ®\n   */\n  async getDigitalTwinSimulationData(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findById(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      const { startDate, endDate, simulationType, parameters } = req.query;\n\n      const simulationData = await digitalTwin.getSimulationData({\n        startDate: startDate ? new Date(startDate) : null,\n        endDate: endDate ? new Date(endDate) : null,\n        simulationType,\n        parameters: parameters ? JSON.parse(parameters) : {}\n      });\n\n      return this.success(res, 'è·å–æ¨¡æ‹Ÿæ•°æ®æˆåŠŸ', { simulationData });\n    } catch (error) {\n      logger.error('è·å–æ•°å­—å­ªç”Ÿæ¨¡æ‹Ÿæ•°æ®é”™è¯¯:', error);\n      return this.error(res, 'è·å–æ¨¡æ‹Ÿæ•°æ®å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è¿è¡Œæ•°å­—å­ªç”Ÿæ¨¡æ‹Ÿ\n   */\n  async runDigitalTwinSimulation(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findById(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      const { simulationType, parameters, duration } = req.body;\n\n      const simulationResult = await digitalTwin.runSimulation({\n        simulationType,\n        parameters,\n        duration,\n        initiatedBy: req.user.userId\n      });\n\n      return this.success(res, 'æ¨¡æ‹Ÿè¿è¡ŒæˆåŠŸ', { simulationResult });\n    } catch (error) {\n      logger.error('è¿è¡Œæ•°å­—å­ªç”Ÿæ¨¡æ‹Ÿé”™è¯¯:', error);\n      return this.error(res, 'è¿è¡Œæ¨¡æ‹Ÿå¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–æ•°å­—å­ªç”Ÿç»Ÿè®¡æ•°æ®\n   */\n  async getDigitalTwinStats(req, res) {\n    try {\n      const { twinType, buildingId, status } = req.query;\n\n      const filters = {};\n      if (twinType) {filters.twinType = twinType;}\n      if (buildingId) {filters.buildingId = buildingId;}\n      if (status) {filters.status = status;}\n\n      const stats = await DigitalTwin.getStatistics(filters);\n\n      return this.success(res, 'è·å–æ•°å­—å­ªç”Ÿç»Ÿè®¡æˆåŠŸ', { stats });\n    } catch (error) {\n      logger.error('è·å–æ•°å­—å­ªç”Ÿç»Ÿè®¡é”™è¯¯:', error);\n      return this.error(res, 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * åŒæ­¥æ•°å­—å­ªç”Ÿæ•°æ®\n   */\n  async syncDigitalTwinData(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findById(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      const syncResult = await digitalTwin.syncWithRealWorld(req.user.userId);\n\n      return this.success(res, 'æ•°æ®åŒæ­¥æˆåŠŸ', { syncResult });\n    } catch (error) {\n      logger.error('åŒæ­¥æ•°å­—å­ªç”Ÿæ•°æ®é”™è¯¯:', error);\n      return this.error(res, 'æ•°æ®åŒæ­¥å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–æ•°å­—å­ªç”Ÿæ€§èƒ½æŒ‡æ ‡\n   */\n  async getDigitalTwinPerformance(req, res) {\n    try {\n      const digitalTwin = await DigitalTwin.findById(req.params.id);\n      if (!digitalTwin) {\n        return this.error(res, 'æ•°å­—å­ªç”Ÿä¸å­˜åœ¨', 404);\n      }\n\n      const { startDate, endDate, metrics } = req.query;\n\n      const performance = await digitalTwin.getPerformanceMetrics({\n        startDate: startDate ? new Date(startDate) : null,\n        endDate: endDate ? new Date(endDate) : null,\n        metrics: metrics ? metrics.split(',') : []\n      });\n\n      return this.success(res, 'è·å–æ€§èƒ½æŒ‡æ ‡æˆåŠŸ', { performance });\n    } catch (error) {\n      logger.error('è·å–æ•°å­—å­ªç”Ÿæ€§èƒ½æŒ‡æ ‡é”™è¯¯:', error);\n      return this.error(res, 'è·å–æ€§èƒ½æŒ‡æ ‡å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * å¯¼å‡ºæ•°å­—å­ªç”Ÿæ•°æ®\n   */\n  async exportDigitalTwinData(req, res) {\n    try {\n      const { twinType, buildingId, status, format = 'csv' } = req.query;\n\n      const filters = {};\n      if (twinType) {filters.twinType = twinType;}\n      if (buildingId) {filters.buildingId = buildingId;}\n      if (status) {filters.status = status;}\n\n      let exportData;\n      let contentType;\n      let filename;\n\n      if (format === 'json') {\n        exportData = await DigitalTwin.exportToJSON(filters);\n        contentType = 'application/json';\n        filename = 'digital-twins.json';\n      } else {\n        exportData = await DigitalTwin.exportToCSV(filters);\n        contentType = 'text/csv';\n        filename = 'digital-twins.csv';\n      }\n\n      res.setHeader('Content-Type', contentType);\n      res.setHeader('Content-Disposition', `attachment; filename=${filename}`);\n      res.send(exportData);\n    } catch (error) {\n      logger.error('å¯¼å‡ºæ•°å­—å­ªç”Ÿæ•°æ®é”™è¯¯:', error);\n      return this.error(res, 'å¯¼å‡ºæ•°æ®å¤±è´¥', 500);\n    }\n  }\n}\n\nexport default new DigitalTwinController();\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/controllers/EnergyController.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":114,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":114,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":170,"column":9,"nodeType":"Literal","messageId":"noMagic","endLine":170,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":219,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":219,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":344,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":344,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { validationResult } from 'express-validator';\nimport BaseController from './BaseController.js';\nimport EnergyData from '../../../core/entities/EnergyData.js';\nimport Device from '../../../core/entities/Device.js';\nimport logger from '../../../shared/utils/logger.js';\n\n/**\n * èƒ½æºæ•°æ®æ§åˆ¶å™¨\n * å¤„ç†èƒ½è€—æ•°æ®ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘\n */\nclass EnergyController extends BaseController {\n  constructor() {\n    super();\n  }\n\n  /**\n   * è·å–èƒ½è€—æ•°æ®åˆ—è¡¨\n   */\n  getEnergyData = this.asyncHandler(async (req, res) => {\n    try {\n      const pagination = this.getPaginationParams(req);\n      const sorting = this.getSortingParams(req, 'timestamp', 'desc');\n      const filters = this.getFilterParams(req, ['device_id', 'energy_type']);\n      const dateRange = this.getDateRangeParams(req);\n\n      // æ„å»ºæŸ¥è¯¢æ¡ä»¶\n      const queryConditions = {\n        ...filters,\n        ...dateRange\n      };\n\n      const result = await EnergyData.findWithPagination({\n        conditions: queryConditions,\n        pagination,\n        sorting\n      });\n\n      const response = this.formatPaginatedResponse(result, pagination);\n      res.success(response);\n    } catch (error) {\n      logger.error('è·å–èƒ½è€—æ•°æ®åˆ—è¡¨å¤±è´¥', {\n        error: error.message,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–èƒ½è€—æ•°æ®åˆ—è¡¨å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–å•ä¸ªèƒ½è€—è®°å½•\n   */\n  getEnergyRecord = this.asyncHandler(async (req, res) => {\n    const { id } = req.params;\n\n    try {\n      const energyRecord = await EnergyData.findById(id);\n      if (!energyRecord) {\n        return res.notFound('èƒ½è€—è®°å½•ä¸å­˜åœ¨');\n      }\n\n      // è·å–å…³è”è®¾å¤‡ä¿¡æ¯\n      if (energyRecord.device_id) {\n        energyRecord.device_info = await Device.findById(energyRecord.device_id);\n      }\n\n      res.success(energyRecord);\n    } catch (error) {\n      logger.error('è·å–èƒ½è€—è®°å½•å¤±è´¥', {\n        error: error.message,\n        recordId: id,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–èƒ½è€—è®°å½•å¤±è´¥');\n    }\n  });\n\n  /**\n   * åˆ›å»ºèƒ½è€—æ•°æ®è®°å½•\n   */\n  createEnergyData = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    try {\n      const energyData = {\n        ...req.body,\n        created_by: req.user.id,\n        created_at: new Date().toISOString()\n      };\n\n      // éªŒè¯è®¾å¤‡æ˜¯å¦å­˜åœ¨\n      if (energyData.device_id) {\n        const device = await Device.findById(energyData.device_id);\n        if (!device) {\n          return res.badRequest('è®¾å¤‡ä¸å­˜åœ¨');\n        }\n      }\n\n      // è®¾ç½®é»˜è®¤æ—¶é—´æˆ³\n      if (!energyData.timestamp) {\n        energyData.timestamp = new Date().toISOString();\n      }\n\n      const newRecord = await EnergyData.create(energyData);\n\n      this.logOperation(req, 'ENERGY_DATA_CREATE', {\n        recordId: newRecord.id,\n        deviceId: energyData.device_id,\n        consumption: energyData.consumption\n      });\n\n      res.success(newRecord, 'èƒ½è€—æ•°æ®åˆ›å»ºæˆåŠŸ', 201);\n    } catch (error) {\n      logger.error('åˆ›å»ºèƒ½è€—æ•°æ®å¤±è´¥', {\n        error: error.message,\n        energyData: req.body,\n        userId: req.user?.id\n      });\n      res.internalError('åˆ›å»ºèƒ½è€—æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * æ‰¹é‡åˆ›å»ºèƒ½è€—æ•°æ®è®°å½•\n   */\n  batchCreateEnergyData = this.asyncHandler(async (req, res) => {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.validationError(errors.array());\n    }\n\n    const { records } = req.body;\n\n    try {\n      // éªŒè¯æ‰€æœ‰è®¾å¤‡ID\n      const deviceIds = [...new Set(records.map((r) => r.device_id).filter(Boolean))];\n      if (deviceIds.length > 0) {\n        const devices = await Device.findByIds(deviceIds);\n        const existingDeviceIds = devices.map((d) => d.id);\n        const invalidDeviceIds = deviceIds.filter((id) => !existingDeviceIds.includes(id));\n\n        if (invalidDeviceIds.length > 0) {\n          return res.badRequest(`ä»¥ä¸‹è®¾å¤‡ä¸å­˜åœ¨: ${invalidDeviceIds.join(', ')}`);\n        }\n      }\n\n      // å¤„ç†æ‰¹é‡æ•°æ®\n      const processedRecords = records.map((record) => ({\n        ...record,\n        created_by: req.user.id,\n        created_at: new Date().toISOString(),\n        timestamp: record.timestamp || new Date().toISOString()\n      }));\n\n      const result = await EnergyData.batchCreate(processedRecords);\n\n      this.logOperation(req, 'ENERGY_DATA_BATCH_CREATE', {\n        recordCount: processedRecords.length,\n        deviceIds\n      });\n\n      res.success(\n        {\n          created_count: result.insertedCount,\n          records: result.records\n        },\n        'æ‰¹é‡åˆ›å»ºèƒ½è€—æ•°æ®æˆåŠŸ',\n        201\n      );\n    } catch (error) {\n      logger.error('æ‰¹é‡åˆ›å»ºèƒ½è€—æ•°æ®å¤±è´¥', {\n        error: error.message,\n        recordCount: req.body.records?.length,\n        userId: req.user?.id\n      });\n      res.internalError('æ‰¹é‡åˆ›å»ºèƒ½è€—æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–èƒ½è€—ç»Ÿè®¡æ•°æ®\n   */\n  getEnergyStatistics = this.asyncHandler(async (req, res) => {\n    try {\n      const dateRange = this.getDateRangeParams(req);\n      const { device_id, energy_type, group_by = 'day' } = req.query;\n\n      const filters = {\n        ...dateRange\n      };\n\n      if (device_id) {filters.device_id = device_id;}\n      if (energy_type) {filters.energy_type = energy_type;}\n\n      const statistics = await EnergyData.getStatistics({\n        filters,\n        groupBy: group_by\n      });\n\n      res.success(statistics);\n    } catch (error) {\n      logger.error('è·å–èƒ½è€—ç»Ÿè®¡æ•°æ®å¤±è´¥', {\n        error: error.message,\n        filters: req.query,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–èƒ½è€—ç»Ÿè®¡æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–è®¾å¤‡èƒ½è€—æ’è¡Œ\n   */\n  getDeviceEnergyRanking = this.asyncHandler(async (req, res) => {\n    try {\n      const dateRange = this.getDateRangeParams(req);\n      const { limit = 10, energy_type } = req.query;\n\n      const filters = {\n        ...dateRange\n      };\n\n      if (energy_type) {filters.energy_type = energy_type;}\n\n      const ranking = await EnergyData.getDeviceRanking({\n        filters,\n        limit: parseInt(limit)\n      });\n\n      res.success(ranking);\n    } catch (error) {\n      logger.error('è·å–è®¾å¤‡èƒ½è€—æ’è¡Œå¤±è´¥', {\n        error: error.message,\n        filters: req.query,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–è®¾å¤‡èƒ½è€—æ’è¡Œå¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–èƒ½è€—è¶‹åŠ¿æ•°æ®\n   */\n  getEnergyTrend = this.asyncHandler(async (req, res) => {\n    try {\n      const dateRange = this.getDateRangeParams(req);\n      const { device_id, energy_type, interval = 'hour' } = req.query;\n\n      const filters = {\n        ...dateRange\n      };\n\n      if (device_id) {filters.device_id = device_id;}\n      if (energy_type) {filters.energy_type = energy_type;}\n\n      const trendData = await EnergyData.getTrendData({\n        filters,\n        interval\n      });\n\n      res.success({\n        trend: trendData,\n        interval,\n        time_range: dateRange\n      });\n    } catch (error) {\n      logger.error('è·å–èƒ½è€—è¶‹åŠ¿æ•°æ®å¤±è´¥', {\n        error: error.message,\n        filters: req.query,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–èƒ½è€—è¶‹åŠ¿æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * åˆ é™¤èƒ½è€—æ•°æ®è®°å½•\n   */\n  deleteEnergyData = this.asyncHandler(async (req, res) => {\n    const { id } = req.params;\n\n    try {\n      const energyRecord = await EnergyData.findById(id);\n      if (!energyRecord) {\n        return res.notFound('èƒ½è€—è®°å½•ä¸å­˜åœ¨');\n      }\n\n      await EnergyData.delete(id);\n\n      this.logOperation(req, 'ENERGY_DATA_DELETE', {\n        recordId: id,\n        deviceId: energyRecord.device_id\n      });\n\n      res.success(null, 'èƒ½è€—æ•°æ®åˆ é™¤æˆåŠŸ');\n    } catch (error) {\n      logger.error('åˆ é™¤èƒ½è€—æ•°æ®å¤±è´¥', {\n        error: error.message,\n        recordId: id,\n        userId: req.user?.id\n      });\n      res.internalError('åˆ é™¤èƒ½è€—æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * å¯¼å‡ºèƒ½è€—æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰\n   */\n  exportEnergyData = this.asyncHandler(async (req, res) => {\n    try {\n      const dateRange = this.getDateRangeParams(req);\n      const filters = this.getFilterParams(req, ['device_id', 'energy_type']);\n\n      const queryConditions = {\n        ...filters,\n        ...dateRange\n      };\n\n      const data = await EnergyData.exportToCSV(queryConditions);\n\n      this.logOperation(req, 'ENERGY_DATA_EXPORT', {\n        filters: queryConditions,\n        recordCount: data.recordCount\n      });\n\n      res.downloadFile(data.csvContent, `energy_data_${Date.now()}.csv`, 'text/csv');\n    } catch (error) {\n      logger.error('å¯¼å‡ºèƒ½è€—æ•°æ®å¤±è´¥', {\n        error: error.message,\n        filters: req.query,\n        userId: req.user?.id\n      });\n      res.internalError('å¯¼å‡ºèƒ½è€—æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–èƒ½è€—é¢„æµ‹æ•°æ®\n   */\n  getEnergyPrediction = this.asyncHandler(async (req, res) => {\n    try {\n      const { device_id, prediction_days = 7 } = req.query;\n\n      if (!device_id) {\n        return res.badRequest('è®¾å¤‡IDæ˜¯å¿…éœ€çš„');\n      }\n\n      // éªŒè¯è®¾å¤‡æ˜¯å¦å­˜åœ¨\n      const device = await Device.findById(device_id);\n      if (!device) {\n        return res.badRequest('è®¾å¤‡ä¸å­˜åœ¨');\n      }\n\n      const prediction = await EnergyData.getPrediction({\n        deviceId: device_id,\n        predictionDays: parseInt(prediction_days)\n      });\n\n      res.success({\n        device_id,\n        prediction_days: parseInt(prediction_days),\n        prediction_data: prediction,\n        generated_at: new Date().toISOString()\n      });\n    } catch (error) {\n      logger.error('è·å–èƒ½è€—é¢„æµ‹æ•°æ®å¤±è´¥', {\n        error: error.message,\n        deviceId: req.query.device_id,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–èƒ½è€—é¢„æµ‹æ•°æ®å¤±è´¥');\n    }\n  });\n\n  /**\n   * è·å–å®æ—¶èƒ½è€—æ•°æ®\n   */\n  getRealTimeEnergyData = this.asyncHandler(async (req, res) => {\n    try {\n      const { device_ids } = req.query;\n      const deviceIdArray = device_ids ? device_ids.split(',') : [];\n\n      const realTimeData = await EnergyData.getRealTimeData(deviceIdArray);\n\n      res.success({\n        data: realTimeData,\n        timestamp: new Date().toISOString(),\n        device_count: realTimeData.length\n      });\n    } catch (error) {\n      logger.error('è·å–å®æ—¶èƒ½è€—æ•°æ®å¤±è´¥', {\n        error: error.message,\n        deviceIds: req.query.device_ids,\n        userId: req.user?.id\n      });\n      res.internalError('è·å–å®æ—¶èƒ½è€—æ•°æ®å¤±è´¥');\n    }\n  });\n}\n\nexport default new EnergyController();\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/controllers/MaintenanceController.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":14,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":14,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":53,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":53,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":64,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":64,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":70,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":70,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":82,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":82,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":97,"column":9,"nodeType":"Literal","messageId":"noMagic","endLine":97,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":101,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":101,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":112,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":112,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":126,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":126,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":137,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":137,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":145,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":145,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":170,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":170,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":194,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":194,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":205,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":205,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":209,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":209,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":227,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":227,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":237,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":237,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":258,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":258,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":286,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":286,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":19,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import BaseController from './BaseController.js';\nimport MaintenanceRecord from '../../../domain/entities/MaintenanceRecord.js';\nimport Device from '../../../domain/entities/Device.js';\nimport logger from '../../../utils/logger.js';\n\nclass MaintenanceController extends BaseController {\n  /**\n   * è·å–ç»´æŠ¤è®°å½•åˆ—è¡¨\n   */\n  async getMaintenanceRecords(req, res) {\n    try {\n      const {\n        page = 1,\n        limit = 20,\n        deviceId,\n        maintenanceType,\n        status,\n        startDate,\n        endDate,\n        priority\n      } = req.query;\n\n      const filters = {};\n      if (deviceId) {filters.deviceId = deviceId;}\n      if (maintenanceType) {filters.maintenanceType = maintenanceType;}\n      if (status) {filters.status = status;}\n      if (priority) {filters.priority = priority;}\n      if (startDate || endDate) {\n        filters.scheduledDate = {};\n        if (startDate) {filters.scheduledDate.$gte = new Date(startDate);}\n        if (endDate) {filters.scheduledDate.$lte = new Date(endDate);}\n      }\n\n      const offset = (page - 1) * limit;\n      const maintenanceRecords = await MaintenanceRecord.findWithPagination(\n        filters,\n        offset,\n        parseInt(limit)\n      );\n      const total = await MaintenanceRecord.countDocuments(filters);\n\n      return this.success(res, 'è·å–ç»´æŠ¤è®°å½•æˆåŠŸ', {\n        data: maintenanceRecords,\n        pagination: {\n          page: parseInt(page),\n          limit: parseInt(limit),\n          total,\n          pages: Math.ceil(total / limit)\n        }\n      });\n    } catch (error) {\n      logger.error('è·å–ç»´æŠ¤è®°å½•é”™è¯¯:', error);\n      return this.error(res, 'è·å–ç»´æŠ¤è®°å½•å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–å•ä¸ªç»´æŠ¤è®°å½•\n   */\n  async getMaintenanceRecord(req, res) {\n    try {\n      const maintenanceRecord = await MaintenanceRecord.findByIdWithDevice(req.params.id);\n      if (!maintenanceRecord) {\n        return this.error(res, 'ç»´æŠ¤è®°å½•ä¸å­˜åœ¨', 404);\n      }\n\n      return this.success(res, 'è·å–ç»´æŠ¤è®°å½•æˆåŠŸ', { maintenanceRecord });\n    } catch (error) {\n      logger.error('è·å–ç»´æŠ¤è®°å½•é”™è¯¯:', error);\n      return this.error(res, 'è·å–ç»´æŠ¤è®°å½•å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * åˆ›å»ºç»´æŠ¤è®°å½•\n   */\n  async createMaintenanceRecord(req, res) {\n    try {\n      // éªŒè¯è®¾å¤‡æ˜¯å¦å­˜åœ¨\n      const device = await Device.findById(req.body.deviceId);\n      if (!device) {\n        return this.error(res, 'è®¾å¤‡ä¸å­˜åœ¨', 404);\n      }\n\n      const maintenanceData = {\n        ...req.body,\n        createdBy: req.user.userId,\n        createdAt: new Date()\n      };\n\n      const newMaintenanceRecord = await MaintenanceRecord.create(maintenanceData);\n\n      return this.success(\n        res,\n        'ç»´æŠ¤è®°å½•åˆ›å»ºæˆåŠŸ',\n        { maintenanceRecord: newMaintenanceRecord },\n        201\n      );\n    } catch (error) {\n      logger.error('åˆ›å»ºç»´æŠ¤è®°å½•é”™è¯¯:', error);\n      return this.error(res, 'åˆ›å»ºç»´æŠ¤è®°å½•å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * æ›´æ–°ç»´æŠ¤è®°å½•\n   */\n  async updateMaintenanceRecord(req, res) {\n    try {\n      const maintenanceRecord = await MaintenanceRecord.findById(req.params.id);\n      if (!maintenanceRecord) {\n        return this.error(res, 'ç»´æŠ¤è®°å½•ä¸å­˜åœ¨', 404);\n      }\n\n      const updateData = {\n        ...req.body,\n        updatedBy: req.user.userId,\n        updatedAt: new Date()\n      };\n\n      const updatedRecord = await maintenanceRecord.update(updateData);\n\n      return this.success(res, 'ç»´æŠ¤è®°å½•æ›´æ–°æˆåŠŸ', { maintenanceRecord: updatedRecord });\n    } catch (error) {\n      logger.error('æ›´æ–°ç»´æŠ¤è®°å½•é”™è¯¯:', error);\n      return this.error(res, 'æ›´æ–°ç»´æŠ¤è®°å½•å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * åˆ é™¤ç»´æŠ¤è®°å½•\n   */\n  async deleteMaintenanceRecord(req, res) {\n    try {\n      const maintenanceRecord = await MaintenanceRecord.findById(req.params.id);\n      if (!maintenanceRecord) {\n        return this.error(res, 'ç»´æŠ¤è®°å½•ä¸å­˜åœ¨', 404);\n      }\n\n      await maintenanceRecord.delete();\n\n      return this.success(res, 'ç»´æŠ¤è®°å½•åˆ é™¤æˆåŠŸ');\n    } catch (error) {\n      logger.error('åˆ é™¤ç»´æŠ¤è®°å½•é”™è¯¯:', error);\n      return this.error(res, 'åˆ é™¤ç»´æŠ¤è®°å½•å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–ç»´æŠ¤ç»Ÿè®¡æ•°æ®\n   */\n  async getMaintenanceStats(req, res) {\n    try {\n      const { startDate, endDate, deviceId, maintenanceType } = req.query;\n\n      const filters = {};\n      if (deviceId) {filters.deviceId = deviceId;}\n      if (maintenanceType) {filters.maintenanceType = maintenanceType;}\n      if (startDate || endDate) {\n        filters.scheduledDate = {};\n        if (startDate) {filters.scheduledDate.$gte = new Date(startDate);}\n        if (endDate) {filters.scheduledDate.$lte = new Date(endDate);}\n      }\n\n      const stats = await MaintenanceRecord.getStatistics(filters);\n\n      return this.success(res, 'è·å–ç»´æŠ¤ç»Ÿè®¡æˆåŠŸ', { stats });\n    } catch (error) {\n      logger.error('è·å–ç»´æŠ¤ç»Ÿè®¡é”™è¯¯:', error);\n      return this.error(res, 'è·å–ç»´æŠ¤ç»Ÿè®¡å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–ç»´æŠ¤è®¡åˆ’\n   */\n  async getMaintenanceSchedule(req, res) {\n    try {\n      const { startDate, endDate, deviceId, status = 'scheduled' } = req.query;\n\n      const filters = { status };\n      if (deviceId) {filters.deviceId = deviceId;}\n      if (startDate || endDate) {\n        filters.scheduledDate = {};\n        if (startDate) {filters.scheduledDate.$gte = new Date(startDate);}\n        if (endDate) {filters.scheduledDate.$lte = new Date(endDate);}\n      }\n\n      const schedule = await MaintenanceRecord.findScheduled(filters);\n\n      return this.success(res, 'è·å–ç»´æŠ¤è®¡åˆ’æˆåŠŸ', { schedule });\n    } catch (error) {\n      logger.error('è·å–ç»´æŠ¤è®¡åˆ’é”™è¯¯:', error);\n      return this.error(res, 'è·å–ç»´æŠ¤è®¡åˆ’å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * å®Œæˆç»´æŠ¤ä»»åŠ¡\n   */\n  async completeMaintenance(req, res) {\n    try {\n      const maintenanceRecord = await MaintenanceRecord.findById(req.params.id);\n      if (!maintenanceRecord) {\n        return this.error(res, 'ç»´æŠ¤è®°å½•ä¸å­˜åœ¨', 404);\n      }\n\n      if (maintenanceRecord.status === 'completed') {\n        return this.error(res, 'ç»´æŠ¤ä»»åŠ¡å·²å®Œæˆ', 400);\n      }\n\n      const completionData = {\n        status: 'completed',\n        completedDate: new Date(),\n        completedBy: req.user.userId,\n        notes: req.body.notes || '',\n        actualCost: req.body.actualCost,\n        actualDuration: req.body.actualDuration,\n        updatedAt: new Date()\n      };\n\n      const completedRecord = await maintenanceRecord.update(completionData);\n\n      return this.success(res, 'ç»´æŠ¤ä»»åŠ¡å®Œæˆ', { maintenanceRecord: completedRecord });\n    } catch (error) {\n      logger.error('å®Œæˆç»´æŠ¤ä»»åŠ¡é”™è¯¯:', error);\n      return this.error(res, 'å®Œæˆç»´æŠ¤ä»»åŠ¡å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * è·å–è®¾å¤‡ç»´æŠ¤å†å²\n   */\n  async getDeviceMaintenanceHistory(req, res) {\n    try {\n      const { deviceId } = req.params;\n      const { page = 1, limit = 20, maintenanceType, status } = req.query;\n\n      const filters = { deviceId };\n      if (maintenanceType) {filters.maintenanceType = maintenanceType;}\n      if (status) {filters.status = status;}\n\n      const offset = (page - 1) * limit;\n      const history = await MaintenanceRecord.findWithPagination(filters, offset, parseInt(limit));\n      const total = await MaintenanceRecord.countDocuments(filters);\n\n      return this.success(res, 'è·å–è®¾å¤‡ç»´æŠ¤å†å²æˆåŠŸ', {\n        data: history,\n        pagination: {\n          page: parseInt(page),\n          limit: parseInt(limit),\n          total,\n          pages: Math.ceil(total / limit)\n        }\n      });\n    } catch (error) {\n      logger.error('è·å–è®¾å¤‡ç»´æŠ¤å†å²é”™è¯¯:', error);\n      return this.error(res, 'è·å–è®¾å¤‡ç»´æŠ¤å†å²å¤±è´¥', 500);\n    }\n  }\n\n  /**\n   * å¯¼å‡ºç»´æŠ¤è®°å½•\n   */\n  async exportMaintenanceRecords(req, res) {\n    try {\n      const { startDate, endDate, deviceId, maintenanceType, status } = req.query;\n\n      const filters = {};\n      if (deviceId) {filters.deviceId = deviceId;}\n      if (maintenanceType) {filters.maintenanceType = maintenanceType;}\n      if (status) {filters.status = status;}\n      if (startDate || endDate) {\n        filters.scheduledDate = {};\n        if (startDate) {filters.scheduledDate.$gte = new Date(startDate);}\n        if (endDate) {filters.scheduledDate.$lte = new Date(endDate);}\n      }\n\n      const csvData = await MaintenanceRecord.exportToCSV(filters);\n\n      res.setHeader('Content-Type', 'text/csv');\n      res.setHeader('Content-Disposition', 'attachment; filename=maintenance-records.csv');\n      res.send(csvData);\n    } catch (error) {\n      logger.error('å¯¼å‡ºç»´æŠ¤è®°å½•é”™è¯¯:', error);\n      return this.error(res, 'å¯¼å‡ºç»´æŠ¤è®°å½•å¤±è´¥', 500);\n    }\n  }\n}\n\nexport default new MaintenanceController();\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/deviceController.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":29,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":29,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":52,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":52,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":61,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":61,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":63,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":63,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":79,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":79,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":139,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":139,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":163,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":163,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 501.","line":167,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":167,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":173,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":173,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 501.","line":177,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":177,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":181,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":181,"endColumn":19},{"ruleId":"no-undef","severity":2,"message":"'existingDevice' is not defined.","line":183,"column":15,"nodeType":"Identifier","messageId":"undef","endLine":183,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":200,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":200,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":206,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":206,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":372,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":372,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 501.","line":376,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":376,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":386,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":386,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 501.","line":390,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":390,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":394,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":394,"endColumn":19},{"ruleId":"no-undef","severity":2,"message":"'device' is not defined.","line":396,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":396,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":418,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":418,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":422,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":422,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":427,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":427,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":450,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":450,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":463,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":463,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":465,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":465,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":482,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":482,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":484,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":484,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":508,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":508,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":517,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":517,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":536,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":536,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":544,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":544,"endColumn":19}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":30,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Device from '../../core/entities/Device.js';\nimport StorageDevice from '../../core/entities/storageDevice.js';\nimport { validationResult } from 'express-validator';\nimport db, { dbPromise } from '../../infrastructure/database/index.js';\n\n/**\n * è·å–è®¾å¤‡åˆ—è¡¨ï¼Œæ”¯æŒé€šè¿‡æŸ¥è¯¢å‚æ•°è¿›è¡Œè¿‡æ»¤\n * @param {object} req - Express è¯·æ±‚å¯¹è±¡\n * @param {object} res - Express å“åº”å¯¹è±¡\n * @param {function} next - Express next ä¸­é—´ä»¶å‡½æ•°\n */\nexport const getDevices = async (req, res, next) => {\n  try {\n    const db = await dbPromise;\n    // åŸºç¡€æŸ¥è¯¢è¯­å¥\n    let sql = 'SELECT * FROM devices';\n    const params = [];\n    const conditions = [];\n\n    // (å¯é€‰) è¿™é‡Œå¯ä»¥æ ¹æ® req.query æ·»åŠ è¿‡æ»¤æ¡ä»¶\n    // ä¾‹å¦‚: if (req.query.status) { ... }\n\n    if (conditions.length > 0) {\n      sql += ` WHERE ${conditions.join(' AND ')}`;\n    }\n\n    const devices = await db.raw(sql, params);\n\n    res.status(200).json({\n      message: 'è®¾å¤‡åˆ—è¡¨è·å–æˆåŠŸ',\n      data: devices\n    });\n  } catch (error) {\n    // --- è¿™æ˜¯å…³é”®çš„ä¿®å¤ ---\n    // æˆ‘ä»¬ä¸å†ç›´æ¥å“åº”ï¼Œè€Œæ˜¯è°ƒç”¨ next(error)\n    // å°†é”™è¯¯ä¼ é€’ç»™åœ¨ index.js ä¸­æ³¨å†Œçš„å…¨å±€é”™è¯¯å¤„ç†å™¨è¿›è¡Œè®°å½•ã€‚\n    next(error);\n  }\n};\n\n/**\n * æ ¹æ®IDè·å–è®¾å¤‡\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n */\nexport const getDeviceById = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const device = await Device.findById(id);\n\n    if (!device) {\n      return res.status(404).json({ message: 'è®¾å¤‡ä¸å­˜åœ¨' });\n    }\n\n    // å¦‚æœæ˜¯å‚¨èƒ½è®¾å¤‡ï¼Œè·å–å¯¹åº”çš„å‚¨èƒ½å‚æ•°\n    if (device.type === 'energy_storage') {\n      const storageParams = await StorageDevice.findByDeviceId(device.id);\n      device.storage_params = storageParams;\n    }\n\n    res.status(200).json(device);\n  } catch (error) {\n    res.status(500).json({\n      message: 'è·å–è®¾å¤‡è¯¦æƒ…å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * åˆ›å»ºæ–°è®¾å¤‡\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n */\nexport const createDevice = async (req, res, next) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({ errors: errors.array() });\n    }\n\n    // æå–å¹¶æ¸…æ´—è®¾å¤‡åŸºæœ¬ä¿¡æ¯\n    const {\n      name,\n      type,\n      location,\n      status,\n      manufacturer,\n      model,\n      serial_number,\n      installation_date,\n      last_maintenance_date,\n      notes,\n      energy_storage_params,\n      solar_panel_params,\n      ev_charger_params\n    } = req.body;\n\n    const deviceData = {\n      name: String(name).trim(),\n      type: String(type).trim(),\n      location: String(location).trim(),\n      status: String(status).trim(),\n      manufacturer: String(manufacturer).trim(),\n      model: String(model).trim(),\n      serial_number: String(serial_number).trim(),\n      installation_date: installation_date ? new Date(installation_date).toISOString() : null,\n      last_maintenance_date: last_maintenance_date\n        ? new Date(last_maintenance_date).toISOString()\n        : null,\n      notes: notes ? String(notes).trim() : null\n    };\n\n    const device = await Device.create(deviceData);\n\n    // æ ¹æ®è®¾å¤‡ç±»å‹å¤„ç†ä¸åŒçš„å‚æ•°\n    if (device.type === 'energy_storage' && energy_storage_params) {\n      // éªŒè¯å‚¨èƒ½è®¾å¤‡å‚æ•°\n      const {\n        capacity,\n        efficiency,\n        min_soc,\n        max_soc,\n        charge_rate,\n        discharge_rate,\n        battery_type,\n        cycle_life\n      } = energy_storage_params;\n      if (\n        !capacity ||\n        !efficiency ||\n        !min_soc ||\n        !max_soc ||\n        !charge_rate ||\n        !discharge_rate ||\n        !battery_type ||\n        !cycle_life\n      ) {\n        return res.status(400).json({ message: 'å‚¨èƒ½è®¾å¤‡å‚æ•°ä¸å®Œæ•´' });\n      }\n      const storageParams = {\n        device_id: device.id,\n        capacity: Number(capacity),\n        efficiency: Number(efficiency),\n        min_soc: Number(min_soc),\n        max_soc: Number(max_soc),\n        charge_rate: Number(charge_rate),\n        discharge_rate: Number(discharge_rate),\n        battery_type: String(battery_type).trim(),\n        cycle_life: Number(cycle_life)\n      };\n      await StorageDevice.create(storageParams);\n    } else if (device.type === 'solar_panel' && solar_panel_params) {\n      // éªŒè¯å¤ªé˜³èƒ½æ¿å‚æ•°\n      const {\n        peak_power,\n        efficiency,\n        orientation,\n        tilt_angle,\n        installation_date: spInstallationDate\n      } = solar_panel_params;\n      if (!peak_power || !efficiency || !orientation || !tilt_angle || !spInstallationDate) {\n        return res.status(400).json({ message: 'å¤ªé˜³èƒ½æ¿å‚æ•°ä¸å®Œæ•´' });\n      }\n      // å‡è®¾æœ‰ä¸€ä¸ª SolarPanel æ¨¡å‹\n      // await SolarPanel.create({ device_id: device.id, ...solar_panel_params });\n      res.status(501).json({ message: 'å¤ªé˜³èƒ½æ¿å‚æ•°é…ç½®åŠŸèƒ½å¾…å®ç°' });\n      return;\n    } else if (device.type === 'ev_charger' && ev_charger_params) {\n      // éªŒè¯ç”µåŠ¨æ±½è½¦å……ç”µæ¡©å‚æ•°\n      const { max_power, connector_type, num_ports, charging_standards } = ev_charger_params;\n      if (!max_power || !connector_type || !num_ports || !charging_standards) {\n        return res.status(400).json({ message: 'ç”µåŠ¨æ±½è½¦å……ç”µæ¡©å‚æ•°ä¸å®Œæ•´' });\n      }\n      // å‡è®¾æœ‰ä¸€ä¸ª EvCharger æ¨¡å‹\n      // await EvCharger.create({ device_id: device.id, ...ev_charger_params });\n      res.status(501).json({ message: 'ç”µåŠ¨æ±½è½¦å……ç”µæ¡©å‚æ•°é…ç½®åŠŸèƒ½å¾…å®ç°' });\n      return;\n    }\n\n    res.status(200).json({\n      message: 'è®¾å¤‡æ›´æ–°æˆåŠŸ',\n      device: existingDevice\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * æ›´æ–°è®¾å¤‡ä¿¡æ¯\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n */\nexport const updateDevice = async (req, res, next) => {\n  try {\n    const { id } = req.params;\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({ errors: errors.array() });\n    }\n\n    // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨\n    const existingDevice = await Device.findById(id);\n    if (!existingDevice) {\n      return res.status(404).json({ message: 'è®¾å¤‡ä¸å­˜åœ¨' });\n    }\n\n    // æå–å¹¶æ¸…æ´—è®¾å¤‡åŸºæœ¬ä¿¡æ¯\n    const {\n      name,\n      type,\n      location,\n      status,\n      manufacturer,\n      model,\n      serial_number,\n      installation_date,\n      last_maintenance_date,\n      notes,\n      energy_storage_params,\n      solar_panel_params,\n      ev_charger_params\n    } = req.body;\n\n    const updates = {};\n    if (name !== undefined) {\n      updates.name = String(name).trim();\n    }\n    // å¦‚æœè®¾å¤‡ç±»å‹å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦ç‰¹åˆ«å¤„ç†ï¼Œå¯èƒ½éœ€è¦åˆ é™¤æ—§çš„å‚æ•°è®°å½•å¹¶åˆ›å»ºæ–°çš„\n    if (type !== undefined && type !== existingDevice.type) {\n      updates.type = String(type).trim();\n      // è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥åˆ é™¤æ—§çš„ç‰¹å®šç±»å‹å‚æ•°è®°å½•\n      // ä¾‹å¦‚ï¼šif (existingDevice.type === 'energy_storage') { await StorageDevice.deleteByDeviceId(id); }\n    } else if (type !== undefined) {\n      updates.type = String(type).trim();\n    }\n    if (location !== undefined) {\n      updates.location = String(location).trim();\n    }\n    if (status !== undefined) {\n      updates.status = String(status).trim();\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (manufacturer !== undefined) {\n      updates.manufacturer = String(manufacturer).trim();\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (model !== undefined) {\n      updates.model = String(model).trim();\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (serial_number !== undefined) {\n      updates.serial_number = String(serial_number).trim();\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (installation_date !== undefined) {\n      updates.installation_date = installation_date\n        ? new Date(installation_date).toISOString()\n        : null;\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (last_maintenance_date !== undefined) {\n      updates.last_maintenance_date = last_maintenance_date\n        ? new Date(last_maintenance_date).toISOString()\n        : null;\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (notes !== undefined) {\n      updates.notes = notes ? String(notes).trim() : null;\n    }\n\n    const _updatedDevice = await Device.update(id, updates);\n\n    // æ ¹æ®è®¾å¤‡ç±»å‹å¤„ç†ä¸åŒçš„å‚æ•°æ›´æ–°\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (existingDevice.type === 'energy_storage' && energy_storage_params) {\n      const storageUpdates = {};\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (energy_storage_params.capacity !== undefined) {\n        storageUpdates.capacity = Number(energy_storage_params.capacity);\n      }\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (energy_storage_params.efficiency !== undefined) {\n        storageUpdates.efficiency = Number(energy_storage_params.efficiency);\n      }\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (energy_storage_params.min_soc !== undefined) {\n        storageUpdates.min_soc = Number(energy_storage_params.min_soc);\n      }\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (energy_storage_params.max_soc !== undefined) {\n        storageUpdates.max_soc = Number(energy_storage_params.max_soc);\n      }\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (energy_storage_params.charge_rate !== undefined) {\n        storageUpdates.charge_rate = Number(energy_storage_params.charge_rate);\n      }\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (energy_storage_params.discharge_rate !== undefined) {\n        storageUpdates.discharge_rate = Number(energy_storage_params.discharge_rate);\n      }\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (energy_storage_params.battery_type !== undefined) {\n        storageUpdates.battery_type = String(energy_storage_params.battery_type).trim();\n      }\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (energy_storage_params.cycle_life !== undefined) {\n        storageUpdates.cycle_life = Number(energy_storage_params.cycle_life);\n      }\n\n      await StorageDevice.updateByDeviceId(id, storageUpdates);\n    } else if (existingDevice.type === 'solar_panel' && solar_panel_params) {\n      // éªŒè¯å¤ªé˜³èƒ½æ¿å‚æ•°\n      const {\n        peak_power,\n        efficiency,\n        orientation,\n        tilt_angle,\n        installation_date: spInstallationDate\n      } = solar_panel_params;\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (!peak_power || !efficiency || !orientation || !tilt_angle || !spInstallationDate) {\n        return res.status(400).json({ message: 'å¤ªé˜³èƒ½æ¿å‚æ•°ä¸å®Œæ•´' });\n      }\n      // å‡è®¾æœ‰ä¸€ä¸ª SolarPanel æ¨¡å‹\n      // await SolarPanel.updateByDeviceId(id, solar_panel_params);\n      res.status(501).json({ message: 'å¤ªé˜³èƒ½æ¿å‚æ•°é…ç½®åŠŸèƒ½å¾…å®ç°' });\n      return;\n    } else if (existingDevice.type === 'ev_charger' && ev_charger_params) {\n      // éªŒè¯ç”µåŠ¨æ±½è½¦å……ç”µæ¡©å‚æ•°\n      const { max_power, connector_type, num_ports, charging_standards } = ev_charger_params;\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n      if (!max_power || !connector_type || !num_ports || !charging_standards) {\n        return res.status(400).json({ message: 'ç”µåŠ¨æ±½è½¦å……ç”µæ¡©å‚æ•°ä¸å®Œæ•´' });\n      }\n      // å‡è®¾æœ‰ä¸€ä¸ª EvCharger æ¨¡å‹\n      // await EvCharger.updateByDeviceId(id, ev_charger_params);\n      res.status(501).json({ message: 'ç”µåŠ¨æ±½è½¦å……ç”µæ¡©å‚æ•°é…ç½®åŠŸèƒ½å¾…å®ç°' });\n      return;\n    }\n\n    res.status(201).json({\n      message: 'è®¾å¤‡åˆ›å»ºæˆåŠŸ',\n      device\n    });\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * æ›´æ–°è®¾å¤‡çŠ¶æ€\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n */\nexport const updateDeviceStatus = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { status } = req.body;\n\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (!status) {\n      return res.status(400).json({ message: 'çŠ¶æ€å‚æ•°ä¸èƒ½ä¸ºç©º' });\n    }\n\n    const updatedDevice = await Device.updateStatus(id, status);\n    res.status(200).json({\n      message: 'è®¾å¤‡çŠ¶æ€æ›´æ–°æˆåŠŸ',\n      device: updatedDevice\n    });\n  } catch (error) {\n    res.status(500).json({\n      message: 'æ›´æ–°è®¾å¤‡çŠ¶æ€å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * åˆ é™¤è®¾å¤‡\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n */\nexport const deleteDevice = async (req, res) => {\n  try {\n    const { id } = req.params;\n\n    // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨\n    const existingDevice = await Device.findById(id);\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (!existingDevice) {\n      return res.status(404).json({ message: 'è®¾å¤‡ä¸å­˜åœ¨' });\n    }\n\n    // å¦‚æœæ˜¯å‚¨èƒ½è®¾å¤‡ï¼ŒåŒæ—¶åˆ é™¤å¯¹åº”çš„å‚¨èƒ½å‚æ•°è®°å½•\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (existingDevice.type === 'energy_storage') {\n      await StorageDevice.deleteByDeviceId(id);\n    }\n\n    await Device.delete(id);\n    res.status(200).json({ message: 'è®¾å¤‡åˆ é™¤æˆåŠŸ' });\n  } catch (error) {\n    res.status(500).json({\n      message: 'åˆ é™¤è®¾å¤‡å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * è·å–å‚¨èƒ½è®¾å¤‡åˆ—è¡¨\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n */\nexport const getEnergyStorageDevices = async (req, res) => {\n  try {\n    const devices = await Device.findAll({\n      type: 'energy_storage'\n    });\n    res.status(200).json(devices);\n  } catch (error) {\n    res.status(500).json({\n      message: 'è·å–å‚¨èƒ½è®¾å¤‡åˆ—è¡¨å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * æ›´æ–°å‚¨èƒ½è®¾å¤‡å‚æ•°\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n */\nexport const updateStorageDeviceParams = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { capacity, efficiency, min_soc, max_soc } = req.body;\n\n    // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨\n    const existingDevice = await Device.findById(id);\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (!existingDevice) {\n      return res.status(404).json({ message: 'è®¾å¤‡ä¸å­˜åœ¨' });\n    }\n\n    // æ£€æŸ¥è®¾å¤‡ç±»å‹æ˜¯å¦ä¸ºå‚¨èƒ½è®¾å¤‡\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (existingDevice.type !== 'energy_storage') {\n      return res.status(400).json({ message: 'è¯¥è®¾å¤‡ä¸æ˜¯å‚¨èƒ½è®¾å¤‡' });\n    }\n\n    // æ›´æ–°å‚¨èƒ½è®¾å¤‡ç‰¹å®šå‚æ•°\n    const storageParams = {\n      capacity,\n      efficiency,\n      min_soc,\n      max_soc,\n      updated_at: new Date().toISOString()\n    };\n\n    // è¿™é‡Œå‡è®¾æ•°æ®åº“ä¸­æœ‰ä¸€ä¸ªstorage_devicesè¡¨å­˜å‚¨å‚¨èƒ½è®¾å¤‡å‚æ•°\n    await db('storage_devices').where({ device_id: id }).update(storageParams);\n\n    // è¿”å›æ›´æ–°åçš„å®Œæ•´è®¾å¤‡ä¿¡æ¯\n    const updatedDevice = await Device.findById(id);\n    const deviceParams = await db('storage_devices').where({ device_id: id }).first();\n\n    res.status(200).json({\n      message: 'å‚¨èƒ½è®¾å¤‡å‚æ•°æ›´æ–°æˆåŠŸ',\n      device: {\n        ...updatedDevice,\n        params: deviceParams\n      }\n    });\n  } catch (error) {\n    res.status(500).json({\n      message: 'æ›´æ–°å‚¨èƒ½è®¾å¤‡å‚æ•°å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/index.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":4,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":4,"endColumn":31},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":146,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":146,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3876,3916],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":147,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":147,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3921,4002],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":148,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":148,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4007,4084],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":149,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":149,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4089,4172],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":150,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":150,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4177,4289],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":153,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":153,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4294,4336],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":201,"column":63,"nodeType":"Literal","messageId":"noMagic","endLine":201,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":201,"column":77,"nodeType":"Literal","messageId":"noMagic","endLine":201,"endColumn":78},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":396,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":396,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":430,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":430,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":474,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":474,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":488,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":488,"endColumn":19},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":571,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":571,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14015,14067],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":576,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":576,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14170,14219],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":580,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":580,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[14359,14419],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":586,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":586,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14530,14573],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":590,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":590,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[14615,14665],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":18,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import crypto from 'crypto';\n// å®‰å…¨éšæœºæ•°ç”Ÿæˆå‡½æ•°\nfunction _generateSecureRandom() {\n  return crypto.randomBytes(16).toString('hex');\n}\n\nimport express from 'express';\nimport http from 'http';\nimport https from 'https';\nimport WebSocket from 'ws';\nimport helmet from 'helmet';\nimport rateLimit from 'express-rate-limit';\nimport cors from 'cors';\nimport fs from 'fs';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport { createRequire } from 'module';\nimport { body as _body } from 'express-validator';\n// import session from 'express-session';\n// import connectRedis from 'connect-redis';\n// import csurf from 'csurf';\n\n// å¯¼å…¥é…ç½®ç®¡ç†\nimport config, { isDevelopment } from '../../shared/config/index.js';\n\n// å¯¼å…¥é”™è¯¯å¤„ç†\n// import { setupProcessHandlers } from '../../shared/utils/processHandlers.js';\n\n// å¯¼å…¥ç»Ÿä¸€é”™è¯¯å¤„ç†å’ŒéªŒè¯ä¸­é—´ä»¶\nimport {\n  errorHandler as unifiedErrorHandler,\n  asyncHandler as _asyncHandler,\n  notFoundHandler as unifiedNotFoundHandler\n} from '../../shared/middleware/errorHandler.js';\nimport {\n  sanitizeInput\n} from '../../shared/middleware/validation.js';\nimport { CacheManager } from '../../shared/cache/CacheManager.js';\n\n// å¯¼å…¥å®‰å…¨å’Œæ€§èƒ½ç›‘æ§ä¸­é—´ä»¶\nimport {\n  securityHeaders,\n  inputSizeLimit,\n  requestId\n} from '../../shared/middleware/security.js';\nimport {\n  performanceMiddleware,\n  healthCheckEndpoint,\n  metricsApiEndpoint\n} from '../../shared/middleware/performance.js';\n\n// å¯¼å…¥æ—¥å¿—æ¨¡å—\nimport logger, { requestLogger, auditLogger } from '../../shared/utils/logger.js';\n\n// å¯¼å…¥JWTè®¤è¯\nimport { authenticateToken } from '../../core/services/jwtManager.js';\n\n// å¯¼å…¥Rediså®¢æˆ·ç«¯\n// import redisClient from '../../database/redisClient.js';\n\nconst require = createRequire(import.meta.url);\nconst mqtt = require('mqtt');\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n// å¯¼å…¥æ•°æ®åº“\nimport dbPromise from '../../infrastructure/database/index.js';\n\n// å¯¼å…¥ç¢³æ’æ”¾è®¡ç®—æ¨¡å—\nimport { calculateTotalEmissions } from '../../core/services/emission.js';\n\n// å¯¼å…¥æ•°æ®é‡‡é›†å™¨\nimport DataCollector from '../../core/services/DataCollector.js';\n\n// å¯¼å…¥APIè·¯ç”±\nimport apiRoutes from './routes.js';\n\n// åˆ›å»ºExpressåº”ç”¨\nconst app = express();\n\n// æ ¹æ®é…ç½®åˆ›å»ºHTTPæˆ–HTTPSæœåŠ¡å™¨\nlet server;\nif (config.security?.https?.enabled) {\n  try {\n    const privateKey = fs.readFileSync(config.security.https.keyPath, 'utf8');\n    const certificate = fs.readFileSync(config.security.https.certPath, 'utf8');\n    const credentials = { key: privateKey, cert: certificate };\n    server = https.createServer(credentials, app);\n    logger.info('HTTPSæœåŠ¡å™¨å·²å¯ç”¨');\n  } catch (error) {\n    logger.error('HTTPSé…ç½®é”™è¯¯ï¼Œå°†å›é€€åˆ°HTTP', { error: error.message });\n    server = http.createServer(app);\n  }\n} else {\n  server = http.createServer(app);\n}\n\n// è®¾ç½®è¿›ç¨‹å¼‚å¸¸å¤„ç†\n// setupProcessHandlers();\n\n// åˆå§‹åŒ–æ•°æ®é‡‡é›†å™¨ï¼ˆä½†ä¸ç«‹å³å¯åŠ¨ï¼‰\nconst dataCollector = new DataCollector({\n  brokerUrl: config.mqtt?.brokerUrl || 'mqtt://localhost:1883',\n  username: config.mqtt?.username || '',\n  password: config.mqtt?.password || ''\n});\n\n// åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨\nconst _cacheManager = new CacheManager({\n  type: 'memory', // ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼Œé¿å…Redisä¾èµ–é—®é¢˜\n  defaultTTL: 300, // 5åˆ†é’Ÿé»˜è®¤è¿‡æœŸæ—¶é—´\n  maxSize: 1000 // æœ€å¤§ç¼“å­˜æ¡ç›®æ•°\n});\n\n// ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–å®Œæˆåå†å¯åŠ¨æ•°æ®é‡‡é›†å™¨\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 30 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 30 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 30 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 30 è¡Œ)\n\nserver.listen(config.app.port, config.app.host, () => {\n  const protocol = config.security?.https?.enabled ? 'https' : 'http';\n  logger.info(\n    `æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç›‘å¬ ${protocol}://${config.app.host}:${config.app.port}ï¼Œç­‰å¾…æ•°æ®åº“è¿æ¥...`,\n    {\n      port: config.app.port,\n      host: config.app.host,\n      protocol,\n      environment: config.app.env,\n      nodeVersion: process.version,\n      pid: process.pid\n    }\n  );\n  auditLogger.info('æœåŠ¡å™¨å¯åŠ¨', {\n    action: 'SERVER_START',\n    target: 'Server',\n    details: `æœåŠ¡å™¨å·²åœ¨ ${protocol}://${config.app.host}:${config.app.port} å¯åŠ¨`\n  });\n\n  if (isDevelopment()) {\n    console.log('\\nğŸš€ é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿèƒ½ç¢³ç®¡ç†ç³»ç»Ÿå¯åŠ¨æˆåŠŸ!');\n    console.log(`ğŸ“Š APIæœåŠ¡: ${protocol}://${config.app.host}:${config.app.port}/api`);\n    console.log(`ğŸ’¬ WebSocketæœåŠ¡: ws://${config.app.host}:${config.app.port}/ws`);\n    console.log(`ğŸ’š å¥åº·æ£€æŸ¥: ${protocol}://${config.app.host}:${config.app.port}/health`);\n    console.log(\n      `ğŸ“ˆ æ€§èƒ½ç›‘æ§: ${protocol}://${config.app.host}:${config.app.port}/api/performance/metrics`\n    );\n    console.log(`ğŸ”§ ç¯å¢ƒ: ${config.app.env}\\n`);\n  }\n});\n\ndbPromise\n  .then(() => {\n    logger.info('æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œå¯åŠ¨æ•°æ®é‡‡é›†å™¨');\n    return dataCollector.initialize();\n  })\n  .catch((error) => {\n    logger.error('æ•°æ®åº“è¿æ¥å¤±è´¥', { error: error.message });\n    process.exit(1);\n  });\n\n// ç›‘å¬è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œè®°å½•å®¡è®¡æ—¥å¿—\nprocess.on('exit', (code) => {\n  auditLogger.info('æœåŠ¡å™¨å…³é—­', {\n    action: 'SERVER_SHUTDOWN',\n    target: 'Server',\n    details: `æœåŠ¡å™¨å·²å…³é—­ï¼Œé€€å‡ºç : ${code}`\n  });\n});\n\nprocess.on('SIGINT', () => {\n  logger.info('æ¥æ”¶åˆ° SIGINT ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n  server.close(() => {\n    logger.info('æœåŠ¡å™¨å·²ä¼˜é›…å…³é—­');\n    process.exit(0);\n  });\n});\n\nprocess.on('SIGTERM', () => {\n  logger.info('æ¥æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n  server.close(() => {\n    logger.info('æœåŠ¡å™¨å·²ä¼˜é›…å…³é—­');\n    process.exit(0);\n  });\n});\n\n// è§’è‰²å®šä¹‰\nconst _roles = {\n  ADMIN: 'admin',\n  ENERGY_MANAGER: 'energy_manager',\n  VIEWER: 'viewer'\n};\n\n// å®æ—¶æ•°æ®é‡‡é›†é…ç½®\nconst mqttClient = mqtt.connect(config.mqtt.brokerUrl, {\n  clientId: `${config.mqtt.clientId}-${Math.random().toString(16).substr(2, 8)}`,\n  username: config.mqtt.username,\n  password: config.mqtt.password,\n  clean: true,\n  keepalive: config.mqtt.keepalive,\n  connectTimeout: config.mqtt.connectTimeout,\n  reconnectPeriod: config.mqtt.reconnectPeriod\n});\n\n// è¿æ¥æˆåŠŸå›è°ƒ\nmqttClient.on('connect', () => {\n  logger.info('å·²è¿æ¥åˆ°MQTT Broker', { brokerUrl: config.mqtt.brokerUrl });\n\n  // è®¢é˜…èƒ½æºæ•°æ®ä¸»é¢˜\n  mqttClient.subscribe(config.mqtt.topics.energyData, (err) => {\n    if (err) {\n      logger.error('MQTTèƒ½æºæ•°æ®ä¸»é¢˜è®¢é˜…å¤±è´¥', {\n        error: err.message,\n        topic: config.mqtt.topics.energyData\n      });\n    } else {\n      logger.info('å·²è®¢é˜…MQTTä¸»é¢˜', { topic: config.mqtt.topics.energyData });\n    }\n  });\n});\n\n// MQTTé”™è¯¯å¤„ç†\nmqttClient.on('error', (error) => {\n  logger.error('MQTTè¿æ¥é”™è¯¯', { error: error.message });\n});\n\n// MQTTæ¶ˆæ¯å¤„ç†ç°åœ¨ç”±DataCollectorå¤„ç†\n\n// ä¿¡ä»»ä»£ç†ï¼ˆå¦‚æœåœ¨åå‘ä»£ç†åé¢ï¼‰\napp.set('trust proxy', 1);\n\n// è¯·æ±‚IDä¸­é—´ä»¶ï¼ˆç”¨äºè¯·æ±‚è¿½è¸ªï¼‰\napp.use(requestId());\n\n// å®‰å…¨å¤´ä¸­é—´ä»¶\napp.use(securityHeaders());\n\n// è¾“å…¥å¤§å°é™åˆ¶ä¸­é—´ä»¶\napp.use(inputSizeLimit());\n\n// è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶\napp.use(requestLogger());\n\n// æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 39 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 39 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 39 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 39 è¡Œ)\n\napp.use(performanceMiddleware);\n\n// å®‰å…¨ä¸­é—´ä»¶\nif (config.security.helmet.enabled) {\n  app.use(\n    helmet({\n      contentSecurityPolicy: {\n        directives: {\n          defaultSrc: [\"'self'\"],\n          scriptSrc: [\"'self'\", \"'unsafe-inline'\"],\n          styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n          imgSrc: [\"'self'\", 'data:', 'https:'],\n          fontSrc: [\"'self'\", 'https://fonts.gstatic.com'],\n          connectSrc: [\n            \"'self'\",\n            'https://*.tiles.mapbox.com',\n            'ws://localhost:*',\n            'wss://localhost:*'\n          ],\n          frameSrc: [\"'self'\"],\n          objectSrc: [\"'none'\"],\n          mediaSrc: [\"'self'\"]\n        }\n      },\n      crossOriginResourcePolicy: { policy: 'cross-origin' },\n      crossOriginOpenerPolicy: { policy: 'same-origin' },\n      crossOriginEmbedderPolicy: { policy: 'require-corp' },\n      originAgentCluster: true,\n\n      dnsPrefetchControl: { allow: true },\n      expectCt: { enforce: true, maxAge: 86400 },\n      frameguard: { action: 'deny' },\n      hidePoweredBy: true,\n      hsts: { maxAge: 31536000, includeSubDomains: true, preload: true },\n      ieNoOpen: true,\n      noSniff: true,\n      permittedCrossDomainPolicies: { permittedPolicies: 'none' },\n      referrerPolicy: { policy: 'no-referrer' },\n      xssFilter: true\n    })\n  );\n}\n\n// CORSé…ç½®\nif (config.security.cors.enabled) {\n  app.use(\n    cors({\n      origin:\n        config.security.cors.origin === '*'\n          ? '*'\n          : config.security.cors.origin.split(',').map((s) => s.trim()),\n      methods: config.security.cors.methods.split(',').map((s) => s.trim()),\n      allowedHeaders: config.security.cors.allowedHeaders.split(',').map((s) => s.trim()),\n      exposedHeaders: config.security.cors.exposedHeaders\n        ? config.security.cors.exposedHeaders.split(',').map((s) => s.trim())\n        : [],\n      credentials: config.security.cors.credentials,\n      maxAge: config.security.cors.maxAge\n    })\n  );\n}\n\n// åŸºç¡€ä¸­é—´ä»¶\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n// ä¼šè¯ç®¡ç† - æš‚æ—¶ç¦ç”¨ï¼Œä½¿ç”¨JWTè®¤è¯\n// const RedisStore = connectRedis(session);\n// app.use(\n//   session({\n//     store: new RedisStore({ client: redisClient }),\n//     secret: config.security.session.secret,\n//     resave: false,\n//     saveUninitialized: false,\n//     name: config.security.session.name,\n//     cookie: {\n//       secure: config.security.session.cookie.secure,\n//       httpOnly: config.security.session.cookie.httpOnly,\n//       maxAge: config.security.session.cookie.maxAge,\n//       sameSite: config.security.session.cookie.sameSite,\n//     },\n//   })\n// );\n\n// é€šç”¨è¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…æ´—ä¸­é—´ä»¶\napp.use((req, res, next) => {\n  // å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œè¾“å…¥æ¸…æ´—\n  if (req.body) {\n    req.body = sanitizeInput(req.body);\n  }\n  if (req.query) {\n    req.query = sanitizeInput(req.query);\n  }\n  if (req.params) {\n    req.params = sanitizeInput(req.params);\n  }\n  next();\n});\n\n// CSRFä¿æŠ¤ - æš‚æ—¶ç¦ç”¨ï¼Œéœ€è¦å®‰è£…csurfåŒ…\n// if (config.security.csrf.enabled) {\n//   app.use(csurf({ cookie: true }));\n//   app.use((req, res, next) => {\n//     res.cookie('XSRF-TOKEN', req.csrfToken());\n//     next();\n//   });\n// }\n\n// é…ç½®é€Ÿç‡é™åˆ¶\nif (config.security.rateLimit.enabled) {\n  const limiter = rateLimit({\n    windowMs: config.security.rateLimit.windowMs,\n    max: config.security.rateLimit.max,\n    message: config.security.rateLimit.message,\n    standardHeaders: true,\n    legacyHeaders: false,\n    skip: (req, _res) => req.method === 'OPTIONS'\n  });\n  // åº”ç”¨é€Ÿç‡é™åˆ¶\n  app.use(limiter);\n}\n\n// å¯¼å…¥ç¼“å­˜ä¸­é—´ä»¶\n// import { cacheMiddleware } from './middleware/cache.js';\n\n// åº”ç”¨ç¼“å­˜ä¸­é—´ä»¶åˆ°APIè·¯ç”±\n// app.use('/api', cacheMiddleware()); // å·²ç¦ç”¨ç¼“å­˜ä¸­é—´ä»¶ä»¥è§£å†³Redisé”™è¯¯\n\n// ä½¿ç”¨APIè·¯ç”±\napp.use('/api', apiRoutes);\n\n// å¯åŠ¨ç¢³æ’æ”¾è®¡ç®—æ¨¡å—ç›¸å…³è·¯ç”±\napp.get('/carbon/trend', authenticateToken(['admin', 'energy_manager']), async (req, res) => {\n  const { start_time, end_time, interval } = req.query;\n\n  // å‚æ•°éªŒè¯\n  if (!start_time || !end_time) {\n    return res.status(400).json({\n      error: {\n        code: 'INVALID_PARAMETERS',\n        message: 'ç¼ºå°‘å¿…è¦å‚æ•°: start_time, end_time'\n      }\n    });\n  }\n\n  try {\n    // è®¡ç®—ç¢³æ’æ”¾è¶‹åŠ¿\n    const trendData = calculateTotalEmissions(start_time, end_time, interval);\n\n    logger.info('ç¢³æ’æ”¾è¶‹åŠ¿è®¡ç®—æˆåŠŸ', {\n      userId: req.user.id,\n      timeRange: { start_time, end_time },\n      interval\n    });\n\n    res.json({\n      data: {\n        trend: trendData,\n        unit: 'kgCO2',\n        time_range: {\n          start: start_time,\n          end: end_time\n        }\n      }\n    });\n  } catch (error) {\n    logger.error('ç¢³æ’æ”¾è¶‹åŠ¿è®¡ç®—å¤±è´¥', {\n      error: error.message,\n      userId: req.user?.id,\n      timeRange: { start_time, end_time }\n    });\n    res.status(500).json({\n      error: {\n        code: 'CALCULATION_FAILED',\n        message: 'ç¢³æ’æ”¾è¶‹åŠ¿è®¡ç®—å¤±è´¥',\n        details: error.message\n      }\n    });\n  }\n});\n\n// JWTéªŒè¯ä¸­é—´ä»¶å·²ç§»è‡³APIè·¯ç”±æ¨¡å—\n\n// åŸºç¡€è·¯ç”±\napp.get('/', (req, res) => {\n  res.json({\n    message: 'é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿèƒ½ç¢³ç®¡ç†ç³»ç»Ÿ API v1',\n    version: config.app?.version || '1.0.0',\n    environment: config.app?.env || 'development',\n    status: 'running',\n    data_collector: dataCollector.getConnectionStatus(),\n    timestamp: new Date().toISOString()\n  });\n});\n\n// è¯»å–æµ‹è¯•æ•°æ®\nfunction readTestData(filename) {\n  try {\n    const dataPath = path.join(__dirname, '..', 'test-data', filename);\n    if (fs.existsSync(dataPath)) {\n      return fs.readFileSync(dataPath, 'utf-8');\n    }\n    return null;\n  } catch (error) {\n    logger.error('è¯»å–æµ‹è¯•æ•°æ®å¤±è´¥', { filename, error: error.message });\n    return null;\n  }\n}\n\n// æµ‹è¯•æ•°æ®API\napp.get('/api/test-data/:type', (req, res) => {\n  const { type } = req.params;\n  const allowedTypes = ['energy', 'carbon', 'battery', 'performance'];\n\n  if (!allowedTypes.includes(type)) {\n    return res.status(400).json({\n      error: {\n        code: 'INVALID_TYPE',\n        message: 'ä¸æ”¯æŒçš„æ•°æ®ç±»å‹'\n      }\n    });\n  }\n\n  const data = readTestData(`${type}_data.csv`);\n  if (data) {\n    logger.info('æµ‹è¯•æ•°æ®è®¿é—®', { type, ip: req.ip });\n    res.header('Content-Type', 'text/csv');\n    res.send(data);\n  } else {\n    res.status(500).json({\n      error: {\n        code: 'DATA_READ_ERROR',\n        message: `æ— æ³•è¯»å–${type}æ•°æ®`\n      }\n    });\n  }\n});\n\n// ç³»ç»Ÿå¥åº·æ£€æŸ¥æ¥å£ - ä½¿ç”¨æ–°çš„æ€§èƒ½ç›‘æ§\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\n// TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\napp.get('/health', healthCheckEndpoint);\n\n// æ€§èƒ½æŒ‡æ ‡APIç«¯ç‚¹\napp.get('/api/metrics', metricsApiEndpoint);\n\n// è¯¦ç»†å¥åº·æ£€æŸ¥æ¥å£ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰\napp.get('/health/detailed', (_req, res) => {\n  const healthCheck = {\n    status: 'healthy',\n    components: {\n      database: {\n        status: 'healthy',\n        version: 'SQLite 3.45.0',\n        uptime: '99.9%'\n      },\n      storage: {\n        status: 'healthy',\n        availableSpace: '120GB',\n        usage: '35%'\n      },\n      network: {\n        status: 'healthy',\n        latency: '<5ms'\n      },\n      security: {\n        status: 'healthy',\n        tlsVersion: 'TLS 1.3',\n        certificateExpiry: '2025-12-31'\n      },\n      mqtt: {\n        status: mqttClient ? (mqttClient.connected ? 'connected' : 'disconnected') : 'unavailable',\n        broker: config.mqtt.brokerUrl\n      }\n    },\n    timestamp: new Date().toISOString()\n  };\n\n  res.json(healthCheck);\n});\n\n// è®¾å¤‡ç®¡ç†å’Œèƒ½æºæ•°æ®è·¯ç”±å·²ç§»è‡³APIè·¯ç”±æ¨¡å—\n\n// ç¢³æ’æ”¾è®¡ç®—åŠŸèƒ½å·²ç§»è‡³æ•°æ®é‡‡é›†å™¨å’ŒAPIè·¯ç”±æ¨¡å—\n\n// å‚¨èƒ½ä¼˜åŒ–ã€ç¢³æ’æ”¾è®¡ç®—ã€èƒ½æºé¢„æµ‹å’Œç”¨æˆ·æƒé™ç®¡ç†APIå·²ç§»è‡³APIè·¯ç”±æ¨¡å—\n\n// æ€§èƒ½ç›‘æ§æ¨¡å—å·²åœ¨æ–‡ä»¶å¼€å¤´å¯¼å…¥å’Œé…ç½®\n\n// 404é”™è¯¯å¤„ç†\napp.use(unifiedNotFoundHandler);\n\n// å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶\napp.use(unifiedErrorHandler);\n\n// å¯åŠ¨æ€§èƒ½ç›‘æ§\n// æ€§èƒ½ç›‘æ§å·²é€šè¿‡ä¸­é—´ä»¶å¯ç”¨\n\n// å¯åŠ¨æœåŠ¡\nconst _PORT = config.app.port;\n\n// WebSocket server setup\nconst wss = new WebSocket.Server({ server });\n\nwss.on('connection', (ws) => {\n  console.log('New WebSocket connection established');\n\n  ws.on('message', (message) => {\n    try {\n      const data = JSON.parse(message.toString());\n      console.log('Received WebSocket message:', data);\n      // Handle incoming message\n      ws.send(JSON.stringify({ status: 'received', timestamp: new Date() }));\n    } catch (error) {\n      console.error('Error processing WebSocket message:', error);\n      ws.send(JSON.stringify({ error: 'Invalid message format' }));\n    }\n  });\n\n  ws.on('close', () => {\n    console.log('WebSocket connection closed');\n  });\n\n  ws.on('error', (error) => {\n    console.error('WebSocket error occurred:', error);\n  });\n});\n\n// ä¼˜é›…å…³é—­å¤„ç†\nprocess.on('SIGTERM', () => {\n  logger.info('æ”¶åˆ°SIGTERMä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­');\n  gracefulShutdown();\n});\n\nprocess.on('SIGINT', () => {\n  logger.info('æ”¶åˆ°SIGINTä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­');\n  gracefulShutdown();\n});\n\nfunction gracefulShutdown() {\n  server.close(() => {\n    logger.info('HTTPæœåŠ¡å™¨å·²å…³é—­');\n\n    // å…³é—­MQTTè¿æ¥\n    if (mqttClient.connected) {\n      mqttClient.end(() => {\n        logger.info('MQTTè¿æ¥å·²å…³é—­');\n      });\n    }\n\n    // å…³é—­æ•°æ®åº“è¿æ¥\n    dbPromise.then((db) => {\n      db.close((err) => {\n        if (err) {\n          logger.error('æ•°æ®åº“å…³é—­å¤±è´¥', { error: err.message });\n        } else {\n          logger.info('æ•°æ®åº“è¿æ¥å·²å…³é—­');\n        }\n        process.exit(0);\n      });\n    }).catch(() => {\n      process.exit(0);\n    });\n  });\n}\n\n// å¯¼å‡ºappå®ä¾‹\nexport default app;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/middleware/authMiddleware.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":80,"column":5,"nodeType":"Literal","messageId":"noMagic","endLine":80,"endColumn":7},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":80,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":80,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":80,"column":15,"nodeType":"Literal","messageId":"noMagic","endLine":80,"endColumn":17},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":80,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":80,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":102,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":102,"endColumn":34},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":159,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":159,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3414,3544],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":165,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":165,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3582,3612],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":217,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":217,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4837,4980],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":225,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":225,"endColumn":17,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[5049,5088],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":283,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":283,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6396,6510],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":289,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":289,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6548,6580],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":312,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":312,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7068,7199],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":323,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":323,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7301,7331],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":334,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":334,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":338,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":338,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":338,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":338,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":353,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":353,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 15.","line":353,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":353,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":353,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":353,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":353,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":353,"endColumn":68}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * è®¤è¯ä¸­é—´ä»¶\n * ç”¨äºéªŒè¯JWTä»¤ç‰Œå’Œç”¨æˆ·èº«ä»½\n */\n\nconst jwt = require('jsonwebtoken');\nconst responseFormatter = require('./responseFormatter');\n\n// JWTé…ç½®\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';\nconst JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '24h';\nconst JWT_REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || 'your-refresh-secret-key';\nconst JWT_REFRESH_EXPIRES_IN = process.env.JWT_REFRESH_EXPIRES_IN || '7d';\n\n// ä»¤ç‰Œé»‘åå•ï¼ˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”ä½¿ç”¨Redisç­‰å¤–éƒ¨å­˜å‚¨ï¼‰\nconst tokenBlacklist = new Set();\n\n/**\n * ç”Ÿæˆè®¿é—®ä»¤ç‰Œ\n * @param {Object} payload - ä»¤ç‰Œè½½è·\n * @returns {string} JWTä»¤ç‰Œ\n */\nfunction generateAccessToken(payload) {\n  return jwt.sign(payload, JWT_SECRET, {\n    expiresIn: JWT_EXPIRES_IN,\n    issuer: 'carbon-management-system',\n    audience: 'carbon-management-client'\n  });\n}\n\n/**\n * ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œ\n * @param {Object} payload - ä»¤ç‰Œè½½è·\n * @returns {string} JWTåˆ·æ–°ä»¤ç‰Œ\n */\nfunction generateRefreshToken(payload) {\n  return jwt.sign(payload, JWT_REFRESH_SECRET, {\n    expiresIn: JWT_REFRESH_EXPIRES_IN,\n    issuer: 'carbon-management-system',\n    audience: 'carbon-management-client'\n  });\n}\n\n/**\n * éªŒè¯è®¿é—®ä»¤ç‰Œ\n * @param {string} token - JWTä»¤ç‰Œ\n * @returns {Object} è§£ç åçš„è½½è·\n */\nfunction verifyAccessToken(token) {\n  return jwt.verify(token, JWT_SECRET, {\n    issuer: 'carbon-management-system',\n    audience: 'carbon-management-client'\n  });\n}\n\n/**\n * éªŒè¯åˆ·æ–°ä»¤ç‰Œ\n * @param {string} token - JWTåˆ·æ–°ä»¤ç‰Œ\n * @returns {Object} è§£ç åçš„è½½è·\n */\nfunction verifyRefreshToken(token) {\n  return jwt.verify(token, JWT_REFRESH_SECRET, {\n    issuer: 'carbon-management-system',\n    audience: 'carbon-management-client'\n  });\n}\n\n/**\n * å°†ä»¤ç‰ŒåŠ å…¥é»‘åå•\n * @param {string} token - è¦åŠ å…¥é»‘åå•çš„ä»¤ç‰Œ\n */\nfunction blacklistToken(token) {\n  tokenBlacklist.add(token);\n\n  // å®šæœŸæ¸…ç†è¿‡æœŸçš„ä»¤ç‰Œï¼ˆç®€å•å®ç°ï¼Œç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨æ›´é«˜æ•ˆçš„æ–¹æ³•ï¼‰\n  setTimeout(\n    () => {\n      tokenBlacklist.delete(token);\n    },\n    24 * 60 * 60 * 1000\n  ); // 24å°æ—¶åæ¸…ç†\n}\n\n/**\n * æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­\n * @param {string} token - è¦æ£€æŸ¥çš„ä»¤ç‰Œ\n * @returns {boolean} æ˜¯å¦åœ¨é»‘åå•ä¸­\n */\nfunction isTokenBlacklisted(token) {\n  return tokenBlacklist.has(token);\n}\n\n/**\n * ä»è¯·æ±‚ä¸­æå–ä»¤ç‰Œ\n * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n * @returns {string|null} æå–çš„ä»¤ç‰Œ\n */\nfunction extractToken(req) {\n  // ä»Authorizationå¤´ä¸­æå–\n  const authHeader = req.headers.authorization;\n  if (authHeader && authHeader.startsWith('Bearer ')) {\n    return authHeader.substring(7);\n  }\n\n  // ä»æŸ¥è¯¢å‚æ•°ä¸­æå–\n  if (req.query.token) {\n    return req.query.token;\n  }\n\n  // ä»Cookieä¸­æå–\n  if (req.cookies && req.cookies.accessToken) {\n    return req.cookies.accessToken;\n  }\n\n  return null;\n}\n\n/**\n * è®¤è¯ä¸­é—´ä»¶\n * éªŒè¯ç”¨æˆ·èº«ä»½å¹¶å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡\n */\nfunction authenticate(req, res, next) {\n  try {\n    const token = extractToken(req);\n\n    if (!token) {\n      return responseFormatter.unauthorized(res, 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ');\n    }\n\n    // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­\n    if (isTokenBlacklisted(token)) {\n      return responseFormatter.unauthorized(res, 'ä»¤ç‰Œå·²å¤±æ•ˆ');\n    }\n\n    // éªŒè¯ä»¤ç‰Œ\n    const decoded = verifyAccessToken(token);\n\n    // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åŒ…å«å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯\n    if (!decoded.userId || !decoded.username || !decoded.role) {\n      return responseFormatter.unauthorized(res, 'ä»¤ç‰Œæ ¼å¼æ— æ•ˆ');\n    }\n\n    // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡\n    req.user = {\n      userId: decoded.userId,\n      username: decoded.username,\n      email: decoded.email,\n      role: decoded.role,\n      permissions: decoded.permissions || [],\n      tokenId: decoded.jti, // JWT ID\n      issuedAt: decoded.iat,\n      expiresAt: decoded.exp\n    };\n\n    // å°†åŸå§‹ä»¤ç‰Œä¹Ÿé™„åŠ åˆ°è¯·æ±‚å¯¹è±¡ï¼ˆç”¨äºæ³¨é”€ç­‰æ“ä½œï¼‰\n    req.token = token;\n\n    // è®°å½•è®¤è¯æ—¥å¿—\n    console.log(\n      `[${new Date().toISOString()}] Authentication: User ${decoded.username} (${decoded.role}) authenticated`\n    );\n\n    next();\n  } catch (error) {\n    console.error('è®¤è¯é”™è¯¯:', error);\n\n    if (error.name === 'TokenExpiredError') {\n      return responseFormatter.unauthorized(res, 'ä»¤ç‰Œå·²è¿‡æœŸ');\n    } else if (error.name === 'JsonWebTokenError') {\n      return responseFormatter.unauthorized(res, 'ä»¤ç‰Œæ— æ•ˆ');\n    } else if (error.name === 'NotBeforeError') {\n      return responseFormatter.unauthorized(res, 'ä»¤ç‰Œå°šæœªç”Ÿæ•ˆ');\n    } \n    return responseFormatter.internalError(res, 'è®¤è¯å¤±è´¥', error);\n    \n  }\n}\n\n/**\n * å¯é€‰è®¤è¯ä¸­é—´ä»¶\n * å¦‚æœæä¾›äº†ä»¤ç‰Œåˆ™éªŒè¯ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œ\n */\nfunction optionalAuthenticate(req, res, next) {\n  try {\n    const token = extractToken(req);\n\n    if (!token) {\n      // æ²¡æœ‰ä»¤ç‰Œï¼Œç»§ç»­æ‰§è¡Œä½†ä¸è®¾ç½®ç”¨æˆ·ä¿¡æ¯\n      return next();\n    }\n\n    // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­\n    if (isTokenBlacklisted(token)) {\n      // ä»¤ç‰Œåœ¨é»‘åå•ä¸­ï¼Œç»§ç»­æ‰§è¡Œä½†ä¸è®¾ç½®ç”¨æˆ·ä¿¡æ¯\n      return next();\n    }\n\n    // éªŒè¯ä»¤ç‰Œ\n    const decoded = verifyAccessToken(token);\n\n    // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åŒ…å«å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯\n    if (decoded.userId && decoded.username && decoded.role) {\n      // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡\n      req.user = {\n        userId: decoded.userId,\n        username: decoded.username,\n        email: decoded.email,\n        role: decoded.role,\n        permissions: decoded.permissions || [],\n        tokenId: decoded.jti,\n        issuedAt: decoded.iat,\n        expiresAt: decoded.exp\n      };\n\n      req.token = token;\n\n      console.log(\n        `[${new Date().toISOString()}] Optional Authentication: User ${decoded.username} (${decoded.role}) authenticated`\n      );\n    }\n\n    next();\n  } catch (error) {\n    // å¯é€‰è®¤è¯å¤±è´¥æ—¶ä¸è¿”å›é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ\n    console.warn('å¯é€‰è®¤è¯å¤±è´¥:', error.message);\n    next();\n  }\n}\n\n/**\n * åˆ·æ–°ä»¤ç‰Œä¸­é—´ä»¶\n * éªŒè¯åˆ·æ–°ä»¤ç‰Œå¹¶ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ\n */\nfunction refreshToken(req, res, next) {\n  try {\n    const refreshToken = req.body.refreshToken || req.cookies.refreshToken;\n\n    if (!refreshToken) {\n      return responseFormatter.unauthorized(res, 'ç¼ºå°‘åˆ·æ–°ä»¤ç‰Œ');\n    }\n\n    // éªŒè¯åˆ·æ–°ä»¤ç‰Œ\n    const decoded = verifyRefreshToken(refreshToken);\n\n    // æ£€æŸ¥åˆ·æ–°ä»¤ç‰Œæ˜¯å¦åŒ…å«å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯\n    if (!decoded.userId || !decoded.username || !decoded.role) {\n      return responseFormatter.unauthorized(res, 'åˆ·æ–°ä»¤ç‰Œæ ¼å¼æ— æ•ˆ');\n    }\n\n    // ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ\n    const newAccessToken = generateAccessToken({\n      userId: decoded.userId,\n      username: decoded.username,\n      email: decoded.email,\n      role: decoded.role,\n      permissions: decoded.permissions\n    });\n\n    // å¯é€‰ï¼šç”Ÿæˆæ–°çš„åˆ·æ–°ä»¤ç‰Œï¼ˆæ»šåŠ¨åˆ·æ–°ï¼‰\n    const newRefreshToken = generateRefreshToken({\n      userId: decoded.userId,\n      username: decoded.username,\n      email: decoded.email,\n      role: decoded.role\n    });\n\n    // å°†æ–°ä»¤ç‰Œé™„åŠ åˆ°å“åº”å¯¹è±¡\n    res.locals.newTokens = {\n      accessToken: newAccessToken,\n      refreshToken: newRefreshToken,\n      expiresIn: JWT_EXPIRES_IN\n    };\n\n    // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡\n    req.user = {\n      userId: decoded.userId,\n      username: decoded.username,\n      email: decoded.email,\n      role: decoded.role,\n      permissions: decoded.permissions || []\n    };\n\n    console.log(\n      `[${new Date().toISOString()}] Token Refresh: User ${decoded.username} tokens refreshed`\n    );\n\n    next();\n  } catch (error) {\n    console.error('ä»¤ç‰Œåˆ·æ–°é”™è¯¯:', error);\n\n    if (error.name === 'TokenExpiredError') {\n      return responseFormatter.unauthorized(res, 'åˆ·æ–°ä»¤ç‰Œå·²è¿‡æœŸ');\n    } else if (error.name === 'JsonWebTokenError') {\n      return responseFormatter.unauthorized(res, 'åˆ·æ–°ä»¤ç‰Œæ— æ•ˆ');\n    } \n    return responseFormatter.internalError(res, 'ä»¤ç‰Œåˆ·æ–°å¤±è´¥', error);\n    \n  }\n}\n\n/**\n * æ³¨é”€ä¸­é—´ä»¶\n * å°†å½“å‰ä»¤ç‰ŒåŠ å…¥é»‘åå•\n */\nfunction logout(req, res, next) {\n  try {\n    const token = extractToken(req);\n\n    if (token) {\n      // å°†ä»¤ç‰ŒåŠ å…¥é»‘åå•\n      blacklistToken(token);\n      console.log(\n        `[${new Date().toISOString()}] Logout: Token blacklisted for user ${req.user?.username || 'unknown'}`\n      );\n    }\n\n    // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯\n    req.user = null;\n    req.token = null;\n\n    next();\n  } catch (error) {\n    console.error('æ³¨é”€é”™è¯¯:', error);\n    return responseFormatter.internalError(res, 'æ³¨é”€å¤±è´¥', error);\n  }\n}\n\n/**\n * æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæœŸä¸­é—´ä»¶\n * å¦‚æœä»¤ç‰Œå³å°†è¿‡æœŸï¼Œåœ¨å“åº”å¤´ä¸­æ·»åŠ æç¤º\n */\nfunction checkTokenExpiry(req, res, next) {\n  if (req.user && req.user.expiresAt) {\n    const now = Math.floor(Date.now() / 1000);\n    const timeToExpiry = req.user.expiresAt - now;\n\n    // å¦‚æœä»¤ç‰Œåœ¨30åˆ†é’Ÿå†…è¿‡æœŸï¼Œæ·»åŠ è­¦å‘Šå¤´\n    if (timeToExpiry < 30 * 60) {\n      res.set('X-Token-Warning', 'Token expires soon');\n      res.set('X-Token-Expires-In', timeToExpiry.toString());\n    }\n  }\n\n  next();\n}\n\n/**\n * é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶ï¼ˆåŸºäºç”¨æˆ·ï¼‰\n * @param {number} maxRequests - æœ€å¤§è¯·æ±‚æ•°\n * @param {number} windowMs - æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰\n * @returns {Function} Expressä¸­é—´ä»¶å‡½æ•°\n */\nfunction userRateLimit(maxRequests = 100, windowMs = 15 * 60 * 1000) {\n  const userRequests = new Map();\n\n  return (req, res, next) => {\n    const userId = req.user?.userId || req.ip;\n    const now = Date.now();\n\n    if (!userRequests.has(userId)) {\n      userRequests.set(userId, { count: 1, resetTime: now + windowMs });\n      return next();\n    }\n\n    const userRequest = userRequests.get(userId);\n\n    if (now > userRequest.resetTime) {\n      // é‡ç½®è®¡æ•°å™¨\n      userRequest.count = 1;\n      userRequest.resetTime = now + windowMs;\n      return next();\n    }\n\n    if (userRequest.count >= maxRequests) {\n      return responseFormatter.tooManyRequests(res, 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');\n    }\n\n    userRequest.count++;\n    next();\n  };\n}\n\nmodule.exports = {\n  authenticate,\n  optionalAuthenticate,\n  refreshToken,\n  logout,\n  checkTokenExpiry,\n  userRateLimit,\n  generateAccessToken,\n  generateRefreshToken,\n  verifyAccessToken,\n  verifyRefreshToken,\n  blacklistToken,\n  isTokenBlacklisted,\n  extractToken\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/middleware/cache.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":36,"column":29,"nodeType":"MemberExpression","messageId":"unexpected","endLine":36,"endColumn":42},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":43,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":43,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1082,1113],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":58,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":58,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1374,1404],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import cache from '../../../shared/config/cache.js';\nimport redisClient from '../../../database/redisClient.js';\nconst { setAsync, expireAsync, DEFAULT_TTL } = cache;\n\n/**\n * ç¼“å­˜ä¸­é—´ä»¶ - ç”¨äºç¼“å­˜GETè¯·æ±‚çš„å“åº”ç»“æœ\n * @param {number} ttl - ç¼“å­˜è¿‡æœŸæ—¶é—´(ç§’)\n */\nconst cacheMiddleware =\n  (ttl = DEFAULT_TTL) =>\n    async (req, res, next) => {\n    // åªç¼“å­˜GETè¯·æ±‚\n      if (req.method !== 'GET') {\n        return next();\n      }\n\n      // ç”Ÿæˆå”¯ä¸€ç¼“å­˜é”®\n      const cacheKey = `api:${req.originalUrl}`;\n\n      try {\n      // å°è¯•ä»ç¼“å­˜è·å–æ•°æ®\n        const cachedData = await redisClient.get(cacheKey);\n\n        if (cachedData) {\n        // è¿”å›ç¼“å­˜æ•°æ®\n          const data = JSON.parse(cachedData);\n          return res.json(data);\n        }\n\n        // é‡å†™res.jsonæ–¹æ³•\n        const originalJson = res.json;\n        res.json = function (body) {\n        // ç¼“å­˜å“åº”æ•°æ®\n          setAsync(cacheKey, JSON.stringify(body))\n            .then(() => expireAsync(cacheKey, ttl))\n            .catch((err) => console.error('ç¼“å­˜è®¾ç½®å¤±è´¥:', err));\n\n          return originalJson.call(this, body);\n        };\n\n        next();\n      } catch (err) {\n        console.error('ç¼“å­˜ä¸­é—´ä»¶é”™è¯¯:', err);\n        next();\n      }\n    };\nexport { cacheMiddleware, clearCacheMiddleware };\n\n/**\n * æ¸…é™¤ç¼“å­˜çš„ä¸­é—´ä»¶\n * @param {string} pattern - ç¼“å­˜é”®åŒ¹é…æ¨¡å¼\n */\nconst clearCacheMiddleware = () => async (req, res, next) => {\n  try {\n    // å®ç°ç¼“å­˜æ¸…é™¤é€»è¾‘\n    next();\n  } catch (err) {\n    console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', err);\n    next();\n  }\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/middleware/cacheMiddleware.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":18,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":18,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":112,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":112,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":117,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":117,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":126,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":126,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":129,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":129,"endColumn":64}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import cacheService from '../../../core/services/cacheService.js';\nimport logger from '../../../shared/utils/logger.js';\n\n/**\n * APIå“åº”ç¼“å­˜ä¸­é—´ä»¶\n * ç”¨äºç¼“å­˜APIæ¥å£çš„å“åº”ç»“æœï¼Œå‡å°‘é‡å¤è®¡ç®—å’Œæ•°æ®åº“æŸ¥è¯¢\n */\nclass CacheMiddleware {\n  /**\n   * åˆ›å»ºç¼“å­˜ä¸­é—´ä»¶\n   * @param {Object} options - ç¼“å­˜é€‰é¡¹\n   * @param {number} options.ttl - ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\n   * @param {Function} [options.keyGenerator] - è‡ªå®šä¹‰ç¼“å­˜é”®ç”Ÿæˆå‡½æ•°\n   * @param {Function} [options.shouldCache] - åˆ¤æ–­æ˜¯å¦ç¼“å­˜å“åº”çš„å‡½æ•°\n   * @returns {Function} - Expressä¸­é—´ä»¶\n   */\n  static createCacheMiddleware(options = {}) {\n    const { ttl = 300, keyGenerator, shouldCache } = options;\n\n    return (req, res, next) => {\n      // åªç¼“å­˜GETè¯·æ±‚\n      if (req.method !== 'GET') {\n        return next();\n      }\n\n      // ç”Ÿæˆç¼“å­˜é”®\n      const cacheKey = keyGenerator ? keyGenerator(req) : CacheMiddleware.defaultKeyGenerator(req);\n\n      try {\n        // å°è¯•ä»ç¼“å­˜è·å–æ•°æ®\n        const cachedData = cacheService.get(cacheKey);\n\n        if (cachedData) {\n          logger.debug(`ç¼“å­˜å‘½ä¸­: ${cacheKey}`);\n          return res.json(cachedData);\n        }\n\n        // é‡å†™res.jsonæ–¹æ³•ä»¥ç¼“å­˜å“åº”\n        const originalJson = res.json;\n        res.json = function (body) {\n          // åˆ¤æ–­æ˜¯å¦åº”è¯¥ç¼“å­˜\n          if (!shouldCache || shouldCache(req, res, body)) {\n            cacheService.set(cacheKey, body, ttl);\n            logger.debug(`ç¼“å­˜è®¾ç½®æˆåŠŸ: ${cacheKey}, TTL: ${ttl}ç§’`);\n          }\n          return originalJson.call(this, body);\n        };\n\n        next();\n      } catch (error) {\n        logger.error(`ç¼“å­˜ä¸­é—´ä»¶é”™è¯¯: ${cacheKey}`, error);\n        next(); // ç¼“å­˜å‡ºé”™æ—¶ç»§ç»­è¯·æ±‚å¤„ç†ï¼Œä¸å½±å“æ­£å¸¸ä¸šåŠ¡\n      }\n    };\n  }\n\n  /**\n   * é»˜è®¤ç¼“å­˜é”®ç”Ÿæˆå™¨\n   * @param {Object} req - Expressè¯·æ±‚å¯¹è±¡\n   * @returns {string} - ç¼“å­˜é”®\n   */\n  static defaultKeyGenerator(req) {\n    // åŒ…å«æŸ¥è¯¢å‚æ•°çš„å®Œæ•´URLä½œä¸ºç¼“å­˜é”®\n    const queryString = new URLSearchParams(req.query).toString();\n    return `${req.originalUrl}${queryString ? `?${queryString}` : ''}`;\n  }\n\n  /**\n   * åˆ›å»ºç¼“å­˜æ¸…é™¤ä¸­é—´ä»¶\n   * ç”¨äºåœ¨æ•°æ®æ›´æ–°æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜\n   * @param {Function} keyPatternGenerator - ç”Ÿæˆç¼“å­˜é”®æ¨¡å¼çš„å‡½æ•°\n   * @returns {Function} - Expressä¸­é—´ä»¶\n   */\n  static createCacheInvalidator(keyPatternGenerator) {\n    return async (req, res, next) => {\n      try {\n        // å…ˆæ‰§è¡Œåç»­ä¸­é—´ä»¶\n        await new Promise((resolve, reject) => {\n          res.on('finish', resolve);\n          res.on('error', reject);\n          next();\n        });\n\n        // ç”Ÿæˆç¼“å­˜é”®æ¨¡å¼å¹¶æ¸…é™¤åŒ¹é…çš„ç¼“å­˜\n        const keyPattern = keyPatternGenerator(req, res);\n        if (keyPattern) {\n          const stats = cacheService.getStats();\n          const keys = stats && stats.keys ? stats.keys : [];\n          const matchedKeys = keys.filter((key) => key.includes(keyPattern));\n\n          if (matchedKeys.length > 0) {\n            const count = cacheService.delMulti(matchedKeys);\n            logger.debug(`ç¼“å­˜æ¸…é™¤æˆåŠŸ: æ¨¡å¼=${keyPattern}, æ•°é‡=${count}`);\n          }\n        }\n      } catch (error) {\n        logger.error('ç¼“å­˜æ¸…é™¤ä¸­é—´ä»¶é”™è¯¯', error);\n        // ç¼“å­˜æ¸…é™¤å¤±è´¥ä¸å½±å“ä¸»æµç¨‹\n      }\n    };\n  }\n\n  /**\n   * å¸¸ç”¨ç¼“å­˜åœºæ™¯çš„å¿«æ·æ–¹æ³•\n   */\n\n  /**\n   * è®¾å¤‡æ•°æ®ç¼“å­˜ä¸­é—´ä»¶\n   * @param {number} [ttl=60] - ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰\n   * @returns {Function} - Expressä¸­é—´ä»¶\n   */\n  static deviceDataCache(ttl = 60) {\n    return CacheMiddleware.createCacheMiddleware({\n      ttl,\n      shouldCache: (req, _res, body) =>\n        // åªç¼“å­˜æˆåŠŸå“åº”\n        _res.statusCode === 200 && body && body.success !== false\n    });\n  }\n\n  /**\n   * èƒ½æºç»Ÿè®¡æ•°æ®ç¼“å­˜ä¸­é—´ä»¶\n   * @param {number} [ttl=300] - ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰\n   * @returns {Function} - Expressä¸­é—´ä»¶\n   */\n  static energyStatsCache(ttl = 300) {\n    return CacheMiddleware.createCacheMiddleware({\n      ttl,\n      shouldCache: (req, _res, body) => _res.statusCode === 200 && body && body.success !== false\n    });\n  }\n\n  /**\n   * æ¸…é™¤è®¾å¤‡æ•°æ®ç¼“å­˜çš„ä¸­é—´ä»¶\n   * @returns {Function} - Expressä¸­é—´ä»¶\n   */\n  static invalidateDeviceCache() {\n    return CacheMiddleware.createCacheInvalidator((req, _) => {\n      // ä»è¯·æ±‚å‚æ•°ä¸­è·å–è®¾å¤‡ID\n      const deviceId = req.params.id || req.body.deviceId;\n      return deviceId ? `device/${deviceId}` : null;\n    });\n  }\n\n  /**\n   * æ¸…é™¤èƒ½æºç»Ÿè®¡ç¼“å­˜çš„ä¸­é—´ä»¶\n   * @returns {Function} - Expressä¸­é—´ä»¶\n   */\n  static invalidateEnergyStatsCache() {\n    return CacheMiddleware.createCacheInvalidator(() => 'energy/stats');\n  }\n}\n\nexport default CacheMiddleware;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/middleware/httpErrorHandler.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":29,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":29,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":38,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":38,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":47,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":47,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":56,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":56,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":65,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":65,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 502.","line":74,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":74,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":165,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":165,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":167,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":167,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":169,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":169,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":171,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":171,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 429.","line":173,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":173,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":175,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":175,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 502.","line":177,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":177,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 503.","line":179,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":179,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 504.","line":181,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":181,"endColumn":13},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":210,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":210,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4491,4521],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":211,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":211,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4526,4554],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":217,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":217,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4666,4706],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":218,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":218,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4711,4746],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":221,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":221,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4824,4852],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":228,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":228,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4946,4987],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":21,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å—\n * æä¾›æ ‡å‡†åŒ–çš„é”™è¯¯ç±»å’Œé”™è¯¯å¤„ç†ä¸­é—´ä»¶\n */\n\nimport { logger } from './logger.js';\n\n/**\n * åº”ç”¨ç¨‹åºé”™è¯¯ç±»\n * ç»§æ‰¿è‡ªErrorï¼Œæ·»åŠ çŠ¶æ€ç å’Œé”™è¯¯ä»£ç \n */\nexport class AppError extends Error {\n  constructor(message, statusCode, errorCode, details = {}) {\n    super(message);\n    this.statusCode = statusCode;\n    this.errorCode = errorCode;\n    this.details = details;\n    this.isOperational = true;\n    this.timestamp = new Date().toISOString();\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\n/**\n * éªŒè¯é”™è¯¯ç±»\n */\nexport class ValidationError extends AppError {\n  constructor(message, details) {\n    super(message, 400, 'VALIDATION_ERROR', details);\n  }\n}\n\n/**\n * è®¤è¯é”™è¯¯ç±»\n */\nexport class AuthenticationError extends AppError {\n  constructor(message = 'è®¤è¯å¤±è´¥') {\n    super(message, 401, 'AUTHENTICATION_ERROR');\n  }\n}\n\n/**\n * æˆæƒé”™è¯¯ç±»\n */\nexport class AuthorizationError extends AppError {\n  constructor(message = 'æƒé™ä¸è¶³') {\n    super(message, 403, 'AUTHORIZATION_ERROR');\n  }\n}\n\n/**\n * èµ„æºæœªæ‰¾åˆ°é”™è¯¯ç±»\n */\nexport class NotFoundError extends AppError {\n  constructor(resource = 'èµ„æº') {\n    super(`${resource}æœªæ‰¾åˆ°`, 404, 'NOT_FOUND');\n  }\n}\n\n/**\n * æ•°æ®åº“é”™è¯¯ç±»\n */\nexport class DatabaseError extends AppError {\n  constructor(message, details) {\n    super(message, 500, 'DATABASE_ERROR', details);\n  }\n}\n\n/**\n * å¤–éƒ¨æœåŠ¡é”™è¯¯ç±»\n */\nexport class ExternalServiceError extends AppError {\n  constructor(service, message = 'å¤–éƒ¨æœåŠ¡è°ƒç”¨å¤±è´¥') {\n    super(`${service}: ${message}`, 502, 'EXTERNAL_SERVICE_ERROR');\n    this.service = service;\n  }\n}\n\n/**\n * é”™è¯¯å¤„ç†ä¸­é—´ä»¶\n * ç»Ÿä¸€å¤„ç†åº”ç”¨ç¨‹åºä¸­çš„é”™è¯¯\n */\nexport const errorHandler = (err, req, res, _next) => {\n  let error = { ...err };\n  error.message = err.message;\n\n  // è®°å½•é”™è¯¯æ—¥å¿—\n  // ç»“æ„åŒ–é”™è¯¯æ—¥å¿—\n  logger.error('API Error', {\n    errorCode: error.errorCode || 'UNKNOWN_ERROR',\n    message: error.message,\n    details: error.details,\n    url: req.url,\n    method: req.method,\n    ip: req.ip,\n    userAgent: req.get('User-Agent'),\n    stack: error.stack\n  });\n\n  // å¤„ç†ç‰¹å®šç±»å‹çš„é”™è¯¯\n  if (err.name === 'ValidationError') {\n    error = new ValidationError(err.message);\n  } else if (err.name === 'JsonWebTokenError') {\n    error = new AuthenticationError('æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ');\n  } else if (err.name === 'TokenExpiredError') {\n    error = new AuthenticationError('è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ');\n  } else if (err.code === 'SQLITE_CONSTRAINT') {\n    error = new ValidationError('æ•°æ®çº¦æŸè¿å');\n  } else if (err.code === 'ENOTFOUND') {\n    error = new ExternalServiceError('DNS', 'åŸŸåè§£æå¤±è´¥');\n  } else if (err.code === 'ECONNREFUSED') {\n    error = new ExternalServiceError('Network', 'è¿æ¥è¢«æ‹’ç»');\n  }\n\n  // è®¾ç½®é»˜è®¤é”™è¯¯ä¿¡æ¯\n  if (!error.statusCode) {\n    error.statusCode = 500;\n  }\n  if (!error.errorCode) {\n    error.errorCode = 'INTERNAL_SERVER_ERROR';\n  }\n\n  // æ„å»ºå“åº”\n  const response = {\n    success: false,\n    error: {\n      code: error.errorCode,\n      message:\n        process.env.NODE_ENV === 'production'\n          ? getProductionMessage(error.statusCode)\n          : error.message,\n      timestamp: new Date().toISOString(),\n      ...(process.env.NODE_ENV !== 'production' && { details: error.details })\n    }\n  };\n\n  // åœ¨å¼€å‘ç¯å¢ƒä¸­åŒ…å«å †æ ˆè·Ÿè¸ª\n  if (process.env.NODE_ENV === 'development') {\n    response.error.stack = error.stack;\n  }\n\n  // å¦‚æœæ˜¯éªŒè¯é”™è¯¯ï¼ŒåŒ…å«å­—æ®µä¿¡æ¯\n  if (error instanceof ValidationError && error.field) {\n    response.error.field = error.field;\n  }\n\n  res.status(error.statusCode).json(response);\n};\n\n/**\n * æ ¹æ®çŠ¶æ€ç è·å–ç”Ÿäº§ç¯å¢ƒä¸‹çš„é”™è¯¯æ¶ˆæ¯\n * @param {number} statusCode HTTPçŠ¶æ€ç \n * @returns {string} é”™è¯¯æ¶ˆæ¯\n */\nconst getProductionMessage = (statusCode) => {\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 22 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 22 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 22 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 22 è¡Œ)\n\n  switch (statusCode) {\n    case 400:\n      return 'è¯·æ±‚å‚æ•°æ— æ•ˆæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚';\n    case 401:\n      return 'è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„å‡­æ®ã€‚';\n    case 403:\n      return 'æ‚¨æ²¡æœ‰æ‰§è¡Œæ­¤æ“ä½œçš„æƒé™ã€‚';\n    case 404:\n      return 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨ã€‚';\n    case 429:\n      return 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚';\n    case 500:\n      return 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚';\n    case 502:\n      return 'ç½‘å…³é”™è¯¯æˆ–ä¸Šæ¸¸æœåŠ¡æ— å“åº”ã€‚';\n    case 503:\n      return 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚';\n    case 504:\n      return 'ç½‘å…³è¶…æ—¶ã€‚';\n    default:\n      return 'å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚';\n  }\n};\n\n/**\n * å¼‚æ­¥é”™è¯¯åŒ…è£…å™¨\n * è‡ªåŠ¨æ•è·å¼‚æ­¥å‡½æ•°ä¸­çš„é”™è¯¯å¹¶ä¼ é€’ç»™é”™è¯¯å¤„ç†ä¸­é—´ä»¶\n */\nexport const asyncHandler = (fn) => (req, res, next) => {\n  Promise.resolve(fn(req, res, next)).catch(next);\n};\n\n/**\n * 404é”™è¯¯å¤„ç†ä¸­é—´ä»¶\n */\nexport const notFoundHandler = (req, res, next) => {\n  const error = new NotFoundError(`è·¯ç”± ${req.originalUrl}`);\n  next(error);\n};\n\n/**\n * è¿›ç¨‹å¼‚å¸¸å¤„ç†\n */\nexport const setupProcessHandlers = () => {\n  // å¤„ç†æœªæ•è·çš„å¼‚å¸¸\n  process.on('uncaughtException', (err) => {\n    console.error('æœªæ•è·çš„å¼‚å¸¸:', err);\n    console.error('åº”ç”¨ç¨‹åºå°†é€€å‡º...');\n    process.exit(1);\n  });\n\n  // å¤„ç†æœªå¤„ç†çš„Promiseæ‹’ç»\n  process.on('unhandledRejection', (reason, promise) => {\n    console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);\n    console.error('Promise:', promise);\n    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½éœ€è¦é€€å‡ºè¿›ç¨‹\n    if (process.env.NODE_ENV === 'production') {\n      console.error('åº”ç”¨ç¨‹åºå°†é€€å‡º...');\n      process.exit(1);\n    }\n  });\n\n  // ä¼˜é›…å…³é—­å¤„ç†\n  const gracefulShutdown = (signal) => {\n    console.log(`æ”¶åˆ° ${signal} ä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...`);\n    // è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘ï¼Œå¦‚å…³é—­æ•°æ®åº“è¿æ¥ã€åœæ­¢å®šæ—¶å™¨ç­‰\n    process.exit(0);\n  };\n\n  process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));\n  process.on('SIGINT', () => gracefulShutdown('SIGINT'));\n};\n\nexport default {\n  AppError,\n  ValidationError,\n  AuthenticationError,\n  AuthorizationError,\n  NotFoundError,\n  DatabaseError,\n  ExternalServiceError,\n  errorHandler,\n  asyncHandler,\n  notFoundHandler,\n  setupProcessHandlers\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/middleware/performance.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":71,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":71,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1745,1783],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":75,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":75,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1840,1875],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":120,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":120,"endColumn":28},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":149,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":149,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3454,3486],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":154,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":154,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3549,3583],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":167,"column":92,"nodeType":"Literal","messageId":"noMagic","endLine":167,"endColumn":95},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":175,"column":79,"nodeType":"Literal","messageId":"noMagic","endLine":175,"endColumn":82},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":182,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":182,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":182,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":182,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":193,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":193,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":193,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":193,"endColumn":57},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":218,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":218,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5495,5527],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":220,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":220,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5551,5592],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":230,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":230,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5872,5910],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":232,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":232,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5934,5980],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":265,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":265,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 80.","line":267,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":267,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":271,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":271,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":273,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":273,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":283,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":283,"endColumn":67},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":303,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":303,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8133,8167],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":306,"column":9,"nodeType":"Literal","messageId":"noMagic","endLine":306,"endColumn":10},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":306,"column":13,"nodeType":"Literal","messageId":"noMagic","endLine":306,"endColumn":15},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":306,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":306,"endColumn":22},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":314,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":314,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8354,8386],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":315,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":315,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8399,8443],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":316,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":316,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8456,8506],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":317,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":317,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8519,8564],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":318,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":318,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8577,8613],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":320,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":320,"endColumn":26,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8654,8690],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":323,"column":9,"nodeType":"Literal","messageId":"noMagic","endLine":323,"endColumn":11},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":323,"column":14,"nodeType":"Literal","messageId":"noMagic","endLine":323,"endColumn":16},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":323,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":323,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":325,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":325,"endColumn":10},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":325,"column":13,"nodeType":"Literal","messageId":"noMagic","endLine":325,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":35,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import path from 'path';\nimport fs from 'fs';\n\n/**\n * æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶\n * ç”¨äºè·Ÿè¸ªAPIå“åº”æ—¶é—´ã€ç¼“å­˜å‘½ä¸­ç‡ç­‰æ€§èƒ½æŒ‡æ ‡\n */\nclass PerformanceMonitor {\n  constructor() {\n    this.metrics = {\n      requests: 0,\n      totalResponseTime: 0,\n      cacheHits: 0,\n      cacheMisses: 0,\n      endpoints: new Map()\n    };\n\n    this.logFile = path.join(process.cwd(), 'logs', 'performance.log');\n    this.reportFile = path.join(process.cwd(), 'test-results', 'performance_monitor.csv');\n\n    // ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨\n    this.ensureLogDirectory();\n\n    // å®šæœŸç”Ÿæˆæ€§èƒ½æŠ¥å‘Š\n    this.startPeriodicReporting();\n  }\n\n  ensureLogDirectory() {\n    const logDir = path.dirname(this.logFile);\n    const reportDir = path.dirname(this.reportFile);\n\n    if (!fs.existsSync(logDir)) {\n      fs.mkdirSync(logDir, { recursive: true });\n    }\n\n    if (!fs.existsSync(reportDir)) {\n      fs.mkdirSync(reportDir, { recursive: true });\n    }\n  }\n\n  /**\n   * åˆ›å»ºæ€§èƒ½ç›‘æ§ä¸­é—´ä»¶\n   */\n  middleware() {\n    return (req, res, next) => {\n      try {\n        const startTime = Date.now();\n        // ä¿®å¤ï¼šå®‰å…¨åœ°è·å–è·¯å¾„ï¼Œé¿å…æœªå®šä¹‰é”™è¯¯\n        let endpoint = req.path;\n        try {\n          endpoint = `${req.method} ${req.route?.path || req.path}`;\n        } catch (e) {\n          // å¦‚æœè·å–route.pathå¤±è´¥ï¼Œä½¿ç”¨req.path\n          endpoint = `${req.method} ${req.path}`;\n        }\n\n        // è®°å½•è¯·æ±‚å¼€å§‹\n        this.recordRequestStart(endpoint);\n\n        // ç›‘å¬å“åº”ç»“æŸ\n        res.on('finish', () => {\n          try {\n            const responseTime = Date.now() - startTime;\n            const cacheHit = res.getHeader('X-Cache-Hit') === 'true';\n\n            // ä½¿ç”¨process.nextTickå»¶è¿Ÿè®°å½•ï¼Œé¿å…é˜»å¡å“åº”\n            process.nextTick(() => {\n              this.recordRequestEnd(endpoint, responseTime, cacheHit, res.statusCode);\n            });\n          } catch (error) {\n            console.error('æ€§èƒ½ç›‘æ§è®°å½•å“åº”ç»“æŸå¤±è´¥:', error);\n          }\n        });\n      } catch (error) {\n        console.error('æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶é”™è¯¯:', error);\n      }\n\n      // æ— è®ºå¦‚ä½•éƒ½ç»§ç»­å¤„ç†è¯·æ±‚\n      next();\n    };\n  }\n\n  /**\n   * è®°å½•è¯·æ±‚å¼€å§‹\n   */\n  recordRequestStart(endpoint) {\n    this.metrics.requests++;\n\n    if (!this.metrics.endpoints.has(endpoint)) {\n      this.metrics.endpoints.set(endpoint, {\n        requests: 0,\n        totalTime: 0,\n        cacheHits: 0,\n        cacheMisses: 0,\n        errors: 0\n      });\n    }\n\n    this.metrics.endpoints.get(endpoint).requests++;\n  }\n\n  /**\n   * è®°å½•è¯·æ±‚ç»“æŸ\n   */\n  recordRequestEnd(endpoint, responseTime, cacheHit, statusCode) {\n    this.metrics.totalResponseTime += responseTime;\n\n    const endpointMetrics = this.metrics.endpoints.get(endpoint);\n    if (endpointMetrics) {\n      endpointMetrics.totalTime += responseTime;\n\n      if (cacheHit) {\n        this.metrics.cacheHits++;\n        endpointMetrics.cacheHits++;\n      } else {\n        this.metrics.cacheMisses++;\n        endpointMetrics.cacheMisses++;\n      }\n\n      if (statusCode >= 400) {\n        endpointMetrics.errors++;\n      }\n    }\n\n    // è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶\n    this.logPerformanceData(endpoint, responseTime, cacheHit, statusCode);\n  }\n\n  /**\n   * è®°å½•æ€§èƒ½æ•°æ®åˆ°æ—¥å¿—æ–‡ä»¶\n   */\n  logPerformanceData(endpoint, responseTime, cacheHit, statusCode) {\n    try {\n      const logEntry = {\n        timestamp: new Date().toISOString(),\n        endpoint,\n        responseTime,\n        cacheHit,\n        statusCode\n      };\n\n      const logLine = `${JSON.stringify(logEntry)}\\n`;\n\n      // ä½¿ç”¨å¼‚æ­¥æ–‡ä»¶æ“ä½œï¼Œé¿å…é˜»å¡è¯·æ±‚\n      // ä½¿ç”¨setImmediateè¿›ä¸€æ­¥å»¶è¿Ÿæ—¥å¿—å†™å…¥ï¼Œç¡®ä¿ä¸å½±å“è¯·æ±‚å¤„ç†\n      setImmediate(() => {\n        fs.appendFile(this.logFile, logLine, (err) => {\n          if (err) {\n            console.error('å†™å…¥æ€§èƒ½æ—¥å¿—å¤±è´¥:', err);\n          }\n        });\n      });\n    } catch (error) {\n      console.error('è®°å½•æ€§èƒ½æ•°æ®å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * è·å–æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯\n   */\n  getStats() {\n    const avgResponseTime =\n      this.metrics.requests > 0 ? this.metrics.totalResponseTime / this.metrics.requests : 0;\n\n    const cacheHitRate =\n      this.metrics.cacheHits + this.metrics.cacheMisses > 0\n        ? (this.metrics.cacheHits / (this.metrics.cacheHits + this.metrics.cacheMisses)) * 100\n        : 0;\n\n    const endpointStats = [];\n    for (const [endpoint, metrics] of this.metrics.endpoints) {\n      const avgTime = metrics.requests > 0 ? metrics.totalTime / metrics.requests : 0;\n      const hitRate =\n        metrics.cacheHits + metrics.cacheMisses > 0\n          ? (metrics.cacheHits / (metrics.cacheHits + metrics.cacheMisses)) * 100\n          : 0;\n\n      endpointStats.push({\n        endpoint,\n        requests: metrics.requests,\n        avgResponseTime: Math.round(avgTime),\n        cacheHitRate: Math.round(hitRate * 100) / 100,\n        errors: metrics.errors\n      });\n    }\n\n    // æŒ‰è¯·æ±‚æ•°æ’åº\n    endpointStats.sort((a, b) => b.requests - a.requests);\n\n    return {\n      totalRequests: this.metrics.requests,\n      avgResponseTime: Math.round(avgResponseTime),\n      cacheHitRate: Math.round(cacheHitRate * 100) / 100,\n      totalCacheHits: this.metrics.cacheHits,\n      totalCacheMisses: this.metrics.cacheMisses,\n      endpoints: endpointStats\n    };\n  }\n\n  /**\n   * ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š\n   */\n  generateReport() {\n    const stats = this.getStats();\n    const timestamp = new Date().toISOString();\n\n    // ç”ŸæˆCSVæ ¼å¼çš„æŠ¥å‘Š\n    const csvHeader = 'timestamp,endpoint,requests,avg_response_time,cache_hit_rate,errors\\n';\n    let csvContent = csvHeader;\n\n    for (const endpoint of stats.endpoints) {\n      csvContent += `${timestamp},\"${endpoint.endpoint}\",${endpoint.requests},${endpoint.avgResponseTime},${endpoint.cacheHitRate},${endpoint.errors}\\n`;\n    }\n\n    // å†™å…¥CSVæ–‡ä»¶\n    fs.writeFile(this.reportFile, csvContent, (err) => {\n      if (err) {\n        console.error('ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šå¤±è´¥:', err);\n      } else {\n        console.log('æ€§èƒ½æŠ¥å‘Šå·²ç”Ÿæˆ:', this.reportFile);\n      }\n    });\n\n    // ç”ŸæˆMarkdownæ ¼å¼çš„æŠ¥å‘Š\n    const markdownReport = this.generateMarkdownReport(stats);\n    const markdownFile = path.join(process.cwd(), 'test-results', 'performance_report.md');\n\n    fs.writeFile(markdownFile, markdownReport, (err) => {\n      if (err) {\n        console.error('ç”ŸæˆMarkdownæŠ¥å‘Šå¤±è´¥:', err);\n      } else {\n        console.log('Markdownæ€§èƒ½æŠ¥å‘Šå·²ç”Ÿæˆ:', markdownFile);\n      }\n    });\n\n    return stats;\n  }\n\n  /**\n   * ç”ŸæˆMarkdownæ ¼å¼çš„æ€§èƒ½æŠ¥å‘Š\n   */\n  generateMarkdownReport(stats) {\n    const timestamp = new Date().toLocaleString('zh-CN');\n\n    let markdown = '# ç³»ç»Ÿæ€§èƒ½ç›‘æ§æŠ¥å‘Š\\n\\n';\n    markdown += `**ç”Ÿæˆæ—¶é—´:** ${timestamp}\\n\\n`;\n\n    markdown += '## æ€»ä½“æ€§èƒ½æŒ‡æ ‡\\n\\n';\n    markdown += `- **æ€»è¯·æ±‚æ•°:** ${stats.totalRequests}\\n`;\n    markdown += `- **å¹³å‡å“åº”æ—¶é—´:** ${stats.avgResponseTime}ms\\n`;\n    markdown += `- **ç¼“å­˜å‘½ä¸­ç‡:** ${stats.cacheHitRate}%\\n`;\n    markdown += `- **ç¼“å­˜å‘½ä¸­æ¬¡æ•°:** ${stats.totalCacheHits}\\n`;\n    markdown += `- **ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°:** ${stats.totalCacheMisses}\\n\\n`;\n\n    markdown += '## æ¥å£æ€§èƒ½è¯¦æƒ…\\n\\n';\n    markdown += '| æ¥å£ | è¯·æ±‚æ•° | å¹³å‡å“åº”æ—¶é—´(ms) | ç¼“å­˜å‘½ä¸­ç‡(%) | é”™è¯¯æ•° |\\n';\n    markdown += '|------|--------|------------------|---------------|--------|\\n';\n\n    for (const endpoint of stats.endpoints) {\n      markdown += `| ${endpoint.endpoint} | ${endpoint.requests} | ${endpoint.avgResponseTime} | ${endpoint.cacheHitRate} | ${endpoint.errors} |\\n`;\n    }\n\n    markdown += '\\n## æ€§èƒ½ä¼˜åŒ–å»ºè®®\\n\\n';\n\n    if (stats.cacheHitRate < 50) {\n      markdown += `- âš ï¸ ç¼“å­˜å‘½ä¸­ç‡è¾ƒä½(${stats.cacheHitRate}%)ï¼Œå»ºè®®æ£€æŸ¥ç¼“å­˜ç­–ç•¥\\n`;\n    } else if (stats.cacheHitRate > 80) {\n      markdown += `- âœ… ç¼“å­˜å‘½ä¸­ç‡è‰¯å¥½(${stats.cacheHitRate}%)\\n`;\n    }\n\n    if (stats.avgResponseTime > 1000) {\n      markdown += `- âš ï¸ å¹³å‡å“åº”æ—¶é—´è¾ƒé•¿(${stats.avgResponseTime}ms)ï¼Œå»ºè®®ä¼˜åŒ–æŸ¥è¯¢æˆ–å¢åŠ ç¼“å­˜\\n`;\n    } else if (stats.avgResponseTime < 200) {\n      markdown += `- âœ… å“åº”æ—¶é—´è¡¨ç°è‰¯å¥½(${stats.avgResponseTime}ms)\\n`;\n    }\n\n    // æ‰¾å‡ºå“åº”æ—¶é—´æœ€é•¿çš„æ¥å£\n    if (stats.endpoints && stats.endpoints.length > 0) {\n      const slowestEndpoint = stats.endpoints.reduce((prev, current) =>\n        prev.avgResponseTime > current.avgResponseTime ? prev : current\n      );\n\n      if (slowestEndpoint && slowestEndpoint.avgResponseTime > 500) {\n        markdown += `- âš ï¸ æœ€æ…¢æ¥å£: ${slowestEndpoint.endpoint} (${slowestEndpoint.avgResponseTime}ms)ï¼Œå»ºè®®ä¼˜åŒ–\\n`;\n      }\n    }\n\n    return markdown;\n  }\n\n  /**\n   * å¼€å§‹å®šæœŸæŠ¥å‘Š\n   */\n  startPeriodicReporting() {\n    // å»¶è¿Ÿå¯åŠ¨æŠ¥å‘Šç”Ÿæˆï¼Œé¿å…åœ¨åº”ç”¨å¯åŠ¨æ—¶å°±å¼€å§‹ç”ŸæˆæŠ¥å‘Š\n    setTimeout(() => {\n      // æ¯5åˆ†é’Ÿç”Ÿæˆä¸€æ¬¡æŠ¥å‘Š\n      setInterval(\n        () => {\n          try {\n            this.generateReport();\n          } catch (error) {\n            console.error('ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šå¤±è´¥:', error);\n          }\n        },\n        5 * 60 * 1000\n      );\n\n      // æ¯å°æ—¶è¾“å‡ºä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯åˆ°æ§åˆ¶å°\n      setInterval(\n        () => {\n          try {\n            const stats = this.getStats();\n            console.log('\\n=== æ€§èƒ½ç›‘æ§ç»Ÿè®¡ ===');\n            console.log(`æ€»è¯·æ±‚æ•°: ${stats.totalRequests}`);\n            console.log(`å¹³å‡å“åº”æ—¶é—´: ${stats.avgResponseTime}ms`);\n            console.log(`ç¼“å­˜å‘½ä¸­ç‡: ${stats.cacheHitRate}%`);\n            console.log('==================\\n');\n          } catch (error) {\n            console.error('è¾“å‡ºæ€§èƒ½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);\n          }\n        },\n        60 * 60 * 1000\n      );\n    }, 60 * 1000); // å»¶è¿Ÿ1åˆ†é’Ÿå¯åŠ¨\n  }\n\n  /**\n   * é‡ç½®ç»Ÿè®¡æ•°æ®\n   */\n  reset() {\n    this.metrics = {\n      requests: 0,\n      totalResponseTime: 0,\n      cacheHits: 0,\n      cacheMisses: 0,\n      endpoints: new Map()\n    };\n  }\n}\n\n// åˆ›å»ºå…¨å±€æ€§èƒ½ç›‘æ§å®ä¾‹\nconst performanceMonitor = new PerformanceMonitor();\n\nexport { performanceMonitor, performanceMonitor as default };\n\nexport const performanceMiddleware = performanceMonitor.middleware.bind(performanceMonitor);\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/middleware/responseFormatter.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":14,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":14,"endColumn":70},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":36,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":36,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":49,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":49,"endColumn":26},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":50,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":50,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1032,1156],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":76,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":76,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":84,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":84,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":99,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":99,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":108,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":108,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":117,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":117,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":126,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":126,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 409.","line":135,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":135,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":144,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":144,"endColumn":66},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 429.","line":146,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":146,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":166,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":166,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":177,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":177,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":177,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":177,"endColumn":60},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":214,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":214,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5214,5252],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3600.","line":228,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":228,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":261,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":271,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":271,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":294,"column":76,"nodeType":"Literal","messageId":"noMagic","endLine":294,"endColumn":80},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 503.","line":297,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":297,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":22,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * å“åº”æ ¼å¼åŒ–ä¸­é—´ä»¶\n * æä¾›ç»Ÿä¸€çš„APIå“åº”æ ¼å¼\n */\n\nclass ResponseFormatter {\n  /**\n   * æˆåŠŸå“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - å“åº”æ¶ˆæ¯\n   * @param {*} data - å“åº”æ•°æ®\n   * @param {number} statusCode - HTTPçŠ¶æ€ç \n   */\n  static success(res, message = 'æ“ä½œæˆåŠŸ', data = null, statusCode = 200) {\n    const response = {\n      success: true,\n      message,\n      timestamp: new Date().toISOString(),\n      statusCode\n    };\n\n    if (data !== null) {\n      response.data = data;\n    }\n\n    return res.status(statusCode).json(response);\n  }\n\n  /**\n   * é”™è¯¯å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   * @param {number} statusCode - HTTPçŠ¶æ€ç \n   * @param {*} errors - è¯¦ç»†é”™è¯¯ä¿¡æ¯\n   */\n  static error(res, message = 'æ“ä½œå¤±è´¥', statusCode = 500, errors = null) {\n    const response = {\n      success: false,\n      message,\n      timestamp: new Date().toISOString(),\n      statusCode\n    };\n\n    if (errors !== null) {\n      response.errors = errors;\n    }\n\n    // è®°å½•é”™è¯¯æ—¥å¿—\n    if (statusCode >= 500) {\n      console.error(`[${new Date().toISOString()}] Server Error:`, {\n        message,\n        statusCode,\n        errors\n      });\n    }\n\n    return res.status(statusCode).json(response);\n  }\n\n  /**\n   * åˆ†é¡µå“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - å“åº”æ¶ˆæ¯\n   * @param {Array} data - æ•°æ®æ•°ç»„\n   * @param {Object} pagination - åˆ†é¡µä¿¡æ¯\n   */\n  static paginated(res, message = 'è·å–æ•°æ®æˆåŠŸ', data = [], pagination = {}) {\n    const response = {\n      success: true,\n      message,\n      timestamp: new Date().toISOString(),\n      statusCode: 200,\n      data,\n      pagination: {\n        page: pagination.page || 1,\n        limit: pagination.limit || 20,\n        total: pagination.total || 0,\n        pages: pagination.pages || 0,\n        hasNext: pagination.hasNext || false,\n        hasPrev: pagination.hasPrev || false\n      }\n    };\n\n    return res.status(200).json(response);\n  }\n\n  /**\n   * éªŒè¯é”™è¯¯å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {Array} validationErrors - éªŒè¯é”™è¯¯æ•°ç»„\n   */\n  static validationError(res, validationErrors) {\n    const formattedErrors = validationErrors.map((error) => ({\n      field: error.param || error.path,\n      message: error.msg || error.message,\n      value: error.value\n    }));\n\n    return this.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, formattedErrors);\n  }\n\n  /**\n   * æœªæˆæƒå“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   */\n  static unauthorized(res, message = 'æœªæˆæƒè®¿é—®') {\n    return this.error(res, message, 401);\n  }\n\n  /**\n   * ç¦æ­¢è®¿é—®å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   */\n  static forbidden(res, message = 'ç¦æ­¢è®¿é—®') {\n    return this.error(res, message, 403);\n  }\n\n  /**\n   * èµ„æºä¸å­˜åœ¨å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   */\n  static notFound(res, message = 'èµ„æºä¸å­˜åœ¨') {\n    return this.error(res, message, 404);\n  }\n\n  /**\n   * å†²çªå“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   */\n  static conflict(res, message = 'èµ„æºå†²çª') {\n    return this.error(res, message, 409);\n  }\n\n  /**\n   * è¯·æ±‚è¿‡äºé¢‘ç¹å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   * @param {number} retryAfter - é‡è¯•ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰\n   */\n  static tooManyRequests(res, message = 'è¯·æ±‚è¿‡äºé¢‘ç¹', retryAfter = 60) {\n    res.setHeader('Retry-After', retryAfter);\n    return this.error(res, message, 429);\n  }\n\n  /**\n   * æœåŠ¡å™¨å†…éƒ¨é”™è¯¯å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - é”™è¯¯æ¶ˆæ¯\n   * @param {Error} error - é”™è¯¯å¯¹è±¡\n   */\n  static internalError(res, message = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯', error = null) {\n    // åœ¨å¼€å‘ç¯å¢ƒä¸­åŒ…å«é”™è¯¯å †æ ˆ\n    const isDevelopment = process.env.NODE_ENV === 'development';\n    const errorDetails =\n      isDevelopment && error\n        ? {\n          stack: error.stack,\n          name: error.name\n        }\n        : null;\n\n    return this.error(res, message, 500, errorDetails);\n  }\n\n  /**\n   * è‡ªå®šä¹‰çŠ¶æ€ç å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {number} statusCode - HTTPçŠ¶æ€ç \n   * @param {string} message - å“åº”æ¶ˆæ¯\n   * @param {*} data - å“åº”æ•°æ®\n   */\n  static custom(res, statusCode, message, data = null) {\n    const isSuccess = statusCode >= 200 && statusCode < 300;\n\n    if (isSuccess) {\n      return this.success(res, message, data, statusCode);\n    } \n    return this.error(res, message, statusCode, data);\n    \n  }\n\n  /**\n   * æ–‡ä»¶ä¸‹è½½å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {Buffer|string} fileData - æ–‡ä»¶æ•°æ®\n   * @param {string} filename - æ–‡ä»¶å\n   * @param {string} contentType - å†…å®¹ç±»å‹\n   */\n  static fileDownload(res, fileData, filename, contentType = 'application/octet-stream') {\n    res.setHeader('Content-Type', contentType);\n    res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n    res.setHeader('Content-Length', Buffer.byteLength(fileData));\n\n    return res.send(fileData);\n  }\n\n  /**\n   * æµå¼å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {Stream} stream - æ•°æ®æµ\n   * @param {string} contentType - å†…å®¹ç±»å‹\n   */\n  static stream(res, stream, contentType = 'application/octet-stream') {\n    res.setHeader('Content-Type', contentType);\n    res.setHeader('Transfer-Encoding', 'chunked');\n\n    stream.pipe(res);\n\n    stream.on('error', (error) => {\n      console.error('Stream error:', error);\n      if (!res.headersSent) {\n        this.internalError(res, 'æ•°æ®æµä¼ è¾“é”™è¯¯', error);\n      }\n    });\n  }\n\n  /**\n   * ç¼“å­˜å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - å“åº”æ¶ˆæ¯\n   * @param {*} data - å“åº”æ•°æ®\n   * @param {number} maxAge - ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰\n   */\n  static cached(res, message, data, maxAge = 3600) {\n    res.setHeader('Cache-Control', `public, max-age=${maxAge}`);\n    res.setHeader('ETag', this._generateETag(data));\n\n    return this.success(res, message, data);\n  }\n\n  /**\n   * ç”ŸæˆETag\n   * @param {*} data - æ•°æ®\n   * @returns {string} ETagå€¼\n   * @private\n   */\n  static _generateETag(data) {\n    const crypto = require('crypto');\n    const content = typeof data === 'string' ? data : JSON.stringify(data);\n    return crypto.createHash('md5').update(content).digest('hex');\n  }\n\n  /**\n   * å¥åº·æ£€æŸ¥å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {Object} healthData - å¥åº·çŠ¶æ€æ•°æ®\n   */\n  static health(res, healthData = {}) {\n    const response = {\n      status: 'healthy',\n      timestamp: new Date().toISOString(),\n      uptime: process.uptime(),\n      memory: process.memoryUsage(),\n      ...healthData\n    };\n\n    return res.status(200).json(response);\n  }\n\n  /**\n   * APIç‰ˆæœ¬ä¸æ”¯æŒå“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} requestedVersion - è¯·æ±‚çš„ç‰ˆæœ¬\n   * @param {Array} supportedVersions - æ”¯æŒçš„ç‰ˆæœ¬åˆ—è¡¨\n   */\n  static unsupportedVersion(res, requestedVersion, supportedVersions = []) {\n    return this.error(res, `ä¸æ”¯æŒçš„APIç‰ˆæœ¬: ${requestedVersion}`, 400, {\n      requestedVersion,\n      supportedVersions\n    });\n  }\n\n  /**\n   * ç»´æŠ¤æ¨¡å¼å“åº”\n   * @param {Object} res - Expresså“åº”å¯¹è±¡\n   * @param {string} message - ç»´æŠ¤æ¶ˆæ¯\n   * @param {Date} estimatedEnd - é¢„è®¡ç»“æŸæ—¶é—´\n   */\n  static maintenance(res, message = 'ç³»ç»Ÿæ­£åœ¨ç»´æŠ¤ä¸­', estimatedEnd = null) {\n    const response = {\n      success: false,\n      message,\n      timestamp: new Date().toISOString(),\n      statusCode: 503,\n      maintenance: true\n    };\n\n    if (estimatedEnd) {\n      response.estimatedEnd = estimatedEnd.toISOString();\n      res.setHeader('Retry-After', Math.ceil((estimatedEnd - new Date()) / 1000));\n    }\n\n    return res.status(503).json(response);\n  }\n}\n\n// ä¸­é—´ä»¶å‡½æ•°ï¼Œå°†ResponseFormatteræ·»åŠ åˆ°reså¯¹è±¡\nconst responseFormatterMiddleware = (req, res, next) => {\n  // å°†æ‰€æœ‰é™æ€æ–¹æ³•ç»‘å®šåˆ°reså¯¹è±¡\n  res.success = (message, data, statusCode) =>\n    ResponseFormatter.success(res, message, data, statusCode);\n  res.error = (message, statusCode, errors) =>\n    ResponseFormatter.error(res, message, statusCode, errors);\n  res.paginated = (message, data, pagination) =>\n    ResponseFormatter.paginated(res, message, data, pagination);\n  res.validationError = (validationErrors) =>\n    ResponseFormatter.validationError(res, validationErrors);\n  res.unauthorized = (message) => ResponseFormatter.unauthorized(res, message);\n  res.forbidden = (message) => ResponseFormatter.forbidden(res, message);\n  res.notFound = (message) => ResponseFormatter.notFound(res, message);\n  res.conflict = (message) => ResponseFormatter.conflict(res, message);\n  res.tooManyRequests = (message, retryAfter) =>\n    ResponseFormatter.tooManyRequests(res, message, retryAfter);\n  res.internalError = (message, error) => ResponseFormatter.internalError(res, message, error);\n  res.custom = (statusCode, message, data) =>\n    ResponseFormatter.custom(res, statusCode, message, data);\n  res.fileDownload = (fileData, filename, contentType) =>\n    ResponseFormatter.fileDownload(res, fileData, filename, contentType);\n  res.stream = (stream, contentType) => ResponseFormatter.stream(res, stream, contentType);\n  res.cached = (message, data, maxAge) => ResponseFormatter.cached(res, message, data, maxAge);\n  res.health = (healthData) => ResponseFormatter.health(res, healthData);\n  res.unsupportedVersion = (requestedVersion, supportedVersions) =>\n    ResponseFormatter.unsupportedVersion(res, requestedVersion, supportedVersions);\n  res.maintenance = (message, estimatedEnd) =>\n    ResponseFormatter.maintenance(res, message, estimatedEnd);\n\n  next();\n};\n\nmodule.exports = ResponseFormatter;\nmodule.exports.middleware = responseFormatterMiddleware;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/middleware/roleCheck.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":103,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":103,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2094,2243],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":109,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":109,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2287,2319],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":150,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":150,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3399,3561],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":156,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":156,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3605,3637],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":184,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":184,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4319,4511],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":190,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":190,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4555,4589],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":226,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":226,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5405,5532],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":232,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":232,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5576,5609],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":272,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":272,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6634,6788],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":278,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":278,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6832,6866],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 405.","line":354,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":354,"endColumn":62}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * è§’è‰²æ£€æŸ¥ä¸­é—´ä»¶\n * ç”¨äºéªŒè¯ç”¨æˆ·æ˜¯å¦å…·æœ‰æ‰§è¡Œç‰¹å®šæ“ä½œçš„æƒé™\n */\n\nconst responseFormatter = require('./responseFormatter');\n\n// è§’è‰²æƒé™çº§åˆ«å®šä¹‰\nconst ROLE_LEVELS = {\n  admin: 100,\n  operator: 50,\n  user: 10,\n  guest: 1\n};\n\n// è§’è‰²æƒé™æ˜ å°„\nconst ROLE_PERMISSIONS = {\n  admin: [\n    'user:create',\n    'user:read',\n    'user:update',\n    'user:delete',\n    'device:create',\n    'device:read',\n    'device:update',\n    'device:delete',\n    'energy:create',\n    'energy:read',\n    'energy:update',\n    'energy:delete',\n    'carbon:create',\n    'carbon:read',\n    'carbon:update',\n    'carbon:delete',\n    'maintenance:create',\n    'maintenance:read',\n    'maintenance:update',\n    'maintenance:delete',\n    'digitaltwin:create',\n    'digitaltwin:read',\n    'digitaltwin:update',\n    'digitaltwin:delete',\n    'system:config',\n    'system:backup',\n    'system:restore',\n    'report:generate',\n    'report:export'\n  ],\n  operator: [\n    'device:create',\n    'device:read',\n    'device:update',\n    'energy:create',\n    'energy:read',\n    'energy:update',\n    'carbon:create',\n    'carbon:read',\n    'carbon:update',\n    'maintenance:create',\n    'maintenance:read',\n    'maintenance:update',\n    'digitaltwin:create',\n    'digitaltwin:read',\n    'digitaltwin:update',\n    'report:generate',\n    'report:export'\n  ],\n  user: [\n    'device:read',\n    'energy:read',\n    'carbon:read',\n    'maintenance:read',\n    'digitaltwin:read',\n    'report:generate'\n  ],\n  guest: ['device:read', 'energy:read', 'carbon:read']\n};\n\n/**\n * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æŒ‡å®šè§’è‰²\n * @param {Array|string} allowedRoles - å…è®¸çš„è§’è‰²åˆ—è¡¨\n * @returns {Function} Expressä¸­é—´ä»¶å‡½æ•°\n */\nfunction requireRole(allowedRoles) {\n  // ç¡®ä¿allowedRolesæ˜¯æ•°ç»„\n  const roles = Array.isArray(allowedRoles) ? allowedRoles : [allowedRoles];\n\n  return (req, res, next) => {\n    try {\n      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯\n      if (!req.user) {\n        return responseFormatter.unauthorized(res, 'ç”¨æˆ·æœªè®¤è¯');\n      }\n\n      const userRole = req.user.role;\n\n      // æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦åœ¨å…è®¸çš„è§’è‰²åˆ—è¡¨ä¸­\n      if (!roles.includes(userRole)) {\n        return responseFormatter.forbidden(res, `éœ€è¦ä»¥ä¸‹è§’è‰²ä¹‹ä¸€: ${roles.join(', ')}`);\n      }\n\n      // è®°å½•æƒé™æ£€æŸ¥æ—¥å¿—\n      console.log(\n        `[${new Date().toISOString()}] Role Check: User ${req.user.username} (${userRole}) accessing ${req.method} ${req.path}`\n      );\n\n      next();\n    } catch (error) {\n      console.error('è§’è‰²æ£€æŸ¥é”™è¯¯:', error);\n      return responseFormatter.internalError(res, 'æƒé™éªŒè¯å¤±è´¥', error);\n    }\n  };\n}\n\n/**\n * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æŒ‡å®šæƒé™\n * @param {Array|string} requiredPermissions - éœ€è¦çš„æƒé™åˆ—è¡¨\n * @returns {Function} Expressä¸­é—´ä»¶å‡½æ•°\n */\nfunction requirePermission(requiredPermissions) {\n  // ç¡®ä¿requiredPermissionsæ˜¯æ•°ç»„\n  const permissions = Array.isArray(requiredPermissions)\n    ? requiredPermissions\n    : [requiredPermissions];\n\n  return (req, res, next) => {\n    try {\n      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯\n      if (!req.user) {\n        return responseFormatter.unauthorized(res, 'ç”¨æˆ·æœªè®¤è¯');\n      }\n\n      const userRole = req.user.role;\n      const userPermissions = ROLE_PERMISSIONS[userRole] || [];\n\n      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æ‰€æœ‰éœ€è¦çš„æƒé™\n      const hasAllPermissions = permissions.every((permission) =>\n        userPermissions.includes(permission)\n      );\n\n      if (!hasAllPermissions) {\n        const missingPermissions = permissions.filter(\n          (permission) => !userPermissions.includes(permission)\n        );\n\n        return responseFormatter.forbidden(res, `ç¼ºå°‘æƒé™: ${missingPermissions.join(', ')}`);\n      }\n\n      // è®°å½•æƒé™æ£€æŸ¥æ—¥å¿—\n      console.log(\n        `[${new Date().toISOString()}] Permission Check: User ${req.user.username} (${userRole}) has permissions: ${permissions.join(', ')}`\n      );\n\n      next();\n    } catch (error) {\n      console.error('æƒé™æ£€æŸ¥é”™è¯¯:', error);\n      return responseFormatter.internalError(res, 'æƒé™éªŒè¯å¤±è´¥', error);\n    }\n  };\n}\n\n/**\n * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰è¶³å¤Ÿçš„è§’è‰²çº§åˆ«\n * @param {string} minimumRole - æœ€ä½è¦æ±‚çš„è§’è‰²\n * @returns {Function} Expressä¸­é—´ä»¶å‡½æ•°\n */\nfunction requireMinimumRole(minimumRole) {\n  return (req, res, next) => {\n    try {\n      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯\n      if (!req.user) {\n        return responseFormatter.unauthorized(res, 'ç”¨æˆ·æœªè®¤è¯');\n      }\n\n      const userRole = req.user.role;\n      const userLevel = ROLE_LEVELS[userRole] || 0;\n      const requiredLevel = ROLE_LEVELS[minimumRole] || 0;\n\n      if (userLevel < requiredLevel) {\n        return responseFormatter.forbidden(res, `éœ€è¦è‡³å°‘ ${minimumRole} è§’è‰²æƒé™`);\n      }\n\n      // è®°å½•æƒé™æ£€æŸ¥æ—¥å¿—\n      console.log(\n        `[${new Date().toISOString()}] Role Level Check: User ${req.user.username} (${userRole}:${userLevel}) meets minimum requirement (${minimumRole}:${requiredLevel})`\n      );\n\n      next();\n    } catch (error) {\n      console.error('è§’è‰²çº§åˆ«æ£€æŸ¥é”™è¯¯:', error);\n      return responseFormatter.internalError(res, 'æƒé™éªŒè¯å¤±è´¥', error);\n    }\n  };\n}\n\n/**\n * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºèµ„æºæ‰€æœ‰è€…æˆ–å…·æœ‰ç®¡ç†æƒé™\n * @param {Function} getResourceOwnerId - è·å–èµ„æºæ‰€æœ‰è€…IDçš„å‡½æ•°\n * @returns {Function} Expressä¸­é—´ä»¶å‡½æ•°\n */\nfunction requireOwnershipOrAdmin(getResourceOwnerId) {\n  return async (req, res, next) => {\n    try {\n      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯\n      if (!req.user) {\n        return responseFormatter.unauthorized(res, 'ç”¨æˆ·æœªè®¤è¯');\n      }\n\n      const userRole = req.user.role;\n      const {userId} = req.user;\n\n      // ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰èµ„æº\n      if (userRole === 'admin') {\n        return next();\n      }\n\n      // è·å–èµ„æºæ‰€æœ‰è€…ID\n      const resourceOwnerId = await getResourceOwnerId(req);\n\n      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºèµ„æºæ‰€æœ‰è€…\n      if (userId !== resourceOwnerId) {\n        return responseFormatter.forbidden(res, 'åªèƒ½è®¿é—®è‡ªå·±çš„èµ„æº');\n      }\n\n      // è®°å½•æƒé™æ£€æŸ¥æ—¥å¿—\n      console.log(\n        `[${new Date().toISOString()}] Ownership Check: User ${req.user.username} accessing own resource`\n      );\n\n      next();\n    } catch (error) {\n      console.error('æ‰€æœ‰æƒæ£€æŸ¥é”™è¯¯:', error);\n      return responseFormatter.internalError(res, 'æƒé™éªŒè¯å¤±è´¥', error);\n    }\n  };\n}\n\n/**\n * æ¡ä»¶æƒé™æ£€æŸ¥\n * @param {Function} condition - æ¡ä»¶æ£€æŸ¥å‡½æ•°\n * @param {Array|string} allowedRoles - æ»¡è¶³æ¡ä»¶æ—¶å…è®¸çš„è§’è‰²\n * @param {Array|string} fallbackRoles - ä¸æ»¡è¶³æ¡ä»¶æ—¶å…è®¸çš„è§’è‰²\n * @returns {Function} Expressä¸­é—´ä»¶å‡½æ•°\n */\nfunction conditionalRole(condition, allowedRoles, fallbackRoles = []) {\n  return async (req, res, next) => {\n    try {\n      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯\n      if (!req.user) {\n        return responseFormatter.unauthorized(res, 'ç”¨æˆ·æœªè®¤è¯');\n      }\n\n      const userRole = req.user.role;\n      const conditionMet = await condition(req);\n\n      const targetRoles = conditionMet\n        ? Array.isArray(allowedRoles)\n          ? allowedRoles\n          : [allowedRoles]\n        : Array.isArray(fallbackRoles)\n          ? fallbackRoles\n          : [fallbackRoles];\n\n      if (!targetRoles.includes(userRole)) {\n        return responseFormatter.forbidden(\n          res,\n          `å½“å‰æ¡ä»¶ä¸‹éœ€è¦ä»¥ä¸‹è§’è‰²ä¹‹ä¸€: ${targetRoles.join(', ')}`\n        );\n      }\n\n      // è®°å½•æƒé™æ£€æŸ¥æ—¥å¿—\n      console.log(\n        `[${new Date().toISOString()}] Conditional Role Check: User ${req.user.username} (${userRole}) - condition: ${conditionMet}`\n      );\n\n      next();\n    } catch (error) {\n      console.error('æ¡ä»¶æƒé™æ£€æŸ¥é”™è¯¯:', error);\n      return responseFormatter.internalError(res, 'æƒé™éªŒè¯å¤±è´¥', error);\n    }\n  };\n}\n\n/**\n * è·å–ç”¨æˆ·æƒé™åˆ—è¡¨\n * @param {string} role - ç”¨æˆ·è§’è‰²\n * @returns {Array} æƒé™åˆ—è¡¨\n */\nfunction getUserPermissions(role) {\n  return ROLE_PERMISSIONS[role] || [];\n}\n\n/**\n * æ£€æŸ¥è§’è‰²æ˜¯å¦å…·æœ‰æŒ‡å®šæƒé™\n * @param {string} role - è§’è‰²\n * @param {string} permission - æƒé™\n * @returns {boolean} æ˜¯å¦å…·æœ‰æƒé™\n */\nfunction hasPermission(role, permission) {\n  const permissions = ROLE_PERMISSIONS[role] || [];\n  return permissions.includes(permission);\n}\n\n/**\n * è·å–è§’è‰²çº§åˆ«\n * @param {string} role - è§’è‰²\n * @returns {number} è§’è‰²çº§åˆ«\n */\nfunction getRoleLevel(role) {\n  return ROLE_LEVELS[role] || 0;\n}\n\n/**\n * æ¯”è¾ƒä¸¤ä¸ªè§’è‰²çš„çº§åˆ«\n * @param {string} role1 - è§’è‰²1\n * @param {string} role2 - è§’è‰²2\n * @returns {number} æ¯”è¾ƒç»“æœ (1: role1 > role2, 0: ç›¸ç­‰, -1: role1 < role2)\n */\nfunction compareRoles(role1, role2) {\n  const level1 = getRoleLevel(role1);\n  const level2 = getRoleLevel(role2);\n\n  if (level1 > level2) {return 1;}\n  if (level1 < level2) {return -1;}\n  return 0;\n}\n\n/**\n * æƒé™æ£€æŸ¥ä¸­é—´ä»¶å·¥å‚\n * æ ¹æ®HTTPæ–¹æ³•è‡ªåŠ¨é€‰æ‹©æƒé™æ£€æŸ¥ç­–ç•¥\n * @param {string} resource - èµ„æºåç§°\n * @returns {Function} Expressä¸­é—´ä»¶å‡½æ•°\n */\nfunction autoPermissionCheck(resource) {\n  return (req, res, next) => {\n    const method = req.method.toLowerCase();\n    let requiredPermission;\n\n    switch (method) {\n      case 'get':\n        requiredPermission = `${resource}:read`;\n        break;\n      case 'post':\n        requiredPermission = `${resource}:create`;\n        break;\n      case 'put':\n      case 'patch':\n        requiredPermission = `${resource}:update`;\n        break;\n      case 'delete':\n        requiredPermission = `${resource}:delete`;\n        break;\n      default:\n        return responseFormatter.error(res, 'ä¸æ”¯æŒçš„HTTPæ–¹æ³•', 405);\n    }\n\n    return requirePermission(requiredPermission)(req, res, next);\n  };\n}\n\nmodule.exports = {\n  requireRole,\n  requirePermission,\n  requireMinimumRole,\n  requireOwnershipOrAdmin,\n  conditionalRole,\n  autoPermissionCheck,\n  getUserPermissions,\n  hasPermission,\n  getRoleLevel,\n  compareRoles,\n  ROLE_LEVELS,\n  ROLE_PERMISSIONS\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/middleware/validation.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":56,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":56,"endColumn":11},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":57,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":57,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":71,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":71,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 999999.","line":71,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":71,"endColumn":63},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":78,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":78,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 999999.","line":78,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":78,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":87,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":87,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":87,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":87,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":98,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":98,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":98,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":98,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":106,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":106,"endColumn":11},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 128.","line":107,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":107,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 255.","line":116,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":116,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":131,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":131,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":143,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":143,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":157,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":157,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":158,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":158,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":159,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":159,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: -50.","line":160,"column":35,"nodeType":"UnaryExpression","messageId":"noMagic","endLine":160,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":160,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":160,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":161,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":161,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":177,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":177,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":179,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":179,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":219,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":219,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":223,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":223,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":224,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":224,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":225,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":225,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":238,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":238,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":251,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":251,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":300,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":300,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":300,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":300,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":300,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":300,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":32,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * è¾“å…¥éªŒè¯ä¸­é—´ä»¶\n * ä½¿ç”¨Joiè¿›è¡Œè¯·æ±‚æ•°æ®éªŒè¯å’Œæ¸…ç†\n */\n\nimport Joi from 'joi';\nimport { ValidationError } from '../utils/errorHandler.js';\n\n/**\n * é€šç”¨éªŒè¯ä¸­é—´ä»¶\n * @param {Object} schema - JoiéªŒè¯æ¨¡å¼\n * @param {Object} options - éªŒè¯é€‰é¡¹\n */\nexport const validateRequest = (schema, options = {}) => {\n  const defaultOptions = {\n    abortEarly: false, // è¿”å›æ‰€æœ‰éªŒè¯é”™è¯¯\n    allowUnknown: false, // ä¸å…è®¸æœªçŸ¥å­—æ®µ\n    stripUnknown: true, // ç§»é™¤æœªçŸ¥å­—æ®µ\n    ...options\n  };\n\n  return (req, res, next) => {\n    const dataToValidate = {\n      body: req.body || {},\n      query: req.query || {},\n      params: req.params || {},\n      headers: req.headers || {}\n    };\n\n    const { error, value } = schema.validate(dataToValidate, defaultOptions);\n\n    if (error) {\n      const errorMessage = error.details.map((detail) => detail.message).join('; ');\n\n      const field = error.details[0]?.path?.join('.') || null;\n\n      return next(new ValidationError(errorMessage, field));\n    }\n\n    // å°†éªŒè¯åçš„æ•°æ®æ›¿æ¢åŸå§‹æ•°æ®\n    req.body = value.body || {};\n    req.query = value.query || {};\n    req.params = value.params || {};\n\n    next();\n  };\n};\n\n/**\n * è‡ªå®šä¹‰éªŒè¯è§„åˆ™\n */\nconst customValidators = {\n  // è®¾å¤‡IDéªŒè¯\n  deviceId: Joi.string()\n    .pattern(/^[a-zA-Z0-9_-]+$/)\n    .min(3)\n    .max(50)\n    .messages({\n      'string.pattern.base': 'è®¾å¤‡IDåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦',\n      'string.min': 'è®¾å¤‡IDé•¿åº¦è‡³å°‘3ä¸ªå­—ç¬¦',\n      'string.max': 'è®¾å¤‡IDé•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦'\n    }),\n\n  // æ—¶é—´æˆ³éªŒè¯\n  timestamp: Joi.date().iso().max('now').messages({\n    'date.format': 'æ—¶é—´æˆ³å¿…é¡»æ˜¯æœ‰æ•ˆçš„ISO 8601æ ¼å¼',\n    'date.max': 'æ—¶é—´æˆ³ä¸èƒ½æ˜¯æœªæ¥æ—¶é—´'\n  }),\n\n  // èƒ½è€—å€¼éªŒè¯\n  energyValue: Joi.number().positive().precision(3).max(999999).messages({\n    'number.positive': 'èƒ½è€—å€¼å¿…é¡»ä¸ºæ­£æ•°',\n    'number.precision': 'èƒ½è€—å€¼æœ€å¤šä¿ç•™3ä½å°æ•°',\n    'number.max': 'èƒ½è€—å€¼ä¸èƒ½è¶…è¿‡999999'\n  }),\n\n  // ç¢³æ’æ”¾å€¼éªŒè¯\n  carbonValue: Joi.number().min(0).precision(6).max(999999).messages({\n    'number.min': 'ç¢³æ’æ”¾å€¼ä¸èƒ½ä¸ºè´Ÿæ•°',\n    'number.precision': 'ç¢³æ’æ”¾å€¼æœ€å¤šä¿ç•™6ä½å°æ•°',\n    'number.max': 'ç¢³æ’æ”¾å€¼ä¸èƒ½è¶…è¿‡999999'\n  }),\n\n  // åˆ†é¡µå‚æ•°éªŒè¯\n  pagination: {\n    page: Joi.number().integer().min(1).default(1),\n    limit: Joi.number().integer().min(1).max(100).default(20),\n    offset: Joi.number().integer().min(0)\n  },\n\n  // æ—¶é—´èŒƒå›´éªŒè¯\n  timeRange: {\n    startTime: Joi.date().iso().required(),\n    endTime: Joi.date().iso().min(Joi.ref('startTime')).required()\n  },\n\n  // ç”¨æˆ·åéªŒè¯\n  username: Joi.string().alphanum().min(3).max(30).messages({\n    'string.alphanum': 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—',\n    'string.min': 'ç”¨æˆ·åé•¿åº¦è‡³å°‘3ä¸ªå­—ç¬¦',\n    'string.max': 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦'\n  }),\n\n  // å¯†ç éªŒè¯\n  password: Joi.string()\n    .min(8)\n    .max(128)\n    .pattern(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]$/)\n    .messages({\n      'string.min': 'å¯†ç é•¿åº¦è‡³å°‘8ä¸ªå­—ç¬¦',\n      'string.max': 'å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡128ä¸ªå­—ç¬¦',\n      'string.pattern.base': 'å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦'\n    }),\n\n  // é‚®ç®±éªŒè¯\n  email: Joi.string().email().max(255).messages({\n    'string.email': 'é‚®ç®±æ ¼å¼æ— æ•ˆ',\n    'string.max': 'é‚®ç®±é•¿åº¦ä¸èƒ½è¶…è¿‡255ä¸ªå­—ç¬¦'\n  })\n};\n\n/**\n * èƒ½æºæ•°æ®éªŒè¯æ¨¡å¼\n */\nexport const energyDataSchema = Joi.object({\n  body: Joi.object({\n    device_id: customValidators.deviceId.required(),\n    value: customValidators.energyValue.required(),\n    unit: Joi.string().valid('kWh', 'MWh', 'GWh').required(),\n    timestamp: customValidators.timestamp.required(),\n    location: Joi.string().max(100).optional(),\n    metadata: Joi.object().optional()\n  })\n});\n\n/**\n * ç¢³æ’æ”¾æ•°æ®éªŒè¯æ¨¡å¼\n */\nexport const carbonDataSchema = Joi.object({\n  body: Joi.object({\n    device_id: customValidators.deviceId.required(),\n    emission_value: customValidators.carbonValue.required(),\n    emission_factor: Joi.number().positive().precision(6).required(),\n    energy_consumption: customValidators.energyValue.required(),\n    timestamp: customValidators.timestamp.required(),\n    calculation_method: Joi.string().valid('direct', 'indirect', 'lifecycle').default('direct'),\n    metadata: Joi.object().optional()\n  })\n});\n\n/**\n * ç”µæ± æ•°æ®éªŒè¯æ¨¡å¼\n */\nexport const batteryDataSchema = Joi.object({\n  body: Joi.object({\n    device_id: customValidators.deviceId.required(),\n    soc: Joi.number().min(0).max(100).precision(2).required(), // ç”µé‡ç™¾åˆ†æ¯”\n    voltage: Joi.number().positive().precision(3).required(),\n    current: Joi.number().precision(3).required(), // å¯ä»¥ä¸ºè´Ÿæ•°ï¼ˆæ”¾ç”µï¼‰\n    temperature: Joi.number().min(-50).max(100).precision(2).required(),\n    capacity: Joi.number().positive().precision(3).required(),\n    cycle_count: Joi.number().integer().min(0).optional(),\n    health_status: Joi.string().valid('good', 'warning', 'critical').default('good'),\n    timestamp: customValidators.timestamp.required(),\n    metadata: Joi.object().optional()\n  })\n});\n\n/**\n * ç”¨æˆ·æ³¨å†ŒéªŒè¯æ¨¡å¼\n */\nexport const userRegistrationSchema = Joi.object({\n  body: Joi.object({\n    username: customValidators.username.required(),\n    password: customValidators.password.required(),\n    email: customValidators.email.required(),\n    full_name: Joi.string().min(2).max(100).required(),\n    role: Joi.string().valid('admin', 'operator', 'viewer').default('viewer'),\n    department: Joi.string().max(100).optional(),\n    phone: Joi.string()\n      .pattern(/^\\+?[1-9]\\d{1,14}$/)\n      .optional()\n  })\n});\n\n/**\n * ç”¨æˆ·ç™»å½•éªŒè¯æ¨¡å¼\n */\nexport const userLoginSchema = Joi.object({\n  body: Joi.object({\n    username: Joi.string().required(),\n    password: Joi.string().required(),\n    remember_me: Joi.boolean().default(false)\n  })\n});\n\n/**\n * æ•°æ®æŸ¥è¯¢éªŒè¯æ¨¡å¼\n */\nexport const dataQuerySchema = Joi.object({\n  query: Joi.object({\n    device_id: customValidators.deviceId.optional(),\n    start_time: Joi.date().iso().optional(),\n    end_time: Joi.date().iso().min(Joi.ref('start_time')).optional(),\n    page: customValidators.pagination.page,\n    limit: customValidators.pagination.limit,\n    sort_by: Joi.string().valid('timestamp', 'value', 'device_id').default('timestamp'),\n    sort_order: Joi.string().valid('asc', 'desc').default('desc'),\n    aggregation: Joi.string().valid('none', 'hourly', 'daily', 'monthly').default('none')\n  })\n});\n\n/**\n * è®¾å¤‡ç®¡ç†éªŒè¯æ¨¡å¼\n */\nexport const deviceSchema = Joi.object({\n  body: Joi.object({\n    device_id: customValidators.deviceId.required(),\n    device_name: Joi.string().min(2).max(100).required(),\n    device_type: Joi.string()\n      .valid('energy_meter', 'carbon_sensor', 'battery', 'solar_panel', 'wind_turbine')\n      .required(),\n    location: Joi.string().max(200).required(),\n    manufacturer: Joi.string().max(100).optional(),\n    model: Joi.string().max(100).optional(),\n    installation_date: Joi.date().iso().max('now').optional(),\n    status: Joi.string().valid('active', 'inactive', 'maintenance').default('active'),\n    specifications: Joi.object().optional(),\n    metadata: Joi.object().optional()\n  })\n});\n\n/**\n * å‘Šè­¦è§„åˆ™éªŒè¯æ¨¡å¼\n */\nexport const alertRuleSchema = Joi.object({\n  body: Joi.object({\n    rule_name: Joi.string().min(2).max(100).required(),\n    device_id: customValidators.deviceId.optional(),\n    metric_type: Joi.string()\n      .valid('energy', 'carbon', 'battery_soc', 'battery_temperature')\n      .required(),\n    condition: Joi.string().valid('>', '<', '>=', '<=', '==', '!=').required(),\n    threshold_value: Joi.number().required(),\n    severity: Joi.string().valid('low', 'medium', 'high', 'critical').required(),\n    enabled: Joi.boolean().default(true),\n    notification_channels: Joi.array()\n      .items(Joi.string().valid('email', 'sms', 'webhook'))\n      .min(1)\n      .required(),\n    description: Joi.string().max(500).optional()\n  })\n});\n\n/**\n * æŠ¥å‘Šç”ŸæˆéªŒè¯æ¨¡å¼\n */\nexport const reportGenerationSchema = Joi.object({\n  body: Joi.object({\n    report_type: Joi.string()\n      .valid('energy_consumption', 'carbon_emission', 'battery_performance', 'comprehensive')\n      .required(),\n    start_time: Joi.date().iso().required(),\n    end_time: Joi.date().iso().min(Joi.ref('start_time')).required(),\n    device_ids: Joi.array().items(customValidators.deviceId).optional(),\n    aggregation_level: Joi.string().valid('hourly', 'daily', 'weekly', 'monthly').default('daily'),\n    include_charts: Joi.boolean().default(true),\n    format: Joi.string().valid('pdf', 'excel', 'csv').default('pdf'),\n    email_recipients: Joi.array().items(customValidators.email).optional()\n  })\n});\n\n/**\n * IDå‚æ•°éªŒè¯æ¨¡å¼\n */\nexport const idParamSchema = Joi.object({\n  params: Joi.object({\n    id: Joi.string()\n      .pattern(/^[0-9]+$/)\n      .required()\n      .messages({\n        'string.pattern.base': 'IDå¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—'\n      })\n  })\n});\n\n/**\n * è®¾å¤‡IDå‚æ•°éªŒè¯æ¨¡å¼\n */\nexport const deviceIdParamSchema = Joi.object({\n  params: Joi.object({\n    deviceId: customValidators.deviceId.required()\n  })\n});\n\n/**\n * æ–‡ä»¶ä¸Šä¼ éªŒè¯\n */\nexport const validateFileUpload =\n  (allowedTypes = [], maxSize = 10 * 1024 * 1024) =>\n    (req, res, next) => {\n      if (!req.file && !req.files) {\n        return next(new ValidationError('æœªæ‰¾åˆ°ä¸Šä¼ çš„æ–‡ä»¶'));\n      }\n\n      const files = req.files || [req.file];\n\n      for (const file of files) {\n      // æ£€æŸ¥æ–‡ä»¶ç±»å‹\n        if (allowedTypes.length > 0 && !allowedTypes.includes(file.mimetype)) {\n          return next(\n            new ValidationError(\n              `ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.mimetype}ï¼Œæ”¯æŒçš„ç±»å‹: ${allowedTypes.join(', ')}`\n            )\n          );\n        }\n\n        // æ£€æŸ¥æ–‡ä»¶å¤§å°\n        if (file.size > maxSize) {\n          return next(\n            new ValidationError(`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶: ${file.size} bytesï¼Œæœ€å¤§å…è®¸: ${maxSize} bytes`)\n          );\n        }\n\n        // æ£€æŸ¥æ–‡ä»¶å\n        if (!/^[a-zA-Z0-9._-]+$/.test(file.originalname)) {\n          return next(new ValidationError('æ–‡ä»¶ååŒ…å«éæ³•å­—ç¬¦'));\n        }\n      }\n\n      next();\n    };\n\n/**\n * è¯·æ±‚å¤´éªŒè¯\n */\nexport const validateHeaders =\n  (requiredHeaders = []) =>\n    (req, res, next) => {\n      for (const header of requiredHeaders) {\n        if (!req.headers[header.toLowerCase()]) {\n          return next(new ValidationError(`ç¼ºå°‘å¿…éœ€çš„è¯·æ±‚å¤´: ${header}`));\n        }\n      }\n      next();\n    };\n\n/**\n * å†…å®¹ç±»å‹éªŒè¯\n */\nexport const validateContentType =\n  (allowedTypes = ['application/json']) =>\n    (req, res, next) => {\n      const contentType = req.headers['content-type'];\n\n      if (!contentType) {\n        return next(new ValidationError('ç¼ºå°‘Content-Typeè¯·æ±‚å¤´'));\n      }\n\n      const isAllowed = allowedTypes.some((type) =>\n        contentType.toLowerCase().includes(type.toLowerCase())\n      );\n\n      if (!isAllowed) {\n        return next(\n          new ValidationError(\n            `ä¸æ”¯æŒçš„Content-Type: ${contentType}ï¼Œæ”¯æŒçš„ç±»å‹: ${allowedTypes.join(', ')}`\n          )\n        );\n      }\n\n      next();\n    };\n\nexport default {\n  validateRequest,\n  energyDataSchema,\n  carbonDataSchema,\n  batteryDataSchema,\n  userRegistrationSchema,\n  userLoginSchema,\n  dataQuerySchema,\n  deviceSchema,\n  alertRuleSchema,\n  reportGenerationSchema,\n  idParamSchema,\n  deviceIdParamSchema,\n  validateFileUpload,\n  validateHeaders,\n  validateContentType\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/recommendationController.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":13,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":17,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":17,"endColumn":19},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":22,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":22,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[560,594],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":23,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":23,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":43,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":43,"endColumn":19},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":45,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":45,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1115,1149],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":46,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":46,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":62,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":62,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":65,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":65,"endColumn":19},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":67,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":67,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[1609,1643],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":68,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":68,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":84,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":84,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":89,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":89,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":92,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":92,"endColumn":19},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":97,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":97,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2289,2323],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":98,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":98,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":114,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":114,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":119,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":119,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":122,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":122,"endColumn":19},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":127,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":127,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3021,3057],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":128,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":128,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":144,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":144,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":147,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":147,"endColumn":19},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":149,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":149,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3554,3588],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":150,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":150,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":166,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":166,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":170,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":170,"endColumn":19},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":176,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":176,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4185,4217],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":177,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":177,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":29,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Recommendation from '../models/recommendation.js';\nimport { validationResult } from 'express-validator';\n\n/**\n * åˆ›å»ºæ¨èè§„åˆ™\n * @route POST /api/recommendations/rules\n * @access Private\n */\nexport const createRecommendationRule = async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({ errors: errors.array() });\n    }\n\n    const rule = await Recommendation.createRule(req.body);\n    res.status(201).json({\n      message: 'æ¨èè§„åˆ™åˆ›å»ºæˆåŠŸ',\n      rule\n    });\n  } catch (error) {\n    console.error('åˆ›å»ºæ¨èè§„åˆ™å¤±è´¥:', error);\n    res.status(500).json({\n      message: 'åˆ›å»ºæ¨èè§„åˆ™å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * è·å–æ‰€æœ‰æ¨èè§„åˆ™\n * @route GET /api/recommendations/rules\n * @access Private\n */\nexport const getAllRecommendationRules = async (req, res) => {\n  try {\n    const filters = {\n      type: req.query.type,\n      is_active: req.query.is_active !== undefined ? req.query.is_active === 'true' : undefined\n    };\n\n    const rules = await Recommendation.getAllRules(filters);\n    res.status(200).json(rules);\n  } catch (error) {\n    console.error('è·å–æ¨èè§„åˆ™å¤±è´¥:', error);\n    res.status(500).json({\n      message: 'è·å–æ¨èè§„åˆ™å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * æ ¹æ®IDè·å–æ¨èè§„åˆ™\n * @route GET /api/recommendations/rules/:id\n * @access Private\n */\nexport const getRecommendationRuleById = async (req, res) => {\n  try {\n    const rule = await Recommendation.getRuleById(req.params.id);\n    if (!rule) {\n      return res.status(404).json({ message: 'æ¨èè§„åˆ™ä¸å­˜åœ¨' });\n    }\n\n    res.status(200).json(rule);\n  } catch (error) {\n    console.error('è·å–æ¨èè§„åˆ™å¤±è´¥:', error);\n    res.status(500).json({\n      message: 'è·å–æ¨èè§„åˆ™å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * æ›´æ–°æ¨èè§„åˆ™\n * @route PUT /api/recommendations/rules/:id\n * @access Private\n */\nexport const updateRecommendationRule = async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({ errors: errors.array() });\n    }\n\n    const rule = await Recommendation.updateRule(req.params.id, req.body);\n    if (!rule) {\n      return res.status(404).json({ message: 'æ¨èè§„åˆ™ä¸å­˜åœ¨' });\n    }\n\n    res.status(200).json({\n      message: 'æ¨èè§„åˆ™æ›´æ–°æˆåŠŸ',\n      rule\n    });\n  } catch (error) {\n    console.error('æ›´æ–°æ¨èè§„åˆ™å¤±è´¥:', error);\n    res.status(500).json({\n      message: 'æ›´æ–°æ¨èè§„åˆ™å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * æ¿€æ´»/ç¦ç”¨æ¨èè§„åˆ™\n * @route PATCH /api/recommendations/rules/:id/status\n * @access Private\n */\nexport const toggleRecommendationRuleStatus = async (req, res) => {\n  try {\n    const { is_active } = req.body;\n    if (is_active === undefined) {\n      return res.status(400).json({ message: 'å¿…é¡»æä¾›is_activeå‚æ•°' });\n    }\n\n    const rule = await Recommendation.toggleRuleStatus(req.params.id, is_active);\n    if (!rule) {\n      return res.status(404).json({ message: 'æ¨èè§„åˆ™ä¸å­˜åœ¨' });\n    }\n\n    res.status(200).json({\n      message: `æ¨èè§„åˆ™å·²${is_active ? 'æ¿€æ´»' : 'ç¦ç”¨'}`,\n      rule\n    });\n  } catch (error) {\n    console.error('æ›´æ–°æ¨èè§„åˆ™çŠ¶æ€å¤±è´¥:', error);\n    res.status(500).json({\n      message: 'æ›´æ–°æ¨èè§„åˆ™çŠ¶æ€å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * åˆ é™¤æ¨èè§„åˆ™\n * @route DELETE /api/recommendations/rules/:id\n * @access Private\n */\nexport const deleteRecommendationRule = async (req, res) => {\n  try {\n    const deletedRows = await Recommendation.deleteRule(req.params.id);\n    if (deletedRows === 0) {\n      return res.status(404).json({ message: 'æ¨èè§„åˆ™ä¸å­˜åœ¨' });\n    }\n\n    res.status(200).json({ message: 'æ¨èè§„åˆ™åˆ é™¤æˆåŠŸ' });\n  } catch (error) {\n    console.error('åˆ é™¤æ¨èè§„åˆ™å¤±è´¥:', error);\n    res.status(500).json({\n      message: 'åˆ é™¤æ¨èè§„åˆ™å¤±è´¥',\n      error: error.message\n    });\n  }\n};\n\n/**\n * ç”Ÿæˆæ¨è\n * @route POST /api/recommendations/generate\n * @access Private\n */\nexport const generateRecommendations = async (req, res) => {\n  try {\n    const { context } = req.body;\n    if (!context) {\n      return res.status(400).json({ message: 'å¿…é¡»æä¾›ç”¨æˆ·ä¸Šä¸‹æ–‡æ•°æ®' });\n    }\n\n    const recommendations = await Recommendation.generateRecommendations(context);\n    res.status(200).json({\n      message: 'æ¨èç”ŸæˆæˆåŠŸ',\n      count: recommendations.length,\n      recommendations\n    });\n  } catch (error) {\n    console.error('ç”Ÿæˆæ¨èå¤±è´¥:', error);\n    res.status(500).json({\n      message: 'ç”Ÿæˆæ¨èå¤±è´¥',\n      error: error.message\n    });\n  }\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/routes.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":98,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":98,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[2318,2596],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * ä¸»è·¯ç”±æ–‡ä»¶ - é‡æ„åçš„æ¨¡å—åŒ–ç‰ˆæœ¬\n * æ•´åˆæ‰€æœ‰å­è·¯ç”±æ¨¡å—\n */\n\nimport express from 'express';\nimport responseFormatter from './middleware/responseFormatter.js';\nimport { authenticate } from './middleware/authMiddleware.js';\n\n// å¯¼å…¥æ¨¡å—åŒ–è·¯ç”±\nimport authRoutes from './routes/auth.js';\nimport deviceRoutes from './routes/devices.js';\nimport energyRoutes from './routes/energy.js';\nimport carbonRoutes from './routes/carbon.js';\nimport maintenanceRoutes from './routes/maintenance.js';\nimport digitalTwinRoutes from './routes/digital-twin.js';\n\nconst router = express.Router();\n\n// åº”ç”¨å“åº”æ ¼å¼åŒ–ä¸­é—´ä»¶\nrouter.use(responseFormatter);\n\n// APIæ ¹è·¯å¾„ä¿¡æ¯\nrouter.get('/', (req, res) => {\n  res.success({\n    message: 'é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿèƒ½ç¢³ç®¡ç†ç³»ç»Ÿ API',\n    version: '2.0.0',\n    status: 'running',\n    timestamp: new Date().toISOString(),\n    endpoints: {\n      auth: '/auth',\n      devices: '/devices',\n      energy: '/energy',\n      carbon: '/carbon',\n      maintenance: '/maintenance',\n      digitalTwin: '/digital-twin'\n    }\n  });\n});\n\n// å¥åº·æ£€æŸ¥ç«¯ç‚¹\nrouter.get('/health', (req, res) => {\n  res.healthCheck({\n    status: 'healthy',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    memory: process.memoryUsage(),\n    version: '2.0.0'\n  });\n});\n\n// APIç‰ˆæœ¬ä¿¡æ¯\nrouter.get('/version', (req, res) => {\n  res.success({\n    version: '2.0.0',\n    apiVersion: 'v1',\n    buildDate: new Date().toISOString(),\n    features: [\n      'modular-architecture',\n      'enhanced-security',\n      'improved-validation',\n      'better-error-handling',\n      'comprehensive-logging'\n    ]\n  });\n});\n\n// æŒ‚è½½å­è·¯ç”±\nrouter.use('/auth', authRoutes);\nrouter.use('/devices', authenticate, deviceRoutes);\nrouter.use('/energy', authenticate, energyRoutes);\nrouter.use('/carbon', authenticate, carbonRoutes);\nrouter.use('/maintenance', authenticate, maintenanceRoutes);\nrouter.use('/digital-twin', authenticate, digitalTwinRoutes);\n\n// 404å¤„ç†\nrouter.use('*', (req, res) => {\n  res.notFound('APIç«¯ç‚¹ä¸å­˜åœ¨', {\n    requestedPath: req.originalUrl,\n    method: req.method,\n    availableEndpoints: [\n      'GET /',\n      'GET /health',\n      'GET /version',\n      'POST /auth/login',\n      'POST /auth/register',\n      'GET /devices',\n      'GET /energy',\n      'GET /carbon',\n      'GET /maintenance',\n      'GET /digital-twin'\n    ]\n  });\n});\n\n// å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶\nrouter.use((error, req, res, _next) => {\n  console.error(`[${new Date().toISOString()}] Global Error Handler:`, {\n    error: error.message,\n    stack: error.stack,\n    url: req.url,\n    method: req.method,\n    user: req.user?.username || 'anonymous',\n    body: req.body,\n    params: req.params,\n    query: req.query\n  });\n\n  // æ ¹æ®é”™è¯¯ç±»å‹è¿”å›ç›¸åº”çš„å“åº”\n  if (error.name === 'ValidationError') {\n    return res.validationError('æ•°æ®éªŒè¯å¤±è´¥', error.details);\n  } else if (error.name === 'UnauthorizedError') {\n    return res.unauthorized(error.message);\n  } else if (error.name === 'ForbiddenError') {\n    return res.forbidden(error.message);\n  } else if (error.name === 'NotFoundError') {\n    return res.notFound(error.message);\n  } else if (error.name === 'ConflictError') {\n    return res.conflict(error.message);\n  } else if (error.name === 'TooManyRequestsError') {\n    return res.tooManyRequests(error.message);\n  } \n  return res.internalError('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯', error);\n  \n});\n\nexport default router;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/routes/auth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/routes/carbon.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/routes/devices.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/routes/digital-twin.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/routes/digitalTwin.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":23,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":23,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":23,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":23,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":23,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":23,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":70,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":70,"endColumn":58},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":105,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":105,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[3817,3855],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":106,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":106,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":119,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":119,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":124,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":124,"endColumn":61},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":129,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":129,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[4483,4521],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":130,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":130,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":144,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":144,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 409.","line":158,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":158,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":163,"column":73,"nodeType":"Literal","messageId":"noMagic","endLine":163,"endColumn":76},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":165,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":165,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[5432,5468],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":166,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":166,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":183,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":183,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":188,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":188,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 409.","line":195,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":195,"endColumn":61},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":209,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":209,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6657,6693],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":210,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":210,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":224,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":224,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":229,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":229,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 409.","line":235,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":235,"endColumn":65},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":242,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":242,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[7540,7576],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":243,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":243,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":256,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":256,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":261,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":61},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":268,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":268,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[8253,8287],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":269,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":269,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":287,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":287,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":292,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":292,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":300,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":300,"endColumn":59},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":307,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":307,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[9354,9386],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":308,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":308,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":322,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":322,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3600.","line":325,"column":63,"nodeType":"Literal","messageId":"noMagic","endLine":325,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":325,"column":80,"nodeType":"Literal","messageId":"noMagic","endLine":325,"endColumn":82},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":330,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":330,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":334,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":334,"endColumn":63},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":350,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":350,"endColumn":67},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":352,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":352,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[10526,10558],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":353,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":353,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":366,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":366,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":371,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":371,"endColumn":57},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":376,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":376,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11195,11229],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":377,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":377,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":390,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":390,"endColumn":58},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":401,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":401,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[11890,11924],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":402,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":402,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":416,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":416,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 201.","line":427,"column":73,"nodeType":"Literal","messageId":"noMagic","endLine":427,"endColumn":76},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":429,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":429,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12598,12632],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":430,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":430,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":443,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":443,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":448,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":448,"endColumn":61},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":455,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":455,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[13321,13357],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":456,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":456,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":476,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":476,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":481,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":481,"endColumn":61},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":494,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":494,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[14477,14509],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":495,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":495,"endColumn":49},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":507,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":507,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[14790,14826],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":508,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":508,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":523,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":523,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":528,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":528,"endColumn":61},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":541,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":541,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[15873,15907],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":542,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":542,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":67,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const express = require('express');\nconst { body, query, param, validationResult } = require('express-validator');\nconst DigitalTwinModel = require('../../../core/entities/DigitalTwinModel');\nconst Device = require('../../../core/entities/Device');\nconst authMiddleware = require('../middleware/auth');\nconst responseFormatter = require('../middleware/responseFormatter');\nconst { requireRole } = require('../middleware/roleCheck');\n\nconst router = express.Router();\n\n// åº”ç”¨è®¤è¯ä¸­é—´ä»¶åˆ°æ‰€æœ‰è·¯ç”±\nrouter.use(authMiddleware);\n\n// å¸¸é‡å®šä¹‰\nconst DIGITAL_TWIN_CONSTANTS = {\n  MAX_MODELS_PER_PAGE: 50,\n  DEFAULT_PAGE_SIZE: 20,\n  MODEL_TYPES: ['building', 'equipment', 'system', 'zone', 'component'],\n  MODEL_STATUS: ['active', 'inactive', 'maintenance', 'error'],\n  SIMULATION_TYPES: ['energy', 'thermal', 'airflow', 'lighting', 'structural'],\n  VIEW_PRESETS: ['overview', 'energy_view', 'maintenance_view', 'security_view', 'custom'],\n  SUPPORTED_FORMATS: ['gltf', 'fbx', 'obj', 'ifc'],\n  MAX_FILE_SIZE: 100 * 1024 * 1024 // 100MB\n};\n\n// éªŒè¯è§„åˆ™\nconst digitalTwinValidation = [\n  body('name').notEmpty().withMessage('æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º'),\n  body('type').isIn(DIGITAL_TWIN_CONSTANTS.MODEL_TYPES).withMessage('æ¨¡å‹ç±»å‹æ— æ•ˆ'),\n  body('description').optional().isString().withMessage('æè¿°å¿…é¡»æ˜¯å­—ç¬¦ä¸²'),\n  body('modelPath').notEmpty().withMessage('æ¨¡å‹è·¯å¾„ä¸èƒ½ä¸ºç©º'),\n  body('position').optional().isObject().withMessage('ä½ç½®ä¿¡æ¯å¿…é¡»æ˜¯å¯¹è±¡'),\n  body('rotation').optional().isObject().withMessage('æ—‹è½¬ä¿¡æ¯å¿…é¡»æ˜¯å¯¹è±¡'),\n  body('scale').optional().isObject().withMessage('ç¼©æ”¾ä¿¡æ¯å¿…é¡»æ˜¯å¯¹è±¡'),\n  body('metadata').optional().isObject().withMessage('å…ƒæ•°æ®å¿…é¡»æ˜¯å¯¹è±¡')\n];\n\nconst simulationValidation = [\n  body('modelId').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ'),\n  body('simulationType').isIn(DIGITAL_TWIN_CONSTANTS.SIMULATION_TYPES).withMessage('ä»¿çœŸç±»å‹æ— æ•ˆ'),\n  body('parameters').isObject().withMessage('å‚æ•°å¿…é¡»æ˜¯å¯¹è±¡'),\n  body('duration').optional().isNumeric().withMessage('æŒç»­æ—¶é—´å¿…é¡»æ˜¯æ•°å­—'),\n  body('timeStep').optional().isNumeric().withMessage('æ—¶é—´æ­¥é•¿å¿…é¡»æ˜¯æ•°å­—')\n];\n\nconst viewPresetValidation = [\n  body('name').notEmpty().withMessage('è§†å›¾åç§°ä¸èƒ½ä¸ºç©º'),\n  body('type').isIn(DIGITAL_TWIN_CONSTANTS.VIEW_PRESETS).withMessage('è§†å›¾ç±»å‹æ— æ•ˆ'),\n  body('cameraPosition').isObject().withMessage('ç›¸æœºä½ç½®å¿…é¡»æ˜¯å¯¹è±¡'),\n  body('cameraTarget').isObject().withMessage('ç›¸æœºç›®æ ‡å¿…é¡»æ˜¯å¯¹è±¡'),\n  body('visibleLayers').optional().isArray().withMessage('å¯è§å›¾å±‚å¿…é¡»æ˜¯æ•°ç»„'),\n  body('settings').optional().isObject().withMessage('è®¾ç½®å¿…é¡»æ˜¯å¯¹è±¡')\n];\n\n// è·å–æ•°å­—å­ªç”Ÿæ¨¡å‹åˆ—è¡¨\nrouter.get(\n  '/models',\n  [\n    query('type').optional().isIn(DIGITAL_TWIN_CONSTANTS.MODEL_TYPES).withMessage('æ¨¡å‹ç±»å‹æ— æ•ˆ'),\n    query('status')\n      .optional()\n      .isIn(DIGITAL_TWIN_CONSTANTS.MODEL_STATUS)\n      .withMessage('æ¨¡å‹çŠ¶æ€æ— æ•ˆ'),\n    query('search').optional().isString().withMessage('æœç´¢å…³é”®è¯å¿…é¡»æ˜¯å­—ç¬¦ä¸²')\n  ],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const {\n        page = 1,\n        limit = DIGITAL_TWIN_CONSTANTS.DEFAULT_PAGE_SIZE,\n        type,\n        status,\n        search\n      } = req.query;\n\n      const filters = {};\n      if (type) {filters.type = type;}\n      if (status) {filters.status = status;}\n      if (search) {\n        filters.$or = [\n          { name: { $regex: search, $options: 'i' } },\n          { description: { $regex: search, $options: 'i' } }\n        ];\n      }\n\n      const offset = (page - 1) * limit;\n      const models = await DigitalTwinModel.findWithPagination(filters, offset, parseInt(limit));\n      const total = await DigitalTwinModel.countDocuments(filters);\n\n      responseFormatter.success(res, 'è·å–æ•°å­—å­ªç”Ÿæ¨¡å‹åˆ—è¡¨æˆåŠŸ', {\n        models,\n        pagination: {\n          page: parseInt(page),\n          limit: parseInt(limit),\n          total,\n          pages: Math.ceil(total / limit)\n        }\n      });\n    } catch (error) {\n      console.error('è·å–æ•°å­—å­ªç”Ÿæ¨¡å‹åˆ—è¡¨é”™è¯¯:', error);\n      responseFormatter.error(res, 'è·å–æ•°å­—å­ªç”Ÿæ¨¡å‹åˆ—è¡¨å¤±è´¥', 500);\n    }\n  }\n);\n\n// è·å–å•ä¸ªæ•°å­—å­ªç”Ÿæ¨¡å‹è¯¦æƒ…\nrouter.get(\n  '/models/:id',\n  [param('id').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ')],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const model = await DigitalTwinModel.findByIdWithDetails(req.params.id);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      responseFormatter.success(res, 'è·å–æ•°å­—å­ªç”Ÿæ¨¡å‹è¯¦æƒ…æˆåŠŸ', { model });\n    } catch (error) {\n      console.error('è·å–æ•°å­—å­ªç”Ÿæ¨¡å‹è¯¦æƒ…é”™è¯¯:', error);\n      responseFormatter.error(res, 'è·å–æ•°å­—å­ªç”Ÿæ¨¡å‹è¯¦æƒ…å¤±è´¥', 500);\n    }\n  }\n);\n\n// åˆ›å»ºæ•°å­—å­ªç”Ÿæ¨¡å‹\nrouter.post(\n  '/models',\n  requireRole(['admin', 'operator']),\n  digitalTwinValidation,\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const modelData = {\n        ...req.body,\n        status: 'active',\n        createdBy: req.user.userId,\n        createdAt: new Date(),\n        version: '1.0.0'\n      };\n\n      // æ£€æŸ¥æ¨¡å‹åç§°æ˜¯å¦å·²å­˜åœ¨\n      const existingModel = await DigitalTwinModel.findByName(modelData.name);\n      if (existingModel) {\n        return responseFormatter.error(res, 'æ¨¡å‹åç§°å·²å­˜åœ¨', 409);\n      }\n\n      const newModel = await DigitalTwinModel.create(modelData);\n\n      responseFormatter.success(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹åˆ›å»ºæˆåŠŸ', { model: newModel }, 201);\n    } catch (error) {\n      console.error('åˆ›å»ºæ•°å­—å­ªç”Ÿæ¨¡å‹é”™è¯¯:', error);\n      responseFormatter.error(res, 'åˆ›å»ºæ•°å­—å­ªç”Ÿæ¨¡å‹å¤±è´¥', 500);\n    }\n  }\n);\n\n// æ›´æ–°æ•°å­—å­ªç”Ÿæ¨¡å‹\nrouter.put(\n  '/models/:id',\n  requireRole(['admin', 'operator']),\n  [\n    param('id').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ'),\n    ...digitalTwinValidation.map((rule) => rule.optional())\n  ],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const model = await DigitalTwinModel.findById(req.params.id);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      // å¦‚æœæ›´æ–°æ¨¡å‹åç§°ï¼Œæ£€æŸ¥æ˜¯å¦é‡å¤\n      if (req.body.name && req.body.name !== model.name) {\n        const existingModel = await DigitalTwinModel.findByName(req.body.name);\n        if (existingModel) {\n          return responseFormatter.error(res, 'æ¨¡å‹åç§°å·²å­˜åœ¨', 409);\n        }\n      }\n\n      const updateData = {\n        ...req.body,\n        updatedBy: req.user.userId,\n        updatedAt: new Date()\n      };\n\n      const updatedModel = await model.update(updateData);\n\n      responseFormatter.success(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹æ›´æ–°æˆåŠŸ', { model: updatedModel });\n    } catch (error) {\n      console.error('æ›´æ–°æ•°å­—å­ªç”Ÿæ¨¡å‹é”™è¯¯:', error);\n      responseFormatter.error(res, 'æ›´æ–°æ•°å­—å­ªç”Ÿæ¨¡å‹å¤±è´¥', 500);\n    }\n  }\n);\n\n// åˆ é™¤æ•°å­—å­ªç”Ÿæ¨¡å‹\nrouter.delete(\n  '/models/:id',\n  requireRole(['admin']),\n  [param('id').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ')],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const model = await DigitalTwinModel.findById(req.params.id);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      // æ£€æŸ¥æ¨¡å‹æ˜¯å¦æœ‰å…³è”çš„è®¾å¤‡æˆ–ä»¿çœŸ\n      const hasAssociations = await model.hasAssociations();\n      if (hasAssociations) {\n        return responseFormatter.error(res, 'æ¨¡å‹å­˜åœ¨å…³è”æ•°æ®ï¼Œæ— æ³•åˆ é™¤', 409);\n      }\n\n      await model.delete();\n\n      responseFormatter.success(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹åˆ é™¤æˆåŠŸ');\n    } catch (error) {\n      console.error('åˆ é™¤æ•°å­—å­ªç”Ÿæ¨¡å‹é”™è¯¯:', error);\n      responseFormatter.error(res, 'åˆ é™¤æ•°å­—å­ªç”Ÿæ¨¡å‹å¤±è´¥', 500);\n    }\n  }\n);\n\n// è·å–æ¨¡å‹å…³è”çš„è®¾å¤‡\nrouter.get(\n  '/models/:id/devices',\n  [param('id').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ')],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const model = await DigitalTwinModel.findById(req.params.id);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      const devices = await model.getAssociatedDevices();\n\n      responseFormatter.success(res, 'è·å–å…³è”è®¾å¤‡æˆåŠŸ', { devices });\n    } catch (error) {\n      console.error('è·å–å…³è”è®¾å¤‡é”™è¯¯:', error);\n      responseFormatter.error(res, 'è·å–å…³è”è®¾å¤‡å¤±è´¥', 500);\n    }\n  }\n);\n\n// å…³è”è®¾å¤‡åˆ°æ¨¡å‹\nrouter.post(\n  '/models/:id/devices',\n  requireRole(['admin', 'operator']),\n  [\n    param('id').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ'),\n    body('deviceIds').isArray().withMessage('è®¾å¤‡IDåˆ—è¡¨å¿…é¡»æ˜¯æ•°ç»„'),\n    body('deviceIds.*').isMongoId().withMessage('è®¾å¤‡IDæ ¼å¼æ— æ•ˆ')\n  ],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const model = await DigitalTwinModel.findById(req.params.id);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      const { deviceIds } = req.body;\n\n      // éªŒè¯æ‰€æœ‰è®¾å¤‡æ˜¯å¦å­˜åœ¨\n      const devices = await Device.findByIds(deviceIds);\n      if (devices.length !== deviceIds.length) {\n        return responseFormatter.error(res, 'éƒ¨åˆ†è®¾å¤‡ä¸å­˜åœ¨', 404);\n      }\n\n      await model.associateDevices(deviceIds, req.user.userId);\n\n      responseFormatter.success(res, 'è®¾å¤‡å…³è”æˆåŠŸ');\n    } catch (error) {\n      console.error('å…³è”è®¾å¤‡é”™è¯¯:', error);\n      responseFormatter.error(res, 'å…³è”è®¾å¤‡å¤±è´¥', 500);\n    }\n  }\n);\n\n// è¿è¡Œä»¿çœŸ\nrouter.post(\n  '/simulations',\n  requireRole(['admin', 'operator']),\n  simulationValidation,\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const { modelId, simulationType, parameters, duration = 3600, timeStep = 60 } = req.body;\n\n      // éªŒè¯æ¨¡å‹æ˜¯å¦å­˜åœ¨\n      const model = await DigitalTwinModel.findById(modelId);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      if (model.status !== 'active') {\n        return responseFormatter.error(res, 'æ¨¡å‹çŠ¶æ€ä¸å…è®¸è¿è¡Œä»¿çœŸ', 400);\n      }\n\n      const simulationData = {\n        modelId,\n        simulationType,\n        parameters,\n        duration,\n        timeStep,\n        status: 'running',\n        startedBy: req.user.userId,\n        startedAt: new Date()\n      };\n\n      const simulation = await model.runSimulation(simulationData);\n\n      responseFormatter.success(res, 'ä»¿çœŸå¯åŠ¨æˆåŠŸ', { simulation }, 201);\n    } catch (error) {\n      console.error('è¿è¡Œä»¿çœŸé”™è¯¯:', error);\n      responseFormatter.error(res, 'è¿è¡Œä»¿çœŸå¤±è´¥', 500);\n    }\n  }\n);\n\n// è·å–ä»¿çœŸç»“æœ\nrouter.get(\n  '/simulations/:id/results',\n  [param('id').isMongoId().withMessage('ä»¿çœŸIDæ ¼å¼æ— æ•ˆ')],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const simulation = await DigitalTwinModel.getSimulationResults(req.params.id);\n      if (!simulation) {\n        return responseFormatter.error(res, 'ä»¿çœŸä¸å­˜åœ¨', 404);\n      }\n\n      responseFormatter.success(res, 'è·å–ä»¿çœŸç»“æœæˆåŠŸ', { simulation });\n    } catch (error) {\n      console.error('è·å–ä»¿çœŸç»“æœé”™è¯¯:', error);\n      responseFormatter.error(res, 'è·å–ä»¿çœŸç»“æœå¤±è´¥', 500);\n    }\n  }\n);\n\n// è·å–è§†å›¾é¢„è®¾åˆ—è¡¨\nrouter.get(\n  '/view-presets',\n  [query('type').optional().isIn(DIGITAL_TWIN_CONSTANTS.VIEW_PRESETS).withMessage('è§†å›¾ç±»å‹æ— æ•ˆ')],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const { type } = req.query;\n      const filters = {};\n      if (type) {filters.type = type;}\n\n      const presets = await DigitalTwinModel.getViewPresets(filters);\n\n      responseFormatter.success(res, 'è·å–è§†å›¾é¢„è®¾æˆåŠŸ', { presets });\n    } catch (error) {\n      console.error('è·å–è§†å›¾é¢„è®¾é”™è¯¯:', error);\n      responseFormatter.error(res, 'è·å–è§†å›¾é¢„è®¾å¤±è´¥', 500);\n    }\n  }\n);\n\n// åˆ›å»ºè§†å›¾é¢„è®¾\nrouter.post(\n  '/view-presets',\n  requireRole(['admin', 'operator']),\n  viewPresetValidation,\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const presetData = {\n        ...req.body,\n        createdBy: req.user.userId,\n        createdAt: new Date()\n      };\n\n      const newPreset = await DigitalTwinModel.createViewPreset(presetData);\n\n      responseFormatter.success(res, 'è§†å›¾é¢„è®¾åˆ›å»ºæˆåŠŸ', { preset: newPreset }, 201);\n    } catch (error) {\n      console.error('åˆ›å»ºè§†å›¾é¢„è®¾é”™è¯¯:', error);\n      responseFormatter.error(res, 'åˆ›å»ºè§†å›¾é¢„è®¾å¤±è´¥', 500);\n    }\n  }\n);\n\n// è·å–æ¨¡å‹æ€§èƒ½ç»Ÿè®¡\nrouter.get(\n  '/models/:id/performance',\n  [param('id').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ')],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const model = await DigitalTwinModel.findById(req.params.id);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      const performance = await model.getPerformanceMetrics();\n\n      responseFormatter.success(res, 'è·å–æ¨¡å‹æ€§èƒ½ç»Ÿè®¡æˆåŠŸ', { performance });\n    } catch (error) {\n      console.error('è·å–æ¨¡å‹æ€§èƒ½ç»Ÿè®¡é”™è¯¯:', error);\n      responseFormatter.error(res, 'è·å–æ¨¡å‹æ€§èƒ½ç»Ÿè®¡å¤±è´¥', 500);\n    }\n  }\n);\n\n// ä¼˜åŒ–æ¨¡å‹\nrouter.post(\n  '/models/:id/optimize',\n  requireRole(['admin', 'operator']),\n  [\n    param('id').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ'),\n    body('optimizationType')\n      .isIn(['lod', 'texture', 'geometry', 'all'])\n      .withMessage('ä¼˜åŒ–ç±»å‹æ— æ•ˆ'),\n    body('targetQuality').optional().isIn(['low', 'medium', 'high']).withMessage('ç›®æ ‡è´¨é‡æ— æ•ˆ')\n  ],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const model = await DigitalTwinModel.findById(req.params.id);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      const { optimizationType, targetQuality = 'medium' } = req.body;\n\n      const optimizationResult = await model.optimize({\n        type: optimizationType,\n        quality: targetQuality,\n        optimizedBy: req.user.userId\n      });\n\n      responseFormatter.success(res, 'æ¨¡å‹ä¼˜åŒ–å®Œæˆ', { result: optimizationResult });\n    } catch (error) {\n      console.error('ä¼˜åŒ–æ¨¡å‹é”™è¯¯:', error);\n      responseFormatter.error(res, 'ä¼˜åŒ–æ¨¡å‹å¤±è´¥', 500);\n    }\n  }\n);\n\n// è·å–æ¨¡å‹ç»Ÿè®¡æ•°æ®\nrouter.get('/stats/summary', async (req, res) => {\n  try {\n    const stats = await DigitalTwinModel.getStatistics();\n\n    responseFormatter.success(res, 'è·å–æ¨¡å‹ç»Ÿè®¡æ•°æ®æˆåŠŸ', { stats });\n  } catch (error) {\n    console.error('è·å–æ¨¡å‹ç»Ÿè®¡æ•°æ®é”™è¯¯:', error);\n    responseFormatter.error(res, 'è·å–æ¨¡å‹ç»Ÿè®¡æ•°æ®å¤±è´¥', 500);\n  }\n});\n\n// å¯¼å‡ºæ¨¡å‹é…ç½®\nrouter.get(\n  '/models/:id/export',\n  [\n    param('id').isMongoId().withMessage('æ¨¡å‹IDæ ¼å¼æ— æ•ˆ'),\n    query('format').optional().isIn(['json', 'xml']).withMessage('å¯¼å‡ºæ ¼å¼æ— æ•ˆ')\n  ],\n  async (req, res) => {\n    try {\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return responseFormatter.error(res, 'è¾“å…¥éªŒè¯å¤±è´¥', 400, errors.array());\n      }\n\n      const model = await DigitalTwinModel.findById(req.params.id);\n      if (!model) {\n        return responseFormatter.error(res, 'æ•°å­—å­ªç”Ÿæ¨¡å‹ä¸å­˜åœ¨', 404);\n      }\n\n      const { format = 'json' } = req.query;\n      const exportData = await model.exportConfiguration(format);\n\n      const contentType = format === 'xml' ? 'application/xml' : 'application/json';\n      const filename = `model-${model.name}-config.${format}`;\n\n      res.setHeader('Content-Type', contentType);\n      res.setHeader('Content-Disposition', `attachment; filename=${filename}`);\n      res.send(exportData);\n    } catch (error) {\n      console.error('å¯¼å‡ºæ¨¡å‹é…ç½®é”™è¯¯:', error);\n      responseFormatter.error(res, 'å¯¼å‡ºæ¨¡å‹é…ç½®å¤±è´¥', 500);\n    }\n  }\n);\n\nmodule.exports = router;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/routes/energy.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/routes/maintenance.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/interfaces/http/validators/commonValidators.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 255.","line":132,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":132,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":141,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":141,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4102444800000.","line":227,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":227,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":234,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":234,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":234,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":234,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":234,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":234,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":237,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":237,"endColumn":64},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":237,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":237,"endColumn":71}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * é€šç”¨éªŒè¯å™¨\n * æä¾›å¸¸ç”¨çš„æ•°æ®éªŒè¯è§„åˆ™å’Œè‡ªå®šä¹‰éªŒè¯å™¨\n */\n\nconst { body, param, query, validationResult } = require('express-validator');\nconst responseFormatter = require('../middleware/responseFormatter');\n\n// å¸¸ç”¨æ­£åˆ™è¡¨è¾¾å¼\nconst REGEX_PATTERNS = {\n  // ç”¨æˆ·åï¼š3-20ä½å­—æ¯æ•°å­—ä¸‹åˆ’çº¿\n  USERNAME: /^[a-zA-Z0-9_]{3,20}$/,\n  // å¯†ç ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—\n  PASSWORD: /^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d@$!%*#?&]{8,}$/,\n  // é‚®ç®±\n  EMAIL: /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/,\n  // æ‰‹æœºå·ï¼ˆä¸­å›½ï¼‰\n  PHONE: /^1[3-9]\\d{9}$/,\n  // IPv4åœ°å€\n  IPV4: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,\n  // MACåœ°å€\n  MAC: /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/,\n  // è®¾å¤‡åºåˆ—å·\n  DEVICE_SERIAL: /^[A-Z0-9]{8,20}$/,\n  // ç‰ˆæœ¬å·\n  VERSION: /^\\d+\\.\\d+\\.\\d+$/\n};\n\n// å¸¸ç”¨éªŒè¯è§„åˆ™\nconst VALIDATION_RULES = {\n  // IDéªŒè¯\n  id: param('id').isInt({ min: 1 }).withMessage('IDå¿…é¡»æ˜¯æ­£æ•´æ•°'),\n\n  // UUIDéªŒè¯\n  uuid: param('id').isUUID().withMessage('IDå¿…é¡»æ˜¯æœ‰æ•ˆçš„UUID'),\n\n  // åˆ†é¡µå‚æ•°éªŒè¯\n  pagination: [\n    query('page').optional().isInt({ min: 1 }).withMessage('é¡µç å¿…é¡»æ˜¯æ­£æ•´æ•°').toInt(),\n    query('limit')\n      .optional()\n      .isInt({ min: 1, max: 100 })\n      .withMessage('æ¯é¡µæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´')\n      .toInt(),\n    query('offset').optional().isInt({ min: 0 }).withMessage('åç§»é‡å¿…é¡»æ˜¯éè´Ÿæ•´æ•°').toInt()\n  ],\n\n  // æ’åºå‚æ•°éªŒè¯\n  sorting: [\n    query('sortBy')\n      .optional()\n      .isString()\n      .isLength({ min: 1, max: 50 })\n      .withMessage('æ’åºå­—æ®µé•¿åº¦å¿…é¡»åœ¨1-50ä¹‹é—´'),\n    query('sortOrder')\n      .optional()\n      .isIn(['asc', 'desc', 'ASC', 'DESC'])\n      .withMessage('æ’åºæ–¹å‘å¿…é¡»æ˜¯ascæˆ–desc')\n  ],\n\n  // æ—¥æœŸèŒƒå›´éªŒè¯\n  dateRange: [\n    query('startDate').optional().isISO8601().withMessage('å¼€å§‹æ—¥æœŸæ ¼å¼æ— æ•ˆ').toDate(),\n    query('endDate')\n      .optional()\n      .isISO8601()\n      .withMessage('ç»“æŸæ—¥æœŸæ ¼å¼æ— æ•ˆ')\n      .toDate()\n      .custom((value, { req }) => {\n        if (req.query.startDate && value < new Date(req.query.startDate)) {\n          throw new Error('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ');\n        }\n        return true;\n      })\n  ],\n\n  // æœç´¢å‚æ•°éªŒè¯\n  search: [\n    query('keyword')\n      .optional()\n      .isString()\n      .isLength({ min: 1, max: 100 })\n      .withMessage('æœç´¢å…³é”®è¯é•¿åº¦å¿…é¡»åœ¨1-100ä¹‹é—´')\n      .trim()\n      .escape(),\n    query('searchFields').optional().isString().withMessage('æœç´¢å­—æ®µå¿…é¡»æ˜¯å­—ç¬¦ä¸²')\n  ],\n\n  // ç”¨æˆ·åéªŒè¯\n  username: body('username')\n    .matches(REGEX_PATTERNS.USERNAME)\n    .withMessage('ç”¨æˆ·åå¿…é¡»æ˜¯3-20ä½å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿'),\n\n  // å¯†ç éªŒè¯\n  password: body('password')\n    .matches(REGEX_PATTERNS.PASSWORD)\n    .withMessage('å¯†ç è‡³å°‘8ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—'),\n\n  // é‚®ç®±éªŒè¯\n  email: body('email').isEmail().normalizeEmail().withMessage('é‚®ç®±æ ¼å¼æ— æ•ˆ'),\n\n  // æ‰‹æœºå·éªŒè¯\n  phone: body('phone').optional().matches(REGEX_PATTERNS.PHONE).withMessage('æ‰‹æœºå·æ ¼å¼æ— æ•ˆ'),\n\n  // è§’è‰²éªŒè¯\n  role: body('role')\n    .isIn(['admin', 'operator', 'user', 'guest'])\n    .withMessage('è§’è‰²å¿…é¡»æ˜¯adminã€operatorã€useræˆ–guestä¹‹ä¸€'),\n\n  // çŠ¶æ€éªŒè¯\n  status: body('status')\n    .isIn(['active', 'inactive', 'pending', 'suspended'])\n    .withMessage('çŠ¶æ€å¿…é¡»æ˜¯activeã€inactiveã€pendingæˆ–suspendedä¹‹ä¸€'),\n\n  // å¸ƒå°”å€¼éªŒè¯\n  boolean: (field) => body(field).isBoolean().withMessage(`${field}å¿…é¡»æ˜¯å¸ƒå°”å€¼`).toBoolean(),\n\n  // æ•°å­—éªŒè¯\n  number: (field, min = 0, max = Number.MAX_SAFE_INTEGER) =>\n    body(field)\n      .isNumeric()\n      .withMessage(`${field}å¿…é¡»æ˜¯æ•°å­—`)\n      .isFloat({ min, max })\n      .withMessage(`${field}å¿…é¡»åœ¨${min}-${max}ä¹‹é—´`)\n      .toFloat(),\n\n  // æ•´æ•°éªŒè¯\n  integer: (field, min = 0, max = Number.MAX_SAFE_INTEGER) =>\n    body(field).isInt({ min, max }).withMessage(`${field}å¿…é¡»æ˜¯${min}-${max}ä¹‹é—´çš„æ•´æ•°`).toInt(),\n\n  // å­—ç¬¦ä¸²éªŒè¯\n  string: (field, minLength = 1, maxLength = 255) =>\n    body(field)\n      .isString()\n      .withMessage(`${field}å¿…é¡»æ˜¯å­—ç¬¦ä¸²`)\n      .isLength({ min: minLength, max: maxLength })\n      .withMessage(`${field}é•¿åº¦å¿…é¡»åœ¨${minLength}-${maxLength}ä¹‹é—´`)\n      .trim(),\n\n  // æ•°ç»„éªŒè¯\n  array: (field, minLength = 0, maxLength = 100) =>\n    body(field)\n      .isArray({ min: minLength, max: maxLength })\n      .withMessage(`${field}å¿…é¡»æ˜¯åŒ…å«${minLength}-${maxLength}ä¸ªå…ƒç´ çš„æ•°ç»„`),\n\n  // JSONéªŒè¯\n  json: (field) =>\n    body(field).custom((value) => {\n      try {\n        JSON.parse(typeof value === 'string' ? value : JSON.stringify(value));\n        return true;\n      } catch (error) {\n        throw new Error(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼`);\n      }\n    })\n};\n\n// è‡ªå®šä¹‰éªŒè¯å™¨\nconst CUSTOM_VALIDATORS = {\n  // éªŒè¯è®¾å¤‡åºåˆ—å·\n  deviceSerial: body('serialNumber')\n    .matches(REGEX_PATTERNS.DEVICE_SERIAL)\n    .withMessage('è®¾å¤‡åºåˆ—å·æ ¼å¼æ— æ•ˆ'),\n\n  // éªŒè¯IPåœ°å€\n  ipAddress: (field) =>\n    body(field).matches(REGEX_PATTERNS.IPV4).withMessage(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„IPv4åœ°å€`),\n\n  // éªŒè¯MACåœ°å€\n  macAddress: (field) =>\n    body(field).matches(REGEX_PATTERNS.MAC).withMessage(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„MACåœ°å€`),\n\n  // éªŒè¯ç‰ˆæœ¬å·\n  version: (field) =>\n    body(field)\n      .matches(REGEX_PATTERNS.VERSION)\n      .withMessage(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼ï¼ˆå¦‚1.0.0ï¼‰`),\n\n  // éªŒè¯èƒ½è€—å€¼\n  energyValue: body('value').isFloat({ min: 0 }).withMessage('èƒ½è€—å€¼å¿…é¡»æ˜¯éè´Ÿæ•°').toFloat(),\n\n  // éªŒè¯ç¢³æ’æ”¾å› å­\n  carbonFactor: body('factor')\n    .isFloat({ min: 0, max: 10 })\n    .withMessage('ç¢³æ’æ”¾å› å­å¿…é¡»åœ¨0-10ä¹‹é—´')\n    .toFloat(),\n\n  // éªŒè¯æ¸©åº¦å€¼\n  temperature: (field) =>\n    body(field)\n      .isFloat({ min: -273.15, max: 1000 })\n      .withMessage(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ¸©åº¦å€¼ï¼ˆ-273.15Â°Cåˆ°1000Â°Cï¼‰`)\n      .toFloat(),\n\n  // éªŒè¯æ¹¿åº¦å€¼\n  humidity: (field) =>\n    body(field)\n      .isFloat({ min: 0, max: 100 })\n      .withMessage(`${field}å¿…é¡»æ˜¯0-100ä¹‹é—´çš„æ¹¿åº¦å€¼`)\n      .toFloat(),\n\n  // éªŒè¯åŠŸç‡å€¼\n  power: (field) =>\n    body(field).isFloat({ min: 0 }).withMessage(`${field}å¿…é¡»æ˜¯éè´Ÿçš„åŠŸç‡å€¼`).toFloat(),\n\n  // éªŒè¯ç»çº¬åº¦\n  latitude: (field) =>\n    body(field)\n      .isFloat({ min: -90, max: 90 })\n      .withMessage(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„çº¬åº¦å€¼ï¼ˆ-90åˆ°90ï¼‰`)\n      .toFloat(),\n\n  longitude: (field) =>\n    body(field)\n      .isFloat({ min: -180, max: 180 })\n      .withMessage(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„ç»åº¦å€¼ï¼ˆ-180åˆ°180ï¼‰`)\n      .toFloat(),\n\n  // éªŒè¯æ—¶é—´æˆ³\n  timestamp: (field) =>\n    body(field).custom((value) => {\n      const timestamp = new Date(value).getTime();\n      if (isNaN(timestamp)) {\n        throw new Error(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ—¶é—´æˆ³`);\n      }\n      // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…ï¼ˆ1970å¹´åˆ°2100å¹´ï¼‰\n      if (timestamp < 0 || timestamp > 4102444800000) {\n        throw new Error(`${field}æ—¶é—´æˆ³è¶…å‡ºæœ‰æ•ˆèŒƒå›´`);\n      }\n      return true;\n    }),\n\n  // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰\n  fileSize: (field, maxSize = 10 * 1024 * 1024) =>\n    body(field)\n      .isInt({ min: 0, max: maxSize })\n      .withMessage(`${field}æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡${Math.round(maxSize / 1024 / 1024)}MB`)\n      .toInt(),\n\n  // éªŒè¯é¢œè‰²å€¼ï¼ˆåå…­è¿›åˆ¶ï¼‰\n  hexColor: (field) =>\n    body(field)\n      .matches(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/)\n      .withMessage(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„åå…­è¿›åˆ¶é¢œè‰²å€¼`),\n\n  // éªŒè¯URL\n  url: (field) =>\n    body(field)\n      .isURL({\n        protocols: ['http', 'https'],\n        require_protocol: true\n      })\n      .withMessage(`${field}å¿…é¡»æ˜¯æœ‰æ•ˆçš„URLåœ°å€`),\n\n  // éªŒè¯è®¾å¤‡ç±»å‹\n  deviceType: body('type')\n    .isIn(['sensor', 'actuator', 'controller', 'gateway', 'meter', 'camera', 'other'])\n    .withMessage('è®¾å¤‡ç±»å‹å¿…é¡»æ˜¯sensorã€actuatorã€controllerã€gatewayã€meterã€cameraæˆ–otherä¹‹ä¸€'),\n\n  // éªŒè¯èƒ½æºç±»å‹\n  energyType: body('energyType')\n    .isIn(['electricity', 'gas', 'water', 'steam', 'coal', 'oil', 'solar', 'wind', 'other'])\n    .withMessage('èƒ½æºç±»å‹æ— æ•ˆ'),\n\n  // éªŒè¯å•ä½\n  unit: body('unit')\n    .isIn(['kWh', 'MWh', 'GWh', 'mÂ³', 'L', 'kg', 't', 'J', 'kJ', 'MJ', 'GJ'])\n    .withMessage('å•ä½æ— æ•ˆ'),\n\n  // éªŒè¯ä¼˜å…ˆçº§\n  priority: body('priority')\n    .isIn(['low', 'medium', 'high', 'critical'])\n    .withMessage('ä¼˜å…ˆçº§å¿…é¡»æ˜¯lowã€mediumã€highæˆ–criticalä¹‹ä¸€'),\n\n  // éªŒè¯ç»´æŠ¤ç±»å‹\n  maintenanceType: body('type')\n    .isIn(['preventive', 'corrective', 'predictive', 'emergency'])\n    .withMessage('ç»´æŠ¤ç±»å‹å¿…é¡»æ˜¯preventiveã€correctiveã€predictiveæˆ–emergencyä¹‹ä¸€')\n};\n\n/**\n * éªŒè¯ç»“æœå¤„ç†ä¸­é—´ä»¶\n * æ£€æŸ¥éªŒè¯ç»“æœï¼Œå¦‚æœæœ‰é”™è¯¯åˆ™è¿”å›é”™è¯¯å“åº”\n */\nfunction handleValidationErrors(req, res, next) {\n  const errors = validationResult(req);\n\n  if (!errors.isEmpty()) {\n    const formattedErrors = errors.array().map((error) => ({\n      field: error.param,\n      message: error.msg,\n      value: error.value,\n      location: error.location\n    }));\n\n    return responseFormatter.validationError(res, 'æ•°æ®éªŒè¯å¤±è´¥', formattedErrors);\n  }\n\n  next();\n}\n\n/**\n * åˆ›å»ºéªŒè¯é“¾\n * @param {Array} validators - éªŒè¯å™¨æ•°ç»„\n * @returns {Array} åŒ…å«éªŒè¯å™¨å’Œé”™è¯¯å¤„ç†çš„å®Œæ•´éªŒè¯é“¾\n */\nfunction createValidationChain(validators) {\n  return [...validators, handleValidationErrors];\n}\n\n/**\n * æ¡ä»¶éªŒè¯\n * @param {Function} condition - æ¡ä»¶å‡½æ•°\n * @param {Array} validators - å½“æ¡ä»¶ä¸ºçœŸæ—¶åº”ç”¨çš„éªŒè¯å™¨\n * @returns {Function} æ¡ä»¶éªŒè¯ä¸­é—´ä»¶\n */\nfunction conditionalValidation(condition, validators) {\n  const runNext = function(req, res, next, validationChain, index) {\n    if (index >= validationChain.length) {\n      return next();\n    }\n\n    const validator = validationChain[index];\n    validator(req, res, () => runNext(req, res, next, validationChain, index + 1));\n  };\n\n  return (req, res, next) => {\n    if (condition(req)) {\n      // åº”ç”¨éªŒè¯å™¨\n      const validationChain = createValidationChain(validators);\n      runNext(req, res, next, validationChain, 0);\n    } else {\n      next();\n    }\n  };\n}\n\n/**\n * æ‰¹é‡éªŒè¯\n * @param {Object} validationRules - éªŒè¯è§„åˆ™å¯¹è±¡\n * @returns {Array} éªŒè¯å™¨æ•°ç»„\n */\nfunction batchValidation(validationRules) {\n  const validators = [];\n\n  for (const [_field, rules] of Object.entries(validationRules)) {\n    if (Array.isArray(rules)) {\n      validators.push(...rules);\n    } else {\n      validators.push(rules);\n    }\n  }\n\n  return createValidationChain(validators);\n}\n\n/**\n * è‡ªå®šä¹‰éªŒè¯å™¨å·¥å‚\n * @param {Function} validatorFn - éªŒè¯å‡½æ•°\n * @param {string} errorMessage - é”™è¯¯æ¶ˆæ¯\n * @returns {Function} è‡ªå®šä¹‰éªŒè¯å™¨\n */\nfunction customValidator(validatorFn, errorMessage) {\n  return (field) => body(field).custom(validatorFn).withMessage(errorMessage);\n}\n\nmodule.exports = {\n  REGEX_PATTERNS,\n  VALIDATION_RULES,\n  CUSTOM_VALIDATORS,\n  handleValidationErrors,\n  createValidationChain,\n  conditionalValidation,\n  batchValidation,\n  customValidator\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/cache/CacheManager.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":100,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":100,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":240,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":240,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60000.","line":284,"column":4,"nodeType":"Literal","messageId":"noMagic","endLine":284,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import logger from '../utils/logger.js';\n\n/**\n * ç¼“å­˜ç®¡ç†å™¨\n * æ”¯æŒå†…å­˜ç¼“å­˜å’ŒRedisç¼“å­˜\n */\nclass CacheManager {\n  constructor() {\n    this.memoryCache = new Map();\n    this.redisClient = null;\n    this.defaultTTL = 3600; // é»˜è®¤1å°æ—¶\n    this.maxMemoryItems = 1000; // å†…å­˜ç¼“å­˜æœ€å¤§æ¡ç›®æ•°\n\n    this.initializeRedis();\n  }\n\n  /**\n   * åˆå§‹åŒ–Redisè¿æ¥\n   */\n  async initializeRedis() {\n    try {\n      // å°è¯•å¯¼å…¥Rediså®¢æˆ·ç«¯\n      const redisClient = await import('../../database/redisClient.js');\n      this.redisClient = redisClient.default;\n      logger.info('Redisç¼“å­˜å·²å¯ç”¨');\n    } catch (error) {\n      logger.warn('Redisä¸å¯ç”¨ï¼Œä½¿ç”¨å†…å­˜ç¼“å­˜', { error: error.message });\n    }\n  }\n\n  /**\n   * è·å–ç¼“å­˜å€¼\n   * @param {string} key - ç¼“å­˜é”®\n   * @returns {Promise<any>} ç¼“å­˜å€¼\n   */\n  async get(key) {\n    try {\n      // ä¼˜å…ˆä½¿ç”¨Redis\n      if (this.redisClient) {\n        const value = await this.redisClient.get(key);\n        if (value !== null) {\n          return JSON.parse(value);\n        }\n      }\n\n      // å›é€€åˆ°å†…å­˜ç¼“å­˜\n      const memoryItem = this.memoryCache.get(key);\n      if (memoryItem) {\n        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ\n        if (Date.now() < memoryItem.expiry) {\n          return memoryItem.value;\n        }\n        this.memoryCache.delete(key);\n      }\n\n      return null;\n    } catch (error) {\n      logger.error('ç¼“å­˜è·å–å¤±è´¥', { key, error: error.message });\n      return null;\n    }\n  }\n\n  /**\n   * è®¾ç½®ç¼“å­˜å€¼\n   * @param {string} key - ç¼“å­˜é”®\n   * @param {any} value - ç¼“å­˜å€¼\n   * @param {number} ttl - è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\n   */\n  async set(key, value, ttl = this.defaultTTL) {\n    try {\n      const serializedValue = JSON.stringify(value);\n\n      // ä½¿ç”¨Redis\n      if (this.redisClient) {\n        await this.redisClient.setex(key, ttl, serializedValue);\n      }\n\n      // åŒæ—¶å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜\n      this.setMemoryCache(key, value, ttl);\n\n      logger.debug('ç¼“å­˜è®¾ç½®æˆåŠŸ', { key, ttl });\n    } catch (error) {\n      logger.error('ç¼“å­˜è®¾ç½®å¤±è´¥', { key, error: error.message });\n    }\n  }\n\n  /**\n   * è®¾ç½®å†…å­˜ç¼“å­˜\n   * @param {string} key - ç¼“å­˜é”®\n   * @param {any} value - ç¼“å­˜å€¼\n   * @param {number} ttl - è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\n   */\n  setMemoryCache(key, value, ttl) {\n    // å¦‚æœå†…å­˜ç¼“å­˜å·²æ»¡ï¼Œåˆ é™¤æœ€æ—§çš„æ¡ç›®\n    if (this.memoryCache.size >= this.maxMemoryItems) {\n      const firstKey = this.memoryCache.keys().next().value;\n      this.memoryCache.delete(firstKey);\n    }\n\n    const expiry = Date.now() + ttl * 1000;\n    this.memoryCache.set(key, { value, expiry });\n  }\n\n  /**\n   * åˆ é™¤ç¼“å­˜\n   * @param {string} key - ç¼“å­˜é”®\n   */\n  async delete(key) {\n    try {\n      if (this.redisClient) {\n        await this.redisClient.del(key);\n      }\n      this.memoryCache.delete(key);\n      logger.debug('ç¼“å­˜åˆ é™¤æˆåŠŸ', { key });\n    } catch (error) {\n      logger.error('ç¼“å­˜åˆ é™¤å¤±è´¥', { key, error: error.message });\n    }\n  }\n\n  /**\n   * æ‰¹é‡åˆ é™¤ç¼“å­˜ï¼ˆæ”¯æŒæ¨¡å¼åŒ¹é…ï¼‰\n   * @param {string} pattern - åŒ¹é…æ¨¡å¼\n   */\n  async invalidate(pattern) {\n    try {\n      if (this.redisClient) {\n        const keys = await this.redisClient.keys(pattern);\n        if (keys.length > 0) {\n          await this.redisClient.del(...keys);\n        }\n      }\n\n      // æ¸…ç†å†…å­˜ç¼“å­˜\n      const regex = new RegExp(pattern.replace(/\\*/g, '.*'));\n      for (const key of this.memoryCache.keys()) {\n        if (regex.test(key)) {\n          this.memoryCache.delete(key);\n        }\n      }\n\n      logger.debug('ç¼“å­˜æ‰¹é‡åˆ é™¤æˆåŠŸ', { pattern });\n    } catch (error) {\n      logger.error('ç¼“å­˜æ‰¹é‡åˆ é™¤å¤±è´¥', { pattern, error: error.message });\n    }\n  }\n\n  /**\n   * æ¸…ç©ºæ‰€æœ‰ç¼“å­˜\n   */\n  async clear() {\n    try {\n      if (this.redisClient) {\n        await this.redisClient.flushdb();\n      }\n      this.memoryCache.clear();\n      logger.info('æ‰€æœ‰ç¼“å­˜å·²æ¸…ç©º');\n    } catch (error) {\n      logger.error('æ¸…ç©ºç¼“å­˜å¤±è´¥', { error: error.message });\n    }\n  }\n\n  /**\n   * è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯\n   */\n  async getStats() {\n    const stats = {\n      memoryCache: {\n        size: this.memoryCache.size,\n        maxSize: this.maxMemoryItems\n      },\n      redis: {\n        connected: !!this.redisClient\n      }\n    };\n\n    if (this.redisClient) {\n      try {\n        const info = await this.redisClient.info('memory');\n        stats.redis.memory = info;\n      } catch (error) {\n        logger.warn('è·å–Redisç»Ÿè®¡ä¿¡æ¯å¤±è´¥', { error: error.message });\n      }\n    }\n\n    return stats;\n  }\n\n  /**\n   * ç¼“å­˜è£…é¥°å™¨\n   * @param {string} keyPrefix - ç¼“å­˜é”®å‰ç¼€\n   * @param {number} ttl - è¿‡æœŸæ—¶é—´\n   * @returns {Function} è£…é¥°å™¨å‡½æ•°\n   */\n  cached(keyPrefix, ttl = this.defaultTTL) {\n    return (target, propertyName, descriptor) => {\n      const originalMethod = descriptor.value;\n\n      descriptor.value = async function (...args) {\n        const cacheKey = `${keyPrefix}:${JSON.stringify(args)}`;\n\n        // å°è¯•ä»ç¼“å­˜è·å–\n        const cachedResult = await this.get(cacheKey);\n        if (cachedResult !== null) {\n          return cachedResult;\n        }\n\n        // æ‰§è¡ŒåŸæ–¹æ³•\n        const result = await originalMethod.apply(this, args);\n\n        // å­˜å‚¨åˆ°ç¼“å­˜\n        await this.set(cacheKey, result, ttl);\n\n        return result;\n      }.bind(this);\n\n      return descriptor;\n    };\n  }\n\n  /**\n   * æ¸…ç†è¿‡æœŸçš„å†…å­˜ç¼“å­˜\n   */\n  cleanupExpiredMemoryCache() {\n    const now = Date.now();\n    for (const [key, item] of this.memoryCache.entries()) {\n      if (now >= item.expiry) {\n        this.memoryCache.delete(key);\n      }\n    }\n  }\n}\n\n/**\n * ç¼“å­˜ä¸­é—´ä»¶å·¥å‚\n * @param {number} ttl - ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰\n * @param {Function} keyGenerator - ç¼“å­˜é”®ç”Ÿæˆå‡½æ•°\n * @returns {Function} Expressä¸­é—´ä»¶\n */\nconst createCacheMiddleware =\n  (ttl = 300, keyGenerator = null) =>\n    async (req, res, next) => {\n      try {\n      // ç”Ÿæˆç¼“å­˜é”®\n        const cacheKey = keyGenerator\n          ? keyGenerator(req)\n          : `api:${req.method}:${req.originalUrl}:${JSON.stringify(req.query)}`;\n\n        // å°è¯•ä»ç¼“å­˜è·å–\n        const cachedData = await cacheManager.get(cacheKey);\n        if (cachedData) {\n          return res.json({\n            success: true,\n            data: cachedData,\n            cached: true,\n            timestamp: new Date().toISOString()\n          });\n        }\n\n        // é‡å†™res.jsonæ–¹æ³•ä»¥ç¼“å­˜å“åº”\n        const originalJson = res.json;\n        res.json = function (data) {\n        // åªç¼“å­˜æˆåŠŸçš„å“åº”\n          if (data.success !== false) {\n            cacheManager.set(cacheKey, data, ttl).catch((error) => {\n              logger.error('ç¼“å­˜å“åº”å¤±è´¥', { cacheKey, error: error.message });\n            });\n          }\n          return originalJson.call(this, data);\n        };\n\n        next();\n      } catch (error) {\n        logger.error('ç¼“å­˜ä¸­é—´ä»¶é”™è¯¯', { error: error.message });\n        next();\n      }\n    };\n\n// åˆ›å»ºå…¨å±€ç¼“å­˜ç®¡ç†å™¨å®ä¾‹\nconst cacheManager = new CacheManager();\n\n// å®šæœŸæ¸…ç†è¿‡æœŸçš„å†…å­˜ç¼“å­˜\nsetInterval(() => {\n  cacheManager.cleanupExpiredMemoryCache();\n}, 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡\n\nexport { CacheManager, createCacheMiddleware, cacheManager };\n\nexport default cacheManager;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/config/cache.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":10,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":10,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[321,364],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":19,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":19,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[513,544],"text":""},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import redis from 'redis';\n\n// åˆ›å»ºRediså®¢æˆ·ç«¯\nconst redisClient = redis.createClient({\n  host: process.env.REDIS_HOST || 'localhost',\n  port: process.env.REDIS_PORT || 6379,\n  password: process.env.REDIS_PASSWORD || '',\n  retry_strategy: (options) => {\n    if (options.error && options.error.code === 'ECONNREFUSED') {\n      console.error('Redisè¿æ¥è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥RedisæœåŠ¡æ˜¯å¦è¿è¡Œ');\n      return 5000; // 5ç§’åé‡è¯•\n    }\n    return Math.min(options.attempt * 100, 3000); // æŒ‡æ•°é€€é¿ç­–ç•¥\n  }\n});\n\n// é”™è¯¯å¤„ç†\nredisClient.on('error', (err) => {\n  console.error('Redisé”™è¯¯:', err);\n});\n\n// å¯¼å‡ºRediså®¢æˆ·ç«¯å’Œå¸¸ç”¨æ–¹æ³•\nexport default {\n  redisClient,\n  get: (key) => redisClient.get(key),\n  set: (key, value) => redisClient.set(key, value),\n  setAsync: (key, value) => redisClient.set(key, value),\n  del: (key) => redisClient.del(key),\n  expire: (key, ttl) => redisClient.expire(key, ttl),\n  expireAsync: (key, ttl) => redisClient.expire(key, ttl),\n  // é»˜è®¤ç¼“å­˜æ—¶é—´ï¼š5åˆ†é’Ÿ\n  DEFAULT_TTL: 300,\n  // é•¿æ—¶ç¼“å­˜æ—¶é—´ï¼š1å°æ—¶\n  LONG_TTL: 3600,\n  // çŸ­æœŸç¼“å­˜æ—¶é—´ï¼š30ç§’\n  SHORT_TTL: 30\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/config/index.js","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":315,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":315,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[9792,9845],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * é…ç½®ç®¡ç†æ¨¡å—\n * æä¾›é›†ä¸­åŒ–çš„é…ç½®ç®¡ç†ã€éªŒè¯å’Œç±»å‹è½¬æ¢\n */\n\nimport dotenv from 'dotenv';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n// åŠ è½½ç¯å¢ƒå˜é‡\nconst envFile = process.env.NODE_ENV === 'production' ? '.env.prod' : '.env';\nconst envPath = path.resolve(__dirname, '../../../', envFile);\ndotenv.config({ path: envPath });\n\n/**\n * é…ç½®éªŒè¯å’Œç±»å‹è½¬æ¢å·¥å…·\n */\nclass ConfigValidator {\n  /**\n   * è·å–å­—ç¬¦ä¸²é…ç½®\n   */\n  static getString(key, defaultValue = null, required = false) {\n    const value = process.env[key];\n\n    if (!value) {\n      if (required) {\n        throw new Error(`å¿…éœ€çš„é…ç½®é¡¹ ${key} æœªè®¾ç½®`);\n      }\n      return defaultValue;\n    }\n\n    return value;\n  }\n\n  /**\n   * è·å–æ•°å­—é…ç½®\n   */\n  static getNumber(key, defaultValue = null, required = false) {\n    const value = process.env[key];\n\n    if (!value) {\n      if (required) {\n        throw new Error(`å¿…éœ€çš„é…ç½®é¡¹ ${key} æœªè®¾ç½®`);\n      }\n      return defaultValue;\n    }\n\n    const numValue = Number(value);\n    if (isNaN(numValue)) {\n      throw new Error(`é…ç½®é¡¹ ${key} å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—ï¼Œå½“å‰å€¼: ${value}`);\n    }\n\n    return numValue;\n  }\n\n  /**\n   * è·å–å¸ƒå°”é…ç½®\n   */\n  static getBoolean(key, defaultValue = false, required = false) {\n    const value = process.env[key];\n\n    if (!value) {\n      if (required) {\n        throw new Error(`å¿…éœ€çš„é…ç½®é¡¹ ${key} æœªè®¾ç½®`);\n      }\n      return defaultValue;\n    }\n\n    return value.toLowerCase() === 'true' || value === '1';\n  }\n\n  /**\n   * è·å–æ•°ç»„é…ç½®ï¼ˆé€—å·åˆ†éš”ï¼‰\n   */\n  static getArray(key, defaultValue = [], required = false) {\n    const value = process.env[key];\n\n    if (!value) {\n      if (required) {\n        throw new Error(`å¿…éœ€çš„é…ç½®é¡¹ ${key} æœªè®¾ç½®`);\n      }\n      return defaultValue;\n    }\n\n    return value\n      .split(',')\n      .map((item) => item.trim())\n      .filter((item) => item);\n  }\n\n  /**\n   * éªŒè¯æšä¸¾å€¼\n   */\n  static getEnum(key, validValues, defaultValue = null, required = false) {\n    const value = this.getString(key, defaultValue, required);\n\n    if (value && !validValues.includes(value)) {\n      throw new Error(`é…ç½®é¡¹ ${key} çš„å€¼ ${value} æ— æ•ˆï¼Œæœ‰æ•ˆå€¼: ${validValues.join(', ')}`);\n    }\n\n    return value;\n  }\n\n  /**\n   * éªŒè¯URLæ ¼å¼\n   */\n  static getUrl(key, defaultValue = null, required = false) {\n    const value = this.getString(key, defaultValue, required);\n\n    if (value) {\n      try {\n        new URL(value);\n      } catch (error) {\n        throw new Error(`é…ç½®é¡¹ ${key} å¿…é¡»æ˜¯æœ‰æ•ˆçš„URLï¼Œå½“å‰å€¼: ${value}`);\n      }\n    }\n\n    return value;\n  }\n\n  /**\n   * éªŒè¯æ–‡ä»¶è·¯å¾„\n   */\n  static getPath(key, defaultValue = null, required = false) {\n    const value = this.getString(key, defaultValue, required);\n\n    if (value && !path.isAbsolute(value)) {\n      // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰\n      return path.resolve(__dirname, '../../../', value);\n    }\n\n    return value;\n  }\n}\n\n/**\n * åº”ç”¨ç¨‹åºé…ç½®\n */\nconst config = {\n  // åº”ç”¨ç¨‹åºåŸºæœ¬é…ç½®\n  app: {\n    name: ConfigValidator.getString('APP_NAME', 'é›¶ç¢³å›­åŒºæ•°å­—å­ªç”Ÿèƒ½ç¢³ç®¡ç†ç³»ç»Ÿ'),\n    version: ConfigValidator.getString('APP_VERSION', '1.0.0'),\n    env: ConfigValidator.getEnum('NODE_ENV', ['development', 'production', 'test'], 'development'),\n    port: ConfigValidator.getNumber('PORT', 1125),\n    host: ConfigValidator.getString('HOST', '0.0.0.0'),\n    timezone: ConfigValidator.getString('TZ', 'Asia/Shanghai')\n  },\n\n  // æ•°æ®åº“é…ç½®\n  database: {\n    path: ConfigValidator.getPath('DB_PATH', 'data/park.db', true),\n    connectionTimeout: ConfigValidator.getNumber('DB_CONNECTION_TIMEOUT', 30000),\n    queryTimeout: ConfigValidator.getNumber('DB_QUERY_TIMEOUT', 10000),\n    maxConnections: ConfigValidator.getNumber('DB_MAX_CONNECTIONS', 10),\n    enableWAL: ConfigValidator.getBoolean('DB_ENABLE_WAL', true),\n    enableForeignKeys: ConfigValidator.getBoolean('DB_ENABLE_FOREIGN_KEYS', true)\n  },\n\n  // JWTè®¤è¯é…ç½®\n  jwt: {\n    secret: ConfigValidator.getString('JWT_SECRET', null, true),\n    accessTokenExpiry: ConfigValidator.getNumber('JWT_ACCESS_TOKEN_EXPIRY', 900000),\n    refreshTokenExpiry: ConfigValidator.getNumber('JWT_REFRESH_TOKEN_EXPIRY', 604800),\n    issuer: ConfigValidator.getString('JWT_ISSUER', 'zero-carbon-park'),\n    audience: ConfigValidator.getString('JWT_AUDIENCE', 'zero-carbon-park-users')\n  },\n\n  // MQTTé…ç½®\n  mqtt: {\n    brokerUrl: ConfigValidator.getUrl('MQTT_BROKER_URL', 'mqtt://localhost:1883', true),\n    clientId: ConfigValidator.getString('MQTT_CLIENT_ID', 'zero-carbon-park-server'),\n    username: ConfigValidator.getString('MQTT_USERNAME'),\n    password: ConfigValidator.getString('MQTT_PASSWORD'),\n    keepalive: ConfigValidator.getNumber('MQTT_KEEPALIVE', 60),\n    connectTimeout: ConfigValidator.getNumber('MQTT_CONNECT_TIMEOUT', 30000),\n    reconnectPeriod: ConfigValidator.getNumber('MQTT_RECONNECT_PERIOD', 1000),\n    topics: {\n      energyData: ConfigValidator.getString('MQTT_TOPIC_ENERGY', 'park/energy/+/data'),\n      carbonData: ConfigValidator.getString('MQTT_TOPIC_CARBON', 'park/carbon/+/data'),\n      batteryData: ConfigValidator.getString('MQTT_TOPIC_BATTERY', 'park/battery/+/data'),\n      alerts: ConfigValidator.getString('MQTT_TOPIC_ALERTS', 'park/alerts')\n    }\n  },\n\n  // Redisç¼“å­˜é…ç½®\n  redis: {\n    enabled: ConfigValidator.getBoolean('REDIS_ENABLED', false),\n    host: ConfigValidator.getString('REDIS_HOST', 'localhost'),\n    port: ConfigValidator.getNumber('REDIS_PORT', 6379),\n    password: ConfigValidator.getString('REDIS_PASSWORD'),\n    db: ConfigValidator.getNumber('REDIS_DB', 0),\n    keyPrefix: ConfigValidator.getString('REDIS_KEY_PREFIX', 'zcp:'),\n    defaultTTL: ConfigValidator.getNumber('REDIS_DEFAULT_TTL', 3600),\n    maxRetriesPerRequest: ConfigValidator.getNumber('REDIS_MAX_RETRIES', 3),\n    retryDelayOnFailover: ConfigValidator.getNumber('REDIS_RETRY_DELAY', 100)\n  },\n\n  // å®‰å…¨é…ç½®\n  security: {\n    passwordSaltRounds: ConfigValidator.getNumber('SECURITY_PASSWORD_SALT_ROUNDS', 10),\n    cors: {\n      enabled: ConfigValidator.getBoolean('SECURITY_CORS_ENABLED', true),\n      origin: ConfigValidator.getString('SECURITY_CORS_ORIGIN', '*'), // ç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶ä¸ºç‰¹å®šåŸŸå\n      methods: ConfigValidator.getString('SECURITY_CORS_METHODS', 'GET,HEAD,PUT,PATCH,POST,DELETE'),\n      allowedHeaders: ConfigValidator.getString(\n        'SECURITY_CORS_ALLOWED_HEADERS',\n        'Content-Type,Authorization'\n      ),\n      exposedHeaders: ConfigValidator.getString('SECURITY_CORS_EXPOSED_HEADERS', ''),\n      credentials: ConfigValidator.getBoolean('SECURITY_CORS_CREDENTIALS', true),\n      maxAge: ConfigValidator.getNumber('SECURITY_CORS_MAX_AGE', 3600)\n    },\n    rateLimit: {\n      enabled: ConfigValidator.getBoolean('SECURITY_RATE_LIMIT_ENABLED', true),\n      windowMs: ConfigValidator.getNumber('SECURITY_RATE_LIMIT_WINDOW_MS', 15 * 60 * 1000), // 15 minutes\n      max: ConfigValidator.getNumber('SECURITY_RATE_LIMIT_MAX', 100), // limit each IP to 100 requests per windowMs\n      message: ConfigValidator.getString(\n        'SECURITY_RATE_LIMIT_MESSAGE',\n        'Too many requests from this IP, please try again after 15 minutes'\n      )\n    },\n    helmet: {\n      enabled: ConfigValidator.getBoolean('SECURITY_HELMET_ENABLED', true)\n    },\n    csrf: {\n      enabled: ConfigValidator.getBoolean('SECURITY_CSRF_ENABLED', false) // CSRFä¿æŠ¤é€šå¸¸ç”¨äºåŸºäºä¼šè¯çš„è®¤è¯ï¼ŒJWTé€šå¸¸ä¸éœ€è¦\n    }\n  },\n\n  // æ—¥å¿—é…ç½®\n  logging: {\n    level: 'debug', // å¼ºåˆ¶è®¾ç½®ä¸ºdebugçº§åˆ«ä»¥æ•è·SQLæŸ¥è¯¢æ—¥å¿—\n    enableConsole: ConfigValidator.getBoolean('LOG_ENABLE_CONSOLE', true),\n    enableFile: ConfigValidator.getBoolean('LOG_ENABLE_FILE', true),\n    logDir: ConfigValidator.getPath('LOG_DIR', 'logs'),\n    maxFileSize: ConfigValidator.getNumber('LOG_MAX_FILE_SIZE', 10485760), // 10MB\n    maxFiles: ConfigValidator.getNumber('LOG_MAX_FILES', 10)\n  },\n  // ç›‘æ§é…ç½®\n  monitoring: {\n    enableMetrics: ConfigValidator.getBoolean('MONITORING_ENABLE_METRICS', true),\n    metricsPort: ConfigValidator.getNumber('MONITORING_METRICS_PORT', 9090),\n    enableHealthCheck: ConfigValidator.getBoolean('MONITORING_ENABLE_HEALTH_CHECK', true),\n    healthCheckInterval: ConfigValidator.getNumber('MONITORING_HEALTH_CHECK_INTERVAL', 30000),\n    enablePerformanceMonitoring: ConfigValidator.getBoolean('MONITORING_ENABLE_PERFORMANCE', true)\n  },\n\n  // æ–‡ä»¶ä¸Šä¼ é…ç½®\n  upload: {\n    maxFileSize: ConfigValidator.getNumber('UPLOAD_MAX_FILE_SIZE', 10 * 1024 * 1024), // 10MB\n    allowedMimeTypes: ConfigValidator.getArray('UPLOAD_ALLOWED_MIME_TYPES', [\n      'image/jpeg',\n      'image/png',\n      'image/gif',\n      'application/pdf',\n      'text/csv'\n    ]),\n    uploadDir: ConfigValidator.getPath('UPLOAD_DIR', 'uploads'),\n    enableVirusScan: ConfigValidator.getBoolean('UPLOAD_ENABLE_VIRUS_SCAN', false)\n  },\n\n  // å¤–éƒ¨æœåŠ¡é…ç½®\n  external: {\n    weatherApiKey: ConfigValidator.getString('WEATHER_API_KEY'),\n    weatherApiUrl: ConfigValidator.getUrl(\n      'WEATHER_API_URL',\n      'https://api.openweathermap.org/data/2.5'\n    ),\n    carbonFactorApiUrl: ConfigValidator.getUrl('CARBON_FACTOR_API_URL'),\n    enableExternalServices: ConfigValidator.getBoolean('ENABLE_EXTERNAL_SERVICES', false)\n  },\n\n  // å¼€å‘é…ç½®\n  development: {\n    enableMockData: ConfigValidator.getBoolean('DEV_ENABLE_MOCK_DATA', false),\n    enableDebugRoutes: ConfigValidator.getBoolean('DEV_ENABLE_DEBUG_ROUTES', false),\n    enableSqlLogging: ConfigValidator.getBoolean('DEV_ENABLE_SQL_LOGGING', false)\n  }\n};\n\n/**\n * é…ç½®éªŒè¯å‡½æ•°\n */\nexport function validateConfig() {\n  const errors = [];\n\n  // éªŒè¯JWTå¯†é’¥é•¿åº¦\n  if (config.jwt.secret && config.jwt.secret.length < 32) {\n    errors.push('JWT_SECRET é•¿åº¦å¿…é¡»è‡³å°‘32ä¸ªå­—ç¬¦');\n  }\n\n  // éªŒè¯ç«¯å£èŒƒå›´\n  if (config.app.port < 1 || config.app.port > 65535) {\n    errors.push('PORT å¿…é¡»åœ¨1-65535èŒƒå›´å†…');\n  }\n\n  // éªŒè¯æ—¥å¿—ç›®å½•\n  if (config.logging.enableFile && !config.logging.logDir) {\n    errors.push('å¯ç”¨æ–‡ä»¶æ—¥å¿—æ—¶å¿…é¡»è®¾ç½® LOG_DIR');\n  }\n\n  // éªŒè¯ä¸Šä¼ ç›®å½•\n  if (!config.upload.uploadDir) {\n    errors.push('å¿…é¡»è®¾ç½® UPLOAD_DIR');\n  }\n\n  if (errors.length > 0) {\n    throw new Error(`é…ç½®éªŒè¯å¤±è´¥:\\n${errors.join('\\n')}`);\n  }\n\n  console.log(`[CONFIG] é…ç½®éªŒè¯é€šè¿‡ï¼Œç¯å¢ƒ: ${config.app.env}`);\n}\n\n/**\n * è·å–é…ç½®ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰\n */\nexport function getConfigInfo() {\n  const safeConfig = JSON.parse(JSON.stringify(config));\n\n  // éšè—æ•æ„Ÿä¿¡æ¯\n  if (safeConfig.jwt.secret) {\n    safeConfig.jwt.secret = '***';\n  }\n  if (safeConfig.mqtt.password) {\n    safeConfig.mqtt.password = '***';\n  }\n  if (safeConfig.redis.password) {\n    safeConfig.redis.password = '***';\n  }\n  if (safeConfig.external.weatherApiKey) {\n    safeConfig.external.weatherApiKey = '***';\n  }\n\n  return safeConfig;\n}\n\n/**\n * æ£€æŸ¥æ˜¯å¦ä¸ºç”Ÿäº§ç¯å¢ƒ\n */\nexport function isProduction() {\n  return config.app.env === 'production';\n}\n\n/**\n * æ£€æŸ¥æ˜¯å¦ä¸ºå¼€å‘ç¯å¢ƒ\n */\nexport function isDevelopment() {\n  return config.app.env === 'development';\n}\n\n/**\n * æ£€æŸ¥æ˜¯å¦ä¸ºæµ‹è¯•ç¯å¢ƒ\n */\nexport function isTest() {\n  return config.app.env === 'test';\n}\n\n// åœ¨æ¨¡å—åŠ è½½æ—¶éªŒè¯é…ç½®\nvalidateConfig();\n\nexport default config;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/constants/HttpStatusCodes.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/constants/MathConstants.js","messages":[{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'TWENTY_FIVE'.","line":44,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":44,"endColumn":14},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'POINT_ZERO_THREE'.","line":108,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":108,"endColumn":19},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'EIGHT_HUNDRED'.","line":142,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":142,"endColumn":16},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'POINT_EIGHT_FIVE'.","line":154,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":154,"endColumn":19},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'THIRTY_SIX'.","line":155,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":155,"endColumn":13},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'NINE'.","line":156,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":156,"endColumn":7},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'POINT_EIGHT'.","line":159,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":159,"endColumn":14},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'POINT_SIX'.","line":160,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":160,"endColumn":12},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'EIGHT_HUNDRED'.","line":161,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":161,"endColumn":16},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'ONE_THOUSAND'.","line":162,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":162,"endColumn":15},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'EIGHTY'.","line":163,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":163,"endColumn":9},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'SIXTY'.","line":164,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":164,"endColumn":8},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'FORTY'.","line":165,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":165,"endColumn":8},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'TWENTY'.","line":166,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":166,"endColumn":9},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'SEVENTY'.","line":175,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":175,"endColumn":10},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'SEVENTY_FIVE'.","line":176,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":176,"endColumn":15},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'EIGHTY_FIVE'.","line":177,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":177,"endColumn":14},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'NINETY_TWO'.","line":179,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":179,"endColumn":13},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'NINETY_FIVE'.","line":180,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":180,"endColumn":14},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'NINETY_EIGHT'.","line":181,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":181,"endColumn":15},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'TWENTY_FOUR'.","line":184,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":184,"endColumn":14},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'THIRTY'.","line":185,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":185,"endColumn":9},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'SIXTY'.","line":186,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":186,"endColumn":8},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'NINETY'.","line":187,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":187,"endColumn":9},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'FIFTEEN'.","line":200,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":200,"endColumn":10},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'POINT_FOUR'.","line":206,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":206,"endColumn":13},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'POINT_SEVEN'.","line":207,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":207,"endColumn":14},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'POINT_NINE'.","line":208,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":208,"endColumn":13},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'POINT_NINE_FIVE'.","line":209,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":209,"endColumn":18},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'NINETY'.","line":210,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":210,"endColumn":9},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'SIXTEEN'.","line":212,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":212,"endColumn":10},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'TWENTY_FIVE'.","line":213,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":213,"endColumn":14},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'THIRTY_SIX'.","line":214,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":214,"endColumn":13},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'NINE'.","line":215,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":215,"endColumn":7},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'ONE_HUNDRED'.","line":216,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":216,"endColumn":14},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'ZERO_POINT_ZERO_FIVE'.","line":220,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":220,"endColumn":23},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'ONE'.","line":226,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":226,"endColumn":6},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'TWO'.","line":227,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":227,"endColumn":6},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'THREE'.","line":228,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":228,"endColumn":8},{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'NINETY_FIVE'.","line":229,"column":3,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":229,"endColumn":14},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":266,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":266,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":266,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":266,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":266,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":266,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":545,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":545,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":545,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":545,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":545,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":545,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":629,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":629,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":629,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":629,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":629,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":629,"endColumn":41}],"suppressedMessages":[],"errorCount":40,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * æ•°å­¦å’ŒåŸºç¡€å¸¸é‡å®šä¹‰\n * ç”¨äºæ›¿æ¢é¡¹ç›®ä¸­çš„é­”æ³•æ•°å­—ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§\n */\n\n// åŸºç¡€æ•°å­¦å¸¸é‡\nexport const MATH_CONSTANTS = {\n  // æ•°å­¦ç›¸å…³å¸¸é‡\n  PI: Math.PI,\n  E: Math.E,\n  GOLDEN_RATIO: 1.618033988749895,\n  DECIMAL_PLACES: 2, // å°æ•°ä½æ•°\n  \n  // åŸºç¡€æ•°å€¼å¸¸é‡\n  ZERO: 0,\n  ONE: 1,\n  TWO: 2,\n  THREE: 3,\n  FOUR: 4,\n  FIVE: 5,\n  SIX: 6,\n  SEVEN: 7,\n  EIGHT: 8,\n  NINE: 9,\n  TEN: 10,\n  ELEVEN: 11,\n  TWELVE: 12,\n  THIRTEEN: 13,\n  FOURTEEN: 14,\n  FIFTEEN: 15,\n  SIXTEEN: 16,\n  SEVENTEEN: 17,\n  EIGHTEEN: 18,\n  NINETEEN: 19,\n  TWENTY: 20,\n  TWENTY_FIVE: 25,\n  POINT_ZERO_FOUR: 0.04,\n  POINT_ZERO_THREE: 0.03,\n  POINT_ZERO_SIX: 0.06,\n  TWENTY_ONE: 21,\n  TWENTY_TWO: 22,\n  TWENTY_THREE: 23,\n  TWENTY_FOUR: 24,\n  TWENTY_FIVE: 25,\n  THIRTY: 30,\n  THIRTY_ONE: 31,\n  THIRTY_TWO: 32,\n  THIRTY_THREE: 33,\n  THIRTY_FOUR: 34,\n  THIRTY_FIVE: 35,\n  THIRTY_SIX: 36,\n  FORTY: 40,\n  FIFTY: 50,\n  SIXTY: 60,\n  SIXTY_FIVE: 65,\n  SEVENTY: 70,\n  SEVENTY_TWO: 72,\n  SEVENTY_FIVE: 75,\n  SEVENTY_EIGHT: 78,\n  EIGHTY: 80,\n  EIGHTY_FIVE: 85,\n  NINETY: 90,\n  NINETY_TWO: 92,\n  NINETY_FIVE: 95,\n  NINETY_EIGHT: 98,\n  ONE_HUNDRED: 100,\n  EIGHT_HUNDRED: 800,\n  TWO_HUNDRED: 200,\n  THREE_HUNDRED: 300,\n  \n  // æ—¶é—´ç›¸å…³åŸºç¡€æ•°å€¼\n  SECONDS_PER_MINUTE: 60,\n  MINUTES_PER_HOUR: 60,\n  HOURS_PER_DAY: 24,\n  DAYS_PER_YEAR: 365,\n  \n  // æ—¶é—´è½¬æ¢ï¼ˆæ¯«ç§’ï¼‰\n  MILLISECONDS_PER_SECOND: 1000,\n  \n  // å­˜å‚¨å’Œæ•°æ®ç›¸å…³\n  BYTES_PER_KB: 1024,\n  \n  // ç™¾åˆ†æ¯”ç›¸å…³\n  PERCENTAGE_BASE: 100,\n  \n  // å°æ•°å¸¸é‡\n  ZERO_POINT_ZERO_ONE: 0.01,\n  ZERO_POINT_ZERO_FIVE: 0.05,\n  ZERO_POINT_ONE: 0.1,\n  ZERO_POINT_FIFTEEN: 0.15,\n  ZERO_POINT_TWO: 0.2,\n  ZERO_POINT_FIVE: 0.5,\n  ZERO_POINT_SIX: 0.6,\n  ZERO_POINT_EIGHT: 0.8,\n  POINT_EIGHT: 0.8,\n  ZERO_POINT_EIGHTY_FIVE: 0.85,\n  POINT_EIGHT_FIVE: 0.85,\n  POINT_EIGHT_EIGHT: 0.88,\n  POINT_NINE: 0.9,\n  POINT_SEVEN: 0.7,\n  POINT_SIX: 0.6,\n  POINT_SIX_FIVE: 0.65,\n  POINT_FIVE: 0.5,\n  POINT_TWO_FIVE: 0.25,\n  POINT_ONE_NINE: 0.19,\n  POINT_ZERO_EIGHT: 0.08,\n  POINT_ZERO_SEVEN: 0.07,\n  POINT_ZERO_THREE: 0.03,\n  POINT_FOUR: 0.4,\n  POINT_THREE: 0.3,\n  POINT_ONE: 0.1,\n  POINT_ONE_TWO: 1.2,\n  ONE_POINT_ZERO: 1.0,\n  ONE_POINT_FIVE: 1.5,\n  ZERO_POINT_NINE: 0.9,\n  ZERO_POINT_NINETY: 0.90,\n  ZERO_POINT_NINETY_FIVE: 0.95,\n  ZERO_POINT_NINETY_EIGHT: 0.98,\n  ZERO_POINT_NINETY_NINE: 0.99,\n  POINT_SEVEN_FIVE: 0.75,\n  POINT_NINE_FIVE: 0.95,\n  POINT_NINE_EIGHT: 0.98,\n  \n  // ç™¾åˆ†æ¯”å¸¸é‡\n  FIVE_PERCENT: 0.05,\n  TEN_PERCENT: 0.1,\n  TWENTY_PERCENT: 0.2,\n  THIRTY_PERCENT: 0.3,\n  FIFTY_PERCENT: 0.5,\n  EIGHTY_PERCENT: 0.8,\n  NINETY_PERCENT: 0.9,\n  \n  // åˆ†æ•°å¸¸é‡\n  HALF: 0.5,\n  ONE_HALF: 0.5,\n  ONE_THIRD: 0.33,\n  ONE_QUARTER: 0.25,\n  \n  // å­˜å‚¨å’Œæ•°æ®ç›¸å…³\n  FOUR_HUNDRED: 400,\n  FIVE_HUNDRED: 500,\n  EIGHT_HUNDRED: 800,\n  ONE_THOUSAND: 1000,\n  FIFTEEN_HUNDRED: 1500,\n  TWO_THOUSAND: 2000,\n  THREE_THOUSAND: 3000,\n  TWO_THOUSAND_TWO_HUNDRED: 2200,\n  POINT_FIVE_SEVEN_ZERO_THREE: 0.5703,\n  POINT_TWO: 0.2,\n  FIFTEEN_POINT_FIVE: 15.5,\n  TWELVE_POINT_THREE: 12.3,\n  EIGHT_POINT_SEVEN: 8.7,\n  FIVE_POINT_TWO: 5.2,\n  POINT_EIGHT_FIVE: 0.85,\n  THIRTY_SIX: 36,\n  NINE: 9,\n  NEGATIVE_SIX: -6,\n  POINT_ZERO_FIVE: 0.05,\n  POINT_EIGHT: 0.8,\n  POINT_SIX: 0.6,\n  EIGHT_HUNDRED: 800,\n  ONE_THOUSAND: 1000,\n  EIGHTY: 80,\n  SIXTY: 60,\n  FORTY: 40,\n  TWENTY: 20,\n  THREE_THOUSAND_THREE_HUNDRED_SIX: 3306,\n  FIVE_THOUSAND: 5000,\n  TEN_THOUSAND: 10000,\n  FIFTEEN_THOUSAND: 15000,\n  TWENTY_THOUSAND: 20000,\n  THIRTY_THOUSAND: 30000,\n  ONE_MILLION: 1000000,\n  SIXTY_SEVEN: 67,\n  SEVENTY: 70,\n  SEVENTY_FIVE: 75,\n  EIGHTY_FIVE: 85,\n  EIGHTY_EIGHT: 88,\n  NINETY_TWO: 92,\n  NINETY_FIVE: 95,\n  NINETY_EIGHT: 98,\n  \n  // DataLineageService ç›¸å…³å¸¸é‡\n  TWENTY_FOUR: 24,\n  THIRTY: 30,\n  SIXTY: 60,\n  NINETY: 90,\n  \n  // å€æ•°å¸¸é‡\n  ONE_POINT_TWO: 1.2,\n  \n  // å•ä½è½¬æ¢åŸºæ•°\n  UNIT_CONVERSION_BASE: 1000,\n  \n  // å¯†ç å’Œå®‰å…¨ç›¸å…³\n  MIN_PASSWORD_LENGTH: 8,\n  CRYPTO_RANDOM_BYTES: 16,\n  \n  // èƒ½æºç®¡ç†ç›¸å…³å¸¸é‡\n  FIFTEEN: 15,\n  ONE_HUNDRED_TWENTY: 120,\n  ONE_HUNDRED_EIGHTY: 180,\n  EIGHT_THOUSAND_SEVEN_HUNDRED_SIXTY: 8760,\n  \n  // ç»´æŠ¤ç®¡ç†ç›¸å…³å¸¸é‡\n  POINT_FOUR: 0.4,\n  POINT_SEVEN: 0.7,\n  POINT_NINE: 0.9,\n  POINT_NINE_FIVE: 0.95,\n  NINETY: 90,\n  EIGHT_THOUSAND: 8000,\n  SIXTEEN: 16,\n  TWENTY_FIVE: 25,\n  THIRTY_SIX: 36,\n  NINE: 9,\n  ONE_HUNDRED: 100,\n  \n  // NationalIndicatorDashboard éœ€è¦çš„å¸¸é‡\n  ONE_POINT_ONE: 1.1,\n  ZERO_POINT_ZERO_FIVE: 0.05,\n  NINE_HUNDRED: 900,\n  TWO_HUNDRED_FORTY: 240,\n  NINE_THOUSAND: 9000,\n  \n  // æ•°å­—å¸¸é‡\n  ONE: 1,\n  TWO: 2,\n  THREE: 3,\n  NINETY_FIVE: 95,\n  \n  // ç½‘ç»œç«¯å£å¸¸é‡\n  SMTP_SECURE_PORT: 465,\n  \n  // é¢œè‰²å¸¸é‡ï¼ˆåå…­è¿›åˆ¶ï¼‰\n  DEFAULT_GRAY_COLOR: 0x808080\n};\n\n// æ—¶é—´é—´éš”å¸¸é‡ï¼ˆåŸºäºåŸºç¡€æ•°å­¦å¸¸é‡è®¡ç®—ï¼‰\nexport const TIME_INTERVALS = {\n  ONE_SECOND_MS: 1000,\n  FIVE_SECONDS_MS: 5000,\n  TEN_SECONDS_MS: 10000,\n  THIRTY_SECONDS_MS: 30000,\n  ONE_MINUTE_MS: 60000,\n  FIVE_MINUTES_MS: MATH_CONSTANTS.FIVE * MATH_CONSTANTS.SECONDS_PER_MINUTE * MATH_CONSTANTS.MILLISECONDS_PER_SECOND,\n  TEN_MINUTES_MS: 600000,\n  FIFTEEN_MINUTES_MS: 900000,\n  THIRTY_MINUTES_MS: 1800000,\n  ONE_HOUR_MS: MATH_CONSTANTS.MINUTES_PER_HOUR * MATH_CONSTANTS.SECONDS_PER_MINUTE * MATH_CONSTANTS.MILLISECONDS_PER_SECOND,\n  TWO_HOURS_MS: 7200000,\n  SIX_HOURS_MS: 21600000,\n  TWELVE_HOURS_MS: 43200000,\n  ONE_DAY_MS: MATH_CONSTANTS.HOURS_PER_DAY * MATH_CONSTANTS.MINUTES_PER_HOUR * MATH_CONSTANTS.SECONDS_PER_MINUTE * MATH_CONSTANTS.MILLISECONDS_PER_SECOND,\n  ONE_WEEK_MS: 604800000,\n  ONE_MONTH_MS: 2592000000,\n  ONE_YEAR_MS: MATH_CONSTANTS.DAYS_PER_YEAR * MATH_CONSTANTS.HOURS_PER_DAY * MATH_CONSTANTS.MINUTES_PER_HOUR * MATH_CONSTANTS.SECONDS_PER_MINUTE * MATH_CONSTANTS.MILLISECONDS_PER_SECOND\n};\n\n// èƒ½æºç®¡ç†ç›¸å…³å¸¸é‡\nexport const ENERGY_CONSTANTS = {\n  // èƒ½æºç›¸å…³å¸¸é‡\n  RENEWABLE_THRESHOLD: 0.3,\n  EFFICIENCY_THRESHOLD: 0.8,\n  LOAD_BALANCE_THRESHOLD: 0.7,\n  OPTIMIZATION_IMPACT: 0.15,\n  DEFAULT_MONITORING_INTERVAL: 5 * 60 * 1000, // 5åˆ†é’Ÿ\n  OPTIMIZATION_THRESHOLD: 0.1,\n  \n  // æ•ˆç‡é˜ˆå€¼\n  EFFICIENCY_THRESHOLD_HIGH: 80,\n  EFFICIENCY_THRESHOLD_MEDIUM: 70,\n  EFFICIENCY_THRESHOLD_LOW: 50,\n  \n  // å¯å†ç”Ÿèƒ½æºæ¯”ä¾‹é˜ˆå€¼\n  RENEWABLE_RATIO_THRESHOLD_HIGH: 50,\n  RENEWABLE_RATIO_THRESHOLD_LOW: 30,\n  \n  // è´Ÿè½½å› å­é˜ˆå€¼\n  LOAD_FACTOR_THRESHOLD_HIGH: 60,\n  LOAD_FACTOR_THRESHOLD_LOW: 50,\n  \n  // æ¨¡æ‹Ÿæ•°æ®èŒƒå›´\n  MOCK_PRODUCTION_MAX: 1000,\n  MOCK_CONSUMPTION_MAX: 800,\n  MOCK_RENEWABLE_BASE: 60,\n  MOCK_RENEWABLE_RANGE: 30,\n  MOCK_EFFICIENCY_BASE: 80,\n  MOCK_EFFICIENCY_RANGE: 15,\n  MOCK_COST_SAVINGS_MAX: 5000,\n  MOCK_HOURLY_PRODUCTION_MAX: 100,\n  MOCK_HOURLY_CONSUMPTION_MAX: 80,\n  MOCK_HOURLY_RENEWABLE_MAX: 60,\n  MOCK_DEVICE_CONTRIBUTION_MAX: 100,\n  MOCK_DEVICE_EFFICIENCY_BASE: 80,\n  MOCK_DEVICE_EFFICIENCY_RANGE: 20,\n  MOCK_ENERGY_SAVED_MAX: 50,\n  MOCK_COST_SAVED_MAX: 100,\n  MOCK_EFFICIENCY_IMPROVED_MAX: 5,\n  \n  // æ—¶é—´èŒƒå›´é™åˆ¶\n  MAX_HOURLY_DATA_HOURS: 24,\n  \n  // ç¢³æ’æ”¾ç›¸å…³å¸¸é‡\n  ELECTRICITY_EMISSION_FACTOR: 0.5, // kg CO2e / kWh\n  NATURAL_GAS_EMISSION_FACTOR: 0.2, // kg CO2e / kWh\n  BASE_ENERGY_USAGE: 500, // kWh\n  RANDOM_ENERGY_RANGE: 500 // kWh\n};\n\n// æ—¶é—´èŒƒå›´å¸¸é‡\nexport const PREVIOUS_TIME_RANGES = {\n  ONE_HOUR: '-2 hours',\n  SIX_HOURS: '-12 hours',\n  ONE_DAY: '-2 days',\n  SEVEN_DAYS: '-14 days',\n  THIRTY_DAYS: '-60 days',\n  NINETY_DAYS: '-180 days',\n  ONE_YEAR: '-2 years'\n};\n\n// å­˜å‚¨å¤§å°å¸¸é‡\nexport const STORAGE_CONSTANTS = {\n  ONE_MB: MATH_CONSTANTS.BYTES_PER_KB * MATH_CONSTANTS.BYTES_PER_KB,\n  FILE_SIZE_LIMIT: MATH_CONSTANTS.BYTES_PER_KB * MATH_CONSTANTS.BYTES_PER_KB // 1MB\n};\n\n// HTTPçŠ¶æ€ç å¸¸é‡\nexport const HTTP_STATUS_CODES = {\n  // æˆåŠŸçŠ¶æ€ç \n  OK: 200,\n  CREATED: 201,\n  ACCEPTED: 202,\n  NO_CONTENT: 204,\n  \n  // é‡å®šå‘çŠ¶æ€ç \n  MOVED_PERMANENTLY: 301,\n  FOUND: 302,\n  NOT_MODIFIED: 304,\n  \n  // å®¢æˆ·ç«¯é”™è¯¯çŠ¶æ€ç \n  BAD_REQUEST: 400,\n  UNAUTHORIZED: 401,\n  FORBIDDEN: 403,\n  NOT_FOUND: 404,\n  METHOD_NOT_ALLOWED: 405,\n  CONFLICT: 409,\n  UNPROCESSABLE_ENTITY: 422,\n  TOO_MANY_REQUESTS: 429,\n  \n  // æœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç \n  INTERNAL_SERVER_ERROR: 500,\n  NOT_IMPLEMENTED: 501,\n  BAD_GATEWAY: 502,\n  SERVICE_UNAVAILABLE: 503,\n  GATEWAY_TIMEOUT: 504\n};\n\n// æ•°æ®å¤„ç†ç›¸å…³å¸¸é‡\nexport const DATA_PROCESSING_CONSTANTS = {\n  // æ‰¹å¤„ç†å¤§å°\n  BATCH_SIZE_SMALL: 100,\n  BATCH_SIZE_MEDIUM: 500,\n  BATCH_SIZE_LARGE: 1000,\n  BATCH_SIZE_EXTRA_LARGE: 5000,\n  \n  // åˆ†é¡µç›¸å…³\n  DEFAULT_PAGE_SIZE: 20,\n  MAX_PAGE_SIZE: 100,\n  MIN_PAGE_SIZE: 1,\n  \n  // é‡è¯•ç›¸å…³\n  MAX_RETRY_ATTEMPTS: 3,\n  RETRY_DELAY_MS: 1000,\n  EXPONENTIAL_BACKOFF_MULTIPLIER: 2,\n  \n  // è¶…æ—¶è®¾ç½®\n  DEFAULT_TIMEOUT_MS: 30000,\n  LONG_TIMEOUT_MS: 60000,\n  SHORT_TIMEOUT_MS: 5000,\n  \n  // ç¼“å­˜ç›¸å…³\n  CACHE_TTL_SHORT: 300, // 5åˆ†é’Ÿ\n  CACHE_TTL_MEDIUM: 1800, // 30åˆ†é’Ÿ\n  CACHE_TTL_LONG: 3600, // 1å°æ—¶\n  CACHE_TTL_EXTRA_LONG: 86400, // 24å°æ—¶\n  \n  // æ•°æ®éªŒè¯\n  MIN_STRING_LENGTH: 1,\n  MAX_STRING_LENGTH: 255,\n  MAX_TEXT_LENGTH: 65535,\n  \n  // æ•°å€¼èŒƒå›´\n  MIN_POSITIVE_NUMBER: 0.0001,\n  MAX_SAFE_INTEGER: Number.MAX_SAFE_INTEGER,\n  MIN_SAFE_INTEGER: Number.MIN_SAFE_INTEGER\n};\n\n// èƒ½æºè®¾å¤‡ç›¸å…³å¸¸é‡\nexport const DEVICE_CONSTANTS = {\n  // è®¾å¤‡çŠ¶æ€\n  STATUS_ONLINE: 1,\n  STATUS_OFFLINE: 0,\n  STATUS_MAINTENANCE: 2,\n  STATUS_ERROR: 3,\n  \n  // è®¾å¤‡ç±»å‹ID\n  TYPE_SOLAR_PANEL: 1,\n  TYPE_WIND_TURBINE: 2,\n  TYPE_BATTERY: 3,\n  TYPE_INVERTER: 4,\n  TYPE_METER: 5,\n  \n  // è®¾å¤‡ä¼˜å…ˆçº§\n  PRIORITY_LOW: 1,\n  PRIORITY_MEDIUM: 2,\n  PRIORITY_HIGH: 3,\n  PRIORITY_CRITICAL: 4,\n  \n  // ç»´æŠ¤é—´éš”ï¼ˆå¤©ï¼‰\n  MAINTENANCE_INTERVAL_DAILY: 1,\n  MAINTENANCE_INTERVAL_WEEKLY: 7,\n  MAINTENANCE_INTERVAL_MONTHLY: 30,\n  MAINTENANCE_INTERVAL_QUARTERLY: 90,\n  MAINTENANCE_INTERVAL_YEARLY: 365,\n  \n  // è®¾å¤‡å®¹é‡ç­‰çº§\n  CAPACITY_SMALL: 10, // kW\n  CAPACITY_MEDIUM: 100, // kW\n  CAPACITY_LARGE: 1000, // kW\n  CAPACITY_EXTRA_LARGE: 10000 // kW\n};\n\n// ç®—æ³•å’Œè®¡ç®—ç›¸å…³å¸¸é‡\nexport const ALGORITHM_CONSTANTS = {\n  // æœºå™¨å­¦ä¹ ç›¸å…³\n  LEARNING_RATE: 0.01,\n  EPOCHS: 100,\n  BATCH_SIZE: 32,\n  VALIDATION_SPLIT: 0.2,\n  TEST_SPLIT: 0.1,\n  \n  // ä¼˜åŒ–ç®—æ³•å‚æ•°\n  CONVERGENCE_THRESHOLD: 0.001,\n  MAX_ITERATIONS: 1000,\n  STEP_SIZE: 0.1,\n  \n  // ç»Ÿè®¡åˆ†æ\n  CONFIDENCE_LEVEL: 0.95,\n  SIGNIFICANCE_LEVEL: 0.05,\n  Z_SCORE_THRESHOLD: 2.0,\n  \n  // é¢„æµ‹æ¨¡å‹\n  FORECAST_HORIZON_HOURS: 24,\n  FORECAST_HORIZON_DAYS: 7,\n  FORECAST_HORIZON_MONTHS: 12,\n  \n  // å¼‚å¸¸æ£€æµ‹\n  ANOMALY_THRESHOLD: 3.0, // æ ‡å‡†å·®å€æ•°\n  OUTLIER_PERCENTILE: 0.95,\n  \n  // èšç±»åˆ†æ\n  MIN_CLUSTER_SIZE: 3,\n  MAX_CLUSTER_SIZE: 10,\n  CLUSTER_DISTANCE_THRESHOLD: 0.5\n};\n\n// å®‰å…¨å’Œè®¤è¯ç›¸å…³å¸¸é‡\nexport const SECURITY_CONSTANTS = {\n  // JWTç›¸å…³\n  JWT_EXPIRY_HOURS: 24,\n  JWT_REFRESH_EXPIRY_DAYS: 7,\n  \n  // å¯†ç ç­–ç•¥\n  MIN_PASSWORD_LENGTH: 8,\n  MAX_PASSWORD_LENGTH: 128,\n  PASSWORD_COMPLEXITY_SCORE: 3,\n  \n  // ä¼šè¯ç®¡ç†\n  SESSION_TIMEOUT_MINUTES: 30,\n  MAX_CONCURRENT_SESSIONS: 5,\n  \n  // è®¿é—®æ§åˆ¶\n  MAX_LOGIN_ATTEMPTS: 5,\n  LOCKOUT_DURATION_MINUTES: 15,\n  \n  // åŠ å¯†ç›¸å…³\n  SALT_ROUNDS: 12,\n  ENCRYPTION_KEY_LENGTH: 32,\n  IV_LENGTH: 16,\n  \n  // APIé™æµ\n  RATE_LIMIT_REQUESTS_PER_MINUTE: 60,\n  RATE_LIMIT_REQUESTS_PER_HOUR: 1000,\n  RATE_LIMIT_BURST_SIZE: 10\n};\n\n// ç›‘æ§å’Œå‘Šè­¦ç›¸å…³å¸¸é‡\nexport const MONITORING_CONSTANTS = {\n  // å‘Šè­¦çº§åˆ«\n  ALERT_LEVEL_INFO: 1,\n  ALERT_LEVEL_WARNING: 2,\n  ALERT_LEVEL_ERROR: 3,\n  ALERT_LEVEL_CRITICAL: 4,\n  \n  // ç›‘æ§é—´éš”\n  MONITOR_INTERVAL_REALTIME: 1000, // 1ç§’\n  MONITOR_INTERVAL_FAST: 5000, // 5ç§’\n  MONITOR_INTERVAL_NORMAL: 30000, // 30ç§’\n  MONITOR_INTERVAL_SLOW: 300000, // 5åˆ†é’Ÿ\n  \n  // æ€§èƒ½é˜ˆå€¼\n  CPU_USAGE_WARNING: 70,\n  CPU_USAGE_CRITICAL: 90,\n  MEMORY_USAGE_WARNING: 80,\n  MEMORY_USAGE_CRITICAL: 95,\n  DISK_USAGE_WARNING: 85,\n  DISK_USAGE_CRITICAL: 95,\n  \n  // å“åº”æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰\n  RESPONSE_TIME_FAST: 100,\n  RESPONSE_TIME_NORMAL: 500,\n  RESPONSE_TIME_SLOW: 1000,\n  RESPONSE_TIME_CRITICAL: 5000,\n  \n  // é”™è¯¯ç‡é˜ˆå€¼\n  ERROR_RATE_WARNING: 0.01, // 1%\n  ERROR_RATE_CRITICAL: 0.05, // 5%\n  \n  // å¯ç”¨æ€§é˜ˆå€¼\n  AVAILABILITY_TARGET: 0.999, // 99.9%\n  AVAILABILITY_WARNING: 0.99, // 99%\n  AVAILABILITY_CRITICAL: 0.95, // 95%\n  \n  // è´¨é‡é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰\n  QUALITY_THRESHOLD_LOW: 60,\n  QUALITY_THRESHOLD_MEDIUM: 75,\n  QUALITY_THRESHOLD_HIGH: 85,\n  QUALITY_THRESHOLD_VERY_HIGH: 90,\n  QUALITY_THRESHOLD_CRITICAL: 95\n};\n\n// ç¢³æ’æ”¾æ ¸ç®—ç›¸å…³å¸¸é‡ï¼ˆç¬¦åˆå›½å®¶æ ‡å‡†ï¼‰\nexport const CARBON_CONSTANTS = {\n  // ç¼“å­˜è¶…æ—¶æ—¶é—´\n  CACHE_TIMEOUT: 5 * 60 * 1000, // 5åˆ†é’Ÿ\n  \n  // å›½å®¶æ ‡å‡†æ’æ”¾å› å­ï¼ˆ2024å¹´ç‰ˆï¼‰\n  NATIONAL_EMISSION_FACTORS: {\n    // å…¨å›½ç”µç½‘å¹³å‡æ’æ”¾å› å­ (kg CO2/kWh)\n    NATIONAL_GRID_ELECTRICITY: 0.5703,\n    \n    // åŒºåŸŸç”µç½‘æ’æ”¾å› å­ (kg CO2/kWh)\n    NORTH_CHINA_GRID: 0.8843,\n    NORTHEAST_CHINA_GRID: 0.8825,\n    EAST_CHINA_GRID: 0.7035,\n    CENTRAL_CHINA_GRID: 0.8257,\n    NORTHWEST_CHINA_GRID: 0.8922,\n    SOUTH_CHINA_GRID: 0.5271,\n    \n    // åŒ–çŸ³ç‡ƒæ–™æ’æ”¾å› å­\n    NATURAL_GAS: 2.1622, // kg CO2/mÂ³\n    COAL: 2.4930, // kg CO2/kg\n    DIESEL: 3.0959, // kg CO2/L\n    GASOLINE: 2.9251, // kg CO2/L\n    HEAVY_OIL: 3.1705, // kg CO2/kg\n    LPG: 3.0012, // kg CO2/kg\n    \n    // å·¥ä¸šè¿‡ç¨‹æ’æ”¾å› å­\n    CEMENT: 0.5273, // kg CO2/kgæ°´æ³¥\n    STEEL: 2.07, // kg CO2/kgé’¢é“\n    ALUMINUM: 11.46, // kg CO2/kgé“\n    CHEMICAL: 1.5, // kg CO2/kgåŒ–å·¥äº§å“ï¼ˆå¹³å‡å€¼ï¼‰\n    PAPER: 0.9, // kg CO2/kgçº¸å¼ \n    \n    // å¯å†ç”Ÿèƒ½æºæ’æ”¾å› å­\n    SOLAR: 0.0,\n    WIND: 0.0,\n    HYDRO: 0.0,\n    NUCLEAR: 0.0\n  },\n  \n  // å›½å®¶æ ¸å¿ƒæŒ‡æ ‡ç›®æ ‡å€¼\n  NATIONAL_TARGETS: {\n    // å•ä½èƒ½è€—ç¢³æ’æ”¾ç›®æ ‡å€¼ (å¨COâ‚‚/å¨æ ‡å‡†ç…¤)\n    CARBON_INTENSITY_TARGET_MIN: 0.2,\n    CARBON_INTENSITY_TARGET_MAX: 0.3,\n    \n    // æ¸…æ´èƒ½æºæ¶ˆè´¹å æ¯”ç›®æ ‡å€¼ (%)\n    CLEAN_ENERGY_RATIO_TARGET: 90,\n    \n    // å·¥ä¸šå›ºåºŸç»¼åˆåˆ©ç”¨ç‡ç›®æ ‡å€¼ (%)\n    SOLID_WASTE_UTILIZATION_TARGET: 95,\n    \n    // ä½™çƒ­/ä½™å†·/ä½™å‹ç»¼åˆåˆ©ç”¨ç‡ç›®æ ‡å€¼ (%)\n    WASTE_ENERGY_UTILIZATION_TARGET: 80,\n    \n    // å·¥ä¸šç”¨æ°´é‡å¤åˆ©ç”¨ç‡ç›®æ ‡å€¼ (%)\n    WATER_REUSE_TARGET: 90\n  },\n  \n  // èƒ½æºæŠ˜æ ‡ç…¤ç³»æ•°\n  ENERGY_CONVERSION_FACTORS: {\n    // ç”µåŠ›ï¼ˆç­‰ä»·å€¼è®¡ç®—ï¼‰\n    ELECTRICITY_EQUIVALENT: 0.1229, // kgce/kWh\n    \n    // åŒ–çŸ³ç‡ƒæ–™æŠ˜æ ‡ç…¤ç³»æ•°\n    NATURAL_GAS: 1.33, // kgce/mÂ³\n    COAL: 0.7143, // kgce/kg\n    DIESEL: 1.4571, // kgce/kg\n    GASOLINE: 1.4714, // kgce/kg\n    HEAVY_OIL: 1.4286, // kgce/kg\n    LPG: 1.7143, // kgce/kg\n    \n    // çƒ­åŠ›æŠ˜æ ‡ç…¤ç³»æ•°\n    HEAT: 0.03412 // kgce/MJ\n  },\n  \n  // è®¡ç®—ç²¾åº¦\n  CALCULATION_PRECISION: {\n    EMISSION_DECIMAL_PLACES: 4,\n    RATIO_DECIMAL_PLACES: 2,\n    ENERGY_DECIMAL_PLACES: 3\n  },\n  \n  // æ•°æ®è´¨é‡é˜ˆå€¼\n  DATA_QUALITY_THRESHOLDS: {\n    COMPLETENESS_MIN: 0.95, // æ•°æ®å®Œæ•´æ€§æœ€ä½è¦æ±‚95%\n    ACCURACY_MIN: 0.99, // æ•°æ®å‡†ç¡®æ€§æœ€ä½è¦æ±‚99%\n    TIMELINESS_MAX_DELAY: 60 * 60 * 1000 // æ•°æ®æ—¶æ•ˆæ€§æœ€å¤§å»¶è¿Ÿ1å°æ—¶\n  }\n};\n\n// å¯¼å‡ºæ‰€æœ‰å¸¸é‡çš„ç»„åˆå¯¹è±¡\nexport const ALL_CONSTANTS = {\n  ...MATH_CONSTANTS,\n  ...TIME_INTERVALS,\n  ...STORAGE_CONSTANTS,\n  ...PREVIOUS_TIME_RANGES,\n  ...ENERGY_CONSTANTS,\n  ...CARBON_CONSTANTS,\n  ...HTTP_STATUS_CODES,\n  ...DATA_PROCESSING_CONSTANTS,\n  ...DEVICE_CONSTANTS,\n  ...ALGORITHM_CONSTANTS,\n  ...SECURITY_CONSTANTS,\n  ...MONITORING_CONSTANTS\n};\n\nexport default ALL_CONSTANTS;","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/database/QueryOptimizer.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":11,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":11,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":13,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":13,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300000.","line":237,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":237,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":295,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":295,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":295,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":295,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":356,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":356,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":356,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":356,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":396,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":396,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":446,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":446,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30000.","line":448,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":448,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300000.","line":449,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":449,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { performance } from 'perf_hooks';\nimport logger from '../../interfaces/http/utils/logger.js';\n\n/**\n * æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å™¨\n */\nexport class QueryOptimizer {\n  constructor(options = {}) {\n    this.options = {\n      enableQueryLogging: options.enableQueryLogging !== false,\n      slowQueryThreshold: options.slowQueryThreshold || 1000, // 1ç§’\n      enableQueryCache: options.enableQueryCache !== false,\n      cacheSize: options.cacheSize || 100,\n      enableExplainPlan: options.enableExplainPlan || false,\n      ...options\n    };\n\n    this.queryCache = new Map();\n    this.queryStats = new Map();\n    this.preparedStatements = new Map();\n  }\n\n  /**\n   * æ‰§è¡Œä¼˜åŒ–çš„æŸ¥è¯¢\n   */\n  async executeQuery(db, sql, params = [], options = {}) {\n    const startTime = performance.now();\n    const queryKey = this.generateQueryKey(sql, params);\n\n    try {\n      // æ£€æŸ¥æŸ¥è¯¢ç¼“å­˜\n      if (this.options.enableQueryCache && options.useCache !== false) {\n        const cached = this.queryCache.get(queryKey);\n        if (cached && !this.isCacheExpired(cached)) {\n          this.recordQueryStats(sql, performance.now() - startTime, true);\n          return cached.result;\n        }\n      }\n\n      // æ‰§è¡ŒæŸ¥è¯¢\n      let result;\n      if (options.useTransaction) {\n        result = await this.executeInTransaction(db, sql, params);\n      } else if (options.usePreparedStatement) {\n        result = await this.executePreparedStatement(db, sql, params);\n      } else {\n        result = await this.executeDirectQuery(db, sql, params);\n      }\n\n      const executionTime = performance.now() - startTime;\n\n      // è®°å½•æŸ¥è¯¢ç»Ÿè®¡\n      this.recordQueryStats(sql, executionTime, false);\n\n      // ç¼“å­˜ç»“æœ\n      if (this.options.enableQueryCache && options.useCache !== false && this.isCacheable(sql)) {\n        this.cacheResult(queryKey, result, options.cacheTTL);\n      }\n\n      // è®°å½•æ…¢æŸ¥è¯¢\n      if (executionTime > this.options.slowQueryThreshold) {\n        this.logSlowQuery(sql, params, executionTime);\n      }\n\n      return result;\n    } catch (error) {\n      const executionTime = performance.now() - startTime;\n      this.recordQueryStats(sql, executionTime, false, error);\n      throw error;\n    }\n  }\n\n  /**\n   * ç›´æ¥æ‰§è¡ŒæŸ¥è¯¢\n   */\n  async executeDirectQuery(db, sql, params) {\n    if (params && params.length > 0) {\n      return new Promise((resolve, reject) => {\n        db.all(sql, params, (err, rows) => {\n          if (err) {\n            reject(err);\n          } else {\n            resolve(rows);\n          }\n        });\n      });\n    }\n    return new Promise((resolve, reject) => {\n      db.all(sql, (err, rows) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(rows);\n        }\n      });\n    });\n  }\n\n  /**\n   * ä½¿ç”¨é¢„å¤„ç†è¯­å¥æ‰§è¡ŒæŸ¥è¯¢\n   */\n  async executePreparedStatement(db, sql, params) {\n    const stmtKey = this.generateStatementKey(sql);\n\n    if (!this.preparedStatements.has(stmtKey)) {\n      const stmt = db.prepare(sql);\n      this.preparedStatements.set(stmtKey, stmt);\n    }\n\n    const stmt = this.preparedStatements.get(stmtKey);\n\n    return new Promise((resolve, reject) => {\n      stmt.all(params, (err, rows) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(rows);\n        }\n      });\n    });\n  }\n\n  /**\n   * åœ¨äº‹åŠ¡ä¸­æ‰§è¡ŒæŸ¥è¯¢\n   */\n  async executeInTransaction(db, sql, params) {\n    return new Promise((resolve, reject) => {\n      db.serialize(() => {\n        db.run('BEGIN TRANSACTION');\n\n        db.all(sql, params, (err, rows) => {\n          if (err) {\n            db.run('ROLLBACK', (rollbackErr) => {\n              if (rollbackErr) {\n                logger.error('äº‹åŠ¡å›æ»šå¤±è´¥', { error: rollbackErr.message });\n              }\n              reject(err);\n            });\n          } else {\n            db.run('COMMIT', (commitErr) => {\n              if (commitErr) {\n                reject(commitErr);\n              } else {\n                resolve(rows);\n              }\n            });\n          }\n        });\n      });\n    });\n  }\n\n  /**\n   * æ‰¹é‡æ‰§è¡ŒæŸ¥è¯¢\n   */\n  async executeBatch(db, queries) {\n    const results = [];\n    const startTime = performance.now();\n\n    return new Promise((resolve, reject) => {\n      db.serialize(() => {\n        db.run('BEGIN TRANSACTION');\n\n        let completed = 0;\n        let hasError = false;\n\n        queries.forEach((query, index) => {\n          const { sql, params = [] } = query;\n\n          db.all(sql, params, (err, rows) => {\n            if (err && !hasError) {\n              hasError = true;\n              db.run('ROLLBACK', () => {\n                reject(err);\n              });\n              return;\n            }\n\n            if (!hasError) {\n              results[index] = rows;\n              completed++;\n\n              if (completed === queries.length) {\n                db.run('COMMIT', (commitErr) => {\n                  if (commitErr) {\n                    reject(commitErr);\n                  } else {\n                    const executionTime = performance.now() - startTime;\n                    logger.info('æ‰¹é‡æŸ¥è¯¢å®Œæˆ', {\n                      queryCount: queries.length,\n                      executionTime: `${executionTime.toFixed(2)}ms`\n                    });\n                    resolve(results);\n                  }\n                });\n              }\n            }\n          });\n        });\n      });\n    });\n  }\n\n  /**\n   * ç”ŸæˆæŸ¥è¯¢ç¼“å­˜é”®\n   */\n  generateQueryKey(sql, params) {\n    const normalizedSql = sql.replace(/\\s+/g, ' ').trim().toLowerCase();\n    const paramsStr = JSON.stringify(params || []);\n    return `${normalizedSql}:${paramsStr}`;\n  }\n\n  /**\n   * ç”Ÿæˆé¢„å¤„ç†è¯­å¥é”®\n   */\n  generateStatementKey(sql) {\n    return sql.replace(/\\s+/g, ' ').trim().toLowerCase();\n  }\n\n  /**\n   * åˆ¤æ–­æŸ¥è¯¢æ˜¯å¦å¯ç¼“å­˜\n   */\n  isCacheable(sql) {\n    const normalizedSql = sql.toLowerCase().trim();\n    // åªç¼“å­˜SELECTæŸ¥è¯¢ï¼Œæ’é™¤åŒ…å«NOW()ã€RANDOM()ç­‰å‡½æ•°çš„æŸ¥è¯¢\n    return (\n      normalizedSql.startsWith('select') &&\n      !normalizedSql.includes('now()') &&\n      !normalizedSql.includes('random()') &&\n      !normalizedSql.includes('current_timestamp')\n    );\n  }\n\n  /**\n   * ç¼“å­˜æŸ¥è¯¢ç»“æœ\n   */\n  cacheResult(queryKey, result, ttl = 300000) {\n    // é»˜è®¤5åˆ†é’Ÿ\n    // å¦‚æœç¼“å­˜å·²æ»¡ï¼Œåˆ é™¤æœ€æ—§çš„æ¡ç›®\n    if (this.queryCache.size >= this.options.cacheSize) {\n      const firstKey = this.queryCache.keys().next().value;\n      this.queryCache.delete(firstKey);\n    }\n\n    this.queryCache.set(queryKey, {\n      result: JSON.parse(JSON.stringify(result)), // æ·±æ‹·è´\n      timestamp: Date.now(),\n      ttl\n    });\n  }\n\n  /**\n   * æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ\n   */\n  isCacheExpired(cached) {\n    return Date.now() - cached.timestamp > cached.ttl;\n  }\n\n  /**\n   * è®°å½•æŸ¥è¯¢ç»Ÿè®¡\n   */\n  recordQueryStats(sql, executionTime, fromCache, error = null) {\n    const queryType = this.getQueryType(sql);\n\n    if (!this.queryStats.has(queryType)) {\n      this.queryStats.set(queryType, {\n        count: 0,\n        totalTime: 0,\n        avgTime: 0,\n        minTime: Infinity,\n        maxTime: 0,\n        cacheHits: 0,\n        errors: 0\n      });\n    }\n\n    const stats = this.queryStats.get(queryType);\n    stats.count++;\n\n    if (fromCache) {\n      stats.cacheHits++;\n    } else {\n      stats.totalTime += executionTime;\n      stats.avgTime = stats.totalTime / (stats.count - stats.cacheHits);\n      stats.minTime = Math.min(stats.minTime, executionTime);\n      stats.maxTime = Math.max(stats.maxTime, executionTime);\n    }\n\n    if (error) {\n      stats.errors++;\n    }\n\n    if (this.options.enableQueryLogging) {\n      logger.debug('æŸ¥è¯¢æ‰§è¡Œ', {\n        sql: sql.substring(0, 100) + (sql.length > 100 ? '...' : ''),\n        executionTime: `${executionTime.toFixed(2)}ms`,\n        fromCache,\n        queryType\n      });\n    }\n  }\n\n  /**\n   * è·å–æŸ¥è¯¢ç±»å‹\n   */\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 23 è¡Œ)\n\n  getQueryType(sql) {\n    const normalizedSql = sql.toLowerCase().trim();\n    if (normalizedSql.startsWith('select')) {\n      return 'SELECT';\n    }\n    if (normalizedSql.startsWith('insert')) {\n      return 'INSERT';\n    }\n    if (normalizedSql.startsWith('update')) {\n      return 'UPDATE';\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (normalizedSql.startsWith('delete')) {\n      return 'DELETE';\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (normalizedSql.startsWith('create')) {\n      return 'CREATE';\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (normalizedSql.startsWith('drop')) {\n      return 'DROP';\n    }\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    // TODO: è€ƒè™‘ä½¿ç”¨æ—©æœŸè¿”å›æˆ–ç­–ç•¥æ¨¡å¼æ¥å‡å°‘åµŒå¥—\n    if (normalizedSql.startsWith('alter')) {\n      return 'ALTER';\n    }\n    return 'OTHER';\n  }\n\n  /**\n   * è®°å½•æ…¢æŸ¥è¯¢\n   */\n  logSlowQuery(sql, params, executionTime) {\n    logger.warn('æ…¢æŸ¥è¯¢æ£€æµ‹', {\n      sql: sql.substring(0, 200) + (sql.length > 200 ? '...' : ''),\n      params: JSON.stringify(params),\n      executionTime: `${executionTime.toFixed(2)}ms`,\n      threshold: `${this.options.slowQueryThreshold}ms`\n    });\n  }\n\n  /**\n   * è·å–æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯\n   */\n  getQueryStats() {\n    const stats = {};\n    for (const [queryType, data] of this.queryStats.entries()) {\n      stats[queryType] = { ...data };\n    }\n    return {\n      queryStats: stats,\n      cacheStats: {\n        size: this.queryCache.size,\n        maxSize: this.options.cacheSize,\n        hitRate: this.calculateCacheHitRate()\n      },\n      preparedStatements: {\n        count: this.preparedStatements.size\n      }\n    };\n  }\n\n  /**\n   * è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡\n   */\n  calculateCacheHitRate() {\n    let totalQueries = 0;\n    let totalCacheHits = 0;\n\n    for (const stats of this.queryStats.values()) {\n      totalQueries += stats.count;\n      totalCacheHits += stats.cacheHits;\n    }\n\n    return totalQueries > 0 ? ((totalCacheHits / totalQueries) * 100).toFixed(2) : 0;\n  }\n\n  /**\n   * æ¸…ç†ç¼“å­˜\n   */\n  clearCache() {\n    this.queryCache.clear();\n    logger.info('æŸ¥è¯¢ç¼“å­˜å·²æ¸…ç†');\n  }\n\n  /**\n   * æ¸…ç†é¢„å¤„ç†è¯­å¥\n   */\n  clearPreparedStatements() {\n    for (const stmt of this.preparedStatements.values()) {\n      try {\n        stmt.finalize();\n      } catch (error) {\n        logger.error('æ¸…ç†é¢„å¤„ç†è¯­å¥å¤±è´¥', { error: error.message });\n      }\n    }\n    this.preparedStatements.clear();\n    logger.info('é¢„å¤„ç†è¯­å¥å·²æ¸…ç†');\n  }\n\n  /**\n   * é‡ç½®ç»Ÿè®¡ä¿¡æ¯\n   */\n  resetStats() {\n    this.queryStats.clear();\n    logger.info('æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®');\n  }\n\n  /**\n   * å…³é—­ä¼˜åŒ–å™¨\n   */\n  close() {\n    this.clearCache();\n    this.clearPreparedStatements();\n    this.resetStats();\n  }\n}\n\n/**\n * æ•°æ®åº“è¿æ¥æ± ç®¡ç†å™¨\n */\nexport class ConnectionPoolManager {\n  constructor(options = {}) {\n    this.options = {\n      maxConnections: options.maxConnections || 10,\n      minConnections: options.minConnections || 2,\n      acquireTimeout: options.acquireTimeout || 30000,\n      idleTimeout: options.idleTimeout || 300000,\n      ...options\n    };\n\n    this.pool = [];\n    this.activeConnections = new Set();\n    this.waitingQueue = [];\n    this.stats = {\n      created: 0,\n      acquired: 0,\n      released: 0,\n      destroyed: 0,\n      timeouts: 0\n    };\n  }\n\n  /**\n   * è·å–è¿æ¥\n   */\n  async acquire() {\n    return new Promise((resolve, reject) => {\n      // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨è¿æ¥\n      const availableConnection = this.pool.find((conn) => !conn.inUse);\n      if (availableConnection) {\n        availableConnection.inUse = true;\n        availableConnection.lastUsed = Date.now();\n        this.activeConnections.add(availableConnection);\n        this.stats.acquired++;\n        resolve(availableConnection.connection);\n        return;\n      }\n\n      // å¦‚æœå¯ä»¥åˆ›å»ºæ–°è¿æ¥\n      if (this.pool.length < this.options.maxConnections) {\n        this.createConnection()\n          .then((connection) => {\n            this.stats.acquired++;\n            resolve(connection);\n          })\n          .catch(reject);\n        return;\n      }\n\n      // åŠ å…¥ç­‰å¾…é˜Ÿåˆ—\n      const timeout = setTimeout(() => {\n        const index = this.waitingQueue.findIndex((item) => item.resolve === resolve);\n        if (index !== -1) {\n          this.waitingQueue.splice(index, 1);\n          this.stats.timeouts++;\n          reject(new Error('è·å–æ•°æ®åº“è¿æ¥è¶…æ—¶'));\n        }\n      }, this.options.acquireTimeout);\n\n      this.waitingQueue.push({ resolve, reject, timeout });\n    });\n  }\n\n  /**\n   * é‡Šæ”¾è¿æ¥\n   */\n  release(connection) {\n    const poolConnection = this.pool.find((conn) => conn.connection === connection);\n    if (poolConnection) {\n      poolConnection.inUse = false;\n      poolConnection.lastUsed = Date.now();\n      this.activeConnections.delete(poolConnection);\n      this.stats.released++;\n\n      // å¤„ç†ç­‰å¾…é˜Ÿåˆ—\n      if (this.waitingQueue.length > 0) {\n        const { resolve, timeout } = this.waitingQueue.shift();\n        clearTimeout(timeout);\n        poolConnection.inUse = true;\n        poolConnection.lastUsed = Date.now();\n        this.activeConnections.add(poolConnection);\n        this.stats.acquired++;\n        resolve(connection);\n      }\n    }\n  }\n\n  /**\n   * åˆ›å»ºæ–°è¿æ¥\n   */\n  async createConnection() {\n    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„æ•°æ®åº“ç±»å‹å®ç°\n    // ç¤ºä¾‹ä½¿ç”¨SQLite\n    const sqlite3 = require('sqlite3').verbose();\n    const connection = new sqlite3.Database(':memory:');\n\n    const poolConnection = {\n      connection,\n      inUse: true,\n      created: Date.now(),\n      lastUsed: Date.now()\n    };\n\n    this.pool.push(poolConnection);\n    this.activeConnections.add(poolConnection);\n    this.stats.created++;\n\n    return connection;\n  }\n\n  /**\n   * æ¸…ç†ç©ºé—²è¿æ¥\n   */\n  cleanupIdleConnections() {\n    const now = Date.now();\n    const connectionsToRemove = [];\n\n    for (const poolConnection of this.pool) {\n      if (\n        !poolConnection.inUse &&\n        now - poolConnection.lastUsed > this.options.idleTimeout &&\n        this.pool.length > this.options.minConnections\n      ) {\n        connectionsToRemove.push(poolConnection);\n      }\n    }\n\n    for (const poolConnection of connectionsToRemove) {\n      this.destroyConnection(poolConnection);\n    }\n  }\n\n  /**\n   * é”€æ¯è¿æ¥\n   */\n  destroyConnection(poolConnection) {\n    try {\n      poolConnection.connection.close();\n      const index = this.pool.indexOf(poolConnection);\n      if (index !== -1) {\n        this.pool.splice(index, 1);\n      }\n      this.activeConnections.delete(poolConnection);\n      this.stats.destroyed++;\n    } catch (error) {\n      logger.error('é”€æ¯æ•°æ®åº“è¿æ¥å¤±è´¥', { error: error.message });\n    }\n  }\n\n  /**\n   * è·å–è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯\n   */\n  getStats() {\n    return {\n      ...this.stats,\n      totalConnections: this.pool.length,\n      activeConnections: this.activeConnections.size,\n      idleConnections: this.pool.length - this.activeConnections.size,\n      waitingRequests: this.waitingQueue.length,\n      maxConnections: this.options.maxConnections,\n      minConnections: this.options.minConnections\n    };\n  }\n\n  /**\n   * å…³é—­è¿æ¥æ± \n   */\n  async close() {\n    // æ¸…ç†ç­‰å¾…é˜Ÿåˆ—\n    for (const { reject, timeout } of this.waitingQueue) {\n      clearTimeout(timeout);\n      reject(new Error('è¿æ¥æ± æ­£åœ¨å…³é—­'));\n    }\n    this.waitingQueue = [];\n\n    // å…³é—­æ‰€æœ‰è¿æ¥\n    for (const poolConnection of this.pool) {\n      this.destroyConnection(poolConnection);\n    }\n\n    logger.info('æ•°æ®åº“è¿æ¥æ± å·²å…³é—­');\n  }\n}\n\n// å¯¼å‡ºé»˜è®¤å®ä¾‹\nexport const defaultQueryOptimizer = new QueryOptimizer();\nexport const defaultConnectionPool = new ConnectionPoolManager();\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/middleware/enhancedErrorHandler.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":25,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":25,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":43,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":43,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":51,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":51,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":59,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":59,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":67,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":67,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 409.","line":75,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":75,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":83,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":83,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 502.","line":90,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":90,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 429.","line":100,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":100,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":112,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":112,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":128,"column":69,"nodeType":"Literal","messageId":"noMagic","endLine":128,"endColumn":72},{"ruleId":"no-unused-vars","severity":2,"message":"'next' is defined but never used. Allowed unused args must match /^_/u.","line":194,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":194,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":215,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":215,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":222,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":222,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":243,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":243,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":261,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":261,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":261,"endColumn":70},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":282,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":282,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60000.","line":282,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":282,"endColumn":72},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 503.","line":296,"column":63,"nodeType":"Literal","messageId":"noMagic","endLine":296,"endColumn":66}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":19,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * å¢å¼ºçš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶\n * æä¾›ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼å’Œé”™è¯¯åˆ†ç±»\n */\n\nimport { logger } from '../utils/logger.js';\n\n// é”™è¯¯ç±»å‹æšä¸¾\nexport const ErrorTypes = {\n  VALIDATION_ERROR: 'VALIDATION_ERROR',\n  AUTHENTICATION_ERROR: 'AUTHENTICATION_ERROR',\n  AUTHORIZATION_ERROR: 'AUTHORIZATION_ERROR',\n  NOT_FOUND_ERROR: 'NOT_FOUND_ERROR',\n  CONFLICT_ERROR: 'CONFLICT_ERROR',\n  DATABASE_ERROR: 'DATABASE_ERROR',\n  EXTERNAL_SERVICE_ERROR: 'EXTERNAL_SERVICE_ERROR',\n  RATE_LIMIT_ERROR: 'RATE_LIMIT_ERROR',\n  INTERNAL_SERVER_ERROR: 'INTERNAL_SERVER_ERROR'\n};\n\n// è‡ªå®šä¹‰é”™è¯¯ç±»\nexport class AppError extends Error {\n  constructor(\n    message,\n    statusCode = 500,\n    errorType = ErrorTypes.INTERNAL_SERVER_ERROR,\n    details = null\n  ) {\n    super(message);\n    this.name = 'AppError';\n    this.statusCode = statusCode;\n    this.errorType = errorType;\n    this.details = details;\n    this.isOperational = true;\n\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\n// éªŒè¯é”™è¯¯\nexport class ValidationError extends AppError {\n  constructor(message, details = null) {\n    super(message, 400, ErrorTypes.VALIDATION_ERROR, details);\n    this.name = 'ValidationError';\n  }\n}\n\n// è®¤è¯é”™è¯¯\nexport class AuthenticationError extends AppError {\n  constructor(message = 'è®¤è¯å¤±è´¥') {\n    super(message, 401, ErrorTypes.AUTHENTICATION_ERROR);\n    this.name = 'AuthenticationError';\n  }\n}\n\n// æˆæƒé”™è¯¯\nexport class AuthorizationError extends AppError {\n  constructor(message = 'æƒé™ä¸è¶³') {\n    super(message, 403, ErrorTypes.AUTHORIZATION_ERROR);\n    this.name = 'AuthorizationError';\n  }\n}\n\n// èµ„æºæœªæ‰¾åˆ°é”™è¯¯\nexport class NotFoundError extends AppError {\n  constructor(resource = 'èµ„æº') {\n    super(`${resource}æœªæ‰¾åˆ°`, 404, ErrorTypes.NOT_FOUND_ERROR);\n    this.name = 'NotFoundError';\n  }\n}\n\n// å†²çªé”™è¯¯\nexport class ConflictError extends AppError {\n  constructor(message = 'èµ„æºå†²çª') {\n    super(message, 409, ErrorTypes.CONFLICT_ERROR);\n    this.name = 'ConflictError';\n  }\n}\n\n// æ•°æ®åº“é”™è¯¯\nexport class DatabaseError extends AppError {\n  constructor(message, originalError = null) {\n    super(message, 500, ErrorTypes.DATABASE_ERROR, originalError);\n    this.name = 'DatabaseError';\n  }\n}\n\n// å¤–éƒ¨æœåŠ¡é”™è¯¯\nexport class ExternalServiceError extends AppError {\n  constructor(service, message, statusCode = 502) {\n    super(`${service}æœåŠ¡é”™è¯¯: ${message}`, statusCode, ErrorTypes.EXTERNAL_SERVICE_ERROR);\n    this.name = 'ExternalServiceError';\n    this.service = service;\n  }\n}\n\n// é™æµé”™è¯¯\nexport class RateLimitError extends AppError {\n  constructor(message = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•') {\n    super(message, 429, ErrorTypes.RATE_LIMIT_ERROR);\n    this.name = 'RateLimitError';\n  }\n}\n\n// é”™è¯¯å“åº”æ ¼å¼åŒ–\nfunction formatErrorResponse(error, req) {\n  const response = {\n    success: false,\n    error: {\n      type: error.errorType || ErrorTypes.INTERNAL_SERVER_ERROR,\n      message: error.message,\n      code: error.statusCode || 500\n    },\n    timestamp: new Date().toISOString(),\n    path: req.originalUrl,\n    method: req.method\n  };\n\n  // å¼€å‘ç¯å¢ƒä¸‹åŒ…å«æ›´å¤šè°ƒè¯•ä¿¡æ¯\n  if (process.env.NODE_ENV === 'development') {\n    response.error.stack = error.stack;\n    if (error.details) {\n      response.error.details = error.details;\n    }\n  }\n\n  // ç”Ÿäº§ç¯å¢ƒä¸‹éšè—æ•æ„Ÿä¿¡æ¯\n  if (process.env.NODE_ENV === 'production' && error.statusCode === 500) {\n    response.error.message = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';\n  }\n\n  return response;\n}\n\n// æ•°æ®åº“é”™è¯¯å¤„ç†\nfunction handleDatabaseError(error) {\n  // SQLiteé”™è¯¯å¤„ç†\n  if (error.code === 'SQLITE_CONSTRAINT_UNIQUE') {\n    return new ConflictError('æ•°æ®å·²å­˜åœ¨ï¼Œè¯·æ£€æŸ¥å”¯ä¸€æ€§çº¦æŸ');\n  }\n\n  if (error.code === 'SQLITE_CONSTRAINT_FOREIGNKEY') {\n    return new ValidationError('å¤–é”®çº¦æŸè¿åï¼Œè¯·æ£€æŸ¥å…³è”æ•°æ®');\n  }\n\n  if (error.message && error.message.includes('no such column')) {\n    return new DatabaseError('æ•°æ®åº“ç»“æ„é”™è¯¯ï¼Œè¯·æ£€æŸ¥å­—æ®µåç§°');\n  }\n\n  if (error.message && error.message.includes('no such table')) {\n    return new DatabaseError('æ•°æ®è¡¨ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿ç§»');\n  }\n\n  // Knex.jsé”™è¯¯å¤„ç†\n  if (error.code === 'ER_DUP_ENTRY') {\n    return new ConflictError('æ•°æ®é‡å¤ï¼Œè¯·æ£€æŸ¥å”¯ä¸€æ€§çº¦æŸ');\n  }\n\n  if (error.code === 'ER_NO_REFERENCED_ROW_2') {\n    return new ValidationError('å¤–é”®çº¦æŸè¿åï¼Œå…³è”æ•°æ®ä¸å­˜åœ¨');\n  }\n\n  return new DatabaseError('æ•°æ®åº“æ“ä½œå¤±è´¥', error);\n}\n\n// JWTé”™è¯¯å¤„ç†\nfunction handleJWTError(error) {\n  if (error.name === 'JsonWebTokenError') {\n    return new AuthenticationError('æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ');\n  }\n\n  if (error.name === 'TokenExpiredError') {\n    return new AuthenticationError('è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ');\n  }\n\n  if (error.name === 'NotBeforeError') {\n    return new AuthenticationError('è®¿é—®ä»¤ç‰Œå°šæœªç”Ÿæ•ˆ');\n  }\n\n  return new AuthenticationError('ä»¤ç‰ŒéªŒè¯å¤±è´¥');\n}\n\n// éªŒè¯é”™è¯¯å¤„ç†\nfunction handleValidationError(error) {\n  if (error.name === 'ValidationError' && error.details) {\n    const messages = error.details.map((detail) => detail.message);\n    return new ValidationError('æ•°æ®éªŒè¯å¤±è´¥', messages);\n  }\n\n  return new ValidationError(error.message);\n}\n\n// ä¸»é”™è¯¯å¤„ç†ä¸­é—´ä»¶\nexport function enhancedErrorHandler(error, req, res, next) {\n  let processedError = error;\n\n  // å¦‚æœä¸æ˜¯è‡ªå®šä¹‰é”™è¯¯ï¼Œè¿›è¡Œé”™è¯¯è½¬æ¢\n  if (!error.isOperational) {\n    // æ•°æ®åº“é”™è¯¯\n    if (error.code && (error.code.startsWith('SQLITE_') || error.code.startsWith('ER_'))) {\n      processedError = handleDatabaseError(error);\n    }\n    // JWTé”™è¯¯\n    else if (error.name && error.name.includes('Token')) {\n      processedError = handleJWTError(error);\n    }\n    // éªŒè¯é”™è¯¯\n    else if (error.name === 'ValidationError') {\n      processedError = handleValidationError(error);\n    }\n    // å…¶ä»–æœªçŸ¥é”™è¯¯\n    else {\n      processedError = new AppError(\n        error.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',\n        error.statusCode || 500,\n        ErrorTypes.INTERNAL_SERVER_ERROR\n      );\n    }\n  }\n\n  // è®°å½•é”™è¯¯æ—¥å¿—\n  const logLevel = processedError.statusCode >= 500 ? 'error' : 'warn';\n  logger[logLevel]('è¯·æ±‚å¤„ç†é”™è¯¯', {\n    error: {\n      name: processedError.name,\n      message: processedError.message,\n      type: processedError.errorType,\n      statusCode: processedError.statusCode,\n      stack: processedError.stack\n    },\n    request: {\n      method: req.method,\n      url: req.originalUrl,\n      ip: req.ip,\n      userAgent: req.get('User-Agent'),\n      userId: req.user?.id,\n      body: req.method !== 'GET' ? req.body : undefined\n    }\n  });\n\n  // å‘é€é”™è¯¯å“åº”\n  const errorResponse = formatErrorResponse(processedError, req);\n  res.status(processedError.statusCode || 500).json(errorResponse);\n}\n\n// 404é”™è¯¯å¤„ç†ä¸­é—´ä»¶\nexport function notFoundHandler(req, res, next) {\n  const error = new NotFoundError(`è·¯ç”± ${req.originalUrl}`);\n  next(error);\n}\n\n// å¼‚æ­¥é”™è¯¯æ•è·åŒ…è£…å™¨\nexport function asyncHandler(fn) {\n  return (req, res, next) => {\n    Promise.resolve(fn(req, res, next)).catch(next);\n  };\n}\n\n// é”™è¯¯æ¢å¤ç­–ç•¥\nexport class ErrorRecoveryStrategy {\n  static async retryOperation(operation, maxRetries = 3, delay = 1000) {\n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\n      try {\n        return await operation();\n      } catch (error) {\n        if (attempt === maxRetries) {\n          throw error;\n        }\n\n        // æŒ‡æ•°é€€é¿\n        const waitTime = delay * Math.pow(2, attempt - 1);\n        await new Promise((resolve) => setTimeout(resolve, waitTime));\n\n        logger.warn(`æ“ä½œé‡è¯• ${attempt}/${maxRetries}`, {\n          error: error.message,\n          nextRetryIn: waitTime\n        });\n      }\n    }\n  }\n\n  static async circuitBreaker(operation, threshold = 5, timeout = 60000) {\n    // ç®€å•çš„æ–­è·¯å™¨å®ç°\n    const key = operation.name || 'default';\n\n    if (!this.failures) {\n      this.failures = new Map();\n    }\n\n    const failures = this.failures.get(key) || { count: 0, lastFailure: 0 };\n\n    // æ£€æŸ¥æ–­è·¯å™¨çŠ¶æ€\n    if (failures.count >= threshold) {\n      const timeSinceLastFailure = Date.now() - failures.lastFailure;\n      if (timeSinceLastFailure < timeout) {\n        throw new ExternalServiceError('æœåŠ¡', 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•', 503);\n      } else {\n        // é‡ç½®è®¡æ•°å™¨\n        failures.count = 0;\n      }\n    }\n\n    try {\n      const result = await operation();\n      // æˆåŠŸæ—¶é‡ç½®è®¡æ•°å™¨\n      failures.count = 0;\n      this.failures.set(key, failures);\n      return result;\n    } catch (error) {\n      // å¤±è´¥æ—¶å¢åŠ è®¡æ•°å™¨\n      failures.count++;\n      failures.lastFailure = Date.now();\n      this.failures.set(key, failures);\n      throw error;\n    }\n  }\n}\n\n// å¥åº·æ£€æŸ¥é”™è¯¯å¤„ç†\nexport function healthCheckErrorHandler(error) {\n  if (error.code === 'ECONNREFUSED') {\n    return {\n      status: 'unhealthy',\n      error: 'æ•°æ®åº“è¿æ¥å¤±è´¥',\n      details: error.message\n    };\n  }\n\n  if (error.code === 'ETIMEDOUT') {\n    return {\n      status: 'unhealthy',\n      error: 'æœåŠ¡å“åº”è¶…æ—¶',\n      details: error.message\n    };\n  }\n\n  return {\n    status: 'unhealthy',\n    error: 'å¥åº·æ£€æŸ¥å¤±è´¥',\n    details: error.message\n  };\n}\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/middleware/errorHandler.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'next' is defined but never used. Allowed unused args must match /^_/u.","line":11,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":16,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":16,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":41,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":41,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":43,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":43,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":90,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":90,"endColumn":62},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 409.","line":106,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":106,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":112,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":112,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":116,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":116,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":122,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":122,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":134,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":134,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":138,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":138,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":141,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":141,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import logger from '../utils/logger.js';\nimport { AppError } from '../utils/AppError.js';\n\n/**\n * ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶\n * @param {Error} err - é”™è¯¯å¯¹è±¡\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n * @param {Function} next - ä¸‹ä¸€ä¸ªä¸­é—´ä»¶\n */\nconst errorHandler = (err, req, res, next) => {\n  let error = err;\n\n  // å¦‚æœä¸æ˜¯ AppError å®ä¾‹ï¼Œè½¬æ¢ä¸º AppError\n  if (!(error instanceof AppError)) {\n    const statusCode = error.statusCode || 500;\n    const message = error.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';\n    error = new AppError(message, statusCode);\n  }\n\n  // è®°å½•é”™è¯¯æ—¥å¿—\n  const logData = {\n    error: {\n      message: error.message,\n      statusCode: error.statusCode,\n      errorCode: error.errorCode,\n      stack: error.stack\n    },\n    request: {\n      method: req.method,\n      url: req.originalUrl,\n      ip: req.ip,\n      userAgent: req.get('User-Agent'),\n      userId: req.user?.id,\n      body: req.method !== 'GET' ? req.body : undefined\n    },\n    timestamp: new Date().toISOString()\n  };\n\n  // æ ¹æ®é”™è¯¯çº§åˆ«è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—\n  if (error.statusCode >= 500) {\n    logger.error('æœåŠ¡å™¨é”™è¯¯', logData);\n  } else if (error.statusCode >= 400) {\n    logger.warn('å®¢æˆ·ç«¯é”™è¯¯', logData);\n  } else {\n    logger.info('è¯·æ±‚é”™è¯¯', logData);\n  }\n\n  // æ„å»ºå“åº”æ•°æ®\n  const responseData = {\n    success: false,\n    error: {\n      code: error.errorCode,\n      message: error.message,\n      details: error.details,\n      timestamp: error.timestamp\n    }\n  };\n\n  // å¼€å‘ç¯å¢ƒä¸‹åŒ…å«å †æ ˆä¿¡æ¯\n  if (process.env.NODE_ENV === 'development') {\n    responseData.error.stack = error.stack;\n    responseData.error.request = {\n      method: req.method,\n      url: req.originalUrl\n    };\n  }\n\n  // å‘é€é”™è¯¯å“åº”\n  res.status(error.statusCode).json(responseData);\n};\n\n/**\n * å¼‚æ­¥é”™è¯¯åŒ…è£…å™¨\n * ç”¨äºåŒ…è£…å¼‚æ­¥è·¯ç”±å¤„ç†å™¨ï¼Œè‡ªåŠ¨æ•è·å¼‚æ­¥é”™è¯¯\n * @param {Function} fn - å¼‚æ­¥å‡½æ•°\n * @returns {Function} åŒ…è£…åçš„å‡½æ•°\n */\nconst asyncHandler = (fn) => (req, res, next) => {\n  Promise.resolve(fn(req, res, next)).catch(next);\n};\n\n/**\n * 404 é”™è¯¯å¤„ç†ä¸­é—´ä»¶\n * @param {Object} req - è¯·æ±‚å¯¹è±¡\n * @param {Object} res - å“åº”å¯¹è±¡\n * @param {Function} next - ä¸‹ä¸€ä¸ªä¸­é—´ä»¶\n */\nconst notFoundHandler = (req, res, next) => {\n  const error = new AppError(`è·¯ç”± ${req.originalUrl} æœªæ‰¾åˆ°`, 404, 'ROUTE_NOT_FOUND', {\n    method: req.method,\n    url: req.originalUrl\n  });\n  next(error);\n};\n\n/**\n * æ•°æ®åº“é”™è¯¯è½¬æ¢å™¨\n * å°†æ•°æ®åº“ç‰¹å®šé”™è¯¯è½¬æ¢ä¸ºåº”ç”¨ç¨‹åºé”™è¯¯\n * @param {Error} err - æ•°æ®åº“é”™è¯¯\n * @returns {AppError} åº”ç”¨ç¨‹åºé”™è¯¯\n */\nconst handleDatabaseError = (err) => {\n  // SQLite é”™è¯¯å¤„ç†\n  if (err.code === 'SQLITE_CONSTRAINT_UNIQUE') {\n    return new AppError('æ•°æ®å·²å­˜åœ¨', 409, 'DUPLICATE_ENTRY', {\n      field: err.message.match(/\\.(\\w+)/)?.[1]\n    });\n  }\n\n  if (err.code === 'SQLITE_CONSTRAINT_FOREIGNKEY') {\n    return new AppError('å…³è”æ•°æ®ä¸å­˜åœ¨', 400, 'FOREIGN_KEY_CONSTRAINT');\n  }\n\n  if (err.code === 'SQLITE_CONSTRAINT_NOTNULL') {\n    return new AppError('å¿…å¡«å­—æ®µä¸èƒ½ä¸ºç©º', 400, 'REQUIRED_FIELD_MISSING', {\n      field: err.message.match(/\\.(\\w+)/)?.[1]\n    });\n  }\n\n  // é€šç”¨æ•°æ®åº“é”™è¯¯\n  return new AppError('æ•°æ®åº“æ“ä½œå¤±è´¥', 500, 'DATABASE_ERROR', {\n    originalError: err.message\n  });\n};\n\n/**\n * JWT é”™è¯¯è½¬æ¢å™¨\n * @param {Error} err - JWT é”™è¯¯\n * @returns {AppError} åº”ç”¨ç¨‹åºé”™è¯¯\n */\nconst handleJWTError = (err) => {\n  if (err.name === 'JsonWebTokenError') {\n    return new AppError('æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ', 401, 'INVALID_TOKEN');\n  }\n\n  if (err.name === 'TokenExpiredError') {\n    return new AppError('è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ', 401, 'TOKEN_EXPIRED');\n  }\n\n  return new AppError('ä»¤ç‰ŒéªŒè¯å¤±è´¥', 401, 'TOKEN_VERIFICATION_FAILED');\n};\n\nexport { errorHandler, asyncHandler, notFoundHandler, handleDatabaseError, handleJWTError };\n\nexport default errorHandler;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/middleware/performance.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":22,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":22,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":23,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":23,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":24,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":24,"endColumn":62},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5000.","line":69,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":69,"endColumn":12},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":120,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":120,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":121,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":121,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":121,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":64},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":122,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":122,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":122,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":122,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":122,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":122,"endColumn":66},{"ruleId":"prefer-destructuring","severity":2,"message":"Use array destructuring.","line":127,"column":11,"nodeType":"VariableDeclarator","messageId":"preferDestructuring","endLine":127,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":131,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":131,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":166,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":166,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":166,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":166,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":168,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":168,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":192,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":192,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.95.","line":212,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":212,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.99.","line":213,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":213,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.9.","line":323,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":323,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.9.","line":324,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":324,"endColumn":60},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2000.","line":325,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":325,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":328,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":328,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 503.","line":328,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":328,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":335,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":335,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":336,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":336,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":336,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":336,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":336,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":336,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":337,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":337,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":337,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":341,"column":72,"nodeType":"Literal","messageId":"noMagic","endLine":341,"endColumn":75}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":31,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import os from 'os';\nimport process from 'process';\nimport { performance } from 'perf_hooks';\nimport logger from '../utils/logger.js';\n\n/**\n * æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶\n */\nexport class PerformanceMonitor {\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 44 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 44 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 44 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 44 è¡Œ)\n\n  constructor(options = {}) {\n    this.options = {\n      enableMetrics: options.enableMetrics !== false,\n      enableLogging: options.enableLogging !== false,\n      slowRequestThreshold: options.slowRequestThreshold || 1000, // 1ç§’\n      memoryWarningThreshold: options.memoryWarningThreshold || 0.8, // 80%\n      cpuWarningThreshold: options.cpuWarningThreshold || 0.8, // 80%\n      ...options\n    };\n\n    this.metrics = {\n      requests: {\n        total: 0,\n        success: 0,\n        error: 0,\n        slow: 0\n      },\n      responseTime: {\n        min: Infinity,\n        max: 0,\n        avg: 0,\n        p95: 0,\n        p99: 0\n      },\n      memory: {\n        used: 0,\n        free: 0,\n        total: 0,\n        percentage: 0\n      },\n      cpu: {\n        usage: 0,\n        loadAverage: [0, 0, 0]\n      },\n      errors: new Map(),\n      endpoints: new Map()\n    };\n\n    this.responseTimes = [];\n    this.maxResponseTimeHistory = 1000; // ä¿ç•™æœ€è¿‘1000ä¸ªå“åº”æ—¶é—´\n\n    // æš‚æ—¶ç¦ç”¨ç³»ç»Ÿç›‘æ§ï¼Œé¿å…é«˜èµ„æºä½¿ç”¨ç‡è­¦å‘Š\n    // this.startSystemMonitoring();\n  }\n\n  /**\n   * å¯åŠ¨ç³»ç»Ÿç›‘æ§\n   */\n  startSystemMonitoring() {\n    setInterval(() => {\n      this.updateSystemMetrics();\n    }, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡\n  }\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 29 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 29 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 29 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 29 è¡Œ)\n\n  /**\n   * æ›´æ–°ç³»ç»ŸæŒ‡æ ‡\n   */\n  updateSystemMetrics() {\n    // å†…å­˜ä½¿ç”¨æƒ…å†µ\n    const memUsage = process.memoryUsage();\n    const totalMem = os.totalmem();\n    const freeMem = os.freemem();\n    const usedMem = totalMem - freeMem;\n\n    this.metrics.memory = {\n      used: usedMem,\n      free: freeMem,\n      total: totalMem,\n      percentage: usedMem / totalMem,\n      heap: {\n        used: memUsage.heapUsed,\n        total: memUsage.heapTotal,\n        external: memUsage.external,\n        rss: memUsage.rss\n      }\n    };\n\n    // CPUè´Ÿè½½\n    this.metrics.cpu = {\n      loadAverage: os.loadavg(),\n      cpuCount: os.cpus().length\n    };\n\n    // æ£€æŸ¥è­¦å‘Šé˜ˆå€¼\n    this.checkThresholds();\n  }\n\n  /**\n   * æ£€æŸ¥æ€§èƒ½é˜ˆå€¼\n   */\n  checkThresholds() {\n    // å†…å­˜è­¦å‘Š\n    if (this.metrics.memory.percentage > this.options.memoryWarningThreshold) {\n      logger.warn('å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜', {\n        usage: `${(this.metrics.memory.percentage * 100).toFixed(2)}%`,\n        used: `${(this.metrics.memory.used / 1024 / 1024 / 1024).toFixed(2)}GB`,\n        total: `${(this.metrics.memory.total / 1024 / 1024 / 1024).toFixed(2)}GB`\n      });\n    }\n\n    // CPUè´Ÿè½½è­¦å‘Š\n    const avgLoad = this.metrics.cpu.loadAverage[0];\n    const cpuUsage = avgLoad / this.metrics.cpu.cpuCount;\n    if (cpuUsage > this.options.cpuWarningThreshold) {\n      logger.warn('CPUè´Ÿè½½è¿‡é«˜', {\n        usage: `${(cpuUsage * 100).toFixed(2)}%`,\n        loadAverage: this.metrics.cpu.loadAverage,\n        cpuCount: this.metrics.cpu.cpuCount\n      });\n    }\n  }\n\n  /**\n   * è®°å½•è¯·æ±‚æŒ‡æ ‡\n   */\n  recordRequest(req, res, responseTime) {\n    this.metrics.requests.total++;\n\n    // è®°å½•å“åº”æ—¶é—´\n    this.responseTimes.push(responseTime);\n    if (this.responseTimes.length > this.maxResponseTimeHistory) {\n      this.responseTimes.shift();\n    }\n\n    // æ›´æ–°å“åº”æ—¶é—´ç»Ÿè®¡\n    this.updateResponseTimeStats();\n\n    // è®°å½•æ…¢è¯·æ±‚\n    if (responseTime > this.options.slowRequestThreshold) {\n      this.metrics.requests.slow++;\n      logger.warn('æ…¢è¯·æ±‚æ£€æµ‹', {\n        method: req.method,\n        path: req.path,\n        responseTime: `${responseTime}ms`,\n        userAgent: req.get('User-Agent'),\n        ip: req.ip\n      });\n    }\n\n    // è®°å½•çŠ¶æ€ç \n    if (res.statusCode >= 200 && res.statusCode < 400) {\n      this.metrics.requests.success++;\n    } else if (res.statusCode >= 400) {\n      this.metrics.requests.error++;\n    }\n\n    // è®°å½•ç«¯ç‚¹ç»Ÿè®¡\n    const endpoint = `${req.method} ${req.route?.path || req.path}`;\n    if (!this.metrics.endpoints.has(endpoint)) {\n      this.metrics.endpoints.set(endpoint, {\n        count: 0,\n        totalTime: 0,\n        avgTime: 0,\n        minTime: Infinity,\n        maxTime: 0,\n        errors: 0\n      });\n    }\n\n    const endpointStats = this.metrics.endpoints.get(endpoint);\n    endpointStats.count++;\n    endpointStats.totalTime += responseTime;\n    endpointStats.avgTime = endpointStats.totalTime / endpointStats.count;\n    endpointStats.minTime = Math.min(endpointStats.minTime, responseTime);\n    endpointStats.maxTime = Math.max(endpointStats.maxTime, responseTime);\n\n    if (res.statusCode >= 400) {\n      endpointStats.errors++;\n    }\n  }\n\n  /**\n   * æ›´æ–°å“åº”æ—¶é—´ç»Ÿè®¡\n   */\n  updateResponseTimeStats() {\n    if (this.responseTimes.length === 0) {\n      return;\n    }\n\n    const sorted = [...this.responseTimes].sort((a, b) => a - b);\n    const len = sorted.length;\n\n    this.metrics.responseTime = {\n      min: sorted[0],\n      max: sorted[len - 1],\n      avg: sorted.reduce((sum, time) => sum + time, 0) / len,\n      p95: sorted[Math.floor(len * 0.95)],\n      p99: sorted[Math.floor(len * 0.99)]\n    };\n  }\n\n  /**\n   * è®°å½•é”™è¯¯\n   */\n  recordError(error, req) {\n    const errorKey = `${error.name}: ${error.message}`;\n    const errorCount = this.metrics.errors.get(errorKey) || 0;\n    this.metrics.errors.set(errorKey, errorCount + 1);\n\n    logger.error('è¯·æ±‚å¤„ç†é”™è¯¯', {\n      error: error.message,\n      stack: error.stack,\n      method: req.method,\n      path: req.path,\n      ip: req.ip,\n      userAgent: req.get('User-Agent')\n    });\n  }\n\n  /**\n   * è·å–æ€§èƒ½æŒ‡æ ‡\n   */\n  getMetrics() {\n    return {\n      ...this.metrics,\n      uptime: process.uptime(),\n      timestamp: new Date().toISOString(),\n      nodeVersion: process.version,\n      platform: os.platform(),\n      arch: os.arch()\n    };\n  }\n\n  /**\n   * é‡ç½®æŒ‡æ ‡\n   */\n  resetMetrics() {\n    this.metrics.requests = {\n      total: 0,\n      success: 0,\n      error: 0,\n      slow: 0\n    };\n    this.metrics.errors.clear();\n    this.metrics.endpoints.clear();\n    this.responseTimes = [];\n  }\n\n  /**\n   * æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶\n   */\n  middleware() {\n    return (req, res, next) => {\n      const startTime = performance.now();\n\n      // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´\n      req.startTime = startTime;\n\n      // ç›‘å¬å“åº”ç»“æŸäº‹ä»¶\n      res.on('finish', () => {\n        const endTime = performance.now();\n        const responseTime = Math.round(endTime - startTime);\n\n        if (this.options.enableMetrics) {\n          this.recordRequest(req, res, responseTime);\n        }\n\n        if (this.options.enableLogging) {\n          logger.info('è¯·æ±‚å®Œæˆ', {\n            method: req.method,\n            path: req.path,\n            statusCode: res.statusCode,\n            responseTime: `${responseTime}ms`,\n            ip: req.ip,\n            userAgent: req.get('User-Agent')\n          });\n        }\n      });\n\n      // ç›‘å¬é”™è¯¯äº‹ä»¶\n      res.on('error', (error) => {\n        if (this.options.enableMetrics) {\n          this.recordError(error, req);\n        }\n      });\n\n      next();\n    };\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 33 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 36 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 39 è¡Œ)\n\n    // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 42 è¡Œ)\n  }\n}\n\n/**\n * å¥åº·æ£€æŸ¥ä¸­é—´ä»¶\n */\nexport const healthCheck = (monitor) => (req, res) => {\n  const metrics = monitor.getMetrics();\n\n  // åˆ¤æ–­ç³»ç»Ÿå¥åº·çŠ¶æ€\n  const isHealthy =\n    metrics.memory.percentage < 0.9 && // å†…å­˜ä½¿ç”¨ç‡å°äº90%\n    metrics.cpu.loadAverage[0] / metrics.cpu.cpuCount < 0.9 && // CPUè´Ÿè½½å°äº90%\n    metrics.responseTime.avg < 2000; // å¹³å‡å“åº”æ—¶é—´å°äº2ç§’\n\n  const status = isHealthy ? 'healthy' : 'unhealthy';\n  const statusCode = isHealthy ? 200 : 503;\n\n  res.status(statusCode).json({\n    status,\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    memory: {\n      usage: `${(metrics.memory.percentage * 100).toFixed(2)}%`,\n      used: `${(metrics.memory.used / 1024 / 1024 / 1024).toFixed(2)}GB`,\n      total: `${(metrics.memory.total / 1024 / 1024 / 1024).toFixed(2)}GB`\n    },\n    cpu: {\n      loadAverage: metrics.cpu.loadAverage,\n      usage: `${((metrics.cpu.loadAverage[0] / metrics.cpu.cpuCount) * 100).toFixed(2)}%`\n    },\n    requests: metrics.requests,\n    responseTime: {\n      avg: `${metrics.responseTime.avg.toFixed(2)}ms`,\n\n      // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n      // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n      // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n      // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n      p95: `${metrics.responseTime.p95}ms`,\n      p99: `${metrics.responseTime.p99}ms`\n    }\n  });\n};\n\n/**\n * æ€§èƒ½æŒ‡æ ‡APIä¸­é—´ä»¶\n */\nexport const metricsEndpoint = (monitor) => (req, res) => {\n  const metrics = monitor.getMetrics();\n\n  // è½¬æ¢ç«¯ç‚¹ç»Ÿè®¡ä¸ºæ•°ç»„æ ¼å¼\n  const endpoints = Array.from(metrics.endpoints.entries()).map(([path, stats]) => ({\n    path,\n    ...stats\n  }));\n\n  // è½¬æ¢é”™è¯¯ç»Ÿè®¡ä¸ºæ•°ç»„æ ¼å¼\n  const errors = Array.from(metrics.errors.entries()).map(([error, count]) => ({\n    error,\n    count\n  }));\n\n  res.json({\n    ...metrics,\n    endpoints,\n    errors\n  });\n};\n\n// åˆ›å»ºé»˜è®¤æ€§èƒ½ç›‘æ§å®ä¾‹\nexport const defaultPerformanceMonitor = new PerformanceMonitor();\n\n// å¯¼å‡ºä¸­é—´ä»¶å‡½æ•°\nexport const performanceMiddleware = defaultPerformanceMonitor.middleware();\nexport const healthCheckEndpoint = healthCheck(defaultPerformanceMonitor);\nexport const metricsApiEndpoint = metricsEndpoint(defaultPerformanceMonitor);\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/middleware/security.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":100,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":100,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":129,"column":81,"nodeType":"Literal","messageId":"noMagic","endLine":129,"endColumn":83},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 15.","line":230,"column":15,"nodeType":"Literal","messageId":"noMagic","endLine":230,"endColumn":17},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":230,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":230,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":230,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":230,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":264,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":264,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":264,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":264,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":265,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":265,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8192.","line":266,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":266,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":330,"column":76,"nodeType":"Literal","messageId":"noMagic","endLine":330,"endColumn":78},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":330,"column":90,"nodeType":"Literal","messageId":"noMagic","endLine":330,"endColumn":91}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import jwt from 'jsonwebtoken';\nimport rateLimit from 'express-rate-limit';\nimport {\n  AuthenticationError,\n  AuthorizationError,\n  ValidationError\n} from '../utils/AppError.js';\nimport logger from '../utils/logger.js';\n\n/**\n * JWTè®¤è¯ä¸­é—´ä»¶å¢å¼ºç‰ˆ\n * æ”¯æŒå¤šç§tokenæ¥æºã€tokenåˆ·æ–°ã€é»‘åå•æ£€æŸ¥\n */\nexport class JWTAuthenticator {\n  constructor(options = {}) {\n    this.secret = options.secret || process.env.JWT_SECRET || 'default-secret';\n    this.refreshSecret =\n      options.refreshSecret || process.env.JWT_REFRESH_SECRET || 'default-refresh-secret';\n    this.tokenExpiry = options.tokenExpiry || '15m';\n    this.refreshTokenExpiry = options.refreshTokenExpiry || '7d';\n    this.blacklistedTokens = new Set(); // ç®€å•çš„å†…å­˜é»‘åå•ï¼Œç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨Redis\n    this.algorithm = options.algorithm || 'HS256';\n  }\n\n  /**\n   * ç”Ÿæˆè®¿é—®ä»¤ç‰Œ\n   */\n  generateAccessToken(payload) {\n    return jwt.sign(payload, this.secret, {\n      expiresIn: this.tokenExpiry,\n      algorithm: this.algorithm,\n      issuer: 'zero-carbon-system',\n      audience: 'zero-carbon-users'\n    });\n  }\n\n  /**\n   * ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œ\n   */\n  generateRefreshToken(payload) {\n    return jwt.sign(payload, this.refreshSecret, {\n      expiresIn: this.refreshTokenExpiry,\n      algorithm: this.algorithm,\n      issuer: 'zero-carbon-system',\n      audience: 'zero-carbon-users'\n    });\n  }\n\n  /**\n   * éªŒè¯è®¿é—®ä»¤ç‰Œ\n   */\n  verifyAccessToken(token) {\n    try {\n      if (this.blacklistedTokens.has(token)) {\n        throw new AuthenticationError('ä»¤ç‰Œå·²è¢«æ’¤é”€');\n      }\n\n      return jwt.verify(token, this.secret, {\n        algorithms: [this.algorithm],\n        issuer: 'zero-carbon-system',\n        audience: 'zero-carbon-users'\n      });\n    } catch (error) {\n      if (error instanceof jwt.TokenExpiredError) {\n        throw new AuthenticationError('ä»¤ç‰Œå·²è¿‡æœŸ');\n      } else if (error instanceof jwt.JsonWebTokenError) {\n        throw new AuthenticationError('æ— æ•ˆçš„ä»¤ç‰Œ');\n      }\n      throw error;\n    }\n  }\n\n  /**\n   * éªŒè¯åˆ·æ–°ä»¤ç‰Œ\n   */\n  verifyRefreshToken(token) {\n    try {\n      return jwt.verify(token, this.refreshSecret, {\n        algorithms: [this.algorithm],\n        issuer: 'zero-carbon-system',\n        audience: 'zero-carbon-users'\n      });\n    } catch (error) {\n      if (error instanceof jwt.TokenExpiredError) {\n        throw new AuthenticationError('åˆ·æ–°ä»¤ç‰Œå·²è¿‡æœŸ');\n      } else if (error instanceof jwt.JsonWebTokenError) {\n        throw new AuthenticationError('æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ');\n      }\n      throw error;\n    }\n  }\n\n  /**\n   * ä»è¯·æ±‚ä¸­æå–ä»¤ç‰Œ\n   */\n  extractToken(req) {\n    // 1. ä»Authorizationå¤´æå–\n    const authHeader = req.headers.authorization;\n    if (authHeader && authHeader.startsWith('Bearer ')) {\n      return authHeader.substring(7);\n    }\n\n    // 2. ä»Cookieæå–\n    if (req.cookies && req.cookies.accessToken) {\n      return req.cookies.accessToken;\n    }\n\n    // 3. ä»æŸ¥è¯¢å‚æ•°æå–ï¼ˆä¸æ¨èï¼Œä»…ç”¨äºç‰¹æ®Šæƒ…å†µï¼‰\n    if (req.query.token) {\n      return req.query.token;\n    }\n\n    return null;\n  }\n\n  /**\n   * æ’¤é”€ä»¤ç‰Œï¼ˆåŠ å…¥é»‘åå•ï¼‰\n   */\n  revokeToken(token) {\n    this.blacklistedTokens.add(token);\n    logger.info('ä»¤ç‰Œå·²æ’¤é”€', { tokenHash: this.hashToken(token) });\n  }\n\n  /**\n   * ä»¤ç‰Œå“ˆå¸Œï¼ˆç”¨äºæ—¥å¿—è®°å½•ï¼Œé¿å…æ³„éœ²å®Œæ•´ä»¤ç‰Œï¼‰\n   */\n  hashToken(token) {\n    const crypto = require('crypto');\n    return crypto.createHash('sha256').update(token).digest('hex').substring(0, 16);\n  }\n\n  /**\n   * è®¤è¯ä¸­é—´ä»¶\n   */\n  authenticate(_options = {}) {\n    return (req, res, next) => {\n      try {\n        const token = this.extractToken(req);\n\n        if (!token) {\n          throw new AuthenticationError('ç¼ºå°‘è®¤è¯ä»¤ç‰Œ');\n        }\n\n        const decoded = this.verifyAccessToken(token);\n        req.user = decoded;\n        req.token = token;\n\n        // è®°å½•è®¤è¯æˆåŠŸæ—¥å¿—\n        logger.info('ç”¨æˆ·è®¤è¯æˆåŠŸ', {\n          userId: decoded.id,\n          username: decoded.username,\n          role: decoded.role,\n          ip: req.ip,\n          userAgent: req.get('User-Agent')\n        });\n\n        next();\n      } catch (error) {\n        logger.warn('è®¤è¯å¤±è´¥', {\n          error: error.message,\n          ip: req.ip,\n          userAgent: req.get('User-Agent'),\n          path: req.path\n        });\n        next(error);\n      }\n    };\n  }\n\n  /**\n   * è§’è‰²æˆæƒä¸­é—´ä»¶\n   */\n  authorize(requiredRoles = []) {\n    return (req, res, next) => {\n      try {\n        if (!req.user) {\n          throw new AuthenticationError('ç”¨æˆ·æœªè®¤è¯');\n        }\n\n        const userRole = req.user.role;\n        const hasPermission = Array.isArray(requiredRoles)\n          ? requiredRoles.includes(userRole)\n          : requiredRoles === userRole;\n\n        if (!hasPermission) {\n          throw new AuthorizationError('æƒé™ä¸è¶³', {\n            requiredRoles,\n            userRole\n          });\n        }\n\n        next();\n      } catch (error) {\n        logger.warn('æˆæƒå¤±è´¥', {\n          error: error.message,\n          userId: req.user?.id,\n          userRole: req.user?.role,\n          requiredRoles,\n          path: req.path\n        });\n        next(error);\n      }\n    };\n  }\n}\n\n/**\n * å®‰å…¨å¤´ä¸­é—´ä»¶\n */\nexport const securityHeaders = () => (req, res, next) => {\n  // è®¾ç½®å®‰å…¨å“åº”å¤´\n  res.setHeader('X-Content-Type-Options', 'nosniff');\n  res.setHeader('X-Frame-Options', 'DENY');\n  res.setHeader('X-XSS-Protection', '1; mode=block');\n  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');\n  res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');\n\n  // ç§»é™¤å¯èƒ½æ³„éœ²æœåŠ¡å™¨ä¿¡æ¯çš„å¤´\n  res.removeHeader('X-Powered-By');\n  res.removeHeader('Server');\n\n  next();\n};\n\n/**\n * APIé€Ÿç‡é™åˆ¶ä¸­é—´ä»¶\n */\nexport const createRateLimiter = (options = {}) => {\n  const defaultOptions = {\n    windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ\n    max: 100, // æ¯ä¸ªIPæœ€å¤š100ä¸ªè¯·æ±‚\n    message: {\n      error: {\n        code: 'RATE_LIMIT_EXCEEDED',\n        message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'\n      }\n    },\n    standardHeaders: true,\n    legacyHeaders: false,\n    skip: (req) =>\n      // è·³è¿‡å¥åº·æ£€æŸ¥å’Œé™æ€èµ„æº\n      req.path === '/health' || req.path.startsWith('/static/'),\n    keyGenerator: (req) =>\n      // å¯¹è®¤è¯ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·IDï¼Œå¯¹åŒ¿åç”¨æˆ·ä½¿ç”¨IP\n      req.user?.id || req.ip,\n    onLimitReached: (req, _res, _options) => {\n      logger.warn('é€Ÿç‡é™åˆ¶è§¦å‘', {\n        ip: req.ip,\n        userId: req.user?.id,\n        path: req.path,\n        method: req.method,\n        userAgent: req.get('User-Agent')\n      });\n    }\n  };\n\n  return rateLimit({ ...defaultOptions, ...options });\n};\n\n/**\n * è¾“å…¥å¤§å°é™åˆ¶ä¸­é—´ä»¶\n */\nexport const inputSizeLimit = (options = {}) => {\n  const maxBodySize = options.maxBodySize || 1024 * 1024; // 1MB\n  const maxQueryLength = options.maxQueryLength || 1000;\n  const maxHeaderSize = options.maxHeaderSize || 8192;\n\n  return (req, res, next) => {\n    try {\n      // æ£€æŸ¥è¯·æ±‚ä½“å¤§å°\n      const contentLength = parseInt(req.get('Content-Length') || '0');\n      if (contentLength > maxBodySize) {\n        throw new ValidationError('è¯·æ±‚ä½“è¿‡å¤§', {\n          maxSize: maxBodySize,\n          actualSize: contentLength\n        });\n      }\n\n      // æ£€æŸ¥æŸ¥è¯¢å­—ç¬¦ä¸²é•¿åº¦\n      const queryString = req.url.split('?')[1] || '';\n      if (queryString.length > maxQueryLength) {\n        throw new ValidationError('æŸ¥è¯¢å‚æ•°è¿‡é•¿', {\n          maxLength: maxQueryLength,\n          actualLength: queryString.length\n        });\n      }\n\n      // æ£€æŸ¥å¤´éƒ¨å¤§å°\n      const headerSize = JSON.stringify(req.headers).length;\n      if (headerSize > maxHeaderSize) {\n        throw new ValidationError('è¯·æ±‚å¤´è¿‡å¤§', {\n          maxSize: maxHeaderSize,\n          actualSize: headerSize\n        });\n      }\n\n      next();\n    } catch (error) {\n      next(error);\n    }\n  };\n};\n\n/**\n * IPç™½åå•ä¸­é—´ä»¶\n */\nexport const ipWhitelist =\n  (allowedIPs = []) =>\n    (req, res, next) => {\n      const clientIP = req.ip || req.connection.remoteAddress;\n\n      if (allowedIPs.length > 0 && !allowedIPs.includes(clientIP)) {\n        logger.warn('IPè®¿é—®è¢«æ‹’ç»', {\n          ip: clientIP,\n          path: req.path,\n          userAgent: req.get('User-Agent')\n        });\n\n        throw new AuthorizationError('è®¿é—®è¢«æ‹’ç»');\n      }\n\n      next();\n    };\n\n/**\n * è¯·æ±‚IDä¸­é—´ä»¶ï¼ˆç”¨äºè¯·æ±‚è¿½è¸ªï¼‰\n */\nexport const requestId = () => (req, res, next) => {\n  const requestId =\n    req.get('X-Request-ID') || `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n  req.requestId = requestId;\n  res.setHeader('X-Request-ID', requestId);\n\n  next();\n};\n\n// å¯¼å‡ºé»˜è®¤çš„JWTè®¤è¯å™¨å®ä¾‹\nexport const defaultJWTAuth = new JWTAuthenticator({\n  secret: process.env.JWT_SECRET,\n  refreshSecret: process.env.JWT_REFRESH_SECRET,\n  tokenExpiry: process.env.JWT_EXPIRY || '15m',\n  refreshTokenExpiry: process.env.JWT_REFRESH_EXPIRY || '7d'\n});\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/middleware/validation.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/AppError.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":6,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":6,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":40,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":40,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 401.","line":46,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":46,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 403.","line":52,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":52,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":58,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":58,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 409.","line":64,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":64,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":70,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":70,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 502.","line":76,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":76,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * åº”ç”¨ç¨‹åºé”™è¯¯ç±»\n * æä¾›ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶\n */\nclass AppError extends Error {\n  constructor(message, statusCode = 500, errorCode = 'INTERNAL_SERVER_ERROR', details = {}) {\n    super(message);\n    this.name = 'AppError';\n    this.statusCode = statusCode;\n    this.errorCode = errorCode;\n    this.details = details;\n    this.isOperational = true;\n    this.timestamp = new Date().toISOString();\n\n    // æ•è·å †æ ˆè·Ÿè¸ª\n    Error.captureStackTrace(this, this.constructor);\n  }\n\n  /**\n   * è½¬æ¢ä¸ºJSONæ ¼å¼\n   */\n  toJSON() {\n    return {\n      name: this.name,\n      message: this.message,\n      statusCode: this.statusCode,\n      errorCode: this.errorCode,\n      details: this.details,\n      timestamp: this.timestamp,\n      stack: process.env.NODE_ENV === 'development' ? this.stack : undefined\n    };\n  }\n}\n\n/**\n * é¢„å®šä¹‰çš„é”™è¯¯ç±»å‹\n */\nclass ValidationError extends AppError {\n  constructor(message, details = {}) {\n    super(message, 400, 'VALIDATION_ERROR', details);\n  }\n}\n\nclass AuthenticationError extends AppError {\n  constructor(message = 'è®¤è¯å¤±è´¥') {\n    super(message, 401, 'AUTHENTICATION_ERROR');\n  }\n}\n\nclass AuthorizationError extends AppError {\n  constructor(message = 'æƒé™ä¸è¶³') {\n    super(message, 403, 'AUTHORIZATION_ERROR');\n  }\n}\n\nclass NotFoundError extends AppError {\n  constructor(message = 'èµ„æºæœªæ‰¾åˆ°') {\n    super(message, 404, 'NOT_FOUND');\n  }\n}\n\nclass ConflictError extends AppError {\n  constructor(message = 'èµ„æºå†²çª') {\n    super(message, 409, 'CONFLICT');\n  }\n}\n\nclass DatabaseError extends AppError {\n  constructor(message = 'æ•°æ®åº“æ“ä½œå¤±è´¥', details = {}) {\n    super(message, 500, 'DATABASE_ERROR', details);\n  }\n}\n\nclass ExternalServiceError extends AppError {\n  constructor(message = 'å¤–éƒ¨æœåŠ¡é”™è¯¯', details = {}) {\n    super(message, 502, 'EXTERNAL_SERVICE_ERROR', details);\n  }\n}\n\nexport {\n  AppError,\n  ValidationError,\n  AuthenticationError,\n  AuthorizationError,\n  NotFoundError,\n  ConflictError,\n  DatabaseError,\n  ExternalServiceError\n};\n\nexport default AppError;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/LogAggregator.js","messages":[{"ruleId":"no-duplicate-imports","severity":2,"message":"'fs' import is duplicated.","line":3,"column":1,"nodeType":"ImportDeclaration","messageId":"import","endLine":3,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":24,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":24,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":24,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":24,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":24,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":24,"endColumn":60},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":25,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":25,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":26,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":26,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":26,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":26,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":26,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":26,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":26,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":26,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":45,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":45,"endColumn":49},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":68,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":68,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1401,1428],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":182,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":182,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3730,3758],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":196,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":196,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3976,4000],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":234,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":234,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4913,4970],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.05.","line":247,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":247,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":250,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":250,"endColumn":18},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":250,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":250,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":250,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":250,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5000.","line":255,"column":91,"nodeType":"Literal","messageId":"noMagic","endLine":255,"endColumn":95},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":257,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":257,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":257,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":257,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":265,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":265,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":265,"column":71,"nodeType":"Literal","messageId":"noMagic","endLine":265,"endColumn":73},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":265,"column":76,"nodeType":"Literal","messageId":"noMagic","endLine":265,"endColumn":80},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":266,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":266,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":269,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":269,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":269,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":269,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":269,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":269,"endColumn":31},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":302,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":302,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[6555,6598],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":333,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":333,"endColumn":17,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"warn"},"fix":{"range":[7128,7170],"text":""},"desc":"Remove the console.warn()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":353,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":353,"endColumn":10},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":353,"column":13,"nodeType":"Literal","messageId":"noMagic","endLine":353,"endColumn":17},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":381,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":381,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":381,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":381,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":381,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":381,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":413,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":413,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":452,"column":17,"nodeType":"Literal","messageId":"noMagic","endLine":452,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":487,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":487,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.2.","line":525,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":525,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.8.","line":527,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":527,"endColumn":52},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":548,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":548,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12534,12568],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":559,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":559,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"error"},"fix":{"range":[12775,12809],"text":""},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 100.","line":567,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":567,"endColumn":70},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":664,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":664,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15108,15137],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":683,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":683,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15504,15530],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":44,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'fs';\nimport path from 'path';\nimport { createWriteStream } from 'fs';\nimport EventEmitter from 'events';\n\n/**\n * æ—¥å¿—èšåˆå™¨\n * æä¾›æ—¥å¿—æ”¶é›†ã€åˆ†æã€å­˜å‚¨å’ŒæŸ¥è¯¢åŠŸèƒ½\n */\nclass LogAggregator extends EventEmitter {\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 30 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 30 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 30 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 30 è¡Œ)\n\n  constructor(options = {}) {\n    super();\n\n    this.options = {\n      logDir: options.logDir || './logs',\n      maxFileSize: options.maxFileSize || 100 * 1024 * 1024, // 100MB\n      maxFiles: options.maxFiles || 10,\n      rotateInterval: options.rotateInterval || 24 * 60 * 60 * 1000, // 24å°æ—¶\n      enableAnalysis: options.enableAnalysis !== false,\n      enableAlerts: options.enableAlerts !== false,\n      ...options\n    };\n\n    this.logStreams = new Map();\n    this.logStats = {\n      totalLogs: 0,\n      errorCount: 0,\n      warningCount: 0,\n      infoCount: 0,\n      debugCount: 0,\n      lastLogTime: null,\n      startTime: new Date()\n    };\n\n    this.alertRules = new Map();\n    this.logBuffer = [];\n    this.bufferSize = options.bufferSize || 1000;\n\n    this.init();\n  }\n\n  /**\n   * åˆå§‹åŒ–æ—¥å¿—èšåˆå™¨\n   */\n  init() {\n    // ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨\n    this.ensureLogDir();\n\n    // è®¾ç½®æ—¥å¿—è½®è½¬\n    this.setupLogRotation();\n\n    // è®¾ç½®é»˜è®¤å‘Šè­¦è§„åˆ™\n    this.setupDefaultAlertRules();\n\n    // å¯åŠ¨åˆ†æä»»åŠ¡\n    if (this.options.enableAnalysis) {\n      this.startAnalysisTask();\n    }\n\n    console.log('ğŸ“Š æ—¥å¿—èšåˆå™¨å·²å¯åŠ¨');\n  }\n\n  /**\n   * ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨\n   */\n  ensureLogDir() {\n    if (!fs.existsSync(this.options.logDir)) {\n      fs.mkdirSync(this.options.logDir, { recursive: true });\n    }\n  }\n\n  /**\n   * è®°å½•æ—¥å¿—\n   */\n  log(level, message, metadata = {}) {\n    const logEntry = {\n      timestamp: new Date().toISOString(),\n      level: level.toUpperCase(),\n      message,\n      metadata,\n      requestId: metadata.requestId,\n      userId: metadata.userId,\n      ip: metadata.ip,\n      userAgent: metadata.userAgent,\n      duration: metadata.duration,\n      statusCode: metadata.statusCode,\n      error: metadata.error\n    };\n\n    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯\n    this.updateStats(logEntry);\n\n    // æ·»åŠ åˆ°ç¼“å†²åŒº\n    this.logBuffer.push(logEntry);\n\n    // å†™å…¥æ—¥å¿—æ–‡ä»¶\n    this.writeToFile(logEntry);\n\n    // æ£€æŸ¥å‘Šè­¦è§„åˆ™\n    if (this.options.enableAlerts) {\n      this.checkAlertRules(logEntry);\n    }\n\n    // è§¦å‘äº‹ä»¶\n    this.emit('log', logEntry);\n\n    // å¦‚æœç¼“å†²åŒºæ»¡äº†ï¼Œæ¸…ç†æ—§æ—¥å¿—\n    if (this.logBuffer.length > this.bufferSize) {\n      this.logBuffer = this.logBuffer.slice(-this.bufferSize);\n    }\n  }\n\n  /**\n   * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯\n   */\n  updateStats(logEntry) {\n    this.logStats.totalLogs++;\n    this.logStats.lastLogTime = logEntry.timestamp;\n\n    switch (logEntry.level) {\n      case 'ERROR':\n        this.logStats.errorCount++;\n        break;\n      case 'WARN':\n        this.logStats.warningCount++;\n        break;\n      case 'INFO':\n        this.logStats.infoCount++;\n        break;\n      case 'DEBUG':\n        this.logStats.debugCount++;\n        break;\n    }\n  }\n\n  /**\n   * å†™å…¥æ—¥å¿—æ–‡ä»¶\n   */\n  writeToFile(logEntry) {\n    const fileName = this.getLogFileName(logEntry.level);\n    const filePath = path.join(this.options.logDir, fileName);\n\n    if (!this.logStreams.has(fileName)) {\n      this.logStreams.set(fileName, createWriteStream(filePath, { flags: 'a' }));\n    }\n\n    const stream = this.logStreams.get(fileName);\n    const logLine = `${JSON.stringify(logEntry)}\\n`;\n\n    stream.write(logLine);\n  }\n\n  /**\n   * è·å–æ—¥å¿—æ–‡ä»¶å\n   */\n  getLogFileName(level) {\n    const [date] = new Date().toISOString().split('T');\n    return `${level.toLowerCase()}-${date}.log`;\n  }\n\n  /**\n   * è®¾ç½®æ—¥å¿—è½®è½¬\n   */\n  setupLogRotation() {\n    this.rotationTimer = setInterval(() => {\n      this.rotateLogFiles();\n    }, this.options.rotateInterval);\n  }\n\n  /**\n   * è½®è½¬æ—¥å¿—æ–‡ä»¶\n   */\n  rotateLogFiles() {\n    console.log('ğŸ”„ å¼€å§‹æ—¥å¿—è½®è½¬...');\n\n    // å…³é—­å½“å‰æµ\n    for (const [_fileName, stream] of this.logStreams) {\n      stream.end();\n    }\n    this.logStreams.clear();\n\n    // å‹ç¼©æ—§æ—¥å¿—æ–‡ä»¶\n    this.compressOldLogs();\n\n    // æ¸…ç†è¿‡æœŸæ—¥å¿—\n    this.cleanupOldLogs();\n\n    console.log('âœ… æ—¥å¿—è½®è½¬å®Œæˆ');\n  }\n\n  /**\n   * å‹ç¼©æ—§æ—¥å¿—æ–‡ä»¶\n   */\n  compressOldLogs() {\n    // è¿™é‡Œå¯ä»¥æ·»åŠ æ—¥å¿—å‹ç¼©é€»è¾‘\n    // ä¾‹å¦‚ä½¿ç”¨ gzip å‹ç¼©\n  }\n\n  /**\n   * æ¸…ç†è¿‡æœŸæ—¥å¿—\n   */\n  cleanupOldLogs() {\n    const files = fs.readdirSync(this.options.logDir);\n    const logFiles = files.filter((file) => file.endsWith('.log'));\n\n    if (logFiles.length > this.options.maxFiles) {\n      // æŒ‰ä¿®æ”¹æ—¶é—´æ’åº\n      const sortedFiles = logFiles\n        .map((file) => ({\n          name: file,\n          path: path.join(this.options.logDir, file),\n          mtime: fs.statSync(path.join(this.options.logDir, file)).mtime\n        }))\n        .sort((a, b) => a.mtime - b.mtime);\n\n      // åˆ é™¤æœ€æ—§çš„æ–‡ä»¶\n      const filesToDelete = sortedFiles.slice(0, sortedFiles.length - this.options.maxFiles);\n\n      const deletedFiles = [];\n      for (const file of filesToDelete) {\n        fs.unlinkSync(file.path);\n        deletedFiles.push(file.name);\n      }\n\n      if (deletedFiles.length > 0) {\n        console.log(`ğŸ—‘ï¸  åˆ é™¤è¿‡æœŸæ—¥å¿—æ–‡ä»¶: ${deletedFiles.join(', ')}`);\n      }\n    }\n  }\n\n  /**\n   * è®¾ç½®é»˜è®¤å‘Šè­¦è§„åˆ™\n   */\n  setupDefaultAlertRules() {\n    // é”™è¯¯ç‡å‘Šè­¦\n    this.addAlertRule('high_error_rate', {\n      condition: (stats) => {\n        const errorRate = stats.errorCount / stats.totalLogs;\n        return errorRate > 0.05; // é”™è¯¯ç‡è¶…è¿‡5%\n      },\n      message: 'é”™è¯¯ç‡è¿‡é«˜',\n      cooldown: 5 * 60 * 1000 // 5åˆ†é’Ÿå†·å´æœŸ\n    });\n\n    // å“åº”æ—¶é—´å‘Šè­¦\n    this.addAlertRule('slow_response', {\n      condition: (logEntry) => logEntry.metadata.duration && logEntry.metadata.duration > 5000, // å“åº”æ—¶é—´è¶…è¿‡5ç§’\n      message: 'å“åº”æ—¶é—´è¿‡é•¿',\n      cooldown: 60 * 1000 // 1åˆ†é’Ÿå†·å´æœŸ\n    });\n\n    // é¢‘ç¹é”™è¯¯å‘Šè­¦\n    this.addAlertRule('frequent_errors', {\n      condition: () => {\n        const recentErrors = this.logBuffer\n          .filter((log) => log.level === 'ERROR')\n          .filter((log) => new Date() - new Date(log.timestamp) < 5 * 60 * 1000); // 5åˆ†é’Ÿå†…\n        return recentErrors.length > 10; // 5åˆ†é’Ÿå†…è¶…è¿‡10ä¸ªé”™è¯¯\n      },\n      message: 'é¢‘ç¹å‡ºç°é”™è¯¯',\n      cooldown: 10 * 60 * 1000 // 10åˆ†é’Ÿå†·å´æœŸ\n    });\n  }\n\n  /**\n   * æ·»åŠ å‘Šè­¦è§„åˆ™\n   */\n  addAlertRule(name, rule) {\n    this.alertRules.set(name, {\n      ...rule,\n      lastTriggered: 0\n    });\n  }\n\n  /**\n   * æ£€æŸ¥å‘Šè­¦è§„åˆ™\n   */\n  checkAlertRules(logEntry) {\n    const now = Date.now();\n\n    for (const [name, rule] of this.alertRules) {\n      // æ£€æŸ¥å†·å´æœŸ\n      if (now - rule.lastTriggered < rule.cooldown) {\n        continue;\n      }\n\n      // æ£€æŸ¥æ¡ä»¶\n      let shouldAlert = false;\n\n      if (typeof rule.condition === 'function') {\n        try {\n          shouldAlert = rule.condition(logEntry, this.logStats, this.logBuffer);\n        } catch (error) {\n          console.error(`å‘Šè­¦è§„åˆ™ ${name} æ‰§è¡Œå¤±è´¥:`, error);\n        }\n      }\n\n      if (shouldAlert) {\n        this.triggerAlert(name, rule, logEntry);\n        rule.lastTriggered = now;\n      }\n    }\n  }\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n  // TODO: è€ƒè™‘å°†æ­¤å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•° (å½“å‰ 21 è¡Œ)\n\n  /**\n   * è§¦å‘å‘Šè­¦\n   */\n  triggerAlert(ruleName, rule, logEntry) {\n    const alert = {\n      ruleName,\n      message: rule.message,\n      timestamp: new Date().toISOString(),\n      logEntry,\n      stats: { ...this.logStats }\n    };\n\n    console.warn(`ğŸš¨ å‘Šè­¦è§¦å‘: ${alert.message}`);\n\n    // è§¦å‘å‘Šè­¦äº‹ä»¶\n    this.emit('alert', alert);\n\n    // è®°å½•å‘Šè­¦æ—¥å¿—\n    this.log('warn', `å‘Šè­¦è§¦å‘: ${alert.message}`, {\n      alert: true,\n      ruleName,\n      originalLog: logEntry\n    });\n  }\n\n  /**\n   * å¯åŠ¨åˆ†æä»»åŠ¡\n   */\n  startAnalysisTask() {\n    // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡åˆ†æ\n    this.analysisTimer = setInterval(() => {\n      this.performAnalysis();\n    }, 60 * 1000);\n  }\n\n  /**\n   * æ‰§è¡Œæ—¥å¿—åˆ†æ\n   */\n  performAnalysis() {\n    const analysis = {\n      timestamp: new Date().toISOString(),\n      stats: { ...this.logStats },\n      trends: this.analyzeTrends(),\n      topErrors: this.getTopErrors(),\n      slowEndpoints: this.getSlowEndpoints(),\n      userActivity: this.analyzeUserActivity()\n    };\n\n    // è§¦å‘åˆ†æäº‹ä»¶\n    this.emit('analysis', analysis);\n\n    // ä¿å­˜åˆ†æç»“æœ\n    this.saveAnalysis(analysis);\n  }\n\n  /**\n   * åˆ†æè¶‹åŠ¿\n   */\n  analyzeTrends() {\n    const now = new Date();\n    const oneHourAgo = new Date(now - 60 * 60 * 1000);\n\n    const recentLogs = this.logBuffer.filter((log) => new Date(log.timestamp) > oneHourAgo);\n\n    const hourlyStats = {\n      total: recentLogs.length,\n      errors: recentLogs.filter((log) => log.level === 'ERROR').length,\n      warnings: recentLogs.filter((log) => log.level === 'WARN').length,\n      avgResponseTime: this.calculateAverageResponseTime(recentLogs)\n    };\n\n    return {\n      hourly: hourlyStats,\n      errorRate: hourlyStats.errors / hourlyStats.total || 0,\n      trend: this.calculateTrend(recentLogs)\n    };\n  }\n\n  /**\n   * è·å–æœ€å¸¸è§é”™è¯¯\n   */\n  getTopErrors() {\n    const errorLogs = this.logBuffer.filter((log) => log.level === 'ERROR');\n    const errorCounts = new Map();\n\n    for (const log of errorLogs) {\n      const errorKey = log.message || log.metadata.error?.message || 'Unknown Error';\n      errorCounts.set(errorKey, (errorCounts.get(errorKey) || 0) + 1);\n    }\n\n    return Array.from(errorCounts.entries())\n      .sort((a, b) => b[1] - a[1])\n      .slice(0, 10)\n      .map(([error, count]) => ({ error, count }));\n  }\n\n  /**\n   * è·å–æ…¢ç«¯ç‚¹\n   */\n  getSlowEndpoints() {\n    const logsWithDuration = this.logBuffer.filter(\n      (log) => log.metadata.duration && log.metadata.url\n    );\n\n    const endpointStats = new Map();\n\n    for (const log of logsWithDuration) {\n      const endpoint = `${log.metadata.method} ${log.metadata.url}`;\n\n      if (!endpointStats.has(endpoint)) {\n        endpointStats.set(endpoint, {\n          count: 0,\n          totalDuration: 0,\n          maxDuration: 0\n        });\n      }\n\n      const stats = endpointStats.get(endpoint);\n      stats.count++;\n      stats.totalDuration += log.metadata.duration;\n      stats.maxDuration = Math.max(stats.maxDuration, log.metadata.duration);\n    }\n\n    return Array.from(endpointStats.entries())\n      .map(([endpoint, stats]) => ({\n        endpoint,\n        avgDuration: stats.totalDuration / stats.count,\n        maxDuration: stats.maxDuration,\n        count: stats.count\n      }))\n      .sort((a, b) => b.avgDuration - a.avgDuration)\n      .slice(0, 10);\n  }\n\n  /**\n   * åˆ†æç”¨æˆ·æ´»åŠ¨\n   */\n  analyzeUserActivity() {\n    const userLogs = this.logBuffer.filter((log) => log.userId);\n    const userStats = new Map();\n\n    for (const log of userLogs) {\n      if (!userStats.has(log.userId)) {\n        userStats.set(log.userId, {\n          requests: 0,\n          errors: 0,\n          lastActivity: log.timestamp\n        });\n      }\n\n      const stats = userStats.get(log.userId);\n      stats.requests++;\n\n      if (log.level === 'ERROR') {\n        stats.errors++;\n      }\n\n      if (new Date(log.timestamp) > new Date(stats.lastActivity)) {\n        stats.lastActivity = log.timestamp;\n      }\n    }\n\n    return {\n      activeUsers: userStats.size,\n      topUsers: Array.from(userStats.entries())\n        .sort((a, b) => b[1].requests - a[1].requests)\n        .slice(0, 10)\n        .map(([userId, stats]) => ({ userId, ...stats }))\n    };\n  }\n\n  /**\n   * è®¡ç®—å¹³å‡å“åº”æ—¶é—´\n   */\n  calculateAverageResponseTime(logs) {\n    const logsWithDuration = logs.filter((log) => log.metadata.duration);\n\n    if (logsWithDuration.length === 0) {\n      return 0;\n    }\n\n    const totalDuration = logsWithDuration.reduce((sum, log) => sum + log.metadata.duration, 0);\n\n    return totalDuration / logsWithDuration.length;\n  }\n\n  /**\n   * è®¡ç®—è¶‹åŠ¿\n   */\n  calculateTrend(logs) {\n    if (logs.length < 2) {\n      return 'stable';\n    }\n\n    const midpoint = Math.floor(logs.length / 2);\n    const firstHalf = logs.slice(0, midpoint);\n    const secondHalf = logs.slice(midpoint);\n\n    const firstHalfErrors = firstHalf.filter((log) => log.level === 'ERROR').length;\n    const secondHalfErrors = secondHalf.filter((log) => log.level === 'ERROR').length;\n\n    const firstHalfRate = firstHalfErrors / firstHalf.length;\n    const secondHalfRate = secondHalfErrors / secondHalf.length;\n\n    if (secondHalfRate > firstHalfRate * 1.2) {\n      return 'increasing';\n    } else if (secondHalfRate < firstHalfRate * 0.8) {\n      return 'decreasing';\n    }\n    return 'stable';\n  }\n\n  /**\n   * ä¿å­˜åˆ†æç»“æœ\n   */\n  async saveAnalysis(analysis) {\n    const fileName = `analysis-${new Date().toISOString().split('T')[0]}.json`;\n    const filePath = path.join(this.options.logDir, fileName);\n\n    let existingData = [];\n\n    try {\n      await fs.promises.access(filePath);\n      try {\n        const content = await fs.promises.readFile(filePath, 'utf8');\n        existingData = JSON.parse(content);\n      } catch (error) {\n        console.error('è¯»å–åˆ†ææ–‡ä»¶å¤±è´¥:', error);\n      }\n    } catch {\n      // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºæ•°ç»„\n    }\n\n    existingData.push(analysis);\n\n    try {\n      await fs.promises.writeFile(filePath, JSON.stringify(existingData, null, 2));\n    } catch (error) {\n      console.error('ä¿å­˜åˆ†æç»“æœå¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * æŸ¥è¯¢æ—¥å¿—\n   */\n  async queryLogs(options = {}) {\n    const { level, startTime, endTime, userId, requestId, limit = 100, offset = 0 } = options;\n\n    let results = [...this.logBuffer];\n\n    // åº”ç”¨è¿‡æ»¤æ¡ä»¶\n    if (level) {\n      results = results.filter((log) => log.level === level.toUpperCase());\n    }\n\n    if (startTime) {\n      results = results.filter((log) => new Date(log.timestamp) >= new Date(startTime));\n    }\n\n    if (endTime) {\n      results = results.filter((log) => new Date(log.timestamp) <= new Date(endTime));\n    }\n\n    if (userId) {\n      results = results.filter((log) => log.userId === userId);\n    }\n\n    if (requestId) {\n      results = results.filter((log) => log.requestId === requestId);\n    }\n\n    // æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰\n    results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\n\n    // åˆ†é¡µ\n    const total = results.length;\n    results = results.slice(offset, offset + limit);\n\n    return {\n      logs: results,\n      total,\n      offset,\n      limit,\n      hasMore: offset + limit < total\n    };\n  }\n\n  /**\n   * è·å–ç»Ÿè®¡ä¿¡æ¯\n   */\n  getStats() {\n    return {\n      ...this.logStats,\n      uptime: Date.now() - this.logStats.startTime.getTime(),\n      bufferSize: this.logBuffer.length,\n      activeStreams: this.logStreams.size\n    };\n  }\n\n  /**\n   * åˆ›å»ºæ—¥å¿—ä¸­é—´ä»¶\n   */\n  createMiddleware() {\n    return (req, res, next) => {\n      const startTime = Date.now();\n\n      // è®°å½•è¯·æ±‚å¼€å§‹\n      this.log('info', `${req.method} ${req.url}`, {\n        requestId: req.requestId,\n        userId: req.user?.id,\n        ip: req.ip,\n        userAgent: req.get('User-Agent'),\n        method: req.method,\n        url: req.url,\n        query: req.query,\n        body: req.method !== 'GET' ? req.body : undefined\n      });\n\n      // ç›‘å¬å“åº”ç»“æŸ\n      res.on('finish', () => {\n        const duration = Date.now() - startTime;\n\n        this.log('info', `${req.method} ${req.url} - ${res.statusCode}`, {\n          requestId: req.requestId,\n          userId: req.user?.id,\n          ip: req.ip,\n          userAgent: req.get('User-Agent'),\n          method: req.method,\n          url: req.url,\n          statusCode: res.statusCode,\n          duration,\n          responseSize: res.get('Content-Length')\n        });\n      });\n\n      next();\n    };\n  }\n\n  /**\n   * å…³é—­æ—¥å¿—èšåˆå™¨\n   */\n  close() {\n    console.log('ğŸ”„ å…³é—­æ—¥å¿—èšåˆå™¨...');\n\n    // æ¸…ç†å®šæ—¶å™¨\n    if (this.rotationTimer) {\n      clearInterval(this.rotationTimer);\n      this.rotationTimer = null;\n    }\n    if (this.analysisTimer) {\n      clearInterval(this.analysisTimer);\n      this.analysisTimer = null;\n    }\n\n    // å…³é—­æ‰€æœ‰æµ\n    for (const [_fileName, stream] of this.logStreams) {\n      stream.end();\n    }\n\n    this.logStreams.clear();\n\n    console.log('âœ… æ—¥å¿—èšåˆå™¨å·²å…³é—­');\n  }\n}\n\n// åˆ›å»ºé»˜è®¤å®ä¾‹\nconst defaultLogAggregator = new LogAggregator();\n\n// ä¾¿æ·æ–¹æ³•\nexport const logInfo = (message, metadata) => defaultLogAggregator.log('info', message, metadata);\nexport const logWarn = (message, metadata) => defaultLogAggregator.log('warn', message, metadata);\nexport const logError = (message, metadata) => defaultLogAggregator.log('error', message, metadata);\nexport const logDebug = (message, metadata) => defaultLogAggregator.log('debug', message, metadata);\n\nexport { LogAggregator };\nexport default defaultLogAggregator;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/apiResponse.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":357,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":357,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":357,"column":68,"nodeType":"Literal","messageId":"noMagic","endLine":357,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":373,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":373,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":375,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":375,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * APIå“åº”æ ‡å‡†åŒ–å·¥å…·\n * ç¡®ä¿æ‰€æœ‰APIå“åº”æ ¼å¼çš„ä¸€è‡´æ€§\n */\n\nimport { logger } from './logger.js';\n\n// å“åº”çŠ¶æ€ç å¸¸é‡\nexport const HTTP_STATUS = {\n  // æˆåŠŸå“åº”\n  OK: 200,\n  CREATED: 201,\n  ACCEPTED: 202,\n  NO_CONTENT: 204,\n\n  // é‡å®šå‘\n  MOVED_PERMANENTLY: 301,\n  FOUND: 302,\n  NOT_MODIFIED: 304,\n\n  // å®¢æˆ·ç«¯é”™è¯¯\n  BAD_REQUEST: 400,\n  UNAUTHORIZED: 401,\n  FORBIDDEN: 403,\n  NOT_FOUND: 404,\n  METHOD_NOT_ALLOWED: 405,\n  CONFLICT: 409,\n  UNPROCESSABLE_ENTITY: 422,\n  TOO_MANY_REQUESTS: 429,\n\n  // æœåŠ¡å™¨é”™è¯¯\n  INTERNAL_SERVER_ERROR: 500,\n  NOT_IMPLEMENTED: 501,\n  BAD_GATEWAY: 502,\n  SERVICE_UNAVAILABLE: 503,\n  GATEWAY_TIMEOUT: 504\n};\n\n// ä¸šåŠ¡é”™è¯¯ç å¸¸é‡\nexport const BUSINESS_CODES = {\n  SUCCESS: 'SUCCESS',\n\n  // è®¤è¯ç›¸å…³\n  AUTH_INVALID_CREDENTIALS: 'AUTH_INVALID_CREDENTIALS',\n  AUTH_TOKEN_EXPIRED: 'AUTH_TOKEN_EXPIRED',\n  AUTH_TOKEN_INVALID: 'AUTH_TOKEN_INVALID',\n  AUTH_INSUFFICIENT_PERMISSIONS: 'AUTH_INSUFFICIENT_PERMISSIONS',\n\n  // éªŒè¯ç›¸å…³\n  VALIDATION_FAILED: 'VALIDATION_FAILED',\n  VALIDATION_REQUIRED_FIELD: 'VALIDATION_REQUIRED_FIELD',\n  VALIDATION_INVALID_FORMAT: 'VALIDATION_INVALID_FORMAT',\n  VALIDATION_OUT_OF_RANGE: 'VALIDATION_OUT_OF_RANGE',\n\n  // èµ„æºç›¸å…³\n  RESOURCE_NOT_FOUND: 'RESOURCE_NOT_FOUND',\n  RESOURCE_ALREADY_EXISTS: 'RESOURCE_ALREADY_EXISTS',\n  RESOURCE_CONFLICT: 'RESOURCE_CONFLICT',\n  RESOURCE_LOCKED: 'RESOURCE_LOCKED',\n\n  // ä¸šåŠ¡é€»è¾‘ç›¸å…³\n  BUSINESS_RULE_VIOLATION: 'BUSINESS_RULE_VIOLATION',\n  OPERATION_NOT_ALLOWED: 'OPERATION_NOT_ALLOWED',\n  QUOTA_EXCEEDED: 'QUOTA_EXCEEDED',\n\n  // ç³»ç»Ÿç›¸å…³\n  SYSTEM_ERROR: 'SYSTEM_ERROR',\n  DATABASE_ERROR: 'DATABASE_ERROR',\n  EXTERNAL_SERVICE_ERROR: 'EXTERNAL_SERVICE_ERROR',\n  RATE_LIMIT_EXCEEDED: 'RATE_LIMIT_EXCEEDED'\n};\n\n// é”™è¯¯æ¶ˆæ¯æ˜ å°„\nconst ERROR_MESSAGES = {\n  [BUSINESS_CODES.AUTH_INVALID_CREDENTIALS]: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯',\n  [BUSINESS_CODES.AUTH_TOKEN_EXPIRED]: 'è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ',\n  [BUSINESS_CODES.AUTH_TOKEN_INVALID]: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ',\n  [BUSINESS_CODES.AUTH_INSUFFICIENT_PERMISSIONS]: 'æƒé™ä¸è¶³',\n\n  [BUSINESS_CODES.VALIDATION_FAILED]: 'æ•°æ®éªŒè¯å¤±è´¥',\n  [BUSINESS_CODES.VALIDATION_REQUIRED_FIELD]: 'å¿…å¡«å­—æ®µç¼ºå¤±',\n  [BUSINESS_CODES.VALIDATION_INVALID_FORMAT]: 'æ•°æ®æ ¼å¼æ— æ•ˆ',\n  [BUSINESS_CODES.VALIDATION_OUT_OF_RANGE]: 'æ•°æ®è¶…å‡ºå…è®¸èŒƒå›´',\n\n  [BUSINESS_CODES.RESOURCE_NOT_FOUND]: 'èµ„æºæœªæ‰¾åˆ°',\n  [BUSINESS_CODES.RESOURCE_ALREADY_EXISTS]: 'èµ„æºå·²å­˜åœ¨',\n  [BUSINESS_CODES.RESOURCE_CONFLICT]: 'èµ„æºå†²çª',\n  [BUSINESS_CODES.RESOURCE_LOCKED]: 'èµ„æºè¢«é”å®š',\n\n  [BUSINESS_CODES.BUSINESS_RULE_VIOLATION]: 'è¿åä¸šåŠ¡è§„åˆ™',\n  [BUSINESS_CODES.OPERATION_NOT_ALLOWED]: 'æ“ä½œä¸è¢«å…è®¸',\n  [BUSINESS_CODES.QUOTA_EXCEEDED]: 'é…é¢å·²è¶…å‡º',\n\n  [BUSINESS_CODES.SYSTEM_ERROR]: 'ç³»ç»Ÿå†…éƒ¨é”™è¯¯',\n  [BUSINESS_CODES.DATABASE_ERROR]: 'æ•°æ®åº“æ“ä½œå¤±è´¥',\n  [BUSINESS_CODES.EXTERNAL_SERVICE_ERROR]: 'å¤–éƒ¨æœåŠ¡é”™è¯¯',\n  [BUSINESS_CODES.RATE_LIMIT_EXCEEDED]: 'è¯·æ±‚é¢‘ç‡è¶…å‡ºé™åˆ¶'\n};\n\n// æ ‡å‡†å“åº”æ ¼å¼ç±»\nexport class ApiResponse {\n  constructor() {\n    this.timestamp = new Date().toISOString();\n    this.requestId = null;\n    this.success = true;\n    this.code = BUSINESS_CODES.SUCCESS;\n    this.message = null;\n    this.data = null;\n    this.errors = null;\n    this.meta = null;\n  }\n\n  // è®¾ç½®è¯·æ±‚ID\n  setRequestId(requestId) {\n    this.requestId = requestId;\n    return this;\n  }\n\n  // è®¾ç½®æˆåŠŸå“åº”\n  setSuccess(data = null, message = null, meta = null) {\n    this.success = true;\n    this.code = BUSINESS_CODES.SUCCESS;\n    this.message = message;\n    this.data = data;\n    this.meta = meta;\n    return this;\n  }\n\n  // è®¾ç½®é”™è¯¯å“åº”\n  setError(code, message = null, errors = null, data = null) {\n    this.success = false;\n    this.code = code;\n    this.message = message || ERROR_MESSAGES[code] || 'æœªçŸ¥é”™è¯¯';\n    this.errors = errors;\n    this.data = data;\n    return this;\n  }\n\n  // è®¾ç½®å…ƒæ•°æ®\n  setMeta(meta) {\n    this.meta = { ...this.meta, ...meta };\n    return this;\n  }\n\n  // æ·»åŠ åˆ†é¡µä¿¡æ¯\n  setPagination(page, limit, total, totalPages = null) {\n    const pagination = {\n      page: parseInt(page),\n      limit: parseInt(limit),\n      total: parseInt(total),\n      totalPages: totalPages || Math.ceil(total / limit),\n      hasNext: page < Math.ceil(total / limit),\n      hasPrev: page > 1\n    };\n\n    return this.setMeta({ pagination });\n  }\n\n  // è½¬æ¢ä¸ºJSONå¯¹è±¡\n  toJSON() {\n    const response = {\n      success: this.success,\n      timestamp: this.timestamp,\n      code: this.code\n    };\n\n    if (this.requestId) {\n      response.requestId = this.requestId;\n    }\n\n    if (this.message) {\n      response.message = this.message;\n    }\n\n    if (this.data !== null) {\n      response.data = this.data;\n    }\n\n    if (this.errors) {\n      response.errors = this.errors;\n    }\n\n    if (this.meta) {\n      response.meta = this.meta;\n    }\n\n    return response;\n  }\n}\n\n// å“åº”æ„å»ºå™¨ç±»\nexport class ResponseBuilder {\n  // æˆåŠŸå“åº”\n  static success(data = null, message = null, meta = null) {\n    return new ApiResponse().setSuccess(data, message, meta);\n  }\n\n  // åˆ›å»ºæˆåŠŸå“åº”\n  static created(data = null, message = 'åˆ›å»ºæˆåŠŸ', meta = null) {\n    return new ApiResponse().setSuccess(data, message, meta);\n  }\n\n  // æ— å†…å®¹å“åº”\n  static noContent(message = 'æ“ä½œæˆåŠŸ') {\n    return new ApiResponse().setSuccess(null, message);\n  }\n\n  // åˆ†é¡µå“åº”\n  static paginated(data, page, limit, total, message = null) {\n    return new ApiResponse().setSuccess(data, message).setPagination(page, limit, total);\n  }\n\n  // é”™è¯¯å“åº”\n  static error(code, message = null, errors = null, data = null) {\n    return new ApiResponse().setError(code, message, errors, data);\n  }\n\n  // éªŒè¯é”™è¯¯\n  static validationError(errors, message = 'æ•°æ®éªŒè¯å¤±è´¥') {\n    return new ApiResponse().setError(BUSINESS_CODES.VALIDATION_FAILED, message, errors);\n  }\n\n  // è®¤è¯é”™è¯¯\n  static unauthorized(message = 'è®¤è¯å¤±è´¥') {\n    return new ApiResponse().setError(BUSINESS_CODES.AUTH_TOKEN_INVALID, message);\n  }\n\n  // æƒé™é”™è¯¯\n  static forbidden(message = 'æƒé™ä¸è¶³') {\n    return new ApiResponse().setError(BUSINESS_CODES.AUTH_INSUFFICIENT_PERMISSIONS, message);\n  }\n\n  // èµ„æºæœªæ‰¾åˆ°\n  static notFound(resource = 'èµ„æº', message = null) {\n    return new ApiResponse().setError(\n      BUSINESS_CODES.RESOURCE_NOT_FOUND,\n      message || `${resource}æœªæ‰¾åˆ°`\n    );\n  }\n\n  // èµ„æºå†²çª\n  static conflict(message = 'èµ„æºå†²çª') {\n    return new ApiResponse().setError(BUSINESS_CODES.RESOURCE_CONFLICT, message);\n  }\n\n  // ç³»ç»Ÿé”™è¯¯\n  static systemError(message = 'ç³»ç»Ÿå†…éƒ¨é”™è¯¯', errors = null) {\n    return new ApiResponse().setError(BUSINESS_CODES.SYSTEM_ERROR, message, errors);\n  }\n\n  // é™æµé”™è¯¯\n  static rateLimitExceeded(message = 'è¯·æ±‚é¢‘ç‡è¶…å‡ºé™åˆ¶') {\n    return new ApiResponse().setError(BUSINESS_CODES.RATE_LIMIT_EXCEEDED, message);\n  }\n}\n\n// Expressä¸­é—´ä»¶ï¼šæ·»åŠ å“åº”æ„å»ºå™¨åˆ°reså¯¹è±¡\nexport function responseMiddleware(req, res, next) {\n  // æ·»åŠ è¯·æ±‚ID\n  const requestId =\n    req.headers['x-request-id'] || req.headers['x-correlation-id'] || generateRequestId();\n\n  req.requestId = requestId;\n\n  // æ·»åŠ å“åº”æ–¹æ³•åˆ°reså¯¹è±¡\n  res.apiSuccess = (data, message, meta) => {\n    const response = ResponseBuilder.success(data, message, meta).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.OK);\n    return res.status(HTTP_STATUS.OK).json(response.toJSON());\n  };\n\n  res.apiCreated = (data, message, meta) => {\n    const response = ResponseBuilder.created(data, message, meta).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.CREATED);\n    return res.status(HTTP_STATUS.CREATED).json(response.toJSON());\n  };\n\n  res.apiNoContent = (message) => {\n    const response = ResponseBuilder.noContent(message).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.NO_CONTENT);\n    return res.status(HTTP_STATUS.NO_CONTENT).json(response.toJSON());\n  };\n\n  res.apiPaginated = (data, page, limit, total, message) => {\n    const response = ResponseBuilder.paginated(data, page, limit, total, message).setRequestId(\n      requestId\n    );\n\n    logResponse(req, response, HTTP_STATUS.OK);\n    return res.status(HTTP_STATUS.OK).json(response.toJSON());\n  };\n\n  res.apiError = (code, message, errors, statusCode = HTTP_STATUS.BAD_REQUEST) => {\n    const response = ResponseBuilder.error(code, message, errors).setRequestId(requestId);\n\n    logResponse(req, response, statusCode);\n    return res.status(statusCode).json(response.toJSON());\n  };\n\n  res.apiValidationError = (errors, message) => {\n    const response = ResponseBuilder.validationError(errors, message).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.UNPROCESSABLE_ENTITY);\n    return res.status(HTTP_STATUS.UNPROCESSABLE_ENTITY).json(response.toJSON());\n  };\n\n  res.apiUnauthorized = (message) => {\n    const response = ResponseBuilder.unauthorized(message).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.UNAUTHORIZED);\n    return res.status(HTTP_STATUS.UNAUTHORIZED).json(response.toJSON());\n  };\n\n  res.apiForbidden = (message) => {\n    const response = ResponseBuilder.forbidden(message).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.FORBIDDEN);\n    return res.status(HTTP_STATUS.FORBIDDEN).json(response.toJSON());\n  };\n\n  res.apiNotFound = (resource, message) => {\n    const response = ResponseBuilder.notFound(resource, message).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.NOT_FOUND);\n    return res.status(HTTP_STATUS.NOT_FOUND).json(response.toJSON());\n  };\n\n  res.apiConflict = (message) => {\n    const response = ResponseBuilder.conflict(message).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.CONFLICT);\n    return res.status(HTTP_STATUS.CONFLICT).json(response.toJSON());\n  };\n\n  res.apiSystemError = (message, errors) => {\n    const response = ResponseBuilder.systemError(message, errors).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.INTERNAL_SERVER_ERROR);\n    return res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json(response.toJSON());\n  };\n\n  res.apiRateLimitExceeded = (message) => {\n    const response = ResponseBuilder.rateLimitExceeded(message).setRequestId(requestId);\n\n    logResponse(req, response, HTTP_STATUS.TOO_MANY_REQUESTS);\n    return res.status(HTTP_STATUS.TOO_MANY_REQUESTS).json(response.toJSON());\n  };\n\n  next();\n}\n\n// ç”Ÿæˆè¯·æ±‚ID\nfunction generateRequestId() {\n  return `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n}\n\n// è®°å½•å“åº”æ—¥å¿—\nfunction logResponse(req, response, statusCode) {\n  const logData = {\n    requestId: req.requestId,\n    method: req.method,\n    url: req.originalUrl,\n    statusCode,\n    success: response.success,\n    code: response.code,\n    userId: req.user?.id,\n    ip: req.ip\n  };\n\n  if (statusCode >= 500) {\n    logger.error('APIå“åº”', logData);\n  } else if (statusCode >= 400) {\n    logger.warn('APIå“åº”', logData);\n  } else {\n    logger.info('APIå“åº”', logData);\n  }\n}\n\n// å“åº”éªŒè¯å™¨\nexport class ResponseValidator {\n  static validate(response) {\n    const errors = [];\n\n    // æ£€æŸ¥å¿…éœ€å­—æ®µ\n    if (typeof response.success !== 'boolean') {\n      errors.push('successå­—æ®µå¿…é¡»æ˜¯å¸ƒå°”å€¼');\n    }\n\n    if (!response.timestamp) {\n      errors.push('timestampå­—æ®µæ˜¯å¿…éœ€çš„');\n    }\n\n    if (!response.code) {\n      errors.push('codeå­—æ®µæ˜¯å¿…éœ€çš„');\n    }\n\n    // æ£€æŸ¥æ—¶é—´æˆ³æ ¼å¼\n    if (response.timestamp && !isValidISO8601(response.timestamp)) {\n      errors.push('timestampå¿…é¡»æ˜¯æœ‰æ•ˆçš„ISO8601æ ¼å¼');\n    }\n\n    // æ£€æŸ¥ä¸šåŠ¡ä»£ç \n    if (response.code && !Object.values(BUSINESS_CODES).includes(response.code)) {\n      errors.push('æ— æ•ˆçš„ä¸šåŠ¡ä»£ç ');\n    }\n\n    // æ£€æŸ¥æˆåŠŸå“åº”çš„æ•°æ®ä¸€è‡´æ€§\n    if (response.success && response.code !== BUSINESS_CODES.SUCCESS) {\n      errors.push('æˆåŠŸå“åº”çš„codeå¿…é¡»æ˜¯SUCCESS');\n    }\n\n    // æ£€æŸ¥å¤±è´¥å“åº”çš„æ•°æ®ä¸€è‡´æ€§\n    if (!response.success && response.code === BUSINESS_CODES.SUCCESS) {\n      errors.push('å¤±è´¥å“åº”çš„codeä¸èƒ½æ˜¯SUCCESS');\n    }\n\n    return {\n      valid: errors.length === 0,\n      errors\n    };\n  }\n}\n\n// æ£€æŸ¥ISO8601æ—¶é—´æ ¼å¼\nfunction isValidISO8601(dateString) {\n  const iso8601Regex = /^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?Z?$/;\n  return iso8601Regex.test(dateString) && !isNaN(Date.parse(dateString));\n}\n\n// å“åº”è½¬æ¢å™¨\nexport class ResponseTransformer {\n  // è½¬æ¢æ•°æ®åº“è®°å½•\n  static transformDatabaseRecord(record, fields = null) {\n    if (!record) {\n      return null;\n    }\n\n    const transformed = { ...record };\n\n    // ç§»é™¤æ•æ„Ÿå­—æ®µ\n    delete transformed.password_hash;\n    delete transformed.password;\n    delete transformed.secret;\n    delete transformed.token;\n\n    // è½¬æ¢æ—¶é—´å­—æ®µ\n    ['created_at', 'updated_at', 'deleted_at', 'last_login', 'expires_at'].forEach((field) => {\n      if (transformed[field]) {\n        transformed[field] = new Date(transformed[field]).toISOString();\n      }\n    });\n\n    // åªè¿”å›æŒ‡å®šå­—æ®µ\n    if (fields && Array.isArray(fields)) {\n      const filteredRecord = {};\n      fields.forEach((field) => {\n        if (Object.prototype.hasOwnProperty.call(transformed, field)) {\n          filteredRecord[field] = transformed[field];\n        }\n      });\n      return filteredRecord;\n    }\n\n    return transformed;\n  }\n\n  // è½¬æ¢æ•°æ®åº“è®°å½•åˆ—è¡¨\n  static transformDatabaseRecords(records, fields = null) {\n    if (!Array.isArray(records)) {\n      return [];\n    }\n\n    return records.map((record) => this.transformDatabaseRecord(record, fields));\n  }\n\n  // è½¬æ¢é”™è¯¯å¯¹è±¡\n  static transformError(error) {\n    if (error.isJoi) {\n      // JoiéªŒè¯é”™è¯¯\n      return {\n        type: 'validation',\n        details: error.details.map((detail) => ({\n          field: detail.path.join('.'),\n          message: detail.message,\n          value: detail.context?.value\n        }))\n      };\n    }\n\n    if (error.code && error.code.startsWith('SQLITE_')) {\n      // SQLiteé”™è¯¯\n      return {\n        type: 'database',\n        code: error.code,\n        message: 'æ•°æ®åº“æ“ä½œå¤±è´¥'\n      };\n    }\n\n    // é€šç”¨é”™è¯¯\n    return {\n      type: 'general',\n      message: error.message || 'æœªçŸ¥é”™è¯¯'\n    };\n  }\n}\n\n// å¯¼å‡ºå¸¸ç”¨å‡½æ•°\nexport {\n  HTTP_STATUS as HttpStatus,\n  BUSINESS_CODES as BusinessCodes,\n  ERROR_MESSAGES as ErrorMessages\n};\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/cache.js","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":167,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":167,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * ç®€å•çš„å†…å­˜ç¼“å­˜ç³»ç»Ÿ\n * ç”¨äºä¼˜åŒ–APIå“åº”æ—¶é—´\n */\n\nimport { MATH_CONSTANTS, TIME_INTERVALS } from '../constants/MathConstants.js';\nimport { defaultLogger } from './logger.js';\n\nconst logger = defaultLogger.child('Cache');\n\nclass MemoryCache {\n  constructor() {\n    this.cache = new Map();\n    this.ttlMap = new Map();\n    this.defaultTTL = TIME_INTERVALS.FIVE_MINUTES_MS; // é»˜è®¤5åˆ†é’Ÿè¿‡æœŸ\n\n    // å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜\n    setInterval(() => {\n      this.cleanup();\n    }, MATH_CONSTANTS.SECONDS_PER_MINUTE * MATH_CONSTANTS.MILLISECONDS_PER_SECOND); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡\n  }\n\n  /**\n   * è®¾ç½®ç¼“å­˜\n   * @param {string} key - ç¼“å­˜é”®\n   * @param {any} value - ç¼“å­˜å€¼\n   * @param {number} ttl - è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨defaultTTL\n   */\n  set(key, value, ttl = this.defaultTTL) {\n    const expiresAt = Date.now() + ttl;\n    this.cache.set(key, value);\n    this.ttlMap.set(key, expiresAt);\n  }\n\n  /**\n   * è·å–ç¼“å­˜\n   * @param {string} key - ç¼“å­˜é”®\n   * @returns {any|null} ç¼“å­˜å€¼æˆ–null\n   */\n  get(key) {\n    const expiresAt = this.ttlMap.get(key);\n\n    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ\n    if (!expiresAt || Date.now() > expiresAt) {\n      this.delete(key);\n      return null;\n    }\n\n    return this.cache.get(key);\n  }\n\n  /**\n   * åˆ é™¤ç¼“å­˜\n   * @param {string} key - ç¼“å­˜é”®\n   */\n  delete(key) {\n    this.cache.delete(key);\n    this.ttlMap.delete(key);\n  }\n\n  /**\n   * æ¸…ç©ºæ‰€æœ‰ç¼“å­˜\n   */\n  clear() {\n    this.cache.clear();\n    this.ttlMap.clear();\n  }\n\n  /**\n   * æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨ä¸”æœªè¿‡æœŸ\n   * @param {string} key - ç¼“å­˜é”®\n   * @returns {boolean}\n   */\n  has(key) {\n    const expiresAt = this.ttlMap.get(key);\n    if (!expiresAt || Date.now() > expiresAt) {\n      this.delete(key);\n      return false;\n    }\n    return this.cache.has(key);\n  }\n\n  /**\n   * è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯\n   * @returns {object} ç»Ÿè®¡ä¿¡æ¯\n   */\n  getStats() {\n    return {\n      size: this.cache.size,\n      keys: Array.from(this.cache.keys())\n    };\n  }\n\n  /**\n   * æ¸…ç†è¿‡æœŸç¼“å­˜\n   */\n  cleanup() {\n    const now = Date.now();\n    const expiredKeys = [];\n\n    for (const [key, expiresAt] of this.ttlMap.entries()) {\n      if (now > expiresAt) {\n        expiredKeys.push(key);\n      }\n    }\n\n    expiredKeys.forEach((key) => this.delete(key));\n\n    if (expiredKeys.length > 0) {\n      logger.info(`æ¸…ç†äº† ${expiredKeys.length} ä¸ªè¿‡æœŸç¼“å­˜é¡¹`);\n    }\n  }\n\n  /**\n   * ç”Ÿæˆç¼“å­˜é”®\n   * @param {string} prefix - å‰ç¼€\n   * @param {object} params - å‚æ•°å¯¹è±¡\n   * @returns {string} ç¼“å­˜é”®\n   */\n  generateKey(prefix, params = {}) {\n    const sortedParams = Object.keys(params)\n      .sort()\n      .map((key) => `${key}:${params[key]}`)\n      .join('|');\n\n    return `${prefix}:${sortedParams}`;\n  }\n}\n\n// åˆ›å»ºå…¨å±€ç¼“å­˜å®ä¾‹\nconst cache = new MemoryCache();\n\n/**\n * ç¼“å­˜ä¸­é—´ä»¶å·¥å‚å‡½æ•°\n * @param {number} ttl - ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\n * @param {function} keyGenerator - ç¼“å­˜é”®ç”Ÿæˆå‡½æ•°\n * @returns {function} Expressä¸­é—´ä»¶\n */\nexport function createCacheMiddleware(ttl = TIME_INTERVALS.FIVE_MINUTES_MS, keyGenerator = null) {\n  return (req, res, next) => {\n    // åªç¼“å­˜GETè¯·æ±‚\n    if (req.method !== 'GET') {\n      return next();\n    }\n\n    // ç”Ÿæˆç¼“å­˜é”®\n    const cacheKey = keyGenerator ? keyGenerator(req) : cache.generateKey(req.path, req.query);\n\n    // å°è¯•ä»ç¼“å­˜è·å–æ•°æ®\n    const cachedData = cache.get(cacheKey);\n    if (cachedData) {\n      logger.debug(`ç¼“å­˜å‘½ä¸­: ${cacheKey}`);\n      // è®¾ç½®ç¼“å­˜å‘½ä¸­å¤´ä¿¡æ¯\n      res.setHeader('X-Cache-Hit', 'true');\n      res.setHeader('X-Cache-Key', cacheKey);\n      return res.json(cachedData);\n    }\n\n    // è®¾ç½®ç¼“å­˜æœªå‘½ä¸­å¤´ä¿¡æ¯\n    res.setHeader('X-Cache-Hit', 'false');\n    res.setHeader('X-Cache-Key', cacheKey);\n\n    // é‡å†™res.jsonæ–¹æ³•ä»¥ç¼“å­˜å“åº”\n    const originalJson = res.json;\n    res.json = function (data) {\n      // åªç¼“å­˜æˆåŠŸçš„å“åº”\n      if (res.statusCode === 200) {\n        cache.set(cacheKey, data, ttl);\n        logger.debug(`ç¼“å­˜å­˜å‚¨: ${cacheKey}`);\n      }\n      return originalJson.call(this, data);\n    };\n\n    next();\n  };\n}\n\n/**\n * æ¸…é™¤ç‰¹å®šå‰ç¼€çš„ç¼“å­˜\n * @param {string} prefix - ç¼“å­˜é”®å‰ç¼€\n */\nexport function clearCacheByPrefix(prefix) {\n  const stats = cache.getStats();\n  const keysToDelete = stats.keys.filter((key) => key.startsWith(prefix));\n\n  keysToDelete.forEach((key) => cache.delete(key));\n\n  logger.info(`æ¸…é™¤äº† ${keysToDelete.length} ä¸ªå‰ç¼€ä¸º \"${prefix}\" çš„ç¼“å­˜é¡¹`);\n}\n\n/**\n * é¢„çƒ­ç¼“å­˜å‡½æ•°\n * @param {string} key - ç¼“å­˜é”®\n * @param {function} dataLoader - æ•°æ®åŠ è½½å‡½æ•°\n * @param {number} ttl - è¿‡æœŸæ—¶é—´\n */\nexport async function warmupCache(key, dataLoader, ttl = TIME_INTERVALS.FIVE_MINUTES_MS) {\n  try {\n    const data = await dataLoader();\n    cache.set(key, data, ttl);\n    logger.info(`é¢„çƒ­ç¼“å­˜: ${key}`);\n  } catch (error) {\n    logger.error(`é¢„çƒ­ç¼“å­˜å¤±è´¥: ${key}`, { error: error.message, stack: error.stack });\n  }\n}\n\nexport { cache };\nexport default cache;\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/inputValidator.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/inputValidatorConstants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/logger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/schemaValidator.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"/Users/xunan/Documents/WebStormProjects/0C/src/shared/utils/testHelpers.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]}]